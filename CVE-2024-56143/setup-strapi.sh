#!/bin/bash
set -e

STRAPI_URL="http://localhost:1337"
ADMIN_EMAIL="admin@lab.local"
ADMIN_PASSWORD="Admin12345!"
ADMIN_FIRSTNAME="CVE"
ADMIN_LASTNAME="Lab"

echo "[*] Starting Strapi in background..."
cd /strapi
NODE_ENV=development npm run develop &
STRAPI_PID=$!

# Wait for Strapi to be ready
echo "[*] Waiting for Strapi to start..."
MAX_WAIT=180
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    if curl -sf "${STRAPI_URL}/_health" > /dev/null 2>&1; then
        echo "[+] Strapi is healthy after ${WAITED}s"
        break
    fi
    sleep 2
    WAITED=$((WAITED + 2))
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo "[-] Strapi failed to start within ${MAX_WAIT}s"
    wait $STRAPI_PID
    exit 1
fi

# Small extra wait for full initialization
sleep 5

# Register admin user (only works on first run)
echo "[*] Registering admin user..."
REGISTER_RESP=$(curl -sf -X POST "${STRAPI_URL}/admin/register-admin" \
    -H "Content-Type: application/json" \
    -d "{
        \"firstname\": \"${ADMIN_FIRSTNAME}\",
        \"lastname\": \"${ADMIN_LASTNAME}\",
        \"email\": \"${ADMIN_EMAIL}\",
        \"password\": \"${ADMIN_PASSWORD}\"
    }" 2>&1) || true

TOKEN=""
if echo "$REGISTER_RESP" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])" > /tmp/token.txt 2>/dev/null; then
    TOKEN=$(cat /tmp/token.txt)
    echo "[+] Admin user registered successfully"
else
    echo "[*] Admin may already exist, attempting login..."
    LOGIN_RESP=$(curl -sf -X POST "${STRAPI_URL}/admin/login" \
        -H "Content-Type: application/json" \
        -d "{
            \"email\": \"${ADMIN_EMAIL}\",
            \"password\": \"${ADMIN_PASSWORD}\"
        }" 2>&1) || true
    if echo "$LOGIN_RESP" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['data']['token'])" > /tmp/token.txt 2>/dev/null; then
        TOKEN=$(cat /tmp/token.txt)
        echo "[+] Logged in successfully"
    fi
fi

if [ -z "$TOKEN" ]; then
    echo "[-] Could not get admin token. Manual setup may be needed."
    echo "[*] Strapi is running. Waiting..."
    wait $STRAPI_PID
    exit 0
fi

echo "[+] Got admin JWT token"

# Configure public permissions for articles
echo "[*] Configuring public permissions for articles..."

# Get Public role from users-permissions plugin
UP_ROLES_RESP=$(curl -sf "${STRAPI_URL}/users-permissions/roles" \
    -H "Authorization: Bearer ${TOKEN}" 2>&1) || true

PUBLIC_ROLE_ID=$(echo "$UP_ROLES_RESP" | python3 -c "
import sys, json
data = json.load(sys.stdin)
roles = data.get('roles', [])
for role in roles:
    if role.get('type') == 'public':
        print(role['id'])
        break
" 2>/dev/null) || true

if [ -n "$PUBLIC_ROLE_ID" ]; then
    echo "[+] Found Public role ID: ${PUBLIC_ROLE_ID}"

    # Update public role to enable find and findOne for articles
    curl -sf -X PUT "${STRAPI_URL}/users-permissions/roles/${PUBLIC_ROLE_ID}" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{
            \"permissions\": {
                \"api::article\": {
                    \"controllers\": {
                        \"article\": {
                            \"find\": { \"enabled\": true },
                            \"findOne\": { \"enabled\": true }
                        }
                    }
                }
            }
        }" > /dev/null 2>&1 || true
    echo "[+] Public permissions updated for articles"
else
    echo "[-] Could not find Public role ID"
fi

# Create a test article
echo "[*] Creating test article..."
CREATE_RESP=$(curl -sf -X POST "${STRAPI_URL}/content-manager/collection-types/api::article.article" \
    -H "Authorization: Bearer ${TOKEN}" \
    -H "Content-Type: application/json" \
    -d '{
        "title": "Test Article for CVE-2024-56143",
        "body": "This is a test article to verify the lookup parameter injection vulnerability."
    }' 2>&1) || true

echo "[*] Create response: ${CREATE_RESP}"

# Extract document ID for publishing
DOC_ID=$(echo "$CREATE_RESP" | python3 -c "
import sys, json
data = json.load(sys.stdin)
did = data.get('data', {}).get('documentId', '') if 'data' in data else data.get('documentId', '')
print(did)
" 2>/dev/null) || true

if [ -n "$DOC_ID" ] && [ "$DOC_ID" != "" ]; then
    echo "[+] Article created with documentId: ${DOC_ID}"

    # Publish the article
    echo "[*] Publishing article..."
    curl -sf -X POST "${STRAPI_URL}/content-manager/collection-types/api::article.article/${DOC_ID}/actions/publish" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d '{}' > /dev/null 2>&1 || true
    echo "[+] Article published"
else
    echo "[-] Could not extract document ID. You may need to create an article manually."
fi

# Verify public access
echo "[*] Verifying public API access..."
sleep 2
API_RESP=$(curl -sf "${STRAPI_URL}/api/articles" 2>&1) || true
ARTICLE_COUNT=$(echo "$API_RESP" | python3 -c "import sys,json; print(len(json.load(sys.stdin).get('data', [])))" 2>/dev/null) || ARTICLE_COUNT="0"

echo ""
echo "============================================"
echo "  Strapi CVE-2024-56143 Lab Ready"
echo "============================================"
echo "  URL:            ${STRAPI_URL}"
echo "  Admin Panel:    ${STRAPI_URL}/admin"
echo "  Admin Email:    ${ADMIN_EMAIL}"
echo "  Admin Password: ${ADMIN_PASSWORD}"
echo "  Content API:    ${STRAPI_URL}/api/articles"
echo "  Articles:       ${ARTICLE_COUNT} published"
echo "  Version:        5.5.1 (vulnerable)"
echo "============================================"
echo ""

# Keep Strapi in foreground
wait $STRAPI_PID
