# CVE-2024-56143 Lab - Strapi 5 IDOR via lookup Parameter Injection
# Builds a vulnerable Strapi 5.5.1 instance with SQLite and pre-configured content

FROM node:20-slim

ENV DEBIAN_FRONTEND=noninteractive

# Install build tools required for better-sqlite3 native module
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 make g++ curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /strapi

# Create project structure
RUN mkdir -p config database/migrations public/uploads \
    src/admin src/api src/extensions

# Create package.json for Strapi 5.5.1
COPY package.json /strapi/package.json

# Create config files
COPY config/ /strapi/config/

# Create src/index.js
RUN printf "'use strict';\nmodule.exports = {\n  register() {},\n  bootstrap() {},\n};\n" > src/index.js

# Create .env with secrets
RUN printf "HOST=0.0.0.0\nPORT=1337\nAPP_KEYS=labKey1base64xxxxxxx,labKey2base64xxxxxxx,labKey3base64xxxxxxx,labKey4base64xxxxxxx\nAPI_TOKEN_SALT=lab-api-token-salt-value1234567\nADMIN_JWT_SECRET=lab-admin-jwt-secret-value1234\nTRANSFER_TOKEN_SALT=lab-transfer-token-salt-value1\nJWT_SECRET=lab-jwt-secret-value123456789ab\nDATABASE_CLIENT=sqlite\nDATABASE_FILENAME=.tmp/data.db\n" > .env

# Create .gitkeep files
RUN touch database/migrations/.gitkeep public/uploads/.gitkeep \
    src/api/.gitkeep src/extensions/.gitkeep

# Pre-create the "article" content type
RUN mkdir -p src/api/article/content-types/article \
             src/api/article/controllers \
             src/api/article/routes \
             src/api/article/services

COPY article-schema.json src/api/article/content-types/article/schema.json

RUN printf "'use strict';\nconst { createCoreController } = require('@strapi/strapi').factories;\nmodule.exports = createCoreController('api::article.article');\n" \
    > src/api/article/controllers/article.js && \
    printf "'use strict';\nconst { createCoreRouter } = require('@strapi/strapi').factories;\nmodule.exports = createCoreRouter('api::article.article');\n" \
    > src/api/article/routes/article.js && \
    printf "'use strict';\nconst { createCoreService } = require('@strapi/strapi').factories;\nmodule.exports = createCoreService('api::article.article');\n" \
    > src/api/article/services/article.js

# Install dependencies
RUN npm install --legacy-peer-deps 2>&1

# Copy the setup script
COPY setup-strapi.sh /strapi/setup-strapi.sh
RUN chmod +x /strapi/setup-strapi.sh

EXPOSE 1337

CMD ["/strapi/setup-strapi.sh"]
