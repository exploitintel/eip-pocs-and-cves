#!/bin/bash
# Wrapper entrypoint that patches host-headers-allowed with the actual container IP
# before delegating to the official OFBiz entrypoint
set -e

# Get the container's IP addresses and add them to host-headers-allowed
CONTAINER_IPS=$(hostname -I 2>/dev/null | tr ' ' ',' | sed 's/,$//')
if [ -n "$CONTAINER_IPS" ]; then
    # Copy security.properties to config override dir with container IPs added
    CURRENT_HOSTS=$(grep '^host-headers-allowed=' /ofbiz/framework/security/config/security.properties | cut -d= -f2)
    echo "host-headers-allowed=${CURRENT_HOSTS},${CONTAINER_IPS}" > /ofbiz/config/security.properties
    # Copy remaining properties
    grep -v '^host-headers-allowed=' /ofbiz/framework/security/config/security.properties >> /ofbiz/config/security.properties
fi

# Delegate to the official entrypoint
exec /ofbiz/docker-entrypoint.sh "$@"
