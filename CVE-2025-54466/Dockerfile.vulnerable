# CVE-2025-54466 - Apache OFBiz Scrum Plugin Command Injection
# Vulnerable version: release24.09.01

###############################################################################
# Stage 1: Builder - clone and build OFBiz with plugins
###############################################################################
FROM eclipse-temurin:17-jdk AS builder

RUN apt-get update \
    && apt-get install -y --no-install-recommends git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /builder

# Clone framework at vulnerable version
RUN git clone --branch release24.09.01 --depth 1 https://github.com/apache/ofbiz-framework.git .

# Clone plugins at vulnerable version into the plugins/ directory
RUN git clone --branch release24.09.01 --depth 1 https://github.com/apache/ofbiz-plugins.git plugins

# Fix shasum -> sha1sum for the gradle wrapper init script
RUN sed -i 's/shasum/sha1sum/g' gradle/init-gradle-wrapper.sh

# Initialize gradle wrapper
RUN chmod +x gradlew gradle/init-gradle-wrapper.sh && gradle/init-gradle-wrapper.sh

# Build OFBiz distribution tarball
RUN ./gradlew --console plain --no-daemon distTar

###############################################################################
# Stage 2: Runtime - set up the vulnerable OFBiz instance
###############################################################################
FROM eclipse-temurin:17-jdk AS runtime

# Install runtime dependencies:
# - xsltproc: used by docker-entrypoint.sh to disable components
# - subversion: CRITICAL - the vulnerable code calls svn commands via Runtime.exec()
# - curl: for healthcheck and debugging
RUN apt-get update \
    && apt-get install -y --no-install-recommends xsltproc subversion curl \
    && rm -rf /var/lib/apt/lists/*

# Create ofbiz user
RUN useradd -m ofbiz

# Create entrypoint hook directories (expected by the entrypoint script)
RUN mkdir --parents \
    /docker-entrypoint-hooks/before-config-applied.d \
    /docker-entrypoint-hooks/after-config-applied.d \
    /docker-entrypoint-hooks/before-data-load.d \
    /docker-entrypoint-hooks/after-data-load.d \
    /docker-entrypoint-hooks/additional-data.d \
    && chown -R ofbiz:ofbiz /docker-entrypoint-hooks

WORKDIR /ofbiz

# Extract the OFBiz tar distribution from builder
COPY --from=builder /builder/build/distributions/ofbiz.tar /tmp/ofbiz.tar
RUN tar --extract --strip-components=1 --file=/tmp/ofbiz.tar && rm /tmp/ofbiz.tar

# Create required directories
RUN mkdir -p /ofbiz/runtime /ofbiz/config /ofbiz/lib-extra

# Copy VERSION file
COPY --from=builder /builder/VERSION .

# Copy entrypoint and helper scripts from the framework's docker directory
COPY --from=builder /builder/docker/docker-entrypoint.sh /ofbiz/docker-entrypoint.sh
COPY --from=builder /builder/docker/send_ofbiz_stop_signal.sh /ofbiz/send_ofbiz_stop_signal.sh
COPY --from=builder /builder/docker/disable-component.xslt /ofbiz/disable-component.xslt
COPY --from=builder /builder/docker/templates /ofbiz/templates

RUN chmod 555 /ofbiz/docker-entrypoint.sh /ofbiz/send_ofbiz_stop_signal.sh \
    && chmod 444 /ofbiz/disable-component.xslt

# Relax host-headers-allowed to accept connections from any hostname/IP
# This is required for lab testing where we connect via container IP
# NOTE: Empty value causes NPE in OFBiz; must list actual IP addresses
# OFBiz uses exact string matching (no CIDR), so we list common Docker bridge IPs
RUN sed -i 's/^host-headers-allowed=.*/host-headers-allowed=localhost,127.0.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.18.0.2,172.18.0.3,172.18.0.4,172.18.0.5,172.19.0.2,172.19.0.3,172.19.0.4,172.19.0.5,172.19.0.6,172.19.0.7,172.19.0.8,172.19.0.9,172.19.0.10,172.20.0.2,172.20.0.3,172.20.0.4,172.20.0.5,172.21.0.2,172.21.0.3,172.22.0.2,172.22.0.3,172.23.0.2,172.23.0.3,cve-2025-54466-vulnerable/' \
    /ofbiz/framework/security/config/security.properties

# Set ownership
RUN chown -R ofbiz:ofbiz /ofbiz

# Load demo data at build time (creates admin/ofbiz user and scrum demo data)
# This makes the container ready to go without data loading at startup
USER ofbiz
RUN /ofbiz/bin/ofbiz --load-data \
    && mkdir -p /ofbiz/runtime/container_state \
    && touch /ofbiz/runtime/container_state/data_loaded \
    && touch /ofbiz/runtime/container_state/admin_loaded \
    && touch /ofbiz/runtime/container_state/db_config_applied

# Create a local SVN repository with 2+ revisions for RCE testing
# The --diff-cmd attack requires a valid SVN repo with actual file changes
RUN svnadmin create /home/ofbiz/svnrepo \
    && svn checkout file:///home/ofbiz/svnrepo /home/ofbiz/svnwc \
    && echo "initial content" > /home/ofbiz/svnwc/test.txt \
    && svn add /home/ofbiz/svnwc/test.txt \
    && svn commit /home/ofbiz/svnwc -m "Initial commit" --username ofbiz \
    && echo "modified content" > /home/ofbiz/svnwc/test.txt \
    && svn commit /home/ofbiz/svnwc -m "Second commit" --username ofbiz \
    && echo "third revision" > /home/ofbiz/svnwc/test.txt \
    && svn commit /home/ofbiz/svnwc -m "Third commit" --username ofbiz

# Add wrapper entrypoint that patches host-headers-allowed with actual container IPs at startup
USER root
COPY entrypoint-wrapper.sh /ofbiz/entrypoint-wrapper.sh
RUN chmod 555 /ofbiz/entrypoint-wrapper.sh
USER ofbiz

EXPOSE 8443 8080 5005

ENTRYPOINT ["/ofbiz/entrypoint-wrapper.sh"]
CMD ["bin/ofbiz"]
