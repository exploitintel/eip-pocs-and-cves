# Dockerfile.vulnerable — CVE-2025-2753
#
# Assimp v5.4.3 with ASan and standard debug builds for crash verification.
# No network services — file-parsing vulnerability only.
#
# Build:
#   docker compose build vulnerable
#
# Trigger:
#   docker exec cve-2025-2753-vulnerable bash -c \
#     'LD_LIBRARY_PATH=/opt/assimp/build-asan/bin assimp-asan info /opt/poc/crash.lws'

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install --no-install-recommends -y \
    ninja-build \
    git \
    ca-certificates \
    cmake \
    build-essential \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone assimp at vulnerable version v5.4.3
RUN git clone --depth 1 --branch v5.4.3 \
    https://github.com/assimp/assimp.git /opt/assimp

WORKDIR /opt/assimp

# Build with AddressSanitizer for detailed crash reports
RUN mkdir -p build-asan && cd build-asan && \
    cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Debug \
    -DASSIMP_BUILD_ASSIMP_TOOLS=ON \
    -DASSIMP_BUILD_TESTS=OFF \
    -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
    -DCMAKE_C_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
    -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
    -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address" \
    .. && \
    ninja -j$(nproc)

# Build without ASan for standard SIGSEGV crash (exit code 139)
RUN mkdir -p build-release && cd build-release && \
    cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Debug \
    -DASSIMP_BUILD_ASSIMP_TOOLS=ON \
    -DASSIMP_BUILD_TESTS=OFF \
    .. && \
    ninja -j$(nproc)

# Copy the crash PoC file
RUN mkdir -p /opt/poc
COPY poc/crash.lws /opt/poc/crash.lws

# Convenience symlinks
RUN ln -sf /opt/assimp/build-asan/bin/assimpd /usr/local/bin/assimp-asan && \
    ln -sf /opt/assimp/build-release/bin/assimpd /usr/local/bin/assimp-release

CMD ["sleep", "infinity"]
