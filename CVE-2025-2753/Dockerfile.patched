# Dockerfile.patched — CVE-2025-2753
#
# Assimp v5.4.3 with recommended fix applied (value-initialization +
# CopyPtrArray null-check). Used to demonstrate that the fix is incomplete
# — see bypass_analysis.md for details on 2 remaining crash paths.
#
# Build:
#   docker compose build patched

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install --no-install-recommends -y \
    ninja-build \
    git \
    ca-certificates \
    cmake \
    build-essential \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone assimp at vulnerable version v5.4.3
RUN git clone --depth 1 --branch v5.4.3 \
    https://github.com/assimp/assimp.git /opt/assimp

WORKDIR /opt/assimp

# ============================================================
# APPLY CVE-2025-2753 FIX: Value-initialize pointer arrays
# in LWSLoader.cpp and add null-checks in CopyPtrArray
# ============================================================

# Fix 1: Value-initialize camera array in LWSLoader.cpp
RUN sed -i 's/master->mCameras = new aiCamera \*\[master->mNumCameras = num_camera\];/master->mCameras = new aiCamera *[master->mNumCameras = num_camera]();/' \
    code/AssetLib/LWS/LWSLoader.cpp

# Fix 2: Value-initialize light array in LWSLoader.cpp
RUN sed -i 's/master->mLights = new aiLight \*\[master->mNumLights = num_light\];/master->mLights = new aiLight *[master->mNumLights = num_light]();/' \
    code/AssetLib/LWS/LWSLoader.cpp

# Fix 3: Add null-check in CopyPtrArray (SceneCombiner.cpp)
RUN sed -i 's/SceneCombiner::Copy(\&dest\[i\], src\[i\]);/if (src[i]) { SceneCombiner::Copy(\&dest[i], src[i]); } else { dest[i] = nullptr; }/' \
    code/Common/SceneCombiner.cpp

# Verify fixes were applied
RUN echo "=== Verifying LWSLoader.cpp fix ===" && \
    grep -n 'num_camera\]()' code/AssetLib/LWS/LWSLoader.cpp && \
    grep -n 'num_light\]()' code/AssetLib/LWS/LWSLoader.cpp && \
    echo "=== Verifying SceneCombiner.cpp fix ===" && \
    grep -n 'if (src\[i\])' code/Common/SceneCombiner.cpp && \
    echo "=== All fixes verified ==="

# Build with AddressSanitizer for detailed crash reports
RUN mkdir -p build-asan && cd build-asan && \
    cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Debug \
    -DASSIMP_BUILD_ASSIMP_TOOLS=ON \
    -DASSIMP_BUILD_TESTS=OFF \
    -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
    -DCMAKE_C_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
    -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address" \
    -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address" \
    .. && \
    ninja -j$(nproc)

# Build without ASan for standard SIGSEGV crash (exit code 139)
RUN mkdir -p build-release && cd build-release && \
    cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Debug \
    -DASSIMP_BUILD_ASSIMP_TOOLS=ON \
    -DASSIMP_BUILD_TESTS=OFF \
    .. && \
    ninja -j$(nproc)

# Copy the crash PoC file
RUN mkdir -p /opt/poc
COPY poc/crash.lws /opt/poc/crash.lws

# Convenience symlinks
RUN ln -sf /opt/assimp/build-asan/bin/assimpd /usr/local/bin/assimp-asan && \
    ln -sf /opt/assimp/build-release/bin/assimpd /usr/local/bin/assimp-release

CMD ["sleep", "infinity"]
