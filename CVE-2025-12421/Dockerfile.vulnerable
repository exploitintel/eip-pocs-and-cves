# CVE-2025-12421 Lab - Mattermost Server Token Type Confusion
# Vulnerable version: Mattermost Server v11.0.2 (Team Edition)
# Single-container: PostgreSQL 14 + Mattermost (preview-style)

FROM postgres:14

# Install required system packages
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
    && rm -rf /var/lib/apt/lists/*

# PostgreSQL credentials (used by the postgres base image entrypoint)
ENV POSTGRES_USER=mmuser
ENV POSTGRES_PASSWORD=mostest
ENV POSTGRES_DB=mattermost_test

# Download Mattermost Team Edition v11.0.2 (vulnerable version)
# Auto-detect architecture for correct binary
WORKDIR /mm
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then MM_ARCH="arm64"; else MM_ARCH="amd64"; fi && \
    echo "Downloading Mattermost v11.0.2 for linux-${MM_ARCH}..." && \
    curl -fSL "https://releases.mattermost.com/11.0.2/mattermost-team-11.0.2-linux-${MM_ARCH}.tar.gz" -o mattermost.tar.gz && \
    tar -xzf mattermost.tar.gz && \
    rm mattermost.tar.gz

# Copy configuration
COPY config_docker.json /mm/mattermost/config/config_docker.json
COPY docker-entry.sh /mm/docker-entry.sh
RUN chmod +x /mm/docker-entry.sh

# Add mattermost binaries to PATH
ENV PATH="/mm/mattermost/bin:${PATH}"

# Enable the MobileSSOCodeExchange feature flag (required for the vulnerable endpoint)
ENV MM_FEATUREFLAGS_MOBILESSOCODEEXCHANGE=true

# Create storage directories
RUN mkdir -p /mm/mattermost-data && \
    mkdir -p /mm/mattermost/logs && \
    mkdir -p /mm/mattermost/plugins && \
    mkdir -p /mm/mattermost/client/plugins

# Expose Mattermost API (8065) and PostgreSQL (5432)
EXPOSE 8065 5432

# Health check: verify Mattermost API is responding
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=12 \
    CMD curl -sf http://localhost:8065/api/v4/system/ping || exit 1

ENTRYPOINT ["/mm/docker-entry.sh"]
