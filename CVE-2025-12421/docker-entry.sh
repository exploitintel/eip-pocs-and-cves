#!/bin/bash
# Entry point for CVE-2025-12421 Mattermost lab container
# Starts PostgreSQL and Mattermost server

set -e

echo "=== CVE-2025-12421 Lab Container Starting ==="

echo "[1/4] Starting PostgreSQL..."
docker-entrypoint.sh postgres -c 'shared_buffers=256MB' -c 'max_connections=300' -c 'listen_addresses=*' &

echo "[2/4] Waiting for PostgreSQL to be ready..."
until pg_isready -h localhost -p 5432 -U "$POSTGRES_USER" &> /dev/null; do
    echo "  PostgreSQL not ready yet, waiting..."
    sleep 2
done
echo "  PostgreSQL is ready!"

echo "[3/4] Updating CA certificates..."
update-ca-certificates --fresh >/dev/null 2>&1 || true

echo "[4/4] Starting Mattermost Server v11.0.2..."
cd /mm/mattermost
exec ./bin/mattermost --config=config/config_docker.json
