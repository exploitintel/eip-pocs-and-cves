# CVE-2026-0773 Lab â€” Upsonic v0.55.6 Cloudpickle Deserialization RCE
# Exploit Intelligence Platform | https://exploit-intel.com | @exploit_intel

FROM python:3.12-slim AS vulnerable

LABEL description="CVE-2026-0773 - Upsonic v0.55.6 Cloudpickle Deserialization RCE"
LABEL cve="CVE-2026-0773"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    gcc \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /opt/upsonic

# Clone the vulnerable version directly from GitHub at the v0.55.6 tag
RUN git clone --depth 1 --branch v0.55.6 https://github.com/Upsonic/Upsonic.git /opt/upsonic

# Install the package with all dependencies
# Use --no-cache-dir to keep image small
RUN pip install --no-cache-dir -e . 2>&1 || \
    pip install --no-cache-dir -e . --no-build-isolation 2>&1

# Install curl for healthcheck (already done above, but ensure it's there)
# Verify the vulnerable code is present
RUN python3 -c "import upsonic; print('Upsonic version:', upsonic.__version__ if hasattr(upsonic, '__version__') else 'installed')"
RUN test -f /opt/upsonic/src/upsonic/tools_server/server/tools.py && \
    grep -q 'cloudpickle.loads' /opt/upsonic/src/upsonic/tools_server/server/tools.py && \
    echo "[+] Vulnerable cloudpickle.loads() confirmed in tools_server"

# Copy entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose the main server port (attack target)
EXPOSE 7541

# Health check against the main server
HEALTHCHECK --interval=5s --timeout=3s --retries=15 --start-period=20s \
    CMD curl -sf http://localhost:7541/status || exit 1

ENTRYPOINT ["/entrypoint.sh"]
