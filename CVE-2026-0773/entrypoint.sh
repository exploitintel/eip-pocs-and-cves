#!/bin/bash
set -e

echo "[*] Starting Upsonic tools_server on localhost:8086..."
python3 -m uvicorn upsonic.tools_server.server.api:app --host localhost --port 8086 --no-access-log &
TOOLS_PID=$!

echo "[*] Starting Upsonic main server on 0.0.0.0:7541..."
python3 -m uvicorn upsonic.server.api:app --host 0.0.0.0 --port 7541 --no-access-log &
MAIN_PID=$!

# Wait for both servers to be ready
echo "[*] Waiting for servers to start..."
for i in $(seq 1 30); do
    if curl -sf http://localhost:7541/status > /dev/null 2>&1; then
        echo "[+] Main server is ready on port 7541"
        break
    fi
    sleep 1
done

for i in $(seq 1 30); do
    if curl -sf http://localhost:8086/tools/status > /dev/null 2>&1; then
        echo "[+] Tools server is ready on port 8086"
        break
    fi
    sleep 1
done

echo "[+] Upsonic v0.55.6 vulnerable lab is running"
echo "[+] Main server: http://0.0.0.0:7541 (attack target)"
echo "[+] Tools server: http://localhost:8086 (internal)"

# Keep container alive - wait for either process
wait -n $TOOLS_PID $MAIN_PID
