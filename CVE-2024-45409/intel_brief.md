# Intel Brief: CVE-2024-45409

## CVE ID
CVE-2024-45409

## Affected Software
- **Name:** ruby-saml
- **Vendor:** SAML-Toolkits (formerly OneLogin)
- **Description:** Ruby SAML library for implementing the client side of SAML authorization
- **Also affects:** omniauth-saml (≤1.10.3, 2.0.0–2.1.0), GitLab CE/EE (≤16.11.10)

## CVSS Score
- **Score:** 10.0 (Critical)
- **Vector:** CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:N
- **EPSS:** 40.7% exploitation probability (97.3rd percentile)

## CWE Classification
- **CWE-347:** Improper Verification of Cryptographic Signature

## Vulnerability Description

Ruby-SAML versions ≤1.12.2 and 1.13.0–1.16.0 do not properly verify the signature of SAML Responses due to **incorrect XPath selectors** in `lib/xml_security.rb`. The `validate_signature` method in `XMLSecurity::SignedDocument` uses document-global XPath selectors (prefixed with `//`) instead of context-relative selectors (prefixed with `./`) when resolving signature-related elements.

### Root Cause — Incorrect XPath Selectors

The vulnerable code in `validate_signature()` (lib/xml_security.rb) uses these **document-global** XPath expressions:

1. **`//ds:Reference`** (line 317) — Finds the first `<ds:Reference>` anywhere in the entire document, not necessarily under the actual `<ds:SignedInfo>`. An attacker can inject a second `<ds:Reference>` element elsewhere in the document (e.g., inside `<samlp:StatusDetail>`) that points to the attacker-controlled assertion.

2. **`//ds:CanonicalizationMethod`** (line 323) — Resolves canonicalization method from anywhere in the document.

3. **`//ds:DigestMethod`** (line 332) — Resolves digest method from anywhere in the document.

4. **`//ds:DigestValue`** (line 338) — Resolves digest value from anywhere in the document.

5. **`//ds:Transforms/ds:Transform`** (line 364) — Resolves transforms from anywhere in the document.

### Attack Mechanism (XML Signature Wrapping)

The attack works as follows:

1. **Obtain a legitimately signed SAML response** from the IdP (any previously captured or intercepted response works, even an expired one).
2. **Move the `<ds:Signature>` element** from the response level into the assertion element.
3. **Set the assertion's ID** to match the `<ds:Reference URI>` so the signature's reference points to this (attacker-modified) assertion.
4. **Modify the assertion's `<saml:NameID>`** to the target user (e.g., admin).
5. **Extend all temporal conditions** (`NotOnOrAfter`, `SessionNotOnOrAfter`) to future dates.
6. **Insert a crafted `<ds:Reference>` element** inside `<samlp:StatusDetail>` (within the `<samlp:Status>` element) that:
   - Points to the modified assertion's ID
   - Contains a freshly computed `<ds:DigestValue>` matching the canonical form of the modified assertion
7. **The `//ds:Reference` XPath** in the vulnerable code finds the attacker's injected reference (in `StatusDetail`) instead of the legitimate one in `SignedInfo`, causing the digest check to pass against the forged assertion.

The cryptographic signature itself remains valid because it was signed by the legitimate IdP — the vulnerability is that ruby-saml checks the digest of the *wrong* element (the one the attacker points to via the injected reference).

### Impact
An **unauthenticated attacker** with access to any signed SAML document (even expired) can forge a SAML Response to **authenticate as any user** in the vulnerable system, including administrators.

## Repository URL
- **Clone URL:** https://github.com/SAML-Toolkits/ruby-saml.git
- **Homepage:** https://github.com/SAML-Toolkits/ruby-saml

## Vulnerable Versions
- **Branch 1.13.x–1.16.x:** All versions from 1.13.0 through **1.16.0** (inclusive)
- **Branch ≤1.12.x:** All versions up to and including **1.12.2**
- **Checked out version:** `v1.16.0` (tag, commit `148a4c2`)
  - This is the latest vulnerable release on the main version line

## Fix Commits
1. **Main branch fix (→ v1.17.0):** `4865d030cae9705ee5cdb12415c654c634093ae7`
   - Author: ahacker1 (SecureSAML)
   - Message: "Use correct XPaths and resolve to correct elements; Block references that resolve to multiple nodes to prevent signature wrapping attacks"
   - Changes `//` XPath selectors to `./` (context-relative) in `lib/xml_security.rb`
   - Adds check for duplicate ID elements (returns error if `reference_nodes.length > 1`)

2. **1.12.x backport fix (→ v1.12.3):** `1ec5392bc506fe43a02dbb66b68741051c5ffeae`
   - Author: Sixto Martin
   - Message: "Release 1.12.3 to include critical vulnerability CVE-2024-45409 fix"
   - Same XPath corrections plus version bump

## Patched Versions
- **v1.17.0** — First patched release on 1.13+ line (contains fix commit `4865d03`)
- **v1.12.3** — Backport patch for 1.12.x line (contains fix commit `1ec5392`)

## Vulnerable File
- **Primary:** `lib/xml_security.rb` — `XMLSecurity::SignedDocument#validate_signature` method
- **Supporting:** `lib/onelogin/ruby-saml/response.rb` — SAML Response processing

### Key Vulnerable Code (v1.16.0, lib/xml_security.rb, lines 317-341)
```ruby
# VULNERABLE: uses //ds:Reference (document-global) instead of ./ds:Reference (context-relative)
ref = REXML::XPath.first(sig_element, "//ds:Reference", {"ds"=>DSIG})

hashed_element = document.at_xpath("//*[@ID=$id]", nil, { 'id' => extract_signed_element_id })

canon_algorithm = canon_algorithm REXML::XPath.first(
  ref,
  '//ds:CanonicalizationMethod',  # VULNERABLE: document-global
  { "ds" => DSIG }
)

digest_algorithm = algorithm(REXML::XPath.first(
  ref,
  "//ds:DigestMethod",  # VULNERABLE: document-global
  { "ds" => DSIG }
))

encoded_digest_value = REXML::XPath.first(
  ref,
  "//ds:DigestValue",  # VULNERABLE: document-global
  { "ds" => DSIG }
)
```

### Fix Applied (lib/xml_security.rb)
```ruby
# FIXED: uses ./ds:Reference (context-relative) under SignedInfo
signed_info_element = REXML::XPath.first(sig_element, "./ds:SignedInfo", {"ds" => DSIG})
ref = REXML::XPath.first(signed_info_element, "./ds:Reference", {"ds"=>DSIG})

# FIXED: checks for duplicate ID elements
reference_nodes = document.xpath("//*[@ID=$id]", nil, { 'id' => extract_signed_element_id })
if reference_nodes.length > 1
  return append_error("Digest Mismatch", soft)
end
hashed_element = reference_nodes[0]

# FIXED: all child XPaths use ./ instead of //
canon_algorithm = canon_algorithm REXML::XPath.first(signed_info_element, './ds:CanonicalizationMethod', {"ds" => DSIG})
digest_algorithm = algorithm(REXML::XPath.first(ref, "./ds:DigestMethod", {"ds" => DSIG}))
encoded_digest_value = REXML::XPath.first(ref, "./ds:DigestValue", {"ds" => DSIG})
```

## Build System
- **Type:** RubyGems (gemspec + Bundler)
- **Language:** Ruby
- **Build files:** `ruby-saml.gemspec`, `Gemfile`, `Rakefile`
- **Ruby version required:** >= 1.8.7 (recommended: Ruby 2.7+ or 3.x for modern testing)
- **Install:** `gem install ruby-saml -v 1.16.0` or `bundle install`
- **Test framework:** minitest + shoulda + mocha

## Key Dependencies
- **nokogiri** (>= 1.13.10 for Ruby >= 2.6) — XML parsing (used for canonicalization)
- **rexml** — XML parsing (used for XPath queries — this is where the vulnerability lives)
- **openssl** — Cryptographic signature verification
- **base64** — Encoding/decoding SAML messages

## Public Exploits

### 1. Synacktiv PoC (Primary Reference)
- **Source:** GitHub (synacktiv/CVE-2024-45409)
- **EIP ID:** 62128
- **Stars:** 83
- **Classification:** `working_poc` (95% confidence)
- **Attack type:** Authentication bypass
- **Complexity:** Moderate
- **Reliability:** Reliable
- **Requires authentication:** No
- **Language:** Python (lxml)
- **Prerequisites:** A valid (even expired) signed SAML response from the target IdP
- **Saved to:** `poc/CVE-2024-45409.py`
- **How it works:**
  1. Takes a legitimate SAML response XML file as input
  2. Moves the `<ds:Signature>` from the response into the assertion
  3. Sets assertion ID to match the signature's reference URI
  4. Replaces `<saml:NameID>` with the target user
  5. Extends all time conditions to future dates
  6. Inserts a crafted `<ds:Reference>` in `<samlp:StatusDetail>` with a recomputed digest
  7. Outputs the forged SAML response ready for submission to the SP

### 2. Nuclei Template
- **Template:** CVE-2024-45409 (verified, critical)
- **Target:** GitLab SAML Authentication Bypass
- **Recon:** Shodan dork: `http.title:"GitLab"`

## Lab Reproduction Strategy

To reproduce this vulnerability in a lab environment:

1. **Set up a Ruby application** that uses ruby-saml v1.16.0 as a SAML Service Provider (SP)
2. **Set up a SAML Identity Provider (IdP)** — can use a simple test IdP (e.g., SimpleSAMLphp or a mock IdP)
3. **Perform a legitimate SAML login** to capture a valid signed SAML response
4. **Run the Synacktiv PoC** against the captured response to forge a response as a different user
5. **Submit the forged response** to the SP's ACS (Assertion Consumer Service) endpoint
6. **Verify:** The SP accepts the forged assertion and authenticates as the target user

### Key Lab Requirements
- Ruby runtime (2.7+ recommended)
- ruby-saml gem v1.16.0
- A SAML IdP with signing capability (self-signed cert is fine)
- A minimal SP application that processes SAML responses using ruby-saml
- Python 3 with lxml (for the PoC exploit script)

## References
1. **Vendor Advisory (GHSA):** https://github.com/SAML-Toolkits/ruby-saml/security/advisories/GHSA-jw9c-mfg7-9rx2
2. **Fix Commit (v1.17.0):** https://github.com/SAML-Toolkits/ruby-saml/commit/4865d030cae9705ee5cdb12415c654c634093ae7
3. **Fix Commit (v1.12.3):** https://github.com/SAML-Toolkits/ruby-saml/commit/1ec5392bc506fe43a02dbb66b68741051c5ffeae
4. **OmniAuth-SAML Advisory:** https://github.com/omniauth/omniauth-saml/security/advisories/GHSA-cvp8-5r8g-fhvq
5. **Synacktiv PoC:** https://github.com/synacktiv/CVE-2024-45409
6. **Debian Advisory:** https://lists.debian.org/debian-lts-announce/2024/11/msg00006.html
7. **NetApp Advisory:** https://security.netapp.com/advisory/ntap-20240926-0008/
8. **HackerNews Discussion:** https://news.ycombinator.com/item?id=41586031
