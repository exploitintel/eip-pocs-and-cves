# CVE-2024-45409 Lab - ruby-saml SAML Authentication Bypass via XML Signature Wrapping
FROM ruby:3.1-slim-bookworm

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libxml2-dev \
    libxslt-dev \
    python3 \
    python3-pip \
    python3-venv \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python lxml for the PoC exploit
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --no-cache-dir lxml
ENV PATH="/opt/venv/bin:$PATH"

# Install the vulnerable ruby-saml version and dependencies
RUN gem install ruby-saml -v 1.16.0 && \
    gem install sinatra -v 3.1.0 && \
    gem install webrick -v 1.8.1 && \
    gem install base64

WORKDIR /app

# Copy certificates
COPY certs/ /app/certs/

# Copy the SP application
COPY sp_app.rb /app/sp_app.rb

# Copy the mock IdP script (generates legitimate signed SAML responses)
COPY mock_idp.rb /app/mock_idp.rb

# Copy the PoC exploits
COPY exploit.py /app/exploit.py
COPY ruby_exploit.rb /app/ruby_exploit.rb

# Expose the SP port
EXPOSE 4567

# Start the SP application
CMD ["ruby", "/app/sp_app.rb"]
