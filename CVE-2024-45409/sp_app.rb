#!/usr/bin/env ruby
# Minimal SAML Service Provider using ruby-saml v1.16.0 (VULNERABLE)
# This SP processes SAML responses and demonstrates CVE-2024-45409

require 'sinatra'
require 'onelogin/ruby-saml'
require 'base64'
require 'digest'
require 'json'

set :bind, '0.0.0.0'
set :port, 4567

# Compute the IdP certificate fingerprint
IDP_CERT_TEXT = File.read('/app/certs/ruby-saml.crt')
IDP_CERT = OpenSSL::X509::Certificate.new(IDP_CERT_TEXT)
IDP_CERT_FINGERPRINT = Digest::SHA1.hexdigest(IDP_CERT.to_der).scan(/../).join(":")

puts "[SP] ruby-saml version: #{OneLogin::RubySaml::VERSION}"
puts "[SP] IdP Certificate Fingerprint (SHA1): #{IDP_CERT_FINGERPRINT}"
puts "[SP] Starting SAML Service Provider on port 4567..."

def get_settings
  settings = OneLogin::RubySaml::Settings.new
  settings.idp_cert_fingerprint = IDP_CERT_FINGERPRINT
  settings.idp_cert = IDP_CERT_TEXT
  settings.assertion_consumer_service_url = "http://localhost:4567/saml/acs"
  settings.issuer = "http://sp.example.com"
  # Relax some validation for lab demo
  settings.soft = true
  settings
end

# Health check
get '/' do
  content_type :html
  <<-HTML
  <html>
  <body>
    <h1>SAML Service Provider (ruby-saml v#{OneLogin::RubySaml::VERSION})</h1>
    <p>Status: Running</p>
    <p>IdP Certificate Fingerprint: #{IDP_CERT_FINGERPRINT}</p>
    <h2>Endpoints:</h2>
    <ul>
      <li>POST /saml/acs - Assertion Consumer Service (accepts SAMLResponse)</li>
      <li>GET /health - Health check (JSON)</li>
      <li>POST /saml/acs_raw - ACS accepting raw XML (not base64)</li>
    </ul>
    <h2>Test Form:</h2>
    <form method="POST" action="/saml/acs">
      <label>SAMLResponse (Base64):</label><br/>
      <textarea name="SAMLResponse" rows="10" cols="80"></textarea><br/>
      <input type="submit" value="Submit SAML Response"/>
    </form>
  </body>
  </html>
  HTML
end

get '/health' do
  content_type :json
  {
    status: 'ok',
    ruby_saml_version: OneLogin::RubySaml::VERSION,
    idp_cert_fingerprint: IDP_CERT_FINGERPRINT
  }.to_json
end

# ACS endpoint - accepts base64-encoded SAMLResponse
post '/saml/acs' do
  content_type :json

  saml_response_b64 = params[:SAMLResponse]

  unless saml_response_b64
    status 400
    return { error: "Missing SAMLResponse parameter" }.to_json
  end

  begin
    saml_settings = get_settings
    # Skip some non-essential validations for lab purposes
    response = OneLogin::RubySaml::Response.new(
      saml_response_b64,
      settings: saml_settings,
      skip_recipient_check: true,
      skip_destination: true,
      skip_audience: true,
      skip_subject_confirmation: true,
      allowed_clock_drift: 315360000  # 10 years - lab environment
    )

    if response.is_valid?
      status 200
      result = {
        status: 'authenticated',
        name_id: response.name_id,
        session_index: response.sessionindex,
        attributes: {},
        message: "SAML authentication successful for: #{response.name_id}"
      }

      # Try to extract attributes
      begin
        response.attributes.each do |key, value|
          result[:attributes][key] = value
        end
      rescue => e
        result[:attribute_error] = e.message
      end

      result.to_json
    else
      status 401
      {
        status: 'rejected',
        errors: response.errors,
        message: "SAML authentication failed"
      }.to_json
    end
  rescue => e
    status 500
    {
      status: 'error',
      error: e.class.name,
      message: e.message,
      backtrace: e.backtrace&.first(5)
    }.to_json
  end
end

# ACS endpoint accepting raw XML (not base64) - for easier testing
post '/saml/acs_raw' do
  content_type :json

  raw_xml = request.body.read

  unless raw_xml && !raw_xml.empty?
    status 400
    return { error: "Missing request body (raw XML)" }.to_json
  end

  begin
    # Encode to base64 as ruby-saml expects
    saml_response_b64 = Base64.encode64(raw_xml)

    saml_settings = get_settings
    response = OneLogin::RubySaml::Response.new(
      saml_response_b64,
      settings: saml_settings,
      skip_recipient_check: true,
      skip_destination: true,
      skip_audience: true,
      skip_subject_confirmation: true,
      allowed_clock_drift: 315360000  # 10 years
    )

    if response.is_valid?
      status 200
      {
        status: 'authenticated',
        name_id: response.name_id,
        session_index: response.sessionindex,
        message: "SAML authentication successful for: #{response.name_id}"
      }.to_json
    else
      status 401
      {
        status: 'rejected',
        errors: response.errors,
        message: "SAML authentication failed"
      }.to_json
    end
  rescue => e
    status 500
    {
      status: 'error',
      error: e.class.name,
      message: e.message,
      backtrace: e.backtrace&.first(5)
    }.to_json
  end
end
