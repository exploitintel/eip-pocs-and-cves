# CVE-2026-28215 - Hoppscotch Backend (Vulnerable Version 2026.1.1)
# Unauthenticated onboarding config overwrite
FROM node:22-bookworm AS builder

RUN apt-get update && apt-get install -y --no-install-recommends git && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src/app

# Install pnpm (version matching the project)
RUN npm i -g pnpm@10

# Clone Hoppscotch at vulnerable version (shallow clone for speed)
RUN git clone --branch 2026.1.1 --depth 1 https://github.com/hoppscotch/hoppscotch.git /tmp/hoppscotch

# Copy lockfile and fetch all packages into pnpm store
RUN cp /tmp/hoppscotch/pnpm-lock.yaml . && \
    pnpm config set manage-package-manager-versions false && \
    pnpm fetch

# Copy the backend package source from the clone
RUN cp -a /tmp/hoppscotch/packages/hoppscotch-backend/. .

# Strip the generate-gql-sdl from postinstall (it tries to start the full app which needs a DB)
# Keep only "prisma generate" in postinstall
RUN node -e " \
  const fs = require('fs'); \
  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); \
  pkg.scripts.postinstall = 'cross-env DATABASE_URL=postgresql://x:x@localhost/x prisma generate'; \
  fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2)); \
"

# Install dependencies with build scripts enabled for native modules (argon2, bcrypt, prisma)
RUN pnpm install --prefer-offline

# Build the NestJS backend (nest build + copy mailer templates)
RUN pnpm run build

# --- Production stage ---
FROM node:22-bookworm-slim AS prod

WORKDIR /usr/src/app

# Install pnpm and openssl (Prisma needs openssl for engine detection)
RUN apt-get update && apt-get install -y openssl && rm -rf /var/lib/apt/lists/* && \
    npm i -g pnpm@10

# Copy built artifacts and dependencies
COPY --from=builder /usr/src/app/node_modules ./node_modules
COPY --from=builder /usr/src/app/dist ./dist
COPY --from=builder /usr/src/app/package.json ./package.json
COPY --from=builder /usr/src/app/prisma ./prisma
# prisma.config.ts is required by Prisma 7.x for datasource URL resolution
COPY --from=builder /usr/src/app/prisma.config.ts ./prisma.config.ts

# Copy entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENV PRODUCTION="true"
ENV PORT=3170

EXPOSE 3170

ENTRYPOINT ["/entrypoint.sh"]
