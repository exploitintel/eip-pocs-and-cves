#!/bin/bash
set -e

echo "[entrypoint] Waiting for PostgreSQL to be ready..."
until node -e "
const { Client } = require('pg');
const c = new Client({ connectionString: process.env.DATABASE_URL });
c.connect().then(() => { c.end(); process.exit(0); }).catch(() => process.exit(1));
" 2>/dev/null; do
  echo "[entrypoint] PostgreSQL not ready yet, retrying in 2s..."
  sleep 2
done
echo "[entrypoint] PostgreSQL is ready."

echo "[entrypoint] Running Prisma migrations..."
pnpm exec prisma migrate deploy
echo "[entrypoint] Migrations complete."

echo "[entrypoint] Starting Hoppscotch backend on port ${PORT:-3170}..."
# NestJS builds to dist/src/ when prisma.config.ts is at project root
if [ -f dist/src/main.js ]; then
  exec node dist/src/main
else
  exec node dist/main
fi
