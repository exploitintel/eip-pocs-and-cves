# Lab Build Report: CVE-2025-59390

## Lab Architecture

The lab reproduces CVE-2025-59390 — a weak PRNG vulnerability in Apache Druid's Kerberos authenticator cookie signing. The lab provides a fully functional Kerberos-authenticated Druid 34.0.0 instance where the `cookieSignatureSecret` is deliberately omitted, triggering the vulnerable `ThreadLocalRandom.current().nextLong()` code path.

### Container Topology (4 containers)

| Container | Image | Role | Network(s) |
|---|---|---|---|
| `cve-2025-59390-kdc` | Custom (Debian bookworm + MIT Kerberos) | Kerberos Key Distribution Center | lab-net |
| `cve-2025-59390-postgres` | `postgres:16-bookworm` | Druid metadata store | lab-net |
| `cve-2025-59390-zookeeper` | `zookeeper:3.5.10` | Druid coordination service | lab-net |
| `cve-2025-59390-druid` | Custom (extends `apache/druid:34.0.0`) | **Vulnerable Druid 34.0.0 Coordinator** | lab-net |

### Network Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  lab-net (internal)                                             │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ KDC          │  │ PostgreSQL   │  │ ZooKeeper            │  │
│  │ port 88      │  │ port 5432    │  │ port 2181            │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Druid 34.0.0 Coordinator (VULNERABLE)                    │   │
│  │ port 8081                                                │   │
│  │ Kerberos auth: ENABLED                                   │   │
│  │ cookieSignatureSecret: NOT SET (triggers CVE-2025-59390) │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
         │
         │ port 8081 mapped to localhost
         ▼
```

## Container Details

### KDC Container (`cve-2025-59390-kdc`)
- **Image**: Custom Dockerfile based on `debian:bookworm` with MIT Kerberos (`krb5-kdc`, `krb5-admin-server`)
- **Realm**: `EXAMPLE.COM`
- **Principals**:
  - `HTTP/cve-2025-59390-druid@EXAMPLE.COM` — Druid service principal (keytab exported)
  - `testuser@EXAMPLE.COM` — Test user (password: `testpassword`)
  - `admin/admin@EXAMPLE.COM` — Admin principal (password: `adminpassword`)
- **Shared Volume**: Exports keytab to `/keytab-share/druid.keytab` (shared with Druid container)
- **Health Check**: Checks for `/keytab-share/.kdc-ready` marker file

### PostgreSQL Container (`cve-2025-59390-postgres`)
- **Image**: `postgres:16-bookworm`
- **Database**: `druid` (user: `druid`, password: `FoolishPassword`)
- **Purpose**: Druid metadata storage

### ZooKeeper Container (`cve-2025-59390-zookeeper`)
- **Image**: `zookeeper:3.5.10`
- **Purpose**: Druid cluster coordination

### Druid Container (`cve-2025-59390-druid`)
- **Image**: Custom Dockerfile extending `apache/druid:34.0.0` (adds `/etc/krb5.conf`)
- **Service**: Coordinator (also runs as Overlord in micro-quickstart mode)
- **Port**: 8081 (HTTP, Kerberos-authenticated)
- **Kerberos Config**:
  - `druid.auth.authenticatorChain=["kerberos"]`
  - `druid.auth.authenticator.kerberos.type=kerberos`
  - `druid.auth.authenticator.kerberos.serverPrincipal=HTTP/cve-2025-59390-druid@EXAMPLE.COM`
  - `druid.auth.authenticator.kerberos.serverKeytab=/etc/security/keytabs/druid.keytab`
  - `druid.auth.authenticator.kerberos.authorizerName=allowAll`
  - **`cookieSignatureSecret` is deliberately NOT SET** — this triggers CVE-2025-59390
- **JAVA_OPTS**: `-Djava.security.krb5.conf=/etc/krb5.conf -Dsun.security.krb5.debug=true`
- **Volumes**: Keytab from shared volume, krb5.conf baked into image

## Build Status

| Container | Status | Notes |
|---|---|---|
| `cve-2025-59390-kdc` | ✅ Running (healthy) | KDC initialized, principals created, keytab exported |
| `cve-2025-59390-postgres` | ✅ Running (healthy) | Database ready |
| `cve-2025-59390-zookeeper` | ✅ Running (healthy) | ZooKeeper ready |
| `cve-2025-59390-druid` | ✅ Running | Druid coordinator started with Kerberos auth |

### Platform Note
The Druid image is `linux/amd64` running on an `arm64` host via QEMU emulation. This causes startup warnings but does not affect functionality.

## Vulnerability Confirmation

### 1. Weak Secret Generated (Log Evidence)
```
2026-03-01T16:46:49,105 WARN [main] org.apache.druid.security.kerberos.KerberosAuthenticator -
  'signature.secret' configuration not set, using a random value as secret
```
This confirms `ThreadLocalRandom.current().nextLong()` was used to generate the cookie signing secret.

### 2. Kerberos SPNEGO Authentication Working
Authenticated as `testuser@EXAMPLE.COM` via SPNEGO and received a signed cookie:
```
Set-Cookie: hadoop.auth="u=testuser&p=testuser@EXAMPLE.COM&t=kerberos&e=1772419844563&s=XeYGKvT1FQ7snsHIG50byxov0hk8HdlvolGiE4fbTYU="
```

### 3. Cookie-Based Authentication Working
The signed cookie grants HTTP 200 access to `/status` endpoint, proving the HMAC-SHA256 signature verification is active. A forged cookie with a valid signature for the weak secret would bypass Kerberos authentication entirely.

### 4. Invalid Signatures Rejected
Sending a cookie with an invalid signature returns:
```
HTTP/1.1 403 Forbidden
SignerException: Invalid signed text
```

## Start/Stop Commands

### Start Lab
```bash
cd CVE-2025-59390
docker compose build
docker compose up -d
```

### Stop Lab
```bash
docker compose down
```

### Stop Lab and Remove Volumes
```bash
docker compose down -v
```

### View Druid Logs
```bash
docker compose logs druid
```

### Rebuild After Changes
```bash
docker compose build --no-cache
docker compose up -d --force-recreate
```

## Accessing the Lab

### Test Unauthenticated Access (should return 401)
```bash
curl -s -o /dev/null -w "%{http_code}" "http://localhost:8081/status"
# Expected: 401
```

### Test with Valid Cookie (should return 200)
```bash
curl -s -b 'hadoop.auth="u=testuser&p=testuser@EXAMPLE.COM&t=kerberos&e=1772419844563&s=XeYGKvT1FQ7snsHIG50byxov0hk8HdlvolGiE4fbTYU="' "http://localhost:8081/status"
# Expected: 200 with Druid status JSON
```

### SPNEGO Authentication (from KDC container)
```bash
docker exec cve-2025-59390-kdc bash -c '
  echo "testpassword" | kinit testuser@EXAMPLE.COM
  curl -sv --negotiate -u: http://cve-2025-59390-druid:8081/status
'
```

## PoC Agent Instructions

### Vulnerability Mechanism
1. The Druid coordinator at `localhost:8081` has Kerberos auth enabled
2. The cookie signing secret was generated as `Long.toString(ThreadLocalRandom.current().nextLong())` — a decimal string of a Java long
3. Cookies are signed with `HMAC-SHA256(secret_bytes, token_string)` where `token_string` is the cookie value before `&s=`

### Cookie Format
```
hadoop.auth="u=<username>&p=<principal>&t=kerberos&e=<expiry_ms>&s=<base64_hmac_sha256>"
```

Example from the lab:
- **Token string**: `u=testuser&p=testuser@EXAMPLE.COM&t=kerberos&e=1772419844563`
- **Signature**: `XeYGKvT1FQ7snsHIG50byxov0hk8HdlvolGiE4fbTYU=` (Base64-encoded HMAC-SHA256)
- **Secret**: A Java long converted to string via `Long.toString()`, generated by `ThreadLocalRandom`

### PoC Approach
1. Use the known token string and signature from the SPNEGO authentication above
2. Brute-force the secret by iterating over candidate long values, computing `HMAC-SHA256(str(candidate).encode('utf-8'), token_string.encode('utf-8'))`, and comparing to the observed signature
3. Once the secret is recovered, forge a new cookie for any user (e.g., `admin@EXAMPLE.COM`) with a far-future expiry
4. Verify the forged cookie grants access to Druid endpoints

### Key Endpoints
- `/status` — Druid version and module info
- `/druid/coordinator/v1/servers` — List cluster servers
- `/druid/coordinator/v1/metadata/datasources` — List data sources

### Credentials
- **Test user**: `testuser@EXAMPLE.COM` / `testpassword`
- **Druid DB**: `druid` / `FoolishPassword` (PostgreSQL)

## Known Issues / Workarounds

1. **Platform mismatch**: The `apache/druid:34.0.0` image is `linux/amd64` only. On ARM64 hosts, it runs via QEMU emulation (slower but functional).

2. **Coordinator self-auth errors**: The coordinator logs `401 Unauthorized` errors when trying to communicate with its own indexer endpoints. This is expected in a single-node setup where internal service-to-service calls also go through Kerberos auth. It does not affect the vulnerability demonstration.

3. **Cookie expiry**: The SPNEGO-obtained cookie expires after ~10 hours. For PoC testing, use SPNEGO to obtain a fresh cookie or forge one with a far-future expiry.

4. **No bind mounts**: Due to Docker-in-Docker networking, the lab uses built-in files (Dockerfile COPY) and Docker volumes instead of host bind mounts. The `krb5.conf` is baked into the Druid image, and the keytab is shared via a Docker volume.

## File Manifest

| File | Purpose |
|---|---|
| `docker-compose.yml` | Orchestrates all 4 containers |
| `Dockerfile.kdc` | MIT Kerberos KDC container |
| `Dockerfile.vulnerable` | Extends `apache/druid:34.0.0` with krb5.conf |
| `environment` | Druid configuration (Kerberos auth, no cookieSignatureSecret) |
| `krb5.conf` | Kerberos realm configuration |
| `kdc.conf` | KDC server configuration |
| `kadm5.acl` | Kerberos admin ACL |
| `kdc-entrypoint.sh` | KDC initialization and startup script |
