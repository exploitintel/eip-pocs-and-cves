#!/bin/bash
set -e

REALM="EXAMPLE.COM"
KEYTAB_DIR="/keytab-share"
DRUID_HOST="cve-2025-59390-druid"

echo "=== Initializing KDC for realm $REALM ==="

# Create KDC database (non-interactive)
kdb5_util create -s -r "$REALM" -P masterkey 2>/dev/null || echo "KDC database may already exist"

# Create the Druid service principal
kadmin.local -q "addprinc -randkey HTTP/${DRUID_HOST}@${REALM}" 2>/dev/null || true

# Create a test user principal (for PoC authentication)
kadmin.local -q "addprinc -pw testpassword testuser@${REALM}" 2>/dev/null || true

# Create an admin user principal
kadmin.local -q "addprinc -pw adminpassword admin/admin@${REALM}" 2>/dev/null || true

# Export keytab for Druid service
mkdir -p "$KEYTAB_DIR"
kadmin.local -q "ktadd -k ${KEYTAB_DIR}/druid.keytab HTTP/${DRUID_HOST}@${REALM}" 2>/dev/null || true
chmod 644 "${KEYTAB_DIR}/druid.keytab"

# Signal that setup is complete
touch "${KEYTAB_DIR}/.kdc-ready"

echo "=== KDC initialization complete ==="
echo "  Realm: $REALM"
echo "  Service principal: HTTP/${DRUID_HOST}@${REALM}"
echo "  Test user: testuser@${REALM} (password: testpassword)"
echo "  Keytab: ${KEYTAB_DIR}/druid.keytab"

# Start KDC in foreground
echo "=== Starting KDC daemon ==="
exec krb5kdc -n
