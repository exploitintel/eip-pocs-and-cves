FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# Install Apache, PHP 8.2, and required extensions
RUN apt-get update && apt-get install -y --no-install-recommends \
    apache2 \
    libapache2-mod-php8.2 \
    php8.2 \
    php8.2-cli \
    php8.2-common \
    php8.2-curl \
    php8.2-gd \
    php8.2-intl \
    php8.2-mbstring \
    php8.2-mysql \
    php8.2-opcache \
    php8.2-xml \
    php8.2-zip \
    mariadb-client \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Clone WeGIA at vulnerable version 3.4.10
RUN git clone --branch 3.4.10 --depth 1 \
    https://github.com/LabRedesCefetRJ/WeGIA.git /var/www/html/WeGIA

# Create config.php with DB_HOST pointing to the db container
RUN cp /var/www/html/WeGIA/config.php.init /var/www/html/WeGIA/config.php && \
    sed -i "s|'localhost'|'db'|g" /var/www/html/WeGIA/config.php && \
    sed -i "s|'https://demo.wegia.org/'|'http://localhost/WeGIA/'|g" /var/www/html/WeGIA/config.php

# Patch login.php to avoid slow external HTTP calls during login
# Replace the remote release check with a hardcoded value
RUN sed -i 's|file_get_contents("https://www.wegia.org/software/release")|"0"|g' \
    /var/www/html/WeGIA/html/login.php

# Create upload directory and set permissions
RUN mkdir -p /var/www/html/WeGIA/html/socio/sistema/tabelas && \
    chown -R www-data:www-data /var/www/html/WeGIA && \
    chmod -R 755 /var/www/html/WeGIA && \
    chmod 775 /var/www/html/WeGIA/html/socio/sistema/tabelas

# Configure Apache virtual host
RUN echo '<VirtualHost *:80>\n\
    DocumentRoot /var/www/html/WeGIA\n\
    <Directory /var/www/html/WeGIA>\n\
        AllowOverride All\n\
        Require all granted\n\
    </Directory>\n\
    ErrorLog ${APACHE_LOG_DIR}/error.log\n\
    CustomLog ${APACHE_LOG_DIR}/access.log combined\n\
</VirtualHost>' > /etc/apache2/sites-available/000-default.conf

# Enable Apache modules
RUN a2enmod php8.2 rewrite

# Increase PHP upload limits for testing
RUN echo "upload_max_filesize = 10M\npost_max_size = 10M\nmax_execution_time = 60" \
    > /etc/php/8.2/apache2/conf.d/99-lab.ini

# Copy scripts
COPY entrypoint.sh /entrypoint.sh
COPY db-init.sh /db-init.sh
RUN chmod +x /entrypoint.sh /db-init.sh

EXPOSE 80

CMD ["/entrypoint.sh"]
