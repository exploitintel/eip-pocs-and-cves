#!/bin/bash
# CVE-2025-58159 - MariaDB schema initializer for WeGIA lab
set -e

DB_HOST="db"
DB_ROOT_PASSWORD="rootpass"
DB_USER="wegiauser"
DB_PASSWORD="senha"
DB_NAME="wegia"

echo "[*] DB-INIT: Waiting for MariaDB to be ready..."
for i in $(seq 1 60); do
    if mariadb -h "$DB_HOST" -u root -p"$DB_ROOT_PASSWORD" -e "SELECT 1" >/dev/null 2>&1; then
        echo "[+] DB-INIT: MariaDB is ready!"
        break
    fi
    echo "    Attempt $i/60 - waiting..."
    sleep 2
done

# Check if schema is already imported
TABLE_EXISTS=$(mariadb -h "$DB_HOST" -u root -p"$DB_ROOT_PASSWORD" -N -e \
    "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='${DB_NAME}' AND table_name='pessoa';" 2>/dev/null || echo "0")

if [ "$TABLE_EXISTS" = "0" ]; then
    echo "[*] DB-INIT: Importing database schema (wegia001.sql)..."
    mariadb -h "$DB_HOST" -u root -p"$DB_ROOT_PASSWORD" < /var/www/html/WeGIA/BD/wegia001.sql

    echo "[*] DB-INIT: Importing seed data (wegia002.sql)..."
    mariadb -h "$DB_HOST" -u root -p"$DB_ROOT_PASSWORD" < /var/www/html/WeGIA/BD/wegia002.sql

    echo "[*] DB-INIT: Creating application user and granting privileges..."
    mariadb -h "$DB_HOST" -u root -p"$DB_ROOT_PASSWORD" <<EOF
CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';
GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%';
FLUSH PRIVILEGES;
EOF

    echo "[+] DB-INIT: Database initialization complete."
else
    echo "[*] DB-INIT: Database already initialized, ensuring user privileges..."
    mariadb -h "$DB_HOST" -u root -p"$DB_ROOT_PASSWORD" <<EOF
CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';
GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%';
FLUSH PRIVILEGES;
EOF
    echo "[+] DB-INIT: Done."
fi
