#!/bin/bash
# CVE-2025-60355 Lab Builder
# Builds OneBlog v2.3.8 JARs from source, then builds Docker Compose images.
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

BUILDER_IMAGE="cve-60355-builder"

echo "=== CVE-2025-60355 Lab Builder ==="
echo

# Step 1: Check if JARs already exist
if [ -f blog-admin.jar ] && [ -f blog-web.jar ]; then
    echo "[+] blog-admin.jar and blog-web.jar already exist, skipping Maven build."
    echo "    Delete them to force a rebuild."
else
    # Step 2: Build the builder image (Maven + source compile)
    echo "[*] Step 1/3: Building OneBlog v2.3.8 from source (this may take several minutes)..."
    docker build -f Dockerfile.builder -t "$BUILDER_IMAGE" .

    # Step 3: Extract JARs from the builder
    echo "[*] Step 2/3: Extracting JARs from builder image..."
    CONTAINER_ID=$(docker create "$BUILDER_IMAGE")
    docker cp "$CONTAINER_ID:/build/blog-admin/target/blog-admin.jar" blog-admin.jar
    docker cp "$CONTAINER_ID:/build/blog-web/target/blog-web.jar" blog-web.jar
    docker rm "$CONTAINER_ID" > /dev/null

    echo "    [+] blog-admin.jar ($(du -h blog-admin.jar | cut -f1))"
    echo "    [+] blog-web.jar ($(du -h blog-web.jar | cut -f1))"
fi

# Step 4: Build the Docker Compose stack
echo "[*] Step 3/3: Building Docker Compose images..."
docker compose build

echo
echo "[+] Build complete! Start the lab with:"
echo "    docker compose up -d"
echo
echo "[+] Wait ~30 seconds for Java apps to initialize, then run:"
echo '    ADMIN_IP=$(docker inspect cve-60355-admin --format '"'"'{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'"'"')'
echo '    WEB_IP=$(docker inspect cve-60355-web --format '"'"'{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'"'"')'
echo '    python3 poc/poc.py "$ADMIN_IP" 8085 "$WEB_IP" 8443'
