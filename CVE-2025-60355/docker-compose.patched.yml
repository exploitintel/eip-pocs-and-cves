# CVE-2025-60355 Lab: OneBlog 2.3.9 (PATCHED) FreeMarker SSTI
# Architecture: MariaDB 10.11 + Redis + blog-admin (8085) + blog-web (8443)
services:

  # Redis for Shiro session management
  cve-60355-patched-redis:
    image: redis:7-alpine
    container_name: cve-60355-patched-redis
    hostname: cve-60355-redis
    command: redis-server --appendonly yes --requirepass oneblog123456
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "oneblog123456", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - cve-60355-patched-net

  # MariaDB 10.11 (MySQL-compatible) with schema + seed data
  cve-60355-patched-mysql:
    image: ghcr.io/exploitintel/cve-2025-60355-mysql:latest
    container_name: cve-60355-patched-mysql
    hostname: cve-60355-mysql
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_ROOT_HOST: '%'
      TZ: UTC
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    healthcheck:
      test: ["CMD", "mariadb", "-u", "root", "-proot", "-e", "SELECT 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - cve-60355-patched-net

  # blog-admin v2.3.9 (patched)
  cve-60355-patched-admin:
    image: ghcr.io/exploitintel/cve-2025-60355-admin-patched:latest
    container_name: cve-60355-patched-admin
    hostname: cve-60355-admin
    environment:
      ONEBLOG_REDIS_DATABASE_INDEX: "1"
      ONEBLOG_REDIS_HOST: cve-60355-redis
      ONEBLOG_REDIS_PORT: "6379"
      ONEBLOG_REDIS_PASSWORD: oneblog123456
      ONEBLOG_DATASOURCE_HOST: cve-60355-mysql
      ONEBLOG_DATASOURCE_PORT: "3306"
      ONEBLOG_DATASOURCE_DATABASE_NAME: dblog
      ONEBLOG_DATASOURCE_USERNAME: root
      ONEBLOG_DATASOURCE_PASSWORD: root
      ONEBLOG_APP_ENABLE_KAPTCHA: "false"
      ONEBLOG_APP_ENABLE_CHECK_LINK: "false"
      ONEBLOG_APP_ENABLE_PRINT_CONFIG: "true"
      ONEBLOG_ENABLE_REDIS_CACHE: "false"
    ports:
      - "9085:8085"
    depends_on:
      cve-60355-patched-redis:
        condition: service_healthy
      cve-60355-patched-mysql:
        condition: service_healthy
    networks:
      - cve-60355-patched-net

  # blog-web v2.3.9 (patched)
  cve-60355-patched-web:
    image: ghcr.io/exploitintel/cve-2025-60355-web-patched:latest
    container_name: cve-60355-patched-web
    hostname: cve-60355-web
    environment:
      ONEBLOG_REDIS_DATABASE_INDEX: "1"
      ONEBLOG_REDIS_HOST: cve-60355-redis
      ONEBLOG_REDIS_PORT: "6379"
      ONEBLOG_REDIS_PASSWORD: oneblog123456
      ONEBLOG_DATASOURCE_HOST: cve-60355-mysql
      ONEBLOG_DATASOURCE_PORT: "3306"
      ONEBLOG_DATASOURCE_DATABASE_NAME: dblog
      ONEBLOG_DATASOURCE_USERNAME: root
      ONEBLOG_DATASOURCE_PASSWORD: root
      ONEBLOG_APP_ENABLE_KAPTCHA: "false"
      ONEBLOG_APP_ENABLE_CHECK_LINK: "false"
      ONEBLOG_APP_ENABLE_PRINT_CONFIG: "true"
      ONEBLOG_ENABLE_REDIS_CACHE: "false"
    ports:
      - "9443:8443"
    depends_on:
      cve-60355-patched-redis:
        condition: service_healthy
      cve-60355-patched-mysql:
        condition: service_healthy
    networks:
      - cve-60355-patched-net

networks:
  cve-60355-patched-net:
    driver: bridge
