# Intel Brief: CVE-2025-60355

## CVE Metadata
- **CVE ID**: CVE-2025-60355
- **Published**: 2025-10-28
- **Severity**: CRITICAL
- **CVSS Score**: 9.8
- **CVSS Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
- **EPSS**: 0.1% (21.8th percentile)
- **CWE**: CWE-1336 (Improper Neutralization of Special Elements Used in a Template Engine)
- **GHSA**: GHSA-q7cx-22m3-64gr

## Affected Software
- **Name**: OneBlog
- **Vendor**: zhangyd-c (yadong.zhang)
- **Description**: A Java blog platform built on Spring Boot with FreeMarker templating
- **Language**: Java (JDK 8)
- **Affected Versions**: All versions before 2.3.9 (< 2.3.9)
- **Vulnerable Version for PoC**: 2.3.8 (commit `8669276`)

## Description
Server-Side Template Injection (SSTI) vulnerability in zhangyd-c OneBlog via FreeMarker templates. The application allows authenticated admin users to modify template content (e.g., TM_ROBOTS) stored in the `sys_template` database table via the `POST /template/edit` endpoint (blog-admin service). This template content is then rendered by the FreeMarker engine without sandboxing when public endpoints like `/robots.txt` or `/sitemap.xml` are accessed (blog-web service).

The vulnerable code is in `FreeMarkerUtil.template2String()` at `blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java` line 79, where a FreeMarker `Configuration` object is created with `Configuration.VERSION_2_3_22` but **no `TemplateClassResolver` restriction** is applied. This allows the FreeMarker `?new()` built-in to instantiate arbitrary Java classes, specifically `freemarker.template.utility.Execute`, enabling Remote Code Execution.

## Vulnerability Details

### Root Cause
The `FreeMarkerUtil.template2String()` method creates a FreeMarker `Configuration` without sandboxing:
```java
Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
cfg.setNumberFormat("#");
// MISSING: cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);
t = new Template("", new StringReader(templateContent), cfg);
StringWriter writer = new StringWriter();
t.process(newMap, writer);
```

### Attack Vector
1. **Step 1**: Authenticate to the blog-admin service (`POST /passport/signin`) with valid admin credentials
2. **Step 2**: Modify a template (e.g., TM_ROBOTS) via `POST /template/edit` with a malicious FreeMarker payload
3. **Step 3**: Trigger the template rendering by accessing `/robots.txt` on the blog-web service (unauthenticated)

### SSTI Payload
```
<#assign value="freemarker.template.utility.Execute"?new()>${value("id")}
```

### Affected Endpoints
- **Template Edit (admin, requires auth)**: `POST /template/edit` on blog-admin (port 8085)
  - Requires Shiro authentication + `template:edit` permission
- **Template Render (public, no auth)**: `GET /robots.txt` on blog-web (port 8443)
  - Unauthenticated, triggers FreeMarker template rendering of TM_ROBOTS
- **Other render endpoints**: `GET /sitemap.xml`, `GET /sitemap.txt`, `GET /sitemap.html`

### Authentication Details
- Uses Apache Shiro for authentication
- Default credentials (from init_data.sql):
  - `root` / `123456` (AES-encrypted with salt=username + key=`929123f8f17944e8b0a531045453e1f1`)
  - `admin` / `123456`
  - `comment-admin` / `123456`
- Login endpoint: `POST /passport/signin` with params: `username`, `password`, `rememberMe`
- Captcha can be disabled via `ONEBLOG_APP_ENABLE_KAPTCHA=false` (default: false)

## Repository
- **URL**: https://github.com/zhangyd-c/OneBlog.git
- **Default Branch**: master
- **Vulnerable Version**: 2.3.8 (commit `8669276`)
- **Patched Version**: 2.3.9 (commit `ac1c801`)
- **Note**: The FreeMarkerUtil.java code was NOT modified between 2.3.8 and 2.3.9. The fix in 2.3.9 is unclear — the vulnerable code pattern still exists at HEAD. The CVE advisory states "before 2.3.9" is vulnerable.

### Fix Commit
- **Commit**: `ac1c801f06a595dab6d3a9c26d4a130b0ca5fac2` (":bookmark: 发布 2.3.9")
- **Note**: No direct SSTI fix was found in this commit. The commit primarily contains version bumps, article table refactoring, WebSocket configuration changes, and SQL schema updates. FreeMarkerUtil.java was unchanged.

## Build System
- **Build Tool**: Apache Maven (pom.xml)
- **Parent**: `org.springframework.boot:spring-boot-starter-parent:2.3.5.RELEASE`
- **Java Version**: 1.8 (JDK 8)
- **Packaging**: Multi-module Maven project
  - `blog-core` - Core library (contains FreeMarkerUtil, services, persistence)
  - `blog-admin` - Admin backend (Spring Boot app, port 8085)
  - `blog-web` - Public frontend (Spring Boot app, port 8443)
  - `blog-file` - File service
  - `blog-codegen` - Code generator

### Key Dependencies
- Spring Boot 2.3.5.RELEASE (includes FreeMarker starter)
- Apache Shiro 1.7.1 (authentication/authorization)
- shiro-redis 2.4.2.1-RELEASE (session management)
- MyBatis 2.1.4 (database mapper)
- Druid 1.2.6 (connection pool)
- MySQL 5.7 (database)
- Redis (session/cache store)
- Hutool 5.8.28 (utility library)
- FastJSON 1.2.83

### Docker Infrastructure
The project provides a `docker-compose.yml` with 4 services:
1. **blog-redis**: Redis for session/cache (port 63799 -> 6379)
2. **blog-mysql**: MySQL 5.7 with dblog.sql + init_data.sql (port 33066 -> 3306)
3. **blog-admin**: Admin backend Spring Boot app (port 8085)
4. **blog-web**: Public frontend Spring Boot app (port 8443)

Base image: `anolis-registry.cn-zhangjiakou.cr.aliyuncs.com/openanolis/openjdk:8-8.6`

### Database Schema
- `sys_template` table stores templates with `ref_key` (e.g., TM_ROBOTS) and `ref_value` (template content)
- `sys_user` table stores users with AES-encrypted passwords
- `sys_resources` / `sys_role_resources` manage Shiro permissions
- Database init: `dblog.sql` (schema) + `init_data.sql` (seed data)

## Public Exploits
- **No public exploit code found** in EIP (no Metasploit, ExploitDB, or GitHub PoCs)
- **No Nuclei templates** available
- Reference issue https://github.com/line2222/vuln/issues/4 provides:
  - Vulnerability description
  - Payload example: `<#assign value="freemarker.template.utility.Execute"?new()>${value("Calc")}`
  - Affected component: `FreeMarkerUtil.java` line 79
  - Attack path: Template Management → Edit TM_ROBOTS → Inject payload

## References
- **CVE**: https://nvd.nist.gov/vuln/detail/CVE-2025-60355
- **GHSA**: https://github.com/advisories/GHSA-q7cx-22m3-64gr
- **Exploit writeup**: https://github.com/line2222/vuln/issues/4
- **Source repo**: https://github.com/zhangyd-c/OneBlog
- **Online docs**: https://docs.zhyd.me

## PoC Strategy Recommendations
1. Build the lab using the existing docker-compose.yml structure (MySQL + Redis + blog-admin + blog-web)
2. Use Maven to build the JARs: `mvn clean package -DskipTests`
3. Login to blog-admin with default credentials (`root`/`123456`)
4. Edit TM_ROBOTS template via `POST /template/edit` with SSTI payload
5. Trigger execution by accessing `GET /robots.txt` on blog-web
6. Verify RCE with a command like `id` or write a file to prove execution
