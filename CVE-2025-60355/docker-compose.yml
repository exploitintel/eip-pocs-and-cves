# CVE-2025-60355 Lab: OneBlog 2.3.8 FreeMarker SSTI
# Architecture: MariaDB 10.11 + Redis + blog-admin (8085) + blog-web (8443)
services:

  # Redis for Shiro session management
  cve-60355-redis:
    image: redis:7-alpine
    container_name: cve-60355-redis
    hostname: cve-60355-redis
    command: redis-server --appendonly yes --requirepass oneblog123456
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "oneblog123456", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - cve-60355-net

  # MariaDB 10.11 (MySQL-compatible) with schema + seed data
  cve-60355-mysql:
    build:
      context: .
      dockerfile: Dockerfile.mysql
    image: cve-60355-mysql
    container_name: cve-60355-mysql
    hostname: cve-60355-mysql
    environment:
      MARIADB_ROOT_PASSWORD: root
      MARIADB_ROOT_HOST: '%'
      TZ: UTC
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    healthcheck:
      test: ["CMD", "mariadb", "-u", "root", "-proot", "-e", "SELECT 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - cve-60355-net

  # blog-admin: Admin backend (template edit endpoint)
  cve-60355-admin:
    build:
      context: .
      dockerfile: Dockerfile.admin
    image: cve-60355-admin
    container_name: cve-60355-admin
    hostname: cve-60355-admin
    env_file:
      - .env
    ports:
      - "8085:8085"
    depends_on:
      cve-60355-redis:
        condition: service_healthy
      cve-60355-mysql:
        condition: service_healthy
    networks:
      - cve-60355-net

  # blog-web: Public frontend (robots.txt trigger endpoint)
  cve-60355-web:
    build:
      context: .
      dockerfile: Dockerfile.web
    image: cve-60355-web
    container_name: cve-60355-web
    hostname: cve-60355-web
    env_file:
      - .env
    ports:
      - "8443:8443"
    depends_on:
      cve-60355-redis:
        condition: service_healthy
      cve-60355-mysql:
        condition: service_healthy
    networks:
      - cve-60355-net

networks:
  cve-60355-net:
    driver: bridge
