# CVE-2025-29953: Apache NMS OpenWire Client Deserialization Filter Bypass
# Vulnerable version: 2.1.0
#
# This builds the vulnerable NMS OpenWire library from source and compiles
# a PoC console app that demonstrates the deserialization filter bypass.

FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build

WORKDIR /src

# Clone the vulnerable library source (v2.1.0)
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --branch 2.1.0 --depth 1 https://github.com/apache/activemq-nms-openwire.git /src/activemq-nms-openwire

# Build the vulnerable library
WORKDIR /src/activemq-nms-openwire
RUN dotnet restore src/nms-openwire.csproj && \
    dotnet build src/nms-openwire.csproj -c Debug --no-restore

# Copy and build the PoC app
COPY poc-app/ /src/poc-app/
WORKDIR /src/poc-app
RUN dotnet restore PocApp.csproj && \
    dotnet build PocApp.csproj -c Debug --no-restore

# Publish for the runtime stage
RUN dotnet publish PocApp.csproj -c Debug -o /app/publish

# Runtime stage
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS runtime

WORKDIR /app
COPY --from=build /app/publish/ /app/

# Also copy the vulnerable source for reference
COPY --from=build /src/activemq-nms-openwire/src/ /src/vulnerable-lib/

# Set environment variables
ENV BROKER_HOST=cve-2025-29953-broker
ENV BROKER_PORT=61616
ENV DOTNET_EnableDiagnostics=0

# Default: keep container alive for the PoC agent to exec into
# Use: docker exec cve-2025-29953-vulnerable dotnet /app/PocApp.dll local
# Use: docker exec cve-2025-29953-vulnerable dotnet /app/PocApp.dll broker
CMD ["dotnet", "/app/PocApp.dll", "wait"]
