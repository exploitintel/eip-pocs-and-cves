# CVE-2025-29953: Apache NMS OpenWire Client Deserialization Filter Bypass
# Patched version: 2.1.1 (fix commit 8944c41)
#
# This builds the PATCHED NMS OpenWire library from source and compiles
# the same PoC console app to demonstrate the fix blocks the bypass.

FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build

WORKDIR /src

# Clone the patched library source (v2.1.1 includes AMQNET-844 fix)
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --branch 2.1.1 --depth 1 https://github.com/apache/activemq-nms-openwire.git /src/activemq-nms-openwire

WORKDIR /src/activemq-nms-openwire

# Build the patched library
RUN dotnet restore src/nms-openwire.csproj && \
    dotnet build src/nms-openwire.csproj -c Debug --no-restore

# Copy and build the PoC app
COPY poc-app/ /src/poc-app/
WORKDIR /src/poc-app
RUN dotnet restore PocApp.csproj && \
    dotnet build PocApp.csproj -c Debug --no-restore

# Publish for the runtime stage
RUN dotnet publish PocApp.csproj -c Debug -o /app/publish

# Runtime stage
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS runtime

WORKDIR /app
COPY --from=build /app/publish/ /app/

# Also copy the patched source for reference
COPY --from=build /src/activemq-nms-openwire/src/ /src/patched-lib/

# Set environment variables
ENV BROKER_HOST=cve-2025-29953-broker
ENV BROKER_PORT=61616
ENV DOTNET_EnableDiagnostics=0

# Default: keep container alive for the PoC agent to exec into
CMD ["dotnet", "/app/PocApp.dll", "wait"]
