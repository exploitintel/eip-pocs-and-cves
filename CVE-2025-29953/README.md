# CVE-2025-29953: Apache ActiveMQ NMS OpenWire Client Deserialization Filter Bypass

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-29953 |
| **Affected Software** | Apache ActiveMQ NMS OpenWire Client (`Apache.NMS.ActiveMQ`) |
| **Affected Versions** | < 2.1.1 (filter bypass applies to 2.0.0 – 2.1.0) |
| **Patched Version** | 2.1.1 |
| **CVSS** | 9.8 CRITICAL — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| **CWE** | CWE-502: Deserialization of Untrusted Data |
| **Author** | [Exploit Intelligence Platform](https://exploit-intel.com) |

## Overview

Apache ActiveMQ NMS OpenWire Client (`Apache.NMS.ActiveMQ`) versions before 2.1.1 contain a deserialization filter bypass vulnerability that allows arbitrary .NET type deserialization past configured allow/deny lists. A malicious message producer or broker can send crafted `ObjectMessage` payloads that exploit a null-type handling flaw in the `TrustedClassFilter` binder, causing `BinaryFormatter`'s internal fallback type resolver to bypass all security restrictions — leading to remote code execution via standard .NET deserialization gadget chains.

**CVSS 9.8 Critical** — No authentication, no user interaction, network-exploitable.

## Root Cause

The vulnerability is a **fail-open deserialization filter bypass** caused by two bugs that work together in the NMS OpenWire Client's `BinaryFormatter` `SerializationBinder` implementation:

**Bug 1 — Missing null check in `TrustedClassFilter.BindToType()`** (`src/Commands/TrustedClassFilter.cs`):
`FormatterServices.GetTypeFromAssembly()` returns `null` when the requested type doesn't exist in the specified assembly. The binder passes this null directly to `IsTrustedType()` without checking, and when approved, returns `null` from `BindToType()`. When `BindToType()` returns `null`, `BinaryFormatter` falls back to its internal `ObjectReader.FastBindToType()` resolver, which resolves types from the original stream metadata — **completely bypassing the binder**.

**Bug 2 — Null type treated as trusted in `NmsDefaultDeserializationPolicy.IsTrustedType()`** (`src/NmsDefaultDeserializationPolicy.cs`):
```csharp
var typeName = type?.FullName;  // null?.FullName evaluates to null
if (typeName == null)
{
    return true;  // BUG: Null type treated as trusted!
}
```
When `type` is `null`, the null-conditional operator produces `null`, and the function returns `true` — marking the unknown type as trusted before any allow/deny list evaluation occurs.

**Exploitation technique:** An attacker crafts a `[Serializable]` class implementing `ISerializable` that manipulates `SerializationInfo` in `GetObjectData()`:
1. `info.SetType(TrustedType)` — records a trusted type in the stream
2. `info.FullTypeName = type.AssemblyQualifiedName` — uses the assembly-qualified name (causes parser confusion)
3. `info.AssemblyName = "mscorlib, ..."` — redirects type resolution to the wrong assembly

During deserialization, `GetTypeFromAssembly(mscorlib, "TrustedType, PocApp, ...")` returns `null` (type not in mscorlib), which passes the trust check, and `BinaryFormatter`'s fallback resolves the real type from stream metadata. For full RCE, the attacker substitutes a .NET gadget chain type (e.g., `TypeConfuseDelegate`, `ObjectDataProvider`) for `TrustedType`.

## Lab Setup

### Prerequisites

- Docker Engine with Compose plugin
- ~2 GB disk space (ActiveMQ image + .NET SDK image)

### Build and Start

```bash
docker compose build
docker compose up -d
```

### Containers

| Container | Role | Image |
|-----------|------|-------|
| `cve-2025-29953-broker` | Apache ActiveMQ Classic 5.18.6 message broker | `apache/activemq-classic:5.18.6` |
| `cve-2025-29953-vulnerable` | .NET 6.0 client with vulnerable NMS OpenWire v2.1.0 + PoC app | Built from `Dockerfile.vulnerable` |

### Architecture

```
┌──────────────────────────────┐     ┌────────────────────────────────────┐
│  cve-2025-29953-broker       │     │  cve-2025-29953-vulnerable         │
│  (ActiveMQ Classic 5.18.6)   │◄────│  (.NET 6.0 SDK + PoC App)          │
│                              │     │                                    │
│  Port 61616 - OpenWire TCP   │     │  PoC App: /app/PocApp.dll          │
│  Port 8161  - Web Console    │     │  Vulnerable lib: NMS v2.1.0        │
│  Credentials: admin/admin    │     │  Test modes: local | broker        │
└──────────────────────────────┘     └────────────────────────────────────┘
                 ▲         lab-net (bridge)         ▲
                 └─────────────────────────────────┘
```

### Stop / Teardown

```bash
docker compose down
```

## PoC Usage

Three PoC scripts demonstrate the vulnerability through different attack vectors. All scripts are in the `poc/` directory.

### Vector 1: Local Filter Bypass (Direct Deserialization)

Tests the core vulnerability: `IsTrustedType(null)` returns `true`, allowing `BindToType()` to return `null` and trigger `BinaryFormatter`'s fallback resolver.

```bash
python3 poc/poc.py
```

**Expected output (vulnerable):**
```
--- Step 2: Test null type bypass (core vulnerability) ---
    IsTrustedType(null) = True
    [VULNERABLE] Null type returns TRUE — filter bypass CONFIRMED!

--- Step 3: Full BinaryFormatter serialization/deserialization ---
    BindToType(assemblyName="mscorlib, Version=4.0.0.0, ...",
               typeName="CVE_2025_29953_PoC.TrustedType, PocApp, ...")
      Resolved type: null
      IsTrustedType => TRUE (null type bypass!)
[VULNERABLE] Deserialization SUCCEEDED!

[RESULT] CVE-2025-29953 CONFIRMED: Deserialization filter bypass successful!
```

### Vector 2: Broker-Based End-to-End Attack

Demonstrates the real-world attack scenario: a malicious producer sends a crafted `ObjectMessage` through an ActiveMQ broker, and the victim consumer's allow list is bypassed on deserialization.

```bash
python3 poc/poc_vector2.py
```

**Expected output (vulnerable):**
```
--- Phase 1: Sending malicious ObjectMessage ---
[+] Sent ObjectMessage with CVE_2025_29953_PoC.MaliciousSerializable
    This type is NOT on the allow list: [CVE_2025_29953_PoC.TrustedType]

--- Phase 2: Receiving and deserializing ---
[*] Received ObjectMessage, deserializing...
[VULNERABLE] Deserialized type: CVE_2025_29953_PoC.TrustedType
[RESULT] CVE-2025-29953 CONFIRMED via broker.
```

### Vector 3: Deny List Bypass

Proves that even the most restrictive configuration (`denyList=*`, deny ALL types) is defeated by the null type bypass — the null check returns `true` before the deny list is ever evaluated.

```bash
python3 poc/poc_vector3.py
```

**Expected output (vulnerable):**
```
--- Step 2: Test null type bypass against deny list ---
    IsTrustedType(null) = True
    [VULNERABLE] Null type BYPASSES the deny list!

--- Step 3: Full BinaryFormatter deserialization with deny-all ---
[VULNERABLE] Deserialization SUCCEEDED despite denyList='*'!

[RESULT] CVE-2025-29953 CONFIRMED: Deny list bypass successful!
```

## Verification: Vulnerable vs. Patched Behavior

| Test | Vulnerable (v2.1.0) | Patched (v2.1.1) |
|------|---------------------|-------------------|
| `IsTrustedType(null)` | Returns `true` ✗ | Throws `NullReferenceException` (null type rejected) ✓ |
| `BindToType()` with mismatched assembly/type | Returns `null` → BinaryFormatter fallback | Throws `SerializationException("Type not found in assembly")` ✓ |
| `MaliciousSerializable` via allow list | Deserialization succeeds (bypass) ✗ | `SerializationException` thrown (blocked) ✓ |
| `MaliciousSerializable` via deny list `*` | Deserialization succeeds (bypass) ✗ | `SerializationException` thrown (blocked) ✓ |
| End-to-end via ActiveMQ broker | Object deserialized past filter ✗ | `SerializationException` on consumer ✓ |

## Fix

**Fix commit:** [`8944c4126dfafee61ffcb4c99d21920cf4b5740b`](https://github.com/apache/activemq-nms-openwire/commit/8944c4126dfafee61ffcb4c99d21920cf4b5740b) (AMQNET-844)

The fix implements a two-layer defense:

### Layer 1 — Null type guard in `TrustedClassFilter.cs`

```csharp
var type = FormatterServices.GetTypeFromAssembly(assembly, typeName);
if (type == null)  // NEW: null check added
{
    throw new SerializationException($"Type {typeName} not found in assembly {assemblyName}");
}
```

This prevents `BindToType()` from ever returning `null`, which eliminates the `BinaryFormatter` fallback path entirely.

### Layer 2 — Defense-in-depth in `NmsDefaultDeserializationPolicy.cs`

```csharp
var typeName = type.FullName;   // Changed from type?.FullName (removed null-conditional)
if (typeName == null)
{
    return false;               // Changed from return true (deny instead of allow)
}
```

Even if a non-null type with a null `FullName` somehow reached this point, it would be denied.

### Fix Assessment

The fix is **complete**. Both layers must be defeated simultaneously, and no known technique can bypass both. When `BindToType()` returns a non-null Type, `BinaryFormatter` uses exactly that type for deserialization — there is no divergence between the validated type and the deserialized type. The fallback path is only triggered when `BindToType()` returns `null`, which the fix prevents.

**Recommended remediation:** Upgrade to `Apache.NMS.ActiveMQ` ≥ 2.1.1. There is no workaround using allow/deny list configuration on vulnerable versions — the null type bypass occurs before any list evaluation.

## References

| Source | URL |
|--------|-----|
| **Apache Advisory** | https://lists.apache.org/thread/vc1sj9y3056d3kkhcvrs9fyw5w8kpmlx |
| **NVD** | https://nvd.nist.gov/vuln/detail/CVE-2025-29953 |
| **GitHub Advisory (GHSA)** | https://github.com/advisories/GHSA-9g64-r942-fvmp |
| **OSS-Security** | http://www.openwall.com/lists/oss-security/2025/04/18/3 |
| **JIRA Tracker** | https://issues.apache.org/jira/browse/AMQNET-844 |
| **Fix Commit** | https://github.com/apache/activemq-nms-openwire/commit/8944c4126dfafee61ffcb4c99d21920cf4b5740b |
| **Source Repository** | https://github.com/apache/activemq-nms-openwire |
| **NuGet Package** | https://www.nuget.org/packages/Apache.NMS.ActiveMQ |
| **Bypass Technique (Code White)** | https://codewhitesec.blogspot.com/2022/06/bypassing-dotnet-serialization-binders.html |

## Timeline

| Date | Event |
|------|-------|
| **2025-04-18** | CVE-2025-29953 published; Apache advisory released |
| **2025-04-18** | Fix commit `8944c41` merged (AMQNET-844) |
| **2025-04-18** | Version 2.1.1 released with fix |
| **Finder** | g7shot (working with Trend Micro Zero Day Initiative) |

## Disclaimer

These proof-of-concept materials are provided for **authorized security testing and educational purposes only**. They exist to help defenders understand, detect, and remediate vulnerabilities in their environments.

**Do not** use these tools against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions.

The authors assume no liability for misuse. This project follows responsible disclosure practices.
