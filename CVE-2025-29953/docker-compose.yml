# CVE-2025-29953 Lab Environment
# Apache NMS OpenWire Client Deserialization Filter Bypass
#
# Architecture:
#   - broker: Apache ActiveMQ Classic 5.18.6 (message broker)
#   - vulnerable: .NET 6.0 app with vulnerable NMS client (v2.1.0)
#   - patched: .NET 6.0 app with patched NMS client (v2.1.1)
#
# Usage:
#   docker compose up -d
#   docker compose logs -f vulnerable
#   docker compose down

services:
  broker:
    image: apache/activemq-classic:5.18.6
    container_name: cve-2025-29953-broker
    ports:
      - "8161:8161"
      - "61616:61616"
    environment:
      ACTIVEMQ_CONNECTION_USER: admin
      ACTIVEMQ_CONNECTION_PASSWORD: admin
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8161/ -o /dev/null -w '%{http_code}' | grep -qE '200|302|401'"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 15s
    networks:
      - lab-net

  vulnerable:
    build:
      context: .
      dockerfile: Dockerfile.vulnerable
    container_name: cve-2025-29953-vulnerable
    environment:
      BROKER_HOST: cve-2025-29953-broker
      BROKER_PORT: "61616"
    depends_on:
      broker:
        condition: service_healthy
    networks:
      - lab-net

  patched:
    build:
      context: .
      dockerfile: Dockerfile.patched
    container_name: cve-2025-29953-patched
    environment:
      BROKER_HOST: cve-2025-29953-broker
      BROKER_PORT: "61616"
    depends_on:
      broker:
        condition: service_healthy
    networks:
      - lab-net

networks:
  lab-net:
    driver: bridge
