# Vulnerability Analysis: CVE-2026-28372

## Root Cause

**Classification:** CWE-829 — Inclusion of Functionality from Untrusted Control Sphere (Environment Variable Injection via insufficient blacklist filtering)

GNU inetutils telnetd accepts **arbitrary environment variables** from telnet clients via the Telnet NEW_ENVIRON option (RFC 1572, option code 39). The `suboption()` handler in `state.c` calls `setenv(varp, valp, 1)` for each variable-value pair received from the client with **no validation or filtering** of variable names.

Before executing `login(1)`, the `start_login()` function in `pty.c` calls `scrub_env()`, which uses a **blacklist approach** that only removes four categories of variables:
- `LD_*` (dynamic linker preload)
- `_RLD_*` (IRIX dynamic linker)
- `LIBPATH=` (AIX library path)
- `IFS=` (shell field separator)

This blacklist was designed in 1995 (telnet-95.10.23.NE by David Borman) and has not been updated since. It does **not** filter `CREDENTIALS_DIRECTORY`.

When **util-linux login(1) >= 2.40** is used as the login program, it checks the `CREDENTIALS_DIRECTORY` environment variable for systemd service credentials support. If the specified directory contains a file named `login.noauth` with the content `yes`, login(1) **completely bypasses authentication** — no password prompt, no PAM checks.

The combination of these two components — telnetd's insufficient env var filtering and login(1)'s credentials support — creates a **local privilege escalation** vulnerability.

## Vulnerable Files and Functions

### Primary — Environment Variable Injection Point
- **File:** `telnetd/state.c`, lines 1324–1522
- **Function:** `suboption()` → `case TELOPT_NEW_ENVIRON:` handler
- **Critical lines:** 1498-1499 (`setenv(varp, valp, 1)`) and 1517-1518 (`setenv(varp, valp, 1)`)
- **Behavior:** Accepts ANY environment variable name and value from the telnet client and calls `setenv()` to place them in the process environment. No whitelist or blacklist is applied at this stage.

### Secondary — Insufficient Blacklist Filter
- **File:** `telnetd/pty.c`, lines 94–107
- **Function:** `scrub_env()`
- **Behavior:** Iterates over `environ` and removes entries starting with `LD_`, `_RLD_`, `LIBPATH=`, or `IFS=`. **Does not remove** `CREDENTIALS_DIRECTORY` or any other modern dangerous variables.

### Tertiary — Login Invocation with Environment Preservation
- **File:** `telnetd/pty.c`, lines 109–135
- **Function:** `start_login()`
- **Behavior:** Calls `scrub_env()`, expands the login invocation template, then calls `execv()` to launch login.

- **File:** `telnetd/telnetd.c`, line 58
- **Variable:** `login_invocation`
- **Value:** `PATH_LOGIN " -p -h %h %?u{-f %u}{%U}"`
- **Critical detail:** The `-p` flag tells login(1) to **preserve the environment**, which is how `CREDENTIALS_DIRECTORY` reaches login. Without `-p`, login would reset the environment.

### Supporting — Template Expansion (USER variable handling)
- **File:** `telnetd/utility.c`, lines 1732–1736
- **Function:** `_var_short_name()` → `case 'U':` handler
- **Behavior:** `%U` in the login template expands to `getenv("USER")`, which is client-controlled via NEW_ENVIRON.

## Triggering Input

### Telnet Protocol Byte Sequence

The attack requires sending specific Telnet protocol bytes during the NEW_ENVIRON subnegotiation phase:

**1. Option Negotiation (client → server):**
```
IAC(0xFF) WILL(0xFB) NEW_ENVIRON(0x27)
```
The client indicates willingness to send environment variables.

**2. Subnegotiation Response (client → server):**
```
IAC(0xFF) SB(0xFA) NEW_ENVIRON(0x27) IS(0x00)
  ENV_USERVAR(0x03) "CREDENTIALS_DIRECTORY" NEW_ENV_VALUE(0x01) "/path/to/fake_cred"
  ENV_USERVAR(0x03) "USER" NEW_ENV_VALUE(0x01) "root"
IAC(0xFF) SE(0xF0)
```

### Byte-level breakdown:
```
FF FA 27 00                           # IAC SB NEW_ENVIRON IS
03                                    # ENV_USERVAR
43 52 45 44 45 4E 54 49 41 4C 53 5F  # "CREDENTIALS_"
44 49 52 45 43 54 4F 52 59            # "DIRECTORY"
01                                    # NEW_ENV_VALUE
2F 68 6F 6D 65 2F 75 73 65 72 2F     # "/home/user/"
66 61 6B 65 5F 63 72 65 64            # "fake_cred"
03                                    # ENV_USERVAR
55 53 45 52                           # "USER"
01                                    # NEW_ENV_VALUE
72 6F 6F 74                           # "root"
FF F0                                 # IAC SE
```

### Constants Reference (from `/usr/include/arpa/telnet.h`):
| Constant | Value | Description |
|---|---|---|
| `IAC` | 255 (0xFF) | Interpret As Command |
| `SB` | 250 (0xFA) | Subnegotiation Begin |
| `SE` | 240 (0xF0) | Subnegotiation End |
| `DO` | 253 (0xFD) | Request option |
| `WILL` | 251 (0xFB) | Agree to option |
| `TELOPT_NEW_ENVIRON` | 39 (0x27) | New Environment Option |
| `TELQUAL_IS` | 0 (0x00) | Option value IS |
| `TELQUAL_SEND` | 1 (0x01) | Send option values |
| `NEW_ENV_VAR` | 0 (0x00) | Standard variable |
| `NEW_ENV_VALUE` | 1 (0x01) | Variable value follows |
| `ENV_USERVAR` | 3 (0x03) | User-defined variable |

### Pre-requisite: Credential Directory Setup
Before connecting, the attacker must create:
```bash
mkdir -p /home/user/fake_cred
echo "yes" > /home/user/fake_cred/login.noauth
```

## Attack Scenario

### Step-by-Step Exploitation

1. **Attacker has local unprivileged access** to a system running GNU inetutils telnetd with util-linux >= 2.40.

2. **Attacker creates the fake credential directory:**
   ```bash
   mkdir -p /tmp/fake_cred
   echo "yes" > /tmp/fake_cred/login.noauth
   ```

3. **Attacker connects to local telnetd** on port 23 (or wherever it's listening).

4. **During Telnet option negotiation**, the server sends `DO NEW_ENVIRON` (per `getterminaltype()` in `utility.c:756`).

5. **Attacker responds `WILL NEW_ENVIRON`**, agreeing to send environment variables.

6. **Server sends `SB NEW_ENVIRON SEND`**, requesting the client's environment variables.

7. **Attacker sends `SB NEW_ENVIRON IS`** containing:
   - `CREDENTIALS_DIRECTORY=/tmp/fake_cred` — points login(1) to the fake credential directory
   - `USER=root` — requests root login (used in the `%U` template expansion, which becomes the login username when autologin is not available)

8. **telnetd processes the NEW_ENVIRON subnegotiation** in `state.c:1324-1522`, calling `setenv("CREDENTIALS_DIRECTORY", "/tmp/fake_cred", 1)` and `setenv("USER", "root", 1)`.

9. **telnetd calls `startslave()`** → `forkpty()` → child calls `start_login()`.

10. **`start_login()` calls `scrub_env()`**, which removes `LD_*`, `_RLD_*`, `LIBPATH`, and `IFS` — but **leaves `CREDENTIALS_DIRECTORY` intact**.

11. **`start_login()` expands login_invocation template** to: `login -p -h <hostname> <username>` (with `-p` preserving the environment).

12. **`execv()` launches login** with `CREDENTIALS_DIRECTORY=/tmp/fake_cred` in the environment.

13. **login(1) (util-linux >= 2.40) checks `$CREDENTIALS_DIRECTORY/login.noauth`**, finds `yes`, and **skips all authentication**.

14. **Attacker receives a root shell** without entering any password.

### Attack Complexity
- **Vector:** Local (AV:L) — attacker must access the system to create the credential directory
- **Complexity:** High (AC:H) — requires specific util-linux version >= 2.40 and telnetd running
- **Privileges Required:** None (PR:N) — any local user can create the credential directory and connect to telnetd
- **User Interaction:** None (UI:N) — no victim action required

## Impact

- **Confidentiality:** HIGH — attacker gains full root access, can read any file
- **Integrity:** HIGH — attacker can modify any system file
- **Availability:** HIGH — attacker can shut down services, modify configs
- **Overall:** **Local privilege escalation from any unprivileged user to root**

The attacker obtains a fully authenticated root shell via telnetd without knowing any password. From the perspective of the system, this looks like a legitimate root login.

## Fix Assessment

### Fix Description
The fix adds a single `unsetenv("CREDENTIALS_DIRECTORY")` call in `start_login()` in `pty.c`, immediately before the `execv()` that launches login(1).

### Effectiveness for CVE-2026-28372: COMPLETE ✓
The fix correctly removes `CREDENTIALS_DIRECTORY` from the environment before login(1) is executed, fully closing the specific attack vector described in this CVE. The `unsetenv()` call is placed after `scrub_env()` and after the `LINEMODE` setenv calls, and before `execv()`, ensuring the variable cannot reach login.

### Broader Fix Quality: INCOMPLETE / NARROW

**The fix is explicitly described by its author as "a simple fix that can be backported easily"** — it is a targeted mitigation, not a comprehensive solution.

1. **Blacklist approach remains fundamentally flawed:** The `scrub_env()` function plus the new `unsetenv()` still use a blacklist strategy. Any new dangerous environment variable (from future login features, PAM modules, shell startup, or other child programs) would require another patch.

2. **Other potentially injectable dangerous variables not filtered:**
   - `BASH_ENV` — executed by bash when started as non-interactive shell
   - `ENV` — executed by POSIX sh on startup
   - `PYTHONPATH`, `PERL5LIB`, `RUBYLIB` — affect interpreters that may run in login scripts
   - `HOME` — could redirect home directory lookups
   - `XDG_CONFIG_HOME`, `XDG_DATA_HOME` — could redirect config file lookups
   - Future systemd-related variables (systemd frequently adds new env var interfaces)

3. **The `-p` flag is the root enabler:** Login is invoked with `-p` (preserve environment) on non-Solaris platforms. This is what allows client-controlled env vars to reach login. A more robust fix would either:
   - Switch to a whitelist of allowed environment variables
   - Remove `-p` and explicitly pass only needed variables
   - Use `execve()` with a clean environment instead of `execv()` with inherited env

4. **Related Debian patches address a sibling vulnerability:** The Debian patch series includes fixes for CVE-2026-24061 (injection via bogus user names in the `%U` template expansion). These patches (`upstream/0001-Fix-injection-bug-with-bogus-user-names.patch` and `upstream/0002-telnetd-Sanitize-all-variable-expansions.patch`) add sanitization of the USER variable and other template expansions to reject values starting with `-` or containing shell metacharacters.

### Potential Bypass Vectors

For this specific CVE (CREDENTIALS_DIRECTORY), there are **no known bypass vectors** — the `unsetenv()` call is definitive.

However, the general env-var-injection attack surface through NEW_ENVIRON remains open for:
- Any future dangerous environment variable added by util-linux, systemd, PAM, or other login-adjacent software
- Environment variables that affect programs invoked from `.bashrc`, `.profile`, or PAM session scripts

## Build System

| Field | Value |
|---|---|
| **Build System** | GNU Autotools (autoconf 2.64+, automake 1.11.1+) |
| **Language** | C (C99) |
| **Bootstrap Required** | Yes — `./bootstrap` pulls gnulib submodule |

## Build Commands

### Full Build (all components)
```bash
cd /path/to/inetutils/source
./bootstrap
./configure
make
```

### Minimal Build (telnetd only)
```bash
cd /path/to/inetutils/source
./bootstrap
./configure
make -C lib          # Build gnulib portability library
make -C libtelnet    # Build telnet protocol library
make -C libinetutils # Build inetutils library
make -C telnetd      # Build telnetd
```

The telnetd binary will be at `telnetd/telnetd`.

### Build Configuration Notes
- Default configure flags are sufficient — telnetd is enabled by default
- No Kerberos or PAM is needed for the vulnerable code path
- The `PATH_LOGIN` macro is set during configure to the system's login binary path (typically `/usr/bin/login` or `/bin/login`)
- Can override with `--with-path-login=/path/to/login` if needed

## Dependencies

### Build Dependencies (Debian/Ubuntu package names)
| Package | Purpose |
|---|---|
| `build-essential` | gcc, make, libc-dev |
| `autoconf` | Autoconf (>= 2.64) |
| `automake` | Automake (>= 1.11.1) |
| `texinfo` | For documentation (may be needed by bootstrap) |
| `bison` | Parser generator (for some gnulib modules) |
| `libncurses-dev` | Terminal capability library |
| `git` | For gnulib submodule checkout during bootstrap |

### Runtime Dependencies for Lab
| Component | Package/Version | Purpose |
|---|---|---|
| **util-linux >= 2.40** | `util-linux` (Debian Trixie/sid, Ubuntu 24.10+) | login(1) with systemd credentials support |
| **telnetd** | Built from source (v2.7) | Vulnerable telnet daemon |
| **telnet client** | Python script (custom) or `telnet` package | To send crafted NEW_ENVIRON |

### Critical Version Requirement
The login(1) binary from **util-linux >= 2.40** is essential. This version added the `CREDENTIALS_DIRECTORY` / `login.noauth` systemd service credentials support. Earlier versions of login do not check this env var, so the vulnerability cannot be triggered.

To verify: `login --version` should show `login from util-linux 2.40` or higher.

## Runtime Requirements

### Lab Environment Setup

1. **Base Image:** Debian Trixie (testing) or Ubuntu 24.10+ — these ship with util-linux >= 2.40
   - Alternative: Debian Bookworm with manually built util-linux >= 2.40

2. **Network Setup:**
   - telnetd listening on a port (default 23, but can use any port for testing)
   - Loopback access sufficient (attack is local)

3. **telnetd Launch Modes:**
   - **Debug mode (simplest for lab):** `telnetd -debug <port>` — runs in foreground, single connection
   - **Via inetd/xinetd:** More production-like but more complex to configure
   - **Standalone:** Can be wrapped with socat or similar

4. **User Accounts:**
   - Root account (target of privilege escalation)
   - Unprivileged user account (e.g., `weakuser`) to simulate the attacker

5. **Credential Directory:**
   - A directory writable by the unprivileged user (e.g., `/home/weakuser/fake_cred/`)
   - Contains `login.noauth` file with content `yes`

### PoC Strategy

A Python script using raw sockets (since `telnetlib` is deprecated in Python 3.11+) should:
1. Connect to telnetd on the target port
2. Perform Telnet option negotiation:
   - Respond WILL to the server's DO NEW_ENVIRON
   - Negotiate terminal type and other standard options
3. When server sends SB NEW_ENVIRON SEND, respond with SB NEW_ENVIRON IS containing:
   - `CREDENTIALS_DIRECTORY=/path/to/fake_cred`
   - `USER=root`
4. Wait for login prompt to be skipped
5. Verify root shell access by sending `id` and checking for `uid=0(root)`

The PoC must handle the full Telnet negotiation handshake correctly, including terminal type (TTYPE) negotiation, as telnetd waits for multiple option negotiations to complete before proceeding to the login phase.
