# Lab Build Report: CVE-2026-28372

## Lab Architecture

### Overview

Single-container lab environment reproducing CVE-2026-28372 (GNU inetutils telnetd ≤2.7 privilege escalation via `CREDENTIALS_DIRECTORY` environment variable injection).

The vulnerability allows a local unprivileged user to obtain a root shell by injecting the `CREDENTIALS_DIRECTORY` environment variable via the Telnet NEW_ENVIRON option, causing `login(1)` (util-linux ≥2.40) to bypass authentication.

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────┐
│  cve-2026-28372-vulnerable (debian:trixie)              │
│                                                         │
│  ┌──────────────┐    ┌───────────┐    ┌──────────────┐  │
│  │ mini-inetd   │───>│  telnetd  │───>│  login(1)    │  │
│  │ (Python3)    │    │  v2.7     │    │  util-linux  │  │
│  │ port 2323    │    │  (vuln)   │    │  v2.41       │  │
│  └──────────────┘    └───────────┘    └──────────────┘  │
│                                                         │
│  Users: root (Sup3rS3cretR00t!), weakuser (weakuser)   │
│  Credential dir: /home/weakuser/fake_cred/login.noauth  │
└─────────────────────────────────────────────────────────┘
```

## Container Details

### cve-2026-28372-vulnerable

| Field | Value |
|---|---|
| **Container Name** | `cve-2026-28372-vulnerable` |
| **Image** | `lab-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Base Image** | `debian:trixie` (multi-stage: builder + runtime) |
| **Hostname** | `telnetd-lab` |
| **Port** | `2323/tcp` (Telnet service) |
| **Network** | `lab-net` (bridge) |

### Software Versions

| Component | Version | Purpose |
|---|---|---|
| **GNU inetutils telnetd** | 2.7 (built from source at tag `v2.7`) | Vulnerable telnet daemon |
| **util-linux login** | 2.41 (from Debian Trixie) | Login binary with `CREDENTIALS_DIRECTORY` support |
| **Python 3** | 3.13 (from Debian Trixie) | mini-inetd wrapper |
| **Debian Trixie** | testing | Base OS |

### User Accounts

| User | Password | Purpose |
|---|---|---|
| `root` | `Sup3rS3cretR00t!` | Target for privilege escalation |
| `weakuser` | `weakuser` | Simulated unprivileged attacker |

### Attack Prerequisite Files

| Path | Content | Purpose |
|---|---|---|
| `/home/weakuser/fake_cred/login.noauth` | `yes` | Triggers login(1) authentication bypass |

## Build Status

### Build: ✅ SUCCESS

- **Builder stage**: Debian Trixie with build-essential, autoconf, automake, bison, texinfo, m4, help2man, git, libncurses-dev
- **Bootstrap**: `./bootstrap` successfully fetched gnulib and generated configure scripts
- **Build**: `./configure && make -C lib && make -C libtelnet && make -C libinetutils && make -C telnetd` completed successfully
- **Runtime stage**: Debian Trixie with libncurses6, libtinfo6, login, python3, procps, net-tools
- **Verification**: `login --version` confirmed util-linux 2.41 (≥2.40 required)

### Container Health: ✅ HEALTHY

Healthcheck via TCP connect to port 2323 — passing consistently.

### Workarounds Applied

1. **inetd-style daemon handling**: GNU inetutils telnetd is designed for inetd (expects socket on fd 0). Created `mini-inetd.py` — a Python script that listens on port 2323, accepts connections, and passes the network socket as fd 0/1/2 via `fork()`+`dup2()`+`execv()`. This correctly preserves the socket semantics that `getpeername(0)` requires.

2. **Multi-stage Docker build**: Used a multi-stage build to keep the runtime image small — build tools are only in the builder stage.

3. **SYS_ADMIN capability**: Added `cap_add: SYS_ADMIN` for login/utmp operations.

## Start/Stop Commands

### Start Lab
```bash
docker compose up -d
```

### Stop Lab
```bash
docker compose down
```

### Rebuild (after changes)
```bash
docker compose build --no-cache
docker compose up -d --force-recreate
```

### Check Status
```bash
docker compose ps
docker compose logs vulnerable
```

### Connect to Container Shell
```bash
docker exec -it cve-2026-28372-vulnerable bash
```

## Verification Evidence

### Exploit Test: ✅ ROOT SHELL OBTAINED WITHOUT PASSWORD

```
[+] Connected to 172.22.0.6:2323
[*] INJECTED: CREDENTIALS_DIRECTORY=/home/weakuser/fake_cred USER=root
[+] Server response: root@telnetd-lab:~#
[+] id output: uid=0(root) gid=0(root) groups=0(root)
[+] whoami output: root

[✓] VULNERABILITY CONFIRMED — Root access without password!
```

### Control Test: ✅ AUTHENTICATION REQUIRED WITHOUT EXPLOIT

```
[✓] CONTROL TEST PASSED — Got 'login:' prompt (authentication required)
Full text: 'Linux 6.12.68-linuxkit (telnetd-lab) (pts/0)\r\n\r\ntelnetd-lab login: '
```

### Automated Verification Script

```bash
# From the CVEForge worker container:
CONTAINER_IP=$(docker inspect cve-2026-28372-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
python3 ./verify_lab.py "$CONTAINER_IP" 2323
```

## Lab Files

| File | Purpose |
|---|---|
| `Dockerfile.vulnerable` | Multi-stage Dockerfile — builds telnetd v2.7 from source on Debian Trixie |
| `docker-compose.yml` | Docker Compose orchestration with healthcheck |
| `mini-inetd.py` | Minimal inetd replacement — listens on TCP, passes sockets to telnetd |
| `verify_lab.py` | Automated exploit verification script |

## Network Access (from CVEForge worker)

Since the CVEForge worker runs as a sibling container, use the container IP directly:

```bash
CONTAINER_IP=$(docker inspect cve-2026-28372-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
# Then use $CONTAINER_IP:2323 for connections
```

**Do NOT use `localhost:2323`** — port mappings expose to the host, not to sibling containers.

## Known Issues

1. **Single-connection limitation**: `mini-inetd.py` handles connections sequentially via `fork()`. Each forked telnetd handles one connection. This is adequate for lab/PoC purposes.

2. **No syslog daemon**: telnetd logs go to syslog but no syslog daemon is running in the container. For debugging, use `docker compose logs` or run `rsyslogd` manually.

3. **Container requires root**: telnetd must run as root to invoke `login(1)`, which requires root for PAM/utmp operations. The `mini-inetd.py` runs as root (PID 1).
