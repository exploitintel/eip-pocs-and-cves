# CVE-2026-28372 Lab - Vulnerable GNU inetutils telnetd v2.7
# Builds telnetd from source on Debian Trixie with util-linux login >= 2.40

FROM debian:trixie AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    autoconf \
    automake \
    bison \
    texinfo \
    m4 \
    help2man \
    git \
    libncurses-dev \
    gzip \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Clone inetutils v2.7 source
RUN git clone --branch v2.7 --depth 1 https://codeberg.org/inetutils/inetutils.git /build/inetutils
WORKDIR /build/inetutils

# Bootstrap (fetches gnulib) and build telnetd
RUN ./bootstrap \
    && ./configure --prefix=/usr/local \
    && make -j$(nproc) -C lib \
    && make -j$(nproc) -C libtelnet \
    && make -j$(nproc) -C libinetutils \
    && make -j$(nproc) -C telnetd

# ---- Runtime stage ----
FROM debian:trixie

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libncurses6 \
    libtinfo6 \
    login \
    python3 \
    procps \
    net-tools \
    iproute2 \
    && rm -rf /var/lib/apt/lists/*

# Copy built telnetd binary
COPY --from=builder /build/inetutils/telnetd/telnetd /usr/local/sbin/telnetd
RUN chmod 755 /usr/local/sbin/telnetd

# Verify util-linux login version >= 2.40
RUN login_version=$(login --version 2>&1 | head -1) && \
    echo "Login version: ${login_version}" && \
    echo "${login_version}" | grep -qE '(2\.(4[0-9]|[5-9][0-9])|[3-9]\.)' || \
    (echo "ERROR: util-linux login < 2.40 â€” cannot reproduce CVE-2026-28372" && exit 1)

# Create unprivileged attacker user
RUN useradd -m -s /bin/bash weakuser && \
    echo "weakuser:weakuser" | chpasswd

# Set up the fake credential directory for the PoC
RUN mkdir -p /home/weakuser/fake_cred && \
    echo "yes" > /home/weakuser/fake_cred/login.noauth && \
    chown -R weakuser:weakuser /home/weakuser/fake_cred

# Set root password (for verification that auth bypass works)
RUN echo "root:Sup3rS3cretR00t!" | chpasswd

# Copy the mini-inetd wrapper
COPY mini-inetd.py /usr/local/bin/mini-inetd.py
RUN chmod 755 /usr/local/bin/mini-inetd.py

# Expose telnet port
EXPOSE 2323

# Run telnetd via the mini-inetd wrapper (as root, required for login)
CMD ["python3", "/usr/local/bin/mini-inetd.py", "2323"]
