# docker-compose.yml â€” CVE-2025-27531 Lab Environment
#
# Apache InLong Manager JDBC URL Sanitization Bypass
#
# Usage:
#   docker compose build
#   docker compose up -d
#   docker compose down -v

services:
  mysql:
    build:
      context: .
      dockerfile: Dockerfile.mysql
      platforms:
        - linux/amd64
    container_name: cve-2025-27531-mysql
    platform: "linux/amd64"
    environment:
      MYSQL_ROOT_PASSWORD: inlong
    healthcheck:
      test: ["CMD", "mysql", "-uroot", "-pinlong", "-e", "SELECT 1 FROM apache_inlong_manager.inlong_group LIMIT 1"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 120s
    command: --authentication_policy=mysql_native_password --default-authentication-plugin=mysql_native_password
    networks:
      - lab-net

  manager:
    build:
      context: .
      dockerfile: Dockerfile.vulnerable
    container_name: cve-2025-27531-manager
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "8083:8083"
    environment:
      - JDBC_URL=cve-2025-27531-mysql:3306
      - USERNAME=root
      - PASSWORD=inlong
      - ZK_URL=localhost:2181
      - FLINK_HOST=localhost
      - FLINK_PORT=8081
      - AUDIT_QUERY_URL=http://localhost:10080
    networks:
      - lab-net

networks:
  lab-net:
    driver: bridge
