# Lab Build Report: CVE-2025-49828

## Lab Architecture

**Multi-container architecture** with two services:

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-49828-pg` | `postgres:15` | PostgreSQL 15 database | 5432 (internal) |
| `cve-2025-49828-vulnerable` | `cve-2025-49828-vulnerable` (custom) | CyberArk Conjur v1.21.1 (vulnerable) | 3000 |

**Network Configuration:**
- `cve-2025-49828_lab-net` — Internal communication between Conjur and PostgreSQL
- Host-mapped port 3000 for external PoC/test access

## Container Details

### PostgreSQL (`cve-2025-49828-pg`)
- **Image**: `postgres:15`
- **Auth**: Trust authentication (`POSTGRES_HOST_AUTH_METHOD: trust`)
- **Healthcheck**: `pg_isready -U postgres` every 3s, 15 retries
- **Network**: `lab-net` only (not exposed externally)

### Conjur Vulnerable (`cve-2025-49828-vulnerable`)
- **Base Image**: `ruby:3.2-slim` (builder + runtime)
- **Conjur Version**: v1.21.1 (commit `a579909060c028c84ab60dc0a984e8e386c65c30`)
- **Ruby**: 3.2.10
- **Rails**: 6.1.7.8
- **Puma**: 6.4.2 (cluster mode, 2 workers)
- **Network**: `lab-net`
- **Entrypoint**: Custom `/entrypoint.sh` that:
  1. Waits for PostgreSQL readiness
  2. Runs database migrations (`conjurctl db migrate`)
  3. Creates the `cucumber` account and saves API key to `/tmp/admin_api_key`
  4. Starts Conjur server on port 3000

## Environment Variables

| Variable | Value | Purpose |
|----------|-------|---------|
| `DATABASE_URL` | `postgres://postgres@cve-2025-49828-pg/postgres` | PostgreSQL connection |
| `CONJUR_DATA_KEY` | `aL2Mf4bfNwRywxcUZBB7gexGOWaAsDLoGZsMx9LuENc=` | AES-256 data encryption key |
| `CONJUR_ACCOUNT` | `cucumber` | Conjur organization account |
| `CONJUR_ADMIN_PASSWORD` | `ADmin123!!!!` | Initial admin password |
| `RAILS_ENV` | `development` | Rails environment |
| `CONJUR_LOG_LEVEL` | `debug` | Logging verbosity |
| `OPENSSL_FIPS_ENABLED` | `false` | Disable FIPS (non-FIPS OpenSSL) |

## Credentials

| Credential | Location | How to Retrieve |
|-----------|----------|-----------------|
| Admin API Key | `/tmp/admin_api_key` inside container | `docker exec cve-2025-49828-vulnerable cat /tmp/admin_api_key` |
| Admin Username | N/A | `admin` |
| Account Name | N/A | `cucumber` |

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| PostgreSQL | ✅ Success | Standard `postgres:15` image, no build needed |
| Conjur Vulnerable | ✅ Success | Custom build from source at v1.21.1 |

### Build Workarounds Applied

1. **Ruby 3.2 instead of 3.0**: The Gemfile specifies Ruby 3.0, but the codebase uses Ruby 3.1+ shorthand hash syntax (`key:,`). Ruby 3.2-slim is the minimum version that supports this syntax while remaining compatible with the gem dependencies.

2. **Excluded dev/test gem groups**: The `debase` gem (development dependency) doesn't compile with Ruby 3.2. Since it's only needed for debugging, the build excludes `test` and `development` groups via `bundle config set --local without 'test development'`.

3. **Patched FIPS initializer**: The original `config/initializers/fips.rb` uses FFI to load `libssl.so` for FIPS detection. Standard Ruby images don't include the FIPS-capable OpenSSL library. The initializer is replaced with a minimal version that only sets up the Digest overrides without FIPS logic.

4. **COPY order for Gemfile.lock**: The source `Gemfile.lock` pins `nokogiri` to `1.15.4` for `aarch64-linux`, but Ruby 3.2 resolves to `1.19.1` for `aarch64-linux-gnu`. The Dockerfile copies source code first, then overlays the builder's `Gemfile.lock` (which has correct platform/version entries).

5. **CyberArk base images bypassed**: The official `cyberark/ubuntu-ruby-builder:latest` and `cyberark/ubuntu-ruby-postgres-fips:latest` images now ship Ruby 3.4, which breaks `ruby-next-core` gem compatibility. Switched to standard `ruby:3.2-slim` images.

## Start/Stop Commands

```bash
# Set the data key
export CONJUR_DATA_KEY="aL2Mf4bfNwRywxcUZBB7gexGOWaAsDLoGZsMx9LuENc="

# Start the lab
docker compose -f docker-compose.yml up -d

# Check status
docker compose -f docker-compose.yml ps

# View logs
docker compose -f docker-compose.yml logs -f vulnerable

# Stop the lab
docker compose -f docker-compose.yml down

# Full reset (removes volumes)
docker compose -f docker-compose.yml down -v
```

## Verification Evidence

### Container Status
```
NAME                        IMAGE                       STATUS                    PORTS
cve-2025-49828-pg           postgres:15                 Up (healthy)              5432/tcp
cve-2025-49828-vulnerable   cve-2025-49828-vulnerable   Up                        3000/tcp
```

### Service Reachability
```
Service URL: http://127.0.0.1:3000
```

### Conjur Status Page
- GET `/` → Returns HTML status page showing "Conjur v1.21.1" and "FIPS mode disabled"

### Authentication Flow
```bash
# Get API key
API_KEY=$(docker exec cve-2025-49828-vulnerable cat /tmp/admin_api_key)

# Authenticate (get token)
TOKEN=$(curl -s -X POST "http://<IP>:3000/authn/cucumber/admin/authenticate" -d "$API_KEY" | base64)

# Verify identity
curl -s "http://<IP>:3000/whoami" -H "Authorization: Token token=\"$TOKEN\""
# → {"account":"cucumber","username":"admin",...}
```

### Factory Endpoint
```bash
# POST /factory-resources responds with expected 404 (no factory loaded yet)
curl -s "http://<IP>:3000/factory-resources/cucumber/core/v1/test" -X POST \
  -H "Authorization: Token token=\"$TOKEN\"" \
  -H "Content-Type: application/json" \
  -d '{"id":"test","branch":"root"}'
# → {"code":404,"error":{"resource":"core/v1/test","message":"Requested Policy Factory does not exist"}}
```

### Policy Loading
```bash
# POST /policies/cucumber/policy/root successfully creates resources
curl -s "http://<IP>:3000/policies/cucumber/policy/root" -X POST \
  -H "Authorization: Token token=\"$TOKEN\"" \
  --data-binary '- !variable test-secret'
# → {"created_roles":{},"version":1} (HTTP 201)
```

### Vulnerable Code Confirmed
```ruby
# /src/conjur-server/app/domain/factories/renderer.rb
module Factories
  class Renderer
    def initialize(render_engine: ERB)     # ← ERB used as default
      @render_engine = render_engine
    end
    def render(template:, variables:)
      @success.new(@render_engine.new(template, trim_mode: '-').result_with_hash(variables))
      # ↑ SSTI: ERB.new(template).result_with_hash(variables) executes arbitrary Ruby
    end
  end
end
```

## Accessing the Lab

1. Get the admin API key:
```bash
API_KEY=$(docker exec cve-2025-49828-vulnerable cat /tmp/admin_api_key | tr -d '\n')
```

2. Authenticate:
```bash
TOKEN=$(curl -s -X POST "http://127.0.0.1:3000/authn/cucumber/admin/authenticate" -d "$API_KEY" | base64)
```

3. Use `Authorization: Token token="$TOKEN"` header for all subsequent requests.

## Known Issues

1. **API key changes on restart**: The admin API key is generated during account creation. If the container is restarted with volumes reset (`down -v`), a new key will be generated. Always read from `/tmp/admin_api_key`.

2. **Startup time**: The container needs ~15-20 seconds after start to complete migrations and start the server. Wait for Puma "Listening on http://0.0.0.0:3000" in logs.

3. **FIPS warnings**: The log shows `CONJ00038I OpenSSL FIPS mode set to false` — this is expected and harmless in the lab.

4. **Config directory warning**: `CONJ00147D Conjur config directory doesn't exist` — benign warning, no `/etc/conjur/config` needed for dev mode.

## Lab Files

| File | Path | Purpose |
|------|------|---------|
| Dockerfile | `Dockerfile.vulnerable` | Builds Conjur v1.21.1 from source |
| docker-compose.yml | `docker-compose.yml` | Orchestrates PostgreSQL + Conjur |
| entrypoint.sh | `entrypoint.sh` | Init script (migrate, create account, start server) |
