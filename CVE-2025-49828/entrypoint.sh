#!/bin/bash
set -e

echo "[*] CVE-2025-49828 Lab - CyberArk Conjur v1.21.1 (Vulnerable)"
echo "[*] Waiting for PostgreSQL to be ready..."

# Wait for PostgreSQL
until pg_isready -h "${DB_HOST:-cve-2025-49828-pg}" -p 5432 -U postgres 2>/dev/null; do
  echo "[*] PostgreSQL not ready, retrying in 2s..."
  sleep 2
done

echo "[+] PostgreSQL is ready!"

# Run database migrations
echo "[*] Running database migrations..."
conjurctl db migrate

# Create the account (outputs the admin API key)
echo "[*] Creating Conjur account '${CONJUR_ACCOUNT:-cucumber}'..."
API_KEY=$(conjurctl account create "${CONJUR_ACCOUNT:-cucumber}" 2>/dev/null | tail -1 || true)

if [ -n "$API_KEY" ]; then
  echo "[+] Account created. Admin API key: $API_KEY"
  # Save the clean API key (strip prefix) to a file for the PoC agent to use
  CLEAN_KEY=$(echo "$API_KEY" | sed 's/^API key for admin: //')
  echo "$CLEAN_KEY" > /tmp/admin_api_key
  # Also write to bind-mounted path for PoC scripts to read from host
  echo "$CLEAN_KEY" > /opt/poc/.api_key 2>/dev/null || true
else
  echo "[!] Account may already exist, retrieving API key..."
  API_KEY=$(conjurctl role retrieve-key "${CONJUR_ACCOUNT:-cucumber}":user:admin 2>/dev/null | tr -d '\r' || true)
  if [ -n "$API_KEY" ]; then
    echo "[+] Retrieved admin API key: $API_KEY"
    echo "$API_KEY" > /tmp/admin_api_key
    echo "$API_KEY" > /opt/poc/.api_key 2>/dev/null || true
  else
    echo "[!] Could not retrieve API key"
  fi
fi

# Start the Conjur server (this blocks)
echo "[*] Starting Conjur server on port ${PORT:-3000}..."
exec conjurctl server \
  --no-authn-local \
  --no-rotation \
  -p "${PORT:-3000}" \
  -b 0.0.0.0
