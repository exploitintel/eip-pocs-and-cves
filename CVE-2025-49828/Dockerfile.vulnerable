# CVE-2025-49828 Lab — CyberArk Conjur SSTI via ERB
#
# CyberArk Conjur v1.21.1 with SSTI in Policy Factory Renderer.
# No patch applied — the Factories::Renderer class uses ERB for template
# rendering, allowing arbitrary Ruby code execution.
#
# Build:
#   docker compose build vulnerable
#
# Trigger:
#   python3 poc/poc.py 127.0.0.1 3000

# Builder stage: clone source and install gems
FROM ruby:3.2-slim AS builder

RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Clone Conjur at vulnerable version v1.21.1
RUN git clone --depth 1 --branch v1.21.1 \
    https://github.com/cyberark/conjur.git /src/conjur-server

WORKDIR /src/conjur-server

# Install bundler version matching the lockfile, then install gems
# Exclude test/development groups (debase gem doesn't compile with Ruby 3.2)
RUN gem install bundler -v 2.4.14 && \
    bundle config set --local jobs "$(nproc --all)" && \
    bundle config set --local without 'test development' && \
    bundle install

# Runtime stage
FROM ruby:3.2-slim

RUN apt-get update && apt-get install -y \
    libpq5 \
    postgresql-client \
    git \
    jq \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install the same bundler version
RUN gem install bundler -v 2.4.14

# Copy full source + gems from builder
COPY --from=builder /src/conjur-server /src/conjur-server
COPY --from=builder /usr/local/bundle /usr/local/bundle

WORKDIR /src/conjur-server

# Create VERSION file
RUN echo -n "1.21.1" > /src/conjur-server/VERSION

# Patch FIPS initializer: replace with minimal version that skips FIPS mode
# (standard Ruby doesn't have FIPS OpenSSL, and we don't need it for the lab)
RUN printf '%s\n' \
  '# frozen_string_literal: true' \
  'require "openssl"' \
  'require "digest"' \
  '# FIPS mode disabled for lab environment' \
  'original_verbose = $VERBOSE' \
  '$VERBOSE = nil' \
  'Digest::SHA256 = OpenSSL::Digest::SHA256' \
  'Digest::SHA1 = OpenSSL::Digest::SHA1' \
  '$VERBOSE = original_verbose' \
  > /src/conjur-server/config/initializers/fips.rb

# Remove CA bundle of httpclient gem
RUN find / -name httpclient -type d -exec find {} -name '*.pem' -type f -delete \; 2>/dev/null || true

# Symlink conjurctl to PATH
RUN ln -sf /src/conjur-server/bin/conjurctl /usr/local/bin/

# Create required directories
RUN mkdir -p /run/authn-local /src/conjur-server/log /src/conjur-server/tmp

ENV PORT=3000 \
    TERM=xterm \
    RAILS_ENV=development \
    CONJUR_LOG_LEVEL=debug \
    BUNDLE_GEMFILE=/src/conjur-server/Gemfile

EXPOSE 3000

# Copy and use custom entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
