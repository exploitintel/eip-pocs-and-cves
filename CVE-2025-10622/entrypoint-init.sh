#!/bin/bash
set -e

cd /usr/share/foreman
export RAILS_ENV=production
export RUBYOPT=-W0

# Remove a potentially pre-existing server.pid for Rails.
rm -f tmp/pids/server.pid

# If INIT_DB is set, run database initialization
if [ "${INIT_DB}" = "true" ]; then
  echo "[*] Waiting for PostgreSQL..."
  until PGPASSWORD="${PGPASSWORD:-foreman}" psql -h "${DB_HOST:-db}" -U "${DB_USER:-foreman}" -d postgres -c "SELECT 1" >/dev/null 2>&1; do
    echo "[*] PostgreSQL not ready, waiting..."
    sleep 2
  done
  echo "[+] PostgreSQL is ready"

  echo "[*] Creating database..."
  bin/rake db:create 2>/dev/null || echo "[*] Database may already exist, continuing..."

  echo "[*] Running migrations..."
  bin/rake db:migrate

  echo "[*] Seeding database..."
  bin/rake db:seed

  echo "[+] Database initialization complete"

  # Unset INIT_DB so restarts don't re-run migration
  unset INIT_DB
fi

# Execute the main command
exec "$@"
