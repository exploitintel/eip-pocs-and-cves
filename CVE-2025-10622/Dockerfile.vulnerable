# Vulnerable Foreman 3.16.0 â€” CVE-2025-10622
# OS command injection via ct_location/fcct_location settings
FROM quay.io/foreman/foreman:3.16.0

USER 0

# Install PostgreSQL client for entrypoint DB wait check
RUN dnf install -y postgresql && dnf clean all

# Copy custom database config pointing to Docker DB service
COPY database.yml /etc/foreman/database.yml

# Copy custom entrypoint that handles DB initialization
COPY entrypoint-init.sh /usr/bin/entrypoint-init.sh
RUN chmod +x /usr/bin/entrypoint-init.sh

# Ensure tmp dirs exist and are writable by foreman user
RUN mkdir -p /usr/share/foreman/tmp/pids && \
    chown foreman:foreman /usr/share/foreman/tmp && \
    chown foreman:foreman /usr/share/foreman/tmp/pids && \
    chmod 777 /usr/share/foreman/tmp && \
    chmod 777 /usr/share/foreman/tmp/pids

USER foreman

WORKDIR /usr/share/foreman

ENTRYPOINT ["entrypoint-init.sh"]
CMD ["bin/rails", "server", "-b", "0.0.0.0"]
