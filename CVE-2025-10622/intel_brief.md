# Intel Brief: CVE-2025-10622

## CVE ID
CVE-2025-10622

## Affected Software
- **Name**: Foreman (component of Red Hat Satellite)
- **Vendor**: The Foreman Project / Red Hat
- **Vulnerable Versions**: Foreman 3.12.0 through 3.16.0 (inclusive)
- **Fixed Versions**: 3.15.1, 3.16.1, 3.17.0

## CVSS Score
- **Score**: 8.0 (HIGH)
- **Vector**: CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:C/C:H/I:H/A:H

## CWE Classification
- **CWE-78**: Improper Neutralization of Special Elements used in an OS Command (OS Command Injection)
- **CWE-602**: Client-Side Enforcement of Server-Side Security

## EPSS
- 0.1% (29.9th percentile)

## Description
A command injection vulnerability exists in Foreman's provisioning settings for the CoreOS Transpiler Command (`ct_location`) and Fedora CoreOS Transpiler Command (`fcct_location`) parameters. While a whitelist of allowed binary paths (`/usr/bin/ct`, `/usr/local/bin/ct` and `/usr/bin/fcct`, `/usr/local/bin/fcct`) is defined, it is **only enforced on the client-side** via a UI dropdown `collection`. There is **no server-side validation** of these settings.

An authenticated user with `edit_settings` permissions (by default, only super administrators) can bypass the client-side restriction by directly calling the Settings API (`PUT /api/v2/settings/ct_location`) with an arbitrary executable path. When a template subsequently invokes the `transpile_coreos_linux_config()` or `transpile_fedora_coreos_config()` macros during provisioning, the attacker-controlled path is passed to `Foreman::CommandRunner`, which executes it via Ruby's `Open3.capture3`. The `CommandRunner` validates that the path is absolute, exists, and is executable — but any system binary satisfies these checks, enabling arbitrary command execution under the Foreman process user.

This also bypasses Foreman's safe mode rendering restrictions.

## Exploitation Path (Technical Detail)

### Step 1: Modify the setting via API (requires `edit_settings` permission)
```
PUT /api/v2/settings/ct_location
Content-Type: application/json
{"setting": {"value": "/usr/bin/id"}}
```
The server accepts any absolute path to an executable without validation.

### Step 2: Trigger template rendering that invokes transpiler
When a provisioning template calls `transpile_coreos_linux_config(input)`, the code at:
- `app/services/foreman/renderer/scope/macros/transpilers.rb:18`
builds the command: `[Setting[:ct_location]] + Setting[:ct_arguments]` and passes it to `Foreman::CommandRunner.new(ct_command, input).run!`

### Step 3: CommandRunner executes the command
- `lib/foreman/command_runner.rb:36` calls `Open3.capture3(*cmd, stdin_data: indata)` which executes the attacker-controlled binary with the template input as stdin.

### Key Files
| File | Role |
|------|------|
| `config/initializers/f_foreman_settings_provisioning.rb` | Defines `ct_location`/`fcct_location` settings with client-side-only whitelist |
| `app/services/foreman/renderer/scope/macros/transpilers.rb` | Template macros that execute the setting as a command |
| `lib/foreman/command_runner.rb` | Command execution wrapper using `Open3.capture3` |
| `app/controllers/api/v2/settings_controller.rb` | API endpoint for modifying settings (no validation) |

## Repository URL
- **GitHub**: https://github.com/theforeman/foreman.git
- **Clone URL**: https://github.com/theforeman/foreman.git

## Vulnerable Version
- **Tag**: `3.16.0` (checked out in workspace)
- The vulnerability was introduced in Foreman 3.12.0 when `ct_location`/`fcct_location` settings were originally created with only a client-side `collection` constraint.

## Fix Commit
- **Primary (develop)**: `49dd22221ed4ba4d7687e3e7406d8ae975a2ffa9`
  - Author: Evgeni Golov <evgeni@golov.de>
  - Date: Thu Sep 25 17:27:12 2025 +0200
  - Message: "Fixes #38885 - Properly validate ct_location and fcct_location"
  - PR: https://github.com/theforeman/foreman/pull/10750
- **Follow-up**: `551378b2f5626757ac24356e9c36be07a2f30e0b` (snapshot task fix)
- **Backport PRs**: #10751 (3.16.x), #10752 (3.15.x), #10762

### Fix Details
The fix adds two server-side `validates` calls:
```ruby
validates('ct_location', ->(value) { value.blank? || CT_LOCATIONS.include?(value) }, message: N_("Invalid ct location, use settings.yaml for arbitrary location"))
validates('fcct_location', ->(value) { value.blank? || FCCT_LOCATIONS.include?(value) }, message: N_("Invalid fcct location, use settings.yaml for arbitrary location"))
```
This ensures the setting value must be either blank or one of the whitelisted paths (`/usr/bin/ct`, `/usr/local/bin/ct`, `/usr/bin/fcct`, `/usr/local/bin/fcct`).

## Patched Versions
- **3.15.1** — contains backported fix
- **3.16.1** — contains backported fix
- **3.17.0** — first release on develop branch with the fix

## Build System
- **Primary Language**: Ruby (Rails 7.0.x application)
- **Build System**: Bundler (Gemfile) + npm/webpack for frontend assets
- **Base Image**: `quay.io/centos/centos:stream9` (official Dockerfile)
- **Pre-built Image**: `quay.io/foreman/foreman:develop`
- **Database**: PostgreSQL 12+
- **Additional Services**: Redis (caching + Dynflow task orchestration)
- **Docker Compose**: Included in repo (`docker-compose.yml`) — defines `db`, `app`, `orchestrator`, `worker`, `redis-cache`, `redis-tasks`

## Key Dependencies
| Dependency | Purpose |
|-----------|---------|
| Ruby + Bundler | Application runtime |
| Rails ~> 7.0.3 | Web framework |
| PostgreSQL | Database |
| Redis | Caching + task queue (Dynflow/Sidekiq) |
| Node.js >= 18 | Frontend build (webpack) |
| `open3` (Ruby stdlib) | Command execution in CommandRunner |
| `safemode` gem | Template sandboxing (bypassed by this vuln) |

## Lab Environment Notes
- The official `docker-compose.yml` in the repo can be adapted for the lab
- The vulnerable version `3.16.0` needs to be checked out and built
- Pre-built images exist at `quay.io/foreman/foreman:<tag>` but may not have the vulnerable version
- For PoC, the lab needs:
  1. Foreman app running on port 3000
  2. PostgreSQL database
  3. Redis for caching/tasks
  4. An admin user account (has `edit_settings` permission by default)
  5. A provisioning template that calls `transpile_coreos_linux_config()`
- **Important**: The `ct_location` setting accepts any absolute path to an executable. For PoC, setting it to `/usr/bin/id` or `/usr/bin/whoami` demonstrates command execution. For full RCE, a script or `/bin/bash` with crafted stdin could be used.

## Public Exploits
- **None found** in EIP (no Metasploit modules, no ExploitDB entries, no GitHub PoCs)
- The exploitation is straightforward — a single API call to modify the setting + triggering template rendering
- No public PoC exists; one must be written from scratch

## References
| Source | URL |
|--------|-----|
| Foreman Security Advisory | https://theforeman.org/security.html#2025-10622 |
| Red Hat CVE Page | https://access.redhat.com/security/cve/CVE-2025-10622 |
| Red Hat Bugzilla | https://bugzilla.redhat.com/show_bug.cgi?id=2396020 |
| Foreman Redmine Issue | https://projects.theforeman.org/issues/38885 |
| GitHub Fix PR (develop) | https://github.com/theforeman/foreman/pull/10750 |
| GitHub Backport PR (3.16.x) | https://github.com/theforeman/foreman/pull/10751 |
| GitHub Backport PR (3.15.x) | https://github.com/theforeman/foreman/pull/10752 |
| GitHub Follow-up PR | https://github.com/theforeman/foreman/pull/10762 |
| GHSA Advisory | https://github.com/advisories/GHSA-f5h4-c4jw-c4gm |
| RHSA-2025:19721 | https://access.redhat.com/errata/RHSA-2025:19721 |
| RHSA-2025:19832 | https://access.redhat.com/errata/RHSA-2025:19832 |
| RHSA-2025:19855 | https://access.redhat.com/errata/RHSA-2025:19855 |
| RHSA-2025:19856 | https://access.redhat.com/errata/RHSA-2025:19856 |

## Workspace State
- Repository was cloned for source analysis
- Checked out at tag `3.16.0` (vulnerable version)
- Fix commit `49dd22221ed4ba4d7687e3e7406d8ae975a2ffa9` available in history
