# Intel Brief: CVE-2025-67895

## CVE Summary

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2025-67895 |
| **Title** | Apache Airflow Providers Edge3 < 2.0.0 — Remote Code Execution via Worker RPC API |
| **Affected Software** | apache-airflow-providers-edge3 |
| **Vendor** | Apache Software Foundation |
| **CVSS Score** | 9.8 CRITICAL |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| **EPSS** | 0.3% (57th percentile) |
| **CWE** | CWE-669 (Incorrect Resource Transfer Between Spheres) |
| **Published** | 2025-12-17 |
| **GHSA** | GHSA-66h8-3g48-6hx8 |

## Description

The Edge3 provider for Apache Airflow, when installed on Airflow 2.x (specifically 2.11.0+), exposes a non-public JSON-RPC API endpoint at `/edge_worker/v1/rpcapi` via a Connexion/Flask Blueprint. This endpoint was intended for development/testing of the Edge Worker feature in Airflow 2 but was never officially released.

When `[edge] api_enabled=True` is configured, the Edge3 plugin registers a CSRF-exempt Flask Blueprint that loads an OpenAPI specification (`edge_worker_api_v1.yaml`). The `/rpcapi` endpoint (`rpcapi_v2()` handler) accepts JSON-RPC 2.0 requests, which are dispatched to Airflow's **entire internal API method map** via `initialize_method_map()` from `airflow.api_internal.endpoints.rpc_api_endpoint`.

This effectively proxies the full Airflow internal RPC API through an externally-reachable endpoint. Combined with the worker-side command execution path (`_launch_job_af2_10()`) which uses `subprocess.Popen(command)` where `command` is a `list[str]`, an attacker can achieve remote code execution.

## Vulnerability Details

### Attack Surface

1. **Exposed RPC Endpoint**: `/edge_worker/v1/rpcapi` (POST) — registered via Connexion OpenAPI spec
2. **CSRF Exemption**: The entire Blueprint is CSRF-exempted (`csrf.exempt(bp)`)
3. **Internal API Proxy**: `rpcapi_v2()` calls `initialize_method_map()` which returns ALL internal Airflow methods
4. **Parameter Deserialization**: Uses `BaseSerialization.deserialize(params, use_pydantic_models=True)` to reconstruct arbitrary Python objects
5. **Command Execution**: Worker-side `_launch_job_af2_10()` runs `subprocess.Popen(command)` with job commands

### Authentication Mechanism (Bypassable)

The endpoint uses JWT authentication via `JWTSigner` with the Airflow config key `[core] internal_api_secret_key`. The JWT token must include a `method` claim matching the RPC method. However:
- The secret key may be default/weak in development setups
- The endpoint was never intended for production use
- On Airflow 2.x, `JWTSigner` from `airflow.utils.jwt_signer` is used

### Vulnerable Code Paths

**Entry Point** — `_v2_routes.py:rpcapi_v2()`:
```python
def rpcapi_v2(body: dict[str, Any]) -> APIResponse:
    methods_map = initialize_method_map()  # Full internal API
    handler = methods_map[request_obj.method]
    params = BaseSerialization.deserialize(request_obj.params, use_pydantic_models=True)
    output = handler(**params, session=session)
```

**Command Parsing** — `_v2_compat.py:parse_command()`:
```python
ExecuteTask = list[str]  # On Airflow 2, this is just a command array
def parse_command(command: str) -> ExecuteTask:
    from ast import literal_eval
    return literal_eval(command)
```

**Execution** — `worker.py:_launch_job_af2_10()`:
```python
def _launch_job_af2_10(edge_job: EdgeJobFetched) -> tuple[Popen, Path]:
    command: list[str] = edge_job.command
    process = Popen(command, close_fds=True, env=env, start_new_session=True)
```

**Plugin Registration** — `edge_executor_plugin.py:_get_airflow_2_api_endpoint()`:
```python
bp = FlaskApi(
    specification=specification,  # edge_worker_api_v1.yaml
    resolver=_LazyResolver(),
    base_path="/edge_worker/v1",
)
csrf.exempt(bp)  # CSRF protection disabled
```

### Additional REST Endpoints Exposed (via OpenAPI spec)

All mapped in `edge_worker_api_v1.yaml`:
- `POST /edge_worker/v1/rpcapi` → `rpcapi_v2()` — **JSON-RPC gateway to internal API**
- `POST /edge_worker/v1/worker/{worker_name}` → `register_v2()` — Worker registration
- `PATCH /edge_worker/v1/worker/{worker_name}` → `set_state_v2()` — Worker state update
- `POST /edge_worker/v1/jobs/fetch/{worker_name}` → `job_fetch_v2()` — Job fetch
- `PATCH /edge_worker/v1/jobs/state/{dag_id}/{task_id}/...` → `job_state_v2()` — Job state update
- `GET /edge_worker/v1/logs/logfile_path/...` → `logfile_path_v2()` — Log path retrieval
- `POST /edge_worker/v1/logs/push/...` → `push_logs_v2()` — Log push
- `GET /edge_worker/v1/health` → Health check

## Repository & Version Information

| Field | Value |
|-------|-------|
| **Repository URL** | https://github.com/apache/airflow.git |
| **Provider Path** | `providers/edge3/` |
| **Vulnerable Version** | 1.6.0 (tag: `providers-edge3/1.6.0`, commit: `b0057c29de`) |
| **All Vulnerable Versions** | 1.0.0 through 1.6.0 (any version < 2.0.0) |
| **Patched Version** | 2.0.0 (tag: `providers-edge3/2.0.0`) |
| **Fix Commit** | `fffab39f99607e3c54842342fdc982babd403707` |
| **Fix PR** | https://github.com/apache/airflow/pull/59143 |
| **Fix Author** | jscheffl (Jens Scheffler) |
| **Fix Merged** | 2025-12-07 |
| **Requires** | Airflow 2.11.0+ (the provider's minimum Airflow version) |
| **Currently Checked Out** | `providers-edge3/1.6.0` (vulnerable) |

## Build System & Dependencies

| Field | Value |
|-------|-------|
| **Build System** | flit_core (Python package, `pyproject.toml`) |
| **Language** | Python 3.10+ |
| **Package Name** | `apache-airflow-providers-edge3` |
| **PyPI Package** | `apache-airflow-providers-edge3` |

### Key Dependencies
- `apache-airflow>=2.11.0,!=3.1.0` — Core Airflow (must be Airflow 2.x to trigger the vuln)
- `apache-airflow-providers-common-compat>=1.10.0` — Compatibility layer
- `pydantic>=2.11.0` — Data validation/serialization
- `retryhttp>=1.2.0,!=1.3.0` — HTTP retry logic
- `connexion` — OpenAPI/Swagger-first REST framework (Airflow 2.x dependency, used for API routing)
- `flask` — Web framework (Airflow 2.x webserver)
- `itsdangerous` — JWT token signing

### Additional Runtime Requirements (for reproduction)
- Apache Airflow 2.11.0 webserver (with `connexion` support)
- Configuration: `[edge] api_enabled = True`
- Database backend (PostgreSQL/MySQL/SQLite)

## Fix Analysis

The fix (PR #59143) **completely removes all Airflow 2.x compatibility code** from the Edge3 provider:

### Files Deleted
- `providers/edge3/src/airflow/providers/edge3/worker_api/routes/_v2_routes.py` — All v2 REST/RPC handlers
- `providers/edge3/src/airflow/providers/edge3/worker_api/routes/_v2_compat.py` — Connexion compatibility shims
- `providers/edge3/src/airflow/providers/edge3/openapi/edge_worker_api_v1.yaml` — OpenAPI spec for Airflow 2.x

### Files Modified
- `auth.py` — Removed dual auth paths (JWTSigner for Airflow 2, JWTValidator for Airflow 3)
- `worker.py` — Removed `_launch_job_af2_10()` with `subprocess.Popen`
- `edge_executor.py` — Removed `execute_async()` method
- `edge_executor_plugin.py` — Removed Flask Blueprint registration for Airflow 2.x
- `_v2_compat.py` — Removed `parse_command()` using `ast.literal_eval()`

## Public Exploits

**No public exploits found.** No Metasploit modules, ExploitDB entries, GitHub PoCs, or Nuclei templates exist for this CVE.

### PoC Approach for Reproduction

The most direct attack path for a PoC:

1. **Set up** Apache Airflow 2.11.x with `apache-airflow-providers-edge3<2.0.0` and `[edge] api_enabled=True`
2. **Obtain or guess** the `[core] internal_api_secret_key` JWT signing key
3. **Generate a JWT** with the appropriate `method` claim using `airflow.utils.jwt_signer.JWTSigner`
4. **Send a JSON-RPC request** to `/edge_worker/v1/rpcapi` targeting a method from the internal API method map that can lead to RCE (e.g., via task scheduling)

**Alternative PoC approach** (simpler, focusing on the worker side):
1. Register as a fake Edge Worker via `/edge_worker/v1/worker/{name}`
2. Inject a malicious job command via the job fetch/state endpoints
3. The worker executes it via `subprocess.Popen(command)` — direct RCE

## References

- **Fix PR**: https://github.com/apache/airflow/pull/59143
- **Advisory (ASF Mailing List)**: https://lists.apache.org/thread/hhnmmzkj5qx5gbk6pdkh8tcsx5oj1nqs
- **OSS-Security**: http://www.openwall.com/lists/oss-security/2025/12/16/3
- **GHSA**: GHSA-66h8-3g48-6hx8
- **NVD**: https://nvd.nist.gov/vuln/detail/CVE-2025-67895

## Lab Build Notes

For the Lab Build agent:
- This requires a full **Apache Airflow 2.11.x** deployment (webserver + database)
- Install `apache-airflow-providers-edge3==1.6.0` via pip
- Configure `[edge] api_enabled = True` in `airflow.cfg`
- The webserver exposes the vulnerable endpoints
- A separate Edge Worker process is needed to demonstrate the command execution path
- Docker Compose is recommended: Airflow webserver + PostgreSQL + Edge Worker
- The `connexion` package must be available (it's a dependency of Airflow 2.x webserver)
