# Dockerfile for CVE-2025-67895 vulnerable lab
# Apache Airflow 2.11.1 with apache-airflow-providers-edge3==1.6.0
# Exposes the vulnerable /edge_worker/v1/rpcapi endpoint

FROM apache/airflow:2.11.1-python3.12

USER root

# Install system dependencies for PostgreSQL client
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        postgresql-client \
        netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

USER airflow

# Install the vulnerable edge3 provider
# Use --no-deps to avoid dependency conflicts, then install missing deps
RUN pip install --no-cache-dir \
    "apache-airflow-providers-edge3==1.6.0" \
    "apache-airflow-providers-common-compat>=1.10.0" \
    "retryhttp>=1.2.0,!=1.3.0" \
    2>&1 || true

# Copy custom airflow config
COPY --chown=airflow:root airflow.cfg /opt/airflow/airflow.cfg

# Copy the entrypoint script
COPY --chown=airflow:root entrypoint.sh /opt/airflow/entrypoint.sh

USER root
RUN chmod +x /opt/airflow/entrypoint.sh
USER airflow

EXPOSE 8080

ENTRYPOINT ["/opt/airflow/entrypoint.sh"]
