#!/bin/bash
# CVE-2025-32897 Lab Entrypoint
# Configures Seata Server in Raft mode with dynamic IP detection
set -e

# Detect container's IP address
MY_IP=$(hostname -i | awk '{print $1}')
echo "[*] Detected container IP: ${MY_IP}"

# Export SEATA_IP so the server binds to the correct address
export SEATA_IP="${MY_IP}"

# Generate application.yml with Raft mode enabled using the detected IP
cat > /seata-server/resources/application.yml << EOF
server:
  port: 7091

spring:
  application:
    name: seata-server

logging:
  config: classpath:logback-spring.xml
  file:
    path: \${log.home:\${user.home}/logs/seata}

console:
  user:
    username: seata
    password: seata

seata:
  config:
    type: file
  registry:
    type: file
  store:
    mode: raft
  server:
    service-port: 8091
    raft:
      group: default
      server-addr: ${MY_IP}:9091
      snapshot-interval: 600
      apply-batch: 32
      max-append-bufferSize: 262144
      max-replicator-inflight-msgs: 256
      disruptor-buffer-size: 16384
      election-timeout-ms: 2000
      reporter-enabled: false
      serialization: jackson
      compressor: none
      sync: true
  security:
    secretKey: SeataSecretKey0c382ef121d778043159209298fd40bf3850a017
    tokenValidityInMilliseconds: 1800000
    csrf-ignore-urls: /metadata/v1/**
    ignore:
      urls: /,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.jpeg,/**/*.ico,/api/v1/auth/login,/version.json,/health,/error,/vgroup/v1/**
EOF

echo "[*] Generated Raft mode configuration with server-addr: ${MY_IP}:9091"
echo "[*] Store mode: raft | Serialization: jackson | Compressor: none"
echo "[*] Starting Seata Server v2.2.0 (vulnerable)..."

# Call the original entrypoint
exec /bin/bash /seata-server-entrypoint.sh
