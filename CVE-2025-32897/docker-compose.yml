# CVE-2025-32897: Apache Seata Insecure Deserialization in Raft Cluster
# Lab environment for PoC reproduction
#
# Architecture: Single Seata server node in Raft mode
# Attack surface: Port 9091 (SOFABolt TCP RPC - Raft protocol)
#
# Usage:
#   docker compose up -d
#   docker compose logs -f vulnerable
#   docker compose down

services:
  vulnerable:
    build:
      context: .
      dockerfile: Dockerfile.vulnerable
    container_name: cve-2025-32897-vulnerable
    hostname: seata-vulnerable
    environment:
      # Reduce JVM memory for lab use
      JVM_XMX: "512m"
      JVM_XMS: "512m"
      JVM_MetaspaceSize: "64m"
      JVM_MaxMetaspaceSize: "128m"
      JVM_MaxDirectMemorySize: "256m"
    ports:
      - "7191:7091"   # HTTP console
      - "8191:8091"   # TC service
      - "9191:9091"   # Raft port (attack surface)
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:7091/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
