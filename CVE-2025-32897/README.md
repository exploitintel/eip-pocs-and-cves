# CVE-2025-32897: Apache Seata Insecure Deserialization in Raft Cluster Components (RCE)

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-32897 |
| **Affected Software** | Apache Seata (incubating) — Server Raft cluster components |
| **Affected Versions** | 2.0.0 – 2.2.0 (Raft mode deployments only) |
| **Patched Version** | 2.3.0 |
| **CVSS** | 9.8 CRITICAL — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| **CWE** | CWE-502: Deserialization of Untrusted Data |
| **Author** | [Exploit Intelligence Platform](https://exploit-intel.com) |

## Overview

Apache Seata (incubating) Server v2.0.0–v2.2.0 contains three independent insecure deserialization vulnerabilities in the Raft cluster consensus layer, enabling **unauthenticated remote code execution (RCE)** via the Raft communication port (default 9091). The vulnerabilities affect deployments using Raft mode (`seata.store.mode=raft`).

## Root Cause

### 1. CustomDeserializer — Arbitrary Class Loading (PRIMARY)

`CustomDeserializer.java` is a Jackson JSON deserializer for `Class<?>` types that calls `Class.forName(className)` on attacker-controlled input without any package or class allowlist. Combined with JNDI injection gadgets (e.g., `com.sun.rowset.JdbcRowSetImpl` or the Seata-bundled `dm.jdbc.driver.DmdbJdbcRowSet`), this leads to RCE via JNDI callback.

### 2. RaftSnapshotSerializer — Unfiltered Java Object Deserialization

`RaftSnapshotSerializer.decode()` uses raw `ObjectInputStream.readObject()` without any `resolveClass()` override or JEP 290 filter. Standard ysoserial gadget chains targeting libraries on the Seata classpath work directly.

### 3. RaftSyncMessageSerializer — Security Exception Swallowed

`RaftSyncMessageSerializer.decode()` has a PERMITS whitelist for its outer `ObjectInputStream`, but the inner body processing through `JacksonSerializer` → `CustomDeserializer` has zero class restrictions. The error handler also fails to propagate wrapped `SeataRuntimeException` instances.

### Attack Surface

- **Entry Point**: Raft port TCP 9091 (SOFABolt RPC, completely unauthenticated)
- **Protocol**: SOFABolt binary RPC over TCP
- **Serialization**: Java ObjectInputStream + Jackson JSON (both vulnerable)

## Lab Setup

### Prerequisites

- Docker Engine with Docker Compose plugin

### Start the Lab

```bash
docker compose up -d
```

### Lab Containers

| Container | Image Base | Role | Host Ports |
|---|---|---|---|
| `cve-2025-32897-vulnerable` | `apache/seata-server:2.2.0` | Vulnerable Seata server (Raft mode) | 7191 (HTTP), 8191 (TC), 9191 (Raft) |

### Verify Lab Health

```bash
# Check container status
docker compose ps

# Verify Raft mode is active
docker compose logs vulnerable | grep "store mode"

# Test HTTP console (default creds: seata:seata)
curl -s http://localhost:7191/api/v1/auth/login -X POST \
  -H 'Content-Type: application/json' \
  -d '{"username":"seata","password":"seata"}'
```

### Stop the Lab

```bash
docker compose down
```

## PoC Usage

### Files

| File | Description |
|---|---|
| `poc/poc.py` | Full orchestrator — deploys Java exploit, starts JNDI listener, runs all vectors |
| `poc/poc_vector2.py` | Vector 2 — Python-crafted HashMap payload for RaftSnapshotSerializer |
| `poc/poc_vector3.py` | Vector 3 — Exception handling bypass demonstration |
| `poc/ExploitCVE202532897.java` | Java exploit — directly calls vulnerable Seata methods |

### Primary PoC — All Vectors (`poc.py`)

Deploys the Java exploit into the vulnerable container, starts a JNDI callback listener, and runs all test vectors automatically.

```bash
python3 poc/poc.py
```

**Expected output (abbreviated):**
```
[Test 1a] Arbitrary class loading: java.net.URLClassLoader
[VULNERABLE] Class.forName("java.net.URLClassLoader") succeeded!

[Test 1b] JNDI Injection via com.sun.rowset.JdbcRowSetImpl
[VULNERABLE] JNDI injection TRIGGERED!

[Test 1c] JNDI Injection via dm.jdbc.driver.DmdbJdbcRowSet
[VULNERABLE] JNDI injection triggered via DmdbJdbcRowSet!

[Test 2a] Unrestricted deserialization: java.util.HashMap
[VULNERABLE] ObjectInputStream deserialized HashMap without filtering!

[Test 2b] Unrestricted deserialization: java.net.InetAddress
[VULNERABLE] InetAddress deserialized without filtering!

[Test 2c] Contrast: RaftSyncMessageSerializer DOES have a whitelist
[EXPECTED] RaftSyncMessageSerializer REJECTED the HashMap
```

### Vector 2 — RaftSnapshotSerializer (`poc_vector2.py`)

Constructs a Java serialized HashMap payload **entirely in Python** and passes it to `RaftSnapshotSerializer.decode()` inside the container.

```bash
python3 poc/poc_vector2.py
```

### Vector 3 — Exception Handling Bypass (`poc_vector3.py`)

Demonstrates the PERMITS whitelist bypass — the outer `ObjectInputStream` has a whitelist, but inner body processing through `JacksonSerializer` is unprotected.

```bash
python3 poc/poc_vector3.py
```

### Manual Java Exploit (inside container)

```bash
docker cp poc/ExploitCVE202532897.java cve-2025-32897-vulnerable:/tmp/
docker exec cve-2025-32897-vulnerable javac -cp "/seata-server/classes:/seata-server/libs/*" /tmp/ExploitCVE202532897.java
docker exec cve-2025-32897-vulnerable java -cp "/tmp:/seata-server/classes:/seata-server/libs/*" ExploitCVE202532897 all
```

## Verification: Vulnerable (v2.2.0)

| Test | Result | Evidence |
|---|---|---|
| CustomDeserializer: `URLClassLoader` | **VULNERABLE** | `Class.forName()` loads arbitrary class outside `org.apache.seata` |
| CustomDeserializer: `JdbcRowSetImpl` | **VULNERABLE** | JNDI injection triggered (blocked by Jackson blocklist, not Seata) |
| CustomDeserializer: `DmdbJdbcRowSet` | **VULNERABLE** | JNDI injection triggered — **bypasses Jackson's blocklist** |
| RaftSnapshotSerializer: `HashMap` | **VULNERABLE** | Deserialized without any class filtering |
| RaftSnapshotSerializer: `InetAddress` | **VULNERABLE** | Deserialized without any class filtering |
| RaftSyncMessageSerializer: Whitelist bypass | **VULNERABLE** | Outer whitelist does not protect inner Jackson deserialization |

## Fix

The fix is delivered across two commits between v2.2.0 and v2.3.0:

**Commit 1**: [`851e5de2e`](https://github.com/apache/incubator-seata/commit/851e5de2e) — Adds `resolveClass()` override with PERMITS whitelist to `RaftSnapshotSerializer`

**Commit 2**: [`7eda23e94`](https://github.com/apache/incubator-seata/commit/7eda23e948312ed52c3336de70a11f4d2ab06a48) — Adds `org.apache.seata` namespace restriction to `CustomDeserializer`, fixes exception propagation | [PR #7049](https://github.com/apache/incubator-seata/pull/7049)

### Recommended Mitigations

1. **Upgrade to Seata >= 2.3.0** — This is the definitive fix
2. **Network segmentation** — Restrict access to the Raft port (default 9091) to cluster-internal communication only
3. **Avoid Raft mode** — File-mode and DB-mode deployments are not affected

## References

| Resource | URL |
|---|---|
| **Apache Advisory** | https://lists.apache.org/thread/9fhtf7yvpjpzlwd1m0wfgg6tp2btxpy1 |
| **GHSA Advisory** | https://github.com/advisories/GHSA-m964-fjrh-xxq2 |
| **Fix Commit (Raft deserializers)** | https://github.com/apache/incubator-seata/commit/7eda23e948312ed52c3336de70a11f4d2ab06a48 |
| **Fix Commit (Snapshot filtering)** | https://github.com/apache/incubator-seata/commit/851e5de2e |
| **Fix PR #7049** | https://github.com/apache/incubator-seata/pull/7049 |
| **NVD** | https://nvd.nist.gov/vuln/detail/CVE-2025-32897 |

## Disclaimer

This proof-of-concept is provided for **authorized security testing, education, and research purposes only**. Do not use against systems without explicit written authorization. The authors assume no liability for misuse.
