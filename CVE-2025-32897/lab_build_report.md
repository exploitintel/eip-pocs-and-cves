# Lab Build Report: CVE-2025-32897

## Lab Architecture

**Architecture:** Single-container Apache Seata server running in Raft mode (vulnerable version)

The lab deploys Apache Seata Server v2.2.0 configured in Raft cluster mode with Jackson serialization. This activates all three vulnerable deserialization code paths:

1. **CustomDeserializer.java** — `Class.forName()` without allowlist during Jackson JSON deserialization
2. **RaftSnapshotSerializer.java** — `ObjectInputStream.readObject()` without `resolveClass()` filtering
3. **RaftSyncMessageSerializer.java** — Error handling swallows `SeataRuntimeException` through Jackson wrapping

The Raft protocol communicates over SOFABolt (TCP-based RPC) on port 9091, which is completely unauthenticated.

---

## Container Details

### Vulnerable Container

| Field | Value |
|-------|-------|
| **Container Name** | `cve-2025-32897-vulnerable` |
| **Image** | `cve-2025-32897-vulnerable` (based on `apache/seata-server:2.2.0`) |
| **Seata Version** | 2.2.0 (vulnerable) |
| **Java Version** | OpenJDK 1.8.0_342 |
| **Store Mode** | `raft` |
| **Serialization** | `jackson` |
| **Compressor** | `none` |

### Ports

| Port | Protocol | Service | Description |
|------|----------|---------|-------------|
| 7091 | HTTP | Seata Console (Spring Boot) | Web UI, login: `seata:seata` |
| 8091 | TCP | Seata TC (Transaction Coordinator) | Client service port |
| 9091 | TCP | **Raft Port (SOFABolt RPC)** | **ATTACK SURFACE — unauthenticated** |

### Host Port Mappings

| Host Port | Container Port | Service |
|-----------|---------------|---------|
| 7191 | 7091 | HTTP Console |
| 8191 | 8091 | TC Service |
| 9191 | 9091 | Raft Port (attack surface) |

---

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| `cve-2025-32897-vulnerable` | **SUCCESS** | Built from official `apache/seata-server:2.2.0` with custom Raft mode entrypoint |
| Raft Mode Init | **SUCCESS** | Single-node cluster elected itself leader (term=1) |
| SOFABolt RPC (9091) | **LISTENING** | Accepts TCP connections, unauthenticated |
| HTTP Console (7091) | **HEALTHY** | Healthcheck passes, login works with `seata:seata` |
| TC Service (8091) | **LISTENING** | Netty server started |

---

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs -f vulnerable

# Stop the lab
docker compose down

# Full reset (remove volumes)
docker compose down -v
```

---

## Verification Evidence

### 1. Raft Mode Active
```
use lock store mode: raft
use session store mode: raft
raft mode and raft cluster is an experimental feature
Node <default/172.29.0.2:9091> become leader of group, term=1
started seata server raft cluster, group: default
```

### 2. Vulnerable Classes Confirmed on Classpath
```
/seata-server/classes/org/apache/seata/server/cluster/raft/serializer/CustomDeserializer.class
/seata-server/classes/org/apache/seata/server/cluster/raft/snapshot/RaftSnapshotSerializer.class
/seata-server/classes/org/apache/seata/server/cluster/raft/sync/RaftSyncMessageSerializer.class
```

### 3. Gadget Libraries on Classpath (for exploitation)
| Library | File | Gadget |
|---------|------|--------|
| JDK JdbcRowSetImpl | `rt.jar` → `com/sun/rowset/JdbcRowSetImpl.class` | JNDI injection (built into JDK) |
| DM JDBC Driver | `DmJdbcDriver18-8.1.2.192.jar` → `dm/jdbc/driver/DmdbJdbcRowSet.class` | JNDI injection |
| H2 Database | `h2-2.1.214.jar` | Various gadget chains |
| Spring Framework | `spring-aop-5.3.39.jar`, `spring-beans-5.3.39.jar` | Spring gadget chains |
| Jackson | `jackson-databind-2.13.5.jar` | Deserialization framework |

### 4. Port Accessibility
```
HTTP Console (7091): OK (health check passes)
TC Service (8091):   OPEN (TCP connection accepted)
Raft Port (9091):    OPEN (TCP connection accepted - SOFABolt binary protocol)
```

### 5. Console Login Test
```json
{"code":"200","message":"success","data":"Bearer eyJhbGci...","success":true}
```
Default credentials `seata:seata` work on the console.

### 6. Seata Version Confirmed
```json
{"version": "2.2.0"}
```

---

## Raft Configuration Details

The entrypoint script (`entrypoint-raft.sh`) dynamically generates the application.yml at container startup:
- Detects the container's IP via `hostname -i`
- Sets `SEATA_IP` environment variable (used by Seata to determine its bind address)
- Configures `server-addr` in the Raft config to `<detected_ip>:9091`
- Sets `store.mode=raft`, `serialization=jackson`, `compressor=none`

This ensures the Raft node correctly identifies itself regardless of the container's assigned IP.

---

## Attack Surface for PoC Agent

### Primary Target: Raft Port 9091 (SOFABolt TCP RPC)

**Protocol:** SOFABolt binary RPC protocol over TCP
**Authentication:** NONE
**Serialization:** Java ObjectInputStream + Jackson JSON (both vulnerable)

### Attack Vectors

1. **CustomDeserializer via RaftSyncMessage (RECOMMENDED)**
   - Craft a Java-serialized `RaftSyncMessage` containing a Jackson JSON body
   - JSON body references a JNDI gadget class (e.g., `com.sun.rowset.JdbcRowSetImpl`)
   - Send via SOFABolt protocol to port 9091
   - Triggers `Class.forName()` on attacker-specified class → JNDI injection → RCE

2. **RaftSnapshotSerializer (raw deserialization)**
   - Send a crafted serialized object via the Raft snapshot protocol
   - `ObjectInputStream.readObject()` with NO filtering
   - Standard ysoserial gadget chains work directly

### Key Technical Details for PoC Construction

- **RaftSyncMessage serialVersionUID:** `8225279734319945365L`
- **Codec for Jackson:** `0x32`
- **Compressor for none:** `0x00`
- **JNDI gadget class (JDK built-in):** `com.sun.rowset.JdbcRowSetImpl`
- **JNDI gadget class (DM JDBC):** `dm.jdbc.driver.DmdbJdbcRowSet`
- **Jackson JSON payload format:** `{"obj":"<base64-encoded-json>","clz":"<gadget-class-name>"}`

### Accessing the Lab

The Raft port is mapped to `localhost:9191`. The PoC scripts use `docker exec` to run Java exploits inside the container.

---

## Files Created

| File | Purpose |
|------|---------|
| `Dockerfile.vulnerable` | Extends official Seata image with Raft mode entrypoint |
| `docker-compose.yml` | Orchestrates the vulnerable container |
| `entrypoint-raft.sh` | Dynamic IP detection + Raft config generation |

---

## Known Issues / Limitations

1. **Single-node Raft cluster:** The lab runs a single Raft node (not a 3-node cluster). This is sufficient for triggering the deserialization vulnerability since the vulnerable code paths are in the serialization layer, not the consensus protocol itself.

2. **Dynamic IP:** The container's IP is assigned dynamically by Docker. The entrypoint script handles this automatically, but the PoC agent must use `docker inspect` to discover the IP at runtime.

3. **JVM Memory:** JVM memory is reduced to 512MB for lab efficiency. This is sufficient for the vulnerability demonstration.

4. **No patched container:** A patched container (v2.3.0) is not included in the lab. If differential testing is needed, a similar setup with `apache/seata-server:2.3.0` can be created.
