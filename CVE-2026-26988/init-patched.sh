#!/bin/bash
# Lab initialization script for CVE-2026-26988 PATCHED container
set -e

PATCHED_CONTAINER="cve-2026-26988-patched"
DB_CONTAINER="cve-2026-26988-patched-db"
ADMIN_USER="admin"
ADMIN_PASS="Cvelab2026!sqli"
ADMIN_EMAIL="admin@lab.local"

echo "[*] Waiting for patched LibreNMS container to be ready..."
for i in $(seq 1 120); do
    STATUS=$(docker exec "$PATCHED_CONTAINER" sh -c 'curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/login' 2>/dev/null)
    if echo "$STATUS" | grep -q '200\|302'; then
        echo "[+] Patched LibreNMS web UI is responding (HTTP $STATUS)"
        break
    fi
    echo "    Waiting... ($i/120, status=$STATUS)"
    sleep 2
done

echo "[*] Removing install wizard marker..."
docker exec "$PATCHED_CONTAINER" sed -i '/^INSTALL=/d' /opt/librenms/.env

echo "[*] Setting APP_URL..."
CONTAINER_IP=$(docker inspect "$PATCHED_CONTAINER" --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
docker exec "$PATCHED_CONTAINER" sh -c "sed -i \"s|^APP_URL=.*|APP_URL=http://${CONTAINER_IP}:8000|\" /opt/librenms/.env"

echo "[*] Clearing Laravel cache..."
docker exec -u librenms "$PATCHED_CONTAINER" php /opt/librenms/artisan config:clear 2>/dev/null || true
docker exec -u librenms "$PATCHED_CONTAINER" php /opt/librenms/artisan cache:clear 2>/dev/null || true

echo "[*] Creating admin user..."
docker exec -u librenms "$PATCHED_CONTAINER" php /opt/librenms/artisan tinker --execute="
\$user = \App\Models\User::where('username', '$ADMIN_USER')->first();
if (\$user) {
    \$user->password = \Illuminate\Support\Facades\Hash::make('$ADMIN_PASS');
    \$user->save();
    echo 'Admin user password reset' . PHP_EOL;
} else {
    \$user = new \App\Models\User;
    \$user->username = '$ADMIN_USER';
    \$user->password = \Illuminate\Support\Facades\Hash::make('$ADMIN_PASS');
    \$user->email = '$ADMIN_EMAIL';
    \$user->auth_type = 'mysql';
    \$user->enabled = 1;
    \$user->can_modify_passwd = 1;
    \$user->save();
    \$user->assignRole('admin');
    echo 'Admin user created' . PHP_EOL;
}
" 2>/dev/null

echo "[*] Seeding test data (devices, ports, addresses)..."
docker exec "$PATCHED_CONTAINER" sh -c "
mariadb -h $DB_CONTAINER -u librenms -plibrenms_pass librenms -e \"
INSERT IGNORE INTO devices (device_id, hostname, sysName, os, status, last_polled, type)
VALUES (1, 'lab-router', 'lab-router', 'linux', 1, NOW(), 'network');

INSERT IGNORE INTO ports (port_id, device_id, ifIndex, ifDescr, ifName, ifAlias, ifType, ifSpeed, ifOperStatus, ifAdminStatus)
VALUES (1, 1, 1, 'eth0', 'eth0', 'Lab Interface', 'ethernetCsmacd', 1000000000, 'up', 'up');

INSERT IGNORE INTO ipv6_addresses (ipv6_address_id, ipv6_address, ipv6_compressed, ipv6_prefixlen, ipv6_origin, port_id, context_name)
VALUES (1, '20010db8000000000000000000000001', '2001:db8::1', 64, 'manual', 1, '');

INSERT IGNORE INTO ipv4_addresses (ipv4_address_id, ipv4_address, ipv4_prefixlen, port_id, context_name)
VALUES (1, '10.0.0.1', 24, 1, '');
\"
" 2>/dev/null

echo ""
echo "[+] Patched lab initialization complete!"
echo ""
echo "    LibreNMS URL: http://${CONTAINER_IP}:8000"
echo "    Admin User:   $ADMIN_USER"
echo "    Admin Pass:   $ADMIN_PASS"
echo "    Container IP: $CONTAINER_IP"
echo "    Container:    $PATCHED_CONTAINER"

# Verify the fix is applied
echo ""
echo "[*] Verifying fix is applied..."
VULN_FILE=$(docker exec "$PATCHED_CONTAINER" sh -c 'test -f /opt/librenms/includes/html/table/address-search.inc.php && echo "PRESENT" || echo "DELETED"')
echo "    address-search.inc.php: $VULN_FILE"
NEW_CONTROLLER=$(docker exec "$PATCHED_CONTAINER" sh -c 'test -f /opt/librenms/app/Http/Controllers/Table/AddressSearchController.php && echo "PRESENT" || echo "MISSING"')
echo "    AddressSearchController.php: $NEW_CONTROLLER"
