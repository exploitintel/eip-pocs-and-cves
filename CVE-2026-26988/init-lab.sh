#!/bin/bash
# Lab initialization script for CVE-2026-26988
# Run this after docker compose up -d to complete lab setup
set -e

VULN_CONTAINER="cve-2026-26988-vulnerable"
DB_CONTAINER="cve-2026-26988-db"
ADMIN_USER="admin"
ADMIN_PASS="Cvelab2026!sqli"
ADMIN_EMAIL="admin@lab.local"

echo "[*] Waiting for LibreNMS container to be ready..."
for i in $(seq 1 60); do
    if docker exec "$VULN_CONTAINER" sh -c 'curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/login' 2>/dev/null | grep -q '200\|302'; then
        echo "[+] LibreNMS web UI is responding"
        break
    fi
    echo "    Waiting... ($i/60)"
    sleep 2
done

echo "[*] Removing install wizard marker..."
docker exec "$VULN_CONTAINER" sed -i '/^INSTALL=/d' /opt/librenms/.env

echo "[*] Setting APP_URL..."
CONTAINER_IP=$(docker inspect "$VULN_CONTAINER" --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
docker exec "$VULN_CONTAINER" sh -c "sed -i \"s|^APP_URL=.*|APP_URL=http://${CONTAINER_IP}:8000|\" /opt/librenms/.env"

echo "[*] Clearing Laravel cache..."
docker exec -u librenms "$VULN_CONTAINER" php /opt/librenms/artisan config:clear 2>/dev/null
docker exec -u librenms "$VULN_CONTAINER" php /opt/librenms/artisan cache:clear 2>/dev/null

echo "[*] Creating admin user..."
docker exec -u librenms "$VULN_CONTAINER" php /opt/librenms/artisan tinker --execute="
\$user = \App\Models\User::where('username', '$ADMIN_USER')->first();
if (\$user) {
    \$user->password = \Illuminate\Support\Facades\Hash::make('$ADMIN_PASS');
    \$user->save();
    echo 'Admin user password reset' . PHP_EOL;
} else {
    \$user = new \App\Models\User;
    \$user->username = '$ADMIN_USER';
    \$user->password = \Illuminate\Support\Facades\Hash::make('$ADMIN_PASS');
    \$user->email = '$ADMIN_EMAIL';
    \$user->auth_type = 'mysql';
    \$user->enabled = 1;
    \$user->can_modify_passwd = 1;
    \$user->save();
    // Assign admin role
    \$user->assignRole('admin');
    echo 'Admin user created' . PHP_EOL;
}
" 2>/dev/null

echo "[*] Seeding test data (devices, ports, addresses)..."
docker exec "$VULN_CONTAINER" sh -c "
mariadb -h $DB_CONTAINER -u librenms -plibrenms_pass librenms -e \"
-- Insert test device (skip if exists)
INSERT IGNORE INTO devices (device_id, hostname, sysName, os, status, last_polled, type)
VALUES (1, 'lab-router', 'lab-router', 'linux', 1, NOW(), 'network');

-- Insert test port (skip if exists)
INSERT IGNORE INTO ports (port_id, device_id, ifIndex, ifDescr, ifName, ifAlias, ifType, ifSpeed, ifOperStatus, ifAdminStatus)
VALUES (1, 1, 1, 'eth0', 'eth0', 'Lab Interface', 'ethernetCsmacd', 1000000000, 'up', 'up');

-- Insert test IPv6 address (skip if exists)
INSERT IGNORE INTO ipv6_addresses (ipv6_address_id, ipv6_address, ipv6_compressed, ipv6_prefixlen, ipv6_origin, port_id, context_name)
VALUES (1, '20010db8000000000000000000000001', '2001:db8::1', 64, 'manual', 1, '');

-- Insert test IPv4 address (skip if exists)
INSERT IGNORE INTO ipv4_addresses (ipv4_address_id, ipv4_address, ipv4_prefixlen, port_id, context_name)
VALUES (1, '10.0.0.1', 24, 1, '');
\"
" 2>/dev/null

echo ""
echo "[+] Lab initialization complete!"
echo ""
echo "    LibreNMS URL: http://${CONTAINER_IP}:8000"
echo "    Admin User:   $ADMIN_USER"
echo "    Admin Pass:   $ADMIN_PASS"
echo ""
echo "    Container IP: $CONTAINER_IP"
echo "    Container:    $VULN_CONTAINER"
