# Dockerfile.patched â€” CVE-2026-26988 Patched Container
#
# Applies fix commit 15429580ba to LibreNMS 25.12.0
# Deletes vulnerable file, adds parameterized Eloquent controllers

FROM librenms/librenms:25.12.0

# Apply the fix for CVE-2026-26988 (commit 15429580ba)
# 1. Delete the vulnerable file
RUN rm -f /opt/librenms/includes/html/table/address-search.inc.php

# 2. Add new parameterized Laravel controllers
COPY patched-files/AddressSearchController.php /opt/librenms/app/Http/Controllers/Table/AddressSearchController.php
COPY patched-files/Ipv4AddressSearchController.php /opt/librenms/app/Http/Controllers/Table/Ipv4AddressSearchController.php
COPY patched-files/Ipv6AddressSearchController.php /opt/librenms/app/Http/Controllers/Table/Ipv6AddressSearchController.php
COPY patched-files/MacSearchController.php /opt/librenms/app/Http/Controllers/Table/MacSearchController.php

# 3. Update routes to add new endpoints
COPY patched-files/web.php /opt/librenms/routes/web.php

# 4. Update frontend pages to use new endpoints
COPY patched-files/ipv4.inc.php /opt/librenms/includes/html/pages/search/ipv4.inc.php
COPY patched-files/ipv6.inc.php /opt/librenms/includes/html/pages/search/ipv6.inc.php
COPY patched-files/mac.inc.php /opt/librenms/includes/html/pages/search/mac.inc.php

# 5. Update Eloquent models with new relationships
COPY patched-files/Ipv4Address.php /opt/librenms/app/Models/Ipv4Address.php
COPY patched-files/Ipv6Address.php /opt/librenms/app/Models/Ipv6Address.php

# Ensure proper ownership
RUN chown -R nobody:nogroup /opt/librenms/app/Http/Controllers/Table/ \
    /opt/librenms/routes/web.php \
    /opt/librenms/includes/html/pages/search/ \
    /opt/librenms/app/Models/Ipv4Address.php \
    /opt/librenms/app/Models/Ipv6Address.php
