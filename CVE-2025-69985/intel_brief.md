# Intel Brief: CVE-2025-69985

## CVE Metadata
- **CVE ID**: CVE-2025-69985
- **GHSA**: GHSA-4r4r-4jp4-wwf9
- **Published**: 2026-02-24
- **CVSS Score**: 9.8 (CRITICAL)
- **CVSS Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
- **EPSS**: 0.5% (67.2th percentile)
- **CWE**: CWE-288 (Authentication Bypass Using an Alternate Path or Channel)

## Affected Software
- **Name**: FUXA
- **Vendor**: frangoteam
- **Package**: @frangoteam/fuxa (npm)
- **Affected Versions**: ≤ 1.2.8 (all versions up to and including 1.2.8)
- **Patched Version**: **NONE** — no patched version available per GHSA-4r4r-4jp4-wwf9

## Description
FUXA 1.2.8 and prior contains an Authentication Bypass vulnerability leading to Remote Code Execution (RCE). The vulnerability exists in the `server/api/jwt-helper.js` middleware, specifically in the `requireAuth` function, which improperly trusts the HTTP `Referer` header to validate internal requests.

A remote unauthenticated attacker can bypass JWT authentication by spoofing the `Referer` header to match the server's host (e.g., including `/fuxa` in the Referer URL). Combined with the `/api/runscript` endpoint — which accepts arbitrary JavaScript code for execution — this results in full unauthenticated Remote Code Execution.

This vulnerability is described as an incomplete fix for CVE-2023-33831 (an earlier auth bypass + RCE in FUXA).

## Vulnerability Root Cause Analysis

### Primary Flaw: Referer Header Trust in `requireAuth`
File: `server/api/jwt-helper.js`, function `requireAuth()` (line ~70)

The `requireAuth` middleware checks the HTTP `Referer` header before enforcing JWT authentication. If the Referer matches certain patterns, the request is allowed through WITHOUT any token verification:

```javascript
function requireAuth (req, res, next) {
    const referer = req.headers.referer;
    if (referer) {
        // Allow if referer is from the same host
        const requestHost = req.headers.host;
        if (referer.startsWith(`http://${requestHost}`) || referer.startsWith(`https://${requestHost}`)) {
            return next();  // BYPASS: any request with matching host Referer skips auth
        }
        // Allow if referer contains common FUXA paths
        const fuxaPatterns = [
            '/fuxa', '/editor', '/viewer', '/lab', '/home',
            'localhost:', '127.0.0.1:', '0.0.0.0:'
        ];
        const hasFuxaReferer = fuxaPatterns.some(pattern => referer.includes(pattern));
        if (hasFuxaReferer) {
            return next();  // BYPASS: any request with /fuxa in Referer skips auth
        }
    }
    // Only reaches JWT verification if Referer check fails
    // ...
}
```

**Two bypass vectors:**
1. Set `Referer` to `http://<target-host>:<port>/anything` → matches same-host check
2. Set `Referer` to any URL containing `/fuxa`, `/editor`, `/viewer`, `/lab`, `/home`, `localhost:`, `127.0.0.1:`, or `0.0.0.0:` → matches pattern check

### Secondary Flaw: Permissive `verifyToken` Middleware
File: `server/api/jwt-helper.js`, function `verifyToken()` (line ~47)

The `verifyToken` middleware (used by the main API endpoints via `verifyApiOrToken`) does NOT enforce authentication. It simply decorates the request with user info:
- If no `x-access-token` header: auto-generates a guest JWT and sets `userId="guest"`, `userGroups=["guest"]`
- Always calls `next()` regardless of authentication status
- When `secureEnabled` is `false` (DEFAULT), `verifyApiOrToken` skips all checks entirely

### RCE Vector: `/api/runscript` Endpoint
File: `server/api/scripts/index.js`

The `/api/runscript` endpoint accepts a POST body with a `script` object. When the `script.test` field is populated, the code is compiled into a Node.js module and executed directly:
```javascript
// server/runtime/scripts/msm.js - runTestScript()
this.runTestScript = function (_script) {
    var tempScripts = JSON.parse(JSON.stringify(scriptsMap));
    tempScripts[_script.name] = _script;
    var result = _scriptsToModule(tempScripts, eventsIncludes);
    if (result.module) {
        return result.module[_script.name](...paramValues);  // Executes user-supplied JS
    }
}
```

This allows arbitrary Node.js code execution including `require("child_process").execSync()`.

## Exploitation Flow
1. Attacker sends POST to `http://target:1881/api/runscript`
2. Sets `Referer: http://target:1881/fuxa` header to bypass auth
3. POST body contains JavaScript payload using `child_process.execSync` in the `test` field
4. Server executes the payload and returns command output
5. **No authentication required, no reverse shell needed**

## Repository
- **URL**: https://github.com/frangoteam/FUXA.git
- **Clone**: Already cloned to `source/`
- **Vulnerable Version**: v1.2.8 (tag `v1.2.8`, commit `5d8463f5`)
- **Currently checked out**: v1.2.8

## Fix Information
- **Patched Version**: **NONE** — the Referer bypass in `requireAuth` remains present in all versions through v1.2.11 (latest)
- **Related Fix Commits**:
  - `37f9876f` / `fe82348d` — "security: fix auth bypass in heartbeat token refresh" (fixes a related token refresh issue, does NOT fix the Referer bypass)
  - `4246c40a` / `22c2192f` — "feat: enforcing auth middleware and validating/sandboxing the destination path" (hardens project API, does NOT fix the Referer bypass)
- **Fix commit for this CVE**: None identified — the `requireAuth` Referer check is identical across v1.2.8 through v1.2.11

## Build System & Dependencies
- **Primary Language**: JavaScript (Node.js)
- **Build System**: npm (Node.js package manager)
- **Server Entry Point**: `server/main.js`
- **Start Command**: `npm start` → `node main.js`
- **Default Port**: 1881
- **Node.js Version**: 18 (per Dockerfile base image `node:18-bookworm`)
- **Key Dependencies**:
  - `express` 4.21.2 — HTTP framework
  - `jsonwebtoken` 9.0.0 — JWT authentication
  - `socket.io` 4.8.1 — WebSocket communication
  - `sqlite3` 5.1.5 — Database storage
  - `bcryptjs` 2.4.3 — Password hashing
  - `body-parser` 1.20.3 — Request body parsing
  - `morgan` 1.10.0 — HTTP request logging
  - `express-rate-limit` 5.5.1 — Rate limiting

## Docker Lab Setup Notes
- **Official Dockerfile**: `source/Dockerfile` (builds from source, uses `node:18-bookworm`)
- **Official Docker Image**: `frangoteam/fuxa:latest` and `frangoteam/fuxa:1.2.8` (both available on Docker Hub)
- **Docker Compose**: `compose.yml` at repo root
- **Exposed Port**: 1881
- **Volumes**:
  - `appdata → /usr/src/app/FUXA/server/_appdata` (settings)
  - `db → /usr/src/app/FUXA/server/_db` (database)
  - `logs → /usr/src/app/FUXA/server/_logs` (logs)
  - `images → /usr/src/app/FUXA/server/_images` (images)
- **Security Configuration**: To test with auth ENABLED, create `_appdata/mysettings.json`:
  ```json
  {
    "secureEnabled": true,
    "secretCode": "frangoteam751",
    "tokenExpiresIn": "1h"
  }
  ```
  OR modify `_appdata/settings.js` to uncomment `secureEnabled: true`.
- **Default state**: Security is DISABLED by default (`secureEnabled: false` in `settings.default.js`)
- **IMPORTANT**: The vulnerability should be tested with `secureEnabled: true` to demonstrate the auth bypass. With security disabled, the RCE is trivially accessible without any bypass needed.

## Public Exploits

### 1. Working PoC — joshuavanderpoll/CVE-2025-69985 (EIP ID: 121337)
- **URL**: https://github.com/joshuavanderpoll/CVE-2025-69985
- **Classification**: WORKING_POC ✅
- **Reliability**: Reliable
- **Confidence**: 100%
- **Language**: Python 3
- **Attack Type**: RCE
- **Complexity**: Moderate
- **Requires Auth**: No
- **Trojan Check**: CLEAN ✅
- **Usage**: `python3 CVE-2025-69985.py -u http://target:1881 -c "whoami"`
- **Mechanism**: Sends crafted JS payload using `child_process.execSync` to `/api/runscript` with spoofed `Referer: {url}/fuxa` header. Full stdout capture (no reverse shell needed).
- **Dependencies**: `requests`, `urllib3`
- **MITRE ATT&CK**: T1190 (Exploit Public-Facing Application), T1059 (Command and Scripting Interpreter)

### 2. Writeup/Advisory — lihy10 Gist (EIP ID: 121239)
- **URL**: https://gist.github.com/lihy10/8cb2dd65ebf1385f12a7e00e25a50d40
- **Classification**: Writeup
- **Content**: Vulnerability writeup describing the auth bypass as an "incomplete fix for CVE-2023-33831". Contains two PoC scripts:
  - `exploit_rce_calc.py` — RCE demonstration (launches calc.exe on Windows)
  - `exploit_user_overwrite.py` — Admin account takeover by overwriting `users.fuxap.db`

### 3. Vulnerable Code Reference (EIP ID: 121240)
- **URL**: https://github.com/frangoteam/FUXA/blob/master/server/api/jwt-helper.js
- **Classification**: Writeup (source code reference, not an exploit)

## Key Files for Lab/PoC Development
| File | Purpose |
|------|---------|
| `server/api/jwt-helper.js` | Vulnerable `requireAuth` function with Referer bypass |
| `server/api/apikeys/verify-api-or-token.js` | Auth middleware wrapper (calls `verifyToken`) |
| `server/api/scripts/index.js` | `/api/runscript` route handler |
| `server/runtime/scripts/index.js` | Script manager with `isAuthorised` and `runScript` |
| `server/runtime/scripts/msm.js` | Script module with `runTestScript` (code execution engine) |
| `server/api/index.js` | API initialization and middleware wiring |
| `server/main.js` | Application entry point |
| `server/settings.default.js` | Default configuration (secureEnabled: false) |
| `Dockerfile` | Official Docker build file |
| `compose.yml` | Docker Compose configuration |

## References
- **GHSA Advisory**: https://github.com/advisories/GHSA-4r4r-4jp4-wwf9
- **NVD**: https://nvd.nist.gov/vuln/detail/CVE-2025-69985
- **Vulnerability Writeup**: https://gist.github.com/lihy10/8cb2dd65ebf1385f12a7e00e25a50d40
- **Vulnerable Source Code**: https://github.com/frangoteam/FUXA/blob/master/server/api/jwt-helper.js
- **Working Exploit**: https://github.com/joshuavanderpoll/CVE-2025-69985
- **Related CVE**: CVE-2023-33831 (original auth bypass in FUXA, of which this is an incomplete fix)
- **Docker Hub**: https://hub.docker.com/r/frangoteam/fuxa
