#!/usr/bin/env python3
"""
Mock Asana API server for CVE-2025-66524 lab.

Returns minimal valid responses so that NiFi's StandardAsanaClient
can initialize (resolve workspace) and the GetAsanaObject processor
can be scheduled. The actual Asana API is never contacted.
"""

import json
from http.server import HTTPServer, BaseHTTPRequestHandler


class AsanaMockHandler(BaseHTTPRequestHandler):
    """Handle Asana API requests with canned responses."""

    def do_GET(self):
        path = self.path.split("?")[0]  # Strip query params

        if path == "/api/1.0/workspaces":
            self.send_json({
                "data": [
                    {
                        "gid": "1000000000001",
                        "name": "CVEForge",
                        "resource_type": "workspace",
                        "is_organization": False,
                    }
                ],
                "next_page": None,
            })
        elif path.startswith("/api/1.0/users"):
            # Return empty user list â€” processor will just see no new data
            self.send_json({
                "data": [],
                "next_page": None,
            })
        elif path.startswith("/api/1.0/projects"):
            self.send_json({
                "data": [],
                "next_page": None,
            })
        elif path.startswith("/api/1.0/tasks"):
            self.send_json({
                "data": [],
                "next_page": None,
            })
        elif path.startswith("/api/1.0/tags"):
            self.send_json({
                "data": [],
                "next_page": None,
            })
        elif path.startswith("/api/1.0/teams"):
            self.send_json({
                "data": [],
                "next_page": None,
            })
        else:
            # Catch-all: return empty data for any other endpoint
            self.send_json({
                "data": [],
                "next_page": None,
            })

    def send_json(self, data):
        body = json.dumps(data).encode("utf-8")
        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.send_header("Content-Length", str(len(body)))
        self.end_headers()
        self.wfile.write(body)

    def log_message(self, format, *args):
        # Log to stdout for docker logs visibility
        print(f"[MockAsana] {args[0]}")


if __name__ == "__main__":
    server = HTTPServer(("0.0.0.0", 8888), AsanaMockHandler)
    print("[MockAsana] Mock Asana API server listening on port 8888")
    server.serve_forever()
