#!/usr/bin/env python3
# Exploit Title: Apache NiFi < 2.7.0 - CC4 RCE Analysis (Vector 3)
# Exploit Author: Exploit Intelligence Platform (EIP)
# Vendor Homepage: https://nifi.apache.org/
# Version: Apache NiFi 1.20.0 - 2.6.0
# Tested on: Apache NiFi 2.6.0 / JDK 21
# CVE: CVE-2025-66524
# Reference: https://exploit-intel.com
"""
PoC Vector 3 for CVE-2025-66524: CommonsCollections4 RCE Attempt

Documents the attempt to achieve Remote Code Execution using the CommonsCollections4
gadget chain available in the GetAsanaObject processor's NAR classloader.

RESULT: BLOCKED — InvokerTransformer is NOT serializable in CC4 4.5.0.

The commons-collections4 4.5.0 library (bundled in nifi-asana-processors NAR) has
security hardening that removes the Serializable interface from dangerous transformer
classes (InvokerTransformer, InstantiateTransformer, CloneTransformer), completely
preventing the classic CC2/CC4 ysoserial gadget chains from being generated.

This script documents the analysis rather than running a working exploit.

Available gadget chains vs. classpath reality:
  - URLDNS (JDK-only): WORKS — proved deserialization via DNS callback
  - CC2/CC4 (commons-collections4): BLOCKED — InvokerTransformer not serializable
  - JRMPClient (JDK-only): WORKS for network callback, no code execution
  - JDK7u21: PATCHED in JDK 21

RCE implications:
  While the default NiFi 2.6.0 + Asana bundle classpath has hardened CC4, RCE IS
  achievable in real deployments because:
  1. NiFi installations typically have many additional NARs with diverse dependencies
  2. Custom processors may include vulnerable serializable classes
  3. The Groovy NAR (detected in nifi-2.6.0/lib/) includes Groovy runtime, which has
     known gadget chains (if its classloader is accessible)
  4. Any future Serializable class with unsafe readObject() on the NAR classloader
     would provide an RCE path

The URLDNS proof demonstrates that ObjectInputStream.readObject() IS called on
attacker-controlled data, confirming the RCE-capable deserialization primitive exists.
"""

import sys

def main():
    print("=" * 70)
    print("CVE-2025-66524: CommonsCollections4 RCE Analysis")
    print("=" * 70)
    print()
    print("Target: Apache NiFi 2.6.0 GetAsanaObject Processor")
    print("Gadget chain: CommonsCollections4 (CC2/CC4 from ysoserial)")
    print("Library: commons-collections4-4.5.0.jar")
    print()
    print("STATUS: BLOCKED by security hardening in CC4 4.5.0")
    print()
    print("Analysis:")
    print("-" * 40)
    print()
    print("1. The ysoserial CC2 chain requires:")
    print("   PriorityQueue → TransformingComparator → InvokerTransformer")
    print("   → TemplatesImpl.newTransformer() → Runtime.exec()")
    print()
    print("2. In commons-collections4 4.5.0, InvokerTransformer.class")
    print("   NO LONGER implements java.io.Serializable.")
    print()
    print("3. Attempting to serialize InvokerTransformer throws:")
    print("   java.io.NotSerializableException: ")
    print("     org.apache.commons.collections4.functors.InvokerTransformer")
    print()
    print("4. The same hardening applies to:")
    print("   - InstantiateTransformer (not serializable)")
    print("   - CloneTransformer (not serializable)")
    print("   - ChainedTransformer (not serializable)")
    print()
    print("Classpath analysis (GetAsanaObject NAR):")
    print("-" * 40)
    print()
    print("  JARs in nifi-asana-processors NAR:")
    print("    - commons-collections4-4.5.0.jar  (CC chains BLOCKED)")
    print("    - nifi-asana-processors-2.6.0.jar (no gadget classes)")
    print()
    print("  JARs in parent API NAR:")
    print("    - guava-33.5.0-jre.jar  (no known gadget chains)")
    print("    - gson-2.13.2.jar       (no known gadget chains)")
    print("    - asana-1.0.0.jar       (no known gadget chains)")
    print()
    print("  JDK 21 built-in chains:")
    print("    - URLDNS: WORKS (DNS callback only)")
    print("    - JRMPClient: WORKS (TCP callback only)")
    print("    - JDK7u21: PATCHED in JDK 21")
    print()
    print("Conclusion:")
    print("-" * 40)
    print()
    print("  The deserialization vulnerability (CVE-2025-66524) IS CONFIRMED.")
    print("  URLDNS gadget chain proves ObjectInputStream.readObject() executes")
    print("  on attacker-controlled data from the cache server.")
    print()
    print("  Full RCE in this specific lab environment is not achievable due to")
    print("  hardened CC4 4.5.0 and limited NAR classpath. However, the")
    print("  vulnerability IS RCE-capable in deployments with additional NARs")
    print("  that include gadget-chain-compatible libraries.")
    print("=" * 70)


if __name__ == '__main__':
    main()
