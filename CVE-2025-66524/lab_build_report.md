# Lab Build Report: CVE-2025-66524

## CVE Overview

- **CVE ID**: CVE-2025-66524
- **Title**: Apache NiFi GetAsanaObject Processor Remote Code Execution via Unsafe Deserialization
- **Affected Software**: Apache NiFi 1.20.0 through 2.6.0
- **Vulnerability**: `GenericObjectSerDe.deserialize()` uses `ObjectInputStream.readObject()` without filtering
- **CWE**: CWE-502 (Deserialization of Untrusted Data)
- **CVSS**: 8.8 (HIGH)

## Lab Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  Docker Network: lab-net (bridge)                               │
│                                                                 │
│  ┌──────────────────────────┐  ┌─────────────────────────────┐  │
│  │ cve-2025-66524-services  │  │  cve-2025-66524-nifi        │  │
│  │ (python:3.11-slim)       │  │  (apache/nifi:2.6.0)        │  │
│  │                          │  │                             │  │
│  │ Mock Asana API (:8888)   │◄─│  AsanaClientProvider        │  │
│  │  - /api/1.0/workspaces   │  │   (http://services:8888)    │  │
│  │  - /api/1.0/users etc    │  │                             │  │
│  │                          │  │  MapCacheClientService       │  │
│  │ NiFi Cache Server (:4557)│◄─│   (services:4557, 120s)    │  │
│  │  - NiFi cache protocol   │  │                             │  │
│  │  - In-memory key-value   │  │  GetAsanaObject Processor   │  │
│  │  - ATTACK SURFACE        │  │   (30s schedule, RUNNING)   │  │
│  │                          │  │   - calls recoverState()    │  │
│  └──────────────────────────┘  │   - GenericObjectSerDe      │  │
│                                │     .deserialize() → RCE    │  │
│  PoC Agent connects to         └─────────────────────────────┘  │
│  port 4557 to inject                                            │
│  malicious serialized payload                                   │
└─────────────────────────────────────────────────────────────────┘
```

## Containers

### 1. Services Container (`cve-2025-66524-services`)

| Property | Value |
|----------|-------|
| Image | python:3.11-slim (custom build) |
| Container Name | cve-2025-66524-services |
| Services | Mock Asana API (port 8888), NiFi Cache Server (port 4557) |
| Networks | lab-net |
| Health Check | HTTP GET to http://localhost:8888/api/1.0/workspaces |

**Mock Asana API (port 8888)**: Returns minimal valid Asana API responses so NiFi's `StandardAsanaClient` can initialize. Key endpoint: `GET /api/1.0/workspaces` returns workspace "CVEForge" (gid: 1000000000001).

**NiFi Cache Server (port 4557)**: Standalone Python implementation of the NiFi Distributed Map Cache protocol. Supports V1-V3 protocol operations: handshake ("NiFi" magic + version → RESOURCE_OK 0x14), put, get, containsKey, remove, keySet, putIfAbsent, getAndPutIfAbsent, subMap, removeAndGet, close. Stores key-value pairs in memory. **This is the attack surface** — an attacker can PUT arbitrary serialized payloads into the cache at the processor's state key.

### 2. NiFi Container (`cve-2025-66524-nifi`)

| Property | Value |
|----------|-------|
| Image | apache/nifi:2.6.0 (custom build) |
| Container Name | cve-2025-66524-nifi |
| NiFi UI | https://localhost:8443/nifi (inside container) |
| Credentials | admin / adminadminadmin |
| JVM Heap | 1g initial, 2g max |
| Networks | lab-net |

**NiFi Controller Services:**

1. **MapCacheClientService** (type: `org.apache.nifi.distributed.cache.client.MapCacheClientService`)
   - Server Hostname: `cve-2025-66524-services`
   - Server Port: `4557`
   - Communications Timeout: `120 secs` (must be > 30s schedule to avoid Netty idle race)
   - State: ENABLED

2. **StandardAsanaClientProviderService** (type: `org.apache.nifi.controller.asana.StandardAsanaClientProviderService`)
   - API URL: `http://cve-2025-66524-services:8888/api/1.0`
   - Personal Access Token: `mock-pat-12345`
   - Workspace: `CVEForge`
   - State: ENABLED

**NiFi Processor:**

- **GetAsanaObject** (type: `org.apache.nifi.processors.asana.GetAsanaObject`)
  - Asana Client Service → AsanaClientProviderService
  - Distributed Cache Service → MapCacheClientService
  - Object Type: `asana-collect-users`
  - Schedule: 30 seconds (TIMER_DRIVEN)
  - Auto-terminated relationships: new, updated, removed
  - State: RUNNING

## Attack Surface

### Cache Server Protocol (TCP port 4557)

The NiFi Distributed Map Cache protocol on port 4557 is the attack surface:

1. **No authentication** — any client that can reach port 4557 can read/write cache entries
2. **Protocol**: TCP with custom framing:
   - Handshake: `"NiFi"` (4 bytes) + version (4-byte BE int) → Server responds with `0x14` (RESOURCE_OK)
   - Operations: `writeUTF(op)` (2-byte length + UTF-8) + args (4-byte length + bytes)
3. **Attack key**: The processor's state key is its UUID serialized via Java `ObjectOutputStream`:
   ```
   Key (hex): aced000574002461373334663837642d303139632d313030302d353762322d653531316431353665313433
   Decoded: Java serialized String "a734f87d-019c-1000-57b2-e511d156e143"
   ```
4. **Injection**: PUT operation with the above key and a malicious serialized payload as the value
5. **Trigger**: Every 30 seconds, `GetAsanaObject.onTrigger()` → `recoverState()` → `client.get()` → `GenericObjectSerDe.deserialize()` → `ObjectInputStream.readObject()` on the attacker-controlled bytes

### Verified Attack Flow

1. Connect to `cve-2025-66524-services:4557` using NiFi cache protocol
2. Complete handshake (NiFi magic + version 3 → RESOURCE_OK)
3. PUT malicious serialized Java object at the processor's state key
4. Wait up to 30 seconds for processor trigger
5. Processor calls `recoverState()` which reads the key from cache
6. `GenericObjectSerDe.deserialize()` calls `ObjectInputStream.readObject()` on attacker's bytes
7. If a valid gadget chain is in the payload, arbitrary code execution occurs

## Vulnerability Verification

### Cache Injection Test (PASSED)

```
Cache injection (PUT): WORKS
Cache read-back (GET): WORKS
Conclusion: Attacker can inject arbitrary bytes into the cache key
that GetAsanaObject.recoverState() reads.
```

### Java Serialization Confirmation (PASSED)

The cache value for the processor's state key begins with `aced0005` (Java serialization magic), confirming that `GenericObjectSerDe` uses Java Object serialization for both keys and values. The stored value is a `java.util.HashMap` containing `AsanaUserFetcher.lastFingerprints`.

### Processor Running Confirmation (PASSED)

The GetAsanaObject processor is RUNNING and actively reading/writing cache entries every 30 seconds. No error bulletins are present with the 120-second Communications Timeout configuration.

## Docker Artifacts

### Files in `CVE-2025-66524/`

| File | Description |
|------|-------------|
| `docker-compose.yml` | Orchestrates both containers on shared networks |
| `Dockerfile.vulnerable` | NiFi 2.6.0 image with setup script |
| `Dockerfile.cache-server` | Python services image (cache server + mock Asana API) |
| `setup-flow.sh` | NiFi REST API script to configure flow (run inside NiFi container) |
| `nifi_cache_server.py` | Standalone NiFi Distributed Map Cache Server (Python) |
| `mock_asana_api.py` | Mock Asana API server returning valid workspace data |
| `start-services.sh` | Supervisor script starting both Python servers |

### Build and Run Commands

```bash
docker compose build
docker compose up -d
# Wait for NiFi to start (~60 seconds)
docker exec cve-2025-66524-nifi bash /opt/nifi/setup-flow.sh
```

## Component IDs (Current Instance)

| Component | ID |
|-----------|-----|
| Root Process Group | a7344995-019c-1000-0d47-41b323ce2908 |
| MapCacheClientService | a734df87-019c-1000-4a3a-b93a4a9c73bf |
| AsanaClientProviderService | a734ec22-019c-1000-4e88-4dec0a08cd98 |
| GetAsanaObject Processor | a734f87d-019c-1000-57b2-e511d156e143 |

## Key Technical Decisions

### 1. External Python Cache Server (vs. Built-in NiFi MapCacheServer)

Used a standalone Python cache server instead of NiFi's built-in `MapCacheServer` controller service. This provides direct attack surface access and avoids NiFi-internal Netty-to-Netty communication complexity. The Python server implements the exact same NiFi cache protocol (verified by capturing traffic with a TCP proxy).

### 2. Mock Asana API

The `GetAsanaObject` processor's `onScheduled()` method creates a `StandardAsanaClient` which immediately calls `getWorkspaceByName()` — an HTTP request to the Asana API. Without a working API endpoint, the processor fails to start. The mock API returns the minimum required responses (workspace list with one workspace named "CVEForge").

### 3. Communications Timeout = 120 seconds

NiFi's Netty-based `MapCacheClientService` has an `IdleStateHandler` that closes idle channels after the Communications Timeout period. With the default 30-second timeout matching the 30-second processor schedule, a race condition causes consistent "Channel unregistered before processing completed" errors. Setting the timeout to 120 seconds ensures channels survive between processor triggers.

### 4. Object Type = asana-collect-users

Using `asana-collect-users` avoids requiring the "Project Name" property (which would require additional mock API setup). The user fetcher path still exercises the full `recoverState()` → `GenericObjectSerDe.deserialize()` vulnerability path.

## PoC Agent Instructions

The lab is ready for the PoC agent to demonstrate CVE-2025-66524. Key information:

1. **Target**: `cve-2025-66524-services:4557` (NiFi cache protocol, TCP)
2. **Protocol**: See "Attack Surface" section above for wire format
3. **Processor State Key** (hex): `aced000574002461373334663837642d303139632d313030302d353762322d653531316431353665313433`
4. **Deserialization trigger**: Every 30 seconds via `GetAsanaObject.onTrigger()` → `recoverState()`
5. **Gadget chain hunting**: Check NiFi's classpath for `commons-collections4`, `commons-beanutils`, or other gadget libraries. NiFi ships with `commons-collections4` in the Asana bundle.
6. **PoC strategy**: Generate a malicious serialized Java object using a gadget chain (e.g., ysoserial CommonsCollections4), PUT it into the cache, wait for processor trigger, observe command execution.
7. **Verification**: Check NiFi container for evidence of command execution (e.g., file creation, DNS callback).

## Troubleshooting

| Issue | Solution |
|-------|----------|
| NiFi takes long to start | Wait 60-90 seconds after container starts; check with `curl -sk https://localhost:8443/nifi-api/access/config` |
| Cache client "Channel unregistered" | Ensure Communications Timeout > processor schedule (120s > 30s) |
| Asana service fails to enable | Verify mock Asana API is running: `curl http://cve-2025-66524-services:8888/api/1.0/workspaces` |
| Processor shows error bulletins | Check NiFi logs: `docker exec cve-2025-66524-nifi tail -100 /opt/nifi/nifi-current/logs/nifi-app.log` |
| Cache server not responding | Check: `docker exec cve-2025-66524-services python3 -c "import socket; s=socket.socket(); s.connect(('localhost',4557)); print('OK'); s.close()"` |
