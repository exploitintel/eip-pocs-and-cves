#!/bin/bash
#
# CVE-2025-66524 Lab â€” NiFi Flow Setup Script
#
# Configures Apache NiFi 2.6.0 with:
#   1. MapCacheClientService (connects to external Python cache server on port 4557)
#   2. StandardAsanaClientProviderService (points to mock Asana API on port 8888)
#   3. GetAsanaObject processor (vulnerable to deserialization via cache)
#
# Run this INSIDE the NiFi container after NiFi has started:
#   docker exec cve-2025-66524-nifi bash /opt/nifi/setup-flow.sh
#
set -euo pipefail

NIFI_URL="https://localhost:8443"
USERNAME="admin"
PASSWORD="adminadminadmin"

# Convenience wrapper: curl with TLS skip + JSON content type
api() {
    local method="$1"
    local path="$2"
    shift 2
    curl -sk -X "$method" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        "${NIFI_URL}${path}" \
        "$@"
}

##############################################################################
# Step 0: Wait for NiFi to be ready
##############################################################################
echo "[*] Waiting for NiFi to become ready..."
for i in $(seq 1 120); do
    HTTP_CODE=$(curl -sk -o /dev/null -w "%{http_code}" "${NIFI_URL}/nifi-api/access/config" 2>/dev/null || true)
    if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
        echo "[+] NiFi is ready (attempt ${i}, HTTP ${HTTP_CODE})"
        break
    fi
    sleep 5
done

##############################################################################
# Step 1: Authenticate
##############################################################################
echo "[*] Authenticating..."
TOKEN=$(curl -sk -X POST "${NIFI_URL}/nifi-api/access/token" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "username=${USERNAME}&password=${PASSWORD}")

if [ -z "$TOKEN" ]; then
    echo "[-] Failed to get access token"
    exit 1
fi
echo "[+] Got access token"

##############################################################################
# Step 2: Get root process group ID
##############################################################################
ROOT_PG_ID=$(api GET "/nifi-api/flow/process-groups/root" | python3 -c "import sys,json; print(json.load(sys.stdin)['processGroupFlow']['id'])")
echo "[+] Root process group ID: ${ROOT_PG_ID}"

##############################################################################
# Step 3: Create MapCacheClientService
#   Connects to the external Python cache server (cve-2025-66524-services:4557).
#   Communications Timeout must be > processor schedule (30s) to avoid
#   Netty IdleStateHandler race condition.
##############################################################################
echo "[*] Creating MapCacheClientService..."
CACHE_CLIENT_RESP=$(api POST "/nifi-api/process-groups/${ROOT_PG_ID}/controller-services" \
    -d '{
        "revision": {"version": 0},
        "component": {
            "type": "org.apache.nifi.distributed.cache.client.MapCacheClientService",
            "name": "DistributedMapCacheClient",
            "properties": {
                "Server Hostname": "cve-2025-66524-services",
                "Server Port": "4557",
                "Communications Timeout": "120 secs"
            }
        }
    }')

CACHE_CLIENT_ID=$(echo "$CACHE_CLIENT_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
CACHE_CLIENT_VER=$(echo "$CACHE_CLIENT_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['revision']['version'])")
echo "[+] MapCacheClientService ID: ${CACHE_CLIENT_ID}"

# Enable the cache client
echo "[*] Enabling MapCacheClientService..."
api PUT "/nifi-api/controller-services/${CACHE_CLIENT_ID}/run-status" \
    -d "{\"revision\": {\"version\": ${CACHE_CLIENT_VER}}, \"state\": \"ENABLED\"}" > /dev/null

for i in $(seq 1 20); do
    STATE=$(api GET "/nifi-api/controller-services/${CACHE_CLIENT_ID}" | python3 -c "import sys,json; print(json.load(sys.stdin)['component']['state'])")
    if [ "$STATE" = "ENABLED" ]; then
        echo "[+] MapCacheClientService is ENABLED"
        break
    fi
    sleep 2
done

##############################################################################
# Step 4: Create StandardAsanaClientProviderService (mock API)
##############################################################################
echo "[*] Creating AsanaClientProviderService..."
ASANA_RESP=$(api POST "/nifi-api/process-groups/${ROOT_PG_ID}/controller-services" \
    -d '{
        "revision": {"version": 0},
        "component": {
            "type": "org.apache.nifi.controller.asana.StandardAsanaClientProviderService",
            "name": "AsanaClientProviderService",
            "properties": {
                "API URL": "http://cve-2025-66524-services:8888/api/1.0",
                "Personal Access Token": "mock-pat-12345",
                "Workspace": "CVEForge"
            }
        }
    }')

ASANA_ID=$(echo "$ASANA_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
ASANA_VER=$(echo "$ASANA_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['revision']['version'])")
echo "[+] AsanaClientProviderService ID: ${ASANA_ID}"

# Enable Asana service
echo "[*] Enabling AsanaClientProviderService..."
api PUT "/nifi-api/controller-services/${ASANA_ID}/run-status" \
    -d "{\"revision\": {\"version\": ${ASANA_VER}}, \"state\": \"ENABLED\"}" > /dev/null

for i in $(seq 1 20); do
    STATE=$(api GET "/nifi-api/controller-services/${ASANA_ID}" | python3 -c "import sys,json; print(json.load(sys.stdin)['component']['state'])")
    if [ "$STATE" = "ENABLED" ]; then
        echo "[+] AsanaClientProviderService is ENABLED"
        break
    fi
    sleep 2
done

##############################################################################
# Step 5: Create GetAsanaObject processor
##############################################################################
echo "[*] Creating GetAsanaObject processor..."
PROC_RESP=$(api POST "/nifi-api/process-groups/${ROOT_PG_ID}/processors" \
    -d "{
        \"revision\": {\"version\": 0},
        \"component\": {
            \"type\": \"org.apache.nifi.processors.asana.GetAsanaObject\",
            \"name\": \"GetAsanaObject-Vulnerable\",
            \"config\": {
                \"properties\": {
                    \"Asana Client Service\": \"${ASANA_ID}\",
                    \"Distributed Cache Service\": \"${CACHE_CLIENT_ID}\",
                    \"Object Type\": \"asana-collect-users\"
                },
                \"autoTerminatedRelationships\": [\"new\", \"updated\", \"removed\"],
                \"schedulingPeriod\": \"30 sec\",
                \"schedulingStrategy\": \"TIMER_DRIVEN\"
            },
            \"position\": {\"x\": 400.0, \"y\": 200.0}
        }
    }")

PROC_ID=$(echo "$PROC_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
PROC_VER=$(echo "$PROC_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['revision']['version'])")
echo "[+] GetAsanaObject processor ID: ${PROC_ID}"

##############################################################################
# Step 6: Start the processor
##############################################################################
echo "[*] Starting GetAsanaObject processor..."
api PUT "/nifi-api/processors/${PROC_ID}/run-status" \
    -d "{\"revision\": {\"version\": ${PROC_VER}}, \"state\": \"RUNNING\"}" > /dev/null
echo "[+] GetAsanaObject processor started"

# Wait and check status
sleep 5
PROC_STATE=$(api GET "/nifi-api/processors/${PROC_ID}" | python3 -c "import sys,json; print(json.load(sys.stdin)['component']['state'])")
echo "[+] Processor state: ${PROC_STATE}"

##############################################################################
# Summary
##############################################################################
echo ""
echo "============================================"
echo " CVE-2025-66524 Lab Setup Complete"
echo "============================================"
echo " NiFi UI:          https://localhost:8443/nifi"
echo " Username:         admin"
echo " Password:         adminadminadmin"
echo ""
echo " Cache Server:     cve-2025-66524-services:4557 (TCP)"
echo " Processor ID:     ${PROC_ID}"
echo " Cache Client ID:  ${CACHE_CLIENT_ID}"
echo " Asana Service ID: ${ASANA_ID}"
echo ""
echo " Attack surface:   TCP port 4557 on the services container"
echo " The GetAsanaObject processor reads from cache"
echo " every 30 seconds, triggering deserialization"
echo " via GenericObjectSerDe.deserialize()"
echo "============================================"
