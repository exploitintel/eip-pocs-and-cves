# CVE-2025-66524 Patched Lab Environment
# Apache NiFi 2.7.0 (patched) â€” for bypass testing
#
# Usage:
#   docker compose -f docker-compose.patched.yml up -d
#   docker exec cve-2025-66524-nifi-patched bash /opt/nifi/setup-flow-patched.sh
#   docker compose -f docker-compose.patched.yml down

services:
  nifi-patched:
    build:
      context: .
      dockerfile: Dockerfile.patched
    container_name: cve-2025-66524-nifi-patched
    ports:
      - "8443:8443"
    environment:
      SINGLE_USER_CREDENTIALS_USERNAME: admin
      SINGLE_USER_CREDENTIALS_PASSWORD: adminadminadmin
      NIFI_WEB_HTTPS_HOST: "0.0.0.0"
      NIFI_JVM_HEAP_INIT: "1g"
      NIFI_JVM_HEAP_MAX: "2g"
    depends_on:
      services:
        condition: service_healthy
    networks:
      - lab-net

  services:
    build:
      context: .
      dockerfile: Dockerfile.cache-server
    container_name: cve-2025-66524-services-patched
    ports:
      - "4557:4557"
      - "8888:8888"
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8888/api/1.0/workspaces')"]
      interval: 3s
      timeout: 3s
      retries: 5
    networks:
      - lab-net

networks:
  lab-net:
    driver: bridge
