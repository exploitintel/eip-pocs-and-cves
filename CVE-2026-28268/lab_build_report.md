# Lab Build Report: CVE-2026-28268

## Vikunja < 2.1.0 — Auth Bypass via Password Reset Token Reuse

---

## Lab Architecture

**Topology: Single Container**

Vikunja uses SQLite as its default embedded database — no external database, cache, or queue services are required. The entire application runs as a single Go binary with an embedded SQLite driver (CGO). This makes it ideal for a single-container lab.

```
┌──────────────────────────────────────────────┐
│  cve-2026-28268-vulnerable                   │
│  ┌─────────────────────────────────────────┐ │
│  │  Vikunja v2.0.0 (Go binary)            │ │
│  │  - Echo v5 HTTP API on :3456           │ │
│  │  - SQLite database at /data/vikunja.db │ │
│  │  - File storage at /app/vikunja/files  │ │
│  │  - No mailer (tokens in DB only)       │ │
│  └─────────────────────────────────────────┘ │
│  Port: 3456 (HTTP API)                       │
│  Networks: lab-net                             │
└──────────────────────────────────────────────┘
```

---

## Container Details

### Vulnerable Container

| Field | Value |
|---|---|
| **Container Name** | `cve-2026-28268-vulnerable` |
| **Image** | `cve-2026-28268-vulnerable:latest` (built from source) |
| **Base Image (build)** | `golang:1.25-bookworm` |
| **Base Image (runtime)** | `debian:bookworm-slim` |
| **Source Version** | `v2.0.0` (tag) |
| **Port** | `3456` (HTTP API) |
| **Database** | SQLite at `/data/vikunja.db` (volume-mounted) |
| **Networks** | `lab-net` |
| **Health Check** | `curl -sf http://localhost:3456/api/v1/info` (5s interval, 10 retries) |
| **User** | `1000` (non-root) |

### Environment Variables

| Variable | Value | Purpose |
|---|---|---|
| `VIKUNJA_DATABASE_TYPE` | `sqlite` | Use embedded SQLite |
| `VIKUNJA_DATABASE_PATH` | `/data/vikunja.db` | Database file location |
| `VIKUNJA_SERVICE_INTERFACE` | `:3456` | Listen on all interfaces, port 3456 |
| `VIKUNJA_MAILER_ENABLED` | `false` | Disable email — tokens only in DB |
| `VIKUNJA_SERVICE_ENABLEREGISTRATION` | `true` | Allow user registration |
| `VIKUNJA_AUTH_LOCAL_ENABLED` | `true` | Enable local auth (username/password) |
| `VIKUNJA_SERVICE_JWTSECRET` | `lab-jwt-secret-2026` | JWT signing secret |
| `VIKUNJA_LOG_LEVEL` | `DEBUG` | Verbose logging for debugging |
| `VIKUNJA_SERVICE_ROOTPATH` | `/app/vikunja/` | Application root path |
| `VIKUNJA_RATELIMIT_ENABLED` | `false` | No rate limiting for testing |
| `VIKUNJA_CORS_ENABLE` | `false` | Disable CORS (avoids publicurl requirement) |
| `VIKUNJA_SERVICE_PUBLICURL` | `http://localhost:3456` | Public URL for link generation |

### Volumes

| Volume | Mount Point | Purpose |
|---|---|------|
| `vikunja-data` | `/data` | Persistent SQLite database storage |

### Networks

| Network | Type | Purpose |
|---|---|---|
| `lab-net` | Bridge (internal) | Internal lab communication |

---

## Build Status

### Build: ✅ SUCCESS

**Build process:**
1. Stage 1 (`golang:1.25-bookworm`): Installed `libsqlite3-dev`, copied source at `v2.0.0`, created dummy `frontend/dist/index.html` to satisfy `go:embed` directive, compiled with `CGO_ENABLED=1 go build -o vikunja .`
2. Stage 2 (`debian:bookworm-slim`): Installed `sqlite3`, `ca-certificates`, `curl`, copied binary, configured environment

**Workarounds applied:**
1. **Frontend embed**: Created `frontend/dist/index.html` placeholder — the Go build requires `frontend/dist` directory to exist for `//go:embed dist` in `frontend/embed.go`. No actual frontend needed for API-only PoC.
2. **Cache directory**: Created `/.cache` with user 1000 ownership — Go module cache writes fail without it.
3. **File storage**: Set `chown -R 1000:1000 /app/vikunja` — Vikunja creates a `files/` subdirectory at startup for file attachments.
4. **CORS disabled**: Set `VIKUNJA_CORS_ENABLE=false` — CORS requires `service.publicurl` to be configured; simpler to disable for lab.

### Runtime: ✅ SUCCESS

Container starts cleanly, runs SQLite migrations on first boot, and begins accepting API requests on port 3456.

---

## Start/Stop Commands

### Start Lab
```bash
docker composeup -d
```

### Stop Lab
```bash
docker composedown
```

### Stop Lab and Reset Database
```bash
docker composedown -v
```

### Rebuild After Changes
```bash
docker composebuild --no-cache
docker composeup -d
```

### View Logs
```bash
docker composelogs -f vulnerable
```

---

## Verification

### API Info Endpoint
```bash
curl -s http://localhost:3456/api/v1/info | jq .
```
**Result:** ✅ Returns JSON with `version: "dev"`, `auth.local.enabled: true`, `auth.local.registration_enabled: true`

### User Registration
```bash
curl -s -X POST http://localhost:3456/api/v1/register \
  -H "Content-Type: application/json" \
  -d '{"username": "labtest", "email": "labtest@example.com", "password": "testpass123"}'
```
**Result:** ✅ Returns user object with `id: 1`

### Login
```bash
curl -s -X POST http://localhost:3456/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{"username": "labtest", "password": "testpass123"}'
```
**Result:** ✅ Returns JWT token

### Password Reset Token Request
```bash
curl -s -X POST http://localhost:3456/api/v1/user/password/token \
  -H "Content-Type: application/json" \
  -d '{"email": "labtest@example.com"}'
```
**Result:** ✅ Returns `{"message": "Token was sent."}`

### Token Extraction from SQLite
```bash
docker exec cve-2026-28268-vulnerable sqlite3 /data/vikunja.db \
  "SELECT id, user_id, token, kind, created FROM user_tokens WHERE kind=1;"
```
**Result:** ✅ Returns the 64-character plaintext reset token (kind=1)

### Vulnerability Confirmation: Token Reuse
1. **First reset** with token → `{"message": "The password was updated successfully."}` ✅
2. **Token still in DB** after first reset (Bug 1 confirmed) → `SELECT` returns the same token ✅
3. **Second reset** with same token → `{"message": "The password was updated successfully."}` ✅ **(BUG!)**
4. **Login with second password** → Returns JWT token ✅
5. **Login with original password** → `{"code": 1011, "message": "Wrong username or password."}` ✅

**CVE-2026-28268 is fully reproducible in this lab.**

---

## Lab Files

| File | Purpose |
|---|---|
| `Dockerfile.vulnerable` | Multi-stage Docker build for Vikunja v2.0.0 |
| `docker-compose.yml` | Container orchestration |
| `environment` | Environment variable configuration (optional) |

---

## Accessing the Lab from PoC Scripts

The vulnerable container is accessible via localhost on port 3456:

```bash
API_URL="http://localhost:3456"
```

### Key API Endpoints for PoC

| Endpoint | Method | Auth Required | Purpose |
|---|---|---|---|
| `/api/v1/info` | GET | No | Health check / version info |
| `/api/v1/register` | POST | No | Create new user account |
| `/api/v1/login` | POST | No | Authenticate and get JWT |
| `/api/v1/user/password/token` | POST | No | Request password reset token |
| `/api/v1/user/password/reset` | POST | No | Reset password with token **(VULNERABLE)** |

### Token Extraction

Since the mailer is disabled, reset tokens cannot be obtained via email. Extract directly from SQLite:

```bash
docker exec cve-2026-28268-vulnerable sqlite3 /data/vikunja.db \
  "SELECT token FROM user_tokens WHERE kind=1 ORDER BY id DESC LIMIT 1;"
```

### Database Reset Between Tests

To start fresh (remove all users, tokens, data):
```bash
docker composedown -v
docker composeup -d
```

---

## Known Issues

1. **Frontend not included**: The binary is built API-only with a placeholder `frontend/dist/index.html`. Browsing to the root URL will show "API Only" instead of the Vue.js frontend. This does not affect the API endpoints needed for the PoC.
2. **Version shows "dev"**: Since we build directly with `go build` instead of `mage release`, the version string is "dev" rather than "v2.0.0". The actual source code is from the v2.0.0 tag and contains the vulnerable code paths.
3. **Mailer disabled**: Password reset tokens are NOT sent via email. They must be read directly from the SQLite database using `sqlite3`. This is by design for the lab — it allows the PoC to be self-contained without requiring email infrastructure.
