# CVE-2026-28268 Lab: Vikunja v2.0.0 (Vulnerable)
# Auth bypass via password reset token reuse

# =============================================================================
# Stage 1: Build the Vikunja API binary from source at v2.0.0
# =============================================================================
FROM golang:1.25-bookworm AS builder

# Install build dependencies (CGO required for SQLite driver)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc6-dev \
    libsqlite3-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Clone Vikunja source and checkout v2.0.0
RUN git clone https://github.com/go-vikunja/vikunja.git . && \
    git checkout v2.0.0

# Create a dummy frontend/dist directory to satisfy go:embed directive
# (We don't need the actual frontend for the API-only PoC)
RUN mkdir -p frontend/dist && \
    echo '<!DOCTYPE html><html><body>API Only</body></html>' > frontend/dist/index.html

# Build API-only binary (no frontend needed for PoC)
# CGO_ENABLED=1 is required for the SQLite driver (github.com/mattn/go-sqlite3)
RUN CGO_ENABLED=1 GOOS=linux go build -o vikunja .

# =============================================================================
# Stage 2: Minimal runtime image
# =============================================================================
FROM debian:bookworm-slim

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    sqlite3 \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create app directory, data directory, cache directory, and files directory
# User 1000 needs write access to /data (SQLite DB), /.cache, and /app/vikunja/files
RUN mkdir -p /app/vikunja/files /data /.cache && \
    chown -R 1000:1000 /data /.cache /app/vikunja

# Copy the built binary
COPY --from=builder /build/vikunja /app/vikunja/vikunja
RUN chmod +x /app/vikunja/vikunja

WORKDIR /app/vikunja

# Environment configuration for lab
ENV VIKUNJA_DATABASE_TYPE=sqlite
ENV VIKUNJA_DATABASE_PATH=/data/vikunja.db
ENV VIKUNJA_SERVICE_INTERFACE=:3456
ENV VIKUNJA_MAILER_ENABLED=false
ENV VIKUNJA_SERVICE_ENABLEREGISTRATION=true
ENV VIKUNJA_AUTH_LOCAL_ENABLED=true
ENV VIKUNJA_SERVICE_JWTSECRET=lab-jwt-secret-2026
ENV VIKUNJA_LOG_LEVEL=DEBUG
ENV VIKUNJA_SERVICE_ROOTPATH=/app/vikunja/
ENV VIKUNJA_RATELIMIT_ENABLED=false
ENV VIKUNJA_CORS_ENABLE=false
ENV VIKUNJA_SERVICE_PUBLICURL=http://localhost:3456

EXPOSE 3456

# Health check: verify API is responding
HEALTHCHECK --interval=5s --timeout=3s --retries=10 \
    CMD curl -sf http://localhost:3456/api/v1/info || exit 1

# Run as non-root (matching upstream)
USER 1000

ENTRYPOINT ["/app/vikunja/vikunja"]
