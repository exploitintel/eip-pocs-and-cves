# Intel Brief: CVE-2026-28268

## CVE Summary

| Field | Value |
|---|---|
| **CVE ID** | CVE-2026-28268 |
| **Title** | Vikunja <2.1.0 — Auth Bypass via Password Reset Token Reuse |
| **CVSS Score** | 9.8 (Critical) |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| **EPSS** | 0.0% (9.6th percentile) |
| **CWE** | CWE-640 (Weak Password Recovery Mechanism), CWE-459 (Incomplete Cleanup) |
| **Published** | 2026-02-27 |
| **Attack Vector** | Network |
| **Attack Complexity** | Low |
| **Privileges Required** | None |
| **User Interaction** | None |

## Affected Software

| Field | Value |
|---|---|
| **Software** | Vikunja |
| **Vendor** | go-vikunja (Vikunja Project) |
| **Module** | code.vikunja.io/api |
| **Language** | Go |
| **Affected Versions** | All versions prior to 2.1.0 |
| **Vulnerable Version** | v2.0.0 (latest release before fix) |
| **Patched Version** | v2.1.0 |

## Vulnerability Description

A critical business logic vulnerability exists in the password reset mechanism of Vikunja's API that allows password reset tokens to be reused indefinitely, enabling persistent account takeover. The vulnerability has **two root causes**:

### Bug 1: Wrong Token Type Deleted After Password Reset (Primary)

In `pkg/user/user_password_reset.go`, the `ResetPassword()` function successfully resets the user's password but then deletes the **wrong token type**. On line 68, it calls:

```go
err = removeTokens(s, user, TokenEmailConfirm)  // BUG: deletes email confirm tokens instead
```

Instead of the correct:
```go
err = removeTokens(s, user, TokenPasswordReset)  // FIX: should delete password reset tokens
```

This means after a password reset, the `TokenPasswordReset` token remains in the `user_tokens` database table and can be reused indefinitely to reset the user's password again.

### Bug 2: Inverted Cron Job Cleanup Logic (Secondary)

In `pkg/user/token.go`, the `RegisterTokenCleanupCron()` function uses an inverted comparison operator. On line 134:

```go
Where("created > ? AND (kind = ? OR kind = ?)", time.Now().Add(time.Hour*24*-1), TokenPasswordReset, TokenAccountDeletion)
```

The `>` operator should be `<`. As written:
- `created > (now - 24h)` selects tokens **newer** than 24 hours — i.e., it deletes VALID recent tokens
- The intended logic `created < (now - 24h)` would select tokens **older** than 24 hours

This means old tokens are **never** cleaned up by the cron job, while newly-issued valid tokens get deleted.

### Combined Impact

Together, these bugs mean:
1. An attacker who intercepts/obtains a password reset token can reuse it **forever**
2. Even if the victim changes their password, the attacker can reset it again using the old token
3. The cron job that should expire old tokens actually preserves them while deleting valid new ones
4. The attack window is **infinite** — tokens never expire

### Token System Context

The token kinds are defined as:
- `TokenPasswordReset = 1` (iota + 1)
- `TokenEmailConfirm = 2`
- `TokenAccountDeletion = 3`
- `TokenCaldavAuth = 4`

Tokens are stored in the `user_tokens` table with columns: `id`, `user_id`, `token`, `kind`, `created`.

## Repository Information

| Field | Value |
|---|---|
| **Repository URL** | https://github.com/go-vikunja/vikunja.git |
| **Vulnerable Version Tag** | `v2.0.0` (checked out in workspace) |
| **Patched Version Tag** | `v2.1.0` |

## Fix Commits

### Fix Commit 1 (Primary): Token Deletion Bug
- **Hash**: `5c2195f9fca9ad208477e865e6009c37889f87b2`
- **Author**: kolaente <k@knt.li>
- **Date**: Fri Feb 27 14:10:34 2026 +0100
- **Message**: `fix(auth): remove password reset token after use`
- **Files Changed**:
  - `pkg/user/user_password_reset.go` — Changed `TokenEmailConfirm` → `TokenPasswordReset` in `removeTokens()` call
  - `pkg/user/user_test.go` — Added test "removes password reset token after use"

### Fix Commit 2 (Secondary): Cron Job Cleanup Bug
- **Hash**: `412215ee2f1e59878e5f54343edd20d3fc7356ba`
- **Author**: kolaente <k@knt.li>
- **Date**: Fri Feb 27 14:12:51 2026 +0100
- **Message**: `fix(auth): correctly delete older password reset tokens in cron`
- **Files Changed**:
  - `pkg/user/token.go` — Extracted `CleanupOldTokens()` function, fixed `>` to `<` in WHERE clause
  - `pkg/user/user_test.go` — Added `TestCleanupOldTokens` tests

## Build System

| Field | Value |
|---|---|
| **Language** | Go (1.25.0, toolchain go1.25.6) |
| **Build Tool** | Mage (Go-based build system, see `magefile.go`) |
| **Module Path** | `code.vikunja.io/api` |
| **Default Database** | SQLite (via `github.com/mattn/go-sqlite3`) |
| **Supported Databases** | SQLite, MySQL (`github.com/go-sql-driver/mysql`), PostgreSQL (`github.com/lib/pq`) |
| **ORM** | xorm (`xorm.io/xorm v1.3.11`) |
| **Web Framework** | Echo v5 (`github.com/labstack/echo/v5`) |
| **Default Port** | 3456 |
| **Frontend** | Vue.js (built separately with pnpm, embedded in binary) |

### Key Dependencies for Building
- Go 1.25+ toolchain
- `mage` build tool (`go install github.com/magefile/mage@latest`)
- `gcc` / C compiler (for CGO — required by sqlite3 driver)
- Node.js + pnpm (for frontend build, can be skipped for API-only testing)

### Simplified Build (API only, for lab)
For PoC purposes, the API can be built without the frontend:
```bash
CGO_ENABLED=1 go build -o vikunja .
```
Or using mage:
```bash
mage build
```

### Configuration for Lab
Vikunja uses environment variables or a `config.yml` file. Key settings:
- `VIKUNJA_DATABASE_TYPE=sqlite` (default)
- `VIKUNJA_DATABASE_PATH=/path/to/vikunja.db`
- `VIKUNJA_SERVICE_INTERFACE=:3456`
- `VIKUNJA_MAILER_ENABLED=false` (disable for PoC — tokens logged instead)
- `VIKUNJA_SERVICE_ENABLEREGISTRATION=true`
- `VIKUNJA_AUTH_LOCAL_ENABLED=true`
- `VIKUNJA_SERVICE_TESTINGTOKEN=testtoken123` (enables test endpoint for fixture loading)

## API Endpoints (Attack Surface)

### Password Reset Token Request
```
POST /api/v1/user/password/token
Content-Type: application/json

{"email": "victim@example.com"}
```
Response: `{"message": "Token was sent."}` (token sent via email or logged)

### Password Reset (Vulnerable Endpoint)
```
POST /api/v1/user/password/reset
Content-Type: application/json

{"token": "<reset_token>", "new_password": "attacker_password"}
```
Response: `{"message": "The password was updated successfully."}`

**Vulnerability**: After successful reset, the token remains valid and can be reused to reset the password again.

### User Registration
```
POST /api/v1/register
Content-Type: application/json

{"username": "testuser", "email": "test@example.com", "password": "12345678"}
```

### Login
```
POST /api/v1/login
Content-Type: application/json

{"username": "testuser", "password": "12345678"}
```

## PoC Strategy

### Attack Flow
1. Register a victim user account (or target existing user)
2. Request a password reset token for the victim's email
3. Obtain the token (from email/logs/database)
4. Use the token to reset the password → succeeds
5. Use the **same token** again to reset the password → succeeds again (BUG!)
6. Demonstrate infinite reuse — the token is never invalidated

### Lab Approach
For a self-contained PoC:
1. Build Vikunja v2.0.0 from source with SQLite backend
2. Configure with mailer disabled (so tokens are accessible from database)
3. Register a user via API
4. Request password reset token
5. Read token directly from SQLite database
6. Reset password using token (first use)
7. Reset password using same token (second use — demonstrates the bug)
8. Optionally verify cron job bug by checking old tokens survive cleanup

### Test Fixture Reference
The test fixtures show a token that can be used for reference:
- Token: `passwordresettesttoken`
- Kind: `1` (TokenPasswordReset)
- User ID: `3`
- Created: `2021-07-12` (old — should be cleaned up by cron but isn't due to bug 2)

## Public Exploits

### EIP Exploit #123244 (Writeup)
- **Classification**: writeup (commit diff, not a standalone PoC script)
- **Attack Type**: auth_bypass
- **Complexity**: trivial
- **Reliability**: reliable
- **Requires Auth**: No
- **Safety**: SAFE — this is the patch commit itself, not malicious code
- **URL**: https://github.com/go-vikunja/vikunja/commit/5c2195f9fca9ad208477e865e6009c37889f87b2

No standalone PoC exploit scripts exist in public. A PoC must be written from scratch based on the API endpoints.

## References

| Type | URL |
|---|---|
| **Patch (Primary Fix)** | https://github.com/go-vikunja/vikunja/commit/5c2195f9fca9ad208477e865e6009c37889f87b2 |
| **Patch (Cron Fix)** | https://github.com/go-vikunja/vikunja/commit/412215ee2f1e59878e5f54343edd20d3fc7356ba |
| **GHSA Advisory** | https://github.com/go-vikunja/vikunja/security/advisories/GHSA-rfjg-6m84-crj2 |
| **Changelog** | https://vikunja.io/changelog/vikunja-v2.1.0-was-released |
| **Source Repository** | https://github.com/go-vikunja/vikunja |

## Key Source Files (Vulnerable)

| File | Role |
|---|---|
| `pkg/user/user_password_reset.go` | `ResetPassword()` — wrong token type in `removeTokens()` call (line 68) |
| `pkg/user/token.go` | `RegisterTokenCleanupCron()` — inverted `>` comparison (line 134) |
| `pkg/user/token.go` | Token types (lines 32-39), `removeTokens()` (lines 113-117) |
| `pkg/routes/api/v1/user_password_reset.go` | HTTP handlers for `/user/password/token` and `/user/password/reset` |
| `pkg/routes/routes.go` | Route registration (lines 322-324) |
| `pkg/db/fixtures/user_tokens.yml` | Test fixture with `passwordresettesttoken` token |
| `pkg/db/fixtures/users.yml` | Test user fixtures (password: `12345678`) |
