# CVE-2026-28370 - OpenStack Vitrage eval() Injection to RCE

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2026-28370 |
| Component | [OpenStack Vitrage](https://github.com/openstack/vitrage) |
| Type | CWE-95: Eval Injection |
| CVSS | 9.1 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H` |
| EPSS | 0.1% (24.6th percentile) |
| Affected | All versions before 12.0.1, 13.0.0, 14.0.0, 15.0.0 |
| Fix | `eval()` removed; replaced with closure-based `operator` module functions |
| Author | Exploit Intelligence Platform |
| Date | 2026-02-27 |

## Vulnerability Details

CVE-2026-28370 is a critical arbitrary code execution vulnerability in OpenStack Vitrage's graph query parser. The `create_predicate()` function in `vitrage/graph/query.py` constructs a Python lambda expression string from user-supplied query dictionaries and passes it to Python's built-in `eval()`. The `_evaluable_str()` helper wraps string values in single quotes **without escaping embedded quotes**, allowing an authenticated attacker to inject arbitrary Python code through crafted query parameters sent to the Vitrage REST API.

Both dictionary **keys** and **values** are vulnerable injection points. Compound queries using `and`/`or` logical operators are also exploitable.

### Attack Chain

```
1. Attacker authenticates to Vitrage API (Keystone token or noauth mode)
2. Sends query with single-quote breakout: {"==": {"x": "' + INJECTED_CODE + '"}}
3. create_predicate() builds expression string and calls eval()
4. _evaluable_str() wraps value without escaping -> attacker breaks out of string
5. eval() executes the injected Python code as the Vitrage service user
6. Lambda is invoked on graph vertices, triggering side effects (file write, RCE)
```

### Fix

The fix (commit `5b57e2b3`) **completely eliminates** `eval()` and all string expression building. User values are captured as closure variables in lambda functions and compared using the `operator` module — never interpolated into code strings.

```diff
-from vitrage.common.exception import VitrageError
+import operator
+from vitrage.common.exception import VitrageError
+
+ops = {
+    '<': operator.lt, '<=': operator.le, '==': operator.eq,
+    '!=': operator.ne, '>=': operator.ge, '>': operator.gt,
+}

 def create_predicate(query_dict):
     try:
-        expression = _create_query_expression(query=query_dict)
-        expression = 'lambda item: ' + expression
-        return eval(expression)
+        return _create_query_function(query=query_dict)
     except Exception as e:
```

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│  Host                                                            │
│                                                                  │
│  ┌─────────────────────────────┐  ┌────────────────────────────┐ │
│  │ cve-2026-28370-vulnerable   │  │ cve-2026-28370-patched     │ │
│  │ Vitrage 12.0.0              │  │ Vitrage 12.0.1             │ │
│  │ python:3.10-slim-bookworm   │  │ python:3.10-slim-bookworm  │ │
│  │                             │  │                            │ │
│  │ eval() present in query.py  │  │ eval() removed             │ │
│  │ PoCs mounted at /poc/       │  │ Bypass PoC at /poc/        │ │
│  └─────────────────────────────┘  └────────────────────────────┘ │
│                                                                  │
│  PoC scripts run inside containers via docker exec               │
└──────────────────────────────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2026-28370

# Build and start
docker compose build
docker compose up -d

# Run the exploit
docker exec cve-2026-28370-vulnerable python3 /poc/poc.py

# Run all vectors
docker exec cve-2026-28370-vulnerable python3 /poc/poc.py
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector2_key_injection.py
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector3_logical_operator.py

# Run bypass test against patched version
docker exec cve-2026-28370-patched python3 /poc/bypass_poc.py

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Description |
|---|---|---|---|
| `cve-2026-28370-vulnerable` | Vulnerable target | `python:3.10-slim-bookworm` + Vitrage 12.0.0 | eval() injection in query.py |
| `cve-2026-28370-patched` | Patched target | `python:3.10-slim-bookworm` + Vitrage 12.0.1 | eval() removed, closures used |

## PoC Usage

Three PoC scripts demonstrate independent attack vectors. All scripts run **inside** the container via `docker exec` — Vitrage is imported directly and the vulnerable `create_predicate()` function is called with crafted query dicts.

### PoC 1: Value Injection (`poc/poc.py`)

The primary PoC demonstrates eval() injection through query dict **values**. Runs 4 tests: vulnerability existence check, arbitrary file write, OS command execution, and data exfiltration.

```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc.py
```

### PoC 2: Key Injection (`poc/poc_vector2_key_injection.py`)

Demonstrates that the injection also works through the dictionary **key** — a second independent injection point.

```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector2_key_injection.py
```

### PoC 3: Compound Logical Queries (`poc/poc_vector3_logical_operator.py`)

Demonstrates injection inside `and`, `or`, and nested compound queries — the typical real-world query format.

```bash
docker exec cve-2026-28370-vulnerable python3 /poc/poc_vector3_logical_operator.py
```

### Expected Output (Vulnerable)

```
╔══════════════════════════════════════════════════════════════════════╗
║   CVE-2026-28370: OpenStack Vitrage eval() Injection PoC           ║
║   Affected: Vitrage < 12.0.1, 13.0.0, 14.0.0, 15.0.0             ║
║   CVSS: 9.1 (Critical) | CWE-95 (Eval Injection)                  ║
╚══════════════════════════════════════════════════════════════════════╝

  [PASS] vulnerability_exists
  [PASS] value_injection
  [PASS] command_execution
  [PASS] data_exfiltration

[+] ALL 4/4 TESTS PASSED
[+] CVE-2026-28370 is CONFIRMED EXPLOITABLE
```

## Bypass Findings

The fix (commit `5b57e2b3`) was tested with **35 payloads across 7 bypass hypotheses**. **No bypass was found** — the fix is complete.

The fix eliminates the entire attack class by removing `eval()` and all string expression construction. User values are captured as closure variables in lambda functions, never interpolated into code strings. This makes bypass fundamentally impossible regardless of input content.

See [bypass_analysis.md](bypass_analysis.md) for the full analysis.

| Hypothesis | Payloads | Result |
|---|---|---|
| Original eval injection | 4 | Fix holds |
| Type confusion | 5 | Fix holds |
| Operator key injection | 6 | Fix holds |
| Dunder/special method abuse | 5 | Fix holds |
| Unicode/encoding bypass | 6 | Fix holds |
| Logical operator manipulation | 5 | Fix holds |
| Operator module side effects | 4 | Fix holds |

## Verification: Vulnerable vs Patched

| Test | Vulnerable (12.0.0) | Patched (12.0.1) |
|---|---|---|
| **eval() in source** | Present | Removed |
| **Value injection** | Code executes, marker file written | Payload treated as literal string |
| **Key injection** | Code executes, marker file written | Payload treated as literal string |
| **Compound query injection** | Code executes via and/or | Payload treated as literal string |
| **OS command execution** | `id` returns `uid=0(root)` | No code execution |

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC: value injection with 4 tests (vuln check, file write, cmd exec, data exfil) |
| `poc/poc_vector2_key_injection.py` | Vector 2: dictionary key injection |
| `poc/poc_vector3_logical_operator.py` | Vector 3: compound query injection (and/or/nested) |
| `poc/bypass_poc.py` | Bypass attempt: 7 hypotheses, 35 payloads against patched version |
| `Dockerfile.vulnerable` | Builds Vitrage 12.0.0 from source (vulnerable) |
| `Dockerfile.patched` | Builds Vitrage 12.0.1 from source (patched) |
| `docker-compose.yml` | Lab orchestration — both containers with poc/ mounted |
| `verify_vuln.py` | Built-in verification script (baked into vulnerable image) |
| `intel_brief.md` | CVE intelligence brief from EIP |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab build details and verification steps |
| `poc_verification_report.md` | PoC test results across all vectors |
| `bypass_analysis.md` | Bypass attempt analysis (no bypass found) |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2026-28370)
- [Bug Tracker](https://storyboard.openstack.org/#!/story/2011539)
- [Fix Commit (master)](https://github.com/openstack/vitrage/commit/5b57e2b32a6d02992a28d9a671ebba5e308fd141)
- [Vulnerable Source](https://github.com/openstack/vitrage/blob/a1f86950e1314b0c740f9cd9b7e9dbab7d02af51/vitrage/graph/query.py#L70)
- [Repository](https://github.com/openstack/vitrage)
- [Tag 12.0.0 (vulnerable)](https://github.com/openstack/vitrage/releases/tag/12.0.0)
- [Tag 12.0.1 (patched)](https://github.com/openstack/vitrage/releases/tag/12.0.1)

## Timeline

| Date | Event |
|---|---|
| 2026-02-27 | CVE-2026-28370 published |
| 2026-02-27 | Fix commit `5b57e2b3` merged to master |
| 2026-02-27 | Cherry-picks to stable/2025.2, 2025.1, 2024.2, 2024.1 |
| 2026-02-27 | Patched versions 12.0.1, 13.0.1, 14.0.1, 15.0.1 released |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2026-28370 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
