# CVE-2025-11539 Lab - Grafana Image Renderer Arbitrary File Write / RCE
# Single-stage build: node:22 with system Chromium, source cloned at build time

FROM node:22-bookworm

# Install Chromium, fonts, build tools, and runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    chromium \
    fonts-open-sans \
    fonts-roboto \
    fonts-inter \
    fonts-freefont-ttf \
    fonts-wqy-zenhei \
    fonts-thai-tlwg \
    fonts-khmeros \
    fonts-kacst \
    tini \
    locales \
    git \
    && echo "en_US.UTF-8 UTF-8" > /etc/locale.gen \
    && locale-gen en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

WORKDIR /app

# Clone vulnerable version (v4.0.16) from source
RUN git clone --depth 1 --branch v4.0.16 https://github.com/grafana/grafana-image-renderer.git /tmp/renderer \
    && cp -a /tmp/renderer/. . \
    && rm -rf /tmp/renderer .git

# Install all dependencies (including dev deps for build)
RUN yarn install --pure-lockfile

# Build TypeScript -> JavaScript
RUN yarn run build

# Remove dev dependencies, keep only production
RUN rm -rf node_modules/ && yarn install --pure-lockfile --production

# Copy default.json as config.json (contains auth token "-")
RUN cp default.json config.json

# Set Chromium environment
ENV CHROME_BIN="/usr/bin/chromium"
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD="true"
ENV NODE_ENV=production

EXPOSE 8081

ENTRYPOINT ["tini", "--"]
CMD ["node", "build/app.js", "server", "--config=config.json"]

HEALTHCHECK --interval=10s --retries=6 --timeout=5s \
    CMD wget -O- -q http://localhost:8081/ || exit 1
