# Intel Brief: CVE-2025-4981

## CVE Metadata
- **CVE ID**: CVE-2025-4981
- **CVSS Score**: 9.9 (CRITICAL) — CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H
- **EPSS**: 0.5% (66.4th percentile)
- **CWE**: CWE-427 (Uncontrolled Search Path Element) — functionally a **path traversal / arbitrary file write** (CWE-22)
- **Published**: 2025-06-20
- **GHSA**: GHSA-qh58-9v3j-wcjc

## Affected Software
- **Software**: Mattermost Server
- **Vendor**: Mattermost, Inc.
- **Affected Versions**:
  - 9.11.x ≤ 9.11.15
  - 10.5.x ≤ 10.5.5
  - 10.6.x ≤ 10.6.5
  - 10.7.x ≤ 10.7.2
  - 10.8.x ≤ 10.8.0

## Description
Mattermost Server fails to sanitize the filename passed to the archive document extractor. When a user uploads a file attachment with an archive extension (`.zip`, `.tar.gz`, `.rar`, etc.), the content extraction service writes the uploaded file to a temporary directory using the **unsanitized original filename** in a `filepath.Join()` call:

```go
// VULNERABLE CODE in server/platform/services/docextractor/archive.go
func (ae *archiveExtractor) Extract(name string, r io.ReadSeeker) (string, error) {
    dir, err := os.MkdirTemp(os.TempDir(), "archiver")
    // ...
    f, err := os.Create(filepath.Join(dir, name))  // <-- PATH TRAVERSAL
    // ...
}
```

Go's `filepath.Join()` resolves `..` path components. If an attacker uploads a file with a name like `../../etc/cron.d/evil.zip`, the call becomes:
```
filepath.Join("/tmp/archiver123456", "../../etc/cron.d/evil.zip") → "/etc/cron.d/evil.zip"
```

This allows an authenticated user to write arbitrary file content to any filesystem location writable by the Mattermost server process, potentially leading to **Remote Code Execution** (e.g., via overwriting cron jobs, config files, web shell placement, or plugin injection).

### Attack Prerequisites
1. **Authentication**: Requires a valid Mattermost user account (any role — low privilege)
2. **FileSettings.EnableFileAttachments** = `true` (default: **true**)
3. **FileSettings.ExtractContent** = `true` (default: **true**)
4. The uploaded filename must end with a recognized archive extension (`.zip`, `.tar.gz`, `.rar`, `.tar`, `.tar.bz2`, `.tar.xz`, `.tar.lz4`, `.tar.sz`, `.tar.zst`) for `archiver.ByExtension()` to match

### Attack Vector
1. Authenticate to Mattermost as any user via `POST /api/v4/users/login`
2. Upload a file attachment to any channel via `POST /api/v4/files` with a path-traversal filename (e.g., `../../path/to/target.zip`)
3. The server's content extraction service processes the upload, triggering the archive extractor
4. The archive content is written to the path-traversed location
5. Depending on the write target, this can escalate to RCE

## Repository
- **URL**: https://github.com/mattermost/mattermost.git
- **Source Language**: Go (Go 1.21)
- **Module Path**: `github.com/mattermost/mattermost/server/v8`

## Versions
- **Vulnerable Version (checked out)**: `v9.11.15` (tag)
- **Fix Commit**: `65aec10162f612d98edf91cc66bf7e781868448b`
  - Author: Jesse Hallam
  - Date: 2025-05-19
  - Message: "MM-64336: simplify doc extractor (#31103)"
  - Jira: https://mattermost.atlassian.net/browse/MM-64337
- **Patched Versions**:
  - `v9.11.16`
  - `v10.5.6`
  - `v10.6.6`
  - `v10.7.3`
  - `v10.8.1`

## Fix Analysis
The fix replaces the vulnerable `filepath.Join(dir, name)` pattern with `os.CreateTemp()`, which generates a random safe filename:

```go
// FIXED CODE
func (ae *archiveExtractor) Extract(name string, r io.ReadSeeker) (string, error) {
    ext := getExtAlsoTarGz(name)
    f, err := os.CreateTemp("", "archiver-*"+ext)  // Safe: random filename, no user-controlled path
    // ...
    defer os.Remove(f.Name())
    // ...
}
```

The fix also adds a helper `getExtAlsoTarGz()` to properly extract the extension (special-casing `.tar.gz`), ensuring the temp file has the correct extension for `archiver.Walk()` to identify the format.

## Vulnerable File
- **Path**: `server/platform/services/docextractor/archive.go`
- **Function**: `archiveExtractor.Extract()`
- **Line**: 37 (the `os.Create(filepath.Join(dir, name))` call)

## Build System
- **Type**: Go with Makefile
- **Build file**: `server/Makefile`
- **Go version**: 1.21.8 (`server/.go-version`)
- **Key Dependencies**:
  - `github.com/mholt/archiver/v3` v3.5.1 — archive format handling (zip, tar.gz, rar, etc.)
  - PostgreSQL or MySQL — database backend
  - Standard Go toolchain
- **Docker images available**:
  - `mattermost/mattermost-team-edition:9.11.15` (vulnerable)
  - `mattermost/mattermost-enterprise-edition:9.11.15` (vulnerable)
  - Binary release: `https://releases.mattermost.com/9.11.15/mattermost-9.11.15-linux-amd64.tar.gz`

## Lab Setup Notes
- **Recommended approach**: Use the official Docker image `mattermost/mattermost-team-edition:9.11.15` with PostgreSQL
- **Required services**: PostgreSQL (or MySQL), Mattermost server
- **Default port**: 8065
- **File upload API**: `POST /api/v4/files` (requires authentication token + channel_id)
- **Login API**: `POST /api/v4/users/login` (returns auth token in header)
- **Config defaults to exploit**: Both `EnableFileAttachments` and `ExtractContent` are `true` by default — no config changes needed
- **Existing docker-compose.yaml** in `server/docker-compose.yaml` provides reference but is overly complex; a minimal PostgreSQL + Mattermost setup suffices

## Public Exploits
- **None found** — No public PoC exploits exist in ExploitDB, GitHub, Metasploit, or Nuclei templates
- **No Nuclei templates** available for this CVE
- PoC must be written from scratch

## PoC Strategy
1. Create a Python script that:
   a. Authenticates to Mattermost via `/api/v4/users/login`
   b. Crafts a multipart file upload request to `/api/v4/files` with a path-traversal filename (e.g., `../../tmp/pwned.zip`)
   c. The filename must end with a valid archive extension (`.zip` recommended)
   d. The file content should be a valid zip archive (so `archiver.ByExtension` matches and the Extract function is called)
2. Verify the file was written to the traversed path
3. For RCE demonstration: write a file to a location that triggers execution (e.g., plugin directory, cron job, or a marker file as proof)

## References
- [Mattermost Security Updates](https://mattermost.com/security-updates)
- [GHSA-qh58-9v3j-wcjc](https://github.com/advisories/GHSA-qh58-9v3j-wcjc)
- [Fix Commit](https://github.com/mattermost/mattermost/commit/65aec10162f612d98edf91cc66bf7e781868448b)
- [Jira Ticket MM-64337](https://mattermost.atlassian.net/browse/MM-64337)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-4981)
