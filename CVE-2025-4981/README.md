# CVE-2025-4981: Mattermost Server Path Traversal / Arbitrary File Write

## Overview

Mattermost Server fails to sanitize the filename parameter in the Upload Session API before passing it to the archive document extractor. The `archiveExtractor.Extract()` function uses `os.Create(filepath.Join(dir, name))` with the user-supplied filename, allowing Go's `filepath.Join()` to resolve `../` path traversal sequences and write attacker-controlled content to arbitrary filesystem locations. An authenticated user with minimal privileges can exploit this to achieve arbitrary file write, with potential escalation to Remote Code Execution.

## Affected Versions

| Branch | Vulnerable | Patched |
|--------|-----------|---------|
| 9.11.x | ≤ 9.11.15 | 9.11.16 |
| 10.5.x | ≤ 10.5.5  | 10.5.6  |
| 10.6.x | ≤ 10.6.5  | 10.6.6  |
| 10.7.x | ≤ 10.7.2  | 10.7.3  |
| 10.8.x | ≤ 10.8.0  | 10.8.1  |

## CVSS Score

- **Score**: 9.9 / 10 — **CRITICAL**
- **Vector**: `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H`
- **EPSS**: 0.5% (66.4th percentile)
- **CWE**: CWE-427 (Uncontrolled Search Path Element) / CWE-22 (Path Traversal)

## Root Cause

The vulnerability exists in `archiveExtractor.Extract()` in `server/platform/services/docextractor/archive.go`. When a file is uploaded via the Upload Session API (`POST /api/v4/uploads`), the user-supplied `filename` field is stored verbatim in the database as `UploadSession.Filename`. When the upload completes, this filename flows through the content extraction pipeline without sanitization:

```
Upload Session API → genFileInfoFromReader(us.Filename, ...) → info.Name = name
  → ExtractContentFromFileInfo(fileInfo.Name, ...) → archiveExtractor.Extract(name, r)
    → os.Create(filepath.Join(dir, name))   // PATH TRAVERSAL
```

Go's `filepath.Join()` resolves `..` components, so a filename like `../../tmp/evil.zip` escapes the intended temporary directory:

```go
filepath.Join("/tmp/archiver123456", "../../tmp/evil.zip")
// Resolves to: "/tmp/evil.zip"
```

**Important**: Only the Upload Session API (`POST /api/v4/uploads`) is vulnerable. The direct multipart upload API (`POST /api/v4/files`) applies `filepath.Base()` sanitization in `UploadFileX()`, stripping path traversal sequences.

## Lab Setup

### Prerequisites

- Docker and Docker Compose installed

### Start the Lab

```bash
# Start containers
docker compose up -d

# Wait for Mattermost to become healthy (~30-60s)
docker compose ps

# Initialize test user, team, and channel
bash init-mattermost.sh
```

### Verify the Lab

```bash
curl -s http://localhost:8065/api/v4/system/ping
# Expected: {"status":"OK"}
```

### Container Details

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-4981-mattermost` | `mattermost/mattermost-team-edition:9.11.15` | Vulnerable Mattermost Server | 8065 |
| `cve-2025-4981-db` | `postgres:15-bookworm` | PostgreSQL database backend | 5432 (internal) |

### Test Credentials

| Field | Value |
|-------|-------|
| Username | `admin` |
| Password | `Admin123!@#` |
| Email | `admin@test.local` |
| Team | `testteam` |
| Channel | `exploits` |

### Stop the Lab

```bash
# Stop containers
docker compose down

# Full reset (removes database volume)
docker compose down -v
```

## PoC Usage

All PoC scripts are in the `poc/` directory and use only Python 3 standard library (zero dependencies).

### PoC 1: Primary Exploit (`poc.py`)

Demonstrates the path traversal via the Upload Session API, writing a file to `/tmp/cve-2025-4981-proof.zip`.

```bash
python3 poc/poc.py localhost 8065
```

**Verify the file was written:**
```bash
docker exec cve-2025-4981-mattermost ls -la /tmp/cve-2025-4981-proof.zip
# Expected: -rw-r--r-- 1 mattermost mattermost 184 ... /tmp/cve-2025-4981-proof.zip
```

### PoC 2: Negative Test — Multipart API (`poc_vector2_multipart_negative.py`)

Confirms that the direct multipart upload API (`POST /api/v4/files`) is **NOT** vulnerable due to `filepath.Base()` sanitization.

```bash
python3 poc/poc_vector2_multipart_negative.py localhost 8065
```

**Expected result:** File is NOT written to the traversed path. Server stores only the base filename.

### PoC 3: Deep Traversal + `.tar.gz` (`poc_vector3_deep_traversal.py`)

Demonstrates 5 levels of `../` traversal with a `.tar.gz` extension, writing to `/var/tmp/`.

```bash
python3 poc/poc_vector3_deep_traversal.py localhost 8065
```

**Verify:**
```bash
docker exec cve-2025-4981-mattermost ls -la /var/tmp/cve-2025-4981-deep.tar.gz
# Expected: -rw-r--r-- 1 mattermost mattermost 151 ... /var/tmp/cve-2025-4981-deep.tar.gz
```

## Fix

**Commit**: [`65aec10162f612d98edf91cc66bf7e781868448b`](https://github.com/mattermost/mattermost/commit/65aec10162f612d98edf91cc66bf7e781868448b)

The fix replaces the vulnerable path construction with `os.CreateTemp()`:

```go
// BEFORE (vulnerable)
dir, err := os.MkdirTemp(os.TempDir(), "archiver")
defer os.RemoveAll(dir)
f, err := os.Create(filepath.Join(dir, name))  // user-controlled 'name' → path traversal

// AFTER (fixed)
ext := getExtAlsoTarGz(name)
f, err := os.CreateTemp("", "archiver-*"+ext)   // random filename, safe
defer os.Remove(f.Name())
```

## References

- [GHSA-qh58-9v3j-wcjc](https://github.com/advisories/GHSA-qh58-9v3j-wcjc) — GitHub Security Advisory
- [NVD — CVE-2025-4981](https://nvd.nist.gov/vuln/detail/CVE-2025-4981)
- [Fix Commit](https://github.com/mattermost/mattermost/commit/65aec10162f612d98edf91cc66bf7e781868448b)
- [Mattermost Security Updates](https://mattermost.com/security-updates)

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help security professionals, researchers, and system administrators understand and verify the vulnerability in controlled lab environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions.

The authors assume no liability for misuse of this software. Always follow responsible disclosure practices and comply with all applicable laws and regulations.
