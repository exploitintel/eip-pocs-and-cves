#!/bin/bash
# Initialize Mattermost with a test user, team, and channel for PoC testing.
# Run this script AFTER containers are up and healthy.

set -euo pipefail

CONTAINER="cve-2025-4981-mattermost"

# Credentials for the PoC
ADMIN_EMAIL="admin@test.local"
ADMIN_USER="admin"
ADMIN_PASS="Admin123!@#"
TEAM_NAME="testteam"
TEAM_DISPLAY="Test Lab"
CHANNEL_NAME="exploits"
CHANNEL_DISPLAY="Exploits"

echo "[*] Waiting for Mattermost to be fully ready..."
for i in $(seq 1 60); do
    if docker exec "$CONTAINER" curl -sf http://localhost:8065/api/v4/system/ping > /dev/null 2>&1; then
        echo "[+] Mattermost is ready!"
        break
    fi
    if [ "$i" -eq 60 ]; then
        echo "[-] Mattermost failed to become ready after 60 attempts"
        exit 1
    fi
    sleep 3
done

echo "[*] Creating admin user..."
docker exec "$CONTAINER" mmctl --local user create \
    --email "$ADMIN_EMAIL" \
    --username "$ADMIN_USER" \
    --password "$ADMIN_PASS" \
    --system-admin 2>&1 || echo "[!] User may already exist, continuing..."

echo "[*] Creating team..."
docker exec "$CONTAINER" mmctl --local team create \
    --name "$TEAM_NAME" \
    --display-name "$TEAM_DISPLAY" 2>&1 || echo "[!] Team may already exist, continuing..."

echo "[*] Adding user to team..."
docker exec "$CONTAINER" mmctl --local team users add "$TEAM_NAME" "$ADMIN_USER" 2>&1 || echo "[!] Already on team, continuing..."

echo "[*] Creating channel..."
docker exec "$CONTAINER" mmctl --local channel create \
    --team "$TEAM_NAME" \
    --name "$CHANNEL_NAME" \
    --display-name "$CHANNEL_DISPLAY" 2>&1 || echo "[!] Channel may already exist, continuing..."

echo "[*] Adding user to channel..."
docker exec "$CONTAINER" mmctl --local channel users add "${TEAM_NAME}:${CHANNEL_NAME}" "$ADMIN_USER" 2>&1 || echo "[!] Already in channel, continuing..."

echo ""
echo "============================================="
echo "  Mattermost Lab Ready for CVE-2025-4981"
echo "============================================="
echo "  Container: $CONTAINER"
echo "  Username:  $ADMIN_USER"
echo "  Password:  $ADMIN_PASS"
echo "  Email:     $ADMIN_EMAIL"
echo "  Team:      $TEAM_NAME"
echo "  Channel:   $CHANNEL_NAME"
echo "============================================="
