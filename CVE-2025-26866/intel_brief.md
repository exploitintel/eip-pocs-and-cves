# Intel Brief: CVE-2025-26866

## CVE Overview

- **CVE ID**: CVE-2025-26866
- **Title**: Apache HugeGraph — Insecure Hessian Deserialization in PD Raft RPC (RCE)
- **Severity**: HIGH
- **CVSS Score**: 8.8 (CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)
- **EPSS**: 1.3% (79.2th percentile)
- **CWE**: CWE-502 (Deserialization of Untrusted Data)
- **Published**: 2025-12-12

## Affected Software

- **Software**: Apache HugeGraph (graph database)
- **Vendor**: Apache Software Foundation
- **Affected Component**: `hugegraph-pd` module, specifically `hg-pd-core` — the PD (Placement Driver) Raft cluster component
- **Affected Artifact**: `org.apache.hugegraph:hg-pd-core`
- **Affected Versions**: 1.0.0 through 1.5.0 (all versions before 1.7.0)
- **Patched Version**: 1.7.0

## Description

A remote code execution (RCE) vulnerability exists in Apache HugeGraph's PD (Placement Driver) component. The PD uses SOFAJRaft (a Raft consensus library) for cluster coordination, and the Raft RPC communication layer uses the SOFABolt protocol. Within this communication channel, the `KVOperation` class deserializes Raft log entries using Hessian2 serialization **without any class whitelist or type filtering**.

A malicious Raft node (or any network attacker who can reach the Raft RPC port, default **8610**) can send specially crafted Hessian-serialized payloads containing arbitrary Java objects. When these payloads are deserialized by `KVOperation.fromByteArray()`, they can trigger gadget chains present on the classpath, leading to arbitrary code execution on the HugeGraph PD server.

**Two root causes are fixed simultaneously:**
1. **No deserialization whitelist**: `Hessian2Input` in `KVOperation.fromByteArray()` accepts any class for deserialization — no `SerializerFactory` with class restrictions is applied.
2. **No IP-based authentication**: The Raft RPC server (`createRaftRpcServer`) accepts connections from **any** IP address, so an external attacker (not just a cluster member) can inject malicious payloads.

## Vulnerability Details

### Vulnerable Code Path

**File**: `hugegraph-pd/hg-pd-core/src/main/java/org/apache/hugegraph/pd/raft/KVOperation.java`

```java
public static KVOperation fromByteArray(byte[] value) throws IOException {
    try (ByteArrayInputStream bis = new ByteArrayInputStream(value, 1, value.length - 1)) {
        Hessian2Input input = new Hessian2Input(bis);
        // BUG: No SerializerFactory — any class can be deserialized
        KVOperation op = new KVOperation();
        op.op = value[0];
        op.key = input.readBytes();
        op.value = input.readBytes();
        op.arg = input.readObject();   // <-- DANGEROUS: arbitrary object deserialization
        input.close();
        return op;
    }
}
```

The `input.readObject()` call on the `arg` field will instantiate and populate any Java class encoded in the Hessian stream. Combined with gadget chains available on the classpath (Spring, Commons, etc.), this enables RCE.

### Deserialization Trigger Chain

1. Raft leader replicates log entries to follower nodes
2. Follower's `RaftStateMachine.onApply()` receives the log entry
3. When `done == null` (replicated entries, not local), it calls `KVOperation.fromByteArray(iter.getData().array())` (line 84 of `RaftStateMachine.java`)
4. The `fromByteArray()` method creates a `Hessian2Input` with **no SerializerFactory** and calls `input.readObject()` on the `arg` field
5. Arbitrary class instantiation occurs → gadget chain executes → RCE

### Additional Vulnerable Location

**File**: `hugegraph-pd/hg-pd-core/src/main/java/org/apache/hugegraph/pd/meta/IdMetaStore.java` (line 250)

```java
private Object deserialize(byte[] bytes) {
    try (ByteArrayInputStream bis = new ByteArrayInputStream(bytes)) {
        Hessian2Input input = new Hessian2Input(bis);
        Object obj = input.readObject();  // Same pattern — no whitelist
        input.close();
        return obj;
    }
}
```

This is a secondary deserialization sink using the same unfiltered pattern, though the primary attack surface is through the Raft RPC port.

### Attack Vector

- **Protocol**: SOFABolt (Alipay's RPC framework, binary protocol over TCP)
- **Default Port**: 8610 (PD Raft port)
- **Authentication**: NONE (pre-fix)
- **Network**: Any attacker with TCP access to port 8610 can exploit this
- **Prerequisites**: Low privilege — attacker only needs network access to the Raft port. No valid cluster membership or credentials required.

## Repository Information

- **Repository URL**: https://github.com/apache/incubator-hugegraph.git
- **Vulnerable Version Tag**: `1.5.0` (checked out at commit `8b90977f8`)
- **Patched Version Tag**: `1.7.0`
- **Fix Merge Commit**: `42f9a7638ba0d3d75744c69690938c4ca1074e56`
- **Fix PR**: https://github.com/apache/incubator-hugegraph/pull/2735
- **Primary Language**: Java 11
- **Build System**: Maven (multi-module POM project)

## Fix Analysis

The fix (PR #2735, merged April 2, 2025) introduces two defense layers:

### 1. Hessian Deserialization Whitelist
**New file**: `hugegraph-pd/hg-pd-core/src/main/java/org/apache/hugegraph/pd/raft/serializer/HugegraphHessianSerializerFactory.java`

A custom `SerializerFactory` that maintains an explicit whitelist of allowed classes:
- Basic types (primitives, wrappers, String, Class, Number)
- Standard collections (List, Set, Map and their implementations)
- Concurrent utilities (AtomicInteger, AtomicLong, AtomicBoolean, AtomicReference, ConcurrentHashMap, ConcurrentSkipListMap, CopyOnWriteArrayList)
- Time classes (Date, Calendar, TimeUnit, SimpleDateFormat, DateTimeFormatter, LocalDate, LocalDateTime, Instant)
- Business class: `KVOperation` and `byte[]`

Any class not in the whitelist triggers a `SecurityException`:
```java
private void checkWhitelist(Class cl) {
    String className = cl.getName();
    if (!whitelist.contains(className)) {
        throw new SecurityException("hessian serialize unauthorized class: " + className);
    }
}
```

Applied in `KVOperation.fromByteArray()`:
```java
Hessian2Input input = new Hessian2Input(bis);
input.setSerializerFactory(HugegraphHessianSerializerFactory.getInstance());
```

### 2. IP-Based Authentication Handler
**New file**: `hugegraph-pd/hg-pd-core/src/main/java/org/apache/hugegraph/pd/raft/auth/IpAuthHandler.java`

A Netty `ChannelDuplexHandler` (marked `@Sharable`) that restricts incoming connections to only IPs from the configured Raft peer list. Connections from non-peer IPs are immediately closed:
```java
public void channelActive(ChannelHandlerContext ctx) throws Exception {
    String clientIp = getClientIp(ctx);
    if (!isIpAllowed(clientIp)) {
        ctx.close();
        return;
    }
    super.channelActive(ctx);
}
```

Applied in `RaftEngine.createRaftRpcServer()` via SOFABolt's `ExtendedNettyChannelHandler` mechanism on `BoltRpcServer`.

### Files Changed in Fix
| File | Change |
|---|---|
| `KVOperation.java` | Added `HugegraphHessianSerializerFactory` to `Hessian2Input` |
| `RaftEngine.java` | Added IP whitelist config, passes peers to `createRaftRpcServer` |
| `RaftStateMachine.java` | Minor log message improvements |
| `IpAuthHandler.java` | **NEW** — IP-based connection filter |
| `HugegraphHessianSerializerFactory.java` | **NEW** — Hessian class whitelist |

## Build System

- **Build tool**: Apache Maven 3.5+
- **Java version**: 11 (compiler source/target = 11)
- **Build command**: `mvn clean package -Dmaven.test.skip=true -Dmaven.javadoc.skip=true`
- **Root POM**: `pom.xml` (multi-module: hugegraph-server, hugegraph-pd, hugegraph-store, hugegraph-commons, install-dist, hugegraph-cluster-test)
- **Vulnerable module**: `hugegraph-pd/hg-pd-core`
- **Existing Dockerfile**: `hugegraph-pd/Dockerfile` (multi-stage: maven:3.9.0-eclipse-temurin-11 build → openjdk:11-slim runtime)

### Key Dependencies (hg-pd-core)
| Dependency | Version | Role |
|---|---|---|
| `com.alipay.sofa:jraft-core` | 1.3.13 | Raft consensus (includes SOFABolt + Hessian as transitive deps) |
| `org.rocksdb:rocksdbjni` | 6.29.5 | Storage engine |
| `org.springframework:spring-context` | 5.3.20 | DI framework (potential gadget source) |
| `org.springframework.boot:spring-boot` | 2.5.14 | Application framework |
| `org.projectlombok:lombok` | 1.18.30 | Code generation |
| `org.apache.commons:commons-lang3` | 3.12.0 | Utility library |
| `com.google.code.gson:gson` | 2.8.9 | JSON library |

### Service Configuration (Default)
| Service | Port | Protocol |
|---|---|---|
| PD REST API | 8620 | HTTP |
| PD gRPC | 8686 | gRPC |
| PD Raft | **8610** | SOFABolt (TCP) — **attack surface** |

### Default Configuration (`application.yml`)
```yaml
grpc:
  port: 8686
  host: 127.0.0.1
server:
  port: 8620
pd:
  data-path: ./pd_data
  initial-store-count: 1
  initial-store-list: 127.0.0.1:8500
raft:
  address: 127.0.0.1:8610
  peers-list: 127.0.0.1:8610
```

## Public Exploits

**No public exploits found.** Neither ExploitDB, Metasploit, GitHub PoCs, nor Nuclei templates exist for this CVE. A PoC must be written from scratch.

## PoC Development Strategy

### Approach
The exploit needs to:
1. **Connect to port 8610** using the SOFABolt protocol
2. **Send a crafted Hessian2-serialized payload** containing a gadget chain
3. **Trigger `KVOperation.fromByteArray()`** via a Raft log append operation

### Key Considerations
- **Protocol**: SOFABolt is a binary RPC protocol. The exploit must speak SOFABolt wire format (not plain HTTP/gRPC). The simplest approach is to write a Java-based PoC that uses the `jraft-core` client library directly.
- **Gadget Chains**: The classpath includes Spring Framework 5.3.x and Hessian (transitive from jraft-core). Known Hessian deserialization gadget chains exist (e.g., from `marshalsec` project). Spring-specific Hessian gadgets (e.g., `SpringPartiallyComparableAdvisorHolder`, `SpringAbstractBeanFactoryPointcutAdvisor`) or JNDI-based gadgets may be applicable.
- **Trigger Mechanism**: The attacker needs to submit a Raft task containing a malicious serialized `KVOperation`. The `readObject()` call on the `arg` field is the injection point. This requires joining the Raft cluster or sending raw SOFABolt AppendEntries requests.
- **Alternative Trigger**: Instead of joining the cluster, a simpler approach might be to directly construct SOFABolt protocol frames containing the malicious Hessian payload. The JRaft AppendEntriesRequest is the natural carrier since it contains byte[] data that gets deserialized via `KVOperation.fromByteArray()`.

### Recommended PoC Architecture
1. **Java-based exploit** using `jraft-core` 1.3.13 and `sofa-bolt` as dependencies
2. Craft a malicious `KVOperation` byte array with embedded Hessian gadget payload in the `arg` field
3. Send via SOFABolt connection to target PD Raft port 8610
4. The malicious payload is replicated through Raft and deserialized on all nodes
5. Verification: execute `touch /tmp/pwned` or DNS callback via RCE chain

### Lab Setup
- Single-node HugeGraph PD instance running version 1.5.0
- Build from source using existing `hugegraph-pd/Dockerfile` (multi-stage Maven build)
- Expose port 8610 (Raft) and 8620 (REST health check) for exploit interaction
- For single-node: configure `peers-list: <container-ip>:8610` with single peer
- Verification: execute `touch /tmp/pwned` and check file existence in container

## References

| Source | URL |
|---|---|
| Fix PR | https://github.com/apache/incubator-hugegraph/pull/2735 |
| GHSA | https://github.com/advisories/GHSA-q37j-3367-fwv7 |
| Apache Mailing List | https://lists.apache.org/thread/ko8jkwbjbb99m45pg4sgo5xsm8gx9nsq |
| oss-security | http://www.openwall.com/lists/oss-security/2025/12/09/1 |
| Repository | https://github.com/apache/incubator-hugegraph |
| NVD | https://nvd.nist.gov/vuln/detail/CVE-2025-26866 |
