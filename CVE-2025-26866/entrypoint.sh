#!/bin/bash
set -e

# Determine the container's IP address
# Try to get the IP from the default route interface
CONTAINER_IP=$(hostname -i 2>/dev/null | awk '{print $1}')
if [ -z "$CONTAINER_IP" ] || [ "$CONTAINER_IP" = "127.0.0.1" ]; then
    CONTAINER_IP=$(ip route get 1 2>/dev/null | awk '{print $NF;exit}')
fi
if [ -z "$CONTAINER_IP" ]; then
    CONTAINER_IP="0.0.0.0"
fi

echo "[*] Container IP: $CONTAINER_IP"

# Update application.yml with the actual container IP
sed -i "s/CONTAINER_IP/$CONTAINER_IP/g" /hugegraph-pd/conf/application.yml

echo "[*] Updated Raft config:"
grep -A2 "raft:" /hugegraph-pd/conf/application.yml

cd /hugegraph-pd

# Configure JVM options
CONF="./conf"
LIB="./lib"
LOGS="./logs"

JVM_OPTIONS="-Dlog4j.configurationFile=${CONF}/log4j2.xml"
JAVA_OPTIONS="-Xms512m -Xmx1024m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=${LOGS} ${JAVA_OPTS}"

echo "[*] Starting HugeGraph PD (vulnerable v1.5.0)..."
echo "[*] Raft port 8610 (attack surface), REST port 8620 (health check)"

# Start PD in the foreground (not background like the original script)
exec java -Dname="HugeGraphPD" ${JVM_OPTIONS} ${JAVA_OPTIONS} -jar \
    -Dspring.config.location=${CONF}/application.yml \
    ${LIB}/hg-pd-service-*.jar
