# CVE-2025-26866 Lab - Apache HugeGraph PD Insecure Hessian Deserialization RCE
#
# Multi-stage build: Maven build from source → Eclipse Temurin 11 runtime
# Build time: ~5 minutes (Maven dependency download + compilation)

# Stage 1: Build from source
FROM maven:3.9.0-eclipse-temurin-11 AS build

RUN apt-get -q update && apt-get -q install -y git && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 --branch 1.5.0 \
    https://github.com/apache/incubator-hugegraph.git /pkg

WORKDIR /pkg

# Full project build (required — PD depends on hugegraph-commons and other modules)
RUN mvn clean package -e -B -ntp \
    -Dmaven.test.skip=true \
    -Dmaven.javadoc.skip=true

# Move the distribution to a known fixed path (wildcards don't work in COPY --from)
RUN mv /pkg/hugegraph-pd/apache-hugegraph-pd-incubating-1.5.0 /hugegraph-pd-dist

# Stage 2: Runtime
FROM eclipse-temurin:11-jre-jammy

# Install runtime deps
RUN apt-get -q update && \
    apt-get -q install -y --no-install-recommends --no-install-suggests \
        dumb-init procps curl lsof iproute2 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copy built PD distribution from fixed path
COPY --from=build /hugegraph-pd-dist/ /hugegraph-pd/

WORKDIR /hugegraph-pd/

# Create required directories
RUN mkdir -p logs plugins pd_data && \
    chmod +x bin/*.sh

# Copy our custom entrypoint and application config
COPY entrypoint.sh /hugegraph-pd/entrypoint.sh
COPY application.yml /hugegraph-pd/conf/application.yml
RUN chmod +x /hugegraph-pd/entrypoint.sh

ENV JAVA_OPTS="-XX:+UnlockExperimentalVMOptions -XX:+UseContainerSupport -XX:MaxRAMPercentage=50"

# PD REST (health check), PD gRPC, PD Raft (attack surface)
EXPOSE 8620 8686 8610

ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["/hugegraph-pd/entrypoint.sh"]
