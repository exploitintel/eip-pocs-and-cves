# Lab Build Report: CVE-2025-26866

## Lab Architecture

**Single-container architecture** — Apache HugeGraph PD (Placement Driver) v1.5.0 running as a standalone single-node Raft cluster. No external database or cache services are needed since PD uses embedded RocksDB for storage.

### Container: `cve-2025-26866-vulnerable`

| Property | Value |
|---|---|
| **Image** | `cve-2025-26866-vulnerable` (multi-stage build) |
| **Base (build)** | `maven:3.9.0-eclipse-temurin-11` |
| **Base (runtime)** | `eclipse-temurin:11-jre-jammy` |
| **Software** | Apache HugeGraph PD v1.5.0 |
| **Container Name** | `cve-2025-26866-vulnerable` |
| **Networks** | `lab-net` |
| **Health Check** | `curl -sf http://localhost:8620/actuator/health` |

### Service Ports

| Port | Protocol | Service | Role |
|---|---|---|---|
| **8610** | SOFABolt (TCP) | PD Raft RPC | **Attack surface** — Hessian deserialization target |
| 8620 | HTTP | PD REST API | Health check / monitoring |
| 8686 | gRPC | PD gRPC | Control plane |

### Network Access

- **REST health check**: `curl http://localhost:8620/actuator/health`
- **Raft attack surface**: TCP connection to `localhost:8610`

## Build Details

### Build Process
- **Multi-stage Docker build**: Maven 3.9 + Eclipse Temurin JDK 11 → Eclipse Temurin JRE 11 (jammy)
- **Source**: Cloned from `https://github.com/apache/incubator-hugegraph.git` at tag `1.5.0`
- **Build command**: `mvn clean package -e -B -ntp -Dmaven.test.skip=true -Dmaven.javadoc.skip=true`
- **Distribution**: `hugegraph-pd/apache-hugegraph-pd-incubating-1.5.0/`

### Build Workarounds
1. **Base image**: Changed from `openjdk:11-slim` (no longer available on Docker Hub) to `eclipse-temurin:11-jre-jammy`
2. **COPY wildcard**: Docker `COPY --from=build` doesn't support wildcards reliably in all versions; used explicit path with a `RUN mv` step in the build stage
3. **Raft binding**: Default config binds to `127.0.0.1:8610` (unreachable from outside). Custom entrypoint script detects the container IP and updates `application.yml` at startup

### Configuration Changes from Default
- `grpc.host`: `127.0.0.1` → `0.0.0.0` (bind to all interfaces)
- `raft.address`: `127.0.0.1:8610` → `<container_ip>:8610` (dynamic at startup)
- `raft.peers-list`: `127.0.0.1:8610` → `<container_ip>:8610` (dynamic at startup)

## Vulnerability Confirmation

### Vulnerable Code Present
- `KVOperation.fromByteArray()` — Hessian2 deserialization with **no SerializerFactory** (no whitelist)
- `RaftStateMachine.onApply()` — Calls `KVOperation.fromByteArray()` on replicated log entries
- `RaftEngine.createRaftRpcServer()` — No `IpAuthHandler` (accepts connections from any IP)

### Patched Code Absent
- ❌ `HugegraphHessianSerializerFactory` — NOT present (no deserialization whitelist)
- ❌ `IpAuthHandler` — NOT present (no IP-based connection filtering)

### Gadget Chain Dependencies in Classpath
| Library | Version | Gadget Chain |
|---|---|---|
| `commons-collections` | 3.2.2 | `ChainedTransformer` / `InvokerTransformer` chains |
| `commons-beanutils` | 1.9.4 | `BeanComparator` chains |
| `spring-context` | 5.3.20 | `ClassPathXmlApplicationContext` JNDI gadgets |
| `hessian` | 3.3.6 | Native Hessian deserialization gadgets |
| `jraft-core` | 1.3.13 | SOFABolt RPC framework (transport layer) |

## Start/Stop Commands

### Start Lab
```bash
cd CVE-2025-26866
docker compose up -d
```

### Stop Lab
```bash
docker compose down
```

### Check Status
```bash
docker compose ps
```

### View Logs
```bash
docker compose logs -f
```

## Verification Evidence

### Container Health
```
NAME                        STATUS                    PORTS
cve-2025-26866-vulnerable   Up About a minute (healthy)   8610/tcp, 8620/tcp, 8686/tcp
```

### REST API Health
```
$ curl http://<container_ip>:8620/actuator/health
{"status":"UP"}
```

### Raft Engine Running
```
RaftEngine start successfully: id = pd_raft, peers list = [172.18.0.2:8610]
Raft becomes leader
Started HugePDServer in 1.64 seconds
```

### Port Accessibility
- TCP port 8610 (Raft/SOFABolt): **OPEN** and reachable from host
- TCP port 8620 (REST): **OPEN** and reachable from host

## Lab Files

| File | Description |
|---|---|
| `Dockerfile.vulnerable` | Multi-stage build (Maven → JRE 11) |
| `docker-compose.yml` | Compose orchestration |
| `application.yml` | PD config with Raft on dynamic container IP |
| `entrypoint.sh` | Dynamic IP detection + PD startup |

## PoC Agent Notes

### Target Information
- **Target host**: `localhost` (port-mapped)
- **Target port**: 8610 (SOFABolt/Raft RPC)
- **Protocol**: SOFABolt binary TCP protocol

### Attack Approach
1. Connect to port 8610 using SOFABolt protocol (use `jraft-core` 1.3.13 client library)
2. Send a crafted Hessian2-serialized payload with a gadget chain in the `arg` field of a `KVOperation`
3. The payload will be deserialized via `KVOperation.fromByteArray()` → `Hessian2Input.readObject()`
4. Available gadget chains: Commons Collections 3.2.2, Commons BeanUtils 1.9.4, Spring Context, Hessian-native

### Verification
- Execute `touch /tmp/pwned` via gadget chain
- Verify: `docker exec cve-2025-26866-vulnerable ls -la /tmp/pwned`

## Known Issues

1. **JRE-only runtime**: The runtime image uses JRE, not JDK. Tools like `jar`, `javac` are not available inside the container. Use `python3` with `zipfile` module for JAR inspection.
2. **Single-node Raft**: The PD runs as a single-node Raft cluster (leader only, no followers). The deserialization vulnerability is triggered through the Raft state machine's `onApply()` path. For single-node, the leader path (`done != null`) uses the already-parsed `KVOperation` object, so the exploit must craft a raw SOFABolt request that triggers the follower path (`done == null` → `KVOperation.fromByteArray()`).
3. **Raft IP binding**: The `raft.address` uses the container's `lab-net` IP since that's the first IP returned by `hostname -i`. The Raft port is accessible from the host via Docker port mapping.
