# CVE-2026-26321 Lab - OpenClaw Path Traversal
# Vulnerable version: v2026.2.13
#
# Self-contained â€” clones source from GitHub during build.
# Base image matches the project's own Dockerfile
FROM node:22-bookworm

# Install system build dependencies for native modules (sharp, etc.)
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      build-essential \
      python3 \
      git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Enable corepack for pnpm (matching project's packageManager field)
RUN corepack enable && corepack prepare pnpm@10.23.0 --activate

WORKDIR /app

# Clone OpenClaw at vulnerable version (shallow clone for speed)
RUN git clone --branch v2026.2.13 --depth 1 https://github.com/openclaw/openclaw.git .

# Install all dependencies (including devDependencies for vitest)
RUN pnpm install --frozen-lockfile

# Create sentinel files for PoC demonstration
RUN echo "CVE-2026-26321-SECRET-DATA-EXFILTRATED" > /tmp/cve-secret.txt && \
    echo "root:x:0:0:root:/root:/bin/bash" > /tmp/fake-passwd && \
    echo "OPENCLAW_API_KEY=sk-secret-key-12345" > /tmp/fake-env && \
    echo "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA0Z3VS5JJcds3xfn/ygWyF0PbnGcY\n-----END RSA PRIVATE KEY-----" > /tmp/fake-ssh-key

# Copy verification script from build context
COPY verify-vuln.mjs /app/verify-vuln.mjs

# Keep container running (the PoC agent will exec into it)
CMD ["tail", "-f", "/dev/null"]
