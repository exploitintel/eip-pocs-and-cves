<?php
/**
 * PATCHED Version — CVE-2025-47916 (simulates Invision Community 5.0.7 fix)
 *
 * The fix in 5.0.7 adds authentication checks to the customCss method,
 * preventing unauthenticated access. Additionally, template expression
 * evaluation is restricted.
 *
 * This file demonstrates the patched behavior for comparison.
 */

error_reporting(E_ALL);

$app        = $_REQUEST['app'] ?? '';
$module     = $_REQUEST['module'] ?? '';
$controller = $_REQUEST['controller'] ?? '';
$do         = $_REQUEST['do'] ?? '';

if ($app === 'core' && $module === 'system' && $controller === 'themeeditor' && $do === 'customCss') {
    themeeditor_customCss_patched();
} else {
    header('Content-Type: text/html; charset=utf-8');
    echo '<!DOCTYPE html><html><head><title>Invision Community</title></head>';
    echo '<body><h1>Invision Community 5.0.7 (Patched)</h1>';
    echo '<p>Synthetic lab instance — CVE-2025-47916 PATCHED.</p>';
    echo '</body></html>';
}

function makeProcessFunction_safe($templateContent) {
    // PATCHED: Strip {expression="..."} tags entirely instead of evaluating them
    // In the real fix, IPS likely restricted which template tags are allowed
    // in user-supplied CSS content
    $compiled = preg_replace('/\{expression="(.+?)"\}/s', '/* expression removed */', $templateContent);
    return $compiled;
}

function themeeditor_customCss_patched() {
    // PATCHED: Authentication check added in 5.0.7
    // In real IPS: if (!$this->member->isAdmin()) { throw new \OutOfRangeException; }
    // For this synthetic app, we simulate the auth check:
    $is_authenticated_admin = false; // No auth in synthetic app
    if (!$is_authenticated_admin) {
        http_response_code(403);
        header('Content-Type: text/html; charset=utf-8');
        echo '<h1>403 Forbidden</h1><p>You do not have permission to access this resource.</p>';
        return;
    }

    $content = $_POST['content'] ?? $_GET['content'] ?? '';
    if (empty($content)) {
        header('Content-Type: text/css; charset=utf-8');
        echo '/* Empty custom CSS */';
        return;
    }

    // PATCHED: Use safe template processing that strips expressions
    header('Content-Type: text/css; charset=utf-8');
    $result = makeProcessFunction_safe($content);
    echo $result;
}
