<?php
/**
 * Synthetic Vulnerable Application — CVE-2025-47916
 *
 * This faithfully reproduces the Invision Community 5.0.0–5.0.6 template
 * injection vulnerability in the themeeditor controller's customCss method.
 *
 * VULNERABLE FILE (in real IPS):
 *   /applications/core/modules/front/system/themeeditor.php
 *
 * ROOT CAUSE:
 *   The customCss() method is a protected controller method that can be
 *   invoked by unauthenticated users via IPS's routing mechanism (index.php
 *   with app/module/controller/do parameters). It passes the 'content'
 *   POST parameter directly to Theme::makeProcessFunction(), which compiles
 *   IPS template syntax into PHP code and evaluates it. The {expression="..."}
 *   template tag is converted to a raw PHP expression via eval().
 *
 * FIX (in 5.0.7):
 *   IPS added authentication checks to the customCss method and/or sanitized
 *   the content parameter before passing it to the template engine.
 *
 * For lab/PoC purposes only — DO NOT deploy to production.
 */

error_reporting(E_ALL);

// ============================================================================
// Simulated IPS Router
// ============================================================================
// IPS routes requests like: index.php?app=core&module=system&controller=themeeditor&do=customCss
// POST body contains the 'content' parameter

$app        = $_REQUEST['app'] ?? '';
$module     = $_REQUEST['module'] ?? '';
$controller = $_REQUEST['controller'] ?? '';
$do         = $_REQUEST['do'] ?? '';

// Route to the vulnerable controller method
if ($app === 'core' && $module === 'system' && $controller === 'themeeditor' && $do === 'customCss') {
    themeeditor_customCss();
} else {
    // Default response — simulated IPS home page
    header('Content-Type: text/html; charset=utf-8');
    echo '<!DOCTYPE html><html><head><title>Invision Community</title></head>';
    echo '<body><h1>Invision Community 5.0.6</h1>';
    echo '<p>Synthetic lab instance for CVE-2025-47916 reproduction.</p>';
    echo '</body></html>';
}

// ============================================================================
// Simulated Theme::makeProcessFunction() — THE VULNERABLE CODE PATH
// ============================================================================
// In real IPS, this method in system/Theme/Theme.php compiles IPS template
// syntax into PHP. The {expression="..."} tag is one of many template tags.
// It was intended for internal theme templates only, but customCss() passes
// user-supplied content through it without sanitization.
//
// The real implementation compiles {expression="EXPR"} to PHP echo statements
// and then evaluates the generated PHP via eval().

function makeProcessFunction($templateContent) {
    // Phase 1: Compile IPS template syntax to PHP
    // The {expression="..."} tag evaluates arbitrary PHP expressions
    $compiled = preg_replace_callback(
        '/\{expression="(.+?)"\}/s',
        function ($matches) {
            // This is the core vulnerability: user-supplied expression
            // is directly interpolated into PHP code
            $expr = $matches[1];
            // Unescape IPS-style escaping
            $expr = str_replace(array('\\\'', '\\"'), array("'", '"'), $expr);
            return '<?php echo ' . $expr . '; ?>';
        },
        $templateContent
    );

    // Phase 2: Evaluate compiled template (the dangerous part)
    // In real IPS this creates a function via eval(), here we use output buffering
    ob_start();
    try {
        // Extract PHP blocks and evaluate them
        // This simulates IPS's eval-based template execution
        $segments = preg_split('/(<\?php\s.*?\?>)/s', $compiled, -1, PREG_SPLIT_DELIM_CAPTURE);
        foreach ($segments as $segment) {
            if (preg_match('/^<\?php\s(.*?)\?>$/s', $segment, $m)) {
                eval($m[1]);
            } else {
                echo $segment;
            }
        }
    } catch (Throwable $e) {
        // Silently fail like IPS does
    }
    return ob_get_clean();
}

// ============================================================================
// Simulated themeeditor::customCss() — THE VULNERABLE ENDPOINT
// ============================================================================
// In real IPS (5.0.0–5.0.6):
// - This is a protected method on the themeeditor controller
// - It can be invoked by ANY user (no auth check) via the IPS router
// - It reads the 'content' POST parameter and passes it directly
//   to Theme::makeProcessFunction() for template compilation
// - The result is echoed back (intended for CSS preview in theme editor)

function themeeditor_customCss() {
    // NO authentication check — this is the access control flaw
    // In 5.0.7+, IPS added: if (!$this->member->isAdmin()) { throw new ... }

    $content = $_POST['content'] ?? $_GET['content'] ?? '';

    if (empty($content)) {
        header('Content-Type: text/css; charset=utf-8');
        echo '/* Empty custom CSS */';
        return;
    }

    // Pass user content directly to the template engine — THIS IS THE VULN
    // The content parameter is treated as an IPS template, allowing
    // {expression="..."} tags to execute arbitrary PHP
    header('Content-Type: text/css; charset=utf-8');
    $result = makeProcessFunction($content);
    echo $result;
}
