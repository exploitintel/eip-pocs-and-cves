#!/usr/bin/env python3
"""CVE-2026-0760 Lab Verification Script
Verifies that the vulnerable deserialize_message() function is importable
and that pickle.loads() is called without any safety checks.
"""
import sys
import inspect

def main():
    print("[*] CVE-2026-0760 Lab Verification")
    print("=" * 50)

    # Step 1: Verify MetaGPT is installed
    try:
        import metagpt
        print(f"[+] MetaGPT installed: version {metagpt.__name__}")
    except ImportError as e:
        print(f"[-] MetaGPT not installed: {e}")
        sys.exit(1)

    # Step 2: Verify the vulnerable function is importable
    try:
        from metagpt.utils.serialize import deserialize_message
        print("[+] deserialize_message() imported successfully")
    except ImportError as e:
        print(f"[-] Failed to import deserialize_message: {e}")
        sys.exit(1)

    # Step 3: Verify the function uses pickle.loads (source code check)
    source = inspect.getsource(deserialize_message)
    if "pickle.loads" in source:
        print("[+] CONFIRMED: deserialize_message() uses pickle.loads()")
    else:
        print("[-] WARNING: pickle.loads not found in function source")
        sys.exit(1)

    # Step 4: Verify pickle module is available (stdlib)
    import pickle
    print(f"[+] pickle module available (protocol {pickle.HIGHEST_PROTOCOL})")

    # Step 5: Create a benign test pickle payload and verify deserialization works
    import pickle

    class BenignTest:
        """A benign class that just returns a string when unpickled"""
        def __reduce__(self):
            return (str, ("pickle_deserialization_works",))

    payload = pickle.dumps(BenignTest())
    try:
        result = deserialize_message(payload)
        # The function will fail on message.instruct_content check
        # but pickle.loads() will have executed
    except AttributeError:
        # Expected: the returned string doesn't have .instruct_content
        print("[+] pickle.loads() executed payload (AttributeError on non-Message type â€” expected)")
    except Exception as e:
        print(f"[+] pickle.loads() executed payload (post-loads error: {type(e).__name__}: {e})")

    print()
    print("[+] LAB VERIFICATION COMPLETE")
    print("[+] The vulnerable deserialize_message() function is accessible")
    print("[+] pickle.loads() is called on untrusted input without any restrictions")
    return 0

if __name__ == "__main__":
    sys.exit(main())
