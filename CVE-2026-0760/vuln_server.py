#!/usr/bin/env python3
"""CVE-2026-0760 Vulnerable Demo Server

Exposes MetaGPT's deserialize_message() and actionoutput_str_to_mapping()
functions via HTTP endpoints, simulating a realistic attack surface where
serialized Message objects and JSON data are received over the network.

Endpoints:
  POST /api/message/deserialize  - Accepts base64-encoded pickle data
  POST /api/message/from-json    - Accepts JSON mapping (triggers eval())
  GET  /health                   - Health check
  GET  /                         - Info page

The server deliberately calls deserialize_message() and
actionoutput_str_to_mapping() on user-supplied data, demonstrating
CVE-2026-0760 (CWE-502 + CWE-95).
"""

import base64
import sys
import traceback

from flask import Flask, request, jsonify

app = Flask(__name__)


@app.route("/")
def index():
    return jsonify({
        "service": "MetaGPT Message Service (VULNERABLE)",
        "cve": "CVE-2026-0760",
        "description": "Demonstrates unsafe pickle deserialization and eval() injection in MetaGPT",
        "endpoints": {
            "POST /api/message/deserialize": "Send base64-encoded pickle payload (CWE-502)",
            "POST /api/message/from-json": "Send JSON mapping with eval() payloads (CWE-95)",
            "GET /health": "Health check"
        }
    })


@app.route("/health")
def health():
    return jsonify({"status": "ok", "vulnerable": True})


@app.route("/api/message/deserialize", methods=["POST"])
def handle_deserialize():
    """Receives base64-encoded serialized message data and deserializes it.

    This endpoint calls metagpt.utils.serialize.deserialize_message() which
    internally uses pickle.loads() — the root cause of CVE-2026-0760.

    Expected POST body (JSON):
        {"data": "<base64-encoded pickle bytes>"}

    Or raw POST body:
        Base64-encoded pickle bytes
    """
    try:
        # Accept JSON or raw body
        if request.is_json:
            payload_b64 = request.json.get("data", "")
        else:
            payload_b64 = request.get_data(as_text=True)

        if not payload_b64:
            return jsonify({"error": "No data provided. Send base64-encoded pickle data."}), 400

        # Decode base64 to raw bytes
        try:
            payload_bytes = base64.b64decode(payload_b64)
        except Exception:
            return jsonify({"error": "Invalid base64 encoding"}), 400

        # VULNERABLE: calls pickle.loads() on untrusted input
        from metagpt.utils.serialize import deserialize_message
        result = deserialize_message(payload_bytes)

        return jsonify({
            "status": "deserialized",
            "type": type(result).__name__,
            "content": str(result)[:500]
        })

    except Exception as e:
        # The pickle payload may execute code and then fail on
        # Message attribute access — but code execution already happened
        return jsonify({
            "status": "error",
            "error": str(e),
            "note": "If a pickle RCE payload was sent, code execution occurred BEFORE this error"
        }), 500


@app.route("/api/message/from-json", methods=["POST"])
def handle_from_json():
    """Receives a JSON mapping and processes it through actionoutput_str_to_mapping().

    This endpoint calls metagpt.utils.serialize.actionoutput_str_to_mapping()
    which internally uses eval() on each mapping value — a secondary RCE path
    independent of the pickle.loads() vulnerability (CWE-95).

    Expected POST body (JSON):
        {"mapping": {"field1": "<python expression>", "field2": "..."}}
    """
    try:
        if not request.is_json:
            return jsonify({"error": "Content-Type must be application/json"}), 400

        mapping = request.json.get("mapping")
        if not mapping or not isinstance(mapping, dict):
            return jsonify({"error": "Provide a 'mapping' dict, e.g. {\"mapping\": {\"key\": \"value\"}}"}), 400

        # VULNERABLE: calls eval() on each mapping value
        from metagpt.utils.serialize import actionoutput_str_to_mapping
        result = actionoutput_str_to_mapping(mapping)

        return jsonify({
            "status": "processed",
            "result": {k: str(v) for k, v in result.items()}
        })

    except Exception as e:
        return jsonify({
            "status": "error",
            "error": str(e),
            "note": "If an eval() RCE payload was sent, code execution occurred BEFORE this error"
        }), 500


if __name__ == "__main__":
    print("[*] CVE-2026-0760 Vulnerable Demo Server")
    print("[*] MetaGPT deserialize_message() pickle RCE + eval() injection")
    print("[*] Listening on 0.0.0.0:8080")
    print()
    app.run(host="0.0.0.0", port=8080, debug=False)
