# Lab Build Report: CVE-2025-7734

## Lab Architecture

**Single-container deployment** using GitLab's official all-in-one Docker image. GitLab CE bundles all required services (Rails/Puma, PostgreSQL, Redis, Gitaly, Nginx, Sidekiq) into a single container. No additional containers are needed since the vulnerability is in client-side JavaScript served by the GitLab web interface.

### Architecture Diagram

```
┌─────────────────────────────────────────┐
│  cve-2025-7734-gitlab                   │
│  (gitlab/gitlab-ce:18.0.5-ce.0)        │
│                                         │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐  │
│  │  Nginx   │ │  Puma    │ │ Sidekiq │  │
│  │  :80     │ │  (Rails) │ │         │  │
│  └────┬─────┘ └────┬─────┘ └─────────┘  │
│       │            │                     │
│  ┌────┴─────┐ ┌────┴─────┐ ┌─────────┐  │
│  │Workhorse │ │PostgreSQL│ │  Redis   │  │
│  └──────────┘ └──────────┘ └─────────┘  │
│                                         │
│  ┌──────────┐                           │
│  │  Gitaly  │                           │
│  └──────────┘                           │
└─────────────────────────────────────────┘
         │
    host port 8880 → container port 80
```

## Container Details

| Field | Value |
|---|---|
| **Container Name** | `cve-2025-7734-gitlab` |
| **Image** | `gitlab/gitlab-ce:18.0.5-ce.0` |
| **GitLab Version** | 18.0.5 (CE, revision `77c69341a7f`) |
| **Enterprise** | false (Community Edition) |
| **Network** | Default bridge |
| **Internal Ports** | 80 (HTTP), 443 (HTTPS), 22 (SSH) |
| **Volumes** | `gitlab-config`, `gitlab-logs`, `gitlab-data` |
| **SHM Size** | 512m |
| **Health Check** | `curl -sf http://localhost/-/health` (15s interval, 40 retries, 120s start period) |

### Access

The lab is accessible at `http://localhost:8880` via the published port mapping.

## Build Status

| Component | Status | Notes |
|---|---|---|
| Image Pull | ✅ SUCCESS | `gitlab/gitlab-ce:18.0.5-ce.0` (~1.7GB) |
| Container Start | ✅ SUCCESS | Platform warning (amd64 on arm64 host) — runs via QEMU emulation |
| GitLab Init | ✅ SUCCESS | Full reconfigure completed in ~2 minutes |
| Health Check | ✅ HEALTHY | All services running |
| API Access | ✅ VERIFIED | Version, user, project CRUD all working |

### Workarounds Applied

1. **Removed `grafana['enable'] = false`** from OMNIBUS_CONFIG — this setting is not recognized in GitLab CE 18.0.5 and causes a fatal `Mixlib::Config::UnknownConfigOptionError` during reconfigure.
2. **Platform mismatch**: The GitLab image is amd64-only; running on arm64 host via QEMU emulation. Performance is slower but functional.

## Credentials & Access

| Field | Value |
|---|---|
| **Root Username** | `root` |
| **Root Password** | `LabPass2025!` |

### Accessing GitLab

```bash
# API calls (include Host header due to external_url config)
curl -sf "http://localhost:8880/api/v4/version" \
  -H "Host: gitlab.local" \
  -H "PRIVATE-TOKEN: <your-token>"
```

**Note**: Include `-H "Host: gitlab.local"` in API requests due to the `external_url` configuration.

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs -f gitlab

# Stop the lab
docker compose down

# Full reset (delete all data)
docker compose down -v
```

## Verification Evidence

### Version Confirmed
```json
{
  "version": "18.0.5",
  "revision": "77c69341a7f",
  "enterprise": false
}
```

This is within the vulnerable range (14.2.0 ≤ version < 18.0.6).

### API Workflow Verified
1. ✅ Project creation via `POST /api/v4/projects`
2. ✅ File creation via `POST /api/v4/projects/:id/repository/files/:path`
3. ✅ File content retrieval via `GET /api/v4/projects/:id/repository/files/:path/raw`
4. ✅ Blob viewer page accessible via `GET /:namespace/:project/-/blob/:branch/:file` (HTTP 200)
5. ✅ Project deletion via `DELETE /api/v4/projects/:id`

### Vulnerable Code Present
The vulnerable JavaScript code navigation module is compiled into webpack bundles served by the GitLab instance. The `wrapNodes()` function (which assigns unsanitized `textContent` to `innerHTML`) is present in the compiled assets.

## CI Runner Status

**No shared runners are available** in this standalone lab. The PoC agent will need to handle LSIF artifact creation through one of these methods:

1. **Register a local runner** inside the container and run a CI pipeline
2. **Use the Job Artifacts API** to upload LSIF data directly
3. **Manipulate the code navigation data** via Rails console or database

### Runner Registration (if needed)
```bash
# Register a shell runner inside the GitLab container
docker exec cve-2025-7734-gitlab gitlab-runner register \
  --non-interactive \
  --url http://gitlab.local \
  --registration-token <TOKEN> \
  --executor shell
```

## PoC Reproduction Notes

### Attack Prerequisites
1. Authenticated user with write access to a project (root account available)
2. A source file containing XSS payload (e.g., `<img/src/onerror=alert(1)>` in a string literal)
3. A legacy LSIF code navigation artifact for that file (JSON without `end_line` property)
4. Victim views the file in GitLab's blob viewer

### LSIF Artifact Format
The code navigation data must be in the legacy format (no `end_line`):
```json
[
  {
    "start_line": 0,
    "start_char": 0,
    "hover": {
      "language": "python",
      "value": "variable: str"
    }
  }
]
```

### Helper Script
A setup script (`setup-gitlab.sh`) is available that automates project creation, payload file creation, and CI configuration.

## Known Issues

1. **Platform emulation**: Running amd64 image on arm64 host via QEMU. Operations are slower than native but fully functional.
2. **No CI runners**: Shared runners are not configured. LSIF artifacts must be uploaded via API or alternative methods.
3. **Memory usage**: GitLab CE is resource-intensive (~4GB RAM). Puma worker count is reduced to 2 and Sidekiq concurrency to 5 to conserve resources.
4. **Startup time**: Full initialization takes ~2 minutes. The health check has a 120-second start period.
5. **Health endpoint 404**: The `/-/health` endpoint returns 404 in this version despite the container being functional. The `/-/liveness` endpoint or the login page (`/users/sign_in`) can be used as alternative health indicators.

## Lab Files

| File | Path | Purpose |
|---|---|---|
| docker-compose.yml | `docker-compose.yml` | Lab orchestration |
| setup-gitlab.sh | `setup-gitlab.sh` | Automated project/payload setup |
