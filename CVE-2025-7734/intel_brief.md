# Intel Brief: CVE-2025-7734

## Overview

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-7734 |
| **Title** | Stored XSS in GitLab CE/EE Blob Viewer via Code Navigation |
| **Affected Software** | GitLab Community Edition (CE) / Enterprise Edition (EE) |
| **Vendor** | GitLab Inc. |
| **CVSS Score** | 8.7 (HIGH) |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:N |
| **CWE** | CWE-79 — Improper Neutralization of Input During Web Page Generation (Cross-site Scripting) |
| **EPSS** | 0.046% (14th percentile) |
| **Published** | 2025-08-13 |
| **Reporter** | joaxcar (via HackerOne #3247096) |

## Affected Versions

| Branch | Vulnerable Range | First Patched Version |
|---|---|---|
| Mainline (18.0.x) | 14.2.0 ≤ version < 18.0.6 | 18.0.6 |
| 18.1.x | 18.1.0 ≤ version < 18.1.4 | 18.1.4 |
| 18.2.x | 18.2.0 ≤ version < 18.2.2 | 18.2.2 |

The vulnerability was introduced in GitLab 14.2, when the code navigation feature with LSIF support was added.

## Vulnerability Description

A **Stored Cross-Site Scripting (XSS)** vulnerability exists in GitLab's blob viewer and code navigation feature. The flaw has two related attack surfaces:

### Attack Surface 1: Code Navigation `wrapNodes` (Primary)

The `wrapNodes()` function in `app/assets/javascripts/code_navigation/utils/dom_utils.js` converts DOM `textContent` into HTML via `innerHTML` without sanitization. When legacy LSIF (Language Server Index Format) artifacts (lacking `end_line` properties) are present, the `deprecatedNodeUpdate()` path in `app/assets/javascripts/code_navigation/utils/index.js` calls `wrapNodes(elm.textContent, ...)`, which:

1. Takes the text content of a `<span>` element (e.g., `<img/src/onerror=alert()>`)
2. Passes it through `wrapSpacesWithSpans()` which performs string replacement
3. Assigns the result to `wrapper.innerHTML` — causing the browser to parse the text as real HTML, executing injected JavaScript

**Vulnerable code:**
```javascript
const wrapNodes = (text, classList, dataset) => {
  const wrapper = createSpan();
  // eslint-disable-next-line no-unsanitized/property
  wrapper.innerHTML = wrapSpacesWithSpans(text);  // <-- XSS: text is parsed as HTML
  wrapper.childNodes.forEach((el) => wrapTextWithSpan(el, text, classList, dataset));
  return wrapper.childNodes;
};
```

### Attack Surface 2: Simple Blob Viewer `loadViewer`

The `loadViewer()` function in `app/assets/javascripts/blob/viewer/index.js` directly assigns server-returned HTML to `viewer.innerHTML` without sanitization:

```javascript
viewer.innerHTML = data.html;  // <-- Unsanitized server HTML
```

### Exploitation Requirements

1. **Attacker**: Authenticated user with write access to a repository (PR:L)
2. **Victim**: Must view the affected file in the blob viewer (UI:R)
3. **Trigger conditions**: The repository must have a legacy LSIF code intelligence artifact (without `end_line` properties) AND a source file containing the XSS payload
4. **Payload**: A source file (e.g., Python) containing a string like `"<img/src/onerror=alert(document.domain)>"`

### Impact

- Stored XSS executing in the context of the victim's GitLab session
- Potential CSP bypass on both self-hosted and gitlab.com instances
- Changed scope (S:C) — attacks can impact resources beyond the vulnerable component
- High confidentiality and integrity impact (C:H/I:H) — full account takeover possible

## Repository Information

| Field | Value |
|---|---|
| **Repository URL** | https://gitlab.com/gitlab-org/gitlab.git |
| **Vulnerable Version (tag)** | v18.0.5-ee (commit: `5ca0e4219f737f6f0cd4b3f882dfabd5a923e559`) |
| **Fix Commit** | `8370acfaf1d203a7227765309492498c93806a52` |
| **Fix Commit Title** | "Sanitize html for legacy simple blob viewer and code navigation nodes" |
| **Fix Author** | Chaoyue Zhao |
| **Fix Date** | 2025-08-11 |
| **Parent of Fix (vulnerable)** | `e25d8ecd126f9173d944c46edcfdf3c6a8b7814b` |
| **Patched Version Tags** | v18.0.6-ee (`85327bfea0841b1eda70dc49b76918681510f967`), v18.1.4-ee, v18.2.2-ee |
| **Security MR** | gitlab-org/security/gitlab!5158 |
| **Checked-out Version** | `e25d8ecd126f9173d944c46edcfdf3c6a8b7814b` (parent of fix — vulnerable) |

## Fix Analysis

The fix (commit `8370acfa`) applies DOMPurify sanitization in three files:

### 1. `app/assets/javascripts/code_navigation/utils/dom_utils.js`
```diff
+import { sanitize } from '~/lib/dompurify';

 const wrapNodes = (text, classList, dataset) => {
   const wrapper = createSpan();
-  // eslint-disable-next-line no-unsanitized/property
-  wrapper.innerHTML = wrapSpacesWithSpans(text);
+  const unSafeHtml = wrapSpacesWithSpans(text);
+  wrapper.innerHTML = sanitize(unSafeHtml);
   wrapper.childNodes.forEach((el) => wrapTextWithSpan(el, text, classList, dataset));
   return wrapper.childNodes;
 };
```

### 2. `app/assets/javascripts/blob/viewer/index.js`
```diff
+import { sanitize } from '~/lib/dompurify';

-    // eslint-disable-next-line no-unsanitized/property
-    viewer.innerHTML = data.html;
+    const unsafeHtml = data.html;
+    viewer.innerHTML = sanitize(unsafeHtml);
```

### 3. `spec/frontend/code_navigation/utils/index_spec.js`
Added test to verify `sanitize()` is called when wrapping text nodes.

**Follow-up hardening** (commit `bcb8c0a7`, 2025-09-24): "Escape text for wrapNodes utility" — added lodash `escape()` as an additional defense layer.

## Build System

| Field | Value |
|---|---|
| **Primary Language** | JavaScript (Vue.js / Webpack) within Ruby on Rails monolith |
| **Package Manager** | Yarn (yarn.lock present) |
| **Build Tool** | Webpack (config/webpack.config.js) |
| **Test Framework** | Jest (jest.config.js) |
| **Key JS Dependencies** | DOMPurify (`~/lib/dompurify`), Vue.js, Vuex, Axios, highlight.js |
| **Backend** | Ruby on Rails (not needed for PoC — XSS is client-side) |

## Lab Build Recommendations

### Recommended Approach: Official GitLab Docker Image

For reproducing this CVE, use GitLab's official Docker image at a vulnerable version:

```
gitlab/gitlab-ce:18.0.5-ce.0
```

This is a full GitLab CE instance with all required components (Rails app, Puma, Nginx, PostgreSQL, Redis, Gitaly).

### Docker Compose Setup Notes

- GitLab CE Docker image exposes ports 80, 443, 22
- Requires ~4GB RAM minimum
- First boot takes 3-5 minutes for initialization
- Configuration via `GITLAB_OMNIBUS_CONFIG` environment variable

### PoC Reproduction Steps

1. Start GitLab CE at a vulnerable version (v18.0.5 or earlier in the 18.0.x range)
2. Create a project and a source file containing the XSS payload:
   ```python
   # payload.py
   x = "<img/src/onerror=alert(document.domain)>"
   ```
3. Upload a **legacy LSIF artifact** (code intelligence data without `end_line` fields) for that file, via CI pipeline with code navigation job
4. View the file in the blob viewer — the XSS payload executes when code navigation processes the text

### LSIF Artifact Format

Legacy LSIF code navigation data is a JSON array served at the code navigation endpoint. The key characteristic is entries **without** `end_line` property, which forces the `deprecatedNodeUpdate` code path:

```json
[
  {"start_line": 0, "start_char": 0, "hover": {"language": "python", "value": "x"}}
]
```

When `end_line` is undefined, `deprecatedNodeUpdate` is triggered, which calls `wrapNodes(elm.textContent, ...)`, executing the XSS.

## Public Exploits

**No public exploits found.** No Metasploit modules, ExploitDB entries, GitHub PoCs, or Nuclei templates exist for this CVE. A PoC must be written from scratch based on the vulnerability analysis above.

## References

| Source | URL |
|---|---|
| GitLab Issue (restricted) | https://gitlab.com/gitlab-org/gitlab/-/issues/556090 |
| HackerOne Report (restricted) | https://hackerone.com/reports/3247096 |
| GHSA Advisory | https://github.com/advisories/GHSA-vp64-6mxr-66qc |
| NVD Entry | https://nvd.nist.gov/vuln/detail/CVE-2025-7734 |
| Fix Commit | https://gitlab.com/gitlab-org/gitlab/-/commit/8370acfaf1d203a7227765309492498c93806a52 |
| GitLab 18.2.2 Patch Release | https://about.gitlab.com/releases/2025/08/13/patch-release-gitlab-18-2-2-released/ |

## Key Files in Source Tree

| File | Role |
|---|---|
| `app/assets/javascripts/code_navigation/utils/dom_utils.js` | Contains vulnerable `wrapNodes()` — primary XSS vector |
| `app/assets/javascripts/code_navigation/utils/index.js` | Contains `deprecatedNodeUpdate()` that triggers `wrapNodes` with unsanitized text |
| `app/assets/javascripts/code_navigation/store/actions.js` | Vuex actions — `showBlobInteractionZones` triggers `addInteractionClass` with `wrapTextNodes` |
| `app/assets/javascripts/blob/viewer/index.js` | Contains vulnerable `loadViewer()` — secondary XSS vector |
| `app/assets/javascripts/lib/dompurify.js` | DOMPurify wrapper used in the fix |
| `spec/frontend/code_navigation/utils/index_spec.js` | Test suite for code navigation utils |
