# CVE-2025-7734: GitLab CE/EE Stored XSS via Code Navigation (Account Takeover)

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-7734 |
| **Affected Software** | GitLab Community Edition (CE) / Enterprise Edition (EE) |
| **Affected Versions** | 14.2.0 – 18.0.5 / 18.1.0 – 18.1.3 / 18.2.0 – 18.2.1 |
| **Patched Versions** | 18.0.6, 18.1.4, 18.2.2 |
| **CVSS** | 8.7 HIGH — `CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:N` |
| **CWE** | CWE-79: Improper Neutralization of Input During Web Page Generation (XSS) |
| **Author** | [Exploit Intelligence Platform](https://exploit-intel.com) |

## Overview

A **Stored Cross-Site Scripting (XSS)** vulnerability exists in GitLab CE/EE's blob viewer and code navigation feature. The `wrapNodes()` function in the code navigation module converts DOM `textContent` into HTML via `innerHTML` without sanitization. When a repository contains both a source file with HTML-like content and a legacy LSIF (Language Server Index Format) code intelligence artifact, any user viewing the file in the GitLab web UI will have attacker-controlled JavaScript execute in their browser session.

This enables full account takeover — the attacker can steal session cookies, create personal access tokens, add SSH keys, and modify code in any project the victim has access to.

## Root Cause

The vulnerability is a **text-to-HTML confusion** in the `wrapNodes()` function (`app/assets/javascripts/code_navigation/utils/dom_utils.js`). This function takes a `text` parameter derived from `elm.textContent` of a `<span>` element in GitLab's syntax-highlighted code viewer, passes it through `wrapSpacesWithSpans()` for whitespace handling, and then assigns the result to `wrapper.innerHTML`.

The critical issue is that `textContent` returns the **decoded plain text** of a DOM element (e.g., `<img onerror=alert()>` as literal characters), but `innerHTML` **parses** it as HTML. When source code contains HTML-like strings — which is completely normal for code files — those strings become live DOM elements with active JavaScript event handlers.

```javascript
// VULNERABLE CODE (pre-fix)
const wrapNodes = (text, classList, dataset) => {
  const wrapper = createSpan();
  wrapper.innerHTML = wrapSpacesWithSpans(text);  // <-- XSS: text parsed as HTML
  wrapper.childNodes.forEach((el) => wrapTextWithSpan(el, text, classList, dataset));
  return wrapper.childNodes;
};
```

A secondary XSS surface exists in `app/assets/javascripts/blob/viewer/index.js` where `viewer.innerHTML = data.html` assigns server-returned HTML without sanitization.

## Lab Setup

### Prerequisites

- Docker Engine with Docker Compose plugin
- ~4GB free RAM (8GB recommended)
- ~5GB free disk space

### Start the Lab

```bash
docker compose up -d
# Wait ~3 minutes for GitLab to initialize
docker compose ps   # STATUS should show "healthy"
```

### Lab Containers

| Container | Image | Ports | Role |
|---|---|---|---|
| `cve-2025-7734-gitlab` | `gitlab/gitlab-ce:18.0.5-ce.0` | `8880:80` | GitLab CE 18.0.5 — all-in-one (Rails, PostgreSQL, Redis, Nginx, Gitaly, Sidekiq) |

### Credentials

| Field | Value |
|---|---|
| **Username** | `root` |
| **Password** | `LabPass2025!` |

### Accessing the Lab

```bash
# Verify the instance is running
curl -sf "http://localhost:8880/api/v4/version" -H "Host: gitlab.local"

# Automated setup (creates project, payload file, CI config)
./setup-gitlab.sh http://localhost:8880 LabPass2025!
```

> **Note:** Include `-H "Host: gitlab.local"` in API calls due to the `external_url` configuration.

## PoC Usage

### Primary PoC: `poc.py` — Full Exploit Chain

The main PoC automates the entire exploit chain: project creation, payload commit, LSIF artifact setup, and verification.

```bash
# Full setup from scratch
python3 poc.py localhost --port 8880 --token <API_TOKEN> --password LabPass2025!

# Against existing lab setup (skip project creation)
python3 poc.py localhost --port 8880 --token <API_TOKEN> --skip-setup --project-id 2
```

### Node.js Engine Verification: `poc_vector2.py`

Reproduces the `wrapNodes()` function in isolation to prove the text-to-HTML confusion:

```bash
python3 poc_vector2.py localhost --port 8880 --token <API_TOKEN>
```

### Standalone HTML PoC: `poc_vector2_standalone.html`

Self-contained HTML file that demonstrates the vulnerability in any browser — no GitLab instance needed:

```bash
open poc_vector2_standalone.html
```

## Verification

### Vulnerable Version (GitLab CE 18.0.5)

| Test | Result |
|---|---|
| LSIF data format | Legacy (no `end_line`) — triggers `deprecatedNodeUpdate()` |
| `wrapNodes()` behavior | `textContent` assigned to `innerHTML` without sanitization |
| Browser XSS | `alert("gitlab.local")` executes — **VULNERABLE** |
| Injected DOM elements | `<img>` with active `onerror` handler found in DOM |

### Patched Version (GitLab CE >= 18.0.6)

| Test | Result |
|---|---|
| `wrapNodes()` behavior | `sanitize(wrapSpacesWithSpans(text))` via DOMPurify before `innerHTML` |
| Browser XSS | `<img onerror=...>` stripped to `<img src="">` — **SAFE** |
| Follow-up hardening | lodash `escape()` HTML-encodes text before processing |

## Fix

### Primary Fix — Commit `8370acfa` (2025-08-11)

The fix wraps both vulnerable `innerHTML` assignments with DOMPurify's `sanitize()` function:

```diff
+import { sanitize } from '~/lib/dompurify';
 const wrapNodes = (text, classList, dataset) => {
   const wrapper = createSpan();
-  wrapper.innerHTML = wrapSpacesWithSpans(text);
+  const unSafeHtml = wrapSpacesWithSpans(text);
+  wrapper.innerHTML = sanitize(unSafeHtml);
```

### Follow-Up Hardening — Commit `bcb8c0a7` (2025-09-24)

Added lodash `escape()` to HTML-encode text before processing, providing defense-in-depth independent of DOMPurify.

### Fix Assessment

The fix is **thorough and complete**. No bypass was found across 100 XSS payload variations targeting 8 distinct bypass vectors. DOMPurify 3.2.6 has no known bypass vulnerabilities with GitLab's conservative configuration.

## Attack Scenario

```
Attacker (Developer role)
    │
    ├─ 1. Commits payload.py with XSS in string literal:
    │      variable = "<img/src/onerror=alert(document.cookie)>"
    │
    ├─ 2. Creates LSIF artifact via CI (legacy format, no end_line):
    │      [{"start_line":4,"start_char":0,"hover":{...}}]
    │
    └─ 3. Victim views payload.py in blob viewer
           │
           ├─ Frontend fetches LSIF JSON → no end_line detected
           ├─ deprecatedNodeUpdate() called
           ├─ wrapNodes(elm.textContent, ...) runs
           ├─ textContent: "<img/src/onerror=alert(document.cookie)>"
           ├─ innerHTML = wrapSpacesWithSpans(text)  ← XSS SINK
           └─ Browser parses <img> → onerror fires → JS executes
               → Steal cookies, create PATs, add SSH keys, modify code
```

## Evidence Files

| File | Description |
|---|---|
| `poc.py` | Primary PoC — full exploit chain (API + LSIF setup + verification) |
| `poc_vector2.py` | Node.js engine verification of `wrapNodes()` vulnerability |
| `poc_vector2_standalone.html` | Standalone browser PoC (no GitLab instance required) |
| `browser_verify.cjs` | Puppeteer headless browser verification script |
| `verify_wrapnodes.cjs` | Node.js `wrapNodes()` reproduction |
| `bypass_poc.py` | Bypass analysis orchestrator (100 payloads, 0 bypasses) |
| `bypass_test.cjs` | DOMPurify bypass test suite 1 (58 payloads) |
| `bypass_test2.cjs` | DOMPurify bypass test suite 2 (42 payloads) |
| `xss_evidence.png` | Screenshot of XSS alert in blob viewer |
| `setup-gitlab.sh` | Automated GitLab project/payload setup script |
| `docker-compose.yml` | Docker Compose lab orchestration |

## References

| Source | URL |
|---|---|
| NVD Entry | https://nvd.nist.gov/vuln/detail/CVE-2025-7734 |
| GHSA Advisory | https://github.com/advisories/GHSA-vp64-6mxr-66qc |
| Fix Commit | https://gitlab.com/gitlab-org/gitlab/-/commit/8370acfaf1d203a7227765309492498c93806a52 |
| GitLab Patch Release | https://about.gitlab.com/releases/2025/08/13/patch-release-gitlab-18-2-2-released/ |

## Timeline

| Date | Event |
|---|---|
| **2025-xx-xx** | Vulnerability discovered by **joaxcar** via HackerOne (#3247096) |
| **2025-08-11** | Fix committed (commit `8370acfa`) |
| **2025-08-13** | Patch releases published: 18.0.6, 18.1.4, 18.2.2 |
| **2025-08-13** | CVE-2025-7734 published |
| **2025-09-24** | Follow-up hardening committed (lodash `escape()`, commit `bcb8c0a7`) |

## Disclaimer

This proof-of-concept is provided for **authorized security research and educational purposes only**. It is intended to help security professionals understand, verify, and test for CVE-2025-7734 in environments they own or have explicit written authorization to test.

**Do not** use this PoC against systems you do not own or have permission to test. Unauthorized access to computer systems is illegal under the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent laws in most jurisdictions.

The authors assume no liability for misuse of this material. If you discover this vulnerability in a production GitLab instance, **upgrade immediately** to a patched version (>= 18.0.6, >= 18.1.4, or >= 18.2.2) and follow GitLab's security advisory.

Responsible disclosure was handled through GitLab's HackerOne bug bounty program.
