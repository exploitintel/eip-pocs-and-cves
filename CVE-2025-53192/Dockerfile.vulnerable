# CVE-2025-53192 Lab — Apache Commons OGNL 4.0-SNAPSHOT (Vulnerable)
# Exploit Intelligence Platform | https://exploit-intel.com | @exploit_intel
#
# IMPORTANT — TEST HARNESS DISCLOSURE:
#   This image includes OgnlHttpHarness.java, a CUSTOM HTTP test wrapper that
#   exposes the vulnerable Ognl.getValue() function over an HTTP endpoint.
#   This harness is NOT part of Apache Commons OGNL — it was built by EIP to
#   enable standalone network-based PoC testing. The actual vulnerability
#   exists in the OGNL library's unrestricted expression evaluation; the
#   harness simply makes it reachable over HTTP for demonstration purposes.
#
# Multi-stage build:
#   Stage 1: Build commons-ognl from source using Maven + JDK 11
#   Stage 2: Minimal JDK 11 runtime with the built JAR + test harness

# ---- Stage 1: Build ----
FROM maven:3.9-eclipse-temurin-11 AS builder

WORKDIR /build

# Copy the entire source tree
COPY source/ ./

# Build the commons-ognl JAR (skip tests for speed)
RUN mvn package -DskipTests -q -B \
    && echo "=== Build successful ===" \
    && ls -la target/commons-ognl-*.jar

# Copy the Javassist dependency from the Maven local repo for runtime
RUN cp $(find /root/.m2/repository -name "javassist-*.jar" | head -1) /build/javassist.jar

# ---- Stage 2: Runtime ----
FROM eclipse-temurin:11-jdk

WORKDIR /lab

# Copy built artifacts
COPY --from=builder /build/target/commons-ognl-4.0-SNAPSHOT.jar /lab/commons-ognl.jar
COPY --from=builder /build/javassist.jar /lab/javassist.jar

# Copy harness source files
COPY OgnlRCEHarness.java /lab/OgnlRCEHarness.java
COPY OgnlHttpHarness.java /lab/OgnlHttpHarness.java

# Compile both harnesses against the built OGNL library
RUN javac -cp /lab/commons-ognl.jar:/lab/javassist.jar /lab/OgnlRCEHarness.java \
    && javac -cp /lab/commons-ognl.jar:/lab/javassist.jar /lab/OgnlHttpHarness.java \
    && echo "=== Harnesses compiled successfully ==="

# Set up classpath for easy execution
ENV CLASSPATH="/lab:/lab/commons-ognl.jar:/lab/javassist.jar"

EXPOSE 8080

# Default command: run the HTTP harness
CMD ["java", "OgnlHttpHarness"]
