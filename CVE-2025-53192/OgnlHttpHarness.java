import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;
import org.apache.commons.ognl.Ognl;
import org.apache.commons.ognl.OgnlContext;
import org.apache.commons.ognl.DefaultClassResolver;
import org.apache.commons.ognl.DefaultTypeConverter;
import org.apache.commons.ognl.DefaultMemberAccess;
import java.io.*;
import java.net.InetSocketAddress;
import java.nio.charset.StandardCharsets;

/**
 * CVE-2025-53192 HTTP Harness — wraps OGNL expression evaluation in an HTTP endpoint.
 *
 * POST /eval — evaluates an OGNL expression from the request body, returns the result.
 * GET  /health — returns 200 OK.
 *
 * This exposes the vulnerable DefaultClassResolver + DefaultMemberAccess configuration
 * over HTTP so PoC scripts can exploit it as standalone network clients.
 */
public class OgnlHttpHarness {

    public static void main(String[] args) throws Exception {
        int port = 8080;
        HttpServer server = HttpServer.create(new InetSocketAddress(port), 0);
        server.createContext("/eval", new EvalHandler());
        server.createContext("/health", new HealthHandler());
        server.setExecutor(null);
        server.start();
        System.out.println("OgnlHttpHarness listening on port " + port);
    }

    static class HealthHandler implements HttpHandler {
        public void handle(HttpExchange exchange) throws IOException {
            byte[] resp = "OK".getBytes(StandardCharsets.UTF_8);
            exchange.sendResponseHeaders(200, resp.length);
            exchange.getResponseBody().write(resp);
            exchange.getResponseBody().close();
        }
    }

    static class EvalHandler implements HttpHandler {
        public void handle(HttpExchange exchange) throws IOException {
            if (!"POST".equalsIgnoreCase(exchange.getRequestMethod())) {
                byte[] resp = "Method Not Allowed".getBytes(StandardCharsets.UTF_8);
                exchange.sendResponseHeaders(405, resp.length);
                exchange.getResponseBody().write(resp);
                exchange.getResponseBody().close();
                return;
            }

            // Read OGNL expression from request body
            String expr;
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(exchange.getRequestBody(), StandardCharsets.UTF_8))) {
                StringBuilder sb = new StringBuilder();
                String line;
                while ((line = reader.readLine()) != null) {
                    sb.append(line).append("\n");
                }
                expr = sb.toString().trim();
            }

            if (expr.isEmpty()) {
                byte[] resp = "Empty expression".getBytes(StandardCharsets.UTF_8);
                exchange.sendResponseHeaders(400, resp.length);
                exchange.getResponseBody().write(resp);
                exchange.getResponseBody().close();
                return;
            }

            // Create OGNL context with default (unrestricted) settings — the vulnerability
            DefaultMemberAccess memberAccess = new DefaultMemberAccess(false);
            OgnlContext context = new OgnlContext(
                new DefaultClassResolver(),
                new DefaultTypeConverter(),
                memberAccess
            );
            context.setRoot(new Object());

            String responseBody;
            int statusCode;

            try {
                Object tree = Ognl.parseExpression(expr);
                Object result = Ognl.getValue(tree, context, context.getRoot());

                // If result is a Process, read its output
                if (result instanceof Process) {
                    Process proc = (Process) result;
                    BufferedReader procReader = new BufferedReader(
                        new InputStreamReader(proc.getInputStream()));
                    StringBuilder output = new StringBuilder();
                    String procLine;
                    while ((procLine = procReader.readLine()) != null) {
                        output.append(procLine).append("\n");
                    }
                    proc.waitFor();
                    responseBody = output.toString();
                } else if (result != null) {
                    responseBody = result.toString();
                } else {
                    responseBody = "null";
                }
                statusCode = 200;
            } catch (Exception e) {
                responseBody = "ERROR: " + e.getClass().getName() + ": " + e.getMessage();
                statusCode = 500;
            }

            byte[] resp = responseBody.getBytes(StandardCharsets.UTF_8);
            exchange.sendResponseHeaders(statusCode, resp.length);
            exchange.getResponseBody().write(resp);
            exchange.getResponseBody().close();
        }
    }
}
