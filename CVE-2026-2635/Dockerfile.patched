# CVE-2026-2635 Lab - MLflow v3.9.0 with Randomized Admin Password
# Simulated fix: default password replaced with random value at build time
# Used to demonstrate the FastAPI auth bypass (works even with password changed)
FROM python:3.10-slim-bullseye

# Install MLflow v3.9.0 with auth dependencies
RUN pip install --no-cache-dir "mlflow[auth]==3.9.0"

# Set required environment variables
ENV MLFLOW_FLASK_SERVER_SECRET_KEY=cve-2026-2635-lab-secret-key-patched

# Create a working directory for MLflow data
WORKDIR /mlflow

# ===== SIMULATED FIX FOR CVE-2026-2635 =====
# Replace the hardcoded default password with a random password.
# This simulates an admin who has applied the recommended fix:
# 1. Generate a random admin password
# 2. Replace it in basic_auth.ini before first startup
# 3. The random password is only known to the operator
#
# The fix ONLY addresses the default credentials issue.
# It does NOT address the unauthenticated FastAPI routes.
RUN RANDOM_PASS=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))") && \
    INI_PATH=$(python3 -c "import mlflow.server.auth; import pathlib; print(pathlib.Path(mlflow.server.auth.__file__).parent / 'basic_auth.ini')") && \
    sed -i "s/admin_password = password1234/admin_password = ${RANDOM_PASS}/" "$INI_PATH" && \
    echo "PATCHED: Admin password changed to random value (not publicly known)" && \
    echo "Random admin password: ${RANDOM_PASS}" > /mlflow/.admin_password

EXPOSE 5000

# Start MLflow server with basic-auth enabled
CMD ["mlflow", "server", "--app-name", "basic-auth", "--host", "0.0.0.0", "--port", "5000"]
