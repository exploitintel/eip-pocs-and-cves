# CVE-2025-53833 - Vulnerable LaRecipe v2.8.0
# Server-Side Template Injection (SSTI) via getRequestUri() → Blade eval() → RCE
# Endpoint: GET /docs/1.0/overview?{{system('id')}}
FROM php:8.1-cli-bookworm

# Install system dependencies for Laravel + LaRecipe
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    unzip \
    libzip-dev \
    libxml2-dev \
    libonig-dev \
    libsqlite3-dev \
    && docker-php-ext-install \
        mbstring \
        xml \
        zip \
        pdo_sqlite \
        fileinfo \
    && rm -rf /var/lib/apt/lists/*

# PHP config: increase memory + suppress E_WARNING for Parsedown/PHP 8.1 compat
COPY php-lab.ini /usr/local/etc/php/conf.d/99-lab.ini

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Copy and run setup script - installs Laravel + LaRecipe 2.8.0 (VULNERABLE)
COPY setup.sh /tmp/setup.sh
RUN chmod +x /tmp/setup.sh && LARECIPE_VERSION=2.8.0 /tmp/setup.sh

# Copy entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /app/larecipe-lab

EXPOSE 8000

HEALTHCHECK --interval=10s --timeout=5s --retries=10 --start-period=15s \
    CMD curl -sf http://localhost:8000/docs/1.0/overview || exit 1

ENTRYPOINT ["/entrypoint.sh"]
