#!/bin/bash
set -e

# Setup script for LaRecipe lab environment
# This script is run inside the Docker container during build
# LARECIPE_VERSION is set by the Dockerfile (2.8.0 for vulnerable, 2.8.1 for patched)

LARECIPE_VERSION="${LARECIPE_VERSION:-2.8.0}"

echo "[*] Creating Laravel 10.x project..."
composer create-project laravel/laravel:^10.0 /app/larecipe-lab \
    --prefer-dist --no-interaction --no-dev

cd /app/larecipe-lab

# Disable Composer's security advisory blocking â€” we are intentionally
# installing a vulnerable package for CVE research/reproduction
echo "[*] Configuring Composer to allow insecure packages (lab environment)..."
composer config audit.block-insecure false

echo "[*] Installing LaRecipe v${LARECIPE_VERSION}..."
composer require "binarytorch/larecipe:${LARECIPE_VERSION}" --no-interaction

echo "[*] Setting up SQLite database (required by Laravel, not by LaRecipe)..."
touch database/database.sqlite
sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/' .env
sed -i '/^DB_HOST=/d' .env
sed -i '/^DB_PORT=/d' .env
sed -i '/^DB_DATABASE=/d' .env
sed -i '/^DB_USERNAME=/d' .env
sed -i '/^DB_PASSWORD=/d' .env

echo "[*] Generating application key..."
php artisan key:generate --force

echo "[*] Publishing LaRecipe config and assets..."
# Try the install command first, fallback to manual vendor:publish
php artisan larecipe:install --no-interaction 2>/dev/null || \
    php artisan vendor:publish --provider="BinaryTorch\LaRecipe\LaRecipeServiceProvider" --force 2>/dev/null || \
    echo "[!] WARNING: LaRecipe publish failed, will create config manually"

# Ensure config/larecipe.php exists (critical for route registration)
if [ ! -f config/larecipe.php ]; then
    echo "[*] Creating LaRecipe config manually..."
    if [ -f vendor/binarytorch/larecipe/publishable/config/larecipe.php ]; then
        cp vendor/binarytorch/larecipe/publishable/config/larecipe.php config/larecipe.php
    fi
fi

# Fix ParsedownExtra PHP 8.1 compatibility issue:
# "Undefined array key 'text'" in blockHeader() line 213.
# Parsedown's blockHeader() can return a Block without 'element.text' (using 'handler'
# instead) but ParsedownExtra assumes 'text' always exists. Add isset() guard.
echo "[*] Patching ParsedownExtra for PHP 8.1 compatibility..."
PARSEDOWN_FILE="vendor/erusev/parsedown-extra/ParsedownExtra.php"
if [ -f "$PARSEDOWN_FILE" ]; then
    sed -i "s/if (preg_match('\/\[ #\]\*{('.\\\$this->regexAttribute.'+)}\[ \]\*\$\/', \\\$Block\['element'\]\['text'\]/if (isset(\$Block['element']['text']) \&\& preg_match('\/[ #]*{('.\$this->regexAttribute.'+)}[ ]*\$\/', \$Block['element']['text']/" "$PARSEDOWN_FILE" 2>/dev/null || true
    # Simpler approach: use PHP to patch
    php -r "
        \$f = '$PARSEDOWN_FILE';
        \$c = file_get_contents(\$f);
        \$old = \"\\\$Block['element']['text'], \\\$matches, PREG_OFFSET_CAPTURE))\";
        \$new = \"(\\\$Block['element']['text'] ?? ''), \\\$matches, PREG_OFFSET_CAPTURE))\";
        \$c = str_replace(\$old, \$new, \$c);
        file_put_contents(\$f, \$c);
        echo '[+] ParsedownExtra patched successfully.' . PHP_EOL;
    "
fi

echo "[*] Creating documentation files with anchor links (trigger condition)..."
mkdir -p resources/docs/1.0

cat > resources/docs/1.0/index.md << 'MARKDOWN'
- ## Get Started
    - [Overview](/docs/1.0/overview)
    - [Installation](/docs/1.0/installation)
MARKDOWN

# The overview page MUST contain anchor links (href="#...") to trigger the vulnerable
# str_replace('"#', ...) code path in Documentation::replaceLinks()
cat > resources/docs/1.0/overview.md << 'MARKDOWN'
# Overview

Welcome to the documentation.

## Getting Started

Check out the [installation guide](#installation) for details on how to get started.

## Installation

Run the following command to install:

```bash
composer require binarytorch/larecipe
```

## Configuration

See the [options section](#options) for all available settings.

## Options

Configure as needed for your project.
MARKDOWN

cat > resources/docs/1.0/installation.md << 'MARKDOWN'
# Installation

## Requirements

- PHP >= 7.1
- Laravel >= 5.4

## Install via Composer

```bash
composer require binarytorch/larecipe
```

See the [configuration section](#configuration) for next steps.

## Configuration

Publish the config file:

```bash
php artisan larecipe:install
```

Check [available options](#options) to customize.

## Options

All options are in `config/larecipe.php`.
MARKDOWN

echo "[*] Running migrations (optional - LaRecipe doesn't need DB)..."
php artisan migrate --force 2>/dev/null || true

echo "[*] Setting permissions..."
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || true

echo "[*] Clearing caches..."
php artisan config:clear 2>/dev/null || true
php artisan cache:clear 2>/dev/null || true
php artisan view:clear 2>/dev/null || true

echo "[*] Setup complete! LaRecipe v${LARECIPE_VERSION} installed."
echo "[*] Documentation at: resources/docs/1.0/overview.md"
echo "[*] Start with: php artisan serve --host=0.0.0.0 --port=8000"
