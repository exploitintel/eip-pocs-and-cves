# Lab Build Report: CVE-2025-53606

## Lab Architecture

**Type**: Multi-container (pre-built Docker images, no source build required)

The lab uses official Apache Seata server Docker images from Docker Hub. No database, cache, or external registry is needed — Seata runs in file-based storage mode by default.

| Container | Image | Role | Ports |
|---|---|---|---|
| `cve-2025-53606-vulnerable` | `apache/seata-server:2.4.0` | Vulnerable Seata server with broken Fury ClassChecker | 7091 (HTTP/management), 8091 (RPC/Netty) |
| `cve-2025-53606-patched` | `apache/seata-server:2.5.0` | Patched Seata server with AllowListChecker fix | 8091 (RPC/Netty) |

### Key Details
- **Base image**: `eclipse-temurin:8u422-b05-jdk` (JDK 8)
- **JDK version**: OpenJDK 1.8.0_422 (Temurin) — JNDI remote class loading is enabled by default on JDK 8
- **Fury version**: fury-core-0.8.0.jar (both containers)
- **Vulnerable JAR**: seata-serializer-fury-2.4.0.jar (broken lambda ClassChecker)
- **Patched JAR**: seata-serializer-fury-2.5.0.jar (AllowListChecker with STRICT mode)
- **Storage mode**: File-based (no external DB required)
- **Authentication**: None required for RPC port

## Container Details

### Vulnerable Container (`cve-2025-53606-vulnerable`)
- **Image**: `apache/seata-server:2.4.0`
- **Health check**: HTTP GET `http://localhost:7091/health` → returns `ok`
- **RPC port**: TCP 8091 (Netty-based, Seata RPC v1 protocol)
- **Management port**: TCP 7091 (HTTP/Tomcat, Spring Boot)
- **Host ports**: 7091 (HTTP), 8091 (RPC)

### Patched Container (`cve-2025-53606-patched`)
- **Image**: `apache/seata-server:2.5.0`
- **Health check**: TCP port 8091 check (v2.5.0 doesn't expose HTTP management on 7091)
- **RPC port**: TCP 8091
- **Host ports**: 7092 (HTTP), 8092 (RPC)

## Network Configuration

Both containers expose their ports to the host via Docker port mappings.

**Accessing the lab:**
```bash
# Vulnerable server
curl -sf http://localhost:7091/health        # HTTP health check
# RPC port: localhost:8091

# Patched server
# RPC port: localhost:8092
```

## Build Status

| Container | Status | Notes |
|---|---|---|
| `cve-2025-53606-vulnerable` | ✅ HEALTHY | Started in ~1.2s, all services operational |
| `cve-2025-53606-patched` | ✅ HEALTHY | Started in ~0.9s, all services operational |

No build from source was required — both use pre-built Docker Hub images.

## Start/Stop Commands

```bash
# Start lab
docker compose up -d

# Stop lab
docker compose down

# Check status
docker compose ps

# View logs
docker compose logs vulnerable
docker compose logs patched
```

## Verification Evidence

### 1. Containers Running and Healthy
```
NAME                        IMAGE                       STATUS                    PORTS
cve-2025-53606-patched      apache/seata-server:2.5.0   Up (healthy)              7091/tcp, 8091/tcp
cve-2025-53606-vulnerable   apache/seata-server:2.4.0   Up (healthy)              7091/tcp, 8091/tcp
```

### 2. Fury Serializer JARs Present
- Vulnerable: `/seata-server/libs/fury-core-0.8.0.jar`, `/seata-server/libs/seata-serializer-fury-2.4.0.jar`
- Patched: `/seata-server/libs/fury-core-0.8.0.jar`, `/seata-server/libs/seata-serializer-fury-2.5.0.jar`

### 3. Network Reachability
- Vulnerable HTTP health (localhost:7091): ✅ Returns `ok`
- Vulnerable RPC (localhost:8091): ✅ TCP open
- Patched RPC (localhost:8092): ✅ TCP open

### 4. Seata RPC Protocol Test
Sent a minimal Seata RPC v1 frame (magic: 0xdada, version: 0x01, codec: 0x56/FURY) to port 8091 of the vulnerable container. Server recognized the protocol (no "Can not recognize protocol" error) and attempted body deserialization, logging `rpcMessage body[null]` as expected for an empty body. This confirms the full protocol path including FURY codec selection is operational.

### 5. JDK 8 Confirmed
```
openjdk version "1.8.0_422"
OpenJDK Runtime Environment (Temurin)(build 1.8.0_422-b05)
```
JDK 8 has no restrictions on JNDI remote class loading (`com.sun.jndi.ldap.object.trustURLCodebase` defaults to `true`), enabling JNDI-based RCE gadget chains.

## PoC Agent Notes

### Attacking the Vulnerable Container
1. **Target**: `localhost:8091` (TCP)
2. **Protocol**: Seata RPC v1 with FURY codec byte `0x56`
3. **No auth required**: Connect directly to TCP 8091
4. **JDK 8**: JNDI remote class loading works, HashMap+URL DNS callback works

### Verifying Against Patched Container
1. **Target**: `localhost:8092` (TCP)
2. **Expected behavior**: AllowListChecker throws `InsecureException` for non-whitelisted classes, rejecting the malicious payload

### Payload Generation
A Java helper tool is needed to generate Fury-serialized payloads (fury-core-0.8.0.jar). The Fury binary format is not trivially constructed by hand. Recommended approach:
1. Write a small Java program using fury-core-0.8.0 to serialize a malicious object
2. Output the raw bytes to a file
3. Use Python to wrap in Seata RPC v1 frame and send via TCP socket

Alternatively, an all-Java PoC can do everything in one program.

## Known Issues

- **Patched container health check**: The v2.5.0 image does not expose an HTTP management endpoint on port 7091 (console UI moved to namingserver). Health check uses TCP port 8091 check instead of HTTP. The TCP health check probe produces harmless "Can not recognize protocol" errors in the server logs.
- **Port mappings**: Vulnerable: 7091/8091 on host. Patched: 7092/8092 on host.

## Files

- `docker-compose.yml` — Docker Compose orchestration file
