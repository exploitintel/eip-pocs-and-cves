FROM alpine:3.22

LABEL maintainer="CVEForge Lab" \
    description="Kanboard v1.2.47 - Patched for CVE-2025-55010"

VOLUME ["/var/www/app/data", "/var/www/app/plugins", "/etc/nginx/ssl"]

EXPOSE 80 443

ARG VERSION=v1.2.46

RUN apk --no-cache --update add \
    tzdata openssl unzip nginx bash ca-certificates s6 curl ssmtp mailx php84 php84-phar php84-curl \
    php84-fpm php84-json php84-zlib php84-xml php84-dom php84-ctype php84-opcache php84-zip php84-iconv \
    php84-pdo php84-pdo_mysql php84-pdo_sqlite php84-pdo_pgsql php84-mbstring php84-session php84-bcmath \
    php84-gd php84-openssl php84-sockets php84-posix php84-ldap php84-simplexml php84-xmlwriter patch && \
    rm -rf /var/www/localhost && \
    rm -f /etc/php84/php-fpm.d/www.conf && \
    ln -sf /usr/bin/php84 /usr/bin/php

# Download Kanboard base version
RUN curl -fsSL "https://github.com/kanboard/kanboard/archive/refs/tags/${VERSION}.tar.gz" -o /tmp/kanboard.tar.gz && \
    mkdir -p /var/www/app && \
    tar xzf /tmp/kanboard.tar.gz -C /var/www/app --strip-components=1 && \
    cp -r /var/www/app/docker/* / && \
    rm -rf /var/www/app/docker /tmp/kanboard.tar.gz

# Apply the CVE-2025-55010 fix patch
COPY fix.patch /tmp/fix.patch
RUN cd /var/www/app && patch -p1 < /tmp/fix.patch && rm /tmp/fix.patch

RUN echo v1.2.47 > /var/www/app/app/version.txt

HEALTHCHECK --start-period=5s --interval=10s --timeout=5s --retries=5 \
  CMD curl -f http://localhost/healthcheck.php || exit 1

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD []
