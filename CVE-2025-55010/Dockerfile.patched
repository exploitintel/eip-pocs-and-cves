# CVE-2025-55010 - Patched Kanboard v1.2.47
# Fix: unserialize() removed from unserializeEvent(). Session bypass still works.
FROM kanboard/kanboard:v1.2.46

LABEL maintainer="Exploit Intelligence Platform" \
    description="Kanboard v1.2.47 - Patched for CVE-2025-55010"

# Install patch utility
RUN apk --no-cache add patch

# Apply the CVE-2025-55010 fix patch
COPY fix.patch /tmp/fix.patch
RUN cd /var/www/app && patch -p1 < /tmp/fix.patch && rm /tmp/fix.patch

RUN echo v1.2.47 > /var/www/app/app/version.txt

# Pre-generate session bypass payload at build time.
# Target file: /opt/poc/.bypass_marker.txt (bind-mounted, verifiable from host)
COPY poc/generate_session_payload.php /tmp/generate_session_payload.php
RUN sed -i "s|/tmp/bypass_marker.txt|/opt/poc/.bypass_marker.txt|" /tmp/generate_session_payload.php && \
    php /tmp/generate_session_payload.php filedelete > /opt/session_payload_filedelete.bin 2>/opt/session_payload_info.txt && \
    rm /tmp/generate_session_payload.php

# Entrypoint wrapper copies pre-generated payloads to the bind-mounted poc directory
COPY entrypoint-wrapper-patched.sh /usr/local/bin/entrypoint-wrapper.sh
RUN chmod +x /usr/local/bin/entrypoint-wrapper.sh

ENTRYPOINT ["/usr/local/bin/entrypoint-wrapper.sh"]
