# CVE-2016-15057 Lab - Apache Continuum Command Injection
# Uses pre-built binary distribution with Azul Zulu JDK 7

FROM azul/zulu-openjdk:7

# Install runtime dependencies and utilities
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    netcat-openbsd \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Download and extract Apache Continuum 1.4.2 pre-built binary
RUN curl -fSL "https://archive.apache.org/dist/continuum/binaries/apache-continuum-1.4.2-bin.tar.gz" -o /tmp/continuum.tar.gz && \
    tar xzf /tmp/continuum.tar.gz -C /opt && \
    rm /tmp/continuum.tar.gz && \
    mv /opt/apache-continuum-1.4.2 /opt/continuum

WORKDIR /opt/continuum

# Patch wrapper.conf to use system Java
RUN JAVA_BIN=$(which java) && \
    sed -i "s|^wrapper.java.command=java|wrapper.java.command=${JAVA_BIN}|" conf/wrapper.conf

# Remove 32-bit wrapper binary so the script uses the 64-bit one
# (The 32-bit binary is picked first but needs /lib/ld-linux.so.2 which
# is not available in this 64-bit only environment)
RUN rm -f bin/wrapper-linux-x86-32 lib/libwrapper-linux-x86-32.so

# Create required directories
RUN mkdir -p logs tmp

# Copy setup helper scripts
COPY entrypoint.sh /opt/entrypoint.sh
COPY setup-continuum.sh /opt/setup-continuum.sh
RUN chmod +x /opt/entrypoint.sh /opt/setup-continuum.sh

EXPOSE 8080

HEALTHCHECK --interval=10s --timeout=5s --start-period=90s --retries=15 \
    CMD curl -sf http://localhost:8080/continuum/ || exit 1

ENTRYPOINT ["/opt/entrypoint.sh"]
