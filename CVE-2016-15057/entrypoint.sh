#!/bin/bash
set -e

CONTINUUM_HOME="/opt/continuum"
cd "$CONTINUUM_HOME"

echo "[entrypoint] Starting Apache Continuum 1.4.2..."
echo "[entrypoint] Java version: $(java -version 2>&1 | head -1)"

# Run the auto-setup script in the background after Continuum starts
/opt/setup-continuum.sh &

# Try the standard wrapper approach first
# The wrapper binary should be the x86-64 version
if [ -f "bin/wrapper-linux-x86-64" ]; then
    echo "[entrypoint] Using Tanuki wrapper (console mode)..."
    exec bin/continuum console
else
    echo "[entrypoint] Wrapper binary not found, starting Jetty directly..."
    # Build classpath from all jars
    CP=""
    for jar in lib/*.jar; do
        CP="$CP:$CONTINUUM_HOME/$jar"
    done
    CP="${CP#:}"

    # Start Jetty directly with the same parameters as wrapper.conf
    exec java \
        -Dappserver.home="$CONTINUUM_HOME" \
        -Dappserver.base="$CONTINUUM_HOME" \
        -Djetty.logs="$CONTINUUM_HOME/logs" \
        -Djava.io.tmpdir="$CONTINUUM_HOME/tmp" \
        -Xmx256m \
        -cp "$CP" \
        org.eclipse.jetty.start.Main \
        conf/jetty.xml \
        conf/jetty-plus.xml \
        conf/jetty-deploy.xml \
        conf/jetty-contexts.xml \
        conf/jetty-requestlog.xml
fi
