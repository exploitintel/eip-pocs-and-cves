#!/bin/bash
# Auto-setup script for Apache Continuum
# Waits for Continuum to start, then completes the initial setup wizard
# (creates admin user) so the vulnerable endpoint is reachable.
#
# The redbackForceAdminUser interceptor will redirect all requests to
# admin creation if no admin user exists. Once an admin is created,
# the app functions normally and the vulnerable endpoint can be exploited
# without authentication.

CONTINUUM_URL="http://localhost:8080/continuum"
MAX_WAIT=120
SETUP_DONE="/opt/continuum/.setup_done"

if [ -f "$SETUP_DONE" ]; then
    echo "[setup] Setup already completed, skipping."
    exit 0
fi

echo "[setup] Waiting for Continuum to start..."
elapsed=0
while [ $elapsed -lt $MAX_WAIT ]; do
    HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "$CONTINUUM_URL/" 2>/dev/null)
    if [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "200" ]; then
        echo "[setup] Continuum is up after ${elapsed}s (HTTP $HTTP_CODE)"
        break
    fi
    sleep 3
    elapsed=$((elapsed + 3))
done

if [ $elapsed -ge $MAX_WAIT ]; then
    echo "[setup] ERROR: Continuum did not start within ${MAX_WAIT}s"
    exit 1
fi

# Give it a couple seconds to fully initialize
sleep 3

echo "[setup] Checking initial setup status..."

# Get the setup page with cookie jar to capture session
COOKIEJAR="/tmp/setup_cookies.txt"
SETUP_PAGE=$(curl -sfL -c "$COOKIEJAR" -b "$COOKIEJAR" "$CONTINUUM_URL/" 2>&1)

if echo "$SETUP_PAGE" | grep -qi "Create Admin User\|addadminSubmit"; then
    echo "[setup] Initial setup wizard detected, creating admin user..."

    # Extract CSRF token from the form
    TOKEN=$(echo "$SETUP_PAGE" | grep -o 'name="token" value="[^"]*"' | head -1 | sed 's/name="token" value="//;s/"//')

    if [ -z "$TOKEN" ]; then
        echo "[setup] WARNING: Could not extract CSRF token, trying without it..."
    else
        echo "[setup] CSRF Token extracted"
    fi

    # Submit the admin user creation form
    RESULT=$(curl -sf -L \
        -b "$COOKIEJAR" \
        -c "$COOKIEJAR" \
        -X POST "$CONTINUUM_URL/security/addadminSubmit.action" \
        -d "user.username=admin" \
        -d "user.fullName=Admin+User" \
        -d "user.email=admin@localhost.local" \
        -d "user.password=admin123" \
        -d "user.confirmPassword=admin123" \
        -d "struts.token.name=token" \
        -d "token=$TOKEN" \
        2>&1)

    if echo "$RESULT" | grep -qi "Login\|groupSummary\|Project Groups"; then
        echo "[setup] Admin user created successfully (admin/admin123)"
    else
        echo "[setup] Admin creation response received, verifying..."
    fi
else
    echo "[setup] No setup wizard detected (may already be configured)"
fi

# Clean up
rm -f "$COOKIEJAR"
touch "$SETUP_DONE"
echo "[setup] Setup complete. Continuum ready at $CONTINUUM_URL"
echo "[setup] Admin credentials: admin/admin123"
echo "[setup] Vulnerable endpoint: POST $CONTINUUM_URL/saveInstallation.action"
echo "[setup]   Exploit: installation.name=test&installation.type=jdk&installation.varValue=\$(COMMAND)"
