#!/bin/bash
# Seed a test user for CVE-2025-66489 PoC testing
# Run this after the vulnerable container has started and migrations have completed
set -e

DB_CONTAINER="cve-2025-66489-db"
DB_USER="unicorn_user"
DB_NAME="calendso"

echo "[*] Waiting for database to be ready..."
until docker exec "$DB_CONTAINER" pg_isready -U "$DB_USER" -d "$DB_NAME" 2>/dev/null; do
    sleep 2
done

echo "[*] Checking if users table exists (waiting for migrations)..."
for i in $(seq 1 30); do
    if docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "SELECT 1 FROM \"users\" LIMIT 0" 2>/dev/null; then
        echo "[+] users table found"
        break
    fi
    echo "    Waiting for migrations... (attempt $i)"
    sleep 5
done

echo "[*] Seeding test user: victim@example.com / Password123!"
docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "
INSERT INTO \"users\" (
    uuid, email, username, name,
    \"identityProvider\", \"completedOnboarding\", \"twoFactorEnabled\",
    role, \"emailVerified\", \"timeZone\", \"weekStart\", locale
) VALUES (
    gen_random_uuid(), 'victim@example.com', 'victim', 'Victim User',
    'CAL', true, false,
    'USER', NOW(), 'America/New_York', 'Sunday', 'en'
) ON CONFLICT DO NOTHING;
"

docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "
INSERT INTO \"UserPassword\" (\"userId\", hash)
SELECT id, '\$2b\$10\$zQfXC6SxIG8iuxiWGeYJB.cQRuObMrXS2k9KGTB9/Rp1TxpxN0HqG'
FROM \"users\"
WHERE email = 'victim@example.com'
ON CONFLICT (\"userId\") DO NOTHING;
"

echo "[+] Test user seeded successfully"
echo "    Email:    victim@example.com"
echo "    Password: Password123!"
echo "    2FA:      disabled"

# Verify
echo ""
echo "[*] Verification:"
docker exec "$DB_CONTAINER" psql -U "$DB_USER" -d "$DB_NAME" -c "
SELECT u.id, u.email, u.\"identityProvider\", u.\"twoFactorEnabled\", p.hash IS NOT NULL as has_password
FROM \"users\" u
LEFT JOIN \"UserPassword\" p ON u.id = p.\"userId\"
WHERE u.email = 'victim@example.com';
"
