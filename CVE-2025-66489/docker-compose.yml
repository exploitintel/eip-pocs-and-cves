# docker-compose.yml â€” CVE-2025-66489 Lab Environment
#
# Cal.com < 5.9.8 - Authentication Bypass via TOTP Code Injection
#
# Usage:
#   docker compose up -d
#   docker compose down

services:
  db:
    image: postgres:15-bookworm
    container_name: cve-2025-66489-db
    environment:
      POSTGRES_USER: unicorn_user
      POSTGRES_PASSWORD: magical_password
      POSTGRES_DB: calendso
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U unicorn_user -d calendso"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - lab-net

  vulnerable:
    build:
      context: .
      dockerfile: Dockerfile.vulnerable
    image: ghcr.io/exploitintel/cve-2025-66489-vulnerable:latest
    container_name: cve-2025-66489-vulnerable
    environment:
      DATABASE_URL: postgresql://unicorn_user:magical_password@cve-2025-66489-db:5432/calendso
      DATABASE_DIRECT_URL: postgresql://unicorn_user:magical_password@cve-2025-66489-db:5432/calendso
      DATABASE_HOST: cve-2025-66489-db:5432
      NEXTAUTH_SECRET: secret
      CALENDSO_ENCRYPTION_KEY: secret
      NEXT_PUBLIC_WEBAPP_URL: http://localhost:3000
      NEXTAUTH_URL: http://localhost:3000
      CALCOM_TELEMETRY_DISABLED: "1"
      NEXT_PUBLIC_LICENSE_CONSENT: "agree"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/auth/csrf"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    ports:
      - "3000:3000"
    networks:
      - lab-net

volumes:
  db-data:

networks:
  lab-net:
    driver: bridge
