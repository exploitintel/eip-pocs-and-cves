# Intel Brief: CVE-2024-37288

## CVE Metadata

- **CVE ID**: CVE-2024-37288
- **Title**: Elastic Kibana — Insecure YAML Deserialization in Integration Assistant
- **CVSS Score**: 9.9 (CRITICAL)
- **CVSS Vector**: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H
- **EPSS**: 1.6% (81.6th percentile)
- **CWE**: CWE-502 (Deserialization of Untrusted Data)
- **Published**: 2024-09-09

## Affected Software

- **Software**: Kibana
- **Vendor**: Elastic
- **Affected Versions**: 8.15.0
- **Fixed Version**: 8.15.1 (released 2024-09-05)
- **Component**: `x-pack/plugins/integration_assistant` (Integration Assistant / Automatic Import plugin)
- **Prerequisite Features**: Elastic Security AI tools enabled + Amazon Bedrock or OpenAI connector configured

## Description

A deserialization vulnerability exists in Kibana's Integration Assistant plugin due to the use of the unsafe `load()` function from the `js-yaml` library (v3.14.1). In js-yaml v3.x, the `load()` function supports dangerous YAML types by default, including `!!js/function`, `!!js/regexp`, and `!!js/undefined`, which can execute arbitrary JavaScript during YAML parsing.

When the Integration Assistant processes AI model responses to build ingest pipelines, it renders responses into a Nunjucks YAML template and then parses the result using the unsafe `load()`. If an attacker can influence the AI model's response (e.g., through prompt injection via crafted log samples), they can inject YAML payloads containing dangerous type tags that execute arbitrary code on the Kibana server.

## Repository

- **Repository URL**: https://github.com/elastic/kibana.git
- **Clone command used**: `git clone --depth 200 --branch v8.15.0 https://github.com/elastic/kibana.git source`
- **Current checkout**: Tag `v8.15.0` (commit `8aa0b59da12c996e3048d8875446667ee6e15c7f`)

## Vulnerable Version

- **Tag**: `v8.15.0`
- **Commit**: `8aa0b59da12c996e3048d8875446667ee6e15c7f`

## Fix Details

### Fix Commit (8.15 branch backport)
- **Commit**: `21877f5f9c556d54a6abc7256cbec07bc4861ef0`
- **Message**: `[8.15] Changing load/dump in source files (#190641) (#190991)`
- **Author**: Kurt (kc13greiner)
- **Date**: 2024-08-22

### Fix Commit (main branch)
- **Commit**: `bcc46b60e99ddb3c86f64f794296405064334335`
- **Message**: `Changing load/dump in source files (#190641)`
- **Date**: 2024-08-21

### Patched Version
- **Tag**: `v8.15.1`
- **Released**: 2024-09-05

### What the Fix Does

The fix replaces all unsafe `js-yaml` methods with their safe counterparts across the codebase:
- `load()` → `safeLoad()` (parsing: rejects dangerous YAML types)
- `dump()` → `safeDump()` (serialization: refuses to output dangerous types)

An ESLint rule (`no_unsafe_js_yaml`) was added to prevent regressions.

## Vulnerable Code Analysis

### Primary Vulnerable File
**Path**: `x-pack/plugins/integration_assistant/server/graphs/ecs/pipeline.ts`

```typescript
// Line 8 — imports the UNSAFE load function
import { load } from 'js-yaml';

// Line 175 — parses AI-influenced YAML with unsafe deserializer
const ingestPipeline = load(renderedTemplate) as IngestPipeline;
```

### Additional Vulnerable Files
1. **`x-pack/plugins/integration_assistant/server/util/samples.ts`** (line 206):
   - `yaml.dump()` → `yaml.safeDump()` (unsafe serialization)
2. **`x-pack/plugins/integration_assistant/server/integration_builder/pipeline.ts`** (line 14):
   - `yaml.dump()` → `yaml.safeDump()` (unsafe serialization)

### Attack Flow

1. **Entry Point**: Authenticated user sends POST to `/api/integration_assistant/ecs` (internal versioned API v1)
2. **Route Handler**: `x-pack/plugins/integration_assistant/server/routes/ecs_routes.ts`
   - Accepts `packageName`, `dataStreamName`, `rawSamples`, `connectorId`
   - Creates an AI model instance (Bedrock or OpenAI)
3. **Graph Execution**: `getEcsGraph(model)` builds a LangGraph state machine
   - `modelInput()` prepares samples and sends them to the AI model
   - `handleEcsMapping()` gets ECS mapping from AI — **attacker-influenced via prompt injection in rawSamples**
   - `modelOutput()` calls `createPipeline(state)` with the AI-generated mapping
4. **Vulnerable Function**: `createPipeline()` in `pipeline.ts`
   - Generates processor objects from `state.currentMapping` (AI model output)
   - Renders a Nunjucks template (`pipeline.yml.njk`) with AI-derived values
   - **Parses the rendered YAML string with unsafe `load()`**
5. **Code Execution**: If the rendered YAML contains `!!js/function` or similar tags, arbitrary JavaScript executes in the Kibana Node.js process

### js-yaml v3 Dangerous Types
The `load()` function in js-yaml v3.14.1 (DEFAULT_FULL_SCHEMA) supports:
- `!!js/function` — Arbitrary JavaScript function instantiation and execution
- `!!js/regexp` — Regular expression creation (ReDoS potential)
- `!!js/undefined` — Undefined value creation

**Example payload**: `!!js/function 'function(){ return require("child_process").execSync("id").toString() }'`

## Build System

- **Language**: TypeScript (Node.js)
- **Build System**: Yarn (v1.22.19) + Bazel
- **Node.js Version**: 20.15.1
- **Package Manager**: `yarn` (lockfile: `yarn.lock`)
- **js-yaml version**: `^3.14.1` (in root `package.json`)
- **Plugin framework**: Kibana plugin system (`@kbn/*` packages)

### Key Dependencies
- `js-yaml` v3.14.1 — The vulnerable YAML parser
- `nunjucks` — Template engine used to render YAML templates
- `@langchain/langgraph` — LangGraph for AI workflow orchestration
- `@kbn/langchain` — Kibana's LangChain integration (Bedrock, OpenAI connectors)
- Elasticsearch 8.15.0 — Required backend

### Docker Images Available
- **Vulnerable**: `docker.elastic.co/kibana/kibana:8.15.0` or `kibana:8.15.0`
- **Patched**: `docker.elastic.co/kibana/kibana:8.15.1` or `kibana:8.15.1`
- **Elasticsearch**: `docker.elastic.co/elasticsearch/elasticsearch:8.15.0` or `elasticsearch:8.15.0`

## Lab Environment Notes

### Minimal Lab Setup
A PoC lab needs:
1. **Elasticsearch 8.15.0** — Backend data store
2. **Kibana 8.15.0** — Vulnerable application (with `xpack.integration_assistant.enabled: true`)
3. **Enterprise license** — The Integration Assistant requires an Enterprise license (can use trial)
4. **AI Connector** — A configured Amazon Bedrock or OpenAI connector (can be mocked)

### Mitigation (without upgrade)
Disable the integration assistant by setting in `kibana.yml`:
```yaml
xpack.integration_assistant.enabled: false
```

### PoC Strategy
The most practical PoC approach is to:
1. Deploy Kibana 8.15.0 + Elasticsearch 8.15.0 via Docker
2. Activate trial license for Enterprise features
3. **Option A (Direct)**: Craft a standalone script that demonstrates `js-yaml` v3's unsafe `load()` executing arbitrary code with a `!!js/function` payload — proves the deserialization primitive
4. **Option B (End-to-end)**: Set up a mock AI connector that returns crafted YAML responses containing `!!js/function` payloads, then trigger the ECS mapping flow via the `/api/integration_assistant/ecs` API endpoint

Option A is simpler and clearly demonstrates the vulnerability. Option B provides full end-to-end validation but requires complex AI connector mocking.

## Public Exploits

**None found.** No public PoC exploits exist on ExploitDB, GitHub, or Metasploit for CVE-2024-37288.

## References

1. **Elastic Advisory**: https://discuss.elastic.co/t/kibana-8-15-1-security-update-esa-2024-27-esa-2024-28/366119
2. **GHSA**: https://github.com/advisories/GHSA-ph9f-2c4w-rghv
3. **NVD**: https://nvd.nist.gov/vuln/detail/CVE-2024-37288
4. **Fix PR (main)**: https://github.com/elastic/kibana/pull/190641
5. **Fix PR (8.15 backport)**: https://github.com/elastic/kibana/pull/190991
6. **Kibana Source**: https://github.com/elastic/kibana
7. **js-yaml v3 docs**: https://github.com/nodeca/js-yaml/tree/v3.14.1
8. **Elastic AI Tools docs**: https://www.elastic.co/guide/en/security/current/ai-for-security.html
9. **Bedrock Connector docs**: https://www.elastic.co/guide/en/security/current/assistant-connect-to-bedrock.html
