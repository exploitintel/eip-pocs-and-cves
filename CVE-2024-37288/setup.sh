#!/bin/sh
set -e

ES_URL="http://cve-2024-37288-es:9200"
ES_USER="elastic"
ES_PASS="changeme"

echo "=== CVE-2024-37288 Lab Setup ==="

# 1. Activate trial license (enables Enterprise features including Integration Assistant)
echo "[1/3] Activating trial license..."
TRIAL_RESULT=$(curl -s -u "${ES_USER}:${ES_PASS}" -X POST "${ES_URL}/_license/start_trial?acknowledge=true" -H "Content-Type: application/json")
echo "Trial license result: ${TRIAL_RESULT}"

# 2. Verify license is active
echo "[2/3] Verifying license..."
LICENSE=$(curl -s -u "${ES_USER}:${ES_PASS}" "${ES_URL}/_license")
echo "License info: ${LICENSE}"

# 3. Verify Kibana is healthy and Integration Assistant plugin is loaded
echo "[3/3] Verifying Kibana status..."
KIBANA_STATUS=$(curl -s "http://cve-2024-37288-kibana:5601/api/status")
echo "Kibana status retrieved."

echo ""
echo "=== Lab Setup Complete ==="
echo "Elasticsearch: ${ES_URL} (user: ${ES_USER}, pass: ${ES_PASS})"
echo "Kibana: http://cve-2024-37288-kibana:5601"
echo "Credentials: elastic / changeme"
echo ""
echo "Integration Assistant API endpoint:"
echo "  POST /api/integration_assistant/ecs"
echo "  Headers: kbn-xsrf: true, elastic-api-version: 1"
echo ""
