# CVE-2026-28417 - Vim netrw OS Command Injection
# Builds Vim v9.2.0072 (vulnerable) from source
FROM debian:bookworm-slim AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    make \
    libc6-dev \
    libncurses5-dev \
    git \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Clone Vim source and checkout vulnerable version
RUN git clone --depth=1 --branch v9.2.0072 https://github.com/vim/vim.git /vim-src

WORKDIR /vim-src/src

# Build Vim with normal features (needed for autoload/packadd)
RUN ./configure \
    --with-features=normal \
    --disable-gui \
    --without-x \
    --prefix=/usr/local \
    && make -j$(nproc) \
    && make install DESTDIR=/vim-install

# --- Runtime stage ---
FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# Install minimal runtime dependencies
# openssh-client is REQUIRED: netrw checks for ssh/scp executables and
# refuses to construct remote commands if they're missing (g:netrw_list_cmd empty).
# The vulnerability triggers during shell command construction, so ssh must be on PATH.
RUN apt-get update && apt-get install -y --no-install-recommends \
    libncurses6 \
    libtinfo6 \
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Copy built Vim
COPY --from=builder /vim-install/usr/local /usr/local

# Copy the runtime files (syntax, plugins, etc.) from source
COPY --from=builder /vim-src/runtime /usr/local/share/vim/vim92/

# Verify netrw plugin is in place
RUN test -f /usr/local/share/vim/vim92/pack/dist/opt/netrw/autoload/netrw.vim \
    && echo "netrw plugin found" || (echo "netrw plugin missing!" && exit 1)

# Set up a clean environment
ENV TERM=xterm-256color
ENV HOME=/root

# Create a minimal vimrc that doesn't interfere but ensures netrw can load
RUN echo "" > /root/.vimrc

WORKDIR /workspace

# Keep container running for interactive testing
CMD ["sleep", "infinity"]
