# Intel Brief: CVE-2026-28417

## CVE ID
CVE-2026-28417

## Affected Software
- **Name:** Vim (netrw plugin)
- **Vendor:** Vim Project (Bram Moolenaar / Christian Brabandt)
- **Affected Versions:** All Vim versions prior to 9.2.0073 (patch level 73)
- **Component:** `runtime/pack/dist/opt/netrw/autoload/netrw.vim` — the bundled netrw file browser plugin

## CVSS Score
- **Score:** 4.4 (Medium)
- **Vector:** CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N
- **Attack Vector:** Local
- **Attack Complexity:** Low
- **Privileges Required:** None
- **User Interaction:** Required

## CWE Classification
- **CWE-78:** Improper Neutralization of Special Elements used in an OS Command (OS Command Injection)
- **Also referenced as CWE-86** in NVD

## Description
An OS command injection vulnerability exists in the `netrw` standard plugin bundled with Vim. The `s:NetrwValidateHostname()` function uses an insufficiently strict regular expression that only checks whether the hostname starts with an alphanumeric character (`'^[a-z0-9]'`), without anchoring the end or restricting the allowed character set. This allows shell metacharacters (e.g., `;`, `$()`, backticks) to be included in the hostname portion of netrw URIs (e.g., `scp://`, `ftp://`).

Additionally, the `s:MakeSshCmd()` function directly substitutes the hostname and port values into shell commands without escaping, allowing injected metacharacters to be interpreted by the shell when Vim executes external commands (like `scp` or `ssh`).

**Attack scenario:** An attacker crafts a malicious URL such as `scp://x;touch RCE;x/dir/` and induces a user to open it in Vim (e.g., `vim scp://x;touch RCE;x/dir/`). The semicolons break out of the SSH command and execute arbitrary shell commands with the privileges of the Vim process.

### Root Cause (Two-Part Vulnerability)

**Part 1 — Weak hostname validation (`s:NetrwValidateHostname`):**
```vim
" VULNERABLE (line 2597-2600 of netrw.vim):
function s:NetrwValidateHostname(hostname)
    return a:hostname =~? '^[a-z0-9]'
endfunction
```
Only checks that the first character is alphanumeric. A hostname like `x;touch RCE;x` passes validation because it starts with `x`.

**Part 2 — Unescaped shell substitution (`s:MakeSshCmd`):**
```vim
" VULNERABLE (line 8963-8977 of netrw.vim):
function s:MakeSshCmd(sshcmd)
    if s:user == ""
        let sshcmd = substitute(a:sshcmd,'\<HOSTNAME\>',s:machine,'')
    else
        let sshcmd = substitute(a:sshcmd,'\<HOSTNAME\>',s:user."@".s:machine,'')
    endif
    if exists("g:netrw_port") && g:netrw_port != ""
        let sshcmd= substitute(sshcmd,"USEPORT",g:netrw_sshport.' '.g:netrw_port,'')
    elseif exists("s:port") && s:port != ""
        let sshcmd= substitute(sshcmd,"USEPORT",g:netrw_sshport.' '.s:port,'')
    else
        let sshcmd= substitute(sshcmd,"USEPORT ",'','')
    endif
    return sshcmd
endfunction
```
The hostname (`s:machine`) and port (`g:netrw_port`, `s:port`) are substituted directly into shell command strings without `shellescape()`.

## Repository URL
- **URL:** https://github.com/vim/vim.git
- **Clone:** `git clone https://github.com/vim/vim.git`

## Vulnerable Version
- **Tag:** `v9.2.0072`
- **Commit:** `1da9d1381f9359652459d4864ac673ff341dafd3`

## Fix Commit
- **Hash:** `79348dbbc09332130f4c86045e1541d68514fcc1`
- **Author:** Christian Brabandt
- **Date:** Sun Feb 22 21:24:48 2026 +0000
- **Message:** `patch 9.2.0073: [security]: possible command injection using netrw`
- **Credits:** ehdgks0627, un3xploitable

### Fix Details
The fix addresses both parts of the vulnerability:

1. **Stricter hostname validation:** Rewrites `s:NetrwValidateHostname()` with proper RFC1123-compliant patterns:
   - Hostname pattern: `[a-zA-Z0-9]([-a-zA-Z0-9.]{,62}[a-zA-Z0-9])?` (anchored, no metacharacters)
   - IPv4 pattern: `(\d{1,3}\.){3}\d{1,3}`
   - IPv6 pattern: `[?([a-fA-F0-9:]{2,})+]?`
   - Optional user prefix: `([a-zA-Z0-9._-]+@)?`

2. **Shell escaping:** Uses `shellescape()` on hostname, username, and port in `s:MakeSshCmd()`:
   ```vim
   let machine = shellescape(s:machine, 1)
   let machine = shellescape(s:user, 1).'@'.machine
   let sshcmd = substitute(sshcmd,"USEPORT",g:netrw_sshport.' '.shellescape(g:netrw_port,1),'')
   ```

### Files Changed
- `runtime/pack/dist/opt/netrw/autoload/netrw.vim` — validation + escaping fix
- `src/testdir/test_plugin_netrw.vim` — added `Test_netrw_reject_evil_hostname()` test
- `src/version.c` — added patch 73 to included_patches

## Patched Version
- **Tag:** `v9.2.0073`
- **Commit:** `79348dbbc09332130f4c86045e1541d68514fcc1` (same as fix commit)

## Build System
- **Type:** Autotools (configure/make)
- **Primary Language:** C (Vim core) + VimL/Vimscript (netrw plugin)
- **Build commands:**
  ```bash
  cd src/
  ./configure --with-features=normal --disable-gui --without-x
  make
  ```
- **Key Dependencies:**
  - C compiler (gcc)
  - ncurses/termlib (terminal library)
  - make
  - No GUI dependencies needed for this vulnerability (CLI-only suffices)
- **Note:** The vulnerability is in the VimL plugin file (`netrw.vim`), not in the C source. The plugin is loaded at runtime by Vim. Building Vim from source is needed to get the specific vulnerable version, but the actual vulnerable code is the VimL script.

## Public Exploits

### EIP Exploit #123238 (Writeup/Patch)
- **Classification:** `writeup` (the patch commit itself, not a standalone PoC)
- **Attack Type:** RCE
- **Complexity:** Moderate
- **Reliability:** Reliable
- **Safety:** Clean (no trojan indicators)
- **Content:** The fix patch from commit `79348dbbc09332130f4c860`, which includes a test case showing the PoC:
  ```vim
  func Test_netrw_reject_evil_hostname()
    let msg = execute(':e scp://x;touch RCE;x/dir/')
    let msg = split(msg, "\n")[-1]
    call assert_match('Rejecting invalid hostname', msg)
  endfunction
  ```
- **No standalone PoC scripts found** — a PoC will need to be written from scratch

### PoC Strategy
The simplest PoC approach:
1. Build vulnerable Vim (v9.2.0072) from source
2. Run: `vim -c ':e scp://x;touch /tmp/pwned;x/file.txt' -c ':q'`
3. Alternatively: `vim 'scp://x;touch /tmp/pwned;x/file.txt'`
4. Verify command execution by checking for `/tmp/pwned`

The netrw plugin will parse the hostname `x;touch /tmp/pwned;x`, pass it through the weak validation (starts with alphanumeric `x`), and then substitute it unescaped into an SSH/SCP command that gets executed via `system()`.

## References
1. **Fix Commit:** https://github.com/vim/vim/commit/79348dbbc09332130f4c86045e1541d68514fcc1
2. **Release Notes:** https://github.com/vim/vim/releases/tag/v9.2.0073
3. **GitHub Security Advisory:** https://github.com/vim/vim/security/advisories/GHSA-m3xh-9434-g336
4. **MITRE ATT&CK Techniques:**
   - T1190 — Exploit Public-Facing Application
   - T1059 — Command and Scripting Interpreter
   - T1203 — Exploitation for Client Execution

## Lab Notes for Downstream Agents

### For Lab Build Agent:
- Build Vim v9.2.0072 from source with minimal features (`--with-features=normal --disable-gui --without-x`)
- Ensure `netrw` plugin is available at runtime (it's bundled in `runtime/pack/dist/opt/netrw/`)
- The container needs basic tools: gcc, make, ncurses-dev
- No network services needed — this is a local attack triggered by opening a crafted URL

### For PoC Agent:
- The vulnerability is triggered by opening a crafted netrw URI in Vim
- The injection point is the hostname field in `scp://`, `sftp://`, `ftp://` URLs
- The weak regex `'^[a-z0-9]'` only checks the first character
- Shell metacharacters (`;`, `$(...)`, backticks) in the hostname are passed unescaped to `system()`
- The PoC from the test suite uses: `scp://x;touch RCE;x/dir/`
- For a clean PoC, use: `scp://a$(touch /tmp/pwned)/file.txt` or `scp://x;touch /tmp/pwned;x/file.txt`
- The command injection happens in `s:MakeSshCmd()` when it constructs the SSH/SCP command
- Vim must be invoked in a way that triggers netrw to process the URL (`:e scp://...` or passing the URL as a file argument)
