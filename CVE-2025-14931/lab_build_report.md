# Lab Build Report: CVE-2025-14931

## Lab Architecture

The lab reproduces CVE-2025-14931 — an unsafe `pickle.loads()` deserialization vulnerability in Hugging Face smolagents v1.24.0 (`RemotePythonExecutor` / `_websocket_run_code_raise_errors()`). The architecture uses two containers:

1. **malicious-server** — A fake Jupyter Kernel Gateway that returns crafted malicious pickle payloads inside `FinalAnswerException` WebSocket error messages.
2. **victim** — A Python 3.12 container with `smolagents==1.24.0` installed, containing the vulnerable `_websocket_run_code_raise_errors()` function that calls `pickle.loads(base64.b64decode(evalue))` on untrusted data from the server.

The attack flow:
1. The victim connects to the malicious server's Jupyter Kernel Gateway API (HTTP + WebSocket)
2. The victim sends a code execution request over WebSocket
3. The malicious server responds with a `FinalAnswerException` error containing a base64-encoded malicious pickle payload
4. The victim's `_websocket_run_code_raise_errors()` at line 309 calls `pickle.loads(base64.b64decode(evalue))` on the payload
5. The pickle `__reduce__` protocol executes `os.system()` on the victim — **arbitrary code execution**

## Container Details

### malicious-server
| Field | Value |
|-------|-------|
| **Container Name** | `cve-2025-14931-malicious-server` |
| **Image** | `cve-2025-14931-malicious-server` (built from `Dockerfile.malicious-server`) |
| **Base Image** | `python:3.12-slim-bookworm` |
| **Role** | Attacker — fake Jupyter Kernel Gateway |
| **Port** | 8888 (HTTP + WebSocket) |
| **Networks** | `lab-net` |
| **Key Dependencies** | `aiohttp==3.11.13` |
| **Healthcheck** | HTTP GET `/api/kernelspecs` (interval=3s, retries=10) |
| **Environment Variables** | `PICKLE_COMMAND` (shell command to execute via RCE), `HOST`, `PORT` |

### victim
| Field | Value |
|-------|-------|
| **Container Name** | `cve-2025-14931-victim` |
| **Image** | `cve-2025-14931-victim` (built from `Dockerfile.victim`) |
| **Base Image** | `python:3.12-slim-bookworm` |
| **Role** | Victim — smolagents v1.24.0 with vulnerable `pickle.loads()` |
| **Networks** | `lab-net` |
| **Key Dependencies** | `smolagents==1.24.0`, `websocket-client>=1.6.0` |
| **CMD** | `sleep infinity` (kept alive for exec) |

## Network Configuration

| Network | Type | Purpose |
|---------|------|---------|
| `lab-net` | bridge | Container-to-container communication (victim ↔ malicious-server) |

## Build Status

| Container | Build Status | Notes |
|-----------|-------------|-------|
| malicious-server | ✅ SUCCESS | aiohttp installed, server starts and responds to healthchecks |
| victim | ✅ SUCCESS | smolagents==1.24.0 installed, vulnerable `pickle.loads()` path confirmed at build time |

## Start/Stop Commands

```bash
# Start lab
docker compose build
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs

# Stop lab
docker compose down
```

## Verification

### 1. Containers Running and Healthy
```
NAME                              IMAGE                             STATUS                   PORTS
cve-2025-14931-malicious-server   cve-2025-14931-malicious-server   Up (healthy)             8888/tcp
cve-2025-14931-victim             cve-2025-14931-victim             Up                       
```

### 2. Vulnerable Software Confirmed
```
smolagents version: 1.24.0
VULNERABLE LINE: result = pickle.loads(base64.b64decode(msg_content.get("evalue", "")))
```

### 3. End-to-End Exploit Verified
The trigger exploit script was run inside the victim container:
```
[+] Server is ready (HTTP 200)
[+] Kernel created: b5bd99f5-7cac-46c4-af17-03a17e1bcc03
[+] WebSocket connected
[+] Code execution returned: CodeOutput(output=0, logs='', is_final_answer=True)
[+] is_final_answer: True
[!!!] RCE CONFIRMED — marker file /tmp/pwned exists!
[!!!] pickle.loads() executed attacker's code on the client!
```

**Marker files on victim:**
- `/tmp/pwned` — created by `touch /tmp/pwned`
- `/tmp/rce_proof.txt` — contains `RCE_SUCCESS`

### 4. Server-Side Attack Logs
```
[WS] Execute request received, code length=14
[WS] Sending malicious FinalAnswerException with pickle payload...
[WS] ✓ Malicious error message sent
[WS] ✓ Idle status message sent
[WS] ✓ Attack payload delivered — client will now call pickle.loads()
```

## Lab Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Orchestration for both containers |
| `Dockerfile.malicious-server` | Builds the fake Jupyter Kernel Gateway |
| `Dockerfile.victim` | Builds the victim with smolagents v1.24.0 |
| `malicious_server.py` | Malicious server that crafts pickle RCE payloads |
| `trigger_exploit.py` | PoC trigger script that exercises the vulnerable code path |

## Known Issues

None. The lab is fully functional and the exploit triggers reliably.
