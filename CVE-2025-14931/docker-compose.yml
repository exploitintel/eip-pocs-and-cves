##
## CVE-2025-14931 Lab — smolagents pickle deserialization RCE
##
## Architecture:
##   malicious-server  → Fake Jupyter Kernel Gateway serving crafted pickle payloads
##   victim            → smolagents v1.24.0 client (vulnerable to pickle.loads RCE)
##
## Usage:
##   docker compose build
##   docker compose up -d
##   docker compose down
##

services:
  malicious-server:
    build:
      context: .
      dockerfile: Dockerfile.malicious-server
    container_name: cve-2025-14931-malicious-server
    environment:
      - PICKLE_COMMAND=touch /tmp/pwned && echo RCE_SUCCESS > /tmp/rce_proof.txt
      - HOST=0.0.0.0
      - PORT=8888
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8888/api/kernelspecs')"]
      interval: 3s
      timeout: 2s
      retries: 10
    networks:
      - lab-net

  victim:
    build:
      context: .
      dockerfile: Dockerfile.victim
    container_name: cve-2025-14931-victim
    depends_on:
      malicious-server:
        condition: service_healthy
    environment:
      # Point the victim at the malicious server (container name resolves on lab-net)
      - MALICIOUS_SERVER_HOST=cve-2025-14931-malicious-server
      - MALICIOUS_SERVER_PORT=8888
    networks:
      - lab-net

networks:
  lab-net:
    driver: bridge
