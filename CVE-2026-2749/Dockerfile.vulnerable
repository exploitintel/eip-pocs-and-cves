# CVE-2026-2749 Lab - Centreon Open Tickets Path Traversal
# Minimal PHP 8.2 + Apache reproduction of the vulnerable upload/remove endpoints

FROM php:8.2-apache-bookworm

# Enable Apache rewrite module and set ServerName to suppress warnings
RUN a2enmod rewrite \
    && echo "ServerName localhost" >> /etc/apache2/apache2.conf

# Configure PHP for file uploads
RUN { \
    echo "file_uploads = On"; \
    echo "upload_max_filesize = 10M"; \
    echo "post_max_size = 12M"; \
    echo "upload_tmp_dir = /tmp"; \
    echo "session.save_handler = files"; \
    echo "session.save_path = /tmp"; \
    } > /usr/local/etc/php/conf.d/uploads.ini

# Set up the Centreon-like directory structure
# Mirrors: /usr/share/centreon/www/modules/centreon-open-tickets/...
RUN mkdir -p /var/www/html/centreon/modules/centreon-open-tickets/views/rules/ajax/actions \
    && mkdir -p /tmp/opentickets \
    && chmod 777 /tmp/opentickets

# ---- Vulnerable PHP files (copied directly from source) ----

# Copy the original vulnerable uploadFile.php (no modifications)
COPY vulnerable/uploadFile.php /var/www/html/centreon/modules/centreon-open-tickets/views/rules/ajax/actions/uploadFile.php

# Copy the original vulnerable removeFile.php (no modifications)
COPY vulnerable/removeFile.php /var/www/html/centreon/modules/centreon-open-tickets/views/rules/ajax/actions/removeFile.php

# ---- Minimal call.php router (preserves vulnerable routing, mocks Centreon deps) ----
COPY vulnerable/call.php /var/www/html/centreon/modules/centreon-open-tickets/views/rules/ajax/call.php

# ---- Mock login endpoint (simulates Centreon authentication) ----
COPY vulnerable/login.php /var/www/html/centreon/login.php

# ---- Health check / info endpoint ----
COPY vulnerable/index.php /var/www/html/centreon/index.php

# Apache config: route /centreon/ to the right docroot
COPY vulnerable/centreon.conf /etc/apache2/sites-available/centreon.conf
RUN a2ensite centreon.conf

# Ensure www-data owns the web root for realistic permissions
RUN chown -R www-data:www-data /var/www/html/centreon \
    && chmod -R 755 /var/www/html/centreon

EXPOSE 80

CMD ["apache2-foreground"]
