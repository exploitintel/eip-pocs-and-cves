<?php

/*
 * Minimal call.php router for CVE-2026-2749 lab reproduction.
 *
 * This is a simplified version of the original Centreon Open Tickets call.php
 * that preserves the vulnerable routing logic but removes Centreon class
 * dependencies (database, DI container, etc.) that are not relevant to the
 * vulnerability.
 *
 * The original call.php:
 * 1. Requires Centreon class files (DB, Rule, providers, etc.)
 * 2. Starts a session
 * 3. Checks $_SESSION['centreon'] for authentication
 * 4. Parses action from POST data or REQUEST params
 * 5. Routes to the action file via include
 *
 * This minimal version preserves steps 2-5 exactly as the original.
 */

session_start();

// Authentication check â€” identical to original call.php
if (isset($_SESSION['centreon'])) {
    $centreon = $_SESSION['centreon'];
} else {
    exit;
}

$resultat = ['code' => 0, 'msg' => ''];
$actions = [
    'upload-file'  => __DIR__ . '/actions/uploadFile.php',
    'remove-file'  => __DIR__ . '/actions/removeFile.php',
];

if (! isset($_POST['data']) && ! isset($_REQUEST['action'])) {
    $resultat = ['code' => 1, 'msg' => "POST 'data' needed."];
} else {
    $get_information = isset($_POST['data']) ? json_decode($_POST['data'], true) : null;
    $action = ! is_null($get_information) && isset($get_information['action'])
        ? $get_information['action'] : ($_REQUEST['action'] ?? 'none');
    if (! isset($actions[$action])) {
        $resultat = ['code' => 1, 'msg' => 'Action not good.'];
    } else {
        include $actions[$action];
    }
}

header('Content-type: text/plain');
echo json_encode($resultat);
