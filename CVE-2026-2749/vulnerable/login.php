<?php

/*
 * Mock Centreon login endpoint for CVE-2026-2749 lab.
 *
 * In a real Centreon installation, authentication is handled by the Centreon
 * web application which sets $_SESSION['centreon'] to a Centreon user object.
 *
 * For this lab, we simulate authentication by setting $_SESSION['centreon']
 * to a truthy value (stdClass object with basic properties) when valid
 * credentials are provided.
 *
 * Default credentials: admin / Centreon!2021
 *
 * Usage:
 *   POST /centreon/login.php
 *   Content-Type: application/x-www-form-urlencoded
 *   Body: useralias=admin&password=Centreon!2021
 *
 * Returns: JSON with session status and PHPSESSID cookie
 */

session_start();

header('Content-Type: application/json');

// Handle GET — show login status
if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    echo json_encode([
        'authenticated' => isset($_SESSION['centreon']),
        'session_id' => session_id(),
        'info' => 'POST with useralias=admin&password=Centreon!2021 to authenticate'
    ]);
    exit;
}

// Handle POST — authenticate
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['useralias'] ?? '';
    $password = $_POST['password'] ?? '';

    if ($username === 'admin' && $password === 'Centreon!2021') {
        // Simulate Centreon session — the vulnerable code only checks
        // isset($_SESSION['centreon']), so any truthy value works
        $centreon = new stdClass();
        $centreon->user = new stdClass();
        $centreon->user->alias = 'admin';
        $centreon->user->admin = 1;
        $_SESSION['centreon'] = $centreon;

        echo json_encode([
            'status' => 'ok',
            'authenticated' => true,
            'session_id' => session_id(),
            'message' => 'Login successful. Use the PHPSESSID cookie for subsequent requests.'
        ]);
    } else {
        http_response_code(401);
        echo json_encode([
            'status' => 'error',
            'authenticated' => false,
            'message' => 'Invalid credentials. Use admin / Centreon!2021'
        ]);
    }
    exit;
}

http_response_code(405);
echo json_encode(['error' => 'Method not allowed']);
