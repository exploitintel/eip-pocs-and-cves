#!/bin/bash
# Setup script for CVE-2025-24490 Mattermost lab
# Creates initial admin user, team, installs focalboard plugin, and verifies it's active
set -e

MM_URL="${1:-http://localhost:8065}"
ADMIN_USER="admin"
ADMIN_PASS="Admin123!@#"
ADMIN_EMAIL="admin@test.local"
TEAM_NAME="testteam"
TEAM_DISPLAY="Test Team"
CONTAINER_NAME="cve-2025-24490-mattermost"

echo "[*] Mattermost Lab Setup for CVE-2025-24490"
echo "[*] Target: $MM_URL"

# Wait for Mattermost to be healthy
echo "[*] Waiting for Mattermost to be ready..."
MAX_WAIT=180
WAITED=0
while [ $WAITED -lt $MAX_WAIT ]; do
    STATUS=$(curl -sf "$MM_URL/api/v4/system/ping" 2>/dev/null | jq -r '.status // empty' 2>/dev/null || true)
    if [ "$STATUS" = "OK" ]; then
        echo "[+] Mattermost is ready!"
        break
    fi
    sleep 3
    WAITED=$((WAITED + 3))
    if [ $((WAITED % 15)) -eq 0 ]; then
        echo "    ...waiting ($WAITED/$MAX_WAIT seconds)"
    fi
done

if [ $WAITED -ge $MAX_WAIT ]; then
    echo "[-] Mattermost did not become ready in time"
    exit 1
fi

# Create admin user (first user becomes system admin)
echo "[*] Creating admin user: $ADMIN_USER"
CREATE_RESP=$(curl -sf -X POST "$MM_URL/api/v4/users" \
    -H "Content-Type: application/json" \
    -d "{\"email\": \"$ADMIN_EMAIL\", \"username\": \"$ADMIN_USER\", \"password\": \"$ADMIN_PASS\"}" 2>/dev/null || true)

USER_ID=$(echo "$CREATE_RESP" | jq -r '.id // empty' 2>/dev/null || true)
if [ -z "$USER_ID" ]; then
    echo "[!] User may already exist, attempting login..."
fi

# Login
echo "[*] Logging in as $ADMIN_USER..."
LOGIN_RESP=$(curl -sf -D - -X POST "$MM_URL/api/v4/users/login" \
    -H "Content-Type: application/json" \
    -d "{\"login_id\": \"$ADMIN_USER\", \"password\": \"$ADMIN_PASS\"}" 2>/dev/null)

TOKEN=$(echo "$LOGIN_RESP" | grep -i '^Token:' | tr -d '\r' | awk '{print $2}')
if [ -z "$TOKEN" ]; then
    echo "[-] Failed to login"
    echo "$LOGIN_RESP"
    exit 1
fi
echo "[+] Got auth token: ${TOKEN:0:10}..."

# Get user ID if not from creation
if [ -z "$USER_ID" ]; then
    USER_ID=$(curl -sf "$MM_URL/api/v4/users/me" \
        -H "Authorization: Bearer $TOKEN" | jq -r '.id' 2>/dev/null)
fi
echo "[+] User ID: $USER_ID"

# Create team
echo "[*] Creating team: $TEAM_NAME"
TEAM_RESP=$(curl -sf -X POST "$MM_URL/api/v4/teams" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"name\": \"$TEAM_NAME\", \"display_name\": \"$TEAM_DISPLAY\", \"type\": \"O\"}" 2>/dev/null || true)

TEAM_ID=$(echo "$TEAM_RESP" | jq -r '.id // empty' 2>/dev/null || true)
if [ -z "$TEAM_ID" ]; then
    echo "[!] Team may already exist, looking it up..."
    TEAM_ID=$(curl -sf "$MM_URL/api/v4/teams/name/$TEAM_NAME" \
        -H "Authorization: Bearer $TOKEN" | jq -r '.id' 2>/dev/null)
fi
echo "[+] Team ID: $TEAM_ID"

# Install and enable focalboard plugin
echo "[*] Checking boards plugin (focalboard)..."
PLUGINS_JSON=$(curl -sf "$MM_URL/api/v4/plugins" -H "Authorization: Bearer $TOKEN" 2>/dev/null)

FOCALBOARD_ACTIVE=$(echo "$PLUGINS_JSON" | jq -r '.active[]? | select(.id == "focalboard") | .id' 2>/dev/null || true)
FOCALBOARD_INACTIVE=$(echo "$PLUGINS_JSON" | jq -r '.inactive[]? | select(.id == "focalboard") | .id' 2>/dev/null || true)

if [ "$FOCALBOARD_ACTIVE" = "focalboard" ]; then
    FOCALBOARD_VERSION=$(echo "$PLUGINS_JSON" | jq -r '.active[]? | select(.id == "focalboard") | .version' 2>/dev/null || true)
    echo "[+] Focalboard plugin already ACTIVE - version: $FOCALBOARD_VERSION"
elif [ "$FOCALBOARD_INACTIVE" = "focalboard" ]; then
    echo "[*] Focalboard found but inactive, enabling..."
    curl -sf -X POST "$MM_URL/api/v4/plugins/focalboard/enable" \
        -H "Authorization: Bearer $TOKEN" 2>/dev/null
    echo "[+] Focalboard plugin enabled"
else
    echo "[*] Focalboard not installed. Installing from prepackaged..."

    # Upload the prepackaged focalboard plugin via the Mattermost API
    UPLOAD_RESP=$(docker exec "$CONTAINER_NAME" curl -sf -X POST \
        "http://localhost:8065/api/v4/plugins" \
        -H "Authorization: Bearer $TOKEN" \
        -F "plugin=@/mattermost/prepackaged_plugins/focalboard-v8.0.0-linux-amd64.tar.gz" \
        -F "force=true" 2>/dev/null)

    FB_ID=$(echo "$UPLOAD_RESP" | jq -r '.id // empty' 2>/dev/null || true)
    if [ "$FB_ID" = "focalboard" ]; then
        echo "[+] Focalboard plugin uploaded successfully (v8.0.0)"
    else
        echo "[-] Failed to upload focalboard plugin"
        echo "    Response: $UPLOAD_RESP"
        exit 1
    fi

    # Enable the plugin
    echo "[*] Enabling focalboard plugin..."
    ENABLE_RESP=$(curl -sf -X POST "$MM_URL/api/v4/plugins/focalboard/enable" \
        -H "Authorization: Bearer $TOKEN" 2>/dev/null)
    echo "[+] Focalboard plugin enabled: $ENABLE_RESP"

    # Wait for plugin to fully initialize
    echo "[*] Waiting for focalboard to initialize..."
    sleep 5
fi

# Verify focalboard is active
PLUGINS_JSON=$(curl -sf "$MM_URL/api/v4/plugins" -H "Authorization: Bearer $TOKEN" 2>/dev/null)
FOCALBOARD_VERSION=$(echo "$PLUGINS_JSON" | jq -r '.active[]? | select(.id == "focalboard") | .version' 2>/dev/null || true)
if [ -n "$FOCALBOARD_VERSION" ]; then
    echo "[+] Focalboard plugin is ACTIVE - version: $FOCALBOARD_VERSION"
else
    echo "[-] WARNING: Focalboard plugin is NOT active after installation attempt"
fi

# Verify the boards API is accessible
echo "[*] Testing boards API..."
BOARDS_HTTP=$(curl -sf -o /dev/null -w "%{http_code}" \
    "$MM_URL/plugins/focalboard/api/v2/teams/$TEAM_ID/categories" \
    -H "Authorization: Bearer $TOKEN" \
    -H "X-Requested-With: XMLHttpRequest" 2>/dev/null || echo "000")

if [ "$BOARDS_HTTP" = "200" ]; then
    echo "[+] Boards API is accessible (HTTP 200)"
    CATEGORIES=$(curl -sf "$MM_URL/plugins/focalboard/api/v2/teams/$TEAM_ID/categories" \
        -H "Authorization: Bearer $TOKEN" \
        -H "X-Requested-With: XMLHttpRequest" 2>/dev/null | jq length 2>/dev/null || echo "?")
    echo "[+] User has $CATEGORIES board categories"
else
    echo "[-] Boards API returned HTTP $BOARDS_HTTP"
fi

echo ""
echo "========================================="
echo "  CVE-2025-24490 Lab Setup Complete"
echo "========================================="
echo "  URL:       $MM_URL"
echo "  Username:  $ADMIN_USER"
echo "  Password:  $ADMIN_PASS"
echo "  User ID:   $USER_ID"
echo "  Team ID:   $TEAM_ID"
echo "  Team Name: $TEAM_NAME"
echo "  Token:     $TOKEN"
echo "  Plugin:    focalboard v$FOCALBOARD_VERSION"
echo "========================================="
echo ""
echo "Vulnerable endpoints:"
echo "  PUT $MM_URL/plugins/focalboard/api/v2/teams/$TEAM_ID/categories/reorder"
echo "  PUT $MM_URL/plugins/focalboard/api/v2/teams/$TEAM_ID/categories/{categoryID}/boards/reorder"
echo ""
echo "Required headers:"
echo "  Authorization: Bearer $TOKEN"
echo "  X-Requested-With: XMLHttpRequest"
echo "  Content-Type: application/json"
