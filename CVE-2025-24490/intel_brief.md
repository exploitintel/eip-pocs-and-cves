# Intel Brief: CVE-2025-24490

## CVE Overview

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2025-24490 |
| **Affected Software** | Mattermost Boards Plugin (plugin ID: `focalboard`) — bundled with Mattermost Server |
| **Vendor** | Mattermost |
| **CVSS Score** | 9.6 CRITICAL |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:N |
| **CWE** | CWE-89 (Improper Neutralization of Special Elements used in an SQL Command — SQL Injection) |
| **EPSS** | 0.3% (50.2th percentile) |
| **Published** | 2025-02-24 |

## Description

Mattermost versions 10.4.x <= 10.4.1, 9.11.x <= 9.11.7, 10.3.x <= 10.3.2, 10.2.x <= 10.2.2 fail to use prepared statements in the SQL query of boards reordering, which allows an authenticated attacker to retrieve arbitrary data from the database via SQL injection when reordering specially crafted board categories.

The vulnerability exists in the Mattermost Boards plugin (formerly Focalboard), which is prepackaged with Mattermost Server. Two SQL store functions directly concatenate user-supplied IDs into SQL `CASE WHEN` expressions without parameterization or input validation.

## Affected Versions

| Component | Vulnerable Versions | Patched Version |
|-----------|-------------------|-----------------|
| Mattermost Server 10.4.x | <= 10.4.1 | 10.4.2 |
| Mattermost Server 10.3.x | <= 10.3.2 | 10.3.3 |
| Mattermost Server 10.2.x | <= 10.2.2 | 10.2.3 |
| Mattermost Server 9.11.x (ESR) | <= 9.11.7 | 9.11.8 |
| Boards Plugin (standalone) | <= v9.0.4 | v9.0.5 |
| Boards Plugin (prepackaged in MM 9.11.7) | focalboard v8.0.0 | focalboard v8.0.1+ (in MM 9.11.8) |

## Repository

| Field | Value |
|-------|-------|
| **Repository URL** | https://github.com/mattermost/mattermost-plugin-boards.git |
| **Vulnerable Version Tag** | `v9.0.4` (checked out in workspace) |
| **Patched Version Tag** | `v9.0.5` |
| **Fix Commit** | `47f29e1bcea11b5b4576c8305e0e0eb5745c37bd` |
| **Fix PR** | [#55 — "Improved ID validation"](https://github.com/mattermost/mattermost-plugin-boards/pull/55) |
| **Fix Author** | Harshil Sharma (2025-01-22) |
| **Language** | Go (server), TypeScript (webapp) |

### Commits Between v9.0.4 and v9.0.5
```
ad0108c Version update to 9.0.5 for plugin.json and client side (#57)
025ce8d Added Validation for block patch (#56)
47f29e1 Improved ID validation (#55)      ← FIX COMMIT
f9d34c7 Migrate scorecard-analysis workflow to job token (#52)
37c752f Fix the comments link and markdown rendering issue (#47)
7fad694 upgrade actions (#51)
```

## Build System

| Field | Value |
|-------|-------|
| **Build Tool** | GNU Make + Go toolchain |
| **Go Version** | 1.22+ (go.mod: `go 1.22.0`, toolchain `go1.22.8`) |
| **Go Module** | `github.com/mattermost/mattermost-plugin-boards` |
| **Build Tags** | `json1 sqlite3` |
| **Plugin Format** | Mattermost plugin (tar.gz bundle with `plugin.json` manifest) |
| **Plugin ID** | `focalboard` |
| **Plugin Version** | `9.0.4` (from plugin.json) |
| **Build Command** | `make dist` |

### Key Dependencies
- `github.com/Masterminds/squirrel` v1.5.4 — SQL query builder (contains the vulnerable `Case.When()` API)
- `github.com/gorilla/mux` v1.8.1 — HTTP router
- `github.com/lib/pq` v1.10.9 — PostgreSQL driver
- `github.com/go-sql-driver/mysql` v1.8.1 — MySQL driver
- `github.com/mattermost/mattermost/server/public` v0.1.9 — Mattermost server API
- `github.com/mattermost/mattermost/server/v8` — Mattermost server internals
- `github.com/mattermost/morph` v1.1.0 — Database migrations

### Lab Deployment Note
The boards plugin is **prepackaged** into Mattermost Server releases. For the lab, use the official Docker image rather than building the plugin from source:
- **Vulnerable image**: `mattermost/mattermost-enterprise-edition:9.11.7`
- **Patched image**: `mattermost/mattermost-enterprise-edition:9.11.8`
- Requires PostgreSQL (or MySQL) as a backend database
- The boards plugin is in prepackaged_plugins but must be manually installed via API in 9.11.x

## Vulnerability Details

### Root Cause

Two functions in the SQL store layer construct SQL `CASE WHEN` expressions by directly concatenating user-supplied string IDs without using parameterized queries:

**File: `server/services/store/sqlstore/category.go` (line 221)**
```go
func (s *SQLStore) reorderCategories(db sq.BaseRunner, userID, teamID string, newCategoryOrder []string) ([]string, error) {
    updateCase := sq.Case("id")
    for i, categoryID := range newCategoryOrder {
        // VULNERABLE: categoryID is directly concatenated into SQL
        updateCase = updateCase.When("'"+categoryID+"'", sq.Expr(fmt.Sprintf("%d", i*categorySortOrderGap)))
    }
    // ...
}
```

**File: `server/services/store/sqlstore/category_boards.go` (line 144)**
```go
func (s *SQLStore) reorderCategoryBoards(db sq.BaseRunner, categoryID string, newBoardsOrder []string) ([]string, error) {
    updateCase := sq.Case("board_id")
    for i, boardID := range newBoardsOrder {
        // VULNERABLE: boardID is directly concatenated into SQL
        updateCase = updateCase.When("'"+boardID+"'", sq.Expr(fmt.Sprintf("%d", i+model.CategoryBoardsSortOrderGap)))
    }
    // ...
}
```

The generated SQL looks like:
```sql
UPDATE focalboard_categories SET sort_order = CASE id
  WHEN '<user_input_here>' THEN 0
  WHEN '<user_input_here>' THEN 10
  ELSE sort_order END
WHERE user_id = $1 AND team_id = $2
```

The WHERE clause uses proper parameterization ($1, $2), but the WHEN values are inline string literals containing attacker-controlled content.

### Attack Surface

Two authenticated API endpoints accept the malicious input:

1. **Reorder Categories** (PRIMARY): `PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/reorder`
   - Body: JSON array of category ID strings → `["id1", "id2", ...]`
   - The category IDs flow directly to `reorderCategories()` without validation
   - Requires ALL existing category IDs in the array (checked by `verifyNewCategoriesMatchExisting()`)

2. **Reorder Category Boards** (SECONDARY): `PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/{categoryID}/boards/reorder`
   - Body: JSON array of board ID strings → `["boardId1", "boardId2", ...]`
   - The board IDs flow directly to `reorderCategoryBoards()` without validation

### Authentication Requirements

- Requires a valid Mattermost session (any authenticated user)
- User must have `PermissionViewTeam` on the target team (any team member qualifies)
- For category reorder, the malicious category must belong to the requesting user (satisfied because attacker creates it)
- CSRF token required: `X-Requested-With: XMLHttpRequest` header
- Authorization: `Bearer <session_token>` header
- **No admin privileges needed** — any team member can exploit this

### Key Constraint: varchar(36)

The `id` column in `focalboard_categories` and `board_id` in `focalboard_category_boards` are both `VARCHAR(36)`. All SQL injection payloads must be ≤ 36 characters. This limits payload complexity but allows:
- Time-based blind: `'||(SELECT '' FROM pg_sleep(5))||'` (34 chars)
- Error-based boolean: `'||(1/0)::text||'` (17 chars)
- Table probing: `'||(SELECT''FROM users LIMIT 1)||'` (34 chars)

### Data Flow (Reorder Categories — PRIMARY)

```
HTTP PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/reorder
  → server/api/categories.go:handleReorderCategories() [line 395]
    → JSON body unmarshaled to []string (no ID validation) [line 437-443]
    → server/app/category.go:ReorderCategories() [line 193]
      → verifyNewCategoriesMatchExisting() [line 210]
        → Fetches existing categories from DB
        → Checks array length matches existing categories
        → Checks each ID exists in existing categories map
        → PASSES: malicious ID exists because attacker created it
      → server/services/store/sqlstore/category.go:reorderCategories() [line 214]
        → Builds CASE expression with concatenated IDs [line 220-222]
        → VULNERABLE: updateCase.When("'"+categoryID+"'", ...) [line 221]
        → SQL injection fires during query execution [line 233]
```

### Attack Flow (Step by Step)

1. **Authenticate**: `POST /api/v4/users/login` → extract `Token` from response header
2. **Get team ID**: `GET /api/v4/users/me/teams`
3. **Create category with SQLi payload as ID**: `POST /plugins/focalboard/api/v2/teams/{teamID}/categories`
   - Body: `{"id": "'||(SELECT '' FROM pg_sleep(5))||'", "name": "test", "userID": "<user_id>", "teamID": "<team_id>", "type": "custom"}`
   - The `Hydrate()` function only generates ID if empty; `IsValid()` only checks non-emptiness. No format/length/char validation.
4. **List all categories**: `GET /plugins/focalboard/api/v2/teams/{teamID}/categories`
   - Collect ALL category IDs including the injected one
5. **Trigger SQL injection**: `PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/reorder`
   - Body: `["<normal_id_1>", "'||(SELECT '' FROM pg_sleep(5))||'", "<normal_id_2>"]`
   - Array MUST contain ALL existing category IDs
6. **Observe**: Response delayed by ~5 seconds → SQL injection confirmed

### SQL Injection Type

- **Type**: String-based blind SQL injection in CASE WHEN clause (UPDATE statement)
- **Database**: PostgreSQL (primary) or MySQL
- **Techniques**: Time-based blind (pg_sleep), error-based boolean oracle (1/0 division), table probing
- **Impact**: Data exfiltration from any table in the database (C:H, I:H, S:C)
- **Stacked queries**: NOT possible (lib/pq extended query protocol restricts to single statement)
- **Error messages**: NOT leaked to client (generic "internal server error" HTTP 500)

### Fix Applied (commit 47f29e1)

The fix has three defensive layers:

**Layer 1: Parameterized queries (addresses root cause)**
```go
// BEFORE (vulnerable)
updateCase = updateCase.When("'"+categoryID+"'", ...)
// AFTER (fixed)
updateCase = updateCase.When(sq.Expr("?", categoryID), ...)
```
Applied to both `category.go:221` and `category_boards.go:144`.

**Layer 2: Input validation (defense-in-depth)**
New `IsValidId()` function in `server/model/base.go`:
- ID must not be empty
- ID length must be exactly 27 characters
- ID format must conform to Mattermost ID standards (1-char type prefix + 26-char base32-encoded UUID)

**Layer 3: Server-side ID generation**
- Added `category.PreCreate()` call in `CreateCategory()` before `Hydrate()`, forcing server-generated ID regardless of user input

## Public Exploits

**None found in public databases.** No Metasploit modules, ExploitDB entries, GitHub PoCs, or Nuclei templates exist for this CVE.

**PoC scripts** (all confirmed working):
| Script | Vector | Technique |
|--------|--------|-----------|
| `poc/poc.py` | reorderCategories | Time-based blind (pg_sleep) |
| `poc/poc_vector2.py` | reorderCategoryBoards | Time-based blind (pg_sleep) |
| `poc/poc_vector3.py` | reorderCategories | Error-based boolean oracle (1/0) |
| `poc/poc_extract.py` | reorderCategories | Data extraction (table probing + timing) |

## References

| Type | URL |
|------|-----|
| Vendor Advisory | https://mattermost.com/security-updates |
| GitHub Advisory (GHSA) | https://github.com/advisories/GHSA-p4jg-qmjv-9x26 |
| NVD Entry | https://nvd.nist.gov/vuln/detail/CVE-2025-24490 |
| Fix Commit | https://github.com/mattermost/mattermost-plugin-boards/commit/47f29e1bcea11b5b4576c8305e0e0eb5745c37bd |
| Fix PR | https://github.com/mattermost/mattermost-plugin-boards/pull/55 |
| Boards Plugin Repo | https://github.com/mattermost/mattermost-plugin-boards |
| Mattermost Server Repo | https://github.com/mattermost/mattermost |
| Docker Hub (Vulnerable) | https://hub.docker.com/r/mattermost/mattermost-enterprise-edition (tag: 9.11.7) |

## Lab Recommendations

### Recommended Lab Setup

Use the official Mattermost Docker image with PostgreSQL:

```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: mmuser_password
      POSTGRES_DB: mattermost
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 5s
      timeout: 5s
      retries: 10

  mattermost:
    image: mattermost/mattermost-enterprise-edition:9.11.7
    environment:
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:mmuser_password@postgres:5432/mattermost?sslmode=disable
      MM_SERVICESETTINGS_SITEURL: http://localhost:8065
      MM_TEAMSETTINGS_ENABLEOPENSERVER: "true"
    ports:
      - "8065:8065"
    depends_on:
      postgres:
        condition: service_healthy
```

### Important: Focalboard Plugin Installation

In Mattermost 9.11.x, the focalboard plugin is **deprecated** and NOT auto-installed despite being in prepackaged_plugins. After Mattermost starts, the setup script must:
1. Upload the tarball via `POST /api/v4/plugins` (from `/mattermost/prepackaged_plugins/focalboard-v8.0.0-linux-amd64.tar.gz`)
2. Enable the plugin via `POST /api/v4/plugins/focalboard/enable`

### Credentials
| Field | Value |
|-------|-------|
| Admin Username | `admin` |
| Admin Password | `Admin123!@#` |
| Admin Email | `admin@test.local` |
| Team Name | `testteam` |

### Key Files for PoC Development

- `server/services/store/sqlstore/category.go:214-244` — Vulnerable `reorderCategories()` function
- `server/services/store/sqlstore/category_boards.go:137-165` — Vulnerable `reorderCategoryBoards()` function
- `server/api/categories.go:395-465` — `handleReorderCategories` API handler
- `server/api/categories.go:467-544` — `handleReorderCategoryBoards` API handler
- `server/api/categories.go:27-114` — `handleCreateCategory` API handler (accepts user-controlled ID)
- `server/api/categories.go:333-393` — `handleUpdateCategoryBoard` API handler (accepts board ID from URL path)
- `server/model/category.go:65-85` — `Hydrate()` (only generates ID if empty)
- `server/model/category.go:87-109` — `IsValid()` (only checks non-emptiness)
- `server/app/category.go:20-40` — `CreateCategory()` (no ID validation in vulnerable version)
- `server/app/category.go:193-208` — `ReorderCategories()` (calls store directly)
- `server/app/category.go:210-245` — `verifyNewCategoriesMatchExisting()` (checks all IDs exist)
