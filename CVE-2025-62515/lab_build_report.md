# Lab Build Report: CVE-2025-62515

## Lab Architecture

**Single-container lab** — the pyquokka FlightServer is a standalone Python service with no external dependencies (no database, cache, or queue needed for the vulnerable code path).

```
┌─────────────────────────────────────────────┐
│  cve-2025-62515-vulnerable                  │
│  Python 3.10 + pyarrow + polars + psutil    │
│  FlightServer listening on grpc://0.0.0.0:5005 │
│  (No authentication, pickle.loads() on input)   │
└──────────────┬──────────────────────────────┘
               │
               │ gRPC (Apache Arrow Flight)
               │
┌──────────────┴──────────────────────────────┐
│  Test harness (running on test network)     │
│  Connects via docker compose network        │
└─────────────────────────────────────────────┘
```

## Container Details

| Field | Value |
|---|---|
| **Container Name** | `cve-2025-62515-vulnerable` |
| **Base Image** | `python:3.10-slim-bookworm` |
| **Service Port** | 5005/tcp (gRPC, Apache Arrow Flight) |
| **Protocol** | gRPC (plaintext, no TLS) |
| **Authentication** | None — anonymous connections accepted |
| **Networks** | `lab-net` (default compose network) |
| **Healthcheck** | Python pyarrow.flight client connects and sends `healthcheck` action |

### Installed Packages (Server)

| Package | Version | Purpose |
|---------|---------|---------|
| pyarrow | 23.0.1 | Apache Arrow Flight server framework (gRPC transport) |
| polars | 1.38.1 | DataFrame operations used in FlightServer data handling |
| psutil | 7.2.2 | Memory monitoring in `check_puttable` action |

### Vulnerable Code

The file `flight.py` inside the container is a direct copy of `pyquokka/flight.py` from the source repo (commit `a8165fdd1767cd92bf9fe5eca95ef9997d2bc131`, tag v0.3.1). The vulnerable `pickle.loads()` call is at **line 283** in the `do_action()` method's `set_configs` handler.

## Build Status

| Step | Status | Notes |
|------|--------|-------|
| Docker image build | ✅ SUCCESS | Built from `python:3.10-slim-bookworm` with pip install |
| Container startup | ✅ SUCCESS | FlightServer starts immediately, binds to 0.0.0.0:5005 |
| Healthcheck | ✅ HEALTHY | gRPC healthcheck action responds correctly |
| Network connectivity | ✅ VERIFIED | Reachable from test harness via compose network |
| Vulnerability confirmed | ✅ EXPLOITABLE | Pickle RCE via `set_configs` action confirmed (file creation test) |

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs vulnerable

# Stop the lab
docker compose down
```

## Connecting to the Vulnerable Server

From another container or host:

```bash
# Get the container IP on the compose network
CONTAINER_IP=$(docker inspect cve-2025-62515-vulnerable --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}')

# Connect with pyarrow Flight client
python3 -c "
import pyarrow.flight
client = pyarrow.flight.connect('grpc://${CONTAINER_IP}:5005')
print(list(client.list_actions()))
"
```

Or execute commands inside the container:
```bash
docker exec cve-2025-62515-vulnerable python -c "
import pyarrow.flight
client = pyarrow.flight.connect('grpc://localhost:5005')
print(list(client.list_actions()))
"
```

## Verification Evidence

### 1. Server is running and responds to gRPC

```
Available actions:
  - clear: Clear the stored flights.
  - check_puttable: check if puttable
  - shutdown: Shut down this server.
  - get_flights_info: get information of flights
  - cache_garbage_collect: garbage collect from cache
```

### 2. Vulnerable `set_configs` endpoint accepts pickle data

Sent a valid pickle-serialized config dict `{'mem_limit': 0.5}` via `set_configs` action → received `b'True'` response. This confirms the `pickle.loads()` deserialization path at line 283 is active.

### 3. RCE via pickle deserialization confirmed

Sent a malicious pickle payload with `__reduce__` calling `os.system('touch /tmp/cve-2025-62515-vuln-test')` → file was created inside the container, confirming arbitrary command execution.

### 4. Server survives exploitation

After the RCE payload, the server returned a `FlightServerError` (because `os.system()` returns an int, not a dict), but the Arrow Flight gRPC framework caught the exception. The server remained healthy and continued accepting connections.

## Attack Surface for PoC Agent

| Attack Vector | Action Type | Line | Complexity |
|---|---|---|---|
| **Primary** | `set_configs` | 283 | Trivial — full body is `pickle.loads()`'d |
| Secondary | `cache_garbage_collect` | 305 | Trivial — full body is `pickle.loads()`'d |
| Alternative | `do_put` (descriptor) | 46 | Moderate — payload in descriptor command bytes |
| Alternative | `do_get` (ticket) | 98 | Moderate — payload in ticket bytes |

### PoC Development Notes

- **Client dependency**: Only `pyarrow` is needed on the attacker side
- **Connection**: `pyarrow.flight.connect('grpc://CONTAINER_IP:5005')`
- **Exploit delivery**: `client.do_action(pyarrow.flight.Action('set_configs', malicious_pickle_bytes))`
- **Expected behavior**: The server will execute the payload during `pickle.loads()`, then raise a `FlightServerError` because the return value of `__reduce__` isn't a valid config dict. The error does NOT crash the server.
- **Verification**: Check for file creation, command output, or other side effects inside the container using `docker exec`

## Known Issues

None. The lab is fully functional with no workarounds needed. The vulnerability is straightforward to reproduce.

## Lab Files

| File | Description |
|---|---|
| `Dockerfile.vulnerable` | Docker build file for the vulnerable FlightServer |
| `docker-compose.yml` | Compose orchestration with healthcheck and network config |
| `flight.py` | Copy of vulnerable `pyquokka/flight.py` from source repo |
