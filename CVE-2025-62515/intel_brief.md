# Intel Brief: CVE-2025-62515

## CVE Summary

| Field | Value |
|---|---|
| **CVE ID** | CVE-2025-62515 |
| **Title** | pyquokka — Insecure Deserialization via pickle.loads() in FlightServer |
| **Affected Software** | pyquokka |
| **Vendor** | marsupialtail (Tony Wang / Ziheng Wang) |
| **CVSS Score** | 9.8 CRITICAL |
| **CVSS Vector** | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| **EPSS** | 0.6% (67.6th percentile) |
| **CWE** | CWE-502 (Deserialization of Untrusted Data) |
| **Published** | 2025-10-17 |
| **GHSA** | GHSA-f74j-gffq-vm9p |

## Description

pyquokka is a Python framework for making data lakes work for time series analytics, built on top of Apache Arrow Flight and Ray. The `FlightServer` class in `pyquokka/flight.py` directly uses `pickle.loads()` to deserialize action bodies received from Flight clients without any sanitization or validation.

The primary vulnerability is in the `do_action()` method at line 283, where the `set_configs` action type directly passes user-supplied data to `pickle.loads()`. An attacker can craft a malicious pickle payload with a `__reduce__()` method to achieve **Remote Code Execution (RCE)** by sending it via an Apache Arrow Flight client connection.

The server binds to `0.0.0.0:5005` by default (all network interfaces), making it accessible to any network attacker who can reach the port.

## Affected Versions

- **All versions through 0.3.2** (latest on PyPI) are vulnerable
- **No fix has been committed** — the vulnerability is UNPATCHED
- The EIP shows affected range: `0 - *` (all versions)

## Repository

| Field | Value |
|---|---|
| **Repository URL** | https://github.com/marsupialtail/quokka.git |
| **Vulnerable Version** | v0.3.1 (tag, checked out — commit `a8165fdd1767cd92bf9fe5eca95ef9997d2bc131`) |
| **Fix Commit** | **NONE** — vulnerability is unpatched |
| **Patched Version** | **NONE** — no version contains a fix |
| **Primary Language** | Python |

## Vulnerable Code Locations

All in `pyquokka/flight.py`:

| Line | Method | Sink | Network-Reachable |
|------|--------|------|-------------------|
| **283** | `do_action()` — "set_configs" action | `pickle.loads(action.body.to_pybytes())` | **YES — primary target** |
| **305** | `do_action()` — "cache_garbage_collect" action | `pickle.loads(action.body.to_pybytes())` | **YES** |
| **46** | `do_put()` | `pickle.loads(key[1])` | YES (via descriptor) |
| **98** | `do_get()` | `pickle.loads(ticket.ticket)` | YES (via ticket) |
| **220** | `do_get()` (inner) | `pickle.loads(input_requirements)` | YES (nested in ticket data) |

### Most Exploitable Path

The **`set_configs` action** (line 283) is the simplest attack path because:
1. It directly deserializes `action.body.to_pybytes()` — the full action body is attacker-controlled
2. No authentication or prior state is required
3. The protocol is standard Apache Arrow Flight over gRPC (`grpc+tcp://0.0.0.0:5005`)

### Attack Flow

```
Attacker --> pyarrow.flight.connect("grpc://TARGET:5005")
         --> client.do_action(pyarrow.flight.Action("set_configs", malicious_pickle_bytes))
         --> FlightServer.do_action() calls pickle.loads(malicious_payload)
         --> RCE via __reduce__() method in crafted pickle object
```

## Build System & Dependencies

| Field | Value |
|---|---|
| **Build System** | setuptools (`setup.py`) |
| **Install** | `pip install pyquokka` or `pip install .` from source |
| **Python Version** | Python 3 |

### Key Dependencies (from setup.py)

| Package | Version Constraint | Role |
|---------|-------------------|------|
| **pyarrow** | any | Apache Arrow Flight server/client (the transport layer) |
| **ray** | >=2.0.0 | Distributed computing framework |
| **polars** | >=0.16.17 | DataFrame library |
| **redis** | any | Caching backend |
| **psutil** | any | System monitoring (used in FlightServer) |
| **duckdb** | >=0.6.0 | SQL engine |
| **boto3** | any | AWS SDK |
| **numpy** | any | Numerical computing |
| **pandas** | any | DataFrame library |
| **protobuf** | any | Serialization |
| **sqlglot** | >=11.4.2 | SQL parser |

### Minimal Dependencies for PoC

For reproducing the vulnerability, only these are needed:
- **Server side**: `pyarrow` (for FlightServer) + `polars` + `psutil` + `pickle` (stdlib)
- **Client/exploit side**: `pyarrow` only (for Flight client)

A minimal standalone server can be created by extracting just the FlightServer class or running `python -m pyquokka.flight` directly.

## Public Exploits

**No public exploits found** in ExploitDB, Metasploit, or GitHub PoCs via EIP search.

The GHSA advisory includes a conceptual PoC description:
> An attacker crafts a malicious pickle object with a `__reduce__()` method to execute arbitrary system commands, then sends it via a Flight client connection to trigger code execution upon deserialization.

This is a standard Python pickle deserialization exploit pattern — straightforward to implement.

## PoC Strategy (for subsequent agents)

### Server Setup
1. Install pyquokka v0.3.1: `pip install pyquokka==0.3.1`
2. Run the FlightServer: `python -c "from pyquokka.flight import FlightServer; s = FlightServer('0.0.0.0', location='grpc+tcp://0.0.0.0:5005'); s.serve()"`
3. Server listens on port 5005 (gRPC)

### Exploit
1. Craft a malicious pickle payload using `__reduce__()` that executes a command (e.g., `touch /tmp/pwned` or `id > /tmp/pwned`)
2. Connect via `pyarrow.flight.connect("grpc://TARGET:5005")`
3. Send: `client.do_action(pyarrow.flight.Action("set_configs", malicious_pickle_bytes))`
4. The server deserializes and executes the payload

### Verification
- Check for file creation, command output, or reverse shell connection

## References

| Type | URL |
|------|-----|
| **GitHub Advisory** | https://github.com/marsupialtail/quokka/security/advisories/GHSA-f74j-gffq-vm9p |
| **Source Repository** | https://github.com/marsupialtail/quokka |
| **PyPI Package** | https://pypi.org/project/pyquokka/ |
| **Vulnerable File** | `pyquokka/flight.py` line 283 |
| **Reporter** | Chenpinji (https://github.com/Chenpinji) |

## Lab Notes

- The FlightServer is standalone — it can be run independently of the full Quokka cluster
- Port 5005 is the default gRPC port
- `pyarrow` is the only dependency needed on both client and server for the exploit path
- The server binds to `0.0.0.0` by default, so Docker port mapping is straightforward
- No authentication is required — the Flight server accepts anonymous connections
- The `set_configs` action path is the cleanest — it requires only sending an Action with type="set_configs" and the pickle payload as the body
