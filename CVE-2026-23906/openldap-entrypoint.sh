#!/bin/bash
# Custom entrypoint that starts OpenLDAP, then enables unauthenticated binds
# (DN with empty password), which is needed for CVE-2026-23906 exploitation.

# Run the original entrypoint in the background
/container/tool/run --copy-service &
LDAP_PID=$!

# Wait for slapd to be ready
echo "Waiting for slapd to start..."
for i in $(seq 1 60); do
    if ldapsearch -x -H ldap://localhost:389 -s base -b "" '(objectClass=*)' > /dev/null 2>&1; then
        echo "slapd is ready."
        break
    fi
    sleep 1
done

# Enable unauthenticated binds (DN with empty password)
echo "Enabling unauthenticated binds (bind_anon_dn)..."
ldapmodify -Y EXTERNAL -H ldapi:/// <<EOF
dn: cn=config
changetype: modify
add: olcAllows
olcAllows: bind_anon_dn
EOF

if [ $? -eq 0 ]; then
    echo "Successfully enabled unauthenticated binds."
else
    echo "Warning: Failed to enable unauthenticated binds (may already be set)."
fi

# Wait for the original entrypoint process
wait $LDAP_PID
