# CVE-2026-28296 Lab - Vulnerable GVFS Client
# Builds GVFS 1.54.2 (vulnerable - no CRLF sanitization in FTP paths).
# Fix is in commit 21dda190, not present in any released version <= 1.58.1.

FROM debian:bookworm

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies for GVFS and runtime tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git ca-certificates \
        meson ninja-build gcc pkg-config gettext \
        libglib2.0-dev libglib2.0-bin \
        libsoup-3.0-dev \
        libsecret-1-dev \
        libpolkit-gobject-1-dev \
        libdbus-1-dev \
        libgudev-1.0-dev \
        libsystemd-dev \
        libgcrypt20-dev \
        gsettings-desktop-schemas-dev \
        dbus dbus-x11 \
        python3 python3-pip \
        ftp telnet tcpdump ncat strace \
        procps less vim-tiny && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Clone GVFS at vulnerable release tag
RUN git clone --branch 1.54.2 --depth 1 https://github.com/GNOME/gvfs.git

WORKDIR /src/gvfs

# Build GVFS with only the FTP backend (minimal build)
RUN meson setup builddir \
        --prefix=/usr \
        -Dadmin=false \
        -Dafc=false \
        -Dafp=false \
        -Darchive=false \
        -Dcdda=false \
        -Ddnssd=false \
        -Dgoa=false \
        -Dgoogle=false \
        -Dgphoto2=false \
        -Dhttp=false \
        -Dmtp=false \
        -Dnfs=false \
        -Donedrive=false \
        -Dsftp=false \
        -Dsmb=false \
        -Dudisks2=false \
        -Dwsdd=false \
        -Dbluray=false \
        -Dfuse=false \
        -Dgcr=false \
        -Dgcrypt=false \
        -Dgudev=false \
        -Dkeyring=false \
        -Dlibusb=false \
        -Dlogind=false \
        -Dman=false \
        -Dsystemduserunitdir=no \
        -Dtmpfilesdir=no && \
    ninja -C builddir && \
    ninja -C builddir install

# Copy the PoC scripts
COPY poc/ /poc/

WORKDIR /poc

CMD ["/bin/bash"]
