## Incomplete fix for CVE-2026-28296: server-supplied paths bypass CR/LF validation

> Reported by: **Exploit Intelligence Platform** | [exploit-intel.com](https://exploit-intel.com) | dev@exploit-intel.com

The fix in commit 21dda190 (MR !298) adds CR/LF validation to `g_vfs_ftp_file_new_from_gvfs()`, which blocks CRLF injection via user-supplied URIs. However, `g_vfs_ftp_file_new_from_ftp()` — used for server-supplied paths — has no equivalent validation. This allows a malicious FTP server to inject arbitrary FTP commands through crafted symlink targets in LIST responses.

### Root cause

`g_vfs_ftp_file_new_from_gvfs()` now rejects paths containing `\r` or `\n`:

```c
// gvfsftpfile.c — PATCHED
if (strpbrk (gvfs_path, "\r\n") != NULL)
  {
    g_set_error_literal (error, ...);
    return NULL;
  }
```

`g_vfs_ftp_file_new_from_ftp()` does not:

```c
// gvfsftpfile.c:112 — NO VALIDATION
GVfsFtpFile *
g_vfs_ftp_file_new_from_ftp (GVfsBackendFtp *ftp, const char *ftp_path)
{
  file = g_slice_new (GVfsFtpFile);
  file->ftp_path = g_strdup (ftp_path);       // passes through unsanitized
  file->gvfs_path = g_vfs_ftp_file_compute_gvfs_path (ftp_path);
  return file;
}
```

Both functions feed into the same downstream sinks — `g_vfs_ftp_file_get_ftp_path()` is used in `g_vfs_ftp_task_send()` calls like `CWD %s`, `SIZE %s`, `RETR %s`, `DELE %s`, etc.

### Attack path

A malicious FTP server returns a LIST response containing a symlink with an embedded `\r` in its target:

```
lrwxrwxrwx 1 user user 22 Jan  1 00:00 evillink -> /tmp\rDELE /etc/passwd\r
```

GVFS processing:

1. `g_data_input_stream_read_line()` reads the line up to `\n` (`gvfsftpdircache.c:661`)
2. Trailing `\r` before `\n` is stripped (`gvfsftpdircache.c:670`)
3. `ParseFTPList` extracts the symlink target: `/tmp\rDELE /etc/passwd`
4. `g_vfs_ftp_dir_cache_funcs_resolve_default()` passes this target to `g_vfs_ftp_file_new_from_ftp()` at line 850 — **no validation**
5. When GVFS probes the resolved file, it sends: `CWD /tmp\r\nDELE /etc/passwd\r\n`
6. The FTP server processes two commands: `CWD /tmp` and `DELE /etc/passwd`

### Impact

- Triggered automatically when a user browses a directory on a malicious FTP server (file manager, `gio list`, etc.)
- No interaction beyond connecting to the server
- Attacker-controlled FTP commands execute under the victim's authenticated session
- The same tainted path reaches at least 11 command sites (`CWD`, `SIZE`, `RETR`, `STOR`, `DELE`, `RMD`, `MKD`, `RNFR`, `RNTO`, `APPE` in `gvfsftpdircache.c` and `gvfsbackendftp.c`)

### Suggested fix

Add the same `strpbrk` check to `g_vfs_ftp_file_new_from_ftp()`:

```c
GVfsFtpFile *
g_vfs_ftp_file_new_from_ftp (GVfsBackendFtp *ftp, const char *ftp_path)
{
  GVfsFtpFile *file;

  g_return_val_if_fail (G_VFS_IS_BACKEND_FTP (ftp), NULL);
  g_return_val_if_fail (ftp_path != NULL, NULL);

  if (strpbrk (ftp_path, "\r\n") != NULL)
    {
      g_warning ("FTP path from server contains CR/LF characters, rejecting");
      return NULL;
    }

  file = g_slice_new (GVfsFtpFile);
  file->backend = g_object_ref (ftp);
  file->ftp_path = g_strdup (ftp_path);
  file->gvfs_path = g_vfs_ftp_file_compute_gvfs_path (ftp_path);

  return file;
}
```

Callers that currently assume a non-NULL return will need NULL checks. The main one is `g_vfs_ftp_dir_cache_funcs_resolve_default()` at `gvfsftpdircache.c:850`, which already returns its result to callers that handle NULL.

The same check should also be considered for `g_vfs_ftp_file_new_child()` since it is used to construct file objects from server-supplied filenames in LIST parsing (`gvfsftpdircache.c:699`).

### Reproduction

A full lab environment with PoCs is available at: https://github.com/exploitintel/eip-pocs-and-cves/tree/main/CVE-2026-28296

The lab includes a custom FTP server that returns the crafted LIST response and a test script that demonstrates the bypass on both vulnerable (1.54.2) and patched (HEAD/1.59.2) builds.

---
*Exploit Intelligence Platform* | [exploit-intel.com](https://exploit-intel.com) | [@exploit_intel](https://x.com/exploit_intel)
