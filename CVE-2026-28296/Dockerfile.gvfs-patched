# CVE-2026-28296 Fix Bypass Lab - Patched GVFS Client
# Builds GVFS HEAD (1.59.2) which includes the CRLF fix (commit 21dda190).
# Uses debian:trixie for glib >= 2.83.0 required by HEAD.
#
# The fix validates g_vfs_ftp_file_new_from_gvfs() (user-supplied paths)
# but leaves g_vfs_ftp_file_new_from_ftp() (server-supplied paths)
# completely unvalidated - this is the bypass vector.

FROM debian:trixie

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies for GVFS and runtime tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git ca-certificates \
        meson ninja-build gcc pkg-config gettext \
        libglib2.0-dev libglib2.0-bin \
        libsoup-3.0-dev \
        libsecret-1-dev \
        libpolkit-gobject-1-dev \
        libdbus-1-dev \
        libgudev-1.0-dev \
        libsystemd-dev \
        libgcrypt20-dev \
        gsettings-desktop-schemas-dev \
        dbus dbus-x11 \
        python3 python3-pip \
        ftp telnet tcpdump ncat strace \
        procps less vim-tiny && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Clone GVFS at HEAD (includes the incomplete CRLF fix)
RUN git clone --depth 1 https://github.com/GNOME/gvfs.git

WORKDIR /src/gvfs

# Build GVFS HEAD (1.59.2) - includes the CRLF fix (21dda190)
RUN meson setup builddir \
        --prefix=/usr \
        -Dadmin=false \
        -Dafc=false \
        -Dafp=false \
        -Darchive=false \
        -Dcdda=false \
        -Ddnssd=false \
        -Dgoa=false \
        -Dgphoto2=false \
        -Dhttp=false \
        -Dmtp=false \
        -Dnfs=false \
        -Donedrive=false \
        -Dsftp=false \
        -Dsmb=false \
        -Dudisks2=false \
        -Dwsdd=false \
        -Dbluray=false \
        -Dfuse=false \
        -Dgcr=false \
        -Dgcrypt=false \
        -Dgudev=false \
        -Dkeyring=false \
        -Dlibusb=false \
        -Dlogind=false \
        -Dman=false \
        -Dsystemduserunitdir=no \
        -Dtmpfilesdir=no && \
    ninja -C builddir && \
    ninja -C builddir install

# Copy the PoC scripts
COPY poc/ /poc/

WORKDIR /poc

CMD ["/bin/bash"]
